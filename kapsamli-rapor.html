<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kapsamlı Kalite Uygunsuzluk Raporu</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* ── RESET & BASE ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
    --c-bg:       #f4f6fa;
    --c-card:     #ffffff;
    --c-border:   #e2e6ed;
    --c-text:     #1e2535;
    --c-sub:      #5a6478;
    --c-accent:   #2563eb;
    --c-ok:       #16a34a;
    --c-warn:     #d97706;
    --c-danger:   #dc2626;
    --c-info:     #0891b2;
    --c-purple:   #7c3aed;
    --c-pink:     #db2777;
    --shadow:     0 2px 12px rgba(0,0,0,.08);
    --r:          12px;
}
body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--c-bg); color:var(--c-text); font-size:14px; }

/* ── TOPBAR ── */
.topbar {
    position:sticky; top:0; z-index:200;
    background:#1e2535; color:#fff;
    display:flex; align-items:center; gap:16px;
    padding:12px 32px; box-shadow:0 2px 8px rgba(0,0,0,.3);
}
.topbar .logo { font-size:1.25rem; font-weight:700; letter-spacing:-.5px; }
.topbar .logo span { color:#60a5fa; }
.topbar-right { margin-left:auto; display:flex; gap:8px; }
.btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border-radius:8px; border:none; cursor:pointer; font-size:.85rem; font-weight:600; transition:all .15s; }
.btn-primary { background:var(--c-accent); color:#fff; }
.btn-primary:hover { background:#1d4ed8; }
.btn-success { background:var(--c-ok); color:#fff; }
.btn-success:hover { background:#15803d; }
.btn-outline { background:transparent; color:#93c5fd; border:1.5px solid #3b82f6; }
.btn-outline:hover { background:#3b82f6; color:#fff; }

/* ── NAV SIDEBAR ── */
.layout { display:flex; min-height:calc(100vh - 52px); }
.sidebar {
    width:230px; flex-shrink:0;
    background:#fff; border-right:1px solid var(--c-border);
    padding:20px 0;
    position:sticky; top:52px; height:calc(100vh - 52px); overflow-y:auto;
}
.sidebar h3 { font-size:.7rem; text-transform:uppercase; letter-spacing:1px; color:var(--c-sub); padding:0 20px 8px; }
.nav-item {
    display:flex; align-items:center; gap:8px;
    padding:9px 20px; cursor:pointer; font-size:.85rem; color:var(--c-sub);
    border-left:3px solid transparent; transition:all .15s;
}
.nav-item:hover { background:#f0f4ff; color:var(--c-accent); }
.nav-item.active { background:#eff6ff; color:var(--c-accent); border-left-color:var(--c-accent); font-weight:600; }
.nav-item .nav-ico { font-size:1rem; width:20px; text-align:center; }

/* ── MAIN ── */
.main { flex:1; padding:28px 32px; max-width:1400px; }

/* ── REPORT HEADER ── */
.report-header {
    background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 50%,#2563eb 100%);
    border-radius:var(--r); padding:32px 40px; color:#fff; margin-bottom:24px;
}
.report-header h1 { font-size:1.6rem; font-weight:700; margin-bottom:6px; }
.report-header .sub { color:#93c5fd; font-size:.9rem; margin-bottom:16px; }
.rh-meta { display:flex; flex-wrap:wrap; gap:20px; }
.rh-tag { background:rgba(255,255,255,.15); border-radius:6px; padding:4px 12px; font-size:.78rem; backdrop-filter:blur(4px); }

/* ── KPI CARDS ── */
.kpi-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:16px; margin-bottom:24px; }
.kpi-card {
    background:var(--c-card); border-radius:var(--r); padding:20px 18px;
    box-shadow:var(--shadow); border-top:4px solid var(--c-accent);
    display:flex; flex-direction:column; gap:4px;
}
.kpi-card .kval { font-size:1.9rem; font-weight:800; color:var(--c-text); line-height:1.1; }
.kpi-card .klbl { font-size:.75rem; color:var(--c-sub); font-weight:600; text-transform:uppercase; letter-spacing:.5px; }
.kpi-card .kdiff { font-size:.78rem; margin-top:4px; }
.kdiff.pos { color:var(--c-ok); }
.kdiff.neg { color:var(--c-danger); }

/* ── SECTION CARDS ── */
.section { background:var(--c-card); border-radius:var(--r); box-shadow:var(--shadow); margin-bottom:24px; overflow:hidden; }
.section-hdr {
    display:flex; align-items:center; gap:10px;
    padding:18px 24px; border-bottom:1px solid var(--c-border);
    background:linear-gradient(90deg,#f8faff,#fff);
}
.section-hdr .ico { font-size:1.2rem; }
.section-hdr h2 { font-size:1rem; font-weight:700; color:var(--c-text); }
.section-hdr .hint { font-size:.75rem; color:var(--c-sub); margin-left:auto; }
.section-body { padding:24px; }

/* ── TWO COLUMN ── */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
.three-col { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }
@media(max-width:900px){ .two-col, .three-col { grid-template-columns:1fr; } }

/* ── CHART CONTAINERS ── */
.chart-wrap { position:relative; }
.chart-wrap canvas { max-height:300px; }
.chart-wrap-tall canvas { max-height:380px; }

/* ── TABLES ── */
.rep-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.rep-table th { background:#f1f5f9; text-transform:uppercase; font-size:.7rem; letter-spacing:.5px; color:var(--c-sub); padding:9px 12px; text-align:left; border-bottom:2px solid var(--c-border); }
.rep-table td { padding:8px 12px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
.rep-table tr:last-child td { border-bottom:none; }
.rep-table tr:hover td { background:#f8faff; }
.rep-table .rank { width:32px; color:var(--c-sub); font-weight:700; }
.rep-table .num { text-align:right; font-variant-numeric:tabular-nums; font-weight:600; }
.rep-table .pct { text-align:right; color:var(--c-sub); font-size:.78rem; }
.badge { display:inline-block; border-radius:4px; padding:2px 8px; font-size:.72rem; font-weight:700; }
.badge-red    { background:#fee2e2; color:#b91c1c; }
.badge-blue   { background:#dbeafe; color:#1e40af; }
.badge-green  { background:#dcfce7; color:#15803d; }
.badge-yellow { background:#fef9c3; color:#92400e; }
.badge-purple { background:#ede9fe; color:#5b21b6; }
.badge-gray   { background:#f1f5f9; color:#475569; }

/* ── PROGRESS BAR ── */
.prog-bar { background:#f1f5f9; border-radius:100px; overflow:hidden; height:8px; margin-top:4px; }
.prog-fill { height:100%; border-radius:100px; transition:width .6s; }

/* ── IC DIS CARDS ── */
.ic-dis-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }
/* İç/Dış breakdown */
.idb-bar { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:18px 0 14px; padding-top:18px; border-top:1.5px solid #e2e8f0; }
.idb-bar span { font-size:.8rem; font-weight:700; color:#475569; margin-right:4px; }
.idb-tab { border:1.5px solid #e2e8f0; background:#f8fafc; color:#64748b; border-radius:20px; padding:4px 14px; font-size:.78rem; font-weight:700; cursor:pointer; transition:all .15s; }
.idb-tab:hover { border-color:#3b82f6; color:#3b82f6; }
.idb-tab.active { background:#2563eb; color:#fff; border-color:#2563eb; }
.id-pareto-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:4px; }
@media(max-width:700px){ .id-pareto-grid { grid-template-columns:1fr; } }
.id-pareto-panel { border:1.5px solid #e2e8f0; border-radius:10px; padding:14px 14px 10px; background:#fafbff; }
.id-panel-title { font-size:.82rem; font-weight:800; margin-bottom:10px; }
.ic-card { border-radius:10px; padding:20px 24px; }
.ic-card.ic { background:linear-gradient(135deg,#eff6ff,#dbeafe); border:1.5px solid #93c5fd; }
.ic-card.dis { background:linear-gradient(135deg,#fff7ed,#fed7aa); border:1.5px solid #fdba74; }
.ic-card.ted { background:linear-gradient(135deg,#f0fdf4,#bbf7d0); border:1.5px solid #86efac; }
.ic-card h3 { font-size:.85rem; font-weight:700; margin-bottom:6px; }
.ic-card .ic-val { font-size:2rem; font-weight:800; margin-bottom:2px; }
.ic-card.ic .ic-val { color:#1d4ed8; }
.ic-card.dis .ic-val { color:#c2410c; }
.ic-card.ted .ic-val { color:#15803d; }

/* ── AKSIYON PLAN TABLE ── */
.ap-faaliyet-tag { display:inline-block; background:#dbeafe; color:#1e40af; font-size:.7rem; font-weight:600; border-radius:4px; padding:2px 7px; white-space:nowrap; }
.ap-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.ap-table th { background:#1e2535; color:#e2e8f0; padding:10px 14px; text-align:left; font-size:.72rem; text-transform:uppercase; letter-spacing:.5px; }
.ap-table td { padding:10px 14px; border-bottom:1px solid #f1f5f9; }
.ap-table tr:nth-child(even) td { background:#fafbff; }
.ap-table .pri { font-weight:700; font-size:.78rem; }
.pri-yuksek { color:#b91c1c; }
.pri-orta   { color:#b45309; }
.pri-dusuk  { color:#166534; }

/* ── 6M GRID ── */
.m6-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
.m6-card { border-radius:10px; padding:16px; border:1.5px solid; }
.m6-card .m6-title { font-size:.8rem; font-weight:700; margin-bottom:8px; }
.m6-card .m6-val { font-size:1.4rem; font-weight:800; margin-bottom:4px; }
.m6-card .m6-list { font-size:.75rem; color:var(--c-sub); }

/* ── FISHBONE ── */
.fb-section { margin-top:28px; border-top:1.5px solid #e2e8f0; padding-top:20px; }
/* ── Multi-Fishbone Group Cards ── */
.fb-group-card { border:1.5px solid #e2e8f0; border-radius:12px; margin-bottom:28px; overflow:hidden; background:#fff; }
.fb-group-hdr  { display:flex; align-items:center; gap:12px; padding:14px 20px; background:linear-gradient(90deg,#f8fafc,#f1f5f9); border-bottom:1.5px solid #e2e8f0; flex-wrap:wrap; }
.fb-group-rank { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:50%; background:#2563eb; color:#fff; font-weight:800; font-size:.85rem; flex-shrink:0; }
.fb-group-name { font-weight:700; font-size:.95rem; color:#1e2535; flex:1; min-width:80px; }
.fb-group-badge2 { padding:3px 10px; border-radius:20px; font-size:.72rem; font-weight:600; background:#eff6ff; color:#1d4ed8; }
.fb-group-table { padding:16px 20px 20px; border-top:1.5px solid #f1f5f9; background:#fafbfc; }
.fb-group-table h4 {
    font-size:.82rem; font-weight:700; color:#475569; margin:0 0 10px;
    display:flex; align-items:center; gap:8px; cursor:pointer;
    user-select:none; padding:7px 10px; border-radius:8px; transition:background .15s;
}
.fb-group-table h4:hover { background:#e2e8f0; }
.fb-table-chevron { margin-left:auto; font-size:.9rem; transition:transform .25s; display:inline-block; }
.fb-table-chevron.collapsed { transform:rotate(-90deg); }
.fb-table-body { overflow:hidden; transition:max-height .35s ease, opacity .25s ease; max-height:2000px; opacity:1; }
.fb-table-body.collapsed { max-height:0; opacity:0; pointer-events:none; }
.fb-header  { display:flex; align-items:center; gap:10px; margin-bottom:14px; flex-wrap:wrap; cursor:pointer; user-select:none; padding:8px 12px; border-radius:8px; transition:background .15s; }
.fb-header:hover { background:#f1f5f9; }
.fb-body { overflow:hidden; transition:max-height .35s ease, opacity .25s ease; max-height:9999px; opacity:1; }
.fb-body.collapsed { max-height:0; opacity:0; pointer-events:none; }
.fb-effect-tag { background:#fef2f2; color:#b91c1c; border:1.5px solid #fca5a5; border-radius:20px; padding:3px 14px; font-size:.75rem; font-weight:700; max-width:340px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fb-svg-wrap { background:#f8fafc; border-radius:12px; border:1.5px solid #e2e8f0; overflow-x:auto; }
.fb-edit-panels { display:grid; grid-template-columns:repeat(6,1fr); gap:10px; margin-top:14px; }
@media(max-width:900px){ .fb-edit-panels { grid-template-columns:repeat(3,1fr); } }
@media(max-width:600px){ .fb-edit-panels { grid-template-columns:repeat(2,1fr); } }
.fb-bone-card { border-radius:10px; overflow:hidden; font-size:.78rem; }
.fb-bone-head { padding:6px 10px; font-weight:800; font-size:.75rem; }
.fb-bone-list { padding:4px 8px; max-height:150px; overflow-y:auto; }
.fb-cause-row { display:flex; align-items:center; gap:4px; padding:3px 2px; border-bottom:1px solid #f1f5f9; }
.fb-cause-name { flex:1; word-break:break-word; line-height:1.3; }
.fb-cause-del { background:none; border:none; color:#ef4444; cursor:pointer; font-size:14px; padding:0 3px; line-height:1; flex-shrink:0; }
.fb-bone-add { display:flex; gap:5px; padding:6px 8px; border-top:1px solid #f1f5f9; }
.fb-add-input { flex:1; border:1px solid #e2e8f0; border-radius:6px; padding:4px 7px; font-size:.75rem; outline:none; font-family:inherit; }
.fb-add-input:focus { border-color:#3b82f6; }
.fb-add-btn { border:none; border-radius:6px; padding:4px 9px; cursor:pointer; font-size:.75rem; font-weight:700; color:#fff; }
.fb-cause-toggle { background:none; border:none; cursor:pointer; color:#94a3b8; font-size:9px; padding:0 2px; flex-shrink:0; transition:transform .15s; line-height:1; }
.fb-sub-block  { border-left:2px solid #e2e8f0; margin:0 2px 3px 18px; padding-left:5px; }
.fb-sub-row    { display:flex; align-items:center; gap:3px; padding:2px 0; font-size:.71rem; color:#475569; }
.fb-sub-del    { background:none; border:none; color:#ef4444; cursor:pointer; font-size:11px; padding:0 2px; flex-shrink:0; }
.fb-sub-add    { display:flex; gap:4px; padding:2px 2px 4px 18px; }
.fb-sub-add input { flex:1; border:1px solid #e2e8f0; border-radius:5px; padding:2px 5px; font-size:.7rem; outline:none; font-family:inherit; }
.fb-sub-add input:focus { border-color:#3b82f6; }
.fb-sub-add button { border:none; border-radius:5px; padding:2px 8px; background:#3b82f6; color:#fff; cursor:pointer; font-size:.7rem; font-weight:700; }
/* Pareto tab selector for fishbone */
.fb-par-tab {
    border:1.5px solid #e2e8f0; background:#f8fafc; color:#64748b;
    border-radius:20px; padding:3px 12px; font-size:.75rem; font-weight:700;
    cursor:pointer; transition:all .15s;
}
.fb-par-tab:hover { border-color:#3b82f6; color:#3b82f6; }
.fb-par-tab.active { background:#2563eb; color:#fff; border-color:#2563eb; }

/* ── AKSIYON EDIT BUTTONS ── */
.ap-btn { border:none; border-radius:6px; padding:4px 8px; cursor:pointer; font-size:.75rem; font-weight:600; line-height:1; transition:opacity .15s; }
.ap-btn:hover { opacity:.8; }
.ap-btn-edit { background:#e0f2fe; color:#0369a1; }
.ap-btn-del  { background:#fee2e2; color:#b91c1c; }
.ap-btn-add  { background:#dcfce7; color:#166534; }
.ap-actions-col { white-space:nowrap; display:flex; gap:5px; }
.ap-table th:last-child, .ap-table td:last-child { text-align:center; }
.btn-8d-ap { background:none; border:1px solid #6366f1; color:#6366f1; border-radius:5px; padding:3px 7px; cursor:pointer; font-size:0.75em; transition:all 0.15s; }
.btn-8d-ap:hover { background:#6366f1; color:#fff; }
.btn-8d-ap.btn-8d-pending { border-color:#9ca3af; color:#9ca3af; }
.btn-8d-ap.btn-8d-pending:hover { background:#9ca3af; color:#fff; }
.btn-8d-unlink { background:none; border:none; color:#6b7280; cursor:pointer; font-size:0.8em; padding:1px 4px; margin-left:2px; border-radius:3px; transition:all 0.15s; }
.btn-8d-unlink:hover { color:#ef4444; background:rgba(239,68,68,0.1); }
/* Durum pill */
.durum-pill { display:inline-block; padding:3px 9px; border-radius:20px; font-size:.72rem; font-weight:700; white-space:nowrap; }
.durum-beklemede  { background:#fef9c3; color:#854d0e; }
.durum-devam      { background:#dbeafe; color:#1e40af; }
.durum-tamamlandi { background:#dcfce7; color:#166534; }
.durum-iptal      { background:#fee2e2; color:#991b1b; }

/* ── MODAL ── */
#apModal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(10,15,30,.55); align-items:center; justify-content:center; }
#apModal.open { display:flex; }
#apModalBox { background:#fff; border-radius:14px; padding:28px 28px 20px; width:min(560px,95vw); box-shadow:0 20px 60px rgba(0,0,0,.22); max-height:90vh; overflow-y:auto; }
#apModalBox h3 { margin:0 0 18px; font-size:1rem; color:#1e2535; }
.ap-field { margin-bottom:14px; }
.ap-field label { display:block; font-size:.75rem; font-weight:700; color:#475569; margin-bottom:4px; text-transform:uppercase; letter-spacing:.4px; }
.ap-field input, .ap-field textarea, .ap-field select { width:100%; box-sizing:border-box; padding:8px 10px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:.85rem; font-family:inherit; color:#1e2535; outline:none; transition:border-color .15s; resize:vertical; }
.ap-field input:focus, .ap-field textarea:focus, .ap-field select:focus { border-color:#3b82f6; }
.ap-modal-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.ap-modal-footer { display:flex; gap:10px; justify-content:flex-end; margin-top:18px; border-top:1px solid #f1f5f9; padding-top:16px; }
.ap-modal-save { background:linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; border:none; border-radius:8px; padding:9px 22px; font-size:.85rem; font-weight:700; cursor:pointer; }
.ap-modal-save:hover { opacity:.9; }
.ap-modal-cancel { background:#f1f5f9; color:#475569; border:none; border-radius:8px; padding:9px 18px; font-size:.85rem; font-weight:600; cursor:pointer; }
.ap-section-toolbar { display:flex; align-items:center; gap:10px; margin-bottom:12px; }

/* ── SNAPSHOT MODAL ── */
#krSnapModal { display:none; position:fixed; inset:0; z-index:9998; background:rgba(10,15,30,.55); align-items:center; justify-content:center; }
#krSnapModal.open { display:flex; }
#krSnapBox { background:#fff; border-radius:14px; padding:28px 28px 20px; width:min(640px,96vw); max-height:82vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.25); }
.kr-snap-row { display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid #f1f5f9; }
.kr-snap-row:last-child { border-bottom:none; }
.kr-snap-info { flex:1; }
.kr-snap-name { font-size:.88rem; font-weight:700; color:#1e2535; margin-bottom:3px; }
.kr-snap-meta { font-size:.73rem; color:#94a3b8; }
.kr-snap-btns { display:flex; gap:6px; flex-shrink:0; }

/* ── PRINT ── */
@media print {
    .topbar, .sidebar, .topbar-right, .no-print { display:none !important; }
    .layout { display:block; }
    .main { padding:16px; max-width:100%; }
    .section { break-inside:avoid; box-shadow:none; border:1px solid #e2e6ed; }
    .kpi-card { box-shadow:none; border:1px solid #e2e6ed; }
    .report-header { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    body { font-size:11px; }
    .kpi-card .kval { font-size:1.5rem; }
    canvas { max-height:200px !important; }
}

/* ── EMPTY STATE ── */
.empty-state { text-align:center; padding:60px 20px; color:var(--c-sub); }
.empty-state .emo { font-size:3rem; margin-bottom:12px; }

/* ── SCROLL NAV ── */
.scroll-progress { position:fixed; top:52px; left:0; height:3px; background:var(--c-accent); z-index:300; transition:width .1s; }

/* ── EDIT MODE ── */
.edit-mode-badge {
    display:none; align-items:center; gap:5px;
    background:rgba(251,191,36,.18); border:1px solid rgba(251,191,36,.45);
    border-radius:20px; padding:3px 12px; font-size:.73rem; color:#fbbf24; font-weight:700;
    animation:edpulse 2s infinite;
}
body.report-editing .edit-mode-badge { display:flex; }
@keyframes edpulse { 0%,100%{opacity:1} 50%{opacity:.55} }

body.report-editing .ed,
body.report-editing [data-ed] {
    outline:1.5px dashed #93c5fd;
    border-radius:3px;
    cursor:text;
    transition:background .12s, outline-color .12s;
    min-width:14px;
    display:inline-block;
}
body.report-editing .ed:hover,
body.report-editing [data-ed]:hover {
    background:rgba(59,130,246,.07);
    outline-color:#3b82f6;
}
body.report-editing .ed:focus,
body.report-editing [data-ed]:focus {
    outline:2px solid #2563eb;
    background:#fff;
    box-shadow:0 0 0 3px rgba(37,99,235,.13);
}
/* ── SECTION HIDE ── */
.section-hdr .kr-hide-btn {
    margin-left:8px; background:transparent; border:none;
    cursor:pointer; color:#94a3b8; font-size:1rem; padding:2px 7px;
    border-radius:6px; line-height:1; transition:all .15s; flex-shrink:0;
}
.section-hdr .kr-hide-btn:hover { background:#fee2e2; color:#dc2626; }
/* ── SOURCES PANEL ── */
.kr-sources {
    background:#fff; border-radius:var(--r); box-shadow:var(--shadow);
    margin-bottom:24px; overflow:hidden; border-left:4px solid #2563eb;
}
.kr-sources-hdr {
    display:flex; align-items:center; gap:10px; padding:13px 20px;
    background:#eff6ff; border-bottom:1px solid #dbeafe;
}
.kr-sources-hdr h3 { font-size:.88rem; font-weight:700; color:#1e3a8a; flex:1; margin:0; }
.kr-src-row {
    display:flex; align-items:center; gap:12px; padding:9px 20px;
    border-bottom:1px solid #f1f5f9; font-size:.81rem; flex-wrap:wrap;
}
.kr-src-row:last-child { border-bottom:none; }
.kr-src-num { font-weight:800; color:#2563eb; min-width:22px; }
.kr-src-label { font-weight:700; color:var(--c-text); flex:1; min-width:120px; }
.kr-src-meta { color:var(--c-sub); font-size:.74rem; flex:2; }
.kr-src-del {
    background:#fee2e2; color:#dc2626; border:none; border-radius:6px;
    padding:4px 10px; font-size:.74rem; font-weight:700; cursor:pointer; flex-shrink:0;
}
.kr-src-del:hover { background:#fecaca; }
/* ── HIDDEN SECTIONS FLOATING BADGE ── */
#kr-hidden-badge {
    position:fixed; bottom:22px; right:22px; z-index:9000;
    background:#1e40af; color:#fff; border-radius:28px;
    padding:11px 20px; display:flex; align-items:center; gap:9px;
    font-size:.82rem; font-weight:700;
    box-shadow:0 4px 20px rgba(30,64,175,.4);
    border:none; cursor:pointer;
    transition:opacity .2s, transform .2s, background .15s;
    animation:krbadgeIn .25s ease;
}
#kr-hidden-badge:hover { background:#1d4ed8; transform:translateY(-3px); }
#kr-hidden-badge.kr-badge-hidden { display:none; }
@keyframes krbadgeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

/* ── CHART SNAPSHOTS ── */
.snap-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(480px,1fr)); gap:20px; margin-top:8px; }
.snap-card { border:1.5px solid var(--c-border); border-radius:12px; overflow:hidden; background:var(--c-card); }
.snap-card-head { display:flex; align-items:center; justify-content:space-between; padding:10px 14px;
    background:#f8faff; border-bottom:1px solid var(--c-border); font-size:.82rem; font-weight:700; color:var(--c-text); }
.snap-card-head .snap-del { background:none; border:none; cursor:pointer; color:#dc2626; font-size:1rem; padding:2px 4px; border-radius:4px; }
.snap-card-head .snap-del:hover { background:#fee2e2; }
.snap-card img { display:block; width:100%; max-height:480px; object-fit:contain; padding:12px; background:#fff; }
.snap-empty { text-align:center; color:var(--c-sub); font-size:.9rem; padding:40px 20px;
    background:#f8f9fc; border-radius:10px; border:2px dashed #e2e6ed; }
#s-snapshots.hidden-sec { display:none; }

html, body { scroll-behavior:smooth; }
</style>
</head>
<body>

<div class="scroll-progress" id="scrollProg"></div>

<!-- TOPBAR -->
<div class="topbar no-print">
    <div class="logo">📊 Kalite<span>Rapor</span></div>
    <div id="topbarTitle" style="color:#93c5fd;font-size:.85rem;"></div>
    <div class="edit-mode-badge">✏️ Düzenleme Modu Aktif</div>
    <div class="topbar-right">
        <button class="btn btn-outline no-print" onclick="krSaveSnapshot()" title="Raporu isimle kaydet">💾 Kaydet</button>
        <button class="btn btn-outline no-print" onclick="krOpenSnapshotModal()" title="Kayıtlı raporları listele">📁 Raporlarım</button>
        <button id="btnEditMode" class="btn btn-outline no-print" onclick="toggleEditMode()">✏️ Raporu Düzenle</button>
        <button class="btn btn-outline no-print" onclick="krShowAllSections()" title="Gizlenen tüm bölümleri tekrar göster">👁 Tüm Bölümler</button>
        <button class="btn btn-outline no-print" onclick="window.print()">🖨️ Yazdır / PDF</button>
        <button class="btn btn-primary" onclick="window.close()">✖ Kapat</button>
    </div>
</div>

<div class="layout">
<!-- SIDEBAR NAV -->
<nav class="sidebar no-print">
    <h3>İçindekiler</h3>
    <div class="nav-item active" onclick="navScrollTo('s-ozet')"><span class="nav-ico">📋</span> Özet</div>
    <div class="nav-item" onclick="navScrollTo('s-icdis')"><span class="nav-ico">⚖️</span> İç / Dış Başarısızlık</div>
    <div class="nav-item" onclick="navScrollTo('s-tedarikci')"><span class="nav-ico">🏭</span> Tedarikçi Kaynaklı</div>
    <div class="nav-item" onclick="navScrollTo('s-malzeme')"><span class="nav-ico">📦</span> Malzeme Bazlı</div>
    <div class="nav-item" onclick="navScrollTo('s-musteri')"><span class="nav-ico">👥</span> Müşteri / Şube Bazlı</div>
    <div class="nav-item" onclick="navScrollTo('s-hatatipi')"><span class="nav-ico">🔍</span> Hata Tipi Dağılımı</div>
    <div class="nav-item" onclick="navScrollTo('s-6m')"><span class="nav-ico">🔧</span> 6M Kaynak Analizi</div>
    <div class="nav-item" onclick="navScrollTo('s-trend')"><span class="nav-ico">📈</span> Aylık Trend</div>
    <div class="nav-item" onclick="navScrollTo('s-aksiyon')"><span class="nav-ico">✅</span> Aksiyon Planı</div>
    <div class="nav-item" id="nav-snapshots" onclick="navScrollTo('s-snapshots')" style="display:none;"><span class="nav-ico">📷</span> Grafik Anlık Görüntüleri</div>
</nav>

<!-- MAIN CONTENT -->
<main class="main" id="mainArea">

    <!-- LOADING -->
    <div id="loadingState" class="empty-state">
        <div class="emo">⏳</div>
        <p>Rapor yükleniyor…</p>
    </div>

    <div id="reportContent" style="display:none;">

    <!-- REPORT HEADER -->
    <div class="report-header" id="s-ozet">
        <h1 id="rhTitle">Kalite Uygunsuzluk Raporu</h1>
        <div class="sub" id="rhSub">Uygunsuzluk Analizi — Tüm Veriler</div>
        <div class="rh-meta" id="rhMeta"></div>
    </div>

    <!-- KPI CARDS -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- İÇ / DIŞ BAŞARISIZLIK -->
    <div class="section" id="s-icdis">
        <div class="section-hdr">
            <span class="ico">⚖️</span>
            <h2>İç & Dış Başarısızlık Analizi</h2>
            <span class="hint">tipi alanına göre sınıflandırma</span>
        </div>
        <div class="section-body">
            <div class="ic-dis-grid" style="margin-bottom:24px;" id="icDisCards"></div>
            <div class="two-col">
                <div class="chart-wrap"><canvas id="cIcDis"></canvas></div>
                <div id="icDisTable"></div>
            </div>
            <!-- per-group pareto breakdown -->
            <div class="idb-bar no-print">
                <span>Kırılım:</span>
                <button class="idb-tab active" onclick="switchIdBreak('hataTipi',this)">Hata Tipi</button>
                <button class="idb-tab" onclick="switchIdBreak('cariAdi',this)">Tedarikçi</button>
                <button class="idb-tab" onclick="switchIdBreak('stokAdi',this)">Malzeme</button>
            </div>
            <div class="idb-bar" style="display:none" id="idbBarPrint">
                <span style="font-size:.8rem;font-weight:700;">Kırılım: <span id="idbPrintLabel">Hata Tipi</span></span>
            </div>
            <div class="id-pareto-grid">
                <div class="id-pareto-panel">
                    <div class="id-panel-title" style="color:#1d4ed8;">🏢 İç Başarısızlık Pareto</div>
                    <div style="min-height:260px;"><canvas id="cIcBreak" height="260"></canvas></div>
                    <div id="icBreakTable" style="margin-top:10px;"></div>
                </div>
                <div class="id-pareto-panel">
                    <div class="id-panel-title" style="color:#c2410c;">🚚 Dış Başarısızlık Pareto</div>
                    <div style="min-height:260px;"><canvas id="cDisBreak" height="260"></canvas></div>
                    <div id="disBreakTable" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TEDARİKÇİ -->
    <div class="section" id="s-tedarikci">
        <div class="section-hdr">
            <span class="ico">🏭</span>
            <h2>Tedarikçi Kaynaklı Hatalar</h2>
            <span class="hint">Cari adına göre Pareto — Top 15</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cTedarikci"></canvas></div>
                <div id="tedarikciTable"></div>
            </div>
        </div>
    </div>

    <!-- MALZEME -->
    <div class="section" id="s-malzeme">
        <div class="section-hdr">
            <span class="ico">📦</span>
            <h2>Malzeme (Stok Adı) Bazlı Hatalar</h2>
            <span class="hint">Stok adına göre Pareto — Top 15</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cMalzeme"></canvas></div>
                <div id="malzemeTable"></div>
            </div>
        </div>
    </div>

    <!-- MÜŞTERİ / ŞUBE -->
    <div class="section" id="s-musteri">
        <div class="section-hdr">
            <span class="ico">👥</span>
            <h2>Müşteri / Şube Bazlı Hata Dağılımı</h2>
            <span class="hint">Tespit yerlerine göre — dış kaynaklılar ön plana</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cMusteri"></canvas></div>
                <div id="musteriTable"></div>
            </div>
        </div>
    </div>

    <!-- HATA TİPİ -->
    <div class="section" id="s-hatatipi">
        <div class="section-hdr">
            <span class="ico">🔍</span>
            <h2>Hata Tipi Dağılımı</h2>
            <span class="hint">Pareto + kümülatif</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cHataTipi"></canvas></div>
                <div id="hataTipiTable"></div>
            </div>
        </div>
    </div>

    <!-- 6M -->
    <div class="section" id="s-6m">
        <div class="section-hdr">
            <span class="ico">🔧</span>
            <h2>6M Kaynak Analizi</h2>
            <span class="hint">hataKaynagi alanı anahtar kelime sınıflandırması</span>
        </div>
        <div class="section-body">
            <div class="m6-grid" id="m6Grid" style="margin-bottom:24px;"></div>
            <div class="two-col">
                <div class="chart-wrap" style="min-height:260px;"><canvas id="c6M" height="260"></canvas></div>
                <div id="m6Detail"></div>
            </div>
            <!-- FISHBONE — Pareto gruplarına göre çoklu kılçık -->
            <div id="multiFbSection" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- TREND -->
    <div class="section" id="s-trend">
        <div class="section-hdr">
            <span class="ico">📈</span>
            <h2>Aylık Trend Analizi</h2>
            <span class="hint">Hatalı miktar aylara göre — son 18 ay</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall" style="grid-column:1/-1;"><canvas id="cTrend"></canvas></div>
            </div>
            <div id="trendInsight" style="margin-top:16px; padding:14px 18px; background:#eff6ff; border-radius:10px; border-left:4px solid var(--c-accent); font-size:.85rem; color:#1e3a8a;"></div>
        </div>
    </div>

    <!-- AKSİYON PLANI -->
    <div class="section" id="s-aksiyon">
        <div class="section-hdr">
            <span class="ico">✅</span>
            <h2>Aksiyon Planı Önerileri</h2>
            <span class="hint">Veriye dayalı otomatik oluşturuldu</span>
        </div>
        <div class="section-body">
            <div class="ap-section-toolbar">
                <p style="color:var(--c-sub);font-size:.8rem;margin:0;flex:1;">Analiz bulgularına göre otomatik oluşturulmuştur. Düzenleyebilir, silebilir veya yeni satır ekleyebilirsiniz.</p>
                <button class="ap-btn ap-btn-add no-print" onclick="apOpenAdd()">＋ Satır Ekle</button>
            </div>
            <table class="ap-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Bulgu / Problem</th>
                        <th>Kategori</th>
                        <th>Önerilen Aksiyon</th>
                        <th>Öncelik</th>
                        <th>Sorumlu</th>
                        <th>Durum</th>
                        <th>Tamamlanma Tarihi</th>
                        <th>Faaliyet</th>
                        <th class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="aksiyonBody"></tbody>
            </table>
        </div>
    </div>

    <!-- CHART SNAPSHOTS -->
    <div class="section hidden-sec" id="s-snapshots">
        <div class="section-hdr">
            <span class="ico">📷</span>
            <h2>Grafik Anlık Görüntüleri</h2>
            <span class="hint">Analiz sayfasından eklenen grafik görüntüleri</span>
            <button class="kr-hide-btn no-print" onclick="krHideSection('s-snapshots')" title="Bu bölümü gizle">🚫</button>
        </div>
        <div class="section-body">
            <div class="snap-grid" id="snapGrid"><div class="snap-empty">Henüz grafik anlık görüntüsü eklenmedi.</div></div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="apModal">
        <div id="apModalBox">
            <h3 id="apModalTitle">Satırı Düzenle</h3>
            <div class="ap-field">
                <label>Bulgu / Problem</label>
                <textarea id="apFBulgu" rows="2"></textarea>
            </div>
            <div class="ap-modal-row">
                <div class="ap-field">
                    <label>Kategori</label>
                    <select id="apFKat">
                        <option value="Hata Tipi|badge-red">Hata Tipi</option>
                        <option value="Tedarikçi|badge-purple">Tedarikçi</option>
                        <option value="Malzeme|badge-yellow">Malzeme</option>
                        <option value="İç Başarısızlık|badge-blue">İç Başarısızlık</option>
                        <option value="Dış Başarısızlık|badge-red">Dış Başarısızlık</option>
                        <option value="6M Analizi|badge-green">6M Analizi</option>
                        <option value="Sistem|badge-gray">Sistem</option>
                        <option value="Diğer|badge-gray">Diğer</option>
                    </select>
                </div>
                <div class="ap-field">
                    <label>Öncelik</label>
                    <select id="apFOncelik">
                        <option value="Yüksek">Yüksek</option>
                        <option value="Orta">Orta</option>
                        <option value="Düşük">Düşük</option>
                    </select>
                </div>
            </div>
            <div class="ap-field">
                <label>Önerilen Aksiyon</label>
                <textarea id="apFAksiyon" rows="3"></textarea>
            </div>
            <div class="ap-modal-row">
                <div class="ap-field">
                    <label>Sorumlu</label>
                    <input type="text" id="apFSorumlu" placeholder="örn: Kalite Müdürü">
                </div>
                <div class="ap-field">
                    <label>Durum</label>
                    <select id="apFDurum">
                        <option value="Beklemede">Beklemede</option>
                        <option value="Devam Ediyor">Devam Ediyor</option>
                        <option value="Tamamlandı">Tamamlandı</option>
                        <option value=İptal">İptal</option>
                    </select>
                </div>
            </div>
            <div class="ap-field">
                <label>Tamamlanma Tarihi</label>
                <input type="date" id="apFTarih">
            </div>
            <div class="ap-field">
                <label>Faaliyet</label>
                <select id="apFFaaliyet">
                    <option value="">— Seç —</option>
                    <option value="5 Neden (5-Why)">5 Neden (5-Why)</option>
                    <option value="PDCA (Plan-Do-Check-Act)">PDCA (Plan-Do-Check-Act)</option>
                    <option value="FMEA">FMEA</option>
                    <option value="8D Raporu">8D Raporu</option>
                    <option value="A3 Raporu">A3 Raporu</option>
                    <option value="Kaizen / Sürekli İyileştirme">Kaizen / Sürekli İyileştirme</option>
                    <option value="DMAIC (Six Sigma)">DMAIC (Six Sigma)</option>
                    <option value="Pareto Analizi (80/20)">Pareto Analizi (80/20)</option>
                    <option value="Poka-Yoke (Hata Engelleme)">Poka-Yoke (Hata Engelleme)</option>
                    <option value="Lean / Değer Akışı (VSM)">Lean / Değer Akışı (VSM)</option>
                    <option value="SPC / Kontrol Grafikleri">SPC / Kontrol Grafikleri</option>
                    <option value="TPM (Toplam Verimli Bakım)">TPM (Toplam Verimli Bakım)</option>
                    <option value="SMED (Hızlı Kalıp Değişimi)">SMED (Hızlı Kalıp Değişimi)</option>
                    <option value="DoE (Deney Tasarımı)">DoE (Deney Tasarımı)</option>
                    <option value="Kano Modeli">Kano Modeli</option>
                </select>
            </div>
            <div class="ap-modal-footer">
                <button class="ap-modal-cancel" onclick="apCloseModal()">İptal</button>
                <button class="ap-modal-save" onclick="apSaveModal()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- SNAPSHOT MODAL -->
    <div id="krSnapModal">
        <div id="krSnapBox">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
                <h3 style="margin:0;font-size:1rem;">📁 Kayıtlı Raporlar</h3>
                <button onclick="document.getElementById('krSnapModal').classList.remove('open')" style="margin-left:auto;background:#f1f5f9;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:.82rem;font-weight:600;">✕ Kapat</button>
            </div>
            <div id="krSnapList"></div>
        </div>
    </div>

    <!-- FOOTER -->
    <div style="text-align:center; color:var(--c-sub); font-size:.75rem; padding:24px 0; margin-top:8px;">
        Rapor <span id="footerDate"></span> tarihinde oluşturuldu · Kalite Yönetim Sistemi
    </div>

    </div><!-- /reportContent -->
</main>
</div><!-- /layout -->

<script>
// ── Scroll progress ──
window.addEventListener('scroll', () => {
    const el = document.getElementById('scrollProg');
    const pct = window.scrollY / (document.body.scrollHeight - window.innerHeight) * 100;
    if(el) el.style.width = Math.min(pct, 100) + '%';
});

// ── Nav active ──
function navScrollTo(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
}

// ── Helpers ──
function fmtN(n, d=0) {
    if (n == null || isNaN(n)) return '—';
    return Number(n).toLocaleString('tr-TR', { maximumFractionDigits: d });
}
function fmtPct(p) { return '%' + Number(p).toFixed(1); }
function truncate(s, n=40) { return s && s.length > n ? s.slice(0, n) + '…' : (s || ''); }

// ── IndexedDB yardımcı ──
const _IDB = { name:'KaliteRaporDB', store:'payloads', key:'rapor_payload', ver:1 };
function idbLoadRapor() {
    return new Promise((res, rej) => {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            const db = e.target.result;
            const tx = db.transaction(_IDB.store, 'readonly');
            const g  = tx.objectStore(_IDB.store).get(_IDB.key);
            g.onsuccess = () => res(g.result);
            g.onerror   = () => rej(g.error);
        };
        r.onerror = () => rej(r.error);
    });
}

// ── Kapsamlı Rapor Düzen Kaydet / Yükleme (IndexedDB) ──
const _KR_KEY = 'kapsamli_rapor_edits';

function _krSaveEdits() {
    const fbBoneCauses = {};
    if (window._fbData && window._fbData.bones) {
        window._fbData.bones.forEach(b => { fbBoneCauses[b.key] = b.causes || []; });
    }
    const fbEffect     = (window._fbData && window._fbData.effect) || window._fbEffect || '';
    const manualAksiyon = (window._aksiyonlar || []).filter(a => !a._fbSource);
    const payload = { version: 1, fbBoneCauses, fbEffect, manualAksiyon };
    const r = indexedDB.open(_IDB.name, _IDB.ver);
    r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
    r.onsuccess = e => {
        const db = e.target.result;
        db.transaction(_IDB.store, 'readwrite').objectStore(_IDB.store).put(payload, _KR_KEY);
    };
    // show brief save indicator
    const ind = document.getElementById('krSaveInd');
    if (ind) { ind.style.opacity='1'; clearTimeout(ind._t); ind._t = setTimeout(() => ind.style.opacity='0', 1800); }
}

function _krLoadEdits() {
    return new Promise(res => {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            const db = e.target.result;
            const g  = db.transaction(_IDB.store, 'readonly').objectStore(_IDB.store).get(_KR_KEY);
            g.onsuccess = () => res(g.result || null);
            g.onerror   = () => res(null);
        };
        r.onerror = () => res(null);
    });
}

function _krApplyFishboneEdits(saved) {
    if (!saved || !saved.fbBoneCauses || !window._fbData) return;
    if (saved.fbEffect) { window._fbData.effect = saved.fbEffect; window._fbEffect = saved.fbEffect; }
    window._fbData.bones.forEach(bone => {
        if (saved.fbBoneCauses[bone.key] !== undefined) bone.causes = saved.fbBoneCauses[bone.key];
    });
    drawFishbone();
    renderFbEditPanels();
}

function _krApplyAksiyonEdits(saved) {
    if (!saved || !window._aksiyonlar) return;
    const manual = (saved.manualAksiyon || []);
    if (!manual.length) return;
    // replace auto-generated rows (keep _fbSource rows, but remove originals that would duplicate)
    const savedKeys = new Set(manual.map(a => a.bulgu));
    window._aksiyonlar = window._aksiyonlar.filter(a => a._fbSource || !savedKeys.has(a.bulgu));
    window._aksiyonlar.push(...manual);
    renderAksiyonTablosu();
}

// ── Generic IDB helpers ──
function _idbGet(key) {
    return new Promise(res => {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            const g = e.target.result.transaction(_IDB.store,'readonly').objectStore(_IDB.store).get(key);
            g.onsuccess = () => res(g.result ?? null);
            g.onerror   = () => res(null);
        };
        r.onerror = () => res(null);
    });
}
function _idbPut(key, value) {
    return new Promise(res => {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            const tx = e.target.result.transaction(_IDB.store,'readwrite');
            tx.objectStore(_IDB.store).put(value, key);
            tx.oncomplete = () => res(true);
            tx.onerror    = () => res(false);
        };
        r.onerror = () => res(false);
    });
}
function _idbDel(key) {
    return new Promise(res => {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            const tx = e.target.result.transaction(_IDB.store,'readwrite');
            tx.objectStore(_IDB.store).delete(key);
            tx.oncomplete = () => res(true);
            tx.onerror    = () => res(false);
        };
        r.onerror = () => res(false);
    });
}

// ── Snapshot save / list / load / delete ──
const _SNAPS_KEY = 'kr_snapshots';

async function krSaveSnapshot() {
    const payload = await _idbGet(_IDB.key);
    if (!payload) { alert('Önce bir rapor yüklenmelidir.'); return; }
    const defaultName = (payload.title || 'Rapor') + ' — ' + new Date().toLocaleDateString('tr-TR');
    const name = prompt('Bu rapor için bir isim girin:', defaultName);
    if (name === null) return;
    const edits = await _krLoadEdits();
    const rows  = payload.rows || [];
    const id    = 'snap_' + Date.now();
    const meta  = {
        id, name: (name.trim() || defaultName), ts: Date.now(),
        recordCount: rows.length,
        totalHatali: rows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0),
        title: payload.title || ''
    };
    const list = (await _idbGet(_SNAPS_KEY)) || [];
    list.push(meta);
    await _idbPut(_SNAPS_KEY, list);
    await _idbPut('kr_' + id, { payload, edits });
    const ind = document.getElementById('krSaveInd');
    if (ind) { ind.textContent = '✔ Snapshot kaydedildi'; ind.style.opacity='1'; clearTimeout(ind._t); ind._t = setTimeout(() => { ind.style.opacity='0'; ind.textContent='✔ Kaydedildi'; }, 2500); }
}

async function krOpenSnapshotModal() {
    const list = (await _idbGet(_SNAPS_KEY)) || [];
    const body = document.getElementById('krSnapList');
    if (!body) return;
    if (!list.length) {
        body.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:24px 0;">Henüz kayıtlı rapor yok.<br><small style="color:#c4cdd8;">Raporu kaydetmek için üst çubuktaki 💾 Kaydet butonunu kullanın.</small></p>';
    } else {
        body.innerHTML = list.slice().reverse().map(m => `
            <div class="kr-snap-row">
                <div class="kr-snap-info">
                    <div class="kr-snap-name">${esc(m.name)}</div>
                    <div class="kr-snap-meta">${new Date(m.ts).toLocaleString('tr-TR')} &nbsp;·&nbsp; ${fmtN(m.recordCount)} kayıt &nbsp;·&nbsp; ${fmtN(m.totalHatali)} hatalı</div>
                </div>
                <div class="kr-snap-btns">
                    <button class="ap-btn ap-btn-edit" onclick="krLoadSnapshot('${m.id}')">📂 Yükle</button>
                    <button class="ap-btn ap-btn-del"  onclick="krDeleteSnapshot('${m.id}')">🗑️</button>
                </div>
            </div>`.trim()).join('');
    }
    document.getElementById('krSnapModal').classList.add('open');
}

async function krDeleteSnapshot(id) {
    if (!confirm('Bu kayıtlı rapor silinsin mi?')) return;
    const list = (await _idbGet(_SNAPS_KEY)) || [];
    await _idbPut(_SNAPS_KEY, list.filter(m => m.id !== id));
    await _idbDel('kr_' + id);
    krOpenSnapshotModal();
}

async function krLoadSnapshot(id) {
    const snap = await _idbGet('kr_' + id);
    if (!snap || !snap.payload) { alert('Snapshot verisi bulunamadı.'); return; }
    document.getElementById('krSnapModal').classList.remove('open');
    // persist back to IDB so refresh also loads this snapshot
    await _idbPut(_IDB.key, snap.payload);
    if (snap.edits) await _idbPut(_KR_KEY, snap.edits);
    else await _idbDel(_KR_KEY);
    _destroyCharts();
    runReport(snap.payload);
}

function _destroyCharts() {
    try { Object.values(Chart.instances || {}).forEach(c => { try { c.destroy(); } catch(e) {} }); } catch(e) {}
}

// ── Delete single chart snapshot ──
async function krDeleteSnap(idx) {
    if (!confirm('Bu grafik görüntüsü kaldırılsın mı?')) return;
    const payload = await _idbGet(_IDB.key);
    if (!payload || !payload.chartSnapshots) return;
    payload.chartSnapshots.splice(idx, 1);
    await _idbPut(_IDB.key, payload);
    _destroyCharts();
    runReport(payload);
}

// ── EDIT MODE ──
window._fbDataArr   = [];
window._fbActiveIdx = 0;
function _fbActivate(idx) {
    window._fbActiveIdx = idx;
    window._fbData = window._fbDataArr[idx] || window._fbData;
}
let _editMode = false;
function toggleEditMode() {
    _editMode = !_editMode;
    const btn = document.getElementById('btnEditMode');

    // All selectors that should be editable in-place
    const SEL = [
        '#rhTitle', '#rhSub', '.rh-tag',
        '.kpi-card .kval', '.kpi-card .klbl', '.kdiff',
        '.section-hdr h2', '.section-hdr .hint',
        '#trendInsight',
        '.ic-card h3', '.ic-card .ic-val',
        '.m6-card .m6-title', '.m6-card .m6-val', '.m6-card .m6-list',
        '.id-panel-title',
        '.ed',                        // all .ed spans / divs across tables
        '#icDisTable td', '#icDisTable th',
        '#tedarikciTable td', '#tedarikciTable th',
        '#malzemeTable td',  '#malzemeTable th',
        '#musteriTable td',  '#musteriTable th',
        '#hataTipiTable td', '#hataTipiTable th',
        '#idBreakContainer td', '#idBreakContainer th',
        '#icBreakTable td',  '#icBreakTable th',
        '#disBreakTable td', '#disBreakTable th',
        '#m6Detail div',
        '.m6-card',
        '.ap-table td', '.ap-table th',
        '.rep-table td', '.rep-table th',
        '.kpi-row span', '.kpi-row td',
        'h1.rh-title', '.rh-sub', '.rh-period',
    ];

    document.querySelectorAll(SEL.join(',')).forEach(el => {
        el.contentEditable = _editMode ? 'true' : 'false';
        if (_editMode) el.dataset.ed = '1';
        else delete el.dataset.ed;
    });

    document.body.classList.toggle('report-editing', _editMode);

    if (btn) {
        btn.innerHTML = _editMode ? '💾 Düzenlemeyi Bitir' : '✏️ Raporu Düzenle';
        btn.className  = _editMode ? 'btn btn-success no-print' : 'btn btn-outline no-print';
    }
}

// ── Color palettes ──
const PAL_BLUE   = ['#1d4ed8','#2563eb','#3b82f6','#60a5fa','#93c5fd','#bfdbfe'];
const PAL_MIXED  = ['#2563eb','#7c3aed','#db2777','#dc2626','#d97706','#16a34a','#0891b2','#1d4ed8'];
const PAL_DANGER = ['#b91c1c','#dc2626','#ef4444','#f87171','#fca5a5','#fecaca'];
const PAL_OK     = '#16a34a';

function paretoColors(n) {
    const base = ['#2563eb','#7c3aed','#db2777','#dc2626','#d97706','#16a34a','#0891b2','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#22c55e','#06b6d4'];
    return Array.from({length:n}, (_, i) => base[i % base.length]);
}

// ── Pareto data helper ──
function paretoData(rows, field, n = 15) {
    const agg = {};
    const totalH = rows.reduce((s,r) => s + (Number(r.hataliMiktar)||0), 0) || 1;
    rows.forEach(r => {
        const v = (r[field] || '').trim();
        if (!v) return;
        if (!agg[v]) agg[v] = { h:0, c:0 };
        agg[v].h += Number(r.hataliMiktar)||0;
        agg[v].c++;
    });
    let entries = Object.entries(agg).sort((a,b) => b[1].h - a[1].h).slice(0, n);
    let cum = 0;
    return entries.map(([name, v]) => {
        cum += v.h;
        return { name, h: v.h, c: v.c, pct: v.h / totalH * 100, cumPct: cum / totalH * 100 };
    });
}

// ── Table builder ──
function buildParetoTable(entries, totalH, colorFn) {
    const maxH = entries[0]?.h || 1;
    let html = `<table class="rep-table"><thead><tr><th class="rank">#</th><th>Ad</th><th class="num">Hatalı</th><th class="pct">%</th></tr></thead><tbody>`;
    entries.slice(0,12).forEach((e,i) => {
        const col = colorFn ? colorFn(i) : paretoColors(12)[i];
        const pct = (e.h / (totalH||1) * 100).toFixed(1);
        html += `<tr>
            <td class="rank">${i+1}</td>
            <td><div class="ed" style="font-weight:600;margin-bottom:3px;">${truncate(e.name,38)}</div>
                <div class="prog-bar"><div class="prog-fill" style="width:${Math.round(e.h/maxH*100)}%;background:${col};"></div></div>
            </td>
            <td class="num ed">${fmtN(e.h)}</td>
            <td class="pct ed">${fmtPct(pct)}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

// ── Horizontal bar chart ──
function hBarChart(ctx, labels, values, colors, label='Hatalı Miktar') {
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{ label, data: values, backgroundColor: colors, borderRadius: 4, borderSkipped: false }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ` ${fmtN(ctx.raw)} adet`
                    }
                }
            },
            scales: {
                x: { ticks: { font:{size:10} }, grid:{ color:'#f1f5f9' } },
                y: { ticks: { font:{size:10}, callback: v => truncate(v, 28) } }
            }
        }
    });
}

// ── Pareto line+bar chart ──
function paretoChart(ctx, entries, singleColor) {
    const labels = entries.map(e => truncate(e.name, 22));
    const vals   = entries.map(e => e.h);
    const cums   = entries.map(e => e.cumPct);
    const cols   = singleColor ? Array(entries.length).fill(singleColor) : paretoColors(entries.length);
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { type:'bar',  label:'Hatalı Miktar', data:vals, backgroundColor:cols, yAxisID:'y', borderRadius:5, order:2 },
                { type:'line', label:'Kümülatif %',   data:cums, borderColor:'#dc2626', backgroundColor:'rgba(220,38,38,.08)', yAxisID:'y2', tension:.35, pointRadius:3, fill:true, order:1 }
            ]
        },
        options: {
            responsive:true, maintainAspectRatio:true,
            plugins: {
                legend:{ position:'top', labels:{ font:{size:11} } },
                tooltip:{ callbacks:{
                    label: ctx => ctx.datasetIndex===0 ? ` ${fmtN(ctx.raw)} adet` : ` %${Number(ctx.raw).toFixed(1)}`
                }}
            },
            scales: {
                x: { ticks:{ font:{size:9}, maxRotation:45 }, grid:{color:'#f1f5f9'} },
                y: { position:'left',  title:{display:true,text:'Hatalı Miktar',font:{size:10}}, ticks:{font:{size:10}} },
                y2:{ position:'right', min:0, max:100, title:{display:true,text:'%',font:{size:10}}, ticks:{ font:{size:10}, callback:v=>v+'%' }, grid:{display:false} }
            }
        }
    });
}

// ── 6M CLASSIFIER (same as main page) ──
function classify6M(rows) {
    const RULES = [
        { bone:'insan',   kws:['işçi','işcilik','iscilik','operatör','operator','personel','eğitim','egitim','dikkatsiz','ihmal','çalışan','calisan','insan','adam','yorgun','tecrübe','tecrubesiz'] },
        { bone:'malzeme', kws:['hammadde','ham madde','malzeme kalite','malzeme','tedarikçi','tedarikci','hammad','kalitesiz','stok','yar mamul','yarı mamul'] },
        { bone:'metot',   kws:['hatalı talimat','hatali talimat','prosedür','prosedur','yöntem','yontem','süreç','surec','standart','talimat','instruks','uygulama hatası'] },
        { bone:'makine',  kws:['makine','ekipman','kalibrasyon','arıza','ariza','bakım','bakim','tertibat','aparat','kalıp','kalip','pres','hidrolik'] },
        { bone:'olcum',   kws:['ölçüm','olcum','muayene','kontrol','test','ölçme','tolerans'] },
        { bone:'ortam',   kws:['sevkiyat','depolama','nakliye','çevre','cevre','sıcaklık','sicaklik','nem','ortam','ambalaj'] },
    ];
    const totalH = rows.reduce((s,r) => s+(Number(r.hataliMiktar)||0),0)||1;
    const agg = {};
    rows.forEach(r => {
        const v = (r.hataKaynagi||'').trim(); if(!v) return;
        if(!agg[v]) agg[v]={h:0,c:0};
        agg[v].h += Number(r.hataliMiktar)||0; agg[v].c++;
    });
    const result = { insan:[], malzeme:[], metot:[], makine:[], olcum:[], ortam:[] };
    Object.entries(agg).forEach(([name,v]) => {
        const lower = name.toLowerCase();
        let bone = null;
        for(const rule of RULES) { if(rule.kws.some(kw=>lower.includes(kw))){ bone=rule.bone; break; } }
        if(!bone) return;
        const pct = (v.h/totalH*100).toFixed(1);
        result[bone].push({ name, pct:Number(pct), h:v.h, c:v.c });
    });
    for(const k of Object.keys(result)) result[k].sort((a,b)=>b.h-a.h);
    return result;
}

// ── IC/DIS CLASSIFIER ──
function classifyIcDis(rows) {
    const ic = [], dis = [], tedarikci = [], belirsiz = [];

    // tipi alanı için IC / DIŞ / TEDARİKÇİ anahtar kelimeleri
    const IC_TIPI  = ['iç','ic','dahili','internal','iç ','in-house','üretim','imalat','fabrika'];
    const DIS_TIPI = ['dış','dis','external','müşteri','şikay','kargo','saha','servis','şube','nakliye','iade'];
    const TED_TIPI = ['tedarikçi','tedarikci','supplier','vendor'];

    // uygunsuzlukTuru alanı için sinyal kelimeleri
    const IC_URU   = ['iç','ic','dahili','iç kontrol','iç üretim','üretim'];
    const DIS_URU  = ['dış','müşteri','şikay','saha','iade','kargo'];
    const TED_URU  = ['tedarikçi','tedarikci','supplier','vendor'];

    function matchesAny(str, kwList) {
        const s = (str||'').toLowerCase().trim();
        return kwList.some(kw => s.includes(kw));
    }

    rows.forEach(r => {
        const tipi = (r.tipi||'').toLowerCase().trim();
        const tur  = (r.uygunsuzlukTuru||'').toLowerCase().trim();

        // 1. Önce tipi alanına bak
        if (tipi && matchesAny(tipi, TED_TIPI)) { tedarikci.push(r); return; }
        if (tipi && matchesAny(tipi, IC_TIPI))  { ic.push(r);        return; }
        if (tipi && matchesAny(tipi, DIS_TIPI)) { dis.push(r);       return; }

        // 2. uygunsuzlukTuru alanına bak
        if (tur  && matchesAny(tur,  TED_URU))  { tedarikci.push(r); return; }
        if (tur  && matchesAny(tur,  IC_URU))   { ic.push(r);        return; }
        if (tur  && matchesAny(tur,  DIS_URU))  { dis.push(r);       return; }

        // 3. Hala eşleşmediyse — belirsiz olarak işaretle (hatalı İç'e atmayız)
        belirsiz.push(r);
    });

    return { ic, dis, tedarikci, belirsiz };
}

// tipi ve uygunsuzlukTuru değerlerinin benzersiz listesini ve sayımlarını döndür
function getIcDisDiagnostic(rows) {
    const tipiCount = {}, turCount = {};
    rows.forEach(r => {
        const t = (r.tipi||'(boş)').trim();
        const u = (r.uygunsuzlukTuru||'(boş)').trim();
        tipiCount[t] = (tipiCount[t]||0) + 1;
        turCount[u]  = (turCount[u] ||0) + 1;
    });
    return { tipiCount, turCount };
}

// ── SAFE PARSE DATE ──
function parseDateStr(s) {
    if (!s) return null;
    if (s instanceof Date) return isNaN(s.getTime()) ? null : s;
    const str = String(s).trim();
    // DD.MM.YYYY or DD/MM/YYYY
    let m = str.match(/^(\d{1,2})[.\/\-](\d{1,2})[.\/\-](\d{4})$/);
    if (m) return new Date(+m[3], +m[2]-1, +m[1]);
    // YYYY-MM-DD
    m = str.match(/^(\d{4})[.\-\/](\d{2})[.\-\/](\d{2})/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3]);
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
}

// ── MONTHLY TREND ──
function buildTrend(rows) {
    const map = {};
    rows.forEach(r => {
        const d = parseDateStr(r.uygunsuzlukTarih);
        if (!d) return;
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        if (!map[key]) map[key] = { h:0, c:0 };
        map[key].h += Number(r.hataliMiktar)||0;
        map[key].c++;
    });
    const keys = Object.keys(map).sort();
    // limit to last 18 months
    const last18 = keys.slice(-18);
    return {
        labels: last18.map(k => {
            const [y,m] = k.split('-');
            const months = ['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara'];
            return `${months[+m-1]} ${y.slice(2)}`;
        }),
        hatali: last18.map(k => map[k].h),
        kayit:  last18.map(k => map[k].c),
        keys: last18
    };
}

// ── ACTION PLAN GENERATOR ──
function generateActionPlan(rows, topHataTipi, topTedarikci, topMalzeme, icDis, m6) {
    const actions = [];
    const totalH = rows.reduce((s,r) => s+(Number(r.hataliMiktar)||0),0)||1;
    const _def = { sorumlu:'', durum:'Beklemede', tarih:'' };

    // Top hata tipi
    topHataTipi.slice(0,3).forEach((e,i) => {
        actions.push({
            bulgu: `En yüksek hata tipi: "${truncate(e.name,35)}"`,
            kat: 'Hata Tipi', katBadge: 'badge-red',
            aksiyon: `Kök neden analizi yapılmalı (5-Neden / Fishbone). Hata oluşum koşulları belirlenmeli ve düzeltici faaliyet başlatılmalı.`,
            oncelik: i===0 ? 'Yüksek' : 'Orta',
            ..._def
        });
    });

    // Top tedarikçi
    topTedarikci.slice(0,2).forEach((e,i) => {
        const pct = (e.h/totalH*100).toFixed(1);
        actions.push({
            bulgu: `Tedarikçi "${truncate(e.name,30)}" toplam hatanın %${pct}'ini oluşturuyor`,
            kat: 'Tedarikçi', katBadge: 'badge-purple',
            aksiyon: `Tedarikçi denetimi planlanmalı. Giriş muayene kriterleri gözden geçirilmeli. Gerekirse alternatif tedarikçi değerlendirmesi yapılmalı.`,
            oncelik: pct > 20 ? 'Yüksek' : 'Orta',
            ..._def
        });
    });

    // Top malzeme
    topMalzeme.slice(0,2).forEach((e,i) => {
        actions.push({
            bulgu: `Malzeme "${truncate(e.name,30)}" için yüksek hata oranı`,
            kat: 'Malzeme', katBadge: 'badge-yellow',
            aksiyon: `Bu malzeme için muayene talimatı / kontrol planı güncellenmeli. Tedarikçiden kalite sertifikası (CoA) talep edilmeli.`,
            oncelik: 'Orta',
            ..._def
        });
    });

    // İç/Dış analizi
    const icH  = icDis.ic.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const disH = icDis.dis.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    if (disH > icH * 0.3) {
        actions.push({
            bulgu: `Dış başarısızlık oranı yüksek (%${(disH/totalH*100).toFixed(1)}) — müşteri/saha şikayetleri`,
            kat: 'Dış Başarısızlık', katBadge: 'badge-red',
            aksiyon: `Sevkiyat öncesi son kontrol prosedürü güçlendirilmeli. Paketleme & etiketleme prosedürü gözden geçirilmeli. Müşteri iade süreç haritası çizilmeli.`,
            oncelik: 'Yüksek',
            ..._def
        });
    }
    if (icH > totalH * 0.5) {
        actions.push({
            bulgu: `İç başarısızlık oranı dominant (%${(icH/totalH*100).toFixed(1)}) — süreç içi israf`,
            kat: 'İç Başarısızlık', katBadge: 'badge-blue',
            aksiyon: `Üretim / hizmet sürecinde proses kontrol noktaları artırılmalı. Operatör eğitimi ve farkındalık programı düzenlenmeli. Kalite kontrol noktaları gözden geçirilmeli.`,
            oncelik: 'Orta',
            ..._def
        });
    }

    // 6M insights
    const m6Totals = Object.entries(m6).map(([k,v]) => ({ k, h: v.reduce((s,e)=>s+e.h,0) })).sort((a,b)=>b.h-a.h);
    if (m6Totals[0] && m6Totals[0].h > 0) {
        const boneMap = { insan:'İnsan (eğitim/işçilik)', malzeme:'Malzeme', metot:'Metot/Süreç', makine:'Makine/Ekipman', olcum:'Ölçüm/Muayene', ortam:'Ortam/Lojistik' };
        const boneAct = {
            insan:   'Personel eğitim programı ve çalışma talimatı güncellemesi planlanmalı.',
            malzeme: 'Malzeme kabul kriterleri ve tedarikçi değerlendirmesi gözden geçirilmeli.',
            metot:   'Proses talimatları ve standart çalışma prosedürleri (SOP) güncellenmeli.',
            makine:  'Periyodik bakım planı oluşturulmalı / güncellenmeli. Kalibrasyon takibi yapılmalı.',
            olcum:   'Ölçüm sistemi analizi (MSA) yapılmalı. Muayene talimatları güncellenmeli.',
            ortam:   'Depolama & sevkiyat koşulları iyileştirilmeli. Ambalaj standardı belirlenmeli.'
        };
        actions.push({
            bulgu: `6M analizine göre en yüksek kaynak: ${boneMap[m6Totals[0].k]}`,
            kat: '6M Analizi', katBadge: 'badge-green',
            aksiyon: boneAct[m6Totals[0].k] || 'Kök neden analizi derinleştirilmeli.',
            oncelik: 'Orta',
            ..._def
        });
    }

    // Genel
    actions.push({
        bulgu: 'Periyodik kalite gözden geçirme toplantısı eksikliği riski',
        kat: 'Sistem', katBadge: 'badge-gray',
        aksiyon: 'Aylık KPI takibi için kalite gözden geçirme toplantısı takvimi oluşturulmalı. Bu rapor bazında aylık trend izlenmeli.',
        oncelik: 'Düşük',
            ..._def
    });

    return actions;
}

// ─────────────────────────────────────────────
// İÇ/DIŞ PARETO BREAKDOWN
// ─────────────────────────────────────────────
const _ID_LABELS = { hataTipi:'Hata Tipi', cariAdi:'Tedarikçi', stokAdi:'Malzeme' };

function _idBuildPareto(groupRows, field, n) {
    // reuse paretoData helper: build manually to use groupRows
    const totalH = groupRows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0)||1;
    const agg = {};
    groupRows.forEach(r => {
        const v = (r[field]||'').trim(); if(!v) return;
        if(!agg[v]) agg[v]={h:0,c:0};
        agg[v].h += Number(r.hataliMiktar)||0; agg[v].c++;
    });
    let cum=0;
    return Object.entries(agg).sort((a,b)=>b[1].h-a[1].h).slice(0,n).map(([name,v])=>{
        cum+=v.h;
        return {name, h:v.h, c:v.c, pct:v.h/totalH*100, cumPct:cum/totalH*100};
    });
}

function switchIdBreak(field, btn) {
    // update active tab
    if (btn) {
        document.querySelectorAll('.idb-tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }
    const lbl = _ID_LABELS[field] || field;
    const el = document.getElementById('idbPrintLabel');
    if (el) el.textContent = lbl;

    const idRows = window._idRows;
    if (!idRows) return;

    const IC_COLOR  = '#2563eb';
    const DIS_COLOR = '#ea580c';

    // destroy old charts
    ['_idIcChart','_idDisChart'].forEach(k => {
        if (window[k]) { try { window[k].destroy(); } catch(e){} window[k]=null; }
    });

    // ─ İç ─
    const icData = _idBuildPareto(idRows.ic, field, 12);
    const icEl = document.getElementById('cIcBreak');
    if (icData.length) {
        const icTotalH = idRows.ic.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0)||1;
        icEl.style.display = '';
        window._idIcChart = paretoChart(icEl, icData, IC_COLOR);
        document.getElementById('icBreakTable').innerHTML = _idTable(icData, icTotalH, IC_COLOR);
    } else {
        icEl.style.display = 'none';
        document.getElementById('icBreakTable').innerHTML = '<p style="color:var(--c-sub);font-size:.8rem;text-align:center;">İç başarısızlık kaydı yok</p>';
    }

    // ─ Dış ─
    const disData = _idBuildPareto(idRows.dis, field, 12);
    const disEl = document.getElementById('cDisBreak');
    if (disData.length) {
        const disTotalH = idRows.dis.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0)||1;
        disEl.style.display = '';
        window._idDisChart = paretoChart(disEl, disData, DIS_COLOR);
        document.getElementById('disBreakTable').innerHTML = _idTable(disData, disTotalH, DIS_COLOR);
    } else {
        disEl.style.display = 'none';
        document.getElementById('disBreakTable').innerHTML = '<p style="color:var(--c-sub);font-size:.8rem;text-align:center;">Dış başarısızlık kaydı yok</p>';
    }
}

function _idTable(data, totalH, color) {
    const maxH = data[0]?.h||1;
    let h = `<table class="rep-table"><thead><tr><th class="rank">#</th><th>Ad</th><th class="num">Miktar</th><th class="pct">% (grup)</th></tr></thead><tbody>`;
    data.forEach((e,i) => {
        const pct = (e.pct).toFixed(1);
        const bar = Math.round(e.h/maxH*100);
        h += `<tr><td class="rank">${i+1}</td><td>
            <div class="ed" style="font-weight:600;margin-bottom:3px;">${truncate(e.name,40)}</div>
            <div class="prog-bar"><div class="prog-fill" style="width:${bar}%;background:${color};"></div></div>
        </td><td class="num ed">${fmtN(e.h)}</td><td class="pct ed">${fmtPct(pct)}</td></tr>`;
    });
    return h + '</tbody></table>';
}

// ─────────────────────────────────────────────
// FISHBONE DIAGRAM
// ─────────────────────────────────────────────
const _FB = {
    W:1200, H:560, SY:280, SS:80, SE:970,
    L:210, A:50,
    TPOS:[0.15, 0.32, 0.50, 0.67, 0.84],
};

// Fixed 6M bones
const FB_6M = [
    { key:'insan',   label:'İnsan',   color:'#ef4444', pos:'top'    },
    { key:'makine',  label:'Makine',  color:'#f59e0b', pos:'bottom' },
    { key:'malzeme', label:'Malzeme', color:'#3b82f6', pos:'top'    },
    { key:'metot',   label:'Metot',   color:'#8b5cf6', pos:'bottom' },
    { key:'olcum',   label:'Ölçüm',   color:'#06b6d4', pos:'top'    },
    { key:'ortam',   label:'Ortam',   color:'#22c55e', pos:'bottom' },
];

// ── Public entry point (called once on data load) ──
function initFishbone(rows, _htData, effectLabel) {
    window._fbRows   = rows;
    window._fbEffect = effectLabel || 'Ana Kalite Problemi';
    rebuildFishboneData();
}

// Normalize cause: string or {name,subs} → always {name,subs}
function fbNorm(c) { return typeof c === 'string' ? {name:c, subs:[]} : (c || {name:'', subs:[]}); }
function fbNormSub(s) { return typeof s === 'string' ? {name:s, subs:[]} : (s || {name:'', subs:[]}); }

// ── Re-build 6M bones from current rows ──
function rebuildFishboneData() {
    const rows   = window._fbRows || [];
    const m6data = classify6M(rows);

    const totalH = rows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0)||1;
    const m6Vals = {};
    FB_6M.forEach(b => { m6Vals[b.key] = m6data[b.key].reduce((s,e)=>s+e.h,0); });

    const bones = FB_6M.map(b => {
        const items  = m6data[b.key] || [];
        const causes = items.slice(0,5).map(e=>({name:e.name, subs:[]}));
        const h      = m6Vals[b.key];
        const pct    = +(h/totalH*100).toFixed(1);
        return { key:b.key, label:b.label, color:b.color, pos:b.pos, causes, pct, cumPct:0 };
    });

    window._fbData = { effect: window._fbEffect, bones };
    drawFishbone();
    renderFbEditPanels();
}

// kept for backward compat
function switchFbPareto(pct, btn) { rebuildFishboneData(); }

// —— Çoklu fishbone: Pareto gruplarına göre her hata tipi için ayrı balık kılçığı ——
function renderMultipleFishbones(groups, allRows) {
    window._fbDataArr = [];
    // Grup yoksa tüm veriyle tek fishbone
    const effectiveGroups = (groups && groups.length)
        ? groups
        : [{ label: window._fbEffect || 'Ana Kalite Problemi',
             groupRows: allRows,
             totalHatali: allRows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0),
             count: allRows.length, pct: 100 }];

    // Her grup için fbData oluştur
    effectiveGroups.forEach(g => {
        const rows   = g.groupRows || allRows;
        const m6data = classify6M(rows);
        const totalH = rows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0) || 1;
        const bones  = FB_6M.map(b => {
            const items  = m6data[b.key] || [];
            const causes = items.slice(0, 5).map(e => ({ name: e.name, subs: [] }));
            const h      = items.reduce((s,e) => s + e.h, 0);
            const pct    = +(h / totalH * 100).toFixed(1);
            return { key: b.key, label: b.label, color: b.color, pos: b.pos, causes, pct, cumPct: 0 };
        });
        window._fbDataArr.push({ effect: g.label, bones });
    });

    window._fbActiveIdx = 0;
    window._fbData      = window._fbDataArr[0] || { effect: '', bones: [] };

    const container = document.getElementById('multiFbSection');
    if (!container) return;

    container.innerHTML = effectiveGroups.map((g, i) => {
        const rows     = g.groupRows || allRows;
        const topRows  = [...rows].sort((a,b) => (Number(b.hataliMiktar)||0) - (Number(a.hataliMiktar)||0)).slice(0, 20);
        const tableBody = topRows.map(r => `
            <tr>
                <td>${esc(r.uygunsuzlukTarih||'\u2014')}</td>
                <td>${esc(r.cariAdi||'\u2014')}</td>
                <td>${esc(r.hataKaynagi||'\u2014')}</td>
                <td style="text-align:right;font-weight:700;">${fmtN(Number(r.hataliMiktar)||0)}</td>
                <td>${esc(r.tespitYeri||'\u2014')}</td>
            </tr>`).join('');
        return `
        <div class="fb-group-card" id="fbGroup_${i}">
            <div class="fb-group-hdr">
                <span class="fb-group-rank">${i + 1}</span>
                <span class="fb-group-name">${esc(g.label)}</span>
                <span class="fb-group-badge2">🔴 ${fmtN(g.totalHatali)} adet</span>
                <span class="fb-group-badge2">📋 ${g.count} kayıt</span>
                <span class="fb-group-badge2">%${g.pct}</span>
            </div>
            <div class="fb-section" onmousedown="_fbActivate(${i})">
                <div class="fb-header" onclick="_fbToggleBody(${i})">
                    <span style="font-weight:700;font-size:.9rem;color:#1e2535;">🐟 Balık Kılçığı — ${esc(g.label)}</span>
                    <span style="font-size:.75rem;color:#64748b;margin-left:auto;">6 kemik: İnsan · Makine · Malzeme · Metot · Ölçüm · Ortam</span>
                    <span id="fbChevron_${i}" style="font-size:.9rem;transition:transform .25s;display:inline-block;margin-left:6px;">▾</span>
                </div>
                <div class="fb-body" id="fbBody_${i}">
                <div class="fb-svg-wrap" id="fbContainer_${i}"></div>
                <div class="fb-edit-panels no-print" id="fbEditPanels_${i}"></div>
                </div>
            </div>
            <div class="fb-group-table">
                <h4 onclick="_krToggleFbTable(this)">
                    <span>📋 ${esc(g.label)} — En Yüksek Hatalı Miktar (ilk ${Math.min(20, rows.length)} kayıt)</span>
                    <span class="fb-table-chevron">▾</span>
                </h4>
                <div class="fb-table-body">
                <div style="overflow-x:auto;">
                <table class="ap-table" style="font-size:.78rem;">
                    <thead><tr>
                        <th>Tarih</th><th>Cari</th><th>Hata Kaynağı</th>
                        <th style="text-align:right;">Hatalı Miktar</th><th>Tespit Yeri</th>
                    </tr></thead>
                    <tbody>${tableBody}</tbody>
                </table>
                </div>
                </div>
            </div>
        </div>`;
    }).join('');

    // Tüm fishbone'ları çiz
    effectiveGroups.forEach((_, i) => {
        window._fbActiveIdx = i;
        window._fbData      = window._fbDataArr[i];
        drawFishbone();
        renderFbEditPanels();
    });
    // İlk fishbone aktif kalsın
    window._fbActiveIdx = 0;
    window._fbData      = window._fbDataArr[0];
}

function drawFishbone() {
    const data = window._fbData;
    if (!data || !data.bones || !data.bones.length) {
        const _cid = 'fbContainer_' + (window._fbActiveIdx ?? 0);
        const _cel = document.getElementById(_cid);
        if (_cel) _cel.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8;">Bu kategori için veri bulunamadı.</div>';
        return;
    }
    const {W, H, SY, SS, SE, L, A, TPOS} = _FB;
    const bones  = data.bones;
    const cosA   = Math.cos(A * Math.PI / 180);
    const sinA   = Math.sin(A * Math.PI / 180);
    const p      = [];

    // Background + grid
    p.push(`<rect width="${W}" height="${H}" fill="#f8fafc"/>`);
    for(let x=SS+60; x<=SE; x+=80)
        p.push(`<line x1="${x}" y1="14" x2="${x}" y2="${H-14}" stroke="#e8edf4" stroke-width="1"/>`);

    // Spine
    p.push(`<line x1="${SS}" y1="${SY}" x2="${SE}" y2="${SY}" stroke="#334155" stroke-width="4" stroke-linecap="round"/>`);
    p.push(`<polygon points="${SE+2},${SY} ${SE-14},${SY-9} ${SE-14},${SY+9}" fill="#334155"/>`);

    // Effect box (fish head)
    const EX=SE+18, EW=168, EH=92;
    p.push(`<rect x="${EX}" y="${SY-EH/2}" width="${EW}" height="${EH}" rx="12" fill="white" stroke="#ef4444" stroke-width="2.5"/>`);
    const effWords = (data.effect||'Ana Problem').split(' ');
    let ecur='', elines=[];
    effWords.forEach(w => {
        if((ecur+' '+w).trim().length > 15 && ecur){ elines.push(ecur.trim()); ecur=w; }
        else ecur = ecur ? ecur+' '+w : w;
    });
    if(ecur) elines.push(ecur.trim());
    elines.slice(0,4).forEach((ln,li) => {
        const ly = SY - (elines.length-1)*9 + li*18;
        p.push(`<text x="${EX+EW/2}" y="${ly}" text-anchor="middle" font-size="11.5" font-weight="700" fill="#1e293b">${esc(ln)}</text>`);
    });
    p.push(`<rect x="${EX}" y="${SY-EH/2}" width="${EW}" height="${EH}" rx="12" fill="transparent" cursor="pointer" onclick="fbEditEffect()"/>`);

    // Compute even spacing along spine
    const spineLen = SE - SS;
    const spacing  = spineLen / (bones.length + 1);

    bones.forEach((bone, bi) => {
        const sx     = +(SS + spacing * (bi + 1)).toFixed(1);
        const isTop  = bone.pos === 'top';
        const dir    = isTop ? -1 : 1;
        const color  = bone.color;

        // Kemik uzunluğunu neden + alt neden yönüne göre dinamik hesapla
        // Alt nedenler spine'a doğru çıkar (subDir = isTop?1:-1)
        // → bir önceki cause label'ıyla çakışmamak için adım formülü:
        //   step(i→i+1) = labelH(i) + GAP + subUpward(i+1)
        // ilk cause: spine'dan yeterli mesafe (subUpward varsa alt neden spine'ı aşmasın)
        const _BH=18, _SL=34, _SBH=15, _GAP=10, _LGap=4;
        const _causes = bone.causes || [];
        function _hasSub(rc) { const c=fbNorm(rc); return c.subs && c.subs.length > 0; }
        const _subUp = _SL + _SBH; // alt neden spine yönünde uzanma (49px)
        // ilk anchor: spine'dan en az _subUp+gap uzakta ol (eğer ilk cause'un sub'ı varsa)
        const _startM = _causes.length > 0 && _hasSub(_causes[0]) ? _subUp + _GAP : _GAP + _BH/2;
        const _pos0 = [_startM];
        for (let _i = 0; _i < _causes.length - 1; _i++) {
            const nextHasSub = _hasSub(_causes[_i + 1]);
            _pos0.push(_pos0[_i] + _BH + _LGap + _GAP + (nextHasSub ? _subUp : 0));
        }
        const _needed = _causes.length > 0
            ? _pos0[_pos0.length-1] + _BH + _LGap + _GAP
            : 0;
        // SVG sınırı: SY=280, A=50° → max L = (SY-20)/sinA
        const _maxL = Math.floor((SY - 20) / sinA);
        const effL  = Math.min(_maxL, Math.max(L, _needed > 0 ? Math.ceil(_needed / sinA) : 0));
        // Her neden için orantılı t değeri
        const _span = effL * sinA;
        const tVals = _pos0.map(p => Math.min(0.96, p / _span));

        const tipX = +(sx - effL * cosA).toFixed(1);
        const tipY = +(SY + dir * effL * sinA).toFixed(1);

        // Main bone line
        p.push(`<line x1="${sx}" y1="${SY}" x2="${tipX}" y2="${tipY}"
            stroke="${color}" stroke-width="3" stroke-linecap="round"/>`);

        // Category label at tip
        const lbl  = bone.label.length > 22 ? bone.label.slice(0,22)+'…' : bone.label;
        const lblY = isTop ? tipY - 14 : tipY + 20;
        p.push(`<text x="${tipX}" y="${lblY}" text-anchor="middle"
            font-size="12" font-weight="800" fill="${color}">${esc(lbl)}</text>`);

        // % badge
        const pctTxt = `%${+(bone.pct||0).toFixed(1)}`;
        const cumTxt = `(kümülâtif %${+(bone.cumPct||0).toFixed(1)})`;
        const badgeY = isTop ? tipY - 28 : tipY + 35;
        p.push(`<text x="${tipX}" y="${badgeY}" text-anchor="middle"
            font-size="9" fill="${color}" opacity="0.8">${pctTxt} ${cumTxt}</text>`);

        // Junction dot + add shortcut
        p.push(`<circle cx="${sx}" cy="${SY}" r="6" fill="${color}" opacity="0.25"/>`);
        p.push(`<text x="${sx}" y="${+(SY+5).toFixed(0)}" text-anchor="middle"
            font-size="15" font-weight="900" fill="${color}" cursor="pointer"
            onclick="fbFocusInput(${bi})" style="user-select:none">+</text>`);

        // Ribs (main causes)
        const causes = bone.causes || [];
        causes.forEach((rawCause, ci) => {
            const cause = fbNorm(rawCause);
            const name  = cause.name;
            const t  = ci < tVals.length ? tVals[ci] : (ci + 1) / (causes.length + 1);
            const px = +(sx  + t * (tipX - sx)).toFixed(1);
            const py = +(SY  + t * (tipY - SY)).toFixed(1);
            const rx = +(px - 78).toFixed(1);

            // Horizontal rib line
            p.push(`<line x1="${px}" y1="${py}" x2="${rx}" y2="${py}"
                stroke="${color}" stroke-width="1.6" opacity="0.75" stroke-linecap="round"/>`);
            // Arrow: tip at junction, base to left -> points INTO spine
            p.push(`<polygon points="${px},${py} ${+(px-8).toFixed(0)},${+(py-4).toFixed(0)} ${+(px-8).toFixed(0)},${+(py+4).toFixed(0)}"
                fill="${color}" opacity="0.75" style="pointer-events:none"/>`);

            // Label box above/below rib end
            const nm   = name.length > 20 ? name.slice(0,20)+'…' : name;
            const BW   = Math.max(60, nm.length * 6 + 16);
            const BH   = 18;
            const boxX = +(rx - BW / 2).toFixed(1);
            const boxY = isTop ? +(py - BH - 4).toFixed(1) : +(py + 4).toFixed(1);
            const txtY = +(boxY + BH * 0.72).toFixed(1);
            const delBtnX = +(parseFloat(boxX) + BW - 13).toFixed(1);
            p.push(`<rect x="${boxX}" y="${boxY}" width="${BW}" height="${BH}" rx="3"
                fill="white" stroke="${color}" stroke-width="1" opacity="0.92"/>`);
            // Label — sadece gösterim, tıklanmaz
            p.push(`<text x="${+(parseFloat(boxX)+4).toFixed(1)}" y="${txtY}" text-anchor="start"
                font-size="9" fill="#1e293b" style="pointer-events:none">${esc(nm)}</text>`);
            // Sadece × alanı tıklanabilir (kaldırır, geri alınabilir)
            p.push(`<g onclick="fbRemoveCause(${window._fbActiveIdx ?? 0},${bi},${ci})" style="cursor:pointer" title="Kaldır: ${esc(name)}">
                <rect x="${delBtnX}" y="${boxY}" width="13" height="${BH}" rx="0" fill="transparent"/>
                <text x="${+(parseFloat(delBtnX)+6.5).toFixed(1)}" y="${txtY}" text-anchor="middle"
                    font-size="11" fill="#ef4444" font-weight="700">×</text>
            </g>`);

            // Sub-ribs (alt-alt nedenler)
            const subs   = cause.subs || [];
            const subDir = isTop ? 1 : -1;
            const subLen = 34;
            subs.slice(0, 3).forEach((sub, si) => {
                const maxS = Math.min(subs.length, 3);
                const srX  = +(rx + (78 / (maxS + 1)) * (si + 1)).toFixed(1);
                const srTY = +(py + subDir * subLen).toFixed(1);
                p.push(`<line x1="${srX}" y1="${py}" x2="${srX}" y2="${srTY}"
                    stroke="${color}" stroke-width="1.1" opacity="0.5" stroke-dasharray="3,2"/>`);
                const _subN = fbNormSub(sub).name;
                const snm = _subN.length > 15 ? _subN.slice(0,15)+'…' : _subN;
                const SBW = Math.max(50, snm.length * 5.5 + 12);
                const SBH = 15;
                const sbX = +(srX - SBW/2).toFixed(1);
                const sbY = isTop ? srTY : +(parseFloat(srTY) - SBH).toFixed(1);
                const stY2 = +(parseFloat(sbY) + SBH * 0.73).toFixed(1);
                p.push(`<rect x="${sbX}" y="${sbY}" width="${SBW}" height="${SBH}" rx="2"
                    fill="white" stroke="${color}" stroke-width="0.8" opacity="0.82"/>`);
                // Alt neden label — tıklanmaz
                p.push(`<text x="${+(parseFloat(sbX)+3).toFixed(1)}" y="${stY2}" text-anchor="start"
                    font-size="7.5" fill="#1e293b" style="pointer-events:none">${esc(snm)}</text>`);
                // Alt neden × butonu
                const sDelX = +(parseFloat(sbX)+SBW-11).toFixed(1);
                p.push(`<g onclick="fbDeleteSub(${bi},${ci},${si})" style="cursor:pointer" title="Sil">
                    <rect x="${sDelX}" y="${sbY}" width="11" height="${SBH}" rx="0" fill="transparent"/>
                    <text x="${+(parseFloat(sDelX)+5.5).toFixed(1)}" y="${stY2}" text-anchor="middle"
                        font-size="10" fill="#ef4444" font-weight="700">×</text>
                </g>`);

                // Alt-alt nedenler (sub-sub) — yatay küçük dallar olarak sub-rib'den çıkar
                const subsubs = fbNormSub(sub).subs || [];
                const ssCount = Math.min(subsubs.length, 2);
                subsubs.slice(0, 2).forEach((ss, ssi) => {
                    const ssName = typeof ss === 'string' ? ss : (ss && ss.name ? ss.name : '');
                    if (!ssName) return;
                    // vertical position along the sub-rib
                    const ssT = (ssi + 1) / (ssCount + 1);
                    const ssY = +(py + subDir * subLen * ssT).toFixed(1);
                    // horizontal branch to the left
                    const ssLen = 34;
                    const ssX2  = +(srX - ssLen).toFixed(1);
                    p.push(`<line x1="${srX}" y1="${ssY}" x2="${ssX2}" y2="${ssY}"
                        stroke="${color}" stroke-width="0.9" opacity="0.45" stroke-dasharray="2,2"/>`);
                    const ssNm  = ssName.length > 12 ? ssName.slice(0,12)+'…' : ssName;
                    const SSBW  = Math.max(38, ssNm.length * 5 + 10);
                    const SSBH  = 12;
                    const ssbX  = +(parseFloat(ssX2) - SSBW).toFixed(1);
                    const ssbY  = +(parseFloat(ssY) - SSBH / 2).toFixed(1);
                    const sstY  = +(parseFloat(ssbY) + SSBH * 0.76).toFixed(1);
                    p.push(`<rect x="${ssbX}" y="${ssbY}" width="${SSBW}" height="${SSBH}" rx="2"
                        fill="white" stroke="${color}" stroke-width="0.6" opacity="0.8"/>`);
                    p.push(`<text x="${+(parseFloat(ssbX)+2.5).toFixed(1)}" y="${sstY}" text-anchor="start"
                        font-size="6.5" fill="#334155" style="pointer-events:none">${esc(ssNm)}</text>`);
                    const ssDelX = +(parseFloat(ssbX) + SSBW - 9).toFixed(1);
                    p.push(`<g onclick="fbDeleteSubSub(${bi},${ci},${si},${ssi})" style="cursor:pointer" title="Alt-alt nedeni sil">
                        <rect x="${ssDelX}" y="${ssbY}" width="9" height="${SSBH}" rx="0" fill="transparent"/>
                        <text x="${+(parseFloat(ssDelX)+4.5).toFixed(1)}" y="${sstY}" text-anchor="middle"
                            font-size="9" fill="#ef4444" font-weight="700">×</text>
                    </g>`);
                });
                if (subsubs.length > 2) {
                    const extraY = +(py + subDir * (subLen * 0.82)).toFixed(1);
                    p.push(`<text x="${+(parseFloat(srX)-38).toFixed(1)}" y="${extraY}" text-anchor="middle"
                        font-size="7" fill="${color}" opacity="0.6">+${subsubs.length-2} alt-alt</text>`);
                }
            });
            if (subs.length > 3) {
                const mY2 = isTop ? +(py + subLen + 14).toFixed(0) : +(py - subLen - 4).toFixed(0);
                p.push(`<text x="${+(rx+39).toFixed(0)}" y="${mY2}" text-anchor="middle"
                    font-size="8" fill="${color}" opacity="0.7">+${subs.length-3} alt neden</text>`);
            }
        });
    });

    const tag = document.getElementById('fbEffectTag');
    if(tag) tag.textContent = data.effect || 'Ana Problem';

    const _fbContEl = document.getElementById('fbContainer_' + (window._fbActiveIdx ?? 0));
    if (!_fbContEl) return;
    _fbContEl.innerHTML =
        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${W} ${H}" width="100%"
            style="display:block;min-width:740px;">${p.join('')}</svg>`;
}

// Fishbone'da eklenen nedenler / alt nedenler → m6Grid + m6Detail güncelle
function _rebuildM6Display() {
    const m6       = window._m6Data;
    const M6_META  = window._M6_META;
    const m6Order  = window._m6Order;
    if (!m6 || !M6_META || !m6Order) return;

    // Fishbone kemiklerinden ekstra öğeler topla
    const fbBones  = (window._fbData && window._fbData.bones) ? window._fbData.bones : [];
    const fbByKey  = {};
    fbBones.forEach(b => {
        fbByKey[b.key] = [];
        (b.causes || []).forEach(rawCause => {
            const cause = fbNorm(rawCause);
            fbByKey[b.key].push({ name: cause.name, isSub: false });
            (cause.subs || []).forEach(sub => fbByKey[b.key].push({ name: fbNormSub(sub).name, isSub: true }));
        });
    });

    // m6Grid kartları
    const m6GridEl = document.getElementById('m6Grid');
    if (m6GridEl) {
        m6GridEl.innerHTML = m6Order.map(k => {
            const meta  = M6_META[k];
            const items = m6[k];
            const total = items.reduce((s,e)=>s+e.h, 0);
            const m6Names = new Set(items.map(e=>e.name.toLowerCase()));
            const fbExtras = (fbByKey[k] || []).filter(r => !m6Names.has(r.name.toLowerCase()));
            const m6ListHtml = items.slice(0,3).map(e=>`• ${truncate(e.name,26)} (%${e.pct})`).join('<br>')
                || '<span style="color:#bbb;">Sınıflandırılan kayıt yok</span>';
            const fbListHtml = fbExtras.map(r =>
                `<div style="font-size:.68rem;color:${r.isSub?'#94a3b8':'#64748b'};padding-left:${r.isSub?'10px':'2px'};">${r.isSub?'↳':'›'} ${truncate(r.name,26)}</div>`
            ).join('');
            return `<div class="m6-card" style="border-color:${meta.borderColor};background:${meta.color}18;">
                <div class="m6-title" style="color:${meta.color}">${meta.label}</div>
                <div class="m6-val" style="color:${meta.color}">${fmtN(total)}</div>
                <div style="font-size:.7rem;color:var(--c-sub);margin-bottom:8px;">${meta.desc}</div>
                <div class="m6-list">${m6ListHtml}${fbListHtml ? '<div style="border-top:1px solid #e2e8f0;margin:4px 0;"></div>'+fbListHtml : ''}</div>
            </div>`;
        }).join('');
    }

    // m6Detail sağ liste
    const m6DetailEl = document.getElementById('m6Detail');
    if (!m6DetailEl) return;
    let html = '<div style="font-size:.82rem;">';
    m6Order.forEach(k => {
        const meta  = M6_META[k];
        const items = m6[k];
        const m6Names = new Set(items.map(e=>e.name.toLowerCase()));
        const fbExtras = (fbByKey[k] || []).filter(r => !m6Names.has(r.name.toLowerCase()));
        if (!items.length && !fbExtras.length) return;
        html += `<div style="margin-bottom:14px;">
            <div class="ed" style="font-weight:700;color:${meta.color};margin-bottom:6px;">${meta.label}</div>`;
        items.slice(0,5).forEach(e => {
            const w = Math.min(Math.round(e.pct*2), 100);
            html += `<div style="margin-bottom:4px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
                    <span class="ed">${truncate(e.name,32)}</span>
                    <span class="ed" style="color:var(--c-sub);">%${e.pct}</span>
                </div>
                <div class="prog-bar"><div class="prog-fill" style="width:${w}%;background:${meta.color};"></div></div>
            </div>`;
        });
        if (fbExtras.length) {
            html += `<div style="border-top:1px solid #e2e8f0;margin:6px 0 4px;"></div>`;
            fbExtras.forEach(r => {
                html += `<div style="margin-bottom:3px;padding-left:${r.isSub?'14px':'4px'};font-size:.76rem;color:${r.isSub?'#94a3b8':'#475569'};"
                    >${r.isSub?'↳':'›'} ${truncate(r.name,32)}</div>`;
            });
        }
        html += '</div>';
    });
    html += '</div>';
    m6DetailEl.innerHTML = html;

    // Sync fishbone causes → aksiyon planı
    _rebuildAksiyonFromFishbone();
}

// Balık kılçığı nedenleri → Aksiyon Planı senkronizasyonu
function _rebuildAksiyonFromFishbone() {
    if (!window._aksiyonlar) return;
    const _def = { sorumlu:'', durum:'Beklemede', tarih:'', faaliyet:'' };
    const boneAct = {
        insan:   'Personel eğitim programı ve çalışma talimatı güncellemesi planlanmalı.',
        malzeme: 'Malzeme kabul kriterleri ve tedarikçi değerlendirmesi gözden geçirilmeli.',
        metot:   'Proses talimatları ve standart çalışma prosedürleri (SOP) güncellenmeli.',
        makine:  'Periyodik bakım planı oluşturulmalı / güncellenmeli. Kalibrasyon takibi yapılmalı.',
        olcum:   'Ölçüm sistemi analizi (MSA) yapılmalı. Muayene talimatları güncellenmeli.',
        ortam:   'Depolama & sevkiyat koşulları iyileştirilmeli. Ambalaj standardı belirlenmeli.'
    };
    const boneKat = {
        insan:'İnsan', malzeme:'Malzeme', metot:'Metot/Süreç',
        makine:'Makine', olcum:'Ölçüm', ortam:'Ortam'
    };
    const boneKatBadge = {
        insan:'badge-blue', malzeme:'badge-yellow', metot:'badge-purple',
        makine:'badge-gray', olcum:'badge-green', ortam:'badge-green'
    };

    // Remove auto-generated fishbone rows (keep rows user manually edited — they won't have _fbSource)
    window._aksiyonlar = window._aksiyonlar.filter(a => !a._fbSource);

    const fbBones = (window._fbDataArr && window._fbDataArr.length)
        ? window._fbDataArr.flatMap(fd => fd.bones || [])
        : (window._fbData && window._fbData.bones) ? window._fbData.bones : [];
    const newEntries = [];
    fbBones.forEach(bone => {
        const bLabel = bone.label || bone.key;
        const actTxt = boneAct[bone.key] || `"${bLabel}" kategorisindeki kök neden giderilmeli. Düzeltici faaliyet planlanmalı.`;
        const kat     = boneKat[bone.key]     || '6M Analizi';
        const katBadge= boneKatBadge[bone.key]|| 'badge-green';
        (bone.causes || []).forEach(rawCause => {
            const cause = fbNorm(rawCause);
            if (!cause.name) return;
            newEntries.push({
                bulgu: `Balık kılçığı [${bLabel}]: "${cause.name}"`,
                kat, katBadge,
                aksiyon: actTxt,
                oncelik: 'Orta',
                _fbSource: true,
                ..._def
            });
            (cause.subs || []).forEach(sub => {
                const subName = fbNormSub(sub).name;
                if (!subName) return;
                newEntries.push({
                    bulgu: `Balık kılçığı [${bLabel}] › ${cause.name}: "${subName}"`,
                    kat, katBadge,
                    aksiyon: actTxt,
                    oncelik: 'Düşük',
                    _fbSource: true,
                    ..._def
                });
            });
        });
    });

    if (newEntries.length) {
        window._aksiyonlar.push(...newEntries);
        renderAksiyonTablosu();
    } else if (fbBones.some(b => (b.causes||[]).length)) {
        renderAksiyonTablosu();
    }
}

function renderFbEditPanels() {
    const gi   = window._fbActiveIdx ?? 0;
    const data = window._fbDataArr ? (window._fbDataArr[gi] || window._fbData) : window._fbData;
    const el   = document.getElementById('fbEditPanels_' + gi);
    if (!el || !data || !data.bones) return;
    const cols = Math.min(data.bones.length || 1, 6);
    el.style.gridTemplateColumns = `repeat(${cols},1fr)`;
    el.innerHTML = data.bones.map((bone, bi) => {
        const causes = bone.causes || [];
        const items  = causes.map((c, ci) => {
            const cause = fbNorm(c);
            const nm    = cause.name;
            const subs  = cause.subs || [];
            const subId = `fbSub_${gi}_${bi}_${ci}`;
            const subRows = subs.map((s, si) => {
                const sub = fbNormSub(s);
                const ssId = `fbSubSub_${gi}_${bi}_${ci}_${si}`;
                const ssRows = (sub.subs || []).map((ss, ssi) => `
                    <div class="fb-sub-row" style="padding-left:16px;font-size:.7rem;background:#f8fafc;">
                        <span style="flex:1;color:#475569;">↳ ${esc(fbNormSub(ss).name)}</span>
                        <button class="fb-sub-del" title="Alt-alt nedeni sil" onclick="fbDeleteSubSub(${gi},${bi},${ci},${si},${ssi})">×</button>
                    </div>`).join('');
                const ssAdd = `
                    <div class="fb-sub-add" style="padding-left:16px;background:#f8fafc;">
                        <input id="fbSSInp_${gi}_${bi}_${ci}_${si}" type="text" placeholder="+ Alt-alt neden..."
                            style="font-size:.7rem;"
                            onkeydown="if(event.key==='Enter')fbAddSubSubFromInput(${gi},${bi},${ci},${si})">
                        <button onclick="fbAddSubSubFromInput(${gi},${bi},${ci},${si})">+</button>
                    </div>`;
                return `
                <div class="fb-sub-row">
                    <button class="fb-cause-toggle" style="font-size:.6rem;min-width:12px;height:12px;padding:0;" onclick="fbToggleSubList('${ssId}')" title="Alt-alt nedenler">▶</button>
                    <span style="flex:1">${esc(sub.name)}</span>
                    <button class="fb-sub-del" title="Alt nedeni sil" onclick="fbDeleteSub(${gi},${bi},${ci},${si})">×</button>
                </div>
                <div class="fb-sub-block" id="${ssId}" style="display:none;border-left:2px solid #e2e8f0;margin-left:10px;">
                    ${ssRows}${ssAdd}
                </div>`;
            }).join('');
            const subAdd = `
                <div class="fb-sub-add">
                    <input id="fbSubInp_${gi}_${bi}_${ci}" type="text" placeholder="+ Alt neden..."
                        onkeydown="if(event.key==='Enter')fbAddSubFromInput(${gi},${bi},${ci})">
                    <button onclick="fbAddSubFromInput(${gi},${bi},${ci})">+</button>
                </div>`;
            return `
            <div class="fb-cause-row">
                <button class="fb-cause-toggle" onclick="fbToggleSubList('${subId}')" title="Alt nedenler">▶</button>
                <span class="fb-cause-name">${esc(nm)}</span>
                <button class="fb-cause-del" title="Sil" onclick="fbDeleteCause(${gi},${bi},${ci})">×</button>
            </div>
            <div class="fb-sub-block" id="${subId}" style="display:none;">
                ${subRows}${subAdd}
            </div>`;
        }).join('') || `<div style="color:#94a3b8;padding:6px 2px;font-size:.72rem;">Tedarikçi kaydı yok</div>`;
        const pctBadge = `<span style="font-size:.68rem;opacity:.75;font-weight:400;"> %${+(bone.pct||0).toFixed(1)}</span>`;
        return `
        <div class="fb-bone-card" style="border:1.5px solid ${bone.color}33;">
            <div class="fb-bone-head" style="background:${bone.color}1a;color:${bone.color};border-bottom:1px solid ${bone.color}22;">
                ${esc(bone.label.length>18?bone.label.slice(0,18)+'…':bone.label)}${pctBadge}
            </div>
            <div class="fb-bone-list">${items}</div>
            <div class="fb-bone-add">
                <input id="fbInp_${gi}_${bi}" class="fb-add-input" placeholder="+ Ana neden..." type="text"
                    onkeydown="if(event.key==='Enter')fbAddFromInput(${gi},${bi})">
                <button class="fb-add-btn" style="background:${bone.color};" onclick="fbAddFromInput(${gi},${bi})">+</button>
            </div>
        </div>`;
    }).join('');
}

function fbToggleSubList(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
    // rotate toggle arrow
    const row = el.previousElementSibling;
    if (row) {
        const btn = row.querySelector('.fb-cause-toggle');
        if (btn) btn.textContent = el.style.display === 'none' ? '▶' : '▼';
    }
}

function fbAddSubFromInput(gi, bi, ci) {
    const inp = document.getElementById(`fbSubInp_${gi}_${bi}_${ci}`);
    if (!inp) return;
    const val = inp.value.trim();
    if (!val) { inp.focus(); return; }
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    const bone  = window._fbData.bones[bi];
    const cause = fbNorm(bone.causes[ci]);
    cause.subs  = cause.subs || [];
    cause.subs.push({name: val, subs: []});
    bone.causes[ci] = cause;
    inp.value = '';
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
    const subId = `fbSub_${gi}_${bi}_${ci}`;
    const el = document.getElementById(subId);
    if (el) el.style.display = 'block';
}

function fbDeleteSub(gi, bi, ci, si) {
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    if (!window._fbData || !window._fbData.bones[bi]) return;
    const bone  = window._fbData.bones[bi];
    const cause = fbNorm(bone.causes[ci]);
    cause.subs  = cause.subs || [];
    cause.subs.splice(si, 1);
    bone.causes[ci] = cause;
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
}

function fbAddSubSubFromInput(gi, bi, ci, si) {
    const inp = document.getElementById(`fbSSInp_${gi}_${bi}_${ci}_${si}`);
    if (!inp) return;
    const val = inp.value.trim();
    if (!val) { inp.focus(); return; }
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    const bone  = window._fbData.bones[bi];
    const cause = fbNorm(bone.causes[ci]);
    cause.subs  = cause.subs || [];
    const sub   = fbNormSub(cause.subs[si]);
    sub.subs    = sub.subs || [];
    sub.subs.push(val);
    cause.subs[si]  = sub;
    bone.causes[ci] = cause;
    inp.value = '';
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
    const ssId = `fbSubSub_${gi}_${bi}_${ci}_${si}`;
    const el   = document.getElementById(ssId);
    if (el) el.style.display = 'block';
    const subId = `fbSub_${gi}_${bi}_${ci}`;
    const subEl = document.getElementById(subId);
    if (subEl) subEl.style.display = 'block';
}

function fbDeleteSubSub(gi, bi, ci, si, ssi) {
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    if (!window._fbData || !window._fbData.bones[bi]) return;
    const bone  = window._fbData.bones[bi];
    const cause = fbNorm(bone.causes[ci]);
    cause.subs  = cause.subs || [];
    const sub   = fbNormSub(cause.subs[si]);
    sub.subs    = sub.subs || [];
    sub.subs.splice(ssi, 1);
    cause.subs[si]  = sub;
    bone.causes[ci] = cause;
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
}

function fbAddFromInput(gi, bi) {
    const inp = document.getElementById(`fbInp_${gi}_${bi}`);
    if (!inp) return;
    const val = inp.value.trim();
    if (!val) { inp.focus(); return; }
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    window._fbData.bones[bi].causes.push({name: val, subs: []});
    inp.value = '';
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
    setTimeout(() => { const i=document.getElementById(`fbInp_${gi}_${bi}`); if(i) i.focus(); }, 20);
}

function fbDeleteCause(gi, bi, ci) {
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    if(!window._fbData || !window._fbData.bones[bi]) return;
    window._fbData.bones[bi].causes.splice(ci, 1);
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
}

function fbRemoveCause(gi, bi, ci) {
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    if (!window._fbData || !window._fbData.bones[bi]) return;
    const bone = window._fbData.bones[bi];
    const removed = fbNorm(bone.causes[ci]);
    bone.causes.splice(ci, 1);
    bone._removed = bone._removed || [];
    bone._removed.push(removed);
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
}

function fbRestoreAll(gi) {
    window._fbActiveIdx = gi;
    window._fbData = window._fbDataArr[gi] || window._fbData;
    if (!window._fbData || !window._fbData.bones) return;
    window._fbData.bones.forEach(bone => {
        if (bone._removed && bone._removed.length > 0) {
            bone.causes = (bone.causes || []).concat(bone._removed);
            bone._removed = [];
        }
    });
    drawFishbone();
    renderFbEditPanels();
    _rebuildM6Display();
    _krSaveEdits();
}

function fbFocusInput(bi) {
    const gi  = window._fbActiveIdx ?? 0;
    const inp = document.getElementById(`fbInp_${gi}_${bi}`);
    if (inp) { inp.scrollIntoView({behavior:'smooth', block:'nearest'}); inp.focus(); }
}

function _fbToggleBody(i) {
    const body    = document.getElementById('fbBody_' + i);
    const chevron = document.getElementById('fbChevron_' + i);
    if (!body) return;
    const collapsed = body.classList.toggle('collapsed');
    if (chevron) chevron.style.transform = collapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
}

function fbEditEffect() {
    const cur = (window._fbData||{}).effect || '';
    const val = prompt('Balık kılçığı başlığı (etki / problem):', cur);
    if (val === null) return;
    window._fbData.effect = val.trim() || 'Ana Kalite Problemi';
    window._fbEffect = window._fbData.effect;
    drawFishbone();
    _krSaveEdits();
}

// ─────────────────────────────────────────────
// AKSIYON PLAN EDIT LOGIC
// ─────────────────────────────────────────────
const _PRI_COLOR = { 'Yüksek':'pri-yuksek', 'Orta':'pri-orta', 'Düşük':'pri-dusuk' };
const _KAT_BADGE_MAP = {
    'Hata Tipi':'badge-red','Tedarikçi':'badge-purple','Malzeme':'badge-yellow',
    'İç Başarısızlık':'badge-blue','Dış Başarısızlık':'badge-red',
    '6M Analizi':'badge-green','Sistem':'badge-gray','Diğer':'badge-gray'
};

const _DURUM_CLASS = {
    'Beklemede':   'durum-beklemede',
    'Devam Ediyor':'durum-devam',
    'Tamamlandı':  'durum-tamamlandi',
    'İptal':       'durum-iptal'
};
function fmtTarih(t) {
    if (!t) return '<span style="color:var(--c-sub)">—</span>';
    try { return new Date(t).toLocaleDateString('tr-TR'); } catch(e) { return t; }
}

function renderAksiyonTablosu() {
    const list = window._aksiyonlar || [];
    document.getElementById('aksiyonBody').innerHTML = list.map((a, i) => `
        <tr data-apkr="${i}">
            <td style="color:var(--c-sub);font-size:.78rem;">${i+1}</td>
            <td>${esc(a.bulgu)}</td>
            <td><span class="badge ${esc(a.katBadge)}">${esc(a.kat)}</span></td>
            <td style="max-width:280px;">${esc(a.aksiyon)}</td>
            <td><span class="pri ${_PRI_COLOR[a.oncelik]||''}">${esc(a.oncelik)}</span></td>
            <td style="font-size:.8rem;">${esc(a.sorumlu) || '<span style="color:var(--c-sub)">—</span>'}</td>
            <td><span class="durum-pill ${_DURUM_CLASS[a.durum] || 'durum-beklemede'}">${esc(a.durum) || 'Beklemede'}</span></td>
            <td style="font-size:.8rem;">${fmtTarih(a.tarih)}</td>
            <td class="ap-faaliyet-cell" style="font-size:.8rem;">${krFaaliyetCell(i, a)}</td>
            <td class="no-print"><div class="ap-actions-col">
                <button class="ap-btn ap-btn-edit" onclick="apOpenEdit(${i})">✏️ Düzenle</button>
                <button class="ap-btn ap-btn-del"  onclick="apDelete(${i})">🗑️</button>
            </div></td>
        </tr>`).join('');
}

function krFaaliyetCell(i, a) {
    if (a.faaliyet !== '8D Raporu') {
        return a.faaliyet
            ? `<span class="ap-faaliyet-tag">${esc(a.faaliyet)}</span>`
            : '<span style="color:var(--c-sub)">—</span>';
    }
    if (a.has8DLink === true) {
        return `<button class="btn-8d-ap" onclick="krOpen8D(${i})" title="8D Raporu Aç">📋 8D</button>`
             + `<button class="btn-8d-unlink" onclick="krUnlink8D(${i})" title="Bağlantıyı kaldır">✕</button>`;
    }
    if (a.has8DLink === 'pending') {
        return `<button class="btn-8d-ap btn-8d-pending" onclick="krOpen8D(${i})" title="8D henüz kaydedilmedi">⏳ 8D</button>`
             + `<button class="btn-8d-unlink" onclick="krUnlink8D(${i})" title="Bağlantıyı iptal et">✕</button>`;
    }
    return `<button class="btn-8d-ap" onclick="krOpen8D(${i})" title="8D Raporu Aç">📋 8D</button>`;
}

function krOpen8D(i) {
    const a = (window._aksiyonlar || [])[i];
    if (!a) return;
    const konu = a.bulgu || '';
    if (a.has8DLink === true) {
        let sig = {};
        try { sig = JSON.parse(localStorage.getItem('fishbone_8d_saved') || '{}'); } catch(e) {}
        const reportId = sig[konu];
        if (reportId) {
            window.open('8d-rapor.html?editId=' + encodeURIComponent(reportId)
                + '&source=' + encodeURIComponent('Kapsamlı Rapor')
                + '&konu='   + encodeURIComponent(konu), '_blank');
            return;
        }
    }
    if (!a.has8DLink) {
        a.has8DLink = 'pending';
        const tr   = document.querySelector(`tr[data-apkr="${i}"]`);
        const cell = tr && tr.querySelector('.ap-faaliyet-cell');
        if (cell) cell.innerHTML = krFaaliyetCell(i, a);
    }
    const problem = a.aksiyon || a.bulgu || '';
    window.open('8d-rapor.html?source=' + encodeURIComponent('Kapsamlı Rapor')
              + '&konu='    + encodeURIComponent(konu)
              + '&problem=' + encodeURIComponent(problem), '_blank');
}

function krUnlink8D(i) {
    const a = (window._aksiyonlar || [])[i];
    if (!a) return;
    const isPending = a.has8DLink === 'pending';
    if (!isPending && !confirm('8D bağlantısı Faaliyet sütunundan kaldırılsın mı?')) return;
    a.has8DLink = false;
    const tr = document.querySelector(`tr[data-apkr="${i}"]`);
    if (tr) {
        const cell = tr.querySelector('.ap-faaliyet-cell');
        if (cell) cell.innerHTML = krFaaliyetCell(i, a);
    }
}

function krCheckSaved() {
    const list = window._aksiyonlar || [];
    let sig;
    try { sig = JSON.parse(localStorage.getItem('fishbone_8d_saved') || '{}'); } catch(e) { return; }
    let changed = false;
    list.forEach((a) => {
        if (a.faaliyet !== '8D Raporu') return;
        // 8D kaydedildiyse güncelle
        if (a.has8DLink === 'pending' && sig[a.bulgu]) {
            a.has8DLink = true;
            changed = true;
        }
        // 8D silindiyse bağlantıyı kaldır
        if (a.has8DLink === true && !sig[a.bulgu]) {
            a.has8DLink = undefined;
            changed = true;
        }
    });
    if (changed) renderAksiyonTablosu();
}
window.addEventListener('focus', krCheckSaved);

function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let _apEditIdx = -1; // -1 = new row

function _apKatVal(name, badge) {
    return `${name}|${badge}`;
}

function apOpenEdit(idx) {
    _apEditIdx = idx;
    const a = window._aksiyonlar[idx];
    document.getElementById('apModalTitle').textContent = 'Satırı Düzenle';
    document.getElementById('apFBulgu').value    = a.bulgu    || '';
    document.getElementById('apFAksiyon').value  = a.aksiyon  || '';
    document.getElementById('apFOncelik').value  = a.oncelik  || 'Orta';
    document.getElementById('apFSorumlu').value  = a.sorumlu  || '';
    document.getElementById('apFDurum').value    = a.durum    || 'Beklemede';
    document.getElementById('apFTarih').value    = a.tarih    || '';
    document.getElementById('apFFaaliyet').value = a.faaliyet || '';
    const katSel = document.getElementById('apFKat');
    const katVal = `${a.kat}|${a.katBadge}`;
    let found = false;
    for (const opt of katSel.options) { if (opt.value === katVal) { katSel.value = opt.value; found = true; break; } }
    if (!found) katSel.value = 'Diğer|badge-gray';
    document.getElementById('apModal').classList.add('open');
}

function apOpenAdd() {
    _apEditIdx = -1;
    document.getElementById('apModalTitle').textContent = 'Yeni Satır Ekle';
    document.getElementById('apFBulgu').value    = '';
    document.getElementById('apFAksiyon').value  = '';
    document.getElementById('apFOncelik').value  = 'Orta';
    document.getElementById('apFSorumlu').value  = '';
    document.getElementById('apFDurum').value    = 'Beklemede';
    document.getElementById('apFTarih').value    = '';
    document.getElementById('apFKat').value      = 'Diğer|badge-gray';
    document.getElementById('apFFaaliyet').value = '';
    document.getElementById('apModal').classList.add('open');
    setTimeout(() => document.getElementById('apFBulgu').focus(), 50);
}

function apCloseModal() {
    document.getElementById('apModal').classList.remove('open');
}

function apSaveModal() {
    const bulgu   = document.getElementById('apFBulgu').value.trim();
    const aksiyon = document.getElementById('apFAksiyon').value.trim();
    const oncelik = document.getElementById('apFOncelik').value;
    const sorumlu = document.getElementById('apFSorumlu').value.trim();
    const durum   = document.getElementById('apFDurum').value;
    const tarih   = document.getElementById('apFTarih').value;
    const katRaw  = document.getElementById('apFKat').value; // "Name|badge-x"
    const [kat, katBadge] = katRaw.split('|');

    if (!bulgu) { document.getElementById('apFBulgu').focus(); return; }

    const faaliyet = document.getElementById('apFFaaliyet').value;
    const entry = { bulgu, kat, katBadge, aksiyon, oncelik, sorumlu, durum, tarih, faaliyet };

    if (_apEditIdx === -1) {
        // Yeni satır: 8D seçildiyse has8DLink'i undefined bırak (düğme görünür)
        window._aksiyonlar.push(entry);
    } else {
        // Düzenleme: onceki satırdan has8DLink'i koru
        const prev = window._aksiyonlar[_apEditIdx] || {};
        if (faaliyet === '8D Raporu') {
            entry.has8DLink = prev.has8DLink; // true / 'pending' / undefined
        }
        // Faaliyet 8D'den başkasına değiştirildiyse bağlantıyı temizle
        window._aksiyonlar[_apEditIdx] = entry;
    }
    renderAksiyonTablosu();
    _krSaveEdits();
    apCloseModal();
}

function apDelete(idx) {
    if (!confirm('Bu satırı silmek istediğinizden emin misiniz?')) return;
    window._aksiyonlar.splice(idx, 1);
    renderAksiyonTablosu();
    _krSaveEdits();
}

// Close modal on backdrop click
document.addEventListener('click', e => {
    if (e.target.id === 'apModal') apCloseModal();
});

// ─────────────────────────────────────────────
// MAIN RENDER
// ─────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', () => {
    idbLoadRapor()
        .then(payload => runReport(payload))
        .catch(e => {
            document.getElementById('loadingState').innerHTML = `<div class="empty-state"><div class="emo">❌</div><p>Veri okunamadı: ${e.message}</p></div>`;
        });
});

function runReport(payload) {
    // destroy previous chart instances on re-run
    _destroyCharts();
    // reset UI state
    document.getElementById('loadingState').style.display = '';
    document.getElementById('loadingState').innerHTML = '<div class="empty-state"><div class="emo">⏳</div><p>Rapor yükleniyor…</p></div>';
    document.getElementById('reportContent').style.display = 'none';

    if (!payload) {
            document.getElementById('loadingState').innerHTML = `
                <div class="empty-state">
                    <div class="emo">⚠️</div>
                    <p style="font-size:1rem;font-weight:600;">Rapor verisi bulunamadı</p>
                    <p style="color:var(--c-sub);margin-top:8px;">Lütfen Uygunsuzluk Analizi sayfasından "Kapsamlı Rapor Oluştur" butonuna tıklayın.</p>
                    <button class="btn btn-outline" style="margin-top:16px;" onclick="krOpenSnapshotModal()">📁 Kayıtlı Raporlarım</button>
                </div>`;
            return;
        }

        const rows = payload.rows || [];
    if (!rows.length) {
        document.getElementById('loadingState').innerHTML = '<div class="empty-state"><div class="emo">📭</div><p>Filtrelenmiş veri boş — lütfen filtreleri kontrol edin.</p></div>';
        return;
    }

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('reportContent').style.display = 'block';

    // Her yeni rapor oluşturulduğunda kaydedilmiş kılçık + aksiyon düzenlemelerini otomatik sıfırla
    (function() {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            try { e.target.result.transaction(_IDB.store,'readwrite').objectStore(_IDB.store).delete(_KR_KEY); } catch(e) {}
        };
    })();

    const totalH   = rows.reduce((s,r) => s+(Number(r.hataliMiktar)||0), 0);
    const totalRec = rows.length;
    const filters  = payload.filters || {};
    const genAt    = new Date(payload.generatedAt || Date.now());

    // ── HEADER ──
    const title = payload.title || 'Kalite Uygunsuzluk Raporu';
    document.title = title;
    document.getElementById('topbarTitle').textContent = title;
    document.getElementById('rhTitle').textContent = title;
    document.getElementById('rhSub').textContent = `Uygunsuzluk Analizi — ${totalRec} kayıt · ${fmtN(totalH)} hatalı adet`;
    document.getElementById('footerDate').textContent = genAt.toLocaleDateString('tr-TR', {day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});

    const metaItems = [];
    if (filters.tarihStart || filters.tarihEnd) metaItems.push(`📅 ${filters.tarihStart||'—'} / ${filters.tarihEnd||'—'}`);
    if (filters.tipi)     metaItems.push(`🏷️ Tip: ${filters.tipi}`);
    if (filters.cariTip)  metaItems.push(`🏢 Cari Tipi: ${filters.cariTip === 'musteri' ? '★ Müşteri' : filters.cariTip === 'tedarikci' ? 'Tedarikçi' : filters.cariTip}`);
    if (filters.cari)     metaItems.push(`👤 ${filters.cari}`);
    if (filters.tespitYeri?.length) metaItems.push(`📍 ${filters.tespitYeri.join(', ')}`);
    if (filters.hataTipi) metaItems.push(`🔍 ${filters.hataTipi}`);
    if (filters.hataKaynagi) metaItems.push(`⚙️ ${filters.hataKaynagi}`);
    if (filters.stokKodu) metaItems.push(`📦 Stok: ${filters.stokKodu}`);
    if (filters.excludedTypes?.length) metaItems.push(`🚫 ${filters.excludedTypes.length} tip hariç tutuldu`);
    metaItems.push(`📊 ${totalRec} kayıt`);
    metaItems.push(`⏱ ${genAt.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})} oluşturuldu`);
    document.getElementById('rhMeta').innerHTML = metaItems.map(t=>`<span class="rh-tag">${t}</span>`).join('');

    // ── İÇ / DIŞ ──
    const icDis = classifyIcDis(rows);
    const icH   = icDis.ic.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const disH  = icDis.dis.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const tedH  = (icDis.tedarikci||[]).reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const belH  = icDis.belirsiz.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const icPct  = totalH ? (icH /totalH*100).toFixed(1) : 0;
    const disPct = totalH ? (disH/totalH*100).toFixed(1) : 0;
    const tedPct = totalH ? (tedH/totalH*100).toFixed(1) : 0;
    const belPct = totalH ? (belH/totalH*100).toFixed(1) : 0;

    // Tanı verisi — hangi tipi/uygunsuzlukTuru değerleri var
    const diag = getIcDisDiagnostic(rows);

    // ── UNIQUE COUNTS ──
    const uTedarikci = new Set(rows.map(r=>r.cariAdi).filter(Boolean)).size;
    const uMalzeme   = new Set(rows.map(r=>r.stokAdi).filter(Boolean)).size;
    const uHataTipi  = new Set(rows.map(r=>r.hataTipi).filter(Boolean)).size;

    // ── KPI CARDS ──
    const avgH       = totalRec ? (totalH/totalRec).toFixed(1) : 0;
    const batchCount = (payload.batches || []).length;
    const kpis = [
        { val: fmtN(totalRec),    lbl:'Toplam Kayıt',         color:'#2563eb' },
        { val: fmtN(totalH),      lbl:'Toplam Hatalı Mikt.',  color:'#dc2626' },
        { val: fmtN(icH),         lbl:'İç Başarısızlık',      color:'#1d4ed8' },
        { val: fmtN(disH),        lbl:'Dış Başarısızlık',      color:'#c2410c' },
        { val: fmtN(tedH),        lbl:'Tedarikçi Başarısızlık', color:'#15803d' },
        { val: icPct+'%',         lbl:'İç Başarısızlık %',    color:'#16a34a' },
        { val: disPct+'%',        lbl:'Dış Başarısızlık %',    color:'#ea580c' },
        { val: tedPct+'%',        lbl:'Tedarikçi %',          color:'#16a34a' },
        { val: uTedarikci,        lbl:'Farklı Tedarikçi',    color:'#0e7490' },
        { val: uMalzeme,          lbl:'Farklı Malzeme',      color:'#0891b2' },
        { val: uHataTipi,         lbl:'Farklı Hata Tipi',    color:'#be185d' },
        { val: fmtN(avgH,1),      lbl:'Ort. Hatalı Mikt.',   color:'#92400e' },
        ...(batchCount > 1 ? [{ val: batchCount, lbl:'Birleşen Filtre', color:'#1e3a8a' }] : []),
    ];
    document.getElementById('kpiGrid').innerHTML = kpis.map(k => `
        <div class="kpi-card" style="border-top-color:${k.color}">
            <div class="kval" style="color:${k.color}">${k.val}</div>
            <div class="klbl">${k.lbl}</div>
        </div>`).join('');

    // ── İÇ / DIŞ CARDS ──
    const belNote = icDis.belirsiz.length
        ? `<div style="margin-top:10px;padding:8px 12px;background:#fef9c3;border-radius:8px;border-left:3px solid #d97706;font-size:.75rem;color:#78350f;">
            <strong>⚠️ ${icDis.belirsiz.length} kayıt sınıflandırılamadı</strong> (%${belPct}) —<br>
            <em>tipi</em> değerleri: ${Object.entries(diag.tipiCount).map(([k,v])=>`<strong>${k}</strong>(${v})`).join(', ')}<br>
            <em>uygunsuzlukTuru</em>: ${Object.entries(diag.turCount).slice(0,5).map(([k,v])=>`<strong>${k}</strong>(${v})`).join(', ')}
           </div>`
        : '';
    document.getElementById('icDisCards').innerHTML = `
        <div class="ic-card ic">
            <h3>🏢 İç Başarısızlık</h3>
            <div class="ic-val">${fmtN(icH)}</div>
            <div style="color:#1d4ed8;font-weight:700;font-size:1.1rem;">%${icPct}</div>
            <div style="color:#5a6478;font-size:.78rem;margin-top:6px;">${icDis.ic.length} kayıt — İç süreçte tespit edilen</div>
            ${belNote}
        </div>
        <div class="ic-card dis">
            <h3>🚚 Dış Başarısızlık</h3>
            <div class="ic-val">${fmtN(disH)}</div>
            <div style="color:#c2410c;font-weight:700;font-size:1.1rem;">%${disPct}</div>
            <div style="color:#5a6478;font-size:.78rem;margin-top:6px;">${icDis.dis.length} kayıt — Müşteri/Saha/Şube'de tespit edilen</div>
        </div>
        <div class="ic-card ted">
            <h3>🏭 Tedarikçi Başarısızlık</h3>
            <div class="ic-val">${fmtN(tedH)}</div>
            <div style="color:#15803d;font-weight:700;font-size:1.1rem;">%${tedPct}</div>
            <div style="color:#5a6478;font-size:.78rem;margin-top:6px;">${(icDis.tedarikci||[]).length} kayıt — Tedarikçi kaynaklı</div>
        </div>`;

    // ── İÇ/DIŞ CHART ──
    new Chart(document.getElementById('cIcDis'), {
        type:'doughnut',
        data:{
            labels:['İç Başarısızlık','Dış Başarısızlık','Tedarikçi Başarısızlık'],
            datasets:[{ data:[icH,disH,tedH], backgroundColor:['#2563eb','#ea580c','#16a34a'], borderWidth:0, hoverOffset:8 }]
        },
        options:{
            responsive:true, maintainAspectRatio:true,
            cutout:'60%',
            plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c=>`${c.label}: ${fmtN(c.raw)} adet` }}}
        }
    });

    // ── İÇ/DIŞ TABLE (by tespitYeri) ──
    const icDisByYer = paretoData(rows,'tespitYeri',12);
    document.getElementById('icDisTable').innerHTML = buildParetoTable(icDisByYer, totalH);

    // ── İÇ/DIŞ PARETO BREAKDOWN ──
    window._idRows = { ic: icDis.ic, dis: icDis.dis };
    window._idCharts = {};
    switchIdBreak('hataTipi', null);

    // ── TEDARİKÇİ ──
    const tedData = paretoData(rows,'cariAdi',15);
    const tedLabels = tedData.map(e=>truncate(e.name,30));
    const tedVals   = tedData.map(e=>e.h);
    hBarChart(document.getElementById('cTedarikci'), tedLabels, tedVals, paretoColors(tedData.length), 'Hatalı Miktar');
    document.getElementById('tedarikciTable').innerHTML = buildParetoTable(tedData, totalH);

    // ── MALZEME ──
    const malData = paretoData(rows,'stokAdi',15);
    const malLabels = malData.map(e=>truncate(e.name,32));
    hBarChart(document.getElementById('cMalzeme'), malLabels, malData.map(e=>e.h), paretoColors(malData.length), 'Hatalı Miktar');
    document.getElementById('malzemeTable').innerHTML = buildParetoTable(malData, totalH);

    // ── MÜŞTERİ / ŞUBE (tespitYeri) ──
    const mustData = paretoData(rows,'tespitYeri',15);
    hBarChart(document.getElementById('cMusteri'), mustData.map(e=>truncate(e.name,28)), mustData.map(e=>e.h), PAL_DANGER.concat(PAL_BLUE), 'Hatalı Miktar');
    document.getElementById('musteriTable').innerHTML = buildParetoTable(mustData, totalH);

    // ── HATA TİPİ ──
    const htData = paretoData(rows,'hataTipi',15);
    paretoChart(document.getElementById('cHataTipi'), htData);
    document.getElementById('hataTipiTable').innerHTML = buildParetoTable(htData, totalH);

    // ── 6M ──
    const m6 = classify6M(rows);
    const M6_META = {
        insan:   { label:'👤 İnsan',   color:'#ef4444', borderColor:'#fca5a5', desc:'İşçilik, operatör, eğitim kaynaklı' },
        makine:  { label:'⚙️ Makine',  color:'#f59e0b', borderColor:'#fcd34d', desc:'Makine, ekipman, kalibrasyon' },
        malzeme: { label:'📦 Malzeme', color:'#3b82f6', borderColor:'#93c5fd', desc:'Hammadde, tedarikçi, stok kalitesi' },
        metot:   { label:'📋 Metot',   color:'#8b5cf6', borderColor:'#c4b5fd', desc:'Talimat, prosedür, standart' },
        olcum:   { label:'📐 Ölçüm',  color:'#06b6d4', borderColor:'#67e8f9', desc:'Muayene, kontrol, tolerans' },
        ortam:   { label:'🌡️ Ortam',  color:'#22c55e', borderColor:'#86efac', desc:'Sevkiyat, depolama, çevre' },
    };
    const m6Order = ['insan','makine','malzeme','metot','olcum','ortam'];
    // globals so _rebuildM6Display() can re-read them later
    window._m6Data  = m6;
    window._M6_META = M6_META;
    window._m6Order = m6Order;
    document.getElementById('m6Grid').innerHTML = m6Order.map(k => {
        const meta = M6_META[k];
        const items = m6[k];
        const total = items.reduce((s,e)=>s+e.h,0);
        return `<div class="m6-card" style="border-color:${meta.borderColor};background:${meta.color}18;">
            <div class="m6-title" style="color:${meta.color}">${meta.label}</div>
            <div class="m6-val" style="color:${meta.color}">${fmtN(total)}</div>
            <div style="font-size:.7rem;color:var(--c-sub);margin-bottom:8px;">${meta.desc}</div>
            <div class="m6-list">${items.slice(0,3).map(e=>`• ${truncate(e.name,26)} (%${e.pct})`).join('<br>') || '<span style="color:#bbb;">Sınıflandırılan kayıt yok</span>'}</div>
        </div>`;
    }).join('');

    const m6Values   = m6Order.map(k => m6[k].reduce((s,e)=>s+e.h, 0));
    const m6Total6M  = m6Values.reduce((s,v)=>s+v, 0) || 1;
    const m6Pcts     = m6Values.map(v => +(v / m6Total6M * 100).toFixed(1));

    new Chart(document.getElementById('c6M'), {
        type: 'bar',
        data: {
            labels: m6Order.map(k => M6_META[k].label),
            datasets: [{
                label: 'Hatalı Miktar',
                data: m6Values,
                backgroundColor: m6Order.map(k => M6_META[k].color + 'cc'),
                borderColor:     m6Order.map(k => M6_META[k].color),
                borderWidth: 2,
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: {
                    label: c => ` ${fmtN(c.raw)} adet  (%${m6Pcts[c.dataIndex]})`
                }},
                // inline data labels
                afterDraw: undefined
            },
            scales: {
                x: { ticks: { font:{size:10}, callback: v => fmtN(v) }, grid: { color:'#f1f5f9' } },
                y: { ticks: { font:{size:12} } }
            }
        },
        plugins: [{
            id: 'm6Labels',
            afterDatasetDraw(chart) {
                const { ctx, data, scales } = chart;
                ctx.save();
                chart.getDatasetMeta(0).data.forEach((bar, i) => {
                    const val  = data.datasets[0].data[i];
                    const pct  = m6Pcts[i];
                    if (!val) return;
                    const x = bar.x + 6;
                    const y = bar.y;
                    ctx.fillStyle = '#374151';
                    ctx.font = 'bold 11px Segoe UI, sans-serif';
                    ctx.textBaseline = 'middle';
                    ctx.textAlign = 'left';
                    ctx.fillText(`${fmtN(val)}  (%${pct})`, x, y);
                });
                ctx.restore();
            }
        }]
    });

    // 6M detail list
    let m6DetailHtml = '<div style="font-size:.82rem;">';
    m6Order.forEach(k => {
        const meta = M6_META[k];
        const items = m6[k];
        if (!items.length) return;
        m6DetailHtml += `<div style="margin-bottom:14px;">
            <div class="ed" style="font-weight:700;color:${meta.color};margin-bottom:6px;">${meta.label}</div>`;
        items.slice(0,5).forEach(e => {
            const w = Math.min(Math.round(e.pct*2),100);
            m6DetailHtml += `<div style="margin-bottom:4px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
                    <span class="ed">${truncate(e.name,32)}</span>
                    <span class="ed" style="color:var(--c-sub);">%${e.pct}</span>
                </div>
                <div class="prog-bar"><div class="prog-fill" style="width:${w}%;background:${meta.color};"></div></div>
            </div>`;
        });
        m6DetailHtml += '</div>';
    });
    m6DetailHtml += '</div>';
    document.getElementById('m6Detail').innerHTML = m6DetailHtml || '<span style="color:var(--c-sub);">hataKaynagi alanı dolu kayıt bulunamadı.</span>';

    // ── FISHBONE (6M) ──
    renderMultipleFishbones(payload.paretoGroups || [], rows);
    _rebuildM6Display(); // fishbone nedenlerini kart + liste’ye ekle

    // ── TREND ──
    const trend = buildTrend(rows);
    new Chart(document.getElementById('cTrend'), {
        type:'line',
        data:{
            labels: trend.labels,
            datasets:[
                {
                    label:'Hatalı Miktar', data:trend.hatali,
                    borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.1)',
                    tension:.35, fill:true, pointRadius:4, yAxisID:'y'
                },
                {
                    label:'Kayıt Sayısı', data:trend.kayit,
                    borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,.05)',
                    tension:.35, fill:false, pointRadius:3, borderDash:[5,5], yAxisID:'y2'
                }
            ]
        },
        options:{
            responsive:true, maintainAspectRatio:true,
            plugins:{ legend:{ position:'top' } },
            scales:{
                x:{ ticks:{font:{size:10}}, grid:{color:'#f1f5f9'} },
                y:{ position:'left',  ticks:{font:{size:10}}, title:{display:true,text:'Hatalı Miktar',font:{size:10}} },
                y2:{ position:'right', ticks:{font:{size:10}}, title:{display:true,text:'Kayıt Sayısı',font:{size:10}}, grid:{display:false} }
            }
        }
    });

    // Trend insight
    if (trend.hatali.length >= 3) {
        const last3  = trend.hatali.slice(-3).reduce((s,v)=>s+v,0)/3;
        const prev3  = trend.hatali.slice(-6,-3).reduce((s,v)=>s+v,0)/3;
        let insight = '';
        if (prev3 > 0) {
            const chg = Math.round((last3-prev3)/prev3*100);
            if (chg >= 15)  insight = `⚠️ <strong>Yükselen trend:</strong> Son 3 ay ortalaması önceki 3 aya göre <strong>+%${chg} artış</strong> gösteriyor. Acil müdahale önerilir.`;
            else if (chg <= -15) insight = `✅ <strong>İyileşme trendi:</strong> Son 3 ay ortalaması önceki 3 aya göre <strong>%${Math.abs(chg)} azalış</strong> gösteriyor. İyileştirme çalışmaları etkili.`;
            else insight = `ℹ️ <strong>Stabil trend:</strong> Son 6 ayda belirgin bir değişim gözlenmedi (%${chg > 0 ? '+' : ''}${chg}).`;
        } else {
            insight = `ℹ️ Yeterli tarihsel veri bulunamadı — karşılaştırmalı trend hesaplanamadı.`;
        }
        document.getElementById('trendInsight').innerHTML = insight;
    }

    // ── AKSİYON PLANI ──
    const actions = generateActionPlan(rows, htData, tedData, malData, icDis, m6);
    window._aksiyonlar = actions;
    renderAksiyonTablosu();
    _rebuildAksiyonFromFishbone(); // Balık kılçığı nedenlerini aksiyon planına ekle
    krCheckSaved();

    // ── Enable edit mode if it was on before re-render ──
    if (_editMode) { _editMode = false; toggleEditMode(); }

    // ── CHART SNAPSHOTS ───────────────────────────────────────────────────
    const snaps = payload.chartSnapshots || [];
    const snapSec  = document.getElementById('s-snapshots');
    const snapGrid = document.getElementById('snapGrid');
    const snapNav  = document.getElementById('nav-snapshots');
    if (snaps.length > 0) {
        if (snapSec)  snapSec.classList.remove('hidden-sec');
        if (snapNav)  snapNav.style.display = '';
        if (snapGrid) snapGrid.innerHTML = snaps.map((s, i) => {
            const dt = s.addedAt ? (() => { try { return new Date(s.addedAt).toLocaleString('tr-TR',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); } catch(e){ return s.addedAt; } })() : '';
            return `
            <div class="snap-card" id="snap-card-${i}">
                <div class="snap-card-head">
                    <span>${s.label || 'Grafik ' + (i + 1)}</span>
                    <span style="color:var(--c-sub);font-size:.75rem;font-weight:400;">${dt}</span>
                    <button class="snap-del no-print" title="Bu görüntüyü kaldır" onclick="krDeleteSnap(${i})">🗑</button>
                </div>
                <img src="${s.dataUrl}" alt="${s.label || 'Grafik'}">
            </div>`;
        }).join('');
    } else {
        if (snapSec)  snapSec.classList.add('hidden-sec');
        if (snapNav)  snapNav.style.display = 'none';
        if (snapGrid) snapGrid.innerHTML = '<div class="snap-empty">Henüz grafik anlık görüntüsü eklenmedi.</div>';
    }

    // ── Bölüm gizleme butonlarını ekle + kaynaklar panelini göster ──
    _krInjectHideButtons();
    _krRenderSources(payload);
}

// ─────────────────────────────────────────────
// BÖLÜM GİZLE / GÖSTER
// ─────────────────────────────────────────────
const _KR_HIDE_KEY = 'kr_hidden_sections';

function _krSaveHidden(idsSet) {
    return _idbPut(_KR_HIDE_KEY, [...idsSet]);
}
function _krLoadHidden() {
    return _idbGet(_KR_HIDE_KEY).then(v => new Set(v || []));
}

async function krHideSection(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
    const hidden = await _krLoadHidden();
    hidden.add(id);
    _krSaveHidden(hidden);
    _krUpdateHiddenBadge();
}

async function krShowAllSections() {
    document.querySelectorAll('.section[id]').forEach(el => el.style.display = '');
    _krSaveHidden(new Set());
    _krUpdateHiddenBadge();
    // Restore all removed fishbone causes in every group
    if (window._fbDataArr) {
        window._fbDataArr.forEach((_, gi) => fbRestoreAll(gi));
    }
}

async function _krInjectHideButtons() {
    const hidden = await _krLoadHidden();
    document.querySelectorAll('.section[id]').forEach(sec => {
        const id  = sec.id;
        const hdr = sec.querySelector('.section-hdr');
        if (!hdr) return;
        // Remove old button if exists (re-render)
        const old = hdr.querySelector('.kr-hide-btn');
        if (old) old.remove();
        const btn = document.createElement('button');
        btn.className   = 'kr-hide-btn no-print';
        btn.title       = 'Bu bölümü gizle (sağ altta çıkan rozetten geri açabilirsiniz)';
        btn.textContent = '✕';
        btn.setAttribute('onclick', `krHideSection('${id}')`);
        hdr.appendChild(btn);
        if (hidden.has(id)) sec.style.display = 'none';
    });
    _krUpdateHiddenBadge();
}

function _krUpdateHiddenBadge() {
    const all    = document.querySelectorAll('.section[id]');
    let count = 0;
    all.forEach(el => { if (el.style.display === 'none') count++; });
    const badge   = document.getElementById('kr-hidden-badge');
    const countEl = document.getElementById('kr-hidden-count');
    if (!badge) return;
    if (count > 0) {
        badge.classList.remove('kr-badge-hidden');
        if (countEl) countEl.textContent = count;
    } else {
        badge.classList.add('kr-badge-hidden');
    }
}

// ─────────────────────────────────────────────
// VERİ KAYNAKLARI (BATCHES) PANELİ
// ─────────────────────────────────────────────
function _krRenderSources(payload) {
    const old = document.getElementById('kr-sources-panel');
    if (old) old.remove();
    const batches = payload.batches;
    if (!batches || !batches.length) return;

    const kpiGrid = document.getElementById('kpiGrid');
    if (!kpiGrid) return;

    const panel = document.createElement('div');
    panel.id = 'kr-sources-panel';
    panel.className = 'kr-sources no-print';

    const rows = batches.map((b, i) => {
        const fs = b.filters || {};
        const tags = [
            fs.tipi       ? `Tip: ${fs.tipi}`                                                   : '',
            fs.cariTip    ? `Cari: ${fs.cariTip === 'musteri' ? '★ Müşteri' : 'Tedarikçi'}`     : '',
            fs.cari       ? fs.cari                                                              : '',
            fs.hataTipi   ? `Hata: ${fs.hataTipi}`                                              : '',
            fs.hataKaynagi? `Kaynak: ${fs.hataKaynagi}`                                         : '',
            (fs.tarihStart||fs.tarihEnd) ? `${fs.tarihStart||'—'} / ${fs.tarihEnd||'—'}`        : '',
            fs.tespitYeri?.length ? fs.tespitYeri.join(', ')                                    : '',
        ].filter(Boolean).join(' · ') || 'Tüm Veriler';
        return `<div class="kr-src-row">
            <span class="kr-src-num">${i+1}.</span>
            <span class="kr-src-label">${esc(b.label)}</span>
            <span class="kr-src-meta">${esc(tags)} &nbsp;·&nbsp; ${fmtN(b.rowCount)} kayıt &nbsp;·&nbsp; ${esc(b.addedAt)}</span>
        </div>`;
    }).join('');

    panel.innerHTML = `
        <div class="kr-sources-hdr">
            <h3>📂 Rapor Veri Kaynakları &mdash; ${batches.length} filtre birleştirildi</h3>
        </div>${rows}`;

    kpiGrid.insertAdjacentElement('afterend', panel);
}

async function krRemoveBatch(batchId) {
    if (!confirm('Bu veri kaynağı rapordan çıkarılsın mı?')) return;
    const existing = await idbLoadRapor();
    if (!existing) return;
    const allRows = (existing.rows    || []).filter(r => r._batchId !== batchId);
    const batches = (existing.batches || []).filter(b => b.id       !== batchId);
    if (!allRows.length) {
        alert('Son veri kaynağı kaldırıldı — rapor boş kalacak. Lütfen önce yeni filtre ekleyin.');
        return;
    }
    const newTitle = batches.length > 1
        ? `Birleşik Kalite Raporu — ${batches.length} filtre, ${allRows.length} kayıt`
        : (batches[0]?.label ? batches[0].label + ' — Kalite Raporu' : 'Kalite Uygunsuzluk Raporu');
    const updated  = Object.assign({}, existing, { rows: allRows, batches, title: newTitle });
    const r = indexedDB.open(_IDB.name, _IDB.ver);
    r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
    r.onsuccess = e => {
        const tx = e.target.result.transaction(_IDB.store, 'readwrite');
        tx.objectStore(_IDB.store).put(updated, _IDB.key);
        tx.oncomplete = () => { _destroyCharts(); runReport(updated); };
    };
}

// close snap modal on backdrop click
document.addEventListener('click', e => {
    if (e.target.id === 'krSnapModal') document.getElementById('krSnapModal').classList.remove('open');
});

function _krToggleFbTable(h4el) {
    const body    = h4el.nextElementSibling;
    const chevron = h4el.querySelector('.fb-table-chevron');
    if (!body) return;
    const collapsed = body.classList.toggle('collapsed');
    if (chevron) chevron.classList.toggle('collapsed', collapsed);
}
</script>

<!-- GİZLİ BÖLÜMLER FLOATING BADGE -->
<button id="kr-hidden-badge" class="no-print kr-badge-hidden"
    onclick="krShowAllSections()"
    title="Gizlenen bölümleri geri göster">
    <span style="font-size:1.15rem;">👁</span>
    <span id="kr-hidden-count">0</span>&nbsp;bölüm gizlendi — Tümünü Göster
</button>

</body>
</html>
