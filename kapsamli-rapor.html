<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KapsamlÄ± Kalite Uygunsuzluk Raporu</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€ RESET & BASE â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
    --c-bg:       #f4f6fa;
    --c-card:     #ffffff;
    --c-border:   #e2e6ed;
    --c-text:     #1e2535;
    --c-sub:      #5a6478;
    --c-accent:   #2563eb;
    --c-ok:       #16a34a;
    --c-warn:     #d97706;
    --c-danger:   #dc2626;
    --c-info:     #0891b2;
    --c-purple:   #7c3aed;
    --c-pink:     #db2777;
    --shadow:     0 2px 12px rgba(0,0,0,.08);
    --r:          12px;
}
body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--c-bg); color:var(--c-text); font-size:14px; }

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
    position:sticky; top:0; z-index:200;
    background:#1e2535; color:#fff;
    display:flex; align-items:center; gap:16px;
    padding:12px 32px; box-shadow:0 2px 8px rgba(0,0,0,.3);
}
.topbar .logo { font-size:1.25rem; font-weight:700; letter-spacing:-.5px; }
.topbar .logo span { color:#60a5fa; }
.topbar-right { margin-left:auto; display:flex; gap:8px; }
.btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border-radius:8px; border:none; cursor:pointer; font-size:.85rem; font-weight:600; transition:all .15s; }
.btn-primary { background:var(--c-accent); color:#fff; }
.btn-primary:hover { background:#1d4ed8; }
.btn-success { background:var(--c-ok); color:#fff; }
.btn-success:hover { background:#15803d; }
.btn-outline { background:transparent; color:#93c5fd; border:1.5px solid #3b82f6; }
.btn-outline:hover { background:#3b82f6; color:#fff; }

/* â”€â”€ NAV SIDEBAR â”€â”€ */
.layout { display:flex; min-height:calc(100vh - 52px); }
.sidebar {
    width:230px; flex-shrink:0;
    background:#fff; border-right:1px solid var(--c-border);
    padding:20px 0;
    position:sticky; top:52px; height:calc(100vh - 52px); overflow-y:auto;
}
.sidebar h3 { font-size:.7rem; text-transform:uppercase; letter-spacing:1px; color:var(--c-sub); padding:0 20px 8px; }
.nav-item {
    display:flex; align-items:center; gap:8px;
    padding:9px 20px; cursor:pointer; font-size:.85rem; color:var(--c-sub);
    border-left:3px solid transparent; transition:all .15s;
}
.nav-item:hover { background:#f0f4ff; color:var(--c-accent); }
.nav-item.active { background:#eff6ff; color:var(--c-accent); border-left-color:var(--c-accent); font-weight:600; }
.nav-item .nav-ico { font-size:1rem; width:20px; text-align:center; }

/* â”€â”€ MAIN â”€â”€ */
.main { flex:1; padding:28px 32px; max-width:1400px; }

/* â”€â”€ REPORT HEADER â”€â”€ */
.report-header {
    background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 50%,#2563eb 100%);
    border-radius:var(--r); padding:32px 40px; color:#fff; margin-bottom:24px;
}
.report-header h1 { font-size:1.6rem; font-weight:700; margin-bottom:6px; }
.report-header .sub { color:#93c5fd; font-size:.9rem; margin-bottom:16px; }
.rh-meta { display:flex; flex-wrap:wrap; gap:20px; }
.rh-tag { background:rgba(255,255,255,.15); border-radius:6px; padding:4px 12px; font-size:.78rem; backdrop-filter:blur(4px); }

/* â”€â”€ KPI CARDS â”€â”€ */
.kpi-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:16px; margin-bottom:24px; }
.kpi-card {
    background:var(--c-card); border-radius:var(--r); padding:20px 18px;
    box-shadow:var(--shadow); border-top:4px solid var(--c-accent);
    display:flex; flex-direction:column; gap:4px;
}
.kpi-card .kval { font-size:1.9rem; font-weight:800; color:var(--c-text); line-height:1.1; }
.kpi-card .klbl { font-size:.75rem; color:var(--c-sub); font-weight:600; text-transform:uppercase; letter-spacing:.5px; }
.kpi-card .kdiff { font-size:.78rem; margin-top:4px; }
.kdiff.pos { color:var(--c-ok); }
.kdiff.neg { color:var(--c-danger); }

/* â”€â”€ SECTION CARDS â”€â”€ */
.section { background:var(--c-card); border-radius:var(--r); box-shadow:var(--shadow); margin-bottom:24px; overflow:hidden; }
.section-hdr {
    display:flex; align-items:center; gap:10px;
    padding:18px 24px; border-bottom:1px solid var(--c-border);
    background:linear-gradient(90deg,#f8faff,#fff);
}
.section-hdr .ico { font-size:1.2rem; }
.section-hdr h2 { font-size:1rem; font-weight:700; color:var(--c-text); }
.section-hdr .hint { font-size:.75rem; color:var(--c-sub); margin-left:auto; }
.section-body { padding:24px; }

/* â”€â”€ TWO COLUMN â”€â”€ */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
.three-col { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; }
@media(max-width:900px){ .two-col, .three-col { grid-template-columns:1fr; } }

/* â”€â”€ CHART CONTAINERS â”€â”€ */
.chart-wrap { position:relative; }
.chart-wrap canvas { max-height:300px; }
.chart-wrap-tall canvas { max-height:380px; }

/* â”€â”€ TABLES â”€â”€ */
.rep-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.rep-table th { background:#f1f5f9; text-transform:uppercase; font-size:.7rem; letter-spacing:.5px; color:var(--c-sub); padding:9px 12px; text-align:left; border-bottom:2px solid var(--c-border); }
.rep-table td { padding:8px 12px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
.rep-table tr:last-child td { border-bottom:none; }
.rep-table tr:hover td { background:#f8faff; }
.rep-table .rank { width:32px; color:var(--c-sub); font-weight:700; }
.rep-table .num { text-align:right; font-variant-numeric:tabular-nums; font-weight:600; }
.rep-table .pct { text-align:right; color:var(--c-sub); font-size:.78rem; }
.badge { display:inline-block; border-radius:4px; padding:2px 8px; font-size:.72rem; font-weight:700; }
.badge-red    { background:#fee2e2; color:#b91c1c; }
.badge-blue   { background:#dbeafe; color:#1e40af; }
.badge-green  { background:#dcfce7; color:#15803d; }
.badge-yellow { background:#fef9c3; color:#92400e; }
.badge-purple { background:#ede9fe; color:#5b21b6; }
.badge-gray   { background:#f1f5f9; color:#475569; }

/* â”€â”€ PROGRESS BAR â”€â”€ */
.prog-bar { background:#f1f5f9; border-radius:100px; overflow:hidden; height:8px; margin-top:4px; }
.prog-fill { height:100%; border-radius:100px; transition:width .6s; }

/* â”€â”€ IC DIS CARDS â”€â”€ */
.ic-dis-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.ic-card { border-radius:10px; padding:20px 24px; }
.ic-card.ic { background:linear-gradient(135deg,#eff6ff,#dbeafe); border:1.5px solid #93c5fd; }
.ic-card.dis { background:linear-gradient(135deg,#fff7ed,#fed7aa); border:1.5px solid #fdba74; }
.ic-card h3 { font-size:.85rem; font-weight:700; margin-bottom:6px; }
.ic-card .ic-val { font-size:2rem; font-weight:800; margin-bottom:2px; }
.ic-card.ic .ic-val { color:#1d4ed8; }
.ic-card.dis .ic-val { color:#c2410c; }

/* â”€â”€ AKSIYON PLAN TABLE â”€â”€ */
.ap-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.ap-table th { background:#1e2535; color:#e2e8f0; padding:10px 14px; text-align:left; font-size:.72rem; text-transform:uppercase; letter-spacing:.5px; }
.ap-table td { padding:10px 14px; border-bottom:1px solid #f1f5f9; }
.ap-table tr:nth-child(even) td { background:#fafbff; }
.ap-table .pri { font-weight:700; font-size:.78rem; }
.pri-yuksek { color:#b91c1c; }
.pri-orta   { color:#b45309; }
.pri-dusuk  { color:#166534; }

/* â”€â”€ 6M GRID â”€â”€ */
.m6-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
.m6-card { border-radius:10px; padding:16px; border:1.5px solid; }
.m6-card .m6-title { font-size:.8rem; font-weight:700; margin-bottom:8px; }
.m6-card .m6-val { font-size:1.4rem; font-weight:800; margin-bottom:4px; }
.m6-card .m6-list { font-size:.75rem; color:var(--c-sub); }

/* â”€â”€ AKSIYON EDIT BUTTONS â”€â”€ */
.ap-btn { border:none; border-radius:6px; padding:4px 8px; cursor:pointer; font-size:.75rem; font-weight:600; line-height:1; transition:opacity .15s; }
.ap-btn:hover { opacity:.8; }
.ap-btn-edit { background:#e0f2fe; color:#0369a1; }
.ap-btn-del  { background:#fee2e2; color:#b91c1c; }
.ap-btn-add  { background:#dcfce7; color:#166534; }
.ap-actions-col { white-space:nowrap; display:flex; gap:5px; }
.ap-table th:last-child, .ap-table td:last-child { text-align:center; }

/* â”€â”€ MODAL â”€â”€ */
#apModal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(10,15,30,.55); align-items:center; justify-content:center; }
#apModal.open { display:flex; }
#apModalBox { background:#fff; border-radius:14px; padding:28px 28px 20px; width:min(560px,95vw); box-shadow:0 20px 60px rgba(0,0,0,.22); max-height:90vh; overflow-y:auto; }
#apModalBox h3 { margin:0 0 18px; font-size:1rem; color:#1e2535; }
.ap-field { margin-bottom:14px; }
.ap-field label { display:block; font-size:.75rem; font-weight:700; color:#475569; margin-bottom:4px; text-transform:uppercase; letter-spacing:.4px; }
.ap-field input, .ap-field textarea, .ap-field select { width:100%; box-sizing:border-box; padding:8px 10px; border:1.5px solid #cbd5e1; border-radius:8px; font-size:.85rem; font-family:inherit; color:#1e2535; outline:none; transition:border-color .15s; resize:vertical; }
.ap-field input:focus, .ap-field textarea:focus, .ap-field select:focus { border-color:#3b82f6; }
.ap-modal-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.ap-modal-footer { display:flex; gap:10px; justify-content:flex-end; margin-top:18px; border-top:1px solid #f1f5f9; padding-top:16px; }
.ap-modal-save { background:linear-gradient(135deg,#2563eb,#3b82f6); color:#fff; border:none; border-radius:8px; padding:9px 22px; font-size:.85rem; font-weight:700; cursor:pointer; }
.ap-modal-save:hover { opacity:.9; }
.ap-modal-cancel { background:#f1f5f9; color:#475569; border:none; border-radius:8px; padding:9px 18px; font-size:.85rem; font-weight:600; cursor:pointer; }
.ap-section-toolbar { display:flex; align-items:center; gap:10px; margin-bottom:12px; }

/* â”€â”€ PRINT â”€â”€ */
@media print {
    .topbar, .sidebar, .topbar-right, .no-print { display:none !important; }
    .layout { display:block; }
    .main { padding:16px; max-width:100%; }
    .section { break-inside:avoid; box-shadow:none; border:1px solid #e2e6ed; }
    .kpi-card { box-shadow:none; border:1px solid #e2e6ed; }
    .report-header { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    body { font-size:11px; }
    .kpi-card .kval { font-size:1.5rem; }
    canvas { max-height:200px !important; }
}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state { text-align:center; padding:60px 20px; color:var(--c-sub); }
.empty-state .emo { font-size:3rem; margin-bottom:12px; }

/* â”€â”€ SCROLL NAV â”€â”€ */
.scroll-progress { position:fixed; top:52px; left:0; height:3px; background:var(--c-accent); z-index:300; transition:width .1s; }
</style>
</head>
<body>

<div class="scroll-progress" id="scrollProg"></div>

<!-- TOPBAR -->
<div class="topbar no-print">
    <div class="logo">ğŸ“Š Kalite<span>Rapor</span></div>
    <div id="topbarTitle" style="color:#93c5fd;font-size:.85rem;"></div>
    <div class="topbar-right">
        <button class="btn btn-outline" onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r / PDF</button>
        <button class="btn btn-primary" onclick="window.close()">âœ– Kapat</button>
    </div>
</div>

<div class="layout">
<!-- SIDEBAR NAV -->
<nav class="sidebar no-print">
    <h3>Ä°Ã§indekiler</h3>
    <div class="nav-item active" onclick="navScrollTo('s-ozet')"><span class="nav-ico">ğŸ“‹</span> Ã–zet</div>
    <div class="nav-item" onclick="navScrollTo('s-icdis')"><span class="nav-ico">âš–ï¸</span> Ä°Ã§ / DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k</div>
    <div class="nav-item" onclick="navScrollTo('s-tedarikci')"><span class="nav-ico">ğŸ­</span> TedarikÃ§i KaynaklÄ±</div>
    <div class="nav-item" onclick="navScrollTo('s-malzeme')"><span class="nav-ico">ğŸ“¦</span> Malzeme BazlÄ±</div>
    <div class="nav-item" onclick="navScrollTo('s-musteri')"><span class="nav-ico">ğŸ‘¥</span> MÃ¼ÅŸteri / Åube BazlÄ±</div>
    <div class="nav-item" onclick="navScrollTo('s-hatatipi')"><span class="nav-ico">ğŸ”</span> Hata Tipi DaÄŸÄ±lÄ±mÄ±</div>
    <div class="nav-item" onclick="navScrollTo('s-6m')"><span class="nav-ico">ğŸ”§</span> 6M Kaynak Analizi</div>
    <div class="nav-item" onclick="navScrollTo('s-trend')"><span class="nav-ico">ğŸ“ˆ</span> AylÄ±k Trend</div>
    <div class="nav-item" onclick="navScrollTo('s-aksiyon')"><span class="nav-ico">âœ…</span> Aksiyon PlanÄ±</div>
</nav>

<!-- MAIN CONTENT -->
<main class="main" id="mainArea">

    <!-- LOADING -->
    <div id="loadingState" class="empty-state">
        <div class="emo">â³</div>
        <p>Rapor yÃ¼kleniyorâ€¦</p>
    </div>

    <div id="reportContent" style="display:none;">

    <!-- REPORT HEADER -->
    <div class="report-header" id="s-ozet">
        <h1 id="rhTitle">Kalite Uygunsuzluk Raporu</h1>
        <div class="sub" id="rhSub">Uygunsuzluk Analizi â€” TÃ¼m Veriler</div>
        <div class="rh-meta" id="rhMeta"></div>
    </div>

    <!-- KPI CARDS -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- Ä°Ã‡ / DIÅ BAÅARISIZLIK -->
    <div class="section" id="s-icdis">
        <div class="section-hdr">
            <span class="ico">âš–ï¸</span>
            <h2>Ä°Ã§ & DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k Analizi</h2>
            <span class="hint">tipi alanÄ±na gÃ¶re sÄ±nÄ±flandÄ±rma</span>
        </div>
        <div class="section-body">
            <div class="ic-dis-grid" style="margin-bottom:24px;" id="icDisCards"></div>
            <div class="two-col">
                <div class="chart-wrap"><canvas id="cIcDis"></canvas></div>
                <div id="icDisTable"></div>
            </div>
        </div>
    </div>

    <!-- TEDARÄ°KÃ‡Ä° -->
    <div class="section" id="s-tedarikci">
        <div class="section-hdr">
            <span class="ico">ğŸ­</span>
            <h2>TedarikÃ§i KaynaklÄ± Hatalar</h2>
            <span class="hint">Cari adÄ±na gÃ¶re Pareto â€” Top 15</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cTedarikci"></canvas></div>
                <div id="tedarikciTable"></div>
            </div>
        </div>
    </div>

    <!-- MALZEME -->
    <div class="section" id="s-malzeme">
        <div class="section-hdr">
            <span class="ico">ğŸ“¦</span>
            <h2>Malzeme (Stok AdÄ±) BazlÄ± Hatalar</h2>
            <span class="hint">Stok adÄ±na gÃ¶re Pareto â€” Top 15</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cMalzeme"></canvas></div>
                <div id="malzemeTable"></div>
            </div>
        </div>
    </div>

    <!-- MÃœÅTERÄ° / ÅUBE -->
    <div class="section" id="s-musteri">
        <div class="section-hdr">
            <span class="ico">ğŸ‘¥</span>
            <h2>MÃ¼ÅŸteri / Åube BazlÄ± Hata DaÄŸÄ±lÄ±mÄ±</h2>
            <span class="hint">Tespit yerlerine gÃ¶re â€” dÄ±ÅŸ kaynaklÄ±lar Ã¶n plana</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cMusteri"></canvas></div>
                <div id="musteriTable"></div>
            </div>
        </div>
    </div>

    <!-- HATA TÄ°PÄ° -->
    <div class="section" id="s-hatatipi">
        <div class="section-hdr">
            <span class="ico">ğŸ”</span>
            <h2>Hata Tipi DaÄŸÄ±lÄ±mÄ±</h2>
            <span class="hint">Pareto + kÃ¼mÃ¼latif</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall"><canvas id="cHataTipi"></canvas></div>
                <div id="hataTipiTable"></div>
            </div>
        </div>
    </div>

    <!-- 6M -->
    <div class="section" id="s-6m">
        <div class="section-hdr">
            <span class="ico">ğŸ”§</span>
            <h2>6M Kaynak Analizi</h2>
            <span class="hint">hataKaynagi alanÄ± anahtar kelime sÄ±nÄ±flandÄ±rmasÄ±</span>
        </div>
        <div class="section-body">
            <div class="m6-grid" id="m6Grid" style="margin-bottom:24px;"></div>
            <div class="two-col">
                <div class="chart-wrap" style="min-height:260px;"><canvas id="c6M" height="260"></canvas></div>
                <div id="m6Detail"></div>
            </div>
        </div>
    </div>

    <!-- TREND -->
    <div class="section" id="s-trend">
        <div class="section-hdr">
            <span class="ico">ğŸ“ˆ</span>
            <h2>AylÄ±k Trend Analizi</h2>
            <span class="hint">HatalÄ± miktar aylara gÃ¶re â€” son 18 ay</span>
        </div>
        <div class="section-body">
            <div class="two-col">
                <div class="chart-wrap-tall" style="grid-column:1/-1;"><canvas id="cTrend"></canvas></div>
            </div>
            <div id="trendInsight" style="margin-top:16px; padding:14px 18px; background:#eff6ff; border-radius:10px; border-left:4px solid var(--c-accent); font-size:.85rem; color:#1e3a8a;"></div>
        </div>
    </div>

    <!-- AKSÄ°YON PLANI -->
    <div class="section" id="s-aksiyon">
        <div class="section-hdr">
            <span class="ico">âœ…</span>
            <h2>Aksiyon PlanÄ± Ã–nerileri</h2>
            <span class="hint">Veriye dayalÄ± otomatik oluÅŸturuldu</span>
        </div>
        <div class="section-body">
            <div class="ap-section-toolbar">
                <p style="color:var(--c-sub);font-size:.8rem;margin:0;flex:1;">Analiz bulgularÄ±na gÃ¶re otomatik oluÅŸturulmuÅŸtur. DÃ¼zenleyebilir, silebilir veya yeni satÄ±r ekleyebilirsiniz.</p>
                <button class="ap-btn ap-btn-add no-print" onclick="apOpenAdd()">ï¼‹ SatÄ±r Ekle</button>
            </div>
            <table class="ap-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Bulgu / Problem</th>
                        <th>Kategori</th>
                        <th>Ã–nerilen Aksiyon</th>
                        <th>Ã–ncelik</th>
                        <th>Hedef SÃ¼re</th>
                        <th class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="aksiyonBody"></tbody>
            </table>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="apModal">
        <div id="apModalBox">
            <h3 id="apModalTitle">SatÄ±rÄ± DÃ¼zenle</h3>
            <div class="ap-field">
                <label>Bulgu / Problem</label>
                <textarea id="apFBulgu" rows="2"></textarea>
            </div>
            <div class="ap-modal-row">
                <div class="ap-field">
                    <label>Kategori</label>
                    <select id="apFKat">
                        <option value="Hata Tipi|badge-red">Hata Tipi</option>
                        <option value="TedarikÃ§i|badge-purple">TedarikÃ§i</option>
                        <option value="Malzeme|badge-yellow">Malzeme</option>
                        <option value="Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k|badge-blue">Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k</option>
                        <option value="DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k|badge-red">DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k</option>
                        <option value="6M Analizi|badge-green">6M Analizi</option>
                        <option value="Sistem|badge-gray">Sistem</option>
                        <option value="DiÄŸer|badge-gray">DiÄŸer</option>
                    </select>
                </div>
                <div class="ap-field">
                    <label>Ã–ncelik</label>
                    <select id="apFOncelik">
                        <option value="YÃ¼ksek">YÃ¼ksek</option>
                        <option value="Orta">Orta</option>
                        <option value="DÃ¼ÅŸÃ¼k">DÃ¼ÅŸÃ¼k</option>
                    </select>
                </div>
            </div>
            <div class="ap-field">
                <label>Ã–nerilen Aksiyon</label>
                <textarea id="apFAksiyon" rows="3"></textarea>
            </div>
            <div class="ap-field">
                <label>Hedef SÃ¼re</label>
                <input type="text" id="apFSure" placeholder="Ã¶rn: 2 hafta, 1 ay">
            </div>
            <div class="ap-modal-footer">
                <button class="ap-modal-cancel" onclick="apCloseModal()">Ä°ptal</button>
                <button class="ap-modal-save" onclick="apSaveModal()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div style="text-align:center; color:var(--c-sub); font-size:.75rem; padding:24px 0; margin-top:8px;">
        Rapor <span id="footerDate"></span> tarihinde oluÅŸturuldu Â· Kalite YÃ¶netim Sistemi
    </div>

    </div><!-- /reportContent -->
</main>
</div><!-- /layout -->

<script>
// â”€â”€ Scroll progress â”€â”€
window.addEventListener('scroll', () => {
    const el = document.getElementById('scrollProg');
    const pct = window.scrollY / (document.body.scrollHeight - window.innerHeight) * 100;
    if(el) el.style.width = Math.min(pct, 100) + '%';
});

// â”€â”€ Nav active â”€â”€
function navScrollTo(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
}

// â”€â”€ Helpers â”€â”€
function fmtN(n, d=0) {
    if (n == null || isNaN(n)) return 'â€”';
    return Number(n).toLocaleString('tr-TR', { maximumFractionDigits: d });
}
function fmtPct(p) { return '%' + Number(p).toFixed(1); }
function truncate(s, n=40) { return s && s.length > n ? s.slice(0, n) + 'â€¦' : (s || ''); }

// â”€â”€ IndexedDB yardÄ±mcÄ± â”€â”€
const _IDB = { name:'KaliteRaporDB', store:'payloads', key:'rapor_payload', ver:1 };
function idbLoadRapor() {
    return new Promise((res, rej) => {
        const r = indexedDB.open(_IDB.name, _IDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_IDB.store);
        r.onsuccess = e => {
            const db = e.target.result;
            const tx = db.transaction(_IDB.store, 'readonly');
            const g  = tx.objectStore(_IDB.store).get(_IDB.key);
            g.onsuccess = () => res(g.result);
            g.onerror   = () => rej(g.error);
        };
        r.onerror = () => rej(r.error);
    });
}

// â”€â”€ Color palettes â”€â”€
const PAL_BLUE   = ['#1d4ed8','#2563eb','#3b82f6','#60a5fa','#93c5fd','#bfdbfe'];
const PAL_MIXED  = ['#2563eb','#7c3aed','#db2777','#dc2626','#d97706','#16a34a','#0891b2','#1d4ed8'];
const PAL_DANGER = ['#b91c1c','#dc2626','#ef4444','#f87171','#fca5a5','#fecaca'];
const PAL_OK     = '#16a34a';

function paretoColors(n) {
    const base = ['#2563eb','#7c3aed','#db2777','#dc2626','#d97706','#16a34a','#0891b2','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#22c55e','#06b6d4'];
    return Array.from({length:n}, (_, i) => base[i % base.length]);
}

// â”€â”€ Pareto data helper â”€â”€
function paretoData(rows, field, n = 15) {
    const agg = {};
    const totalH = rows.reduce((s,r) => s + (Number(r.hataliMiktar)||0), 0) || 1;
    rows.forEach(r => {
        const v = (r[field] || '').trim();
        if (!v) return;
        if (!agg[v]) agg[v] = { h:0, c:0 };
        agg[v].h += Number(r.hataliMiktar)||0;
        agg[v].c++;
    });
    let entries = Object.entries(agg).sort((a,b) => b[1].h - a[1].h).slice(0, n);
    let cum = 0;
    return entries.map(([name, v]) => {
        cum += v.h;
        return { name, h: v.h, c: v.c, pct: v.h / totalH * 100, cumPct: cum / totalH * 100 };
    });
}

// â”€â”€ Table builder â”€â”€
function buildParetoTable(entries, totalH, colorFn) {
    const maxH = entries[0]?.h || 1;
    let html = `<table class="rep-table"><thead><tr><th class="rank">#</th><th>Ad</th><th class="num">HatalÄ±</th><th class="pct">%</th></tr></thead><tbody>`;
    entries.slice(0,12).forEach((e,i) => {
        const col = colorFn ? colorFn(i) : paretoColors(12)[i];
        const pct = (e.h / (totalH||1) * 100).toFixed(1);
        html += `<tr>
            <td class="rank">${i+1}</td>
            <td><div style="font-weight:600;margin-bottom:3px;">${truncate(e.name,38)}</div>
                <div class="prog-bar"><div class="prog-fill" style="width:${Math.round(e.h/maxH*100)}%;background:${col};"></div></div>
            </td>
            <td class="num">${fmtN(e.h)}</td>
            <td class="pct">${fmtPct(pct)}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

// â”€â”€ Horizontal bar chart â”€â”€
function hBarChart(ctx, labels, values, colors, label='HatalÄ± Miktar') {
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{ label, data: values, backgroundColor: colors, borderRadius: 4, borderSkipped: false }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ` ${fmtN(ctx.raw)} adet`
                    }
                }
            },
            scales: {
                x: { ticks: { font:{size:10} }, grid:{ color:'#f1f5f9' } },
                y: { ticks: { font:{size:10}, callback: v => truncate(v, 28) } }
            }
        }
    });
}

// â”€â”€ Pareto line+bar chart â”€â”€
function paretoChart(ctx, entries) {
    const labels = entries.map(e => truncate(e.name, 22));
    const vals   = entries.map(e => e.h);
    const cums   = entries.map(e => e.cumPct);
    const cols   = paretoColors(entries.length);
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { type:'bar',  label:'HatalÄ± Miktar', data:vals, backgroundColor:cols, yAxisID:'y', borderRadius:5, order:2 },
                { type:'line', label:'KÃ¼mÃ¼latif %',   data:cums, borderColor:'#dc2626', backgroundColor:'rgba(220,38,38,.08)', yAxisID:'y2', tension:.35, pointRadius:3, fill:true, order:1 }
            ]
        },
        options: {
            responsive:true, maintainAspectRatio:true,
            plugins: {
                legend:{ position:'top', labels:{ font:{size:11} } },
                tooltip:{ callbacks:{
                    label: ctx => ctx.datasetIndex===0 ? ` ${fmtN(ctx.raw)} adet` : ` %${Number(ctx.raw).toFixed(1)}`
                }}
            },
            scales: {
                x: { ticks:{ font:{size:9}, maxRotation:45 }, grid:{color:'#f1f5f9'} },
                y: { position:'left',  title:{display:true,text:'HatalÄ± Miktar',font:{size:10}}, ticks:{font:{size:10}} },
                y2:{ position:'right', min:0, max:100, title:{display:true,text:'%',font:{size:10}}, ticks:{ font:{size:10}, callback:v=>v+'%' }, grid:{display:false} }
            }
        }
    });
}

// â”€â”€ 6M CLASSIFIER (same as main page) â”€â”€
function classify6M(rows) {
    const RULES = [
        { bone:'insan',   kws:['iÅŸÃ§i','iÅŸcilik','iscilik','operatÃ¶r','operator','personel','eÄŸitim','egitim','dikkatsiz','ihmal','Ã§alÄ±ÅŸan','calisan','insan','adam','yorgun','tecrÃ¼be','tecrubesiz'] },
        { bone:'malzeme', kws:['hammadde','ham madde','malzeme kalite','malzeme','tedarikÃ§i','tedarikci','hammad','kalitesiz','stok','yar mamul','yarÄ± mamul'] },
        { bone:'metot',   kws:['hatalÄ± talimat','hatali talimat','prosedÃ¼r','prosedur','yÃ¶ntem','yontem','sÃ¼reÃ§','surec','standart','talimat','instruks','uygulama hatasÄ±'] },
        { bone:'makine',  kws:['makine','ekipman','kalibrasyon','arÄ±za','ariza','bakÄ±m','bakim','tertibat','aparat','kalÄ±p','kalip','pres','hidrolik'] },
        { bone:'olcum',   kws:['Ã¶lÃ§Ã¼m','olcum','muayene','kontrol','test','Ã¶lÃ§me','tolerans'] },
        { bone:'ortam',   kws:['sevkiyat','depolama','nakliye','Ã§evre','cevre','sÄ±caklÄ±k','sicaklik','nem','ortam','ambalaj'] },
    ];
    const totalH = rows.reduce((s,r) => s+(Number(r.hataliMiktar)||0),0)||1;
    const agg = {};
    rows.forEach(r => {
        const v = (r.hataKaynagi||'').trim(); if(!v) return;
        if(!agg[v]) agg[v]={h:0,c:0};
        agg[v].h += Number(r.hataliMiktar)||0; agg[v].c++;
    });
    const result = { insan:[], malzeme:[], metot:[], makine:[], olcum:[], ortam:[] };
    Object.entries(agg).forEach(([name,v]) => {
        const lower = name.toLowerCase();
        let bone = null;
        for(const rule of RULES) { if(rule.kws.some(kw=>lower.includes(kw))){ bone=rule.bone; break; } }
        if(!bone) return;
        const pct = (v.h/totalH*100).toFixed(1);
        result[bone].push({ name, pct:Number(pct), h:v.h, c:v.c });
    });
    for(const k of Object.keys(result)) result[k].sort((a,b)=>b.h-a.h);
    return result;
}

// â”€â”€ IC/DIS CLASSIFIER â”€â”€
function classifyIcDis(rows) {
    const ic = [], dis = [], belirsiz = [];

    // tipi alanÄ± iÃ§in IC / DIÅ anahtar kelimeleri
    const IC_TIPI  = ['iÃ§','ic','dahili','internal','iÃ§ ','in-house','Ã¼retim','imalat','fabrika'];
    const DIS_TIPI = ['dÄ±ÅŸ','dis','external','mÃ¼ÅŸteri','ÅŸikay','kargo','saha','servis','ÅŸube','nakliye','iade'];

    // uygunsuzlukTuru alanÄ± iÃ§in sinyal kelimeleri
    const IC_URU   = ['iÃ§','ic','dahili','iÃ§ kontrol','iÃ§ Ã¼retim','Ã¼retim'];
    const DIS_URU  = ['dÄ±ÅŸ','mÃ¼ÅŸteri','ÅŸikay','saha','iade','kargo'];

    function matchesAny(str, kwList) {
        const s = (str||'').toLowerCase().trim();
        return kwList.some(kw => s.includes(kw));
    }

    rows.forEach(r => {
        const tipi = (r.tipi||'').toLowerCase().trim();
        const tur  = (r.uygunsuzlukTuru||'').toLowerCase().trim();

        // 1. Ã–nce tipi alanÄ±na bak
        if (tipi && matchesAny(tipi, IC_TIPI))  { ic.push(r);       return; }
        if (tipi && matchesAny(tipi, DIS_TIPI)) { dis.push(r);      return; }

        // 2. uygunsuzlukTuru alanÄ±na bak
        if (tur  && matchesAny(tur,  IC_URU))   { ic.push(r);       return; }
        if (tur  && matchesAny(tur,  DIS_URU))  { dis.push(r);      return; }

        // 3. Hala eÅŸleÅŸmediyse â€” belirsiz olarak iÅŸaretle (hatalÄ± Ä°Ã§'e atmayÄ±z)
        belirsiz.push(r);
    });

    return { ic, dis, belirsiz };
}

// tipi ve uygunsuzlukTuru deÄŸerlerinin benzersiz listesini ve sayÄ±mlarÄ±nÄ± dÃ¶ndÃ¼r
function getIcDisDiagnostic(rows) {
    const tipiCount = {}, turCount = {};
    rows.forEach(r => {
        const t = (r.tipi||'(boÅŸ)').trim();
        const u = (r.uygunsuzlukTuru||'(boÅŸ)').trim();
        tipiCount[t] = (tipiCount[t]||0) + 1;
        turCount[u]  = (turCount[u] ||0) + 1;
    });
    return { tipiCount, turCount };
}

// â”€â”€ SAFE PARSE DATE â”€â”€
function parseDateStr(s) {
    if (!s) return null;
    if (s instanceof Date) return isNaN(s.getTime()) ? null : s;
    const str = String(s).trim();
    // DD.MM.YYYY or DD/MM/YYYY
    let m = str.match(/^(\d{1,2})[.\/\-](\d{1,2})[.\/\-](\d{4})$/);
    if (m) return new Date(+m[3], +m[2]-1, +m[1]);
    // YYYY-MM-DD
    m = str.match(/^(\d{4})[.\-\/](\d{2})[.\-\/](\d{2})/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3]);
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
}

// â”€â”€ MONTHLY TREND â”€â”€
function buildTrend(rows) {
    const map = {};
    rows.forEach(r => {
        const d = parseDateStr(r.uygunsuzlukTarih);
        if (!d) return;
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        if (!map[key]) map[key] = { h:0, c:0 };
        map[key].h += Number(r.hataliMiktar)||0;
        map[key].c++;
    });
    const keys = Object.keys(map).sort();
    // limit to last 18 months
    const last18 = keys.slice(-18);
    return {
        labels: last18.map(k => {
            const [y,m] = k.split('-');
            const months = ['Oca','Åub','Mar','Nis','May','Haz','Tem','AÄŸu','Eyl','Eki','Kas','Ara'];
            return `${months[+m-1]} ${y.slice(2)}`;
        }),
        hatali: last18.map(k => map[k].h),
        kayit:  last18.map(k => map[k].c),
        keys: last18
    };
}

// â”€â”€ ACTION PLAN GENERATOR â”€â”€
function generateActionPlan(rows, topHataTipi, topTedarikci, topMalzeme, icDis, m6) {
    const actions = [];
    const totalH = rows.reduce((s,r) => s+(Number(r.hataliMiktar)||0),0)||1;

    // Top hata tipi
    topHataTipi.slice(0,3).forEach((e,i) => {
        actions.push({
            bulgu: `En yÃ¼ksek hata tipi: "${truncate(e.name,35)}"`,
            kat: 'Hata Tipi', katBadge: 'badge-red',
            aksiyon: `KÃ¶k neden analizi yapÄ±lmalÄ± (5-Neden / Fishbone). Hata oluÅŸum koÅŸullarÄ± belirlenmeli ve dÃ¼zeltici faaliyet baÅŸlatÄ±lmalÄ±.`,
            oncelik: i===0 ? 'YÃ¼ksek' : 'Orta',
            sure: i===0 ? '2 hafta' : '1 ay'
        });
    });

    // Top tedarikÃ§i
    topTedarikci.slice(0,2).forEach((e,i) => {
        const pct = (e.h/totalH*100).toFixed(1);
        actions.push({
            bulgu: `TedarikÃ§i "${truncate(e.name,30)}" toplam hatanÄ±n %${pct}'ini oluÅŸturuyor`,
            kat: 'TedarikÃ§i', katBadge: 'badge-purple',
            aksiyon: `TedarikÃ§i denetimi planlanmalÄ±. GiriÅŸ muayene kriterleri gÃ¶zden geÃ§irilmeli. Gerekirse alternatif tedarikÃ§i deÄŸerlendirmesi yapÄ±lmalÄ±.`,
            oncelik: pct > 20 ? 'YÃ¼ksek' : 'Orta',
            sure: '3 hafta'
        });
    });

    // Top malzeme
    topMalzeme.slice(0,2).forEach((e,i) => {
        actions.push({
            bulgu: `Malzeme "${truncate(e.name,30)}" iÃ§in yÃ¼ksek hata oranÄ±`,
            kat: 'Malzeme', katBadge: 'badge-yellow',
            aksiyon: `Bu malzeme iÃ§in muayene talimatÄ± / kontrol planÄ± gÃ¼ncellenmeli. TedarikÃ§iden kalite sertifikasÄ± (CoA) talep edilmeli.`,
            oncelik: 'Orta',
            sure: '1 ay'
        });
    });

    // Ä°Ã§/DÄ±ÅŸ analizi
    const icH  = icDis.ic.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const disH = icDis.dis.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    if (disH > icH * 0.3) {
        actions.push({
            bulgu: `DÄ±ÅŸ baÅŸarÄ±sÄ±zlÄ±k oranÄ± yÃ¼ksek (%${(disH/totalH*100).toFixed(1)}) â€” mÃ¼ÅŸteri/saha ÅŸikayetleri`,
            kat: 'DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k', katBadge: 'badge-red',
            aksiyon: `Sevkiyat Ã¶ncesi son kontrol prosedÃ¼rÃ¼ gÃ¼Ã§lendirilmeli. Paketleme & etiketleme prosedÃ¼rÃ¼ gÃ¶zden geÃ§irilmeli. MÃ¼ÅŸteri iade sÃ¼reÃ§ haritasÄ± Ã§izilmeli.`,
            oncelik: 'YÃ¼ksek',
            sure: '2 hafta'
        });
    }
    if (icH > totalH * 0.5) {
        actions.push({
            bulgu: `Ä°Ã§ baÅŸarÄ±sÄ±zlÄ±k oranÄ± dominant (%${(icH/totalH*100).toFixed(1)}) â€” sÃ¼reÃ§ iÃ§i israf`,
            kat: 'Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k', katBadge: 'badge-blue',
            aksiyon: `Ãœretim / hizmet sÃ¼recinde proses kontrol noktalarÄ± artÄ±rÄ±lmalÄ±. OperatÃ¶r eÄŸitimi ve farkÄ±ndalÄ±k programÄ± dÃ¼zenlenmeli. Kalite kontrol noktalarÄ± gÃ¶zden geÃ§irilmeli.`,
            oncelik: 'Orta',
            sure: '4 hafta'
        });
    }

    // 6M insights
    const m6Totals = Object.entries(m6).map(([k,v]) => ({ k, h: v.reduce((s,e)=>s+e.h,0) })).sort((a,b)=>b.h-a.h);
    if (m6Totals[0] && m6Totals[0].h > 0) {
        const boneMap = { insan:'Ä°nsan (eÄŸitim/iÅŸÃ§ilik)', malzeme:'Malzeme', metot:'Metot/SÃ¼reÃ§', makine:'Makine/Ekipman', olcum:'Ã–lÃ§Ã¼m/Muayene', ortam:'Ortam/Lojistik' };
        const boneAct = {
            insan:   'Personel eÄŸitim programÄ± ve Ã§alÄ±ÅŸma talimatÄ± gÃ¼ncellemesi planlanmalÄ±.',
            malzeme: 'Malzeme kabul kriterleri ve tedarikÃ§i deÄŸerlendirmesi gÃ¶zden geÃ§irilmeli.',
            metot:   'Proses talimatlarÄ± ve standart Ã§alÄ±ÅŸma prosedÃ¼rleri (SOP) gÃ¼ncellenmeli.',
            makine:  'Periyodik bakÄ±m planÄ± oluÅŸturulmalÄ± / gÃ¼ncellenmeli. Kalibrasyon takibi yapÄ±lmalÄ±.',
            olcum:   'Ã–lÃ§Ã¼m sistemi analizi (MSA) yapÄ±lmalÄ±. Muayene talimatlarÄ± gÃ¼ncellenmeli.',
            ortam:   'Depolama & sevkiyat koÅŸullarÄ± iyileÅŸtirilmeli. Ambalaj standardÄ± belirlenmeli.'
        };
        actions.push({
            bulgu: `6M analizine gÃ¶re en yÃ¼ksek kaynak: ${boneMap[m6Totals[0].k]}`,
            kat: '6M Analizi', katBadge: 'badge-green',
            aksiyon: boneAct[m6Totals[0].k] || 'KÃ¶k neden analizi derinleÅŸtirilmeli.',
            oncelik: 'Orta',
            sure: '3 hafta'
        });
    }

    // Genel
    actions.push({
        bulgu: 'Periyodik kalite gÃ¶zden geÃ§irme toplantÄ±sÄ± eksikliÄŸi riski',
        kat: 'Sistem', katBadge: 'badge-gray',
        aksiyon: 'AylÄ±k KPI takibi iÃ§in kalite gÃ¶zden geÃ§irme toplantÄ±sÄ± takvimi oluÅŸturulmalÄ±. Bu rapor bazÄ±nda aylÄ±k trend izlenmeli.',
        oncelik: 'DÃ¼ÅŸÃ¼k',
        sure: '1 ay'
    });

    return actions;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AKSIYON PLAN EDIT LOGIC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _PRI_COLOR = { 'YÃ¼ksek':'pri-yuksek', 'Orta':'pri-orta', 'DÃ¼ÅŸÃ¼k':'pri-dusuk' };
const _KAT_BADGE_MAP = {
    'Hata Tipi':'badge-red','TedarikÃ§i':'badge-purple','Malzeme':'badge-yellow',
    'Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k':'badge-blue','DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k':'badge-red',
    '6M Analizi':'badge-green','Sistem':'badge-gray','DiÄŸer':'badge-gray'
};

function renderAksiyonTablosu() {
    const list = window._aksiyonlar || [];
    document.getElementById('aksiyonBody').innerHTML = list.map((a, i) => `
        <tr>
            <td style="color:var(--c-sub);font-size:.78rem;">${i+1}</td>
            <td>${esc(a.bulgu)}</td>
            <td><span class="badge ${esc(a.katBadge)}">${esc(a.kat)}</span></td>
            <td style="max-width:320px;">${esc(a.aksiyon)}</td>
            <td><span class="pri ${_PRI_COLOR[a.oncelik]||''}">${esc(a.oncelik)}</span></td>
            <td style="color:var(--c-sub);white-space:nowrap;">${esc(a.sure)}</td>
            <td class="no-print"><div class="ap-actions-col">
                <button class="ap-btn ap-btn-edit" onclick="apOpenEdit(${i})">âœï¸ DÃ¼zenle</button>
                <button class="ap-btn ap-btn-del"  onclick="apDelete(${i})">ğŸ—‘ï¸</button>
            </div></td>
        </tr>`).join('');
}

function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let _apEditIdx = -1; // -1 = new row

function _apKatVal(name, badge) {
    return `${name}|${badge}`;
}

function apOpenEdit(idx) {
    _apEditIdx = idx;
    const a = window._aksiyonlar[idx];
    document.getElementById('apModalTitle').textContent = 'SatÄ±rÄ± DÃ¼zenle';
    document.getElementById('apFBulgu').value   = a.bulgu   || '';
    document.getElementById('apFAksiyon').value = a.aksiyon || '';
    document.getElementById('apFOncelik').value = a.oncelik || 'Orta';
    document.getElementById('apFSure').value    = a.sure    || '';
    const katSel = document.getElementById('apFKat');
    const katVal = `${a.kat}|${a.katBadge}`;
    // Try to find matching option
    let found = false;
    for (const opt of katSel.options) { if (opt.value === katVal) { katSel.value = opt.value; found = true; break; } }
    if (!found) katSel.value = 'DiÄŸer|badge-gray';
    document.getElementById('apModal').classList.add('open');
}

function apOpenAdd() {
    _apEditIdx = -1;
    document.getElementById('apModalTitle').textContent = 'Yeni SatÄ±r Ekle';
    document.getElementById('apFBulgu').value   = '';
    document.getElementById('apFAksiyon').value = '';
    document.getElementById('apFOncelik').value = 'Orta';
    document.getElementById('apFSure').value    = '';
    document.getElementById('apFKat').value     = 'DiÄŸer|badge-gray';
    document.getElementById('apModal').classList.add('open');
    setTimeout(() => document.getElementById('apFBulgu').focus(), 50);
}

function apCloseModal() {
    document.getElementById('apModal').classList.remove('open');
}

function apSaveModal() {
    const bulgu   = document.getElementById('apFBulgu').value.trim();
    const aksiyon = document.getElementById('apFAksiyon').value.trim();
    const oncelik = document.getElementById('apFOncelik').value;
    const sure    = document.getElementById('apFSure').value.trim();
    const katRaw  = document.getElementById('apFKat').value; // "Name|badge-x"
    const [kat, katBadge] = katRaw.split('|');

    if (!bulgu) { document.getElementById('apFBulgu').focus(); return; }

    const entry = { bulgu, kat, katBadge, aksiyon, oncelik, sure };

    if (_apEditIdx === -1) {
        window._aksiyonlar.push(entry);
    } else {
        window._aksiyonlar[_apEditIdx] = entry;
    }
    renderAksiyonTablosu();
    apCloseModal();
}

function apDelete(idx) {
    if (!confirm('Bu satÄ±rÄ± silmek istediÄŸinizden emin misiniz?')) return;
    window._aksiyonlar.splice(idx, 1);
    renderAksiyonTablosu();
}

// Close modal on backdrop click
document.addEventListener('click', e => {
    if (e.target.id === 'apModal') apCloseModal();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
    idbLoadRapor().then(payload => {
        if (!payload) {
            document.getElementById('loadingState').innerHTML = `
                <div class="empty-state">
                    <div class="emo">âš ï¸</div>
                    <p style="font-size:1rem;font-weight:600;">Rapor verisi bulunamadÄ±</p>
                    <p style="color:var(--c-sub);margin-top:8px;">LÃ¼tfen Uygunsuzluk Analizi sayfasÄ±ndan "KapsamlÄ± Rapor OluÅŸtur" butonuna tÄ±klayÄ±n.</p>
                </div>`;
            return;
        }

        const rows = payload.rows || [];
    if (!rows.length) {
        document.getElementById('loadingState').innerHTML = '<div class="empty-state"><div class="emo">ğŸ“­</div><p>FiltrelenmiÅŸ veri boÅŸ â€” lÃ¼tfen filtreleri kontrol edin.</p></div>';
        return;
    }

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('reportContent').style.display = 'block';

    const totalH   = rows.reduce((s,r) => s+(Number(r.hataliMiktar)||0), 0);
    const totalRec = rows.length;
    const filters  = payload.filters || {};
    const genAt    = new Date(payload.generatedAt || Date.now());

    // â”€â”€ HEADER â”€â”€
    const title = payload.title || 'Kalite Uygunsuzluk Raporu';
    document.title = title;
    document.getElementById('topbarTitle').textContent = title;
    document.getElementById('rhTitle').textContent = title;
    document.getElementById('rhSub').textContent = `Uygunsuzluk Analizi â€” ${totalRec} kayÄ±t Â· ${fmtN(totalH)} hatalÄ± adet`;
    document.getElementById('footerDate').textContent = genAt.toLocaleDateString('tr-TR', {day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'});

    const metaItems = [];
    if (filters.tarihStart || filters.tarihEnd) metaItems.push(`ğŸ“… ${filters.tarihStart||'â€”'} / ${filters.tarihEnd||'â€”'}`);
    if (filters.cari) metaItems.push(`ğŸ¢ ${filters.cari}`);
    if (filters.tespitYeri?.length) metaItems.push(`ğŸ“ ${filters.tespitYeri.join(', ')}`);
    if (filters.hataTipi) metaItems.push(`ğŸ” ${filters.hataTipi}`);
    metaItems.push(`ğŸ“Š ${totalRec} kayÄ±t`);
    metaItems.push(`â± ${genAt.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})} oluÅŸturuldu`);
    document.getElementById('rhMeta').innerHTML = metaItems.map(t=>`<span class="rh-tag">${t}</span>`).join('');

    // â”€â”€ Ä°Ã‡ / DIÅ â”€â”€
    const icDis = classifyIcDis(rows);
    const icH   = icDis.ic.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const disH  = icDis.dis.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const belH  = icDis.belirsiz.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const icPct  = totalH ? (icH /totalH*100).toFixed(1) : 0;
    const disPct = totalH ? (disH/totalH*100).toFixed(1) : 0;
    const belPct = totalH ? (belH/totalH*100).toFixed(1) : 0;

    // TanÄ± verisi â€” hangi tipi/uygunsuzlukTuru deÄŸerleri var
    const diag = getIcDisDiagnostic(rows);

    // â”€â”€ UNIQUE COUNTS â”€â”€
    const uTedarikci = new Set(rows.map(r=>r.cariAdi).filter(Boolean)).size;
    const uMalzeme   = new Set(rows.map(r=>r.stokAdi).filter(Boolean)).size;
    const uHataTipi  = new Set(rows.map(r=>r.hataTipi).filter(Boolean)).size;

    // â”€â”€ KPI CARDS â”€â”€
    const kpis = [
        { val: fmtN(totalRec),    lbl:'Toplam KayÄ±t',       color:'#2563eb' },
        { val: fmtN(totalH),      lbl:'Toplam HatalÄ± Mikt.',color:'#dc2626' },
        { val: fmtN(icH),         lbl:'Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k',    color:'#1d4ed8' },
        { val: fmtN(disH),        lbl:'DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k',   color:'#c2410c' },
        { val: uTedarikci,        lbl:'FarklÄ± TedarikÃ§i',   color:'#7c3aed' },
        { val: uMalzeme,          lbl:'FarklÄ± Malzeme',     color:'#0891b2' },
        { val: uHataTipi,         lbl:'FarklÄ± Hata Tipi',   color:'#be185d' },
        { val: icPct+'%',         lbl:'Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k %',  color:'#16a34a' },
    ];
    document.getElementById('kpiGrid').innerHTML = kpis.map(k => `
        <div class="kpi-card" style="border-top-color:${k.color}">
            <div class="kval" style="color:${k.color}">${k.val}</div>
            <div class="klbl">${k.lbl}</div>
        </div>`).join('');

    // â”€â”€ Ä°Ã‡ / DIÅ CARDS â”€â”€
    const belNote = icDis.belirsiz.length
        ? `<div style="margin-top:10px;padding:8px 12px;background:#fef9c3;border-radius:8px;border-left:3px solid #d97706;font-size:.75rem;color:#78350f;">
            <strong>âš ï¸ ${icDis.belirsiz.length} kayÄ±t sÄ±nÄ±flandÄ±rÄ±lamadÄ±</strong> (%${belPct}) â€”<br>
            <em>tipi</em> deÄŸerleri: ${Object.entries(diag.tipiCount).map(([k,v])=>`<strong>${k}</strong>(${v})`).join(', ')}<br>
            <em>uygunsuzlukTuru</em>: ${Object.entries(diag.turCount).slice(0,5).map(([k,v])=>`<strong>${k}</strong>(${v})`).join(', ')}
           </div>`
        : '';
    document.getElementById('icDisCards').innerHTML = `
        <div class="ic-card ic">
            <h3>ğŸ¢ Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k</h3>
            <div class="ic-val">${fmtN(icH)}</div>
            <div style="color:#1d4ed8;font-weight:700;font-size:1.1rem;">%${icPct}</div>
            <div style="color:#5a6478;font-size:.78rem;margin-top:6px;">${icDis.ic.length} kayÄ±t â€” Ä°Ã§ sÃ¼reÃ§te tespit edilen</div>
            ${belNote}
        </div>
        <div class="ic-card dis">
            <h3>ğŸšš DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k</h3>
            <div class="ic-val">${fmtN(disH)}</div>
            <div style="color:#c2410c;font-weight:700;font-size:1.1rem;">%${disPct}</div>
            <div style="color:#5a6478;font-size:.78rem;margin-top:6px;">${icDis.dis.length} kayÄ±t â€” MÃ¼ÅŸteri/Saha/Åube'de tespit edilen</div>
        </div>`;

    // â”€â”€ Ä°Ã‡/DIÅ CHART â”€â”€
    new Chart(document.getElementById('cIcDis'), {
        type:'doughnut',
        data:{
            labels:['Ä°Ã§ BaÅŸarÄ±sÄ±zlÄ±k','DÄ±ÅŸ BaÅŸarÄ±sÄ±zlÄ±k'],
            datasets:[{ data:[icH,disH], backgroundColor:['#2563eb','#ea580c'], borderWidth:0, hoverOffset:8 }]
        },
        options:{
            responsive:true, maintainAspectRatio:true,
            cutout:'60%',
            plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label: c=>`${c.label}: ${fmtN(c.raw)} adet` }}}
        }
    });

    // â”€â”€ Ä°Ã‡/DIÅ TABLE (by tespitYeri) â”€â”€
    const icDisByYer = paretoData(rows,'tespitYeri',12);
    document.getElementById('icDisTable').innerHTML = buildParetoTable(icDisByYer, totalH);

    // â”€â”€ TEDARÄ°KÃ‡Ä° â”€â”€
    const tedData = paretoData(rows,'cariAdi',15);
    const tedLabels = tedData.map(e=>truncate(e.name,30));
    const tedVals   = tedData.map(e=>e.h);
    hBarChart(document.getElementById('cTedarikci'), tedLabels, tedVals, paretoColors(tedData.length), 'HatalÄ± Miktar');
    document.getElementById('tedarikciTable').innerHTML = buildParetoTable(tedData, totalH);

    // â”€â”€ MALZEME â”€â”€
    const malData = paretoData(rows,'stokAdi',15);
    const malLabels = malData.map(e=>truncate(e.name,32));
    hBarChart(document.getElementById('cMalzeme'), malLabels, malData.map(e=>e.h), paretoColors(malData.length), 'HatalÄ± Miktar');
    document.getElementById('malzemeTable').innerHTML = buildParetoTable(malData, totalH);

    // â”€â”€ MÃœÅTERÄ° / ÅUBE (tespitYeri) â”€â”€
    const mustData = paretoData(rows,'tespitYeri',15);
    hBarChart(document.getElementById('cMusteri'), mustData.map(e=>truncate(e.name,28)), mustData.map(e=>e.h), PAL_DANGER.concat(PAL_BLUE), 'HatalÄ± Miktar');
    document.getElementById('musteriTable').innerHTML = buildParetoTable(mustData, totalH);

    // â”€â”€ HATA TÄ°PÄ° â”€â”€
    const htData = paretoData(rows,'hataTipi',15);
    paretoChart(document.getElementById('cHataTipi'), htData);
    document.getElementById('hataTipiTable').innerHTML = buildParetoTable(htData, totalH);

    // â”€â”€ 6M â”€â”€
    const m6 = classify6M(rows);
    const M6_META = {
        insan:   { label:'ğŸ‘¤ Ä°nsan',   color:'#ef4444', borderColor:'#fca5a5', desc:'Ä°ÅŸÃ§ilik, operatÃ¶r, eÄŸitim kaynaklÄ±' },
        makine:  { label:'âš™ï¸ Makine',  color:'#f59e0b', borderColor:'#fcd34d', desc:'Makine, ekipman, kalibrasyon' },
        malzeme: { label:'ğŸ“¦ Malzeme', color:'#3b82f6', borderColor:'#93c5fd', desc:'Hammadde, tedarikÃ§i, stok kalitesi' },
        metot:   { label:'ğŸ“‹ Metot',   color:'#8b5cf6', borderColor:'#c4b5fd', desc:'Talimat, prosedÃ¼r, standart' },
        olcum:   { label:'ğŸ“ Ã–lÃ§Ã¼m',  color:'#06b6d4', borderColor:'#67e8f9', desc:'Muayene, kontrol, tolerans' },
        ortam:   { label:'ğŸŒ¡ï¸ Ortam',  color:'#22c55e', borderColor:'#86efac', desc:'Sevkiyat, depolama, Ã§evre' },
    };
    const m6Order = ['insan','makine','malzeme','metot','olcum','ortam'];
    document.getElementById('m6Grid').innerHTML = m6Order.map(k => {
        const meta = M6_META[k];
        const items = m6[k];
        const total = items.reduce((s,e)=>s+e.h,0);
        return `<div class="m6-card" style="border-color:${meta.borderColor};background:${meta.color}18;">
            <div class="m6-title" style="color:${meta.color}">${meta.label}</div>
            <div class="m6-val" style="color:${meta.color}">${fmtN(total)}</div>
            <div style="font-size:.7rem;color:var(--c-sub);margin-bottom:8px;">${meta.desc}</div>
            <div class="m6-list">${items.slice(0,3).map(e=>`â€¢ ${truncate(e.name,26)} (%${e.pct})`).join('<br>') || '<span style="color:#bbb;">SÄ±nÄ±flandÄ±rÄ±lan kayÄ±t yok</span>'}</div>
        </div>`;
    }).join('');

    const m6Values   = m6Order.map(k => m6[k].reduce((s,e)=>s+e.h, 0));
    const m6Total6M  = m6Values.reduce((s,v)=>s+v, 0) || 1;
    const m6Pcts     = m6Values.map(v => +(v / m6Total6M * 100).toFixed(1));

    new Chart(document.getElementById('c6M'), {
        type: 'bar',
        data: {
            labels: m6Order.map(k => M6_META[k].label),
            datasets: [{
                label: 'HatalÄ± Miktar',
                data: m6Values,
                backgroundColor: m6Order.map(k => M6_META[k].color + 'cc'),
                borderColor:     m6Order.map(k => M6_META[k].color),
                borderWidth: 2,
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true, maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: {
                    label: c => ` ${fmtN(c.raw)} adet  (%${m6Pcts[c.dataIndex]})`
                }},
                // inline data labels
                afterDraw: undefined
            },
            scales: {
                x: { ticks: { font:{size:10}, callback: v => fmtN(v) }, grid: { color:'#f1f5f9' } },
                y: { ticks: { font:{size:12} } }
            }
        },
        plugins: [{
            id: 'm6Labels',
            afterDatasetDraw(chart) {
                const { ctx, data, scales } = chart;
                ctx.save();
                chart.getDatasetMeta(0).data.forEach((bar, i) => {
                    const val  = data.datasets[0].data[i];
                    const pct  = m6Pcts[i];
                    if (!val) return;
                    const x = bar.x + 6;
                    const y = bar.y;
                    ctx.fillStyle = '#374151';
                    ctx.font = 'bold 11px Segoe UI, sans-serif';
                    ctx.textBaseline = 'middle';
                    ctx.textAlign = 'left';
                    ctx.fillText(`${fmtN(val)}  (%${pct})`, x, y);
                });
                ctx.restore();
            }
        }]
    });

    // 6M detail list
    let m6DetailHtml = '<div style="font-size:.82rem;">';
    m6Order.forEach(k => {
        const meta = M6_META[k];
        const items = m6[k];
        if (!items.length) return;
        m6DetailHtml += `<div style="margin-bottom:14px;">
            <div style="font-weight:700;color:${meta.color};margin-bottom:6px;">${meta.label}</div>`;
        items.slice(0,5).forEach(e => {
            const w = Math.min(Math.round(e.pct*2),100);
            m6DetailHtml += `<div style="margin-bottom:4px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
                    <span>${truncate(e.name,32)}</span>
                    <span style="color:var(--c-sub);">%${e.pct}</span>
                </div>
                <div class="prog-bar"><div class="prog-fill" style="width:${w}%;background:${meta.color};"></div></div>
            </div>`;
        });
        m6DetailHtml += '</div>';
    });
    m6DetailHtml += '</div>';
    document.getElementById('m6Detail').innerHTML = m6DetailHtml || '<span style="color:var(--c-sub);">hataKaynagi alanÄ± dolu kayÄ±t bulunamadÄ±.</span>';

    // â”€â”€ TREND â”€â”€
    const trend = buildTrend(rows);
    new Chart(document.getElementById('cTrend'), {
        type:'line',
        data:{
            labels: trend.labels,
            datasets:[
                {
                    label:'HatalÄ± Miktar', data:trend.hatali,
                    borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.1)',
                    tension:.35, fill:true, pointRadius:4, yAxisID:'y'
                },
                {
                    label:'KayÄ±t SayÄ±sÄ±', data:trend.kayit,
                    borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,.05)',
                    tension:.35, fill:false, pointRadius:3, borderDash:[5,5], yAxisID:'y2'
                }
            ]
        },
        options:{
            responsive:true, maintainAspectRatio:true,
            plugins:{ legend:{ position:'top' } },
            scales:{
                x:{ ticks:{font:{size:10}}, grid:{color:'#f1f5f9'} },
                y:{ position:'left',  ticks:{font:{size:10}}, title:{display:true,text:'HatalÄ± Miktar',font:{size:10}} },
                y2:{ position:'right', ticks:{font:{size:10}}, title:{display:true,text:'KayÄ±t SayÄ±sÄ±',font:{size:10}}, grid:{display:false} }
            }
        }
    });

    // Trend insight
    if (trend.hatali.length >= 3) {
        const last3  = trend.hatali.slice(-3).reduce((s,v)=>s+v,0)/3;
        const prev3  = trend.hatali.slice(-6,-3).reduce((s,v)=>s+v,0)/3;
        let insight = '';
        if (prev3 > 0) {
            const chg = Math.round((last3-prev3)/prev3*100);
            if (chg >= 15)  insight = `âš ï¸ <strong>YÃ¼kselen trend:</strong> Son 3 ay ortalamasÄ± Ã¶nceki 3 aya gÃ¶re <strong>+%${chg} artÄ±ÅŸ</strong> gÃ¶steriyor. Acil mÃ¼dahale Ã¶nerilir.`;
            else if (chg <= -15) insight = `âœ… <strong>Ä°yileÅŸme trendi:</strong> Son 3 ay ortalamasÄ± Ã¶nceki 3 aya gÃ¶re <strong>%${Math.abs(chg)} azalÄ±ÅŸ</strong> gÃ¶steriyor. Ä°yileÅŸtirme Ã§alÄ±ÅŸmalarÄ± etkili.`;
            else insight = `â„¹ï¸ <strong>Stabil trend:</strong> Son 6 ayda belirgin bir deÄŸiÅŸim gÃ¶zlenmedi (%${chg > 0 ? '+' : ''}${chg}).`;
        } else {
            insight = `â„¹ï¸ Yeterli tarihsel veri bulunamadÄ± â€” karÅŸÄ±laÅŸtÄ±rmalÄ± trend hesaplanamadÄ±.`;
        }
        document.getElementById('trendInsight').innerHTML = insight;
    }

    // â”€â”€ AKSÄ°YON PLANI â”€â”€
    const actions = generateActionPlan(rows, htData, tedData, malData, icDis, m6);
    window._aksiyonlar = actions;
    renderAksiyonTablosu();
    }).catch(e => {
        document.getElementById('loadingState').innerHTML = `<div class="empty-state"><div class="emo">âŒ</div><p>Veri okunamadÄ±: ${e.message}</p></div>`;
    });
});
</script>
</body>
</html>
