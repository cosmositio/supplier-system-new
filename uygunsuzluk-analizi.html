<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uygunsuzluk Analizi</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #4a0a6b 0%, #7b2d8b 50%, #b94fc4 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .header-left { display: flex; flex-direction: column; gap: 4px; }
        .header h1 { font-size: 1.8em; display: flex; align-items: center; gap: 12px; }
        .header p { opacity: 0.85; font-size: 0.9em; margin-left: 4px; margin-top: 4px; }
        .back-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            padding: 10px 18px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
            font-size: 0.95em;
        }
        .back-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.04); }
        .page-nav { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .page-nav .back-btn { font-size: 0.85em; padding: 8px 14px; border-radius: 8px; }
        .page-nav .back-btn.active-page { background: rgba(255,255,255,0.35); font-weight: 700; }

        .container { max-width: 1600px; margin: 0 auto; padding: 24px 20px; }

        /* Upload Area */
        .upload-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        .upload-card h2 { font-size: 1.1em; color: #4a0a6b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .drop-zone {
            border: 2.5px dashed #b94fc4;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fdf5ff;
        }
        .drop-zone:hover, .drop-zone.dragover { background: #f3e0ff; border-color: #7b2d8b; }
        .drop-zone .icon { font-size: 2.5em; margin-bottom: 12px; }
        .drop-zone p { color: #555; font-size: 1em; }
        .drop-zone .hint { color: #999; font-size: 0.82em; margin-top: 6px; }
        #fileInput { display: none; }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .stat-card {
            flex: 1;
            min-width: 150px;
            background: white;
            border-radius: 14px;
            padding: 20px 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            text-align: center;
            border-top: 4px solid #b94fc4;
        }
        .stat-card .val { font-size: 2em; font-weight: 800; color: #4a0a6b; }
        .stat-card .lbl { font-size: 0.8em; color: #666; margin-top: 4px; }

        /* Filters */
        .filter-card {
            background: white;
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        .filter-card h2 { font-size: 1em; color: #4a0a6b; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; min-width: 150px; }
        .filter-group label { font-size: 0.78em; font-weight: 600; color: #555; }
        .filter-group select, .filter-group input {
            padding: 8px 10px;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            background: #fafafa;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }
        .filter-group select:focus, .filter-group input:focus { border-color: #b94fc4; }
        .filter-btn {
            padding: 8px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .btn-apply { background: linear-gradient(135deg, #7b2d8b, #b94fc4); color: white; }
        .btn-apply:hover { opacity: 0.9; }
        .btn-reset { background: #f0f0f0; color: #444; }
        .btn-reset:hover { background: #e0e0e0; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            overflow: hidden;
        }
        .tab-btn {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: none;
            font-size: 0.95em;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: #7b2d8b; border-bottom-color: #b94fc4; background: #fdf5ff; }
        .tab-btn:hover:not(.active) { background: #f8f8f8; color: #555; }

        /* Tab Panels */
        .tab-panel {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            display: none;
        }
        .tab-panel.active { display: block; }

        /* Pareto Chart */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 420px;
        }
        .pareto-options {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .pareto-options label { font-size: 0.82em; font-weight: 600; color: #555; }
        .pareto-options select {
            padding: 7px 10px;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            font-size: 0.88em;
            background: #fafafa;
            outline: none;
            transition: border-color 0.2s;
        }
        .pareto-options select:focus { border-color: #b94fc4; }

        /* Data Table */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 14px;
        }
        .table-search {
            padding: 8px 12px;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            min-width: 220px;
            outline: none;
        }
        .table-search:focus { border-color: #b94fc4; }
        .table-info { font-size: 0.82em; color: #666; }
        .table-wrap {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #eee;
            max-height: 480px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82em;
            min-width: 900px;
        }
        thead th {
            background: linear-gradient(135deg, #4a0a6b, #7b2d8b);
            color: white;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 2;
            cursor: pointer;
            user-select: none;
        }
        thead th:hover { background: linear-gradient(135deg, #5e1280, #9b3dab); }
        thead th .sort-icon { opacity: 0.6; margin-left: 4px; }
        tbody tr:nth-child(even) { background: #fdf5ff; }
        tbody tr:hover { background: #f0d9ff; }
        tbody td { padding: 8px 12px; border-bottom: 1px solid #eee; white-space: nowrap; vertical-align: middle; }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.78em;
            font-weight: 600;
        }
        .badge-red { background: #ffe0e0; color: #b71c1c; }
        .btn-8d-link { font-size:0.78em; padding:3px 8px; border:1px solid #1e3c72; border-radius:4px; background:#eef2ff; color:#1e3c72; cursor:pointer; white-space:nowrap; }
        .btn-8d-link:hover { background:#1e3c72; color:#fff; }
        .badge-orange { background: #fff3e0; color: #e65100; }
        .badge-blue { background: #e3f2fd; color: #0d47a1; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 14px;
            flex-wrap: wrap;
        }
        .page-btn {
            padding: 6px 12px;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .page-btn:hover { border-color: #b94fc4; color: #7b2d8b; }
        .page-btn.active { background: #b94fc4; color: white; border-color: #b94fc4; }

        /* Hata Tipi Breakdown */
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
            margin-top: 16px;
        }
        .breakdown-item {
            background: #fdf5ff;
            border-radius: 10px;
            padding: 14px 16px;
            border-left: 4px solid #b94fc4;
        }
        .breakdown-item .bi-name { font-weight: 700; color: #4a0a6b; font-size: 0.9em; margin-bottom: 6px; }
        .breakdown-item .bi-count { font-size: 1.3em; font-weight: 800; color: #7b2d8b; }
        .breakdown-item .bi-pct { font-size: 0.78em; color: #888; margin-top: 2px; }
        .bi-bar { height: 5px; border-radius: 3px; margin-top: 8px; background: #e0c0f0; }
        .bi-bar-fill { height: 5px; border-radius: 3px; background: linear-gradient(90deg, #b94fc4, #7b2d8b); }
        .breakdown-item.excluded { opacity: 0.38; border-left-color: #ccc; }
        .bi-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
        .bi-checkbox { width: 17px; height: 17px; accent-color: #b94fc4; cursor: pointer; flex-shrink: 0; margin-top: 1px; }
        .bi-fishbone-btn {
            margin-top: 10px; width: 100%; padding: 5px 8px;
            font-size: 0.73em; font-weight: 600;
            background: #e8f5f1; color: #1a6b5a;
            border: 1px solid #a8d8cc; border-radius: 6px;
            cursor: pointer; transition: background 0.2s, color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .bi-fishbone-btn:hover { background: #1a6b5a; color: white; border-color: #1a6b5a; }
        .breakdown-item.excluded .bi-fishbone-btn { display: none; }
        /* Ak≈üiyon badge ‚Äî breakdown kartta */
        .bi-aksiyon-badge {
            display: inline-flex; align-items: center; gap: 3px;
            background: #d1fae5; color: #065f46; font-size: 0.68em;
            font-weight: 700; padding: 2px 6px; border-radius: 10px;
            margin-left: 5px; vertical-align: middle; white-space: nowrap;
        }
        /* √áoklu se√ßim */
        .breakdown-item.selected-for-multi {
            border-left-color: #1a6b5a; outline: 2px solid #2ea88a;
            background: #e8f5f1;
        }
        .multi-analyze-bar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999;
            background: linear-gradient(135deg, #1a6b5a, #2ea88a);
            color: white; padding: 12px 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2); font-weight: 600;
        }
        .multi-analyze-bar button {
            background: white; color: #1a6b5a; border: none;
            border-radius: 8px; padding: 8px 18px; font-weight: 700;
            cursor: pointer; font-size: 0.9em;
        }
        .multi-analyze-bar button:hover { background: #d1fae5; }
        .multi-cancel-btn { background: transparent !important; color: white !important; font-size: 0.82em !important; opacity: 0.8; }
        .multi-cancel-btn:hover { opacity: 1 !important; }
        /* Tedarik√ßi analiz butonu */
        .cari-fishbone-btn {
            margin-top: 6px; width: 100%; padding: 5px 8px;
            font-size: 0.73em; font-weight: 600;
            background: #e8f5f1; color: #1a6b5a;
            border: 1px solid #a8d8cc; border-radius: 6px;
            cursor: pointer; transition: background 0.2s, color 0.2s;
            display: none; align-items: center; justify-content: center; gap: 5px;
        }
        .cari-fishbone-btn:hover { background: #1a6b5a; color: white; border-color: #1a6b5a; }

        /* Custom Cari Dropdown */
        .cari-dropdown { position: relative; }
        .cari-selected {
            border: 1px solid #d0b0e0; border-radius: 8px; padding: 7px 12px;
            background: white; cursor: pointer; font-size: 0.88em; color: #333;
            display: flex; justify-content: space-between; align-items: center;
            min-height: 36px; gap: 6px; user-select: none;
        }
        .cari-selected:hover { border-color: #b94fc4; }
        .cari-selected .cari-sel-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .cari-panel {
            position: absolute; top: calc(100% + 4px); left: 0; width: 440px;
            background: white; border: 1px solid #d0b0e0; border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden;
        }
        .cari-panel-header { padding: 8px 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 6px; }
        .cari-search-input {
            flex: 1; border: 1px solid #e0c0f0; border-radius: 6px; padding: 6px 10px;
            font-size: 0.85em; outline: none;
        }
        .cari-search-input:focus { border-color: #b94fc4; }
        .cari-legend { font-size: 0.72em; color: #888; white-space: nowrap; }
        .cari-list { max-height: 300px; overflow-y: auto; }
        .cari-list-item {
            display: flex; align-items: center; gap: 8px; padding: 7px 12px;
            cursor: pointer; font-size: 0.83em; color: #333; transition: background 0.12s;
        }
        .cari-list-item:hover { background: #fdf5ff; }
        .cari-list-item.selected { background: #f0e0ff; }
        .cari-list-item.selected .cari-item-name { font-weight: 700; color: #4a0a6b; }
        .cari-musteri-chk { width: 14px; height: 14px; accent-color: #e07000; cursor: pointer; flex-shrink: 0; }
        .cari-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cari-badge { font-size: 0.70em; background: #e07000; color: white; border-radius: 4px; padding: 1px 5px; flex-shrink: 0; }
        .cari-clear-btn { font-size: 0.75em; border: none; background: #f3e0ff; color: #7b2d8b; border-radius: 5px; padding: 2px 8px; cursor: pointer; white-space: nowrap; }

        /* Custom Tespit Yeri Multi-Select */
        .tespit-dropdown { position: relative; }
        .tespit-selected {
            border: 1px solid #d0b0e0; border-radius: 8px; padding: 7px 12px;
            background: white; cursor: pointer; font-size: 0.88em; color: #333;
            display: flex; justify-content: space-between; align-items: center;
            min-height: 36px; gap: 6px; user-select: none;
        }
        .tespit-selected:hover { border-color: #b94fc4; }
        .tespit-sel-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .tespit-panel {
            position: absolute; top: calc(100% + 4px); left: 0; min-width: 220px; width: max-content; max-width: 320px;
            background: white; border: 1px solid #d0b0e0; border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden;
        }
        .tespit-panel-header { padding: 6px 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .tespit-list { max-height: 260px; overflow-y: auto; }
        .tespit-list-item {
            display: flex; align-items: center; gap: 8px; padding: 7px 12px;
            cursor: pointer; font-size: 0.84em; color: #333; transition: background 0.12s;
        }
        .tespit-list-item:hover { background: #fdf5ff; }
        .tespit-list-item.ty-selected { background: #f0e0ff; font-weight: 600; color: #4a0a6b; }
        .tespit-chk { width: 15px; height: 15px; accent-color: #b94fc4; cursor: pointer; flex-shrink: 0; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
        }
        .empty-state .icon { font-size: 3em; margin-bottom: 12px; }
        .empty-state p { font-size: 1em; }

        /* Export btn */
        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            background: linear-gradient(135deg, #7b2d8b, #b94fc4);
            color: white;
        }
        .export-btn:hover { opacity: 0.9; }

        .section-title {
            font-size: 1em;
            font-weight: 700;
            color: #4a0a6b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .loading-overlay.show { display: flex; }
        .loading-box {
            background: white;
            border-radius: 16px;
            padding: 36px 48px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .spinner {
            width: 48px; height: 48px;
            border: 5px solid #f0d9ff;
            border-top-color: #b94fc4;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px; right: 24px;
            background: #4a0a6b;
            color: white;
            padding: 14px 22px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
            transform: translateY(80px);
            opacity: 0;
            transition: all 0.35s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: #b71c1c; }
        .toast.success { background: #2d5a3d; }

        /* ‚îÄ‚îÄ Snapshot Modal ‚îÄ‚îÄ */
        #uaSnapModal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(10,15,30,.55); align-items:center; justify-content:center; }
        #uaSnapModal.open { display:flex; }

        /* ‚îÄ‚îÄ Filter Save Modal ‚îÄ‚îÄ */
        #uaFiltreModal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(10,15,30,.55); align-items:center; justify-content:center; }
        #uaFiltreModal.open { display:flex; }
        #uaFiltreBox { background:#fff; border-radius:14px; padding:28px 28px 20px; width:min(620px,96vw); max-height:82vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.25); font-family:inherit; }
        #uaFiltreBox h3 { margin:0 0 18px; font-size:1rem; color:#1e2535; }
        .filtre-save-row { display:flex; align-items:center; gap:12px; padding:11px 0; border-bottom:1px solid #f1f5f9; }
        .filtre-save-row:last-child { border-bottom:none; }
        .filtre-save-info { flex:1; }
        .filtre-save-name { font-size:.88rem; font-weight:700; color:#1e2535; margin-bottom:3px; }
        .filtre-save-meta { font-size:.73rem; color:#94a3b8; }
        .filtre-save-btns { display:flex; gap:6px; flex-shrink:0; }
        .btn-filtre-kaydet  { background:linear-gradient(135deg,#059669,#10b981); color:#fff; border:none; border-radius:7px; padding:6px 13px; cursor:pointer; font-size:.75rem; font-weight:700; }
        .btn-filtre-listele { background:linear-gradient(135deg,#0369a1,#0ea5e9); color:#fff; border:none; border-radius:7px; padding:6px 13px; cursor:pointer; font-size:.75rem; font-weight:700; }
        #uaSnapBox { background:#fff; border-radius:14px; padding:28px 28px 20px; width:min(640px,96vw); max-height:82vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.25); font-family:inherit; }
        #uaSnapBox h3 { margin:0 0 18px; font-size:1rem; color:#1e2535; }
        .ua-snap-row { display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid #f1f5f9; }
        .ua-snap-row:last-child { border-bottom:none; }
        .ua-snap-info { flex:1; }
        .ua-snap-name { font-size:.88rem; font-weight:700; color:#1e2535; margin-bottom:3px; }
        .ua-snap-meta { font-size:.73rem; color:#94a3b8; }
        .ua-snap-btns { display:flex; gap:6px; flex-shrink:0; }
        .ua-snap-btn  { border:none; border-radius:6px; padding:5px 11px; cursor:pointer; font-size:.75rem; font-weight:600; line-height:1; }
        .ua-snap-load { background:#dbeafe; color:#1e40af; }
        .ua-snap-del  { background:#fee2e2; color:#b91c1c; }

        @media(max-width: 700px) {
            .header { padding: 16px 18px; }
            .header h1 { font-size: 1.3em; }
            .container { padding: 14px 10px; }
        }

        /* ‚îÄ‚îÄ RADAR TAB ‚îÄ‚îÄ */
        .radar-header { margin-bottom:14px; }
        .radar-controls {
            display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;
            padding:14px 16px; background:#faf5ff; border-radius:10px;
            border:1px solid #e9d5ff;
        }
        .radar-ctrl-group { display:flex; flex-direction:column; gap:4px; }
        .radar-ctrl-group label { font-size:.75rem; font-weight:600; color:#6b21a8; }
        .radar-ctrl-group select {
            padding:6px 10px; border:1.5px solid #d8b4fe; border-radius:7px;
            font-size:.84rem; background:#fff; outline:none; color:#3b0764;
        }
        .radar-ctrl-group select:focus { border-color:#a855f7; }
        .radar-selector-panel {
            width:260px; flex-shrink:0; border:1.5px solid #e9d5ff;
            border-radius:12px; background:#fff; overflow:hidden;
            box-shadow:0 2px 8px rgba(168,85,247,.08);
        }
        .radar-sel-title {
            display:flex; align-items:center; justify-content:space-between;
            padding:10px 14px; background:#f5f0ff;
            border-bottom:1px solid #e9d5ff; font-size:.82rem; font-weight:700; color:#4a0a6b;
        }
        .radar-sel-title small { font-size:.7rem; color:#a78bfa; font-weight:400; }
        .radar-group-list { max-height:320px; overflow-y:auto; padding:6px 0; }
        .radar-group-item {
            display:flex; align-items:center; gap:9px; padding:7px 14px;
            cursor:pointer; font-size:.82rem; color:#333; transition:background .12s;
        }
        .radar-group-item:hover { background:#fdf4ff; }
        .radar-group-item.rgi-selected { background:#f3e8ff; }
        .radar-group-item input[type=checkbox] { width:15px; height:15px; accent-color:#a855f7; flex-shrink:0; }
        .radar-group-item .rgi-label { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .radar-group-item .rgi-val { font-size:.73rem; color:#94a3b8; flex-shrink:0; }
        .radar-group-item.rgi-selected .rgi-label { font-weight:700; color:#6b21a8; }
        .radar-sel-btn {
            padding:5px 12px; border:1.5px solid #d8b4fe; border-radius:6px;
            background:#fff; color:#7c3aed; font-size:.75rem; font-weight:600;
            cursor:pointer; transition:all .15s;
        }
        .radar-sel-btn:hover { background:#ede9fe; }
        .radar-sel-btn-clear { border-color:#fca5a5; color:#dc2626; }
        .radar-sel-btn-clear:hover { background:#fee2e2; }
        .radar-chart-wrap { position:relative; width:100%; height:480px; }
        .radar-color-dot {
            width:12px; height:12px; border-radius:50%; flex-shrink:0;
        }

        /* ‚îÄ‚îÄ HEATMAP TAB ‚îÄ‚îÄ */
        .hm-controls {
            display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;
            padding:14px 16px; background:#f0f8ff; border-radius:10px;
            border:1px solid #bae6fd;
        }
        .hm-ctrl-group { display:flex; flex-direction:column; gap:4px; }
        .hm-ctrl-group label { font-size:.75rem; font-weight:600; color:#0369a1; }
        .hm-ctrl-group select {
            padding:6px 10px; border:1.5px solid #7dd3fc; border-radius:7px;
            font-size:.84rem; background:#fff; outline:none; color:#0c4a6e;
        }
        .hm-ctrl-group select:focus { border-color:#0ea5e9; }
        .hm-legend-row {
            display:flex; align-items:center; gap:10px; margin-top:14px;
        }
        .hm-legend-bar {
            flex:1; max-width:220px; height:12px; border-radius:6px;
        }
        .hm-legend-max { font-size:.72rem; color:#64748b; }
        /* The actual heatmap table */
        .hm-table { border-collapse:collapse; font-size:.75rem; }
        .hm-table th {
            padding:6px 10px; white-space:nowrap; max-width:160px;
            overflow:hidden; text-overflow:ellipsis;
            background:#f8fafc; position:sticky; top:0; z-index:2;
            font-weight:700; color:#334155; border:1px solid #e2e8f0;
        }
        .hm-table th.hm-row-hdr {
            left:0; z-index:3; text-align:left; min-width:130px; max-width:200px;
        }
        .hm-table td {
            padding:5px 8px; border:1px solid #e2e8f0; text-align:center;
            white-space:nowrap; transition:opacity .15s; cursor:default;
            min-width:56px;
        }
        .hm-table td:first-child {
            position:sticky; left:0; z-index:1; background:#f8fafc !important;
            font-weight:700; color:#334155; text-align:left; max-width:200px;
            overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
        }
        .hm-table td:hover, .hm-table tr:hover td { filter:brightness(.9); }
        .hm-cell-val { font-size:.72rem; font-weight:700; }
        .hm-total-row td { background:#f1f5f9 !important; font-weight:700; color:#334155; }
        .hm-total-col { background:#f1f5f9 !important; font-weight:700; color:#334155; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <h1>üîç Uygunsuzluk Analizi</h1>
        <p>Pareto Analizi ¬∑ Hata Tipi Daƒüƒ±lƒ±mƒ±</p>
    </div>
    <div class="page-nav">
        <a href="index.html"              class="back-btn">üè† Ana Sayfa</a>
        <a href="coa-arsiv.html"          class="back-btn">üìÑ COA</a>
        <a href="balik-kilcigi.html"      class="back-btn">üêü Balƒ±k Kƒ±l√ßƒ±ƒüƒ±</a>
        <a href="8d-rapor.html"        class="back-btn">üìã 8D</a>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
        <div class="spinner"></div>
        <p style="color:#4a0a6b;font-weight:700;">Excel Y√ºkleniyor...</p>
    </div>
</div>

<div class="toast" id="toast"></div>

<div class="container">

    <!-- Upload -->
    <div class="upload-card">
        <h2>üìÇ Excel Dosyasƒ± Y√ºkle</h2>
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div class="icon">üìä</div>
            <p><strong>Excel dosyanƒ±zƒ± s√ºr√ºkleyip bƒ±rakƒ±n veya tƒ±klayƒ±n</strong></p>
            <p class="hint">Desteklenen formatlar: .xlsx, .xls</p>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.xls">
        <div id="fileInfo" style="margin-top:12px;font-size:0.88em;color:#555;display:none;"></div>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="statsRow" style="display:none;">
        <div class="stat-card">
            <div class="val" id="statTotal">0</div>
            <div class="lbl">Toplam Kayƒ±t</div>
        </div>
        <div class="stat-card" style="border-top-color:#e65100;">
            <div class="val" id="statHataliMiktar">0</div>
            <div class="lbl">Toplam Hatalƒ± Miktar</div>
        </div>
        <div class="stat-card" style="border-top-color:#0d47a1;">
            <div class="val" id="statHataTipi">0</div>
            <div class="lbl">Farklƒ± Hata Tipi</div>
        </div>
        <div class="stat-card" style="border-top-color:#2d5a3d;">
            <div class="val" id="statCari">0</div>
            <div class="lbl">Farklƒ± Tedarik√ßi</div>
        </div>
        <div class="stat-card" style="border-top-color:#b71c1c;">
            <div class="val" id="statPPM">0</div>
            <div class="lbl">PPM (Hatalƒ±/Parti Hacmi)</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card" id="filterCard" style="display:none;">
        <h2>üîé Filtreler</h2>
        <div class="filter-grid">
            <div class="filter-group">
                <label>Tarih Ba≈ülangƒ±√ß</label>
                <input type="date" id="fDateStart">
            </div>
            <div class="filter-group">
                <label>Tarih Biti≈ü</label>
                <input type="date" id="fDateEnd">
            </div>
            <div class="filter-group">
                <label>Tipi</label>
                <select id="fTipi"><option value="">T√ºm√º</option></select>
            </div>
            <div class="filter-group">
                <label>Hata Tipi</label>
                <select id="fHataTipi"><option value="">T√ºm√º</option></select>
            </div>
            <div class="filter-group">
                <label>Hata Kaynaƒüƒ±</label>
                <select id="fHataKaynagi"><option value="">T√ºm√º</option></select>
            </div>
            <div class="filter-group">
                <label>Uygunsuzluk T√ºr√º</label>
                <select id="fUygunsuzlukTuru"><option value="">T√ºm√º</option></select>
            </div>
            <div class="filter-group" style="position:relative;">
                <label>Tespit Yeri</label>
                <div class="tespit-dropdown" id="tespitDropdown">
                    <div class="tespit-selected" onclick="toggleTespitDropdown()">
                        <span class="tespit-sel-text" id="tespitSelectedText">T√ºm√º</span>
                        <span style="color:#b94fc4;font-size:0.85em;">&#9660;</span>
                    </div>
                    <div class="tespit-panel" id="tespitPanel" style="display:none;">
                        <div class="tespit-panel-header">
                            <span style="font-size:0.78em;color:#888;">√áoklu se√ßim yapƒ±labilir</span>
                            <button onclick="resetTespitYeri()" style="font-size:0.75em;border:none;background:#f3e0ff;color:#7b2d8b;border-radius:5px;padding:2px 8px;cursor:pointer;">Temizle</button>
                        </div>
                        <div class="tespit-list" id="tespitList"></div>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label>Makine</label>
                <select id="fMakine"><option value="">T√ºm√º</option></select>
            </div>
            <div class="filter-group">
                <label>Cari Tipi</label>
                <select id="fCariTip">
                    <option value="">T√ºm√º</option>
                    <option value="musteri">‚òÖ M√º≈üteri</option>
                    <option value="tedarikci">Tedarik√ßi</option>
                </select>
            </div>
            <div class="filter-group" style="position:relative;">
                <label>Cari (Tedarik√ßi / M√º≈üteri)</label>
                <div class="cari-dropdown" id="cariDropdown">
                    <div class="cari-selected" onclick="toggleCariDropdown()">
                        <span class="cari-sel-text" id="cariSelectedText">T√ºm√º</span>
                        <span style="color:#b94fc4;font-size:0.85em;">&#9660;</span>
                    </div>
                    <div class="cari-panel" id="cariPanel" style="display:none;">
                        <div class="cari-panel-header">
                            <input class="cari-search-input" id="cariSearch" placeholder="üîç Cari ara..." oninput="filterCariList()" autocomplete="off">
                            <span class="cari-legend">‚òÖ = M√º≈üteri</span>
                            <button class="cari-clear-btn" onclick="selectCari('')">Temizle</button>
                        </div>
                        <div class="cari-list" id="cariList"></div>
                    </div>
                </div>
                <button id="cariAnalyzeBtn" class="cari-fishbone-btn" onclick="openFishboneTedarikci()">üêü Bu Tedarik√ßiyi Analiz Et</button>
            </div>
            <div class="filter-group">
                <label>Stok Kodu</label>
                <select id="fStokKodu"><option value="">T√ºm√º</option></select>
            </div>
            <div class="filter-group" style="flex-direction: row; gap: 8px; align-items: flex-end; flex-wrap:wrap;">
                <button class="filter-btn btn-apply" onclick="applyFilters()">‚úî Uygula</button>
                <button class="filter-btn btn-reset" onclick="resetFilters()">‚Ü∫ Sƒ±fƒ±rla</button>
                <button class="btn-filtre-kaydet" onclick="saveCurrentFilter()" title="Mevcut filtreyi kaydet">üíæ Filtreyi Kaydet</button>
                <button class="btn-filtre-listele" onclick="openSavedFiltersModal()" title="Kayƒ±tlƒ± filtreleri listele">üìÇ Kayƒ±tlƒ± Filtreler</button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div id="mainContent" style="display:none;">
        <div class="tabs" style="flex-wrap:wrap;gap:4px;">
            <button class="tab-btn active" onclick="switchTab('pareto')">üìä Pareto Analizi</button>
            <button class="tab-btn" onclick="switchTab('breakdown')">üìã Hata Tipi Daƒüƒ±lƒ±mƒ±</button>
            <button class="tab-btn" onclick="switchTab('table')">üìÑ Veri Tablosu</button>
            <button class="tab-btn" onclick="switchTab('radar')">üï∑Ô∏è Radar Analizi</button>
            <button class="tab-btn" onclick="switchTab('heatmap')">üå°Ô∏è Isƒ± Haritasƒ±</button>
            <button class="tab-btn" onclick="openKapsamliRapor()" style="margin-left:auto;background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#fff;font-weight:700;border:none;" title="Filtrelenmi≈ü veriyi kapsamlƒ± rapora ekler (birikimli)">üìë Kapsamlƒ± Rapora Ekle</button>
            <button class="tab-btn" onclick="temizleKapsamliRapor()" style="background:linear-gradient(135deg,#7f1d1d,#dc2626);color:#fff;font-weight:700;border:none;" title="Birikmi≈ü rapor verisini sil ve yeniden ba≈üla">üóë Raporu Sƒ±fƒ±rla</button>
            <button class="tab-btn" onclick="uaOpenSnapshotModal()" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;font-weight:700;border:none;" title="Kayƒ±tlƒ± kapsamlƒ± raporlarƒ± listele">üìÅ Kayƒ±tlƒ± Raporlar</button>
        </div>

        <!-- Pareto Tab -->
        <div class="tab-panel active" id="tab-pareto">
            <div class="pareto-options">
                <div>
                    <label>Analiz Kriteri: </label>
                    <select id="paretoMetric" onchange="renderPareto()">
                        <option value="hataliMiktar">Hatalƒ± Miktar</option>
                        <option value="kayitSayisi">Kayƒ±t Sayƒ±sƒ±</option>
                    </select>
                </div>
                <div>
                    <label>G√∂ster (Top): </label>
                    <select id="paretoTop" onchange="renderPareto()">
                        <option value="10">ƒ∞lk 10</option>
                        <option value="15" selected>ƒ∞lk 15</option>
                        <option value="20">ƒ∞lk 20</option>
                        <option value="999">T√ºm√º</option>
                    </select>
                </div>
                <div>
                    <label>E≈üik: </label>
                    <select id="paretoThreshold" onchange="renderPareto()">
                        <option value="60">60/40</option>
                        <option value="70">70/30</option>
                        <option value="80" selected>80/20</option>
                        <option value="90">90/10</option>
                    </select>
                </div>
                <div>
                    <label>Grupla: </label>
                    <select id="paretoGroup" onchange="renderPareto()">
                        <option value="hataTipi">Hata Tipi</option>
                        <option value="hataKaynagi">Hata Kaynaƒüƒ±</option>
                        <option value="uygunsuzlukTuru">Uygunsuzluk T√ºr√º</option>
                        <option value="tespitYeri">Tespit Yeri</option>
                        <option value="cariAdi">Cari Adƒ±</option>
                        <option value="stokAdi">Stok Adƒ±</option>
                    </select>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="paretoGroupOthers" onchange="renderPareto()" style="width:16px;height:16px;accent-color:#b94fc4;cursor:pointer;">
                    <label for="paretoGroupOthers" style="cursor:pointer;font-size:0.88em;color:#4a0a6b;white-space:nowrap;">E≈üik√ºst√º 'Diƒüer'</label>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="paretoShowLabels" onchange="renderPareto()" style="width:16px;height:16px;accent-color:#b94fc4;cursor:pointer;">
                    <label for="paretoShowLabels" style="cursor:pointer;font-size:0.88em;color:#4a0a6b;white-space:nowrap;">Deƒüerleri G√∂ster</label>
                </div>
                <div style="display:flex;align-items:center;gap:6px;position:relative;">
                    <label style="font-size:0.88em;color:#4a0a6b;white-space:nowrap;">Renk:</label>
                    <select id="paretoColorScheme" onchange="onParetoColorSchemeChange()" style="font-size:0.82em;border:1px solid #d0b0e0;border-radius:6px;padding:3px 6px;color:#4a0a6b;cursor:pointer;">
                        <option value="default">Mor Gradient</option>
                        <option value="blue">Mavi Gradient</option>
                        <option value="green">Ye≈üil Gradient</option>
                        <option value="orange">Turuncu Gradient</option>
                        <option value="red">Kƒ±rmƒ±zƒ± Gradient</option>
                        <option value="rainbow">G√∂kkua≈üaƒüƒ±</option>
                        <option value="custom">√ñzel Renk...</option>
                    </select>
                    <div id="paretoCustomColors" style="display:none;align-items:center;gap:4px;">
                        <input type="color" id="paretoColor1" value="#b94fc4" title="Ba≈ülangƒ±√ß rengi" onchange="renderPareto()" style="width:28px;height:28px;border:none;padding:0;cursor:pointer;border-radius:4px;">
                        <span style="font-size:0.8em;color:#888;">&#8594;</span>
                        <input type="color" id="paretoColor2" value="#3b82f6" title="Biti≈ü rengi" onchange="renderPareto()" style="width:28px;height:28px;border:none;padding:0;cursor:pointer;border-radius:4px;">
                    </div>
                </div>
                <button class="export-btn" onclick="downloadChartPNG()">‚¨á PNG ƒ∞ndir</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="paretoChart"></canvas>
            </div>
            <div id="paretoInsight" style="margin-top:14px;padding:12px 16px;background:#fdf5ff;border-radius:10px;font-size:0.85em;color:#4a0a6b;border-left:4px solid #b94fc4;"></div>
        </div>

        <!-- Breakdown Tab -->
        <div class="tab-panel" id="tab-breakdown">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div class="section-title" style="margin-bottom:0;">üìã Hata Tipi Bazƒ±nda Hatalƒ± Miktar Daƒüƒ±lƒ±mƒ±</div>
                <button id="multiAnalyzeToggleBtn" onclick="toggleMultiAnalyze()" style="background:#e8f5f1;color:#1a6b5a;border:1px solid #a8d8cc;border-radius:8px;padding:6px 14px;font-size:0.82em;font-weight:600;cursor:pointer;">üìä √áoklu Analiz</button>
            </div>
            <div class="breakdown-grid" id="breakdownGrid"></div>
        </div>

        <!-- Table Tab -->
        <div class="tab-panel" id="tab-table">
            <div class="table-controls">
                <input type="text" class="table-search" id="tableSearch" placeholder="üîç Tabloda ara..." oninput="onTableSearch()">
                <div style="display:flex;gap:8px;align-items:center;">
                    <span class="table-info" id="tableInfo"></span>
                    <button class="export-btn" onclick="exportTableExcel()">‚¨á Excel ƒ∞ndir</button>
                </div>
            </div>
            <div class="table-wrap">
                <table id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <!-- Radar Tab -->
        <div class="tab-panel" id="tab-radar">
            <div class="radar-header">
                <div style="font-size:1.05rem;font-weight:800;color:#4a0a6b;display:flex;align-items:center;gap:8px;">
                    üï∑Ô∏è Radar / √ñr√ºmcek Kar≈üƒ±la≈ütƒ±rma Analizi
                    <span style="font-size:.75rem;font-weight:400;color:#888;background:#f3e8ff;padding:2px 10px;border-radius:20px;">Her eksen bir boyutu, her √ßizgi bir grubu temsil eder</span>
                </div>
            </div>
            <div class="radar-controls">
                <div class="radar-ctrl-group">
                    <label>Kar≈üƒ±la≈ütƒ±rma Kriteri</label>
                    <select id="radarGroupBy" onchange="radarBuildSelector()">
                        <option value="cariAdi">Cari Adƒ± (Tedarik√ßi/M√º≈üteri)</option>
                        <option value="hataTipi">Hata Tipi</option>
                        <option value="hataKaynagi">Hata Kaynaƒüƒ±</option>
                        <option value="tespitYeri">Tespit Yeri</option>
                        <option value="stokAdi">Stok Adƒ±</option>
                    </select>
                </div>
                <div class="radar-ctrl-group">
                    <label>Eksen Boyutu</label>
                    <select id="radarAxesBy" onchange="radarBuildSelector()">
                        <option value="hataTipi">Hata Tipi</option>
                        <option value="hataKaynagi">Hata Kaynaƒüƒ±</option>
                        <option value="tespitYeri">Tespit Yeri</option>
                        <option value="stokAdi">Stok Adƒ±</option>
                        <option value="uygunsuzlukTuru">Uygunsuzluk T√ºr√º</option>
                    </select>
                </div>
                <div class="radar-ctrl-group">
                    <label>Metrik</label>
                    <select id="radarMetric" onchange="renderRadar()">
                        <option value="hataliMiktar">Hatalƒ± Miktar</option>
                        <option value="kayitSayisi">Kayƒ±t Sayƒ±sƒ±</option>
                    </select>
                </div>
                <div class="radar-ctrl-group">
                    <label>Max Eksen (Top)</label>
                    <select id="radarAxesTop" onchange="radarBuildSelector()">
                        <option value="5">5</option>
                        <option value="7" selected>7</option>
                        <option value="10">10</option>
                        <option value="12">12</option>
                    </select>
                </div>
                <div class="radar-ctrl-group">
                    <label>Normalize</label>
                    <select id="radarNorm" onchange="renderRadar()">
                        <option value="1">Evet ‚Äî 0 ile 100 arasƒ±</option>
                        <option value="0">Hayƒ±r ‚Äî Ger√ßek Deƒüer</option>
                    </select>
                </div>
                <button class="export-btn" onclick="downloadRadarPNG()">‚¨á PNG ƒ∞ndir</button>
            </div>

            <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:18px;">
                <!-- Group selector panel -->
                <div class="radar-selector-panel">
                    <div class="radar-sel-title">
                        <span>üìã Kar≈üƒ±la≈ütƒ±rƒ±lacak Gruplar</span>
                        <small id="radarSelHint">Se√ßilecek: 2‚Äì10</small>
                    </div>
                    <div id="radarGroupList" class="radar-group-list"></div>
                    <div style="padding:8px 12px;border-top:1px solid #f1f5f9;display:flex;gap:8px;">
                        <button class="radar-sel-btn" onclick="radarSelectAll()">T√ºm√º</button>
                        <button class="radar-sel-btn" onclick="radarSelectTop5()">Top 5</button>
                        <button class="radar-sel-btn radar-sel-btn-clear" onclick="radarClearAll()">Temizle</button>
                    </div>
                </div>

                <!-- Chart area -->
                <div style="flex:1;min-width:300px;">
                    <div id="radarNoData" style="display:none;text-align:center;padding:60px 20px;color:#aaa;">
                        <div style="font-size:2.5em;margin-bottom:12px;">üï∑Ô∏è</div>
                        <p>En az 2 grup ve en az 2 eksen deƒüeri se√ßin.</p>
                    </div>
                    <div class="radar-chart-wrap" id="radarChartWrap">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="radarInsight" style="margin-top:16px;padding:12px 16px;background:#fdf5ff;border-radius:10px;font-size:0.83em;color:#4a0a6b;border-left:4px solid #b94fc4;display:none;"></div>
        </div>

        <!-- Heatmap Tab -->
        <div class="tab-panel" id="tab-heatmap">
            <div style="font-size:1.05rem;font-weight:800;color:#0f4c81;display:flex;align-items:center;gap:8px;margin-bottom:14px;">
                üå°Ô∏è Isƒ± Haritasƒ±
                <span style="font-size:.75rem;font-weight:400;color:#888;background:#e0f0ff;padding:2px 10px;border-radius:20px;">Satƒ±r √ó S√ºtun kesi≈üimindeki yoƒüunluƒüu renk ile g√∂sterir</span>
            </div>
            <div class="hm-controls">
                <div class="hm-ctrl-group">
                    <label>Satƒ±r (Y ekseni)</label>
                    <select id="hmRowBy" onchange="renderHeatmap()">
                        <option value="cariAdi">Cari Adƒ±</option>
                        <option value="hataTipi">Hata Tipi</option>
                        <option value="hataKaynagi">Hata Kaynaƒüƒ±</option>
                        <option value="tespitYeri">Tespit Yeri</option>
                        <option value="stokAdi">Stok Adƒ±</option>
                        <option value="uygunsuzlukTuru">Uyg. T√ºr√º</option>
                    </select>
                </div>
                <div class="hm-ctrl-group">
                    <label>S√ºtun (X ekseni)</label>
                    <select id="hmColBy" onchange="renderHeatmap()">
                        <option value="hataTipi">Hata Tipi</option>
                        <option value="hataKaynagi">Hata Kaynaƒüƒ±</option>
                        <option value="tespitYeri">Tespit Yeri</option>
                        <option value="cariAdi">Cari Adƒ±</option>
                        <option value="stokAdi">Stok Adƒ±</option>
                        <option value="uygunsuzlukTuru">Uyg. T√ºr√º</option>
                    </select>
                </div>
                <div class="hm-ctrl-group">
                    <label>Metrik</label>
                    <select id="hmMetric" onchange="renderHeatmap()">
                        <option value="hataliMiktar">Hatalƒ± Miktar</option>
                        <option value="kayitSayisi">Kayƒ±t Sayƒ±sƒ±</option>
                    </select>
                </div>
                <div class="hm-ctrl-group">
                    <label>Top Satƒ±r</label>
                    <select id="hmTopRow" onchange="renderHeatmap()">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div class="hm-ctrl-group">
                    <label>Top S√ºtun</label>
                    <select id="hmTopCol" onchange="renderHeatmap()">
                        <option value="8">8</option>
                        <option value="12" selected>12</option>
                        <option value="16">16</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="hm-ctrl-group">
                    <label>Renk Skalasƒ±</label>
                    <select id="hmColorScale" onchange="renderHeatmap()">
                        <option value="blue">Mavi (soƒüuk‚Üísƒ±cak)</option>
                        <option value="red">Kƒ±rmƒ±zƒ±</option>
                        <option value="green">Ye≈üil</option>
                        <option value="purple">Mor</option>
                        <option value="orange">Turuncu</option>
                    </select>
                </div>
                <div class="hm-ctrl-group">
                    <label>Deƒüer G√∂ster</label>
                    <select id="hmShowVal" onchange="renderHeatmap()">
                        <option value="1">Evet</option>
                        <option value="0">Hayƒ±r</option>
                    </select>
                </div>
            </div>

            <div class="hm-legend-row" id="hmLegendRow">
                <span style="font-size:.73rem;color:#64748b;">D√º≈ü√ºk</span>
                <div class="hm-legend-bar" id="hmLegendBar"></div>
                <span style="font-size:.73rem;color:#64748b;">Y√ºksek</span>
                <span class="hm-legend-max" id="hmLegendMax"></span>
            </div>

            <div style="overflow:auto;margin-top:12px;">
                <div id="hmTableWrap"></div>
            </div>
            <div id="hmInsight" style="margin-top:14px;padding:12px 16px;background:#e0f0ff;border-radius:10px;font-size:0.83em;color:#0f4c81;border-left:4px solid #2196f3;display:none;"></div>
        </div>
    </div>

    <!-- Empty state -->
    <div class="empty-state" id="emptyState">
        <div class="icon">üì•</div>
        <p>Hen√ºz dosya y√ºklenmedi. Yukarƒ±dan bir Excel dosyasƒ± se√ßin.</p>
    </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allData = [];         // raw parsed rows
let filteredData = [];    // after filters
let tableSearchData = []; // after table search
let currentPage = 1;
const PAGE_SIZE = 50;
let sortCol = -1;
let sortAsc = true;
let paretoChartInst = null;
let radarChartInst  = null;
let _radarSelected  = new Set();
let excludedHataTipleri = new Set(); // breakdown'dan dƒ±≈ülananlar
let selectedCari = '';            // custom cari dropdown se√ßili deƒüer
let musteriSet = new Set();       // m√º≈üteri olarak i≈üaretlenmi≈ü cariler
let _cariAllList = [];            // cari dropdown listesi
let selectedTespitYeriSet = new Set(); // tespit yeri √ßoklu se√ßim
let _tespitYeriAllList = [];      // tespit yeri dropdown listesi
let multiAnalyzeMode = false;    // √ßoklu analiz modu
let selectedForMulti = new Set(); // √ßoklu analiz se√ßilenleri

// Column map: internal key ‚Üí possible Excel header variants (case-insensitive)
const COL_MAP = {
    uygunsuzlukSeri:    ['uygunsuzluk seri', 'uyg seri', 'seri'],
    uygunsuzlukSira:    ['uygunsuzluk sira', 'uyg sira', 'sƒ±ra', 'sira'],
    uygunsuzlukTarih:   ['uygunsuzluk tarih', 'tarih', 'date'],
    tipi:               ['tipi', 'tip'],
    tespitYeri:         ['tespit yeri', 'tespityeri'],
    makine:             ['makine'],
    stokKodu:           ['stok kodu', 'stokkodu', 'stok_kodu'],
    stokAdi:            ['stok adƒ±', 'stok adi', 'stokadi', 'stok_adi'],
    yarimamulKodu:      ['yarimamul kodu', 'yarƒ± mamul kodu', 'yarimamulkodu'],
    yarimamulAdi:       ['yarimamul adi', 'yarƒ± mamul adƒ±', 'yarimamuladi'],
    cariKodu:           ['cari kodu', 'carikodu', 'cari_kodu'],
    cariAdi:            ['cari adƒ±', 'cari adi', 'cariadi', 'cari_adi'],
    partiHacmi:         ['parti hacmi', 'partihacmi'],
    kontrolMiktar:      ['kontrol miktar', 'kontrol miktarƒ±', 'kontrolmiktar'],
    hataliMiktar:       ['hatali miktar', 'hatalƒ± miktar', 'hatalimiktar', 'hata miktar'],
    birim:              ['birim'],
    uygunsuzlukTuru:    ['uygunsuzluk turu', 'uygunsuzluk t√ºr√º', 'uygunsuzlukturu'],
    hataTipi:           ['hata tipi', 'hatatp', 'hata_tipi'],
    hataKaynagi:        ['hata kaynagi', 'hata kaynaƒüƒ±', 'hatakaynagi'],
    tarif:              ['tarif'],
    karar:              ['karar'],
    kapatmaTarihi:      ['kapatma tarihi', 'kapatmatarihi'],
    sonuc:              ['sonu√ß', 'sonuc'],
    stokHarSeri:        ['stok hareketi seri', 'stokhar seri'],
    stokHarSira:        ['stok hareketi sƒ±ra', 'stok hareketi sira', 'stokhar sira'],
    isEmriKodu:         ['i≈ü emri kodu', 'is emri kodu', 'isemrikodu'],
    uretimKaydi:        ['√ºretim kaydƒ±', 'uretim kaydi', '√ºretimkaydƒ±'],
};

const COL_LABELS = {
    uygunsuzlukSeri: 'Uyg. Seri',
    uygunsuzlukSira: 'Uyg. Sƒ±ra',
    uygunsuzlukTarih: 'Tarih',
    tipi: 'Tipi',
    tespitYeri: 'Tespit Yeri',
    makine: 'Makine',
    stokKodu: 'Stok Kodu',
    stokAdi: 'Stok Adƒ±',
    yarimamulKodu: 'Yarƒ±mamul Kodu',
    yarimamulAdi: 'Yarƒ±mamul Adƒ±',
    cariKodu: 'Cari Kodu',
    cariAdi: 'Cari Adƒ±',
    partiHacmi: 'Parti Hacmi',
    kontrolMiktar: 'Kontrol Miktar',
    hataliMiktar: 'Hatalƒ± Miktar',
    birim: 'Birim',
    uygunsuzlukTuru: 'Uyg. T√ºr√º',
    hataTipi: 'Hata Tipi',
    hataKaynagi: 'Hata Kaynaƒüƒ±',
    tarif: 'Tarif',
    karar: 'Karar',
    kapatmaTarihi: 'Kapatma Tarihi',
    sonuc: 'Sonu√ß',
    stokHarSeri: 'Stok Har. Seri',
    stokHarSira: 'Stok Har. Sƒ±ra',
    isEmriKodu: 'ƒ∞≈ü Emri Kodu',
    uretimKaydi: '√úretim Kaydƒ±',
};

const TABLE_COLS = Object.keys(COL_MAP);

// ‚îÄ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) processFile(file);
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) processFile(e.target.files[0]); });

// ‚îÄ‚îÄ‚îÄ File Processing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function processFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
        showToast('L√ºtfen .xlsx veya .xls dosyasƒ± se√ßin!', 'error'); return;
    }
    showLoading(true);
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(ws, { defval: '', raw: false });
            allData = mapColumns(raw);
            filteredData = [...allData];
            showFileInfo(file.name, wb.SheetNames[0], allData.length, false);
            saveToStorage(file.name, wb.SheetNames[0]);
            initUI();
            showLoading(false);
            showToast(`${allData.length} kayƒ±t ba≈üarƒ±yla y√ºklendi!`, 'success');
        } catch(err) {
            showLoading(false);
            showToast('Excel okuma hatasƒ±: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

function normalizeHeader(h) {
    return String(h).toLowerCase().trim()
        .replace(/[_\-]/g, ' ')
        .replace(/ƒü/g,'g').replace(/√º/g,'u').replace(/≈ü/g,'s')
        .replace(/ƒ±/g,'i').replace(/√∂/g,'o').replace(/√ß/g,'c');
}

function mapColumns(raw) {
    if (!raw.length) return [];
    const headers = Object.keys(raw[0]);
    // Build lookup: normalized header ‚Üí original key
    const normToOrig = {};
    headers.forEach(h => { normToOrig[normalizeHeader(h)] = h; });

    // For each internal key, find the matching column
    const keyMap = {};
    for (const [intKey, variants] of Object.entries(COL_MAP)) {
        for (const v of variants) {
            const norm = normalizeHeader(v);
            if (normToOrig[norm]) { keyMap[intKey] = normToOrig[norm]; break; }
        }
        // fuzzy: try contains
        if (!keyMap[intKey]) {
            for (const v of variants) {
                const norm = normalizeHeader(v);
                const found = Object.keys(normToOrig).find(h => h.includes(norm) || norm.includes(h));
                if (found) { keyMap[intKey] = normToOrig[found]; break; }
            }
        }
    }

    return raw.map(row => {
        const obj = {};
        for (const intKey of TABLE_COLS) {
            const origCol = keyMap[intKey];
            let val = origCol ? row[origCol] : '';
            if (val === null || val === undefined) val = '';
            // Parse numeric fields
            if (intKey === 'hataliMiktar' || intKey === 'kontrolMiktar' || intKey === 'partiHacmi') {
                const n = parseFloat(String(val).replace(',', '.'));
                val = isNaN(n) ? 0 : n;
            }
            obj[intKey] = val;
        }
        return obj;
    }).filter(r => r.hataTipi !== '' || r.uygunsuzlukSeri !== '' || r.stokKodu !== '');
}

// ‚îÄ‚îÄ‚îÄ Init UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initUI() {
    populateFilters();
    updateStats();
    renderPareto();
    renderBreakdown();
    renderTable();
    document.getElementById('statsRow').style.display = 'flex';
    document.getElementById('filterCard').style.display = 'block';
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
}

function populateFilters() {
    const selFields = {
        fTipi: 'tipi',
        fHataTipi: 'hataTipi',
        fHataKaynagi: 'hataKaynagi',
        fUygunsuzlukTuru: 'uygunsuzlukTuru',
        fMakine: 'makine',
        fStokKodu: 'stokKodu',
    };
    for (const [selId, field] of Object.entries(selFields)) {
        const sel = document.getElementById(selId);
        const current = sel.value;
        const vals = [...new Set(allData.map(r => r[field]).filter(v => v !== '' && v !== 0))].sort();
        sel.innerHTML = '<option value="">T√ºm√º</option>' + vals.map(v => `<option value="${v}">${v}</option>`).join('');
        if (vals.includes(current)) sel.value = current;
    }
    populateTespitYeriDropdown();
    populateCariDropdown();
    // Date range
    const dates = allData.map(r => r.uygunsuzlukTarih).filter(Boolean).sort();
    if (dates.length) {
        document.getElementById('fDateStart').value = '';
        document.getElementById('fDateEnd').value = '';
    }
}

// ‚îÄ‚îÄ‚îÄ Filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyFilters() {
    const tipi          = document.getElementById('fTipi').value;
    const hataTipi      = document.getElementById('fHataTipi').value;
    const hataKaynagi   = document.getElementById('fHataKaynagi').value;
    const uyTuru        = document.getElementById('fUygunsuzlukTuru').value;
    const makine        = document.getElementById('fMakine').value;
    const stokKodu      = document.getElementById('fStokKodu').value;
    const dateStart     = document.getElementById('fDateStart').value;
    const dateEnd       = document.getElementById('fDateEnd').value;
    const cariTip       = document.getElementById('fCariTip').value;

    filteredData = allData.filter(r => {
        if (tipi        && r.tipi        !== tipi)        return false;
        if (hataTipi    && r.hataTipi    !== hataTipi)    return false;
        if (hataKaynagi && r.hataKaynagi !== hataKaynagi) return false;
        if (uyTuru      && r.uygunsuzlukTuru !== uyTuru)  return false;
        if (selectedTespitYeriSet.size > 0 && !selectedTespitYeriSet.has(r.tespitYeri)) return false;
        if (makine      && r.makine      !== makine)       return false;
        if (selectedCari && r.cariAdi    !== selectedCari) return false;
        if (cariTip === 'musteri'   && !musteriSet.has(r.cariAdi)) return false;
        if (cariTip === 'tedarikci' &&  musteriSet.has(r.cariAdi)) return false;
        if (stokKodu    && r.stokKodu    !== stokKodu)    return false;
        if (dateStart || dateEnd) {
            const d = parseDateStr(r.uygunsuzlukTarih);
            if (dateStart && d && d < dateStart) return false;
            if (dateEnd   && d && d > dateEnd)   return false;
        }
        return true;
    });
    updateStats();
    renderPareto();
    renderBreakdown();
    currentPage = 1;
    renderTable();
    _radarSelected.clear();
    if (document.getElementById('tab-radar').classList.contains('active')) radarBuildSelector();
    if (document.getElementById('tab-heatmap').classList.contains('active')) renderHeatmap();
    showToast(`${filteredData.length} kayƒ±t filtrelendi`, 'success');
}

function resetFilters() {
    document.getElementById('fTipi').value = '';
    document.getElementById('fHataTipi').value = '';
    document.getElementById('fHataKaynagi').value = '';
    document.getElementById('fUygunsuzlukTuru').value = '';
    resetTespitYeri();
    document.getElementById('fMakine').value = '';
    document.getElementById('fCariTip').value = '';
    document.getElementById('fStokKodu').value = '';
    document.getElementById('fDateStart').value = '';
    document.getElementById('fDateEnd').value = '';
    selectCari('');
    filteredData = [...allData];
    updateStats();
    renderPareto();
    renderBreakdown();
    currentPage = 1;
    renderTable();
    _radarSelected.clear();
    if (document.getElementById('tab-radar').classList.contains('active')) radarBuildSelector();
    if (document.getElementById('tab-heatmap').classList.contains('active')) renderHeatmap();
    showToast('Filtreler sƒ±fƒ±rlandƒ±');
}

// ‚îÄ‚îÄ‚îÄ Custom Tespit Yeri Multi-Select ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateTespitYeriDropdown() {
    _tespitYeriAllList = [...new Set(allData.map(r => r.tespitYeri).filter(v => v !== '' && v !== undefined && v !== null))].sort();
    _buildTespitYeriItems();
}

function _buildTespitYeriItems() {
    const container = document.getElementById('tespitList');
    if (!container) return;
    container.innerHTML = '';
    if (!_tespitYeriAllList.length) {
        container.innerHTML = '<div style="padding:10px 12px;color:#aaa;font-size:0.83em;">Veri yok</div>';
        return;
    }
    _tespitYeriAllList.forEach(val => {
        const isSelected = selectedTespitYeriSet.has(val);
        const row = document.createElement('div');
        row.className = 'tespit-list-item' + (isSelected ? ' ty-selected' : '');
        row.onclick = () => toggleTespitYeriItem(val);

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'tespit-chk';
        chk.checked = isSelected;
        chk.addEventListener('click', e => e.stopPropagation());
        chk.addEventListener('change', () => toggleTespitYeriItem(val));

        const lbl = document.createElement('span');
        lbl.style.flex = '1';
        lbl.textContent = val;

        row.appendChild(chk);
        row.appendChild(lbl);
        container.appendChild(row);
    });
}

function toggleTespitYeriItem(val) {
    if (selectedTespitYeriSet.has(val)) selectedTespitYeriSet.delete(val);
    else selectedTespitYeriSet.add(val);
    _updateTespitYeriLabel();
    _buildTespitYeriItems();
}

function _updateTespitYeriLabel() {
    const el = document.getElementById('tespitSelectedText');
    if (!el) return;
    if (selectedTespitYeriSet.size === 0) {
        el.textContent = 'T√ºm√º';
    } else if (selectedTespitYeriSet.size === 1) {
        el.textContent = [...selectedTespitYeriSet][0];
    } else {
        el.textContent = `${selectedTespitYeriSet.size} se√ßili`;
    }
}

function toggleTespitDropdown() {
    const panel = document.getElementById('tespitPanel');
    if (!panel) return;
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    if (panel.style.display === 'block') _buildTespitYeriItems();
}

function resetTespitYeri() {
    selectedTespitYeriSet.clear();
    _updateTespitYeriLabel();
    _buildTespitYeriItems();
}

// ‚îÄ‚îÄ‚îÄ Custom Cari Dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateCariDropdown() {
    _cariAllList = [...new Set(allData.map(r => r.cariAdi).filter(v => v))].sort();
    _buildCariItems(_cariAllList);
}

function filterCariList() {
    const q = (document.getElementById('cariSearch').value || '').toLowerCase();
    const filtered = q ? _cariAllList.filter(c => c.toLowerCase().includes(q)) : _cariAllList;
    _buildCariItems(filtered);
}

function _buildCariItems(list) {
    const container = document.getElementById('cariList');
    container.innerHTML = '';
    if (!list.length) {
        container.innerHTML = '<div style="padding:12px;color:#aaa;text-align:center;font-size:0.85em;">Sonu√ß yok</div>';
        return;
    }
    list.forEach(c => {
        const isMusteri = musteriSet.has(c);
        const isSelected = selectedCari === c;
        const row = document.createElement('div');
        row.className = 'cari-list-item' + (isSelected ? ' selected' : '');

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'cari-musteri-chk';
        chk.title = 'M√º≈üteri olarak i≈üaretle';
        chk.checked = isMusteri;
        chk.addEventListener('change', e => { e.stopPropagation(); toggleMusteriMark(c, e.target.checked); });

        const star = document.createElement('span');
        star.style.cssText = 'font-size:0.78em;color:#e07000;flex-shrink:0;';
        star.textContent = '‚òÖ';
        star.title = 'M√º≈üteri olarak i≈üaretle';
        star.style.cursor = 'pointer';
        star.addEventListener('click', e => { e.stopPropagation(); chk.click(); });

        const nameSp = document.createElement('span');
        nameSp.className = 'cari-item-name';
        nameSp.textContent = c;
        nameSp.addEventListener('click', () => {
            selectCari(selectedCari === c ? '' : c);
            document.getElementById('cariPanel').style.display = 'none';
        });

        row.appendChild(chk);
        row.appendChild(star);
        row.appendChild(nameSp);

        if (isMusteri) {
            const badge = document.createElement('span');
            badge.className = 'cari-badge';
            badge.textContent = 'M√º≈üteri';
            row.appendChild(badge);
        }
        container.appendChild(row);
    });
}

function toggleCariDropdown() {
    const panel = document.getElementById('cariPanel');
    if (panel.style.display === 'block') {
        panel.style.display = 'none';
    } else {
        panel.style.display = 'block';
        document.getElementById('cariSearch').value = '';
        document.getElementById('cariSearch').focus();
        _buildCariItems(_cariAllList);
    }
}

function selectCari(val) {
    selectedCari = val;
    document.getElementById('cariSelectedText').textContent = val || 'T√ºm√º';
    // Tedarik√ßi analiz butonunu g√∂ster/gizle
    const ab = document.getElementById('cariAnalyzeBtn');
    if (ab) ab.style.display = val ? 'flex' : 'none';
    // Rebuild visible list to update selected highlight
    const q = (document.getElementById('cariSearch')?.value || '').toLowerCase();
    const filtered = q ? _cariAllList.filter(c => c.toLowerCase().includes(q)) : _cariAllList;
    _buildCariItems(filtered);
}

function toggleMusteriMark(cariAdi, isMus) {
    if (isMus) musteriSet.add(cariAdi);
    else musteriSet.delete(cariAdi);
    const arr = [...musteriSet];
    // localStorage (birincil - hƒ±zlƒ± ve g√ºvenilir)
    try { localStorage.setItem('uyg_musteriSet', JSON.stringify(arr)); } catch(e) {}
    // IndexedDB (yedek)
    dbSet('musteriSet', arr);
    const q = (document.getElementById('cariSearch')?.value || '').toLowerCase();
    const filtered = q ? _cariAllList.filter(c => c.toLowerCase().includes(q)) : _cariAllList;
    _buildCariItems(filtered);
}

// Dropdown dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
document.addEventListener('click', e => {
    const dd = document.getElementById('cariDropdown');
    if (dd && !dd.contains(e.target)) {
        const panel = document.getElementById('cariPanel');
        if (panel) panel.style.display = 'none';
    }
    const tdd = document.getElementById('tespitDropdown');
    if (tdd && !tdd.contains(e.target)) {
        const tpanel = document.getElementById('tespitPanel');
        if (tpanel) tpanel.style.display = 'none';
    }
});

function parseDateStr(val) {
    if (!val) return null;
    // Try yyyy-mm-dd or dd.mm.yyyy or dd/mm/yyyy
    let m;
    if ((m = String(val).match(/^(\d{4})-(\d{2})-(\d{2})/))) return `${m[1]}-${m[2]}-${m[3]}`;
    if ((m = String(val).match(/^(\d{2})[.\/](\d{2})[.\/](\d{4})/))) return `${m[3]}-${m[2]}-${m[1]}`;
    return null;
}

// ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
    const total = filteredData.length;
    const hatali = filteredData.reduce((s, r) => s + (Number(r.hataliMiktar) || 0), 0);
    const partiHacmi = filteredData.reduce((s, r) => s + (Number(r.partiHacmi) || 0), 0);
    const hataTipleri = new Set(filteredData.map(r => r.hataTipi).filter(Boolean)).size;
    const cariler = new Set(filteredData.map(r => r.cariAdi).filter(Boolean)).size;
    const ppm = partiHacmi > 0 ? Math.round((hatali / partiHacmi) * 1_000_000) : 0;
    document.getElementById('statTotal').textContent = total.toLocaleString('tr');
    document.getElementById('statHataliMiktar').textContent = hatali.toLocaleString('tr', {maximumFractionDigits:1});
    document.getElementById('statHataTipi').textContent = hataTipleri;
    document.getElementById('statCari').textContent = cariler;
    document.getElementById('statPPM').textContent = ppm.toLocaleString('tr');
}

// ‚îÄ‚îÄ‚îÄ Pareto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPareto() {
    const metric      = document.getElementById('paretoMetric').value;
    const topN        = parseInt(document.getElementById('paretoTop').value);
    const groupKey    = document.getElementById('paretoGroup').value;
    const threshold   = parseInt(document.getElementById('paretoThreshold').value);
    const groupOthers = document.getElementById('paretoGroupOthers').checked;

    // Aggregate (excluded hataTipleri hari√ß)
    const paretoSource = excludedHataTipleri.size > 0
        ? filteredData.filter(r => !excludedHataTipleri.has(r.hataTipi || '(Belirtilmemi≈ü)'))
        : filteredData;

    const agg = {};
    paretoSource.forEach(r => {
        const key = r[groupKey] || '(Belirtilmemi≈ü)';
        if (!agg[key]) agg[key] = { count: 0, hatali: 0 };
        agg[key].count++;
        agg[key].hatali += Number(r.hataliMiktar) || 0;
    });

    let allEntries = Object.entries(agg).map(([k, v]) => ({
        label: k,
        value: metric === 'hataliMiktar' ? v.hatali : v.count,
        count: v.count,
        hatali: v.hatali,
    })).sort((a, b) => b.value - a.value);

    let entries;
    if (groupOthers) {
        // √ñnce topN uygula (T√ºm√º = 999 ise t√ºm liste)
        const topSlice = topN < allEntries.length ? allEntries.slice(0, topN) : allEntries;
        // E≈üik y√ºzdesine g√∂re kesim noktasƒ± bul
        const totalVal = topSlice.reduce((s, e) => s + e.value, 0);
        let cum2 = 0;
        let threshCut = topSlice.length; // varsayƒ±lan: hepsi ana
        for (let i = 0; i < topSlice.length; i++) {
            cum2 += topSlice[i].value;
            if ((cum2 / (totalVal || 1)) * 100 >= threshold) {
                threshCut = i + 1;
                break;
            }
        }
        const mainEntries = topSlice.slice(0, threshCut);
        // topN sƒ±nƒ±rƒ± dƒ±≈üƒ±ndaki + e≈üik √ºst√ºndeki t√ºm giri≈üleri "Diƒüer"e ekle
        const restEntries = [
            ...topSlice.slice(threshCut),
            ...(topN < allEntries.length ? allEntries.slice(topN) : []),
        ];
        if (restEntries.length > 0) {
            const restVal = restEntries.reduce((s, e) => s + e.value, 0);
            mainEntries.push({
                label: `Diƒüer (${restEntries.length} kategori)`,
                value: restVal,
                count: restEntries.reduce((s, e) => s + e.count, 0),
                hatali: restEntries.reduce((s, e) => s + e.hatali, 0),
                isOther: true,
            });
        }
        entries = mainEntries;
    } else {
        entries = topN < allEntries.length ? allEntries.slice(0, topN) : allEntries;
    }

    const total = entries.reduce((s, e) => s + e.value, 0);
    let cum = 0;
    const cumPct = entries.map(e => { cum += e.value; return +(cum / total * 100).toFixed(1); });

    // Insight
    const threshIdx = cumPct.findIndex(p => p >= threshold);
    const insightEl = document.getElementById('paretoInsight');
    if (threshIdx >= 0 && entries.length > 0) {
        const mainCount = entries[threshIdx].isOther ? threshIdx : threshIdx + 1;
        insightEl.innerHTML = `üìå <strong>Pareto Kuralƒ±:</strong> ƒ∞lk <strong>${mainCount}</strong> kategori (toplam ${entries.filter(e=>!e.isOther).length} i√ßinden), t√ºm ${metric === 'hataliMiktar' ? 'hatalƒ± miktarƒ±n' : 'kaydƒ±n'} <strong>%${threshold}</strong>'${threshold===80?'i':threshold===70?'i':threshold===60?'sƒ±':'u'} olu≈üturmaktadƒ±r. Bu kategorilere odaklanmak en b√ºy√ºk iyile≈ütirmeyi saƒülar.`;
    } else {
        insightEl.innerHTML = '';
    }

    const labels = entries.map(e => e.label);
    const values = entries.map(e => e.value);

    // Colors: normal bars = se√ßilen renk ≈üemasƒ±, 'Diƒüer' bar = gri
    const barColors = getParetoBarColors(entries);

    if (paretoChartInst) { paretoChartInst.destroy(); paretoChartInst = null; }

    // Data labels plugin ‚Äî draws values on top of each bar
    const _showLabels = document.getElementById('paretoShowLabels').checked;
    const _metric = metric;
    const pluginDataLabels = {
        id: 'barDataLabels',
        afterDatasetsDraw(chart) {
            if (!_showLabels) return;
            const { ctx, data, scales } = chart;
            const barDs = chart.data.datasets.findIndex(ds => ds.type === 'bar');
            if (barDs < 0) return;
            const meta = chart.getDatasetMeta(barDs);
            ctx.save();
            ctx.font = 'bold 11px Segoe UI, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            meta.data.forEach((bar, i) => {
                const val = data.datasets[barDs].data[i];
                if (val == null || val === 0) return;
                const formatted = Number(val) >= 1000
                    ? Number(val).toLocaleString('tr', { maximumFractionDigits: 0 })
                    : Number(val).toLocaleString('tr', { maximumFractionDigits: 1 });
                const x = bar.x;
                const y = bar.y - 4;
                // shadow for readability
                ctx.fillStyle = 'rgba(255,255,255,0.75)';
                ctx.fillText(formatted, x + 1, y + 1);
                ctx.fillStyle = '#4a0a6b';
                ctx.fillText(formatted, x, y);
            });
            ctx.restore();
        }
    };

    // Threshold reference line ‚Äî inline plugin (closure captures current threshold)
    const _thresholdVal = threshold;
    const plugin80 = {
        id: 'line80',
        afterDraw(chart) {
            const { ctx, scales } = chart;
            if (!scales.y2) return;
            const y = scales.y2.getPixelForValue(_thresholdVal);
            ctx.save();
            ctx.setLineDash([6, 4]);
            ctx.strokeStyle = 'rgba(185,79,196,0.55)';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(scales.x.left, y);
            ctx.lineTo(scales.x.right, y);
            ctx.stroke();
            ctx.restore();
        }
    };

    const ctx = document.getElementById('paretoChart').getContext('2d');
    paretoChartInst = new Chart(ctx, {
        plugins: [pluginDataLabels, plugin80],
        data: {
            labels,
            datasets: [
                {
                    type: 'bar',
                    label: metric === 'hataliMiktar' ? 'Hatalƒ± Miktar' : 'Kayƒ±t Sayƒ±sƒ±',
                    data: values,
                    backgroundColor: barColors,
                    borderColor: barColors.map(c => c.replace('0.82', '1')),
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2,
                },
                {
                    type: 'line',
                    label: 'K√ºm√ºlatif %',
                    data: cumPct,
                    borderColor: '#4a0a6b',
                    backgroundColor: 'rgba(74,10,107,0.08)',
                    borderWidth: 2.5,
                    pointBackgroundColor: '#b94fc4',
                    pointRadius: 4,
                    tension: 0.3,
                    yAxisID: 'y2',
                    fill: false,
                    order: 1,
                },
            ],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top', labels: { font: { size: 12 }, color: '#333' } },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            if (ctx.datasetIndex === 1) {
                                return `K√ºm√ºlatif: %${ctx.parsed.y}`;
                            }
                            const val = Number(ctx.parsed.y);
                            const formatted = val >= 1000
                                ? val.toLocaleString('tr', { maximumFractionDigits: 0 })
                                : val.toLocaleString('tr', { maximumFractionDigits: 2 });
                            return `${ctx.dataset.label}: ${formatted}`;
                        }
                    }
                },
                annotation: {
                    // 80% line approximation via dataset
                },
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 30,
                        font: { size: 11 },
                        callback: function(val, idx) {
                            const lbl = labels[idx];
                            return lbl.length > 22 ? lbl.substring(0, 20) + '‚Ä¶' : lbl;
                        }
                    },
                    grid: { display: false },
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: metric === 'hataliMiktar' ? 'Hatalƒ± Miktar' : 'Kayƒ±t Sayƒ±sƒ±',
                        color: '#555',
                    },
                    grid: { color: '#eee' },
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    min: 0, max: 100,
                    title: { display: true, text: 'K√ºm√ºlatif (%)', color: '#4a0a6b' },
                    grid: { display: false },
                    ticks: {
                        callback: v => v + '%',
                        color: '#4a0a6b',
                    },
                },
            },
        },
    });

}

// ‚îÄ‚îÄ‚îÄ Pareto Color Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onParetoColorSchemeChange() {
    const scheme = document.getElementById('paretoColorScheme').value;
    const customDiv = document.getElementById('paretoCustomColors');
    customDiv.style.display = scheme === 'custom' ? 'flex' : 'none';
    renderPareto();
}

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return {r, g, b};
}

function lerpColor(c1, c2, t) {
    return {
        r: Math.round(c1.r + (c2.r - c1.r) * t),
        g: Math.round(c1.g + (c2.g - c1.g) * t),
        b: Math.round(c1.b + (c2.b - c1.b) * t),
    };
}

function getParetoBarColors(entries) {
    const scheme = (document.getElementById('paretoColorScheme') || {}).value || 'default';
    const n = entries.length;
    return entries.map((e, i) => {
        if (e.isOther) return 'rgba(160,160,160,0.65)';
        const t = n > 1 ? i / (n - 1) : 0;
        let c;
        if (scheme === 'default') {
            const r = Math.max(60, 185 - i * 8);
            return `rgba(${r}, 50, ${Math.min(180, 100 + i * 6)}, 0.82)`;
        } else if (scheme === 'blue') {
            c = lerpColor({r:29,g:78,b:216}, {r:147,g:197,b:253}, t);
        } else if (scheme === 'green') {
            c = lerpColor({r:21,g:128,b:61}, {r:134,g:239,b:172}, t);
        } else if (scheme === 'orange') {
            c = lerpColor({r:194,g:65,b:12}, {r:253,g:186,b:116}, t);
        } else if (scheme === 'red') {
            c = lerpColor({r:185,g:28,b:28}, {r:252,g:165,b:165}, t);
        } else if (scheme === 'rainbow') {
            const hue = Math.round(t * 300);
            return `hsla(${hue}, 80%, 50%, 0.82)`;
        } else if (scheme === 'custom') {
            const h1 = (document.getElementById('paretoColor1') || {}).value || '#b94fc4';
            const h2 = (document.getElementById('paretoColor2') || {}).value || '#3b82f6';
            c = lerpColor(hexToRgb(h1), hexToRgb(h2), t);
        } else {
            const r2 = Math.max(60, 185 - i * 8);
            return `rgba(${r2}, 50, ${Math.min(180, 100 + i * 6)}, 0.82)`;
        }
        return `rgba(${c.r},${c.g},${c.b},0.85)`;
    });
}

function downloadChartPNG() {
    if (!paretoChartInst) return;
    const src = paretoChartInst.canvas;
    const tmp = document.createElement('canvas');
    tmp.width  = src.width;
    tmp.height = src.height;
    const ctx2 = tmp.getContext('2d');
    ctx2.fillStyle = '#ffffff';
    ctx2.fillRect(0, 0, tmp.width, tmp.height);
    ctx2.drawImage(src, 0, 0);
    const a = document.createElement('a');
    a.href = tmp.toDataURL('image/png', 1);
    a.download = 'pareto-analizi.png';
    a.click();
}

// ‚îÄ‚îÄ‚îÄ Breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBreakdown() {
    const agg = {};
    const totalHatali = filteredData.reduce((s, r) => s + (Number(r.hataliMiktar) || 0), 0);
    filteredData.forEach(r => {
        const k = r.hataTipi || '(Belirtilmemi≈ü)';
        if (!agg[k]) agg[k] = { count: 0, hatali: 0 };
        agg[k].count++;
        agg[k].hatali += Number(r.hataliMiktar) || 0;
    });
    const sorted = Object.entries(agg).sort((a, b) => b[1].hatali - a[1].hatali);
    const maxHatali = sorted[0] ? sorted[0][1].hatali : 1;
    // √ñzellik 3: Aksiyon geri besleme
    let aksiyonlar = {};
    try { aksiyonlar = JSON.parse(localStorage.getItem('fishbone_aksiyonlar') || '{}'); } catch(e) {}

    const grid = document.getElementById('breakdownGrid');
    if (!sorted.length) { grid.innerHTML = '<p style="color:#aaa;font-size:0.9em;">Veri yok</p>'; return; }
    grid.innerHTML = sorted.map(([k, v]) => {
        const pct = totalHatali > 0 ? (v.hatali / totalHatali * 100).toFixed(1) : 0;
        const barW = maxHatali > 0 ? (v.hatali / maxHatali * 100).toFixed(1) : 0;
        const isExcluded = excludedHataTipleri.has(k);
        const isSelectedMulti = selectedForMulti.has(k);
        const safeKey = k.replace(/"/g, '&quot;');
        const aksiyon = aksiyonlar[k] || 0;
        const aksiyonBadge = aksiyon > 0 ? `<span class="bi-aksiyon-badge">üìã ${aksiyon} aksiyon</span>` : '';
        const multiAttr = multiAnalyzeMode ? `onclick="toggleMultiSelect('${safeKey}')" style="cursor:pointer;"` : '';
        return `<div class="breakdown-item${isExcluded ? ' excluded' : ''}${isSelectedMulti ? ' selected-for-multi' : ''}" id="bdi-${btoa(encodeURIComponent(k)).replace(/=/g,'')}" ${multiAttr}>
            <div class="bi-header">
                <div class="bi-name">${k}${aksiyonBadge}</div>
                <input type="checkbox" class="bi-checkbox" title="Paretoya dahil et" ${isExcluded ? '' : 'checked'} onchange="toggleHataTipi('${safeKey}', this.checked)" ${multiAnalyzeMode ? 'style="pointer-events:none;"' : ''}>
            </div>
            <div class="bi-count">${v.hatali.toLocaleString('tr', {maximumFractionDigits:1})}</div>
            <div class="bi-pct">%${pct} ¬∑ ${v.count} kayƒ±t</div>
            <div class="bi-bar"><div class="bi-bar-fill" style="width:${barW}%"></div></div>
            <button class="bi-fishbone-btn" onclick="openFishbone('${safeKey}', ${v.count}, ${v.hatali}, '${pct}')" title="Bu hatayƒ± balƒ±k kƒ±l√ßƒ±ƒüƒ± diyagramƒ±nda analiz et">üêü Balƒ±k Kƒ±l√ßƒ±ƒüƒ±'nda Analiz Et</button>
        </div>`;
    }).join('');
}

function toggleHataTipi(key, checked) {
    if (checked) {
        excludedHataTipleri.delete(key);
    } else {
        excludedHataTipleri.add(key);
    }
    // Kart g√∂r√ºn√ºm√ºn√º g√ºncelle
    const safeId = 'bdi-' + btoa(encodeURIComponent(key)).replace(/=/g,'');
    const card = document.getElementById(safeId);
    if (card) card.classList.toggle('excluded', !checked);
    // Sadece Pareto grafiƒüini g√ºncelle
    renderPareto();
}

// ‚îÄ‚îÄ‚îÄ Yardƒ±mcƒ±: bir alan i√ßin en sƒ±k N deƒüeri d√∂nd√ºr ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function topNField(rows, field, n = 5) {
    const cnt = {};
    rows.forEach(r => { const v = (r[field] || '').trim(); if (v) cnt[v] = (cnt[v] || 0) + 1; });
    return Object.entries(cnt).sort((a, b) => b[1] - a[1]).slice(0, n).map(e => e[0]);
}

// Contribution oranƒ±yla birlikte top-N ‚Äî hatali miktar bazlƒ±
function topNFieldWithContrib(rows, field, n = 5) {
    const agg = {};
    const totalHatali = rows.reduce((s, r) => s + (Number(r.hataliMiktar) || 0), 0) || 1;
    rows.forEach(r => {
        const v = (r[field] || '').trim();
        if (!v) return;
        if (!agg[v]) agg[v] = { count: 0, hatali: 0 };
        agg[v].count++;
        agg[v].hatali += Number(r.hataliMiktar) || 0;
    });
    return Object.entries(agg)
        .sort((a, b) => b[1].hatali - a[1].hatali)
        .slice(0, n)
        .map(([name, v]) => {
            const pct = (v.hatali / totalHatali * 100).toFixed(1);
            return { name, displayName: `${name} (%${pct})`, pct: Number(pct), count: v.count, hatali: v.hatali };
        });
}

// 6M anahtar kelime sƒ±nƒ±flandƒ±rƒ±cƒ±
// hataKaynagi deƒüerlerini i√ßeriklerine g√∂re 6 kemiƒüe daƒüƒ±tƒ±r
function classify6M(rows) {
    const RULES = [
        { bone: 'insan',   kws: ['i≈ü√ßi','i≈ücilik','iscilik','operat√∂r','operator','personel','eƒüitim','egitim','dikkatsiz','ihmal','√ßalƒ±≈üan','calisan','insan','adam','yorgun','tecr√ºbe','tecrubesiz'] },
        { bone: 'malzeme', kws: ['hammadde','ham madde','malzeme kalite','malzeme','tedarik√ßi','tedarikci','hammad','kalitesiz','stok','yar mamul','yarƒ± mamul'] },
        { bone: 'metot',   kws: ['hatalƒ± talimat','hatali talimat','prosed√ºr','prosedur','y√∂ntem','yontem','s√ºre√ß','surec','standart','talimat','instruks','uygulama hatasƒ±'] },
        { bone: 'makine',  kws: ['makine','ekipman','kalibrasyon','arƒ±za','ariza','bakƒ±m','bakim','tertibat','aparat','kalƒ±p','kalip','pres','hidrolik'] },
        { bone: 'olcum',   kws: ['√∂l√ß√ºm','olcum','muayene','kontrol','test','√∂l√ßme','tolerans'] },
        { bone: 'ortam',   kws: ['sevkiyat','depolama','nakliye','√ßevre','cevre','sƒ±caklƒ±k','sicaklik','nem','ortam','ambalaj'] },
    ];

    const totalHatali = rows.reduce((s, r) => s + (Number(r.hataliMiktar) || 0), 0) || 1;
    const agg = {};
    rows.forEach(r => {
        const v = (r.hataKaynagi || '').trim();
        if (!v) return;
        if (!agg[v]) agg[v] = { count: 0, hatali: 0 };
        agg[v].count++;
        agg[v].hatali += Number(r.hataliMiktar) || 0;
    });

    const result = { insan: [], malzeme: [], metot: [], makine: [], olcum: [], ortam: [] };
    Object.entries(agg).forEach(([name, v]) => {
        const lower = name.toLowerCase();
        let bone = null; // e≈üle≈üme yoksa null ‚Äî sƒ±nƒ±flandƒ±rƒ±lamayan
        for (const rule of RULES) {
            if (rule.kws.some(kw => lower.includes(kw))) { bone = rule.bone; break; }
        }
        if (!bone) return; // sƒ±nƒ±flandƒ±rƒ±lamayanlarƒ± atlƒ±yoruz (diyagramƒ± kirletmesin)
        const pct = (v.hatali / totalHatali * 100).toFixed(1);
        result[bone].push({ name, displayName: `${name} (%${pct})`, pct: Number(pct), count: v.count, hatali: v.hatali });
    });
    for (const k of Object.keys(result)) result[k].sort((a, b) => b.hatali - a.hatali);
    return result;
}

function openFishbone(hataTipi, count, hatali, pct) {
    const fTarih1 = (document.getElementById('fDateStart') || {}).value || '';
    const fTarih2 = (document.getElementById('fDateEnd')   || {}).value || '';
    const fCariTip = (document.getElementById('fCariTip')  || {}).value || '';
    const tarihBilgi = (fTarih1 || fTarih2) ? `\n‚Ä¢ Tarih aralƒ±ƒüƒ±: ${fTarih1 || '‚Äî'} / ${fTarih2 || '‚Äî'}` : '';
    const cariBilgi = fCariTip && fCariTip !== 'tumu' ? `\n‚Ä¢ Cari tipi: ${fCariTip}` : '';

    // √ñzellik 4: Trend tespiti (son 90 g√ºn vs √∂nceki 90 g√ºn)
    const relRows = filteredData.filter(r => r.hataTipi === hataTipi);
    const now = new Date();
    const d90  = new Date(now.getTime() - 90  * 86400000);
    const d180 = new Date(now.getTime() - 180 * 86400000);
    let trendBilgi = '';
    try {
        const currH = relRows.filter(r => { const d = parseDateStr(r.uygunsuzlukTarih); return d && d >= d90; })
                             .reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
        const prevH = relRows.filter(r => { const d = parseDateStr(r.uygunsuzlukTarih); return d && d >= d180 && d < d90; })
                             .reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
        if (prevH > 0 && currH > 0) {
            const delta = Math.round((currH - prevH) / prevH * 100);
            if (delta >= 20)  trendBilgi = `\n‚ö†Ô∏è Y√ºkselen trend: son 90 g√ºnde +%${delta} artƒ±≈ü`;
            else if (delta <= -20) trendBilgi = `\nüìâ D√º≈üen trend: son 90 g√ºnde %${Math.abs(delta)} azalƒ±≈ü`;
        }
    } catch(e) {}

    const desc = `Uygunsuzluk Analizi verilerinden aktarƒ±ldƒ±.\n‚Ä¢ Hatalƒ± miktar: ${Number(hatali).toLocaleString('tr', {maximumFractionDigits:1})} adet (%${pct})\n‚Ä¢ Kayƒ±t sayƒ±sƒ±: ${count}${tarihBilgi}${cariBilgi}${trendBilgi}`;

    // √ñzellik 2: 6M kemikleri ‚Äî hataKaynagi anahtar kelimeye g√∂re otomatik sƒ±nƒ±flandƒ±rƒ±lƒ±r
    const BONE_COLORS = ['#ef4444','#f59e0b','#3b82f6','#8b5cf6','#06b6d4','#22c55e'];
    let _nid = 1; const mkId = () => _nid++;
    const mkChildren = (items, color) => (items||[]).slice(0,6).map(item => ({
        id:mkId(),
        name: item.displayName || item.name || item,
        color, children:[], collapsed:false,
        offsetX:0, offsetY:0,
        _contrib: item.pct || null
    }));

    // hataKaynagi -> 6M anahtar kelime sƒ±nƒ±flandƒ±rmasƒ±
    const cls = classify6M(relRows);

    // Diƒüer alanlarda da katkƒ± oranƒ±
    const causes = [
        { name:'üë§ ƒ∞nsan',   desc:'Hata kaynaƒüƒ± ‚Üí insan kaynaklƒ±',        color:BONE_COLORS[0], side:'top',
          children: mkChildren(cls.insan, BONE_COLORS[0]) },
        { name:'‚öôÔ∏è Makine',  desc:'Makine/ekipman kaynaklƒ±',         color:BONE_COLORS[1], side:'bottom',
          children: mkChildren(cls.makine, BONE_COLORS[1]) },
        { name:'üì¶ Malzeme', desc:'Etkilenen stoklar + malzeme kaynaklƒ±', color:BONE_COLORS[2], side:'top',
          children: [
            ...mkChildren(topNFieldWithContrib(relRows,'stokAdi',3), BONE_COLORS[2]),
            ...mkChildren(topNFieldWithContrib(relRows,'cariAdi',2), BONE_COLORS[2]),
            ...mkChildren(cls.malzeme, BONE_COLORS[2])
          ].slice(0,6) },
        { name:'üìã Metot',   desc:'Metot / s√ºre√ß kaynaklƒ±',            color:BONE_COLORS[3], side:'bottom',
          children: mkChildren(cls.metot, BONE_COLORS[3]) },
        { name:'üìê √ñl√ß√ºm',  desc:'√ñl√ß√ºm / muayene kaynaklƒ±',          color:BONE_COLORS[4], side:'top',
          children: mkChildren(cls.olcum, BONE_COLORS[4]) },
        { name:'üå°Ô∏è Ortam',  desc:'Tespit yeri + ortam kaynaklƒ±',      color:BONE_COLORS[5], side:'bottom',
          children: [
            ...mkChildren(topNFieldWithContrib(relRows,'tespitYeri',3), BONE_COLORS[5]),
            ...mkChildren(cls.ortam, BONE_COLORS[5])
          ].slice(0,6) },
    ].map(b => ({ ...b, id:mkId(), collapsed:false, offsetX:0, offsetY:0, baseOffsetX:0, baseOffsetY:0 }));

    localStorage.setItem('fishbone_incoming', JSON.stringify({
        problem: hataTipi, problemDesc: desc,
        source: 'uygunsuzluk-analizi',
        causes, nextId: _nid,
        meta: { hataTipi, count, hatali, pct }
    }));
    localStorage.setItem('fishbone_source', 'uygunsuzluk-analizi');
    window.open('balik-kilcigi.html', '_blank');
}

// Kapsamlƒ± Rapor ‚Äî IndexedDB √ºzerinden iletim
const _RIDB = { name:'KaliteRaporDB', store:'payloads', key:'rapor_payload', ver:1 };
function _rIdbOpen() {
    return new Promise((res, rej) => {
        const r = indexedDB.open(_RIDB.name, _RIDB.ver);
        r.onupgradeneeded = e => e.target.result.createObjectStore(_RIDB.store);
        r.onsuccess = e => res(e.target.result);
        r.onerror   = () => rej(r.error);
    });
}
function _rIdbSave(data) {
    return _rIdbOpen().then(db => new Promise((res, rej) => {
        const tx = db.transaction(_RIDB.store, 'readwrite');
        tx.objectStore(_RIDB.store).put(data, _RIDB.key);
        tx.oncomplete = () => { db.close(); res(); };
        tx.onerror    = () => { db.close(); rej(tx.error); };
    }));
}
function _rIdbGet(key) {
    return _rIdbOpen().then(db => new Promise(res => {
        const g = db.transaction(_RIDB.store,'readonly').objectStore(_RIDB.store).get(key);
        g.onsuccess = () => { db.close(); res(g.result ?? null); };
        g.onerror   = () => { db.close(); res(null); };
    }));
}
function _rIdbPut(key, value) {
    return _rIdbOpen().then(db => new Promise((res, rej) => {
        const tx = db.transaction(_RIDB.store, 'readwrite');
        tx.objectStore(_RIDB.store).put(value, key);
        tx.oncomplete = () => { db.close(); res(); };
        tx.onerror    = () => { db.close(); rej(tx.error); };
    }));
}
function _rIdbDel(key) {
    return _rIdbOpen().then(db => new Promise(res => {
        const tx = db.transaction(_RIDB.store,'readwrite');
        tx.objectStore(_RIDB.store).delete(key);
        tx.oncomplete = () => { db.close(); res(); };
        tx.onerror    = () => { db.close(); res(); };
    }));
}

// Snapshot list modal for uygunsuzluk-analizi
const _UA_SNAPS_KEY = 'kr_snapshots'; // same key as kapsamli-rapor.html
const _UA_FILTERS_KEY = 'ua_saved_filters';

// ‚îÄ‚îÄ‚îÄ Filtre Kaydet / Y√ºkle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveCurrentFilter() {
    const name = prompt('Bu filtre i√ßin bir isim girin:', 'Filtre ' + new Date().toLocaleDateString('tr-TR'));
    if (!name || !name.trim()) return;
    const state = {
        tipi:             document.getElementById('fTipi').value,
        hataTipi:         document.getElementById('fHataTipi').value,
        hataKaynagi:      document.getElementById('fHataKaynagi').value,
        uygunsuzlukTuru:  document.getElementById('fUygunsuzlukTuru').value,
        makine:           document.getElementById('fMakine').value,
        stokKodu:         document.getElementById('fStokKodu').value,
        dateStart:        document.getElementById('fDateStart').value,
        dateEnd:          document.getElementById('fDateEnd').value,
        cariTip:          document.getElementById('fCariTip').value,
        selectedCari:     selectedCari,
        tespitYeri:       [...selectedTespitYeriSet]
    };
    const list = (await _rIdbGet(_UA_FILTERS_KEY)) || [];
    list.push({ id: Date.now(), name: name.trim(), savedAt: new Date().toLocaleString('tr-TR'), state });
    await _rIdbPut(_UA_FILTERS_KEY, list);
    showToast('Filtre kaydedildi: ' + name.trim(), 'success');
}

async function openSavedFiltersModal() {
    const list = (await _rIdbGet(_UA_FILTERS_KEY)) || [];
    const el = document.getElementById('uaFiltreList');
    if (!list.length) {
        el.innerHTML = '<div style="padding:20px;text-align:center;color:#94a3b8;font-size:.85rem;">Kayƒ±tlƒ± filtre bulunamadƒ±.</div>';
    } else {
        el.innerHTML = list.slice().reverse().map(f => `
            <div class="filtre-save-row">
                <div class="filtre-save-info">
                    <div class="filtre-save-name">${_uaEsc(f.name)}</div>
                    <div class="filtre-save-meta">${_uaEsc(f.savedAt)}</div>
                </div>
                <div class="filtre-save-btns">
                    <button class="ua-snap-btn ua-snap-load" onclick="applySavedFilter(${f.id})">‚ñ∂ Uygula</button>
                    <button class="ua-snap-btn ua-snap-del" onclick="deleteSavedFilter(${f.id})">üóë Sil</button>
                </div>
            </div>`).join('');
    }
    document.getElementById('uaFiltreModal').classList.add('open');
}

async function applySavedFilter(id) {
    const list = (await _rIdbGet(_UA_FILTERS_KEY)) || [];
    const entry = list.find(f => f.id === id);
    if (!entry) return;
    const s = entry.state;
    document.getElementById('fTipi').value            = s.tipi            || '';
    document.getElementById('fHataTipi').value        = s.hataTipi        || '';
    document.getElementById('fHataKaynagi').value     = s.hataKaynagi     || '';
    document.getElementById('fUygunsuzlukTuru').value = s.uygunsuzlukTuru || '';
    document.getElementById('fMakine').value          = s.makine          || '';
    document.getElementById('fStokKodu').value        = s.stokKodu        || '';
    document.getElementById('fDateStart').value       = s.dateStart       || '';
    document.getElementById('fDateEnd').value         = s.dateEnd         || '';
    document.getElementById('fCariTip').value         = s.cariTip         || '';
    selectedTespitYeriSet = new Set(s.tespitYeri || []);
    _updateTespitYeriLabel();
    selectCari(s.selectedCari || '');
    document.getElementById('uaFiltreModal').classList.remove('open');
    applyFilters();
    showToast('Filtre y√ºklendi: ' + entry.name, 'success');
}

async function deleteSavedFilter(id) {
    if (!confirm('Bu kayƒ±tlƒ± filtreyi silmek istediƒüinize emin misiniz?')) return;
    let list = (await _rIdbGet(_UA_FILTERS_KEY)) || [];
    list = list.filter(f => f.id !== id);
    await _rIdbPut(_UA_FILTERS_KEY, list);
    showToast('Filtre silindi');
    openSavedFiltersModal();
}
const _UA_EDITS_KEY = 'kapsamli_rapor_edits';

function _uaEsc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function _uaFmtN(n) {
    if (n == null || isNaN(n)) return '‚Äî';
    return Number(n).toLocaleString('tr-TR', { maximumFractionDigits:0 });
}

async function uaOpenSnapshotModal() {
    const list = (await _rIdbGet(_UA_SNAPS_KEY)) || [];
    const body = document.getElementById('uaSnapList');
    if (!body) return;
    if (!list.length) {
        body.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:28px 0;">Hen√ºz kayƒ±tlƒ± rapor yok.<br><small style="color:#c4cdd8;">Kapsamlƒ± Rapor sayfasƒ±nda üíæ Kaydet butonunu kullanarak rapor kaydedebilirsiniz.</small></p>';
    } else {
        body.innerHTML = list.slice().reverse().map(m => `
            <div class="ua-snap-row">
                <div class="ua-snap-info">
                    <div class="ua-snap-name">${_uaEsc(m.name)}</div>
                    <div class="ua-snap-meta">${new Date(m.ts).toLocaleString('tr-TR')} &nbsp;¬∑&nbsp; ${_uaFmtN(m.recordCount)} kayƒ±t &nbsp;¬∑&nbsp; ${_uaFmtN(m.totalHatali)} hatalƒ±</div>
                </div>
                <div class="ua-snap-btns">
                    <button class="ua-snap-btn ua-snap-load" onclick="uaLoadSnapshot('${m.id}')">üìÇ Raporu A√ß</button>
                    <button class="ua-snap-btn ua-snap-del"  onclick="uaDeleteSnapshot('${m.id}')">üóëÔ∏è Sil</button>
                </div>
            </div>`.trim()).join('');
    }
    document.getElementById('uaSnapModal').classList.add('open');
}

async function uaDeleteSnapshot(id) {
    if (!confirm('Bu kayƒ±tlƒ± rapor silinsin mi?')) return;
    const list = (await _rIdbGet(_UA_SNAPS_KEY)) || [];
    await _rIdbPut(_UA_SNAPS_KEY, list.filter(m => m.id !== id));
    await _rIdbDel('kr_' + id);
    uaOpenSnapshotModal();
}

async function uaLoadSnapshot(id) {
    const snap = await _rIdbGet('kr_' + id);
    if (!snap || !snap.payload) { showToast('Snapshot verisi bulunamadƒ±.', 'error'); return; }
    // Restore payload + edits to IDB then open the report
    await _rIdbPut(_RIDB.key, snap.payload);
    if (snap.edits) await _rIdbPut(_UA_EDITS_KEY, snap.edits);
    else await _rIdbDel(_UA_EDITS_KEY);
    document.getElementById('uaSnapModal').classList.remove('open');
    window.open('kapsamli-rapor.html', '_blank');
}

// Kapsamlƒ± Rapor ‚Äî t√ºm filtrelenmi≈ü veriyi paketleyip rapor sayfasƒ±na g√∂nderir
async function openKapsamliRapor() {
    if (!filteredData || !filteredData.length) {
        showToast('Rapor olu≈üturmak i√ßin √∂nce veri y√ºkleyin ve filtreleyin.', 'error');
        return;
    }
    const fTarih1      = (document.getElementById('fDateStart')   || {}).value || '';
    const fTarih2      = (document.getElementById('fDateEnd')     || {}).value || '';
    const fHataTipi    = (document.getElementById('fHataTipi')    || {}).value || '';
    const fTipi        = (document.getElementById('fTipi')        || {}).value || '';
    const fHataKaynagi = (document.getElementById('fHataKaynagi') || {}).value || '';
    const fCariTip     = (document.getElementById('fCariTip')     || {}).value || '';
    const fStokKodu    = (document.getElementById('fStokKodu')    || {}).value || '';
    const tespitList   = [...selectedTespitYeriSet];

    const cariTipLabel = fCariTip === 'musteri' ? '‚òÖ M√º≈üteri' : fCariTip === 'tedarikci' ? 'Tedarik√ßi' : '';
    let titleParts = [];
    if (fTipi)                   titleParts.push(fTipi);
    if (cariTipLabel)            titleParts.push(cariTipLabel);
    if (selectedCari)            titleParts.push(selectedCari);
    if (tespitList.length === 1) titleParts.push(tespitList[0]);
    if (fHataTipi)               titleParts.push(fHataTipi);
    const batchLabel = titleParts.join(' ¬∑ ') || 'T√ºm Veriler';

    // Hata tipinden dƒ±≈ülananlarƒ± √ßƒ±kar
    const reportData = excludedHataTipleri.size > 0
        ? filteredData.filter(r => !excludedHataTipleri.has(r.hataTipi || '(Belirtilmemi≈ü)'))
        : filteredData;

    const RAPOR_FIELDS = ['hataliMiktar','hataTipi','hataKaynagi','cariAdi','stokAdi',
                          'tespitYeri','tipi','uygunsuzlukTarih','uygunsuzlukTuru','partiHacmi'];
    const rowSig = r => RAPOR_FIELDS.map(f => String(r[f] ?? '')).join('|');

    const batchId  = 'b_' + Date.now();
    const batchFilters = {
        tarihStart: fTarih1, tarihEnd: fTarih2, tipi: fTipi, cariTip: fCariTip,
        cari: selectedCari || '', tespitYeri: tespitList, hataTipi: fHataTipi,
        hataKaynagi: fHataKaynagi, stokKodu: fStokKodu, excludedTypes: [...excludedHataTipleri]
    };
    const newBatch = {
        id: batchId, label: batchLabel, rowCount: reportData.length,
        addedAt: new Date().toLocaleString('tr-TR'), filters: batchFilters
    };

    // Mevcut payload'ƒ± y√ºkle ve birle≈ütir
    const existing     = await _rIdbGet(_RIDB.key);
    let allRows        = [];
    let batches        = [];
    const existingSigs = new Set();
    if (existing && existing.rows && existing.rows.length) {
        allRows = existing.rows;
        batches = existing.batches || [];
        allRows.forEach(r => existingSigs.add(rowSig(r)));
    }

    // Yeni satƒ±rlarƒ± etiketle ve tekrar edenleri atla
    const newSlim = reportData.map(r => {
        const o = { _batchId: batchId };
        RAPOR_FIELDS.forEach(f => { if (r[f] !== undefined) o[f] = r[f]; });
        return o;
    }).filter(r => !existingSigs.has(rowSig(r)));

    // Yeni benzersiz satƒ±r yoksa batch metaverisini yine de kaydet
    const dupNotice = newSlim.length === 0
        ? ` (0 yeni ‚Äî t√ºm satƒ±rlar zaten mevcut; filtre i≈üaretlendi)` : '';

    allRows = [...allRows, ...newSlim];
    batches = [...batches, { ...newBatch, rowCount: newSlim.length, dupNotice: !!dupNotice }];

    // T√ºm satƒ±rlar √ºzerinden Pareto gruplarƒ±nƒ± yeniden hesapla
    const _pgMetric = document.getElementById('paretoMetric').value;
    const _pgTopN   = parseInt(document.getElementById('paretoTop').value);
    const _pgThresh = parseInt(document.getElementById('paretoThreshold').value);
    const _pgKey    = document.getElementById('paretoGroup').value;
    const _pgAgg    = {};
    allRows.forEach(r => {
        const k = r[_pgKey] || '(Belirtilmemi≈ü)';
        if (!_pgAgg[k]) _pgAgg[k] = { count: 0, hatali: 0 };
        _pgAgg[k].count++;
        _pgAgg[k].hatali += Number(r.hataliMiktar) || 0;
    });
    let _pgEntries = Object.entries(_pgAgg).map(([k,v]) => ({
        label: k, value: _pgMetric === 'hataliMiktar' ? v.hatali : v.count, count: v.count, hatali: v.hatali
    })).sort((a,b) => b.value - a.value);
    const _pgTopSlice = _pgTopN < _pgEntries.length ? _pgEntries.slice(0, _pgTopN) : _pgEntries;
    const _pgTotal    = _pgTopSlice.reduce((s,e) => s + e.value, 0);
    let _pgCum = 0, _pgCut = _pgTopSlice.length;
    for (let _i = 0; _i < _pgTopSlice.length; _i++) {
        _pgCum += _pgTopSlice[_i].value;
        if ((_pgCum / (_pgTotal || 1)) * 100 >= _pgThresh) { _pgCut = _i + 1; break; }
    }
    const paretoGroups = _pgTopSlice.slice(0, _pgCut).map(e => {
        const gRows = allRows.filter(r => (r[_pgKey] || '(Belirtilmemi≈ü)') === e.label);
        return { label: e.label, totalHatali: e.hatali, count: e.count, pct: +(e.value / (_pgTotal||1) * 100).toFixed(1), groupRows: gRows };
    });

    const title = batches.length > 1
        ? `Birle≈üik Kalite Raporu ‚Äî ${batches.length} filtre, ${allRows.length} kayƒ±t`
        : (batchLabel + ' ‚Äî Kalite Raporu');

    const payload = {
        rows: allRows, batches, title,
        generatedAt: new Date().toISOString(),
        paretoGroups,
        paretoGroupKey:  _pgKey,
        paretoThreshold: _pgThresh,
        filters: batchFilters
    };

    try {
        await _rIdbSave(payload);
        showToast(`‚úÖ ${newSlim.length} kayƒ±t eklendi${dupNotice} ‚Äî raporda toplam ${allRows.length} kayƒ±t (${batches.length} filtre)`, newSlim.length === 0 ? 'warn' : 'success');
        if (!window._kapsamliWin || window._kapsamliWin.closed)
            window._kapsamliWin = window.open('kapsamli-rapor.html', 'kapsamliRapor');
        else
            window._kapsamliWin.location.reload();
    } catch(e) {
        showToast('Rapor kaydedilemedi: ' + (e && e.message || e), 'error');
    }
}

async function temizleKapsamliRapor() {
    if (!confirm('Kapsamlƒ± rapordaki t√ºm birikmi≈ü veri silinsin mi?\nYeni bir rapor ba≈ülatmak i√ßin Evet\'e basƒ±n.')) return;
    await _rIdbDel(_RIDB.key);
    if (window._kapsamliWin && !window._kapsamliWin.closed) {
        window._kapsamliWin.close();
        window._kapsamliWin = null;
    }
    showToast('Rapor temizlendi ‚Äî artƒ±k yeni filtrelerle ba≈ülayabilirsiniz.', 'success');
}

// √ñzellik 1: Tedarik√ßi bazƒ±nda Fishbone ‚Äî 6M yapƒ±sƒ±
function openFishboneTedarikci() {
    if (!selectedCari) return;
    const cariRows = filteredData.filter(r => r.cariAdi === selectedCari);
    if (!cariRows.length) { showToast('Bu cari i√ßin veri bulunamadƒ±.', 'error'); return; }
    const BONE_COLORS = ['#ef4444','#f59e0b','#3b82f6','#8b5cf6','#06b6d4','#22c55e'];
    let _nid = 1; const mkId = () => _nid++;
    const mkChildren = (items, color) => (items||[]).slice(0,6).map(item => ({
        id:mkId(),
        name: item.displayName || item.name || item,
        color, children:[], collapsed:false,
        offsetX:0, offsetY:0,
        _contrib: item.pct || null
    }));
    // hataKaynagi -> 6M anahtar kelime sƒ±nƒ±flandƒ±rmasƒ±
    const cls = classify6M(cariRows);

    const causes = [
        { name:'üë§ ƒ∞nsan',   desc:'Hata kaynaƒüƒ± ‚Üí insan kaynaklƒ±',           color:BONE_COLORS[0], side:'top',
          children: mkChildren(cls.insan, BONE_COLORS[0]) },
        { name:'‚öôÔ∏è Makine',  desc:'Makine/ekipman kaynaklƒ±',            color:BONE_COLORS[1], side:'bottom',
          children: mkChildren(cls.makine, BONE_COLORS[1]) },
        { name:'üì¶ Malzeme', desc:'Etkilenen stoklar + malzeme kaynaklƒ±',  color:BONE_COLORS[2], side:'top',
          children: [
            ...mkChildren(topNFieldWithContrib(cariRows,'stokAdi',3), BONE_COLORS[2]),
            ...mkChildren(cls.malzeme, BONE_COLORS[2])
          ].slice(0,6) },
        { name:'üìã Metot',   desc:'Metot / s√ºre√ß kaynaklƒ±',               color:BONE_COLORS[3], side:'bottom',
          children: mkChildren(cls.metot, BONE_COLORS[3]) },
        { name:'üìê √ñl√ß√ºm',  desc:'Hata tipi + √∂l√ß√ºm kaynaklƒ±',            color:BONE_COLORS[4], side:'top',
          children: [
            ...mkChildren(topNFieldWithContrib(cariRows,'hataTipi',3), BONE_COLORS[4]),
            ...mkChildren(cls.olcum, BONE_COLORS[4])
          ].slice(0,6) },
        { name:'üå°Ô∏è Ortam',  desc:'Tespit yeri + ortam kaynaklƒ±',         color:BONE_COLORS[5], side:'bottom',
          children: [
            ...mkChildren(topNFieldWithContrib(cariRows,'tespitYeri',3), BONE_COLORS[5]),
            ...mkChildren(cls.ortam, BONE_COLORS[5])
          ].slice(0,6) },
    ].map(b => ({ ...b, id:mkId(), collapsed:false, offsetX:0, offsetY:0, baseOffsetX:0, baseOffsetY:0 }));
    const total = cariRows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    const desc = `Tedarik√ßi kalite analizi.\n‚Ä¢ Toplam hatalƒ± miktar: ${total.toLocaleString('tr',{maximumFractionDigits:1})}\n‚Ä¢ Toplam kayƒ±t: ${cariRows.length}\nKaynak: Uygunsuzluk Analizi`;
    localStorage.setItem('fishbone_incoming', JSON.stringify({
        problem: `${selectedCari} ‚Äï Kalite Problemleri`,
        problemDesc: desc, source: 'uygunsuzluk-analizi',
        causes, nextId: _nid
    }));
    localStorage.setItem('fishbone_source', 'uygunsuzluk-analizi');
    window.open('balik-kilcigi.html', '_blank');
}

// ‚îÄ‚îÄ‚îÄ Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable(data) {
    if (data === undefined) {
        tableSearchData = [...filteredData];
    }
    const search = document.getElementById('tableSearch').value.toLowerCase();
    let display = tableSearchData.filter(r => {
        if (!search) return true;
        return TABLE_COLS.some(k => String(r[k]).toLowerCase().includes(search));
    });

    // Sort
    if (sortCol >= 0) {
        const key = TABLE_COLS[sortCol];
        display.sort((a, b) => {
            const av = a[key], bv = b[key];
            const an = parseFloat(av), bn = parseFloat(bv);
            if (!isNaN(an) && !isNaN(bn)) return sortAsc ? an - bn : bn - an;
            return sortAsc ? String(av).localeCompare(String(bv), 'tr') : String(bv).localeCompare(String(av), 'tr');
        });
    }

    const total = display.length;
    const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (currentPage > pages) currentPage = pages;
    const start = (currentPage - 1) * PAGE_SIZE;
    const slice = display.slice(start, start + PAGE_SIZE);

    document.getElementById('tableInfo').textContent = `${total.toLocaleString('tr')} kayƒ±t ¬∑ Sayfa ${currentPage}/${pages}`;

    // Header
    document.getElementById('tableHead').innerHTML = `<tr>${TABLE_COLS.map((k, i) => {
        const icon = sortCol === i ? (sortAsc ? ' ‚ñ≤' : ' ‚ñº') : '';
        return `<th onclick="sortTable(${i})">${COL_LABELS[k]}${icon}</th>`;
    }).join('')}<th style="min-width:52px;text-align:center;">8D</th></tr>`;

    // Body
    document.getElementById('tableBody').innerHTML = slice.map(r => {
        const seri = String(r.uygunsuzlukSeri || '').trim();
        const esc  = seri.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
        const btn  = seri ? `<button class="btn-8d-link" onclick="open8DForRow('${esc}')">üìã 8D</button>` : '';
        return `<tr>${
            TABLE_COLS.map(k => {
                let v = r[k];
                if (k === 'hataliMiktar' && v > 0) return `<td><span class="badge badge-red">${Number(v).toLocaleString('tr', {maximumFractionDigits:2})}</span></td>`;
                if (k === 'kontrolMiktar' && v > 0) return `<td><span class="badge badge-blue">${Number(v).toLocaleString('tr', {maximumFractionDigits:2})}</span></td>`;
                return `<td>${v}</td>`;
            }).join('')
        }<td style="text-align:center;">${btn}</td></tr>`;
    }).join('') || `<tr><td colspan="${TABLE_COLS.length + 1}" style="text-align:center;color:#aaa;padding:30px;">Kayƒ±t bulunamadƒ±</td></tr>`;

    renderPagination(pages, display);
}

function open8DForRow(seri) {
    const url = '8d-rapor.html?source=' + encodeURIComponent('Uygunsuzluk') + '&konu=' + encodeURIComponent(seri);
    window.open(url, '_blank');
}

function sortTable(idx) {
    if (sortCol === idx) sortAsc = !sortAsc;
    else { sortCol = idx; sortAsc = true; }
    currentPage = 1;
    renderTable();
}

function onTableSearch() {
    currentPage = 1;
    renderTable();
}

function renderPagination(pages, display) {
    const pg = document.getElementById('pagination');
    if (pages <= 1) { pg.innerHTML = ''; return; }
    const btns = [];
    btns.push(`<button class="page-btn" onclick="goPage(1)">¬´</button>`);
    const from = Math.max(1, currentPage - 2);
    const to   = Math.min(pages, currentPage + 2);
    if (from > 1) btns.push('<span style="padding:6px 4px;color:#aaa">‚Ä¶</span>');
    for (let i = from; i <= to; i++) {
        btns.push(`<button class="page-btn${i === currentPage ? ' active' : ''}" onclick="goPage(${i})">${i}</button>`);
    }
    if (to < pages) btns.push('<span style="padding:6px 4px;color:#aaa">‚Ä¶</span>');
    btns.push(`<button class="page-btn" onclick="goPage(${pages})">¬ª</button>`);
    pg.innerHTML = btns.join('');
}

function goPage(p) { currentPage = p; renderTable(); }

// ‚îÄ‚îÄ‚îÄ Export Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportTableExcel() {
    const header = TABLE_COLS.map(k => COL_LABELS[k]);
    const rows   = filteredData.map(r => TABLE_COLS.map(k => r[k]));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
    XLSX.utils.book_append_sheet(wb, ws, 'Uygunsuzluk');
    XLSX.writeFile(wb, 'uygunsuzluk-analizi.xlsx');
    showToast('Excel indirildi!', 'success');
}

// ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name) {
    const names = ['pareto', 'breakdown', 'table', 'radar', 'heatmap'];
    document.querySelectorAll('.tab-btn').forEach((b, i) => {
        b.classList.toggle('active', names[i] === name);
    });
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    if (name === 'pareto' && paretoChartInst) paretoChartInst.resize();
    if (name === 'radar')   { radarBuildSelector(); }
    if (name === 'heatmap') { renderHeatmap(); }
}

// ‚îÄ‚îÄ‚îÄ RADAR ANALƒ∞Zƒ∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const RADAR_PALETTE = [
    '#7c3aed','#db2777','#0891b2','#16a34a','#ea580c',
    '#9333ea','#0f766e','#b45309','#be123c','#1d4ed8',
];

function _radarField(row, key) {
    const map = {
        cariAdi: row.cariAdi || row['Cari Adƒ±'] || '‚Äî',
        hataTipi: row.hataTipi || row['Hata Tipi'] || '‚Äî',
        hataKaynagi: row.hataKaynagi || row['Hata Kaynaƒüƒ±'] || '‚Äî',
        tespitYeri: row.tespitYeri || row['Tespit Yeri'] || '‚Äî',
        stokAdi: row.stokAdi || row['Stok Adƒ±'] || '‚Äî',
        uygunsuzlukTuru: row.uygunsuzlukTuru || row['Uygunsuzluk T√ºr√º'] || '‚Äî',
    };
    return (map[key] || '‚Äî').toString().trim() || '‚Äî';
}

function _radarMetricVal(row, metric) {
    if (metric === 'hataliMiktar') return parseFloat(row.hataliMiktar || row['Hatalƒ± Miktar'] || 0) || 0;
    return 1; // kayƒ±t sayƒ±sƒ±: her satƒ±r 1
}

// T√ºm veriyi pivot'la: { [groupVal]: { [axisVal]: number } }
function _radarPivot(data, groupKey, axisKey, metric) {
    const pivot = {};
    data.forEach(row => {
        const g = _radarField(row, groupKey);
        const a = _radarField(row, axisKey);
        const v = _radarMetricVal(row, metric);
        if (!pivot[g]) pivot[g] = {};
        pivot[g][a] = (pivot[g][a] || 0) + v;
    });
    return pivot;
}

// Top N eksen (t√ºm datadan aggregate)
function _radarTopAxes(data, axisKey, metric, topN) {
    const totals = {};
    data.forEach(row => {
        const a = _radarField(row, axisKey);
        totals[a] = (totals[a] || 0) + _radarMetricVal(row, metric);
    });
    return Object.entries(totals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, topN)
        .map(e => e[0]);
}

// Top N gruplar (t√ºm datadan)
function _radarTopGroups(data, groupKey, metric, topN) {
    const totals = {};
    data.forEach(row => {
        const g = _radarField(row, groupKey);
        totals[g] = (totals[g] || 0) + _radarMetricVal(row, metric);
    });
    return Object.entries(totals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, topN)
        .map(e => ({ label: e[0], total: e[1] }));
}

function radarBuildSelector() {
    if (!filteredData.length) return;
    const groupKey = document.getElementById('radarGroupBy').value;
    const metric   = document.getElementById('radarMetric').value;
    const top20    = _radarTopGroups(filteredData, groupKey, metric, 20);

    // Sync selected: keep existing selections that are still valid
    const validLabels = new Set(top20.map(g => g.label));
    _radarSelected.forEach(s => { if (!validLabels.has(s)) _radarSelected.delete(s); });

    // Auto-select top 5 if nothing selected
    if (_radarSelected.size === 0) {
        top20.slice(0, 5).forEach(g => _radarSelected.add(g.label));
    }

    const list = document.getElementById('radarGroupList');
    const maxVal = top20[0]?.total || 1;

    list.innerHTML = top20.map(g => {
        const pct = Math.round((g.total / maxVal) * 100);
        const sel = _radarSelected.has(g.label);
        return `<div class="radar-group-item ${sel ? 'rgi-selected' : ''}" onclick="_radarToggle(this,'${g.label.replace(/'/g,"\\'")}')" >
            <input type="checkbox" ${sel ? 'checked' : ''} onclick="event.stopPropagation()">
            <span class="radar-color-dot" style="background:${RADAR_PALETTE[top20.indexOf(g) % RADAR_PALETTE.length]};"></span>
            <span class="rgi-label" title="${g.label}">${g.label}</span>
            <span class="rgi-val">${g.total.toLocaleString('tr-TR',{maximumFractionDigits:0})} (${pct}%)</span>
        </div>`;
    }).join('');

    document.getElementById('radarSelHint').textContent = `Se√ßili: ${_radarSelected.size}`;
    renderRadar();
}

function _radarToggle(el, label) {
    if (_radarSelected.has(label)) {
        _radarSelected.delete(label);
        el.classList.remove('rgi-selected');
        el.querySelector('input').checked = false;
    } else {
        _radarSelected.add(label);
        el.classList.add('rgi-selected');
        el.querySelector('input').checked = true;
    }
    document.getElementById('radarSelHint').textContent = `Se√ßili: ${_radarSelected.size}`;
    renderRadar();
}

function radarSelectAll() {
    document.querySelectorAll('.radar-group-item').forEach(el => {
        const label = el.querySelector('.rgi-label').title;
        _radarSelected.add(label);
        el.classList.add('rgi-selected');
        el.querySelector('input').checked = true;
    });
    document.getElementById('radarSelHint').textContent = `Se√ßili: ${_radarSelected.size}`;
    renderRadar();
}

function radarSelectTop5() {
    _radarSelected.clear();
    let i = 0;
    document.querySelectorAll('.radar-group-item').forEach(el => {
        const label = el.querySelector('.rgi-label').title;
        if (i++ < 5) {
            _radarSelected.add(label);
            el.classList.add('rgi-selected');
            el.querySelector('input').checked = true;
        } else {
            el.classList.remove('rgi-selected');
            el.querySelector('input').checked = false;
        }
    });
    document.getElementById('radarSelHint').textContent = `Se√ßili: ${_radarSelected.size}`;
    renderRadar();
}

function radarClearAll() {
    _radarSelected.clear();
    document.querySelectorAll('.radar-group-item').forEach(el => {
        el.classList.remove('rgi-selected');
        el.querySelector('input').checked = false;
    });
    document.getElementById('radarSelHint').textContent = 'Se√ßili: 0';
    renderRadar();
}

function renderRadar() {
    const groupKey  = document.getElementById('radarGroupBy').value;
    const axisKey   = document.getElementById('radarAxesBy').value;
    const metric    = document.getElementById('radarMetric').value;
    const axesTop   = parseInt(document.getElementById('radarAxesTop').value);
    const normalize = document.getElementById('radarNorm').value === '1';

    const noDataEl  = document.getElementById('radarNoData');
    const wrapEl    = document.getElementById('radarChartWrap');
    const insightEl = document.getElementById('radarInsight');

    if (!filteredData.length || _radarSelected.size < 2) {
        noDataEl.style.display = 'block';
        wrapEl.style.display   = 'none';
        insightEl.style.display = 'none';
        return;
    }

    const selectedGroups = [..._radarSelected];
    const axes    = _radarTopAxes(filteredData, axisKey, metric, axesTop);

    if (axes.length < 2) {
        noDataEl.style.display  = 'block';
        wrapEl.style.display    = 'none';
        insightEl.style.display = 'none';
        return;
    }

    noDataEl.style.display = 'none';
    wrapEl.style.display   = 'block';

    const pivot = _radarPivot(filteredData, groupKey, axisKey, metric);

    // For each axis, find the max across all selected groups (for normalization)
    const axisMax = {};
    axes.forEach(ax => {
        axisMax[ax] = Math.max(1, ...selectedGroups.map(g => pivot[g]?.[ax] || 0));
    });

    const datasets = selectedGroups.map((g, i) => {
        const color = RADAR_PALETTE[i % RADAR_PALETTE.length];
        const rawVals = axes.map(ax => pivot[g]?.[ax] || 0);
        const vals = normalize
            ? axes.map(ax => axisMax[ax] > 0 ? Math.round((pivot[g]?.[ax] || 0) / axisMax[ax] * 100) : 0)
            : rawVals;
        return {
            label: g,
            data: vals,
            backgroundColor: color + '22',
            borderColor: color,
            borderWidth: 2.2,
            pointBackgroundColor: color,
            pointRadius: 4,
            pointHoverRadius: 6,
            _rawVals: rawVals,
        };
    });

    if (radarChartInst) { radarChartInst.destroy(); radarChartInst = null; }

    const ctx = document.getElementById('radarChart').getContext('2d');
    radarChartInst = new Chart(ctx, {
        type: 'radar',
        data: { labels: axes, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { font: { size: 12 }, padding: 14 } },
                tooltip: {
                    callbacks: {
                        label(ctx) {
                            const raw = ctx.dataset._rawVals?.[ctx.dataIndex];
                            const suffix = normalize ? ` (${ctx.raw}%)` : '';
                            const fmt = typeof raw === 'number'
                                ? raw.toLocaleString('tr-TR', { maximumFractionDigits: 1 })
                                : raw;
                            return ` ${ctx.dataset.label}: ${fmt}${suffix}`;
                        }
                    }
                }
            },
            scales: {
                r: {
                    min: 0,
                    max: normalize ? 100 : undefined,
                    ticks: {
                        stepSize: normalize ? 20 : undefined,
                        font: { size: 10 },
                        backdropColor: 'transparent',
                        callback: v => normalize ? v + '%' : v.toLocaleString('tr-TR', { maximumFractionDigits: 0 }),
                    },
                    pointLabels: { font: { size: 11 }, color: '#374151' },
                    grid: { color: '#e5e7eb' },
                    angleLines: { color: '#e5e7eb' },
                }
            }
        }
    });

    // Insight: find the strongest group per axis
    const insights = [];
    axes.forEach(ax => {
        let best = null, bestVal = -1;
        selectedGroups.forEach(g => {
            const v = pivot[g]?.[ax] || 0;
            if (v > bestVal) { bestVal = v; best = g; }
        });
        if (best && bestVal > 0) {
            insights.push(`<b>${ax}</b> ekseninde en y√ºksek: <b>${best}</b> (${bestVal.toLocaleString('tr-TR',{maximumFractionDigits:1})})`);
        }
    });

    insightEl.style.display = insights.length ? 'block' : 'none';
    insightEl.innerHTML = 'üîé <b>Radar √ñng√∂r√ºleri:</b> ' + insights.join(' &nbsp;|&nbsp; ');
}

function downloadRadarPNG() {
    const canvas = document.getElementById('radarChart');
    if (!canvas) return;
    const link = document.createElement('a');
    link.download = 'radar-analiz.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}

// ‚îÄ‚îÄ‚îÄ ISI HARƒ∞TASI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const HM_SCALES = {
    blue:   ['#dbeafe','#93c5fd','#3b82f6','#1d4ed8','#1e3a8a'],
    red:    ['#fee2e2','#fca5a5','#ef4444','#b91c1c','#7f1d1d'],
    green:  ['#dcfce7','#86efac','#22c55e','#15803d','#14532d'],
    purple: ['#f3e8ff','#d8b4fe','#a855f7','#7e22ce','#3b0764'],
    orange: ['#ffedd5','#fdba74','#f97316','#c2410c','#7c2d12'],
};

function renderHeatmap() {
    const wrap     = document.getElementById('hmTableWrap');
    const insightEl= document.getElementById('hmInsight');
    if (!wrap) return;

    if (!filteredData || !filteredData.length) {
        wrap.innerHTML = '<p style="color:#aaa;padding:20px;">Veri yok ‚Äî √∂nce filtre uygulayƒ±n.</p>';
        if (insightEl) insightEl.style.display = 'none';
        return;
    }

    const rowKey    = document.getElementById('hmRowBy').value;
    const colKey    = document.getElementById('hmColBy').value;
    const metric    = document.getElementById('hmMetric').value;
    const topRow    = parseInt(document.getElementById('hmTopRow').value)  || 15;
    const topCol    = parseInt(document.getElementById('hmTopCol').value)  || 12;
    const scaleName = document.getElementById('hmColorScale').value        || 'blue';
    const showVal   = document.getElementById('hmShowVal').value === '1';
    const scale     = HM_SCALES[scaleName] || HM_SCALES.blue;

    if (rowKey === colKey) {
        wrap.innerHTML = '<p style="color:#e11d48;padding:20px;">‚ö†Ô∏è Satƒ±r ve S√ºtun aynƒ± alan olamaz ‚Äî l√ºtfen farklƒ± iki alan se√ßin.</p>';
        if (insightEl) insightEl.style.display = 'none';
        return;
    }

    // ‚îÄ‚îÄ Veriyi pivot'a √ßevir ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const rowTotals = {};
    const colTotals = {};
    const cell      = {};

    filteredData.forEach(r => {
        const rv = _hmGet(r, rowKey);
        const cv = _hmGet(r, colKey);
        const v  = metric === 'hataliMiktar'
            ? (parseFloat(r.hataliMiktar) || 0)
            : 1;
        rowTotals[rv] = (rowTotals[rv] || 0) + v;
        colTotals[cv] = (colTotals[cv] || 0) + v;
        if (!cell[rv]) cell[rv] = {};
        cell[rv][cv]  = (cell[rv][cv] || 0) + v;
    });

    const rows = Object.entries(rowTotals)
        .filter(e => e[0] !== '‚Äî' && e[0] !== '')
        .sort((a,b) => b[1]-a[1]).slice(0, topRow).map(e => e[0]);
    const cols = Object.entries(colTotals)
        .filter(e => e[0] !== '‚Äî' && e[0] !== '')
        .sort((a,b) => b[1]-a[1]).slice(0, topCol).map(e => e[0]);

    if (!rows.length || !cols.length) {
        wrap.innerHTML = '<p style="color:#aaa;padding:20px;">Bu kombinasyon i√ßin yeterli veri yok ‚Äî farklƒ± alanlar deneyin.</p>';
        if (insightEl) insightEl.style.display = 'none';
        return;
    }

    // ‚îÄ‚îÄ Global maks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let globalMax = 0;
    rows.forEach(r => cols.forEach(c => {
        const v = cell[r]?.[c] || 0;
        if (v > globalMax) globalMax = v;
    }));

    // ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const barEl = document.getElementById('hmLegendBar');
    const maxEl = document.getElementById('hmLegendMax');
    if (barEl) barEl.style.background = `linear-gradient(to right,${scale[0]},${scale[scale.length-1]})`;
    if (maxEl) maxEl.textContent = `Maks: ${globalMax.toLocaleString('tr-TR',{maximumFractionDigits:1})}`;

    const fmt  = v => v === 0 ? '' : v.toLocaleString('tr-TR', {maximumFractionDigits:1});
    const tr26 = (s, n=24) => String(s).length > n ? String(s).slice(0,n-1)+'‚Ä¶' : String(s);
    const tr16 = (s, n=15) => String(s).length > n ? String(s).slice(0,n-1)+'‚Ä¶' : String(s);

    // Koyu/a√ßƒ±k renk i√ßin luminans hesapla (CSS renkler)
    const luminance = (r, g, b) => (0.299*r + 0.587*g + 0.114*b);
    function textColor(cssColor) {
        // cssColor can be '#rrggbb' or 'rgb(r,g,b)'
        let r=255,g=255,b=255;
        if (cssColor.startsWith('#')) {
            r = parseInt(cssColor.slice(1,3),16);
            g = parseInt(cssColor.slice(3,5),16);
            b = parseInt(cssColor.slice(5,7),16);
        } else {
            const m = cssColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (m) { r=+m[1]; g=+m[2]; b=+m[3]; }
        }
        return luminance(r,g,b) > 145 ? '#1e293b' : '#ffffff';
    }
    function cellBg(v) {
        if (v <= 0 || globalMax === 0) return '#f8fafc';
        const t   = v / globalMax;
        const pos = t * (scale.length - 1);
        const lo  = Math.floor(pos);
        const hi  = Math.min(scale.length-1, lo+1);
        const f   = pos - lo;
        // hex interpolation
        const ph  = h => parseInt(h.slice(1,3),16);
        const rs  = [1,3,5].map(i => {
            const a = parseInt(scale[lo].slice(i,i+2),16);
            const b = parseInt(scale[hi].slice(i,i+2),16);
            return Math.round(a + (b-a)*f).toString(16).padStart(2,'0');
        });
        return '#' + rs.join('');
    }

    // ‚îÄ‚îÄ Tablo HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const FIELD_LABELS = {
        cariAdi:'Cari Adƒ±', hataTipi:'Hata Tipi', hataKaynagi:'Hata Kaynaƒüƒ±',
        tespitYeri:'Tespit Yeri', stokAdi:'Stok Adƒ±', uygunsuzlukTuru:'Uyg. T√ºr√º'
    };

    let html = `<table class="hm-table"><thead><tr>
        <th class="hm-row-hdr">${FIELD_LABELS[rowKey]||rowKey} \\ ${FIELD_LABELS[colKey]||colKey}</th>`;
    cols.forEach(c => { html += `<th title="${c}">${tr16(c)}</th>`; });
    html += '<th class="hm-total-col" style="min-width:72px;">Toplam</th></tr></thead><tbody>';

    rows.forEach(r => {
        const rowTotal = rowTotals[r] || 0;
        html += '<tr>';
        html += `<td title="${r}" style="font-weight:600;color:#334155;">${tr26(r)}</td>`;
        cols.forEach(c => {
            const v   = cell[r]?.[c] || 0;
            const bg  = cellBg(v);
            const fg  = textColor(bg);
            const tip = `${r} √ó ${c}: ${v ? v.toLocaleString('tr-TR',{maximumFractionDigits:1}) : '0'}`;
            html += `<td title="${tip}" style="background:${bg};color:${fg};text-align:center;">`;
            if (showVal && v > 0) html += `<span class="hm-cell-val">${fmt(v)}</span>`;
            html += '</td>';
        });
        html += `<td class="hm-total-col" style="text-align:right;">${fmt(rowTotal)||'0'}</td></tr>`;
    });

    // Toplam satƒ±rƒ±
    html += '<tr class="hm-total-row"><td><b>Toplam</b></td>';
    cols.forEach(c => {
        html += `<td style="text-align:center;">${fmt(colTotals[c]||0)||'0'}</td>`;
    });
    const grand = Object.values(rowTotals)
        .reduce((a,b)=>a+b,0);
    html += `<td style="text-align:right;"><b>${fmt(grand)||'0'}</b></td></tr>`;
    html += '</tbody></table>';
    wrap.innerHTML = html;

    // ‚îÄ‚îÄ √ñng√∂r√ºler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let hotR='', hotC='', hotV=0;
    rows.forEach(r => cols.forEach(c => {
        const v = cell[r]?.[c]||0;
        if (v > hotV) { hotV=v; hotR=r; hotC=c; }
    }));
    let spreadR='', spreadN=0;
    rows.forEach(r => {
        const n = cols.filter(c=>(cell[r]?.[c]||0)>0).length;
        if (n > spreadN) { spreadN=n; spreadR=r; }
    });
    const parts = [];
    if (hotV > 0) parts.push(`üî¥ <b>En sƒ±cak nokta:</b> ${hotR} √ó ${hotC} (${fmt(hotV)})`);
    if (spreadR)  parts.push(`üìä <b>En geni≈ü daƒüƒ±lƒ±m:</b> ${spreadR} ‚Äî ${spreadN} farklƒ± kategori`);
    if (insightEl) {
        insightEl.innerHTML = parts.join(' &nbsp;|&nbsp; ');
        insightEl.style.display = parts.length ? 'block' : 'none';
    }
}

// Basit, g√ºvenli alan okuyucu (t√ºm olasƒ± key formatlarƒ±nƒ± dener)
function _hmGet(row, key) {
    const direct = row[key];
    if (direct && direct !== '') return String(direct).trim();
    // camelCase ‚Üí fallback haritasƒ±
    const alt = {
        cariAdi:         row['Cari Adƒ±']         || row['cari_adi']       || '',
        hataTipi:        row['Hata Tipi']         || row['hata_tipi']      || '',
        hataKaynagi:     row['Hata Kaynaƒüƒ±']      || row['hata_kaynagi']   || '',
        tespitYeri:      row['Tespit Yeri']       || row['tespit_yeri']    || '',
        stokAdi:         row['Stok Adƒ±']          || row['stok_adi']       || '',
        uygunsuzlukTuru: row['Uygunsuzluk T√ºr√º']  || row['uyg_turu']       || '',
    };
    const v = alt[key] || '';
    return String(v).trim() || '(Belirtilmemi≈ü)';
}

// ‚îÄ‚îÄ‚îÄ LocalStorage Persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ IndexedDB Persistence (localStorage'dan √ßok daha b√ºy√ºk limit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DB_NAME    = 'UygunsuzlukDB';
const DB_VERSION = 1;
const STORE_NAME = 'cache';
let _db = null;

function openDB() {
    return new Promise((resolve, reject) => {
        if (_db) { resolve(_db); return; }
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
            e.target.result.createObjectStore(STORE_NAME);
        };
        req.onsuccess = e => { _db = e.target.result; resolve(_db); };
        req.onerror   = e => reject(e.target.error);
    });
}

function dbSet(key, value) {
    return openDB().then(db => new Promise((resolve, reject) => {
        const tx  = db.transaction(STORE_NAME, 'readwrite');
        const req = tx.objectStore(STORE_NAME).put(value, key);
        req.onsuccess = () => resolve();
        req.onerror   = e => reject(e.target.error);
    }));
}

function dbGet(key) {
    return openDB().then(db => new Promise((resolve, reject) => {
        const tx  = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = e => resolve(e.target.result);
        req.onerror   = e => reject(e.target.error);
    }));
}

function dbDelete(key) {
    return openDB().then(db => new Promise((resolve, reject) => {
        const tx  = db.transaction(STORE_NAME, 'readwrite');
        const req = tx.objectStore(STORE_NAME).delete(key);
        req.onsuccess = () => resolve();
        req.onerror   = e => reject(e.target.error);
    }));
}

function saveToStorage(fileName, sheetName) {
    showLoading(true);
    Promise.all([
        dbSet('data', allData),
        dbSet('meta', { fileName, sheetName, savedAt: new Date().toISOString() })
    ]).then(() => {
        showLoading(false);
    }).catch(err => {
        showLoading(false);
        showToast('Veri hafƒ±zaya kaydedilemedi: ' + err.message, 'error');
    });
}

function loadFromStorage() {
    // √ñnce localStorage'dan musteriSet y√ºkle (hƒ±zlƒ±)
    try {
        const ls = localStorage.getItem('uyg_musteriSet');
        if (ls) musteriSet = new Set(JSON.parse(ls));
    } catch(e) {}

    Promise.all([dbGet('meta'), dbGet('data'), dbGet('musteriSet')]).then(([meta, data, mSet]) => {
        // IndexedDB'de varsa ve localStorage'dan daha b√ºy√ºkse onu kullan
        if (mSet && Array.isArray(mSet) && mSet.length > musteriSet.size) {
            musteriSet = new Set(mSet);
            try { localStorage.setItem('uyg_musteriSet', JSON.stringify(mSet)); } catch(e) {}
        }
        if (!meta || !data || !data.length) return;
        allData       = data;
        filteredData  = [...allData];
        const savedAt = new Date(meta.savedAt).toLocaleString('tr-TR');
        showFileInfo(meta.fileName, meta.sheetName, allData.length, savedAt);
        initUI();
        showToast(`Hafƒ±zadan y√ºklendi: ${allData.length} kayƒ±t`, 'success');
    }).catch(() => { /* hi√ß kayƒ±t yok */ });
}

function clearStorage() {
    Promise.all([dbDelete('data'), dbDelete('meta')]).then(() => {
        allData = []; filteredData = []; tableSearchData = [];
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('statsRow').style.display = 'none';
        document.getElementById('filterCard').style.display = 'none';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        if (paretoChartInst) { paretoChartInst.destroy(); paretoChartInst = null; }
        showToast('Hafƒ±za temizlendi. Yeni dosya y√ºkleyebilirsiniz.');
    });
}

function showFileInfo(fileName, sheetName, count, fromCache) {
    const el = document.getElementById('fileInfo');
    el.style.display = 'block';
    const cacheNote = fromCache
        ? ` &nbsp;<span style="color:#7b2d8b;font-size:0.85em">(üíæ ${fromCache} tarihinde kaydedildi)</span>`
        : '';
    el.innerHTML = `‚úÖ <strong>${fileName}</strong> ‚Äî <strong>${count}</strong> kayƒ±t, sayfa: <strong>${sheetName}</strong>${cacheNote}
        &nbsp;&nbsp;<button onclick="clearStorage()" style="background:#fff0f8;border:1.2px solid #b94fc4;color:#7b2d8b;padding:3px 10px;border-radius:6px;cursor:pointer;font-size:0.82em;font-weight:600;" title="Hafƒ±zayƒ± temizle ve yeni dosya y√ºkle">üóë Temizle</button>`;
}

document.addEventListener('DOMContentLoaded', loadFromStorage);
document.addEventListener('click', e => {
    if (e.target.id === 'uaSnapModal')  document.getElementById('uaSnapModal').classList.remove('open');
    if (e.target.id === 'uaFiltreModal') document.getElementById('uaFiltreModal').classList.remove('open');
});

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('show', show);
}

function showToast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show' + (type ? ' ' + type : '');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 3200);
}

// ‚îÄ‚îÄ‚îÄ √áoklu Analiz ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMultiAnalyze() {
    multiAnalyzeMode = !multiAnalyzeMode;
    selectedForMulti.clear();
    const btn = document.getElementById('multiAnalyzeToggleBtn');
    const bar = document.getElementById('multiAnalyzeBar');
    if (multiAnalyzeMode) {
        btn.style.background = '#1a6b5a'; btn.style.color = 'white';
        btn.textContent = '‚úñ Kapat';
        if (bar) bar.style.display = 'flex';
    } else {
        btn.style.background = '#e8f5f1'; btn.style.color = '#1a6b5a';
        btn.textContent = 'üìä √áoklu Analiz';
        if (bar) bar.style.display = 'none';
    }
    renderBreakdown();
}

function toggleMultiSelect(hataTipi) {
    if (!multiAnalyzeMode) return;
    if (selectedForMulti.has(hataTipi)) selectedForMulti.delete(hataTipi);
    else selectedForMulti.add(hataTipi);
    const safeId = 'bdi-' + btoa(encodeURIComponent(hataTipi)).replace(/=/g,'');
    const card = document.getElementById(safeId);
    if (card) card.classList.toggle('selected-for-multi', selectedForMulti.has(hataTipi));
    const cnt = document.getElementById('multiAnalyzeCount');
    if (cnt) cnt.textContent = selectedForMulti.size;
}

function openFishboneMulti() {
    if (!selectedForMulti.size) { showToast('En az 1 hata tipi se√ßin', 'error'); return; }
    const selected = [...selectedForMulti];
    const relRows = filteredData.filter(r => selected.includes(r.hataTipi));
    const BONE_COLORS = ['#ef4444','#f59e0b','#3b82f6','#8b5cf6','#06b6d4','#22c55e'];
    let _nid = 1; const mkId = () => _nid++;
    const mkChildren = (vals, color) => vals.map(v => ({id:mkId(),name:v,color,children:[],collapsed:false,offsetX:0,offsetY:0}));
    // 6M ana kemikler ‚Äî se√ßili hata tiplerinin toplu verisi
    const bonesConfig = [
        {name:'üë§ ƒ∞nsan',    desc:'Hata kaynaƒüƒ± analizi',        color:BONE_COLORS[0], side:'top',    field:'hataKaynagi'},
        {name:'‚öôÔ∏è Makine',   desc:'Makine / ekipman',             color:BONE_COLORS[1], side:'bottom', field:'makine'},
        {name:'üì¶ Malzeme',  desc:`Hata tipleri: ${selected.join(', ')}`, color:BONE_COLORS[2], side:'top', field:'hataTipi'},
        {name:'üìã Metot',    desc:'Uygunsuzluk t√ºr√º',            color:BONE_COLORS[3], side:'bottom', field:'uygunsuzlukTuru'},
        {name:'üìê √ñl√ß√ºm',   desc:'Uygunsuzluk tipi',            color:BONE_COLORS[4], side:'top',    field:'tipi'},
        {name:'üå°Ô∏è Ortam',   desc:'(Manuel doldurun)',           color:BONE_COLORS[5], side:'bottom', field:null},
    ];
    const causes = bonesConfig.map(b => ({
        id:mkId(), name:b.name, description:b.desc,
        color:b.color, side:b.side, collapsed:false,
        children: b.field ? mkChildren(topNField(relRows, b.field, 5), b.color) : [],
        offsetX:0, offsetY:0, baseOffsetX:0, baseOffsetY:0
    }));
    const total = relRows.reduce((s,r)=>s+(Number(r.hataliMiktar)||0),0);
    localStorage.setItem('fishbone_incoming', JSON.stringify({
        problem: `√áoklu Hata Analizi (${selected.length} tip)`,
        problemDesc: `Se√ßili hata tipleri: ${selected.join(', ')}\n‚Ä¢ Toplam hatalƒ±: ${total.toLocaleString('tr',{maximumFractionDigits:1})}\nKaynak: Uygunsuzluk Analizi`,
        source:'uygunsuzluk-analizi', causes, nextId:_nid
    }));
    localStorage.setItem('fishbone_source', 'uygunsuzluk-analizi');
    window.open('balik-kilcigi.html','_blank');
}
</script>

<div id="uaSnapModal">
    <div id="uaSnapBox">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
            <h3>üìÅ Kayƒ±tlƒ± Kapsamlƒ± Raporlar</h3>
            <button onclick="document.getElementById('uaSnapModal').classList.remove('open')" style="margin-left:auto;background:#f1f5f9;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:.82rem;font-weight:600;">‚úï Kapat</button>
        </div>
        <div id="uaSnapList"></div>
    </div>
</div>

<div id="uaFiltreModal">
    <div id="uaFiltreBox">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
            <h3>üìÇ Kayƒ±tlƒ± Filtreler</h3>
            <button onclick="document.getElementById('uaFiltreModal').classList.remove('open')" style="margin-left:auto;background:#f1f5f9;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:.82rem;font-weight:600;">‚úï Kapat</button>
        </div>
        <div id="uaFiltreList"></div>
    </div>
</div>

<!-- √áoklu Analiz Alt Barƒ± -->
<div id="multiAnalyzeBar" class="multi-analyze-bar" style="display:none;">
    <div><span id="multiAnalyzeCount">0</span> hata tipi se√ßildi &mdash; kartlara tƒ±klayarak se√ßin</div>
    <div style="display:flex;gap:10px;">
        <button onclick="openFishboneMulti()">üêü Fishbone'a G√∂nder</button>
        <button class="multi-cancel-btn" onclick="toggleMultiAnalyze()">ƒ∞ptal</button>
    </div>
</div>
</body>
</html>
