<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>5 Neden Analizi â€“ Technical &amp; Systemic</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column}

/* â”€â”€ HEADER â”€â”€ */
.hdr{background:#1e293b;border-bottom:1px solid #334155;padding:12px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.hdr-title{font-size:1.05rem;font-weight:700;color:#f1f5f9;white-space:nowrap;line-height:1.3}
.hdr-title small{display:block;font-size:.68rem;font-weight:400;color:#64748b}
.hdr-meta{display:flex;gap:8px;flex:1;flex-wrap:wrap}
.hdr-meta input{background:#0f172a;border:1px solid #334155;color:#cbd5e1;border-radius:6px;padding:5px 10px;font-size:.82rem;width:140px}
.hdr-meta input::placeholder{color:#475569}
.hdr-actions{display:flex;gap:8px}
.btn-hdr{padding:6px 14px;border-radius:7px;border:none;cursor:pointer;font-size:.82rem;font-weight:600;transition:all .15s}
.btn-save{background:#1d4ed8;color:#fff}.btn-save:hover{background:#2563eb}
.btn-ai-main{background:#7c3aed;color:#fff}.btn-ai-main:hover{background:#8b5cf6}

/* â”€â”€ TABS â”€â”€ */
.tabs-bar{background:#1e293b;display:flex;gap:4px;padding:0 20px;border-bottom:2px solid #1e3a5f}
.tab-btn{padding:11px 22px;border:none;background:none;color:#64748b;font-size:.88rem;font-weight:600;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;margin-bottom:-2px;display:flex;align-items:center;gap:8px}
.tab-btn.tech.active{color:#38bdf8;border-bottom-color:#38bdf8;background:#0c4a6e22}
.tab-btn.sys.active{color:#a78bfa;border-bottom-color:#a78bfa;background:#2e106522}
.tab-btn:not(.active):hover{color:#94a3b8}
.badge{font-size:.65rem;border-radius:10px;padding:2px 7px;font-weight:700}
.badge.tech{background:#0c4a6e;color:#38bdf8}
.badge.sys{background:#2e1065;color:#a78bfa}
.tab-desc{font-size:.7rem;color:#475569;font-weight:400}

/* â”€â”€ TRACK PANEL â”€â”€ */
.track-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.track-panel.active{display:flex}

/* â”€â”€ TRACK TOOLBAR â”€â”€ */
.track-toolbar{background:#162032;padding:8px 16px;display:flex;gap:8px;align-items:center;border-bottom:1px solid #1e3a5f;flex-wrap:wrap;flex-shrink:0}
.track-lbl{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;margin-right:4px}
.track-lbl.tech{color:#38bdf8}
.track-lbl.sys{color:#a78bfa}
.btn-tb{padding:5px 12px;border-radius:6px;border:none;cursor:pointer;font-size:.8rem;font-weight:600;transition:all .15s}
.btn-add-tech{background:#0c4a6e;color:#7dd3fc}.btn-add-tech:hover{background:#0369a1}
.btn-add-sys{background:#2e1065;color:#c4b5fd}.btn-add-sys:hover{background:#5b21b6}
.btn-yenile{position:relative;overflow:hidden;padding:5px 14px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#64748b;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;min-width:110px}
.btn-yenile:hover{border-color:#475569;color:#94a3b8}
.btn-yenile.tech::after{content:'';position:absolute;inset:0;background:#38bdf8;opacity:.15;width:var(--prog,0%);transition:width .4s linear;pointer-events:none}
.btn-yenile.sys::after{content:'';position:absolute;inset:0;background:#a78bfa;opacity:.15;width:var(--prog,0%);transition:width .4s linear;pointer-events:none}
.toolbar-hint{margin-left:auto;font-size:.7rem;color:#334155}

/* â”€â”€ CANVAS â”€â”€ */
.canvas-wrap{flex:1;overflow:auto;padding:24px;background:#0f172a;position:relative}
.canvas-inner{position:relative}
.c-svg{position:absolute;left:0;top:0;overflow:visible;pointer-events:none}

/* â”€â”€ BOXES â”€â”€ */
.prob-box,.step-box,.rcb-box{position:absolute;border-radius:10px;display:flex;flex-direction:column}

.prob-box{width:170px;background:#162032;border:2px solid #334155;padding:8px}
.prob-box.tech{border-color:#0369a1}
.prob-box.sys{border-color:#5b21b6}
.prob-lbl{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.prob-box.tech .prob-lbl{color:#38bdf8}
.prob-box.sys .prob-lbl{color:#a78bfa}
.prob-box textarea{background:transparent;border:none;color:#e2e8f0;font-size:.82rem;font-weight:500;resize:none;outline:none;flex:1;line-height:1.45;width:100%}

.step-box{width:175px;background:#162032;border:2px solid #1e3a5f;padding:8px 8px 30px}
.step-box.tech{border-color:#1d4ed8}
.step-box.sys{border-color:#6d28d9}
.step-box.root.tech{border-color:#0ea5e9;box-shadow:0 0 14px #0ea5e940}
.step-box.root.sys{border-color:#8b5cf6;box-shadow:0 0 14px #8b5cf640}
.step-num{font-size:.6rem;font-weight:700;letter-spacing:.06em;margin-bottom:3px}
.step-box.tech .step-num{color:#38bdf8}
.step-box.sys .step-num{color:#a78bfa}
.step-box textarea{background:transparent;border:none;color:#f1f5f9;font-size:.83rem;font-weight:500;resize:none;outline:none;width:100%;line-height:1.4}
.step-actions{position:absolute;bottom:4px;left:5px;right:5px;display:flex;gap:3px;align-items:center}
.sb{padding:1px 5px;border-radius:4px;border:none;cursor:pointer;font-size:.67rem;font-weight:700;transition:all .12s;white-space:nowrap}
.sb-root-tech{background:#0c4a6e;color:#7dd3fc}
.sb-root-sys{background:#2e1065;color:#c4b5fd}
.sb-root-tech.on{background:#0284c7;color:#fff}
.sb-root-sys.on{background:#7c3aed;color:#fff}
.sb-del{background:#450a0a;color:#fca5a5}
.sb-fork{background:#064e3b;color:#6ee7b7;margin-left:auto}
.sb-add-tech{background:#0c2d4a;color:#93c5fd}
.sb-add-sys{background:#1e1040;color:#c4b5fd}

.rcb-box{width:158px;background:#0f172a;padding:9px;min-height:110px}
.rcb-box.tech{border:2px solid #0ea5e9;box-shadow:0 0 18px #0ea5e930}
.rcb-box.sys{border:2px solid #8b5cf6;box-shadow:0 0 18px #8b5cf630}
.rcb-lbl{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
.rcb-box.tech .rcb-lbl{color:#38bdf8}
.rcb-box.sys .rcb-lbl{color:#a78bfa}
.rcb-box textarea{background:transparent;border:none;color:#f1f5f9;font-size:.78rem;font-weight:600;resize:none;outline:none;width:100%;line-height:1.45}

/* â”€â”€ MODAL â”€â”€ */
.modal-bg{position:fixed;inset:0;background:#000000bb;display:none;align-items:center;justify-content:center;z-index:800}
.modal-bg.open{display:flex}
.modal{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:24px;width:530px;max-width:95vw;max-height:90vh;overflow-y:auto;position:relative}
.modal.tech{border-color:#0369a1;box-shadow:0 0 40px #0369a130}
.modal.sys{border-color:#6d28d9;box-shadow:0 0 40px #6d28d930}
.modal-close{position:absolute;top:11px;right:14px;background:none;border:none;color:#64748b;font-size:1.2rem;cursor:pointer;line-height:1}
.modal-close:hover{color:#f87171}
.modal-title{font-size:.98rem;font-weight:700;color:#f1f5f9;margin-bottom:14px}
.wiz-prog-bar{height:3px;background:#1e3a5f;border-radius:4px;margin-bottom:16px}
.wiz-prog-fill{height:100%;border-radius:4px;transition:width .3s}
.wiz-prog-fill.tech{background:linear-gradient(90deg,#0ea5e9,#38bdf8)}
.wiz-prog-fill.sys{background:linear-gradient(90deg,#7c3aed,#a78bfa)}
.wiz-step-lbl{font-size:.7rem;color:#475569;margin-bottom:6px;letter-spacing:.04em}
.wiz-q{font-size:.9rem;font-weight:600;color:#e2e8f0;margin-bottom:10px;line-height:1.4}
.wiz-inp{width:100%;background:#0f172a;border:1px solid #334155;color:#f1f5f9;border-radius:8px;padding:9px 12px;font-size:.87rem;resize:none;line-height:1.5;margin-bottom:12px}
.wiz-inp:focus{outline:none;border-color:#475569}
.wiz-opts{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.wiz-chip{padding:6px 16px;border-radius:20px;border:1.5px solid #334155;background:#0f172a;color:#64748b;font-size:.84rem;font-weight:600;cursor:pointer;transition:all .15s}
.wiz-chip.tech.sel{background:#0c4a6e;border-color:#38bdf8;color:#fff}
.wiz-chip.sys.sel{background:#4c1d95;border-color:#a78bfa;color:#fff}
.wiz-nav{display:flex;justify-content:space-between;margin-top:8px}
.btn-wiz{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;font-size:.86rem;font-weight:700}
.btn-wiz-back{background:#1e293b;color:#64748b;border:1px solid #334155}
.btn-wiz-back:hover{color:#94a3b8}
.btn-wiz-next.tech{background:#0369a1;color:#fff}
.btn-wiz-next.sys{background:#6d28d9;color:#fff}
.btn-wiz-next:hover{filter:brightness(1.15)}
.api-key-row{margin-top:16px;padding-top:12px;border-top:1px solid #1e3a5f}
.api-key-lbl{font-size:.7rem;color:#475569;margin-bottom:5px}
.api-key-inp{width:100%;background:#0f172a;border:1px solid #334155;color:#64748b;border-radius:6px;padding:6px 10px;font-size:.8rem}
.api-key-inp:focus{outline:none}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:20px;right:20px;background:#1e293b;border:1px solid #334155;color:#e2e8f0;padding:10px 18px;border-radius:10px;font-size:.84rem;transform:translateY(80px);opacity:0;transition:all .3s;z-index:9990;pointer-events:none;max-width:340px}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-color:#22c55e;color:#86efac}
.toast.err{border-color:#ef4444;color:#fca5a5}

/* â”€â”€ LEGEND â”€â”€ */
.legend{position:fixed;bottom:14px;left:14px;background:#1e293bcc;backdrop-filter:blur(6px);border:1px solid #334155;border-radius:8px;padding:8px 12px;font-size:.72rem;color:#475569;z-index:90;line-height:2}
.lc{font-weight:700}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-title">
    5 Neden Analizi
    <small>IATF 16949 / VDA 6.3 â€“ Technical &amp; Systemic</small>
  </div>
  <div class="hdr-meta">
    <input id="inPartNo" placeholder="ParÃ§a / ÃœrÃ¼n No" oninput="saveMeta()"/>
    <input id="inDefect" placeholder="Hata TanÄ±mÄ±" oninput="saveMeta()"/>
    <input id="inDate" type="date" oninput="saveMeta()"/>
  </div>
  <div class="hdr-actions">
    <button class="btn-hdr btn-ai-main" onclick="openWizard()">ğŸ¤– AI OluÅŸtur</button>
    <button class="btn-hdr btn-save" onclick="saveDB()">ğŸ’¾ Kaydet</button>
  </div>
</div>

<!-- TABS -->
<div class="tabs-bar">
  <button class="tab-btn tech active" onclick="switchTab('tech')">
    ğŸ”§ Technical Consideration
    <span class="badge tech">Teknik</span>
    <span class="tab-desc">Parametre Â· Makine Â· Malzeme Â· Ã–lÃ§Ã¼m</span>
  </button>
  <button class="tab-btn sys" onclick="switchTab('sys')">
    ğŸ›ï¸ Systemic Consideration
    <span class="badge sys">Sistemsel</span>
    <span class="tab-desc">Kontrol PlanÄ± Â· FMEA Â· ProsedÃ¼r Â· Denetim</span>
  </button>
</div>

<!-- TECH PANEL -->
<div id="panel-tech" class="track-panel active">
  <div class="track-toolbar">
    <span class="track-lbl tech">Teknik DeÄŸerlendirme</span>
    <button class="btn-tb btn-add-tech" onclick="addMainStep('tech')">+ AdÄ±m</button>
    <button class="btn-yenile tech" id="yenileTech" onclick="aiRefresh('tech')">ğŸ”„ Yenile</button>
    <span class="toolbar-hint">Hata nasÄ±l oluÅŸtu? â†’ Fiziksel / MÃ¼hendislik nedenler</span>
  </div>
  <div class="canvas-wrap" id="wrap-tech">
    <div class="canvas-inner" id="inner-tech">
      <svg class="c-svg" id="svg-tech"></svg>
      <div id="boxes-tech"></div>
    </div>
  </div>
</div>

<!-- SYS PANEL -->
<div id="panel-sys" class="track-panel">
  <div class="track-toolbar">
    <span class="track-lbl sys">Sistemsel DeÄŸerlendirme</span>
    <button class="btn-tb btn-add-sys" onclick="addMainStep('sys')">+ AdÄ±m</button>
    <button class="btn-yenile sys" id="yenileSys" onclick="aiRefresh('sys')">ğŸ”„ Yenile</button>
    <span class="toolbar-hint">Sistem neden Ã¶nleyemedi? â†’ YÃ¶netim / ProsedÃ¼r boÅŸluklarÄ±</span>
  </div>
  <div class="canvas-wrap" id="wrap-sys">
    <div class="canvas-inner" id="inner-sys">
      <svg class="c-svg" id="svg-sys"></svg>
      <div id="boxes-sys"></div>
    </div>
  </div>
</div>

<!-- AI WIZARD MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modalBox">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="modal-title" id="modalTitle">ğŸ¤– AI ile 5 Neden OluÅŸtur</div>
    <div class="wiz-prog-bar"><div class="wiz-prog-fill tech" id="wizProg" style="width:0%"></div></div>
    <div class="wiz-step-lbl" id="wizStepLbl"></div>
    <div class="wiz-q" id="wizQ"></div>
    <div id="wizBody"></div>
    <div class="wiz-nav">
      <button class="btn-wiz btn-wiz-back" id="wizBack" onclick="wizNav(-1)">â† Geri</button>
      <button class="btn-wiz btn-wiz-next tech" id="wizNext" onclick="wizNav(1)">Ä°leri â†’</button>
    </div>
    <div class="api-key-row">
      <div class="api-key-lbl">Groq API Key â€” console.groq.com (Ã¼cretsiz)</div>
      <input class="api-key-inp" id="apiKeyInp" type="password" placeholder="gsk_..."
             oninput="localStorage.setItem('groq_api_key',this.value)"/>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="legend">
  <div><span class="lc" style="color:#93c5fd">â”€â”€â–¶</span>&nbsp;Neden?</div>
  <div><span class="lc" style="color:#fb923c">- - â—€</span>&nbsp;Bu yÃ¼zden</div>
  <div><span class="lc" style="color:#6ee7b7">â•Œ â•Œâ–¼</span>&nbsp;Paralel dal</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOX_W=175, BOX_H=92, PROB_W=170, PROB_H=84;
const RCB_W=158, RCB_H=110;
const H_GAP=80, V_STEP=72, BRANCH_V=30;
const COL_W = BOX_W + H_GAP; // 255

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid(){ return Math.random().toString(36).slice(2,9) }

let _S = {
  meta:{ partNo:'', defect:'', date:'' },
  tech:{
    problem:'Teknik problem tanÄ±mÄ±...',
    rcText:'Teknik KÃ¶k Neden',
    chains:[{ startAfter:null, steps:[{ id:uid(), text:'Neden 1', isRoot:false }] }]
  },
  sys:{
    problem:'Sistemsel problem tanÄ±mÄ±...',
    rcText:'Sistemsel KÃ¶k Neden',
    chains:[{ startAfter:null, steps:[{ id:uid(), text:'Neden 1', isRoot:false }] }]
  }
};

let _activeTab = 'tech';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tk){
  _activeTab = tk;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.tab-btn.${tk}`).classList.add('active');
  document.querySelectorAll('.track-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(`panel-${tk}`).classList.add('active');
  render(tk);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDEXEDDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _db;
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('KaliteRaporDB',4);
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('payloads')) d.createObjectStore('payloads');
    };
    r.onsuccess=e=>{ _db=e.target.result; res() };
    r.onerror=rej;
  });
}
function dbPut(k,v){ return new Promise((r,j)=>{ const t=_db.transaction('payloads','readwrite'); t.objectStore('payloads').put(v,k).onsuccess=r; t.onerror=j }) }
function dbGet(k){ return new Promise((r,j)=>{ const t=_db.transaction('payloads','readonly'); const q=t.objectStore('payloads').get(k); q.onsuccess=()=>r(q.result); q.onerror=j }) }

async function saveDB(){
  collectMeta();
  await dbPut('5neden_ts', JSON.parse(JSON.stringify(_S)));
  toast('Kaydedildi âœ“','ok');
}

async function loadDB(){
  const d = await dbGet('5neden_ts') || await dbGet('5neden_v2') || await dbGet('5neden_v1');
  if(!d) return;
  if(d.meta) _S.meta = d.meta;
  if(d.tech) _S.tech = d.tech;
  else if(d.os) _S.tech = d.os; // legacy
  if(d.sys) _S.sys = d.sys;
  else if(d.nd) _S.sys = d.nd;  // legacy
  fillMeta();
}

function collectMeta(){
  _S.meta.partNo = document.getElementById('inPartNo').value;
  _S.meta.defect = document.getElementById('inDefect').value;
  _S.meta.date   = document.getElementById('inDate').value;
}
function fillMeta(){
  document.getElementById('inPartNo').value = _S.meta.partNo||'';
  document.getElementById('inDefect').value = _S.meta.defect||'';
  document.getElementById('inDate').value   = _S.meta.date||'';
}
function saveMeta(){ collectMeta() }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMainStep(tk){
  _S[tk].chains[0].steps.push({ id:uid(), text:'Neden?', isRoot:false });
  render(tk); saveDB();
}
function addBranchStep(tk, ci){
  _S[tk].chains[ci].steps.push({ id:uid(), text:'Neden?', isRoot:false });
  render(tk); saveDB();
}
function deleteStep(tk, ci, si){
  const ch = _S[tk].chains[ci];
  if(ch.steps.length<=1){ toast('En az 1 adÄ±m gerekli','err'); return }
  ch.steps.splice(si,1);
  if(ci>0 && ch.steps.length===0) _S[tk].chains.splice(ci,1);
  render(tk); saveDB();
}
function toggleRoot(tk, ci, si){
  _S[tk].chains[ci].steps[si].isRoot = !_S[tk].chains[ci].steps[si].isRoot;
  render(tk); saveDB();
}
function addParallelBranch(tk, forkAt){
  _S[tk].chains.push({ startAfter:forkAt, steps:[{ id:uid(), text:'Neden?', isRoot:false }] });
  render(tk); saveDB();
}
function forkFrom(tk, ci, si){
  let forkAt;
  if(ci===0){ forkAt = si+1; }
  else {
    const sa = _S[tk].chains[ci].startAfter ?? 0;
    forkAt = sa + si;
  }
  addParallelBranch(tk, forkAt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAYOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLayout(tk){
  const chains = _S[tk].chains;
  const mainSteps = chains[0].steps;

  let items=[], conns=[], allPlaced=[];

  // Problem box
  const probX=20, probY=20;
  items.push({ type:'prob', x:probX, y:probY, w:PROB_W, h:PROB_H,
    cx:probX+PROB_W/2, cy:probY+PROB_H/2 });

  // Main chain staircase
  let mainItems=[];
  mainSteps.forEach((st,i)=>{
    const x=(i+1)*COL_W+20, y=i*V_STEP+20;
    const it={ type:'step', x, y, w:BOX_W, h:BOX_H,
      cx:x+BOX_W/2, cy:y+BOX_H/2, chain:0, stepIdx:i, step:st };
    mainItems.push(it); allPlaced.push(it);
  });
  items.push(...mainItems);

  // Main chain connections
  conns.push({ type:'why', x1:probX+PROB_W, y1:probY+PROB_H/2,
    x2:mainItems[0].x, y2:mainItems[0].cy });
  for(let i=0;i<mainItems.length-1;i++){
    conns.push({ type:'why',
      x1:mainItems[i].x+BOX_W, y1:mainItems[i].cy,
      x2:mainItems[i+1].x, y2:mainItems[i+1].cy });
  }

  // Branches
  let allBranchLast=[];
  for(let ci=1; ci<chains.length; ci++){
    const ch = chains[ci];
    const sa = ch.startAfter ?? 0;
    const forkColX = (sa+1)*COL_W+20;

    // Find bottommost placed item at fork column
    let lowestBottom=-Infinity, forkAnchor=mainItems[Math.min(sa, mainItems.length-1)];
    allPlaced.forEach(it=>{
      const mX=it.x+it.w/2;
      if(Math.abs(mX-(forkColX+BOX_W/2))<BOX_W*0.7){
        if(it.y+it.h>lowestBottom){ lowestBottom=it.y+it.h; forkAnchor=it }
      }
    });
    if(lowestBottom<0) lowestBottom = forkAnchor.y + BOX_H;

    const startX = sa*COL_W+20;
    const brTopY = lowestBottom + BRANCH_V;

    let brItems=[];
    ch.steps.forEach((st,j)=>{
      const x=startX+j*COL_W, y=brTopY+j*V_STEP;
      const it={ type:'step', x, y, w:BOX_W, h:BOX_H,
        cx:x+BOX_W/2, cy:y+BOX_H/2, chain:ci, stepIdx:j, step:st };
      brItems.push(it); allPlaced.push(it);
    });
    items.push(...brItems);
    allBranchLast.push(brItems[brItems.length-1]);

    // Fork connector (vertical down)
    conns.push({ type:'branch',
      x1:forkAnchor.cx, y1:forkAnchor.y+BOX_H,
      x2:brItems[0].cx, y2:brItems[0].y });

    // Branch step conns
    for(let j=0;j<brItems.length-1;j++){
      conns.push({ type:'why',
        x1:brItems[j].x+BOX_W, y1:brItems[j].cy,
        x2:brItems[j+1].x, y2:brItems[j+1].cy });
    }
  }

  // RCB: rightmost of all last items
  const lastItems = [mainItems[mainItems.length-1], ...allBranchLast];
  let rightX=-Infinity, rcbAnchor=mainItems[mainItems.length-1];
  lastItems.forEach(it=>{ if(it.x+BOX_W>rightX){ rightX=it.x+BOX_W; rcbAnchor=it } });
  const rcbX=rightX+H_GAP, rcbY=rcbAnchor.y;
  items.push({ type:'rcb', x:rcbX, y:rcbY, w:RCB_W, h:RCB_H,
    cx:rcbX+RCB_W/2, cy:rcbY+RCB_H/2 });
  conns.push({ type:'why',
    x1:rcbAnchor.x+BOX_W, y1:rcbAnchor.cy,
    x2:rcbX, y2:rcbY+RCB_H/2 });

  // Canvas size
  let maxX=0, maxY=0;
  items.forEach(it=>{ maxX=Math.max(maxX,it.x+it.w+40); maxY=Math.max(maxY,it.y+it.h+60) });
  return { items, conns, canvasW:maxX, canvasH:maxY };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(tk){
  const innerEl  = document.getElementById(`inner-${tk}`);
  const svgEl    = document.getElementById(`svg-${tk}`);
  const boxesEl  = document.getElementById(`boxes-${tk}`);
  boxesEl.innerHTML = '';
  svgEl.innerHTML   = '';

  const { items, conns, canvasW, canvasH } = doLayout(tk);

  innerEl.style.width  = canvasW+'px';
  innerEl.style.height = canvasH+'px';
  svgEl.setAttribute('width', canvasW);
  svgEl.setAttribute('height', canvasH);

  // Arrow colors by tab
  const fwdCol  = tk==='tech' ? '#93c5fd' : '#c4b5fd';
  const brCol   = tk==='tech' ? '#6ee7b7' : '#fda4af';

  svgEl.innerHTML = `<defs>
    <marker id="mfw_${tk}" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L7,3 L0,6 z" fill="${fwdCol}"/>
    </marker>
    <marker id="mbr_${tk}" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L7,3 L0,6 z" fill="${brCol}" opacity=".75"/>
    </marker>
    <marker id="mret_${tk}" markerWidth="8" markerHeight="8" refX="1" refY="3" orient="auto">
      <path d="M7,0 L7,6 L0,3 z" fill="#fb923c"/>
    </marker>
  </defs>`;

  conns.forEach(c => drawConn(svgEl, c, tk, fwdCol, brCol));
  items.forEach(it => renderBox(boxesEl, it, tk));
}

function drawConn(svg, c, tk, fwdCol, brCol){
  if(c.type==='branch'){
    const p = makePath(`M${c.x1},${c.y1} L${c.x2},${c.y2}`, brCol, 1.8, '5,4', `url(#mbr_${tk})`);
    svg.appendChild(p); return;
  }
  if(c.type==='why'){
    const mx=(c.x1+c.x2)/2;
    // Forward bezier
    const df=`M${c.x1},${c.y1} C${mx},${c.y1} ${mx},${c.y2} ${c.x2},${c.y2}`;
    svg.appendChild(makePath(df, fwdCol, 2, null, `url(#mfw_${tk})`));

    // "Neden?" label
    svg.appendChild(makeTxt((c.x1+c.x2)/2, (c.y1+c.y2)/2-11, 'Neden?', fwdCol, 9, '700'));

    // Return bezier (offset 6px down)
    const O=6;
    const dr=`M${c.x2},${c.y2+O} C${mx},${c.y2+O} ${mx},${c.y1+O} ${c.x1},${c.y1+O}`;
    svg.appendChild(makePath(dr, '#fb923c', 1.5, '4,4', `url(#mret_${tk})`));

    // "Bu yÃ¼zden" label
    svg.appendChild(makeTxt((c.x1+c.x2)/2, (c.y1+c.y2)/2+24, 'â† Bu yÃ¼zden', '#fb923c', 9, '600'));
  }
}

function makePath(d, stroke, w, dash, mEnd){
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d',d); p.setAttribute('fill','none');
  p.setAttribute('stroke',stroke); p.setAttribute('stroke-width',w);
  if(dash) p.setAttribute('stroke-dasharray',dash);
  if(mEnd) p.setAttribute('marker-end',mEnd);
  return p;
}
function makeTxt(x,y,txt,fill,size,weight){
  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x',x); t.setAttribute('y',y);
  t.setAttribute('text-anchor','middle'); t.setAttribute('fill',fill);
  t.setAttribute('font-size',size); t.setAttribute('font-weight',weight);
  t.textContent=txt; return t;
}

function renderBox(container, it, tk){
  const el = document.createElement('div');
  el.style.cssText=`position:absolute;left:${it.x}px;top:${it.y}px;width:${it.w}px`;

  if(it.type==='prob'){
    el.className=`prob-box ${tk}`;
    el.style.height=PROB_H+'px';
    const lbl = tk==='tech' ? 'Teknik Problem' : 'Sistem ZayÄ±flÄ±k NoktasÄ±';
    el.innerHTML=`<div class="prob-lbl">${lbl}</div>
      <textarea style="height:${PROB_H-30}px" oninput="_S['${tk}'].problem=this.value">${esc(_S[tk].problem)}</textarea>`;
  }

  if(it.type==='step'){
    const st=it.step, ci=it.chain, si=it.stepIdx;
    const lbl = ci===0 ? `Ana Zincir â€“ ${si+1}` : `Dal ${ci} â€“ AdÄ±m ${si+1}`;
    const rootClass = `sb-root-${tk}${st.isRoot?' on':''}`;
    const isLastMain   = ci===0 && si===_S[tk].chains[0].steps.length-1;
    const isLastBranch = ci>0   && si===_S[tk].chains[ci].steps.length-1;
    const isMidMain    = ci===0 && !isLastMain;

    let extra='';
    if(isLastMain){
      extra=`<button class="sb sb-fork" onclick="forkFrom('${tk}',${ci},${si})">â‘‚ Dal</button>
             <button class="sb sb-add-${tk}" onclick="addMainStep('${tk}')">+</button>`;
    } else if(isLastBranch){
      extra=`<button class="sb sb-fork" onclick="forkFrom('${tk}',${ci},${si})">â‘‚</button>
             <button class="sb sb-add-${tk}" onclick="addBranchStep('${tk}',${ci})">+</button>`;
    } else if(isMidMain){
      extra=`<button class="sb sb-fork" onclick="forkFrom('${tk}',${ci},${si})">â‘‚</button>`;
    }

    el.className=`step-box ${tk}${st.isRoot?' root':''}`;
    el.style.minHeight=BOX_H+'px';
    el.innerHTML=`<div class="step-num">${lbl}</div>
      <textarea style="height:${BOX_H-46}px;min-height:44px" oninput="_S['${tk}'].chains[${ci}].steps[${si}].text=this.value">${esc(st.text)}</textarea>
      <div class="step-actions">
        <button class="sb ${rootClass}" onclick="toggleRoot('${tk}',${ci},${si})">${st.isRoot?'â˜… KÃ¶k':'â˜† KÃ¶k'}</button>
        <button class="sb sb-del" onclick="deleteStep('${tk}',${ci},${si})">âœ•</button>
        ${extra}
      </div>`;
  }

  if(it.type==='rcb'){
    el.className=`rcb-box ${tk}`;
    el.style.minHeight=RCB_H+'px';
    const lbl = tk==='tech' ? 'Teknik KÃ¶k Neden' : 'Sistemsel KÃ¶k Neden';
    el.innerHTML=`<div class="rcb-lbl">${lbl}</div>
      <textarea style="min-height:${RCB_H-34}px" oninput="_S['${tk}'].rcText=this.value">${esc(_S[tk].rcText)}</textarea>`;
  }

  container.appendChild(el);
}

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIZARD DEFINITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WIZ = {
  tech:[
    { q:'Teknik problem nedir? Ne oldu?', type:'textarea', k:'problem',
      hint:'Ã–rn: Pinhole sayÄ±sÄ± spec dÄ±ÅŸÄ±, boyut tolerans aÅŸÄ±mÄ±, yÃ¼zey hatasÄ±, renk farkÄ±...' },
    { q:'Hangi teknik parametreler etkilendi?', type:'text', k:'params',
      hint:'Ã–rn: KalÄ±p sÄ±caklÄ±ÄŸÄ±, karÄ±ÅŸÄ±m oranÄ±, pres basÄ±ncÄ±, viskozite, besleme hÄ±zÄ±...' },
    { q:'Hangi ekipman / proses adÄ±mÄ±?', type:'text', k:'process',
      hint:'Ã–rn: KÃ¶pÃ¼k dÃ¶kÃ¼m fÄ±rÄ±nÄ±, pres istasyonu #3, kaynak robotu, CMM Ã¶lÃ§Ã¼m...' },
    { q:'Ã–lÃ§Ã¼m / SPC / kontrol bulgusu ne gÃ¶sterdi?', type:'text', k:'measure',
      hint:'Ã–rn: SPC UCL aÅŸÄ±mÄ±, CMM sapma +0.45mm, gÃ¶rsel ret, kalibrasyon kaybÄ±...' },
    { q:'KaÃ§ teknik neden adÄ±mÄ± analiz edilsin?', type:'chips', k:'stepCount',
      opts:['3','4','5','6','7'], def:'5' },
    { q:'Paralel teknik zincir eklensin mi?', type:'chips', k:'branches',
      opts:['Yok','1 Dal','2 Dal'], def:'Yok' }
  ],
  sys:[
    { q:'Teknik kÃ¶k nedeni Ã¶zetle (bu temel alÄ±nacak)', type:'textarea', k:'techRoot',
      hint:'Ã–rn: KalÄ±p sÄ±caklÄ±ÄŸÄ± kritik limitin dÄ±ÅŸÄ±na Ã§Ä±ktÄ± â†’ sistem bunu neden Ã¶nleyemedi?' },
    { q:'Kontrol planÄ± yeterliliÄŸi nasÄ±ldÄ±?', type:'text', k:'cp',
      hint:'Ã–rn: Bu parametre kontrol planÄ±nda yok / Ã¶lÃ§Ã¼m frekansÄ± Ã§ok dÃ¼ÅŸÃ¼k / reaksiyon planÄ± eksik...' },
    { q:'FMEA bu riski kapsamÄ±ÅŸ mÄ±ydÄ±?', type:'text', k:'fmea',
      hint:'Ã–rn: FMEA\'da RPN 48 (dÃ¼ÅŸÃ¼k), aksiyon alÄ±nmamÄ±ÅŸ / risk olarak tanÄ±mlanmamÄ±ÅŸ...' },
    { q:'Hangi sistemsel boÅŸluk bu hatayÄ± mÃ¼mkÃ¼n kÄ±ldÄ±?', type:'text', k:'gap',
      hint:'Ã–rn: OperatÃ¶r eÄŸitimi eksik, iÃ§ denetim bu noktayÄ± gÃ¶zden kaÃ§Ä±rdÄ±, MSA yapÄ±lmamÄ±ÅŸ...' },
    { q:'KaÃ§ sistemsel neden adÄ±mÄ± analiz edilsin?', type:'chips', k:'stepCount',
      opts:['3','4','5','6','7'], def:'5' },
    { q:'Paralel sistemsel zincir eklensin mi?', type:'chips', k:'branches',
      opts:['Yok','1 Dal','2 Dal'], def:'Yok' }
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIZARD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _wiz = { tk:'tech', step:0, ans:{} };

function openWizard(){
  _wiz.tk   = _activeTab;
  _wiz.step = 0;
  _wiz.ans  = {};
  WIZ[_wiz.tk].forEach(s=>{ _wiz.ans[s.k] = s.type==='chips' ? s.def : '' });

  document.getElementById('modalBox').className = `modal ${_wiz.tk}`;
  document.getElementById('wizProg').className  = `wiz-prog-fill ${_wiz.tk}`;
  document.getElementById('wizNext').className  = `btn-wiz btn-wiz-next ${_wiz.tk}`;
  document.getElementById('apiKeyInp').value    = localStorage.getItem('groq_api_key')||'';
  document.getElementById('modalTitle').textContent =
    'ğŸ¤– ' + (_wiz.tk==='tech'?'Teknik':'Sistemsel') + ' 5 Neden OluÅŸtur';
  document.getElementById('modalBg').classList.add('open');
  renderWizStep();
}

function closeModal(){
  document.getElementById('modalBg').classList.remove('open');
}

function renderWizStep(){
  const steps = WIZ[_wiz.tk];
  const s = steps[_wiz.step];
  const total = steps.length;
  const pct = ((_wiz.step+1)/total*100).toFixed(0);

  document.getElementById('wizStepLbl').textContent = `AdÄ±m ${_wiz.step+1} / ${total}`;
  document.getElementById('wizQ').textContent = s.q;
  document.getElementById('wizProg').style.width = pct+'%';
  document.getElementById('wizBack').style.visibility = _wiz.step===0?'hidden':'visible';
  document.getElementById('wizNext').textContent =
    _wiz.step===total-1 ? 'âœ¨ OluÅŸtur â†’' : 'Ä°leri â†’';

  let html='';
  if(s.type==='textarea'){
    html=`<textarea class="wiz-inp" id="wizInp" rows="3" placeholder="${s.hint||''}">${_wiz.ans[s.k]||''}</textarea>`;
  } else if(s.type==='text'){
    html=`<input class="wiz-inp" id="wizInp" placeholder="${s.hint||''}" value="${esc(_wiz.ans[s.k]||'')}"/>`;
  } else if(s.type==='chips'){
    html=`<div class="wiz-opts">${
      s.opts.map(o=>`<button class="wiz-chip ${_wiz.tk}${_wiz.ans[s.k]===o?' sel':''}"
        onclick="wizChip(this,'${s.k}','${o}')">${o}</button>`).join('')
    }</div>`;
  }
  document.getElementById('wizBody').innerHTML=html;

  if(s.type!=='chips'){
    const inp=document.getElementById('wizInp');
    if(inp){
      inp.focus();
      if(s.type==='text') inp.onkeydown=e=>{ if(e.key==='Enter'){ e.preventDefault(); wizNav(1) } };
    }
  }
}

function wizChip(btn, k, val){
  _wiz.ans[k]=val;
  btn.closest('.wiz-opts').querySelectorAll('.wiz-chip').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
}

function wizSave(){
  const s=WIZ[_wiz.tk][_wiz.step];
  if(s.type!=='chips'){ const inp=document.getElementById('wizInp'); if(inp) _wiz.ans[s.k]=inp.value||'' }
}

function wizNav(dir){
  wizSave();
  const total=WIZ[_wiz.tk].length;
  if(dir>0 && _wiz.step===total-1){ closeModal(); aiGenerate(_wiz.tk, _wiz.ans); return }
  _wiz.step = Math.max(0, Math.min(total-1, _wiz.step+dir));
  renderWizStep();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI GENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GROQ_URL='https://api.groq.com/openai/v1/chat/completions';
const GROQ_MODEL='llama-3.3-70b-versatile';

function getKey(){ return localStorage.getItem('groq_api_key')||'' }

async function aiGenerate(tk, ans){
  const key=getKey();
  if(!key){ toast('Groq API key eksik!','err'); return }

  const stepCount = parseInt(ans.stepCount)||5;
  const branchCount = ans.branches==='Yok'?0 : parseInt(ans.branches)||0;

  const sysPrompt = tk==='tech'
    ? `Sen IATF 16949 / VDA 6.3 uzmanÄ± bir kalite mÃ¼hendisisin.
       TECHNICAL 5 Neden analizi yapÄ±yorsun â€” sadece teknik, mÃ¼hendislik ve proses kaynaklÄ± nedenler:
       â€¢ Proses parametresi sapmasÄ± (sÄ±caklÄ±k, basÄ±nÃ§, hÄ±z, karÄ±ÅŸÄ±m oranÄ±)
       â€¢ Ekipman arÄ±zasÄ± veya yanlÄ±ÅŸ ayar
       â€¢ Malzeme spesifikasyon dÄ±ÅŸÄ±
       â€¢ Ã–lÃ§Ã¼m sistemi hatasÄ± / kalibrasyon
       â€¢ Tolerans aÅŸÄ±mÄ±, takÄ±m aÅŸÄ±nmasÄ±
       "Hata nasÄ±l fiziksel olarak oluÅŸtu?" sorusunu yanÄ±tla. TÃ¼rkÃ§e JSON.`
    : `Sen IATF 16949 / VDA 6.3 uzmanÄ± bir kalite sistem denetÃ§isisin.
       SYSTEMIC 5 Neden analizi yapÄ±yorsun â€” sadece yÃ¶netim sistemi, prosedÃ¼r ve organizasyonel nedenler:
       â€¢ Kontrol planÄ± eksikliÄŸi / yetersiz frekans / reaksiyon planÄ± yok
       â€¢ FMEA'da risk tanÄ±mlanmamÄ±ÅŸ / RPN yetersiz / aksiyon alÄ±nmamÄ±ÅŸ
       â€¢ ProsedÃ¼r/talimat gÃ¼ncel deÄŸil veya yok
       â€¢ OperatÃ¶r eÄŸitimi eksik / OJT tamamlanmamÄ±ÅŸ
       â€¢ Ä°Ã§ denetim/sÃ¼reÃ§ denetimi bu noktayÄ± gÃ¶zden kaÃ§Ä±rdÄ±
       â€¢ MSA/R&R yapÄ±lmamÄ±ÅŸ
       "Sistem bunu neden Ã¶nleyemedi?" sorusunu yanÄ±tla. TÃ¼rkÃ§e JSON.`;

  const branchEx=[];
  for(let b=0;b<branchCount;b++){
    const sa=Math.round((b+1)*stepCount/(branchCount+1))-1;
    branchEx.push(`{"startAfter":${Math.max(0,sa)},"steps":[{"text":"paralel neden","isRoot":false}]}`);
  }

  const userMsg = tk==='tech'
    ? `Problem: ${ans.problem}
Teknik parametreler: ${ans.params}
Proses/ekipman: ${ans.process}
Ã–lÃ§Ã¼m bulgusu: ${ans.measure}

${stepCount} teknik neden adÄ±mlÄ± ana zincir oluÅŸtur. Son adÄ±mÄ± isRoot:true yap.
${branchCount>0 ? `AyrÄ±ca ${branchCount} paralel teknik zincir ekle: ${branchEx.join(', ')}` : ''}
Teknik kÃ¶k nedeni (rcText) de yaz.
JSON: {"problem":"...","rcText":"Teknik KÃ¶k: ...","chains":[{"startAfter":null,"steps":[{"text":"...","isRoot":false}]}${branchCount>0 ? ','+branchEx.join(',') : ''}]}`
    : `Teknik kÃ¶k neden: ${ans.techRoot}
Kontrol planÄ±: ${ans.cp}
FMEA durumu: ${ans.fmea}
Sistemsel boÅŸluk: ${ans.gap}

${stepCount} sistemsel neden adÄ±mlÄ± ana zincir oluÅŸtur. Son adÄ±mÄ± isRoot:true yap.
${branchCount>0 ? `AyrÄ±ca ${branchCount} paralel sistemsel zincir ekle: ${branchEx.join(', ')}` : ''}
Sistemsel kÃ¶k nedeni (rcText) de yaz.
JSON: {"problem":"...","rcText":"Sistemsel KÃ¶k: ...","chains":[{"startAfter":null,"steps":[{"text":"...","isRoot":false}]}${branchCount>0 ? ','+branchEx.join(',') : ''}]}`;

  toast('AI analiz oluÅŸturuluyor...','');
  try{
    const r=await fetch(GROQ_URL,{
      method:'POST',
      headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},
      body:JSON.stringify({ model:GROQ_MODEL,
        response_format:{type:'json_object'},
        messages:[{role:'system',content:sysPrompt},{role:'user',content:userMsg}],
        temperature:0.7, max_tokens:2000 })
    });
    const j=await r.json();
    if(j.error) throw new Error(j.error.message);
    applyResult(tk, JSON.parse(j.choices[0].message.content));
    toast((tk==='tech'?'Teknik':'Sistemsel')+' analiz oluÅŸturuldu âœ“','ok');
  } catch(e){ toast('AI Hata: '+e.message,'err') }
}

async function aiRefresh(tk){
  const key=getKey();
  if(!key){ toast('Groq API key eksik!','err'); return }

  const btnId = tk==='tech'?'yenileTech':'yenileSys';
  const btn=document.getElementById(btnId);
  let pct=10;
  btn.style.setProperty('--prog',pct+'%');
  btn.textContent='ğŸ”„ '+pct+'%';
  const iv=setInterval(()=>{ pct=Math.min(pct+7,85); btn.style.setProperty('--prog',pct+'%'); btn.textContent='ğŸ”„ '+pct+'%' },600);

  const cur=_S[tk];
  const sysPrompt = tk==='tech'
    ? 'Sen IATF 16949 uzmanÄ±sÄ±n. Mevcut teknik 5 Neden analizini daha derin ve spesifik yap. Sadece teknik nedenler. TÃ¼rkÃ§e JSON.'
    : 'Sen IATF 16949 uzmanÄ±sÄ±n. Mevcut sistemsel 5 Neden analizini daha derin ve spesifik yap. Sadece yÃ¶netim sistemi/prosedÃ¼r nedenleri. TÃ¼rkÃ§e JSON.';

  const userMsg=`Problem: ${cur.problem}
Mevcut zincirler: ${JSON.stringify(cur.chains.map(ch=>({sa:ch.startAfter,steps:ch.steps.map(s=>s.text)})))}
Bu analizi geliÅŸtir ve derinleÅŸtir. AynÄ± zincir sayÄ±sÄ± ve yapÄ±sÄ±nÄ± koru.
JSON: {"problem":"...","rcText":"...","chains":[{"startAfter":null|number,"steps":[{"text":"...","isRoot":false}]},...]}`;

  try{
    const r=await fetch(GROQ_URL,{
      method:'POST',
      headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},
      body:JSON.stringify({ model:GROQ_MODEL, response_format:{type:'json_object'},
        messages:[{role:'system',content:sysPrompt},{role:'user',content:userMsg}],
        temperature:0.65, max_tokens:1800 })
    });
    const j=await r.json();
    if(j.error) throw new Error(j.error.message);
    clearInterval(iv);
    btn.style.setProperty('--prog','100%');
    btn.textContent='âœ… Tamam';
    applyResult(tk, JSON.parse(j.choices[0].message.content));
    setTimeout(()=>{ btn.style.setProperty('--prog','0%'); btn.textContent='ğŸ”„ Yenile' },1500);
    toast((tk==='tech'?'Teknik':'Sistemsel')+' analiz yenilendi âœ“','ok');
  } catch(e){
    clearInterval(iv);
    btn.style.setProperty('--prog','0%'); btn.textContent='ğŸ”„ Yenile';
    toast('AI Hata: '+e.message,'err');
  }
}

function applyResult(tk, iz){
  if(iz.problem) _S[tk].problem = iz.problem;
  if(iz.rcText)  _S[tk].rcText  = iz.rcText;
  if(iz.chains && Array.isArray(iz.chains) && iz.chains.length>0){
    _S[tk].chains = iz.chains.map((ch,i)=>({
      startAfter: i===0 ? null : (ch.startAfter ?? ch.startAfterStep ?? null),
      steps: (ch.steps||[]).map(s=>({
        id:uid(),
        text: typeof s==='string' ? s : (s.text||''),
        isRoot: typeof s==='object' ? (s.isRoot||false) : false
      }))
    }));
    // Ensure each chain has at least one step
    _S[tk].chains.forEach(ch=>{ if(!ch.steps.length) ch.steps=[{id:uid(),text:'Neden?',isRoot:false}] });
  }
  render(tk); saveDB();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type=''){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`toast ${type} show`;
  setTimeout(()=>el.classList.remove('show'),3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
openDB().then(async ()=>{
  await loadDB();
  render('tech');
  render('sys');
});
</script>
</body>
</html>
