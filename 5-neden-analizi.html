<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5 Neden Analizi</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f4f8;color:#1e293b;min-height:100vh;}

.topbar{display:flex;align-items:center;gap:10px;padding:10px 18px;
  background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.22);flex-wrap:wrap;}
.topbar h1{font-size:1.1rem;font-weight:800;}
.topbar .sp{flex:1;}
.tbb{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.32);
  color:#fff;border-radius:7px;padding:5px 13px;font-size:.76rem;font-weight:600;
  cursor:pointer;transition:.15s;white-space:nowrap;}
.tbb:hover{background:rgba(255,255,255,.27);}
.tbb.danger{background:rgba(220,38,38,.38);border-color:rgba(220,38,38,.6);}
.tbb.ok{background:rgba(22,163,74,.46);border-color:rgba(22,163,74,.7);}

.meta-bar{display:flex;gap:10px;flex-wrap:wrap;padding:9px 18px;background:#fff;
  border-bottom:1px solid #e2e8f0;align-items:flex-end;}
.mf{display:flex;flex-direction:column;gap:2px;flex:1;min-width:150px;}
.mf label{font-size:.62rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;}
.mf input,.mf select{border:1.5px solid #e2e8f0;border-radius:6px;padding:4px 8px;
  font-size:.8rem;outline:none;transition:.2s;}
.mf input:focus,.mf select:focus{border-color:#2563eb;}

.legend{display:flex;gap:14px;flex-wrap:wrap;padding:6px 18px;background:#f8faff;
  border-bottom:1px solid #e2e8f0;font-size:.71rem;align-items:center;color:#475569;}
.li{display:flex;align-items:center;gap:5px;}
.lb{width:22px;height:13px;border-radius:2px;border:2px solid;}
.lb.n{background:#fff;border-color:#94a3b8;}
.lb.r{background:#fff5f5;border-color:#dc2626;border-style:dashed;}

/* â”€â”€ CANVAS â”€â”€ */
.canvas-outer{overflow:auto;padding:18px 18px 48px;background:#eef2f7;}
.track-wrap{margin-bottom:52px;}
.track-hdr{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.tbadge{font-size:.7rem;font-weight:800;color:#fff;border-radius:6px;
  padding:3px 11px;text-transform:uppercase;letter-spacing:.07em;}
.tbadge.os{background:#2563eb;} .tbadge.nd{background:#7c3aed;}
.tsub{font-size:.68rem;font-style:italic;color:#94a3b8;}

/* â”€â”€ DIAGRAM CANVAS â”€â”€ */
.diag{position:relative;overflow:visible;}
.diag svg{position:absolute;top:0;left:0;pointer-events:none;overflow:visible;}

/* â”€â”€ PROBLEM BOX â”€â”€ */
.pbox{position:absolute;border:2.5px solid #2563eb;border-radius:8px;
  background:#eef4ff;padding:8px 10px;}
.pbox.nd-t{border-color:#7c3aed;background:#f4f0ff;}
.plbl{font-size:.58rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:4px;color:#2563eb;}
.pbox.nd-t .plbl{color:#7c3aed;}
.pbox textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.82rem;font-weight:500;color:#1e293b;font-family:inherit;line-height:1.45;min-height:44px;}

/* â”€â”€ STEP BOX â”€â”€ */
.sbox{position:absolute;border:2px solid #cbd5e1;border-radius:8px;
  background:#fff;padding:7px 10px;
  box-shadow:0 1px 5px rgba(0,0,0,.06);transition:border .15s,box-shadow .15s;}
.sbox:hover{border-color:#93c5fd;box-shadow:0 2px 8px rgba(37,99,235,.13);}
.sbox.is-root{border-color:#dc2626;border-style:dashed;border-width:2.5px;background:#fff7f7;}
.stag{position:absolute;top:-9px;left:8px;font-size:.57rem;font-weight:800;
  padding:1px 7px;border-radius:10px;background:#dc2626;color:#fff;white-space:nowrap;}
.sbox textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.83rem;font-weight:500;color:#1e293b;font-family:inherit;line-height:1.45;
  min-height:36px;margin-top:14px;padding-left:2px;}
.sbox.is-root textarea{margin-top:18px;}
.sacts{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap;}
.sa{font-size:.56rem;padding:2px 5px;border-radius:4px;border:1px solid;
  cursor:pointer;font-weight:700;background:#fff;transition:.12s;white-space:nowrap;}
/* wizard chips */
.wiz-opts{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
.wiz-chip{padding:6px 16px;border-radius:20px;border:2px solid #e2e8f0;
  font-size:.82rem;font-weight:700;cursor:pointer;background:#fff;color:#475569;transition:.15s;}
.wiz-chip:hover{border-color:#93c5fd;color:#2563eb;}
.wiz-chip.sel{border-color:#2563eb;background:#2563eb;color:#fff;}
.sa.add{color:#2563eb;border-color:#bfdbfe;background:#eff6ff;}
.sa.add:hover{background:#2563eb;color:#fff;}
.sa.root{color:#dc2626;border-color:#fca5a5;background:#fff5f5;}
.sa.root:hover{background:#dc2626;color:#fff;}
.sa.fork{color:#7c3aed;border-color:#ddd6fe;background:#f5f3ff;}
.sa.fork:hover{background:#7c3aed;color:#fff;}
.sa.del{color:#94a3b8;border-color:#e2e8f0;}
.sa.del:hover{background:#ef4444;color:#fff;border-color:#ef4444;}

/* â”€â”€ ROOT CAUSE BOX â”€â”€ */
.rcb{position:absolute;border:2.5px dashed #dc2626;border-radius:10px;
  background:#fff5f5;padding:10px 12px;text-align:center;}
.rcb .ri{font-size:1.1rem;}
.rcb .rl{font-size:.6rem;font-weight:800;text-transform:uppercase;
  color:#dc2626;letter-spacing:.04em;margin:4px 0 2px;}
.rcb textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.78rem;font-weight:600;color:#b91c1c;font-family:inherit;text-align:center;
  line-height:1.4;min-height:30px;}

/* â”€â”€ STEP NUMBER LABEL â”€â”€ */
.step-num-lbl{
  position:absolute;top:-1px;left:-1px;
  font-size:.57rem;font-weight:800;color:#fff;
  background:#2563eb;
  border-radius:7px 0 6px 0;   /* top-left follows box corner, cut diagonally into box */
  padding:2px 6px;letter-spacing:.04em;
  pointer-events:none;line-height:1.4;
  z-index:2;
}
.step-num-lbl.nd-lbl{background:#7c3aed;}

/* â”€â”€ PIN BUTTON â”€â”€ */
.pin-btn{position:absolute;top:3px;right:4px;background:none;border:none;
  cursor:pointer;font-size:.75rem;line-height:1;padding:2px 3px;border-radius:4px;
  opacity:.28;transition:.15s;color:#64748b;}
.pin-btn:hover{opacity:1;background:#fef3c7;}
.pin-btn.pinned{opacity:1;color:#f59e0b;filter:drop-shadow(0 0 3px #fcd34d);}
.sbox.is-pinned{border-color:#f59e0b !important;background:#fffbeb !important;}
.pbox.is-pinned{border-color:#f59e0b !important;background:#fffbeb !important;}
.rcb.is-pinned{border-color:#f59e0b !important;background:#fffbeb !important;}

/* â”€â”€ STEP ADD BTN â”€â”€ */
.add-step-btn{display:inline-flex;align-items:center;gap:5px;
  font-size:.72rem;font-weight:700;color:#2563eb;background:#eff6ff;
  border:1.5px dashed #93c5fd;border-radius:8px;padding:5px 13px;
  cursor:pointer;margin-top:6px;transition:.15s;}
.add-step-btn:hover{background:#dbeafe;}
.add-step-btn.nd{color:#7c3aed;background:#f5f3ff;border-color:#c4b5fd;}
.add-step-btn.nd:hover{background:#ede9fe;}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.42);
  z-index:9000;align-items:center;justify-content:center;}
.mo.open{display:flex;}
.mb{background:#fff;border-radius:14px;padding:22px 24px 18px;
  max-width:420px;width:95%;box-shadow:0 8px 40px rgba(0,0,0,.2);}
.mb h3{font-size:.92rem;font-weight:800;margin-bottom:12px;color:#1e293b;}
.mb textarea{width:100%;min-height:80px;border:1.5px solid #e2e8f0;
  border-radius:8px;padding:8px 10px;font-size:.82rem;resize:vertical;
  font-family:inherit;outline:none;}
.mb textarea:focus{border-color:#2563eb;}
.mbts{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
.mbt{padding:6px 17px;border-radius:7px;font-size:.8rem;font-weight:700;
  cursor:pointer;border:none;}
.mbt.c{background:#f1f5f9;color:#64748b;}
.mbt.s{background:#2563eb;color:#fff;}
.mbt.s:hover{background:#1d4ed8;}

/* â”€â”€ AI PANEL â”€â”€ */
.ai-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.48);
  z-index:9500;align-items:center;justify-content:center;}
.ai-modal.open{display:flex;}
.ai-box{background:#fff;border-radius:16px;padding:24px 26px 20px;
  max-width:480px;width:96%;box-shadow:0 10px 50px rgba(0,0,0,.22);}
.ai-box h3{font-size:.95rem;font-weight:800;color:#1e293b;margin-bottom:3px;
  display:flex;align-items:center;gap:8px;}
.ai-subtitle{font-size:.68rem;color:#94a3b8;margin-bottom:10px;}
.ai-subtitle a{color:#2563eb;text-decoration:none;}
/* Provider tabs */
.ai-provider-tabs{display:flex;gap:6px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #f1f5f9;}
.ai-ptab{flex:1;padding:7px 10px;border:1.5px solid #e2e8f0;border-radius:8px;background:#f8fafc;
  cursor:pointer;font-size:.78rem;font-weight:700;color:#64748b;transition:all .15s;}
.ai-ptab:hover{border-color:#93c5fd;color:#1d4ed8;}
.ai-ptab.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8;}
.ai-ptab.active.gem{background:#0f9d58;border-color:#0f9d58;}
.ai-ptab.active.or{background:#7c3aed;border-color:#7c3aed;}
.or-model-sel{width:100%;margin-top:6px;padding:5px 8px;border:1.5px solid #e2e8f0;border-radius:7px;
  font-size:.78rem;color:#374151;background:#f8fafc;cursor:pointer;}
.or-model-sel:focus{outline:none;border-color:#7c3aed;}
/* wizard */
.wiz-dots{display:flex;gap:6px;align-items:center;margin-bottom:16px;}
.wiz-dot{width:22px;height:4px;border-radius:2px;background:#e2e8f0;transition:.2s;}
.wiz-dot.active{background:#2563eb;}
.wiz-dot.done{background:#93c5fd;}
.wiz-q{font-size:.78rem;font-weight:700;color:#1e293b;margin-bottom:5px;}
.wiz-hint{font-size:.66rem;color:#94a3b8;margin-bottom:8px;}
.ai-ta{width:100%;border:1.5px solid #e2e8f0;border-radius:8px;
  padding:8px 10px;font-size:.82rem;resize:none;font-family:inherit;
  outline:none;min-height:64px;color:#1e293b;box-sizing:border-box;}
.ai-ta:focus{border-color:#2563eb;}
.ai-input{width:100%;border:1.5px solid #e2e8f0;border-radius:8px;
  padding:8px 10px;font-size:.82rem;font-family:inherit;outline:none;
  color:#1e293b;box-sizing:border-box;}
.ai-input:focus{border-color:#2563eb;}
.ai-label{font-size:.64rem;font-weight:700;color:#64748b;text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:4px;display:block;margin-top:12px;}
.ai-key{width:100%;border:1.5px solid #e2e8f0;border-radius:8px;
  padding:7px 10px;font-size:.78rem;font-family:monospace;outline:none;color:#1e293b;
  box-sizing:border-box;}
.ai-key:focus{border-color:#2563eb;}
.key-hint{font-size:.61rem;color:#94a3b8;margin-top:3px;}
.key-hint a{color:#2563eb;text-decoration:none;}
.ai-actions{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:14px;}
.ai-actions-right{display:flex;gap:8px;}
.aib{padding:7px 16px;border-radius:8px;font-size:.8rem;font-weight:700;
  cursor:pointer;border:none;transition:.15s;}
.aib.cancel{background:#f1f5f9;color:#64748b;}
.aib.cancel:hover{background:#e2e8f0;}
.aib.back{background:#f1f5f9;color:#475569;}
.aib.back:hover{background:#e2e8f0;}
.aib.next{background:#2563eb;color:#fff;}
.aib.next:hover{opacity:.88;}
.aib.gen{background:linear-gradient(135deg,#7c3aed,#2563eb);color:#fff;
  display:flex;align-items:center;gap:6px;}
.aib.gen:hover{opacity:.88;}
.aib.gen:disabled{opacity:.5;cursor:not-allowed;}
.ai-status{font-size:.74rem;color:#64748b;display:flex;align-items:center;gap:6px;}
.ai-spinner{width:14px;height:14px;border:2px solid #e2e8f0;
  border-top-color:#2563eb;border-radius:50%;animation:spin .7s linear infinite;}
.tbb-prog{position:relative;overflow:hidden;}
.tbb-prog::after{content:'';position:absolute;left:0;top:0;height:100%;
  background:rgba(255,255,255,.28);width:var(--prog,0%);transition:width .3s;}
.tbb-pct{font-size:.65rem;opacity:.85;margin-left:4px;}

/* â”€â”€ CONSIDERATION TABS â”€â”€ */
.consid-tabs{display:flex;background:#fff;border-bottom:2px solid #e2e8f0;padding:0 18px;}
.ctab{padding:11px 24px;border:none;background:none;cursor:pointer;font-size:.85rem;
  font-weight:700;color:#64748b;border-bottom:3px solid transparent;margin-bottom:-2px;
  transition:all .2s;display:flex;align-items:center;gap:8px;white-space:nowrap;}
.ctab:hover{color:#1e3a5f;background:#f0f7ff;}
.ctab.active{color:#1e3a5f;border-bottom-color:#2563eb;background:#f0f7ff;}
.ctab .cbadge{font-size:.7rem;background:#e0e7ff;color:#2563eb;border-radius:12px;
  padding:1px 8px;font-weight:700;}
.ctab.active .cbadge{background:#2563eb;color:#fff;}
.consid-panel{display:none;}
.consid-panel.active{display:block;}
.consid-banner{display:flex;align-items:flex-start;gap:10px;background:#eff6ff;
  border-left:4px solid #2563eb;padding:8px 18px;font-size:.73rem;color:#1d4ed8;line-height:1.5;}
.consid-banner.sys{background:#faf5ff;border-left-color:#7c3aed;color:#5b21b6;}
.consid-banner .cbi{font-size:1.2rem;flex-shrink:0;}
.consid-banner strong{font-size:.78rem;display:block;margin-bottom:1px;}

/* â”€â”€ SIDE LAYOUT: diagram left, actions table right â”€â”€ */
.panel-body{display:flex;align-items:flex-start;gap:0;}
.diagram-side{flex:1;min-width:0;overflow-x:auto;}
.actions-side{
  width:370px;flex-shrink:0;
  border-left:2px solid #e2e8f0;
  background:#fff;
  display:flex;flex-direction:column;
  position:sticky;top:0;
  align-self:flex-start;
  max-height:calc(100vh - 120px);
  overflow-y:auto;
}

/* â”€â”€ CORRECTIVE ACTIONS TABLE â”€â”€ */
.ca-hdr{
  background:linear-gradient(135deg,#1d4ed8,#2563eb);
  color:#fff;font-size:.72rem;font-weight:800;
  text-transform:uppercase;letter-spacing:.06em;
  padding:9px 14px;text-align:center;
}
.ca-hdr.sys-hdr{background:linear-gradient(135deg,#5b21b6,#7c3aed);}
.ca-row-hdr{
  display:grid;
  grid-template-columns:28px 20px 1fr 26px 76px 88px;
  background:#f8faff;
  border-bottom:2px solid #e2e8f0;
  padding:4px 0;
}
.ca-col{
  font-size:.6rem;font-weight:800;color:#64748b;
  text-transform:uppercase;letter-spacing:.04em;
  display:flex;align-items:center;justify-content:center;
  padding:2px 4px;
}
.ca-row{
  display:grid;
  grid-template-columns:28px 20px 1fr 26px 76px 88px;
  border-bottom:1px solid #f1f5f9;
  min-height:44px;
  transition:background .15s;
}
.ca-row:hover{background:#fafbff;}
.ca-row.act-pinned{background:#fffbeb !important;border-left:2.5px solid #f59e0b;}
.ca-lbl{
  font-size:.65rem;font-weight:800;color:#64748b;
  display:flex;align-items:center;justify-content:center;
  background:#f8faff;border-right:1px solid #e2e8f0;
}
/* action pin button */
.ca-pin-btn{
  border:none;background:none;cursor:pointer;
  font-size:.75rem;padding:1px 2px;
  display:flex;align-items:center;justify-content:center;
  opacity:.22;transition:.15s;color:#64748b;
  border-right:1px solid #f1f5f9;
}
.ca-pin-btn:hover{opacity:1;background:#fef3c7;}
.ca-pin-btn.pinned{opacity:1;color:#f59e0b;filter:drop-shadow(0 0 2px #fcd34d);}
.ca-input{
  border:none;outline:none;resize:none;background:transparent;
  font-size:.76rem;color:#1e293b;font-family:inherit;
  padding:6px 7px;width:100%;line-height:1.4;
  min-height:44px;
}
.ca-input:focus{background:#f0f7ff;}
.ca-ai-btn{
  border:none;background:none;cursor:pointer;
  font-size:.85rem;padding:0 3px;
  display:flex;align-items:center;justify-content:center;
  border-left:1px solid #f1f5f9;
  border-right:1px solid #f1f5f9;
  color:#f59e0b;transition:.15s;
}
.ca-ai-btn:hover{background:#fef3c7;}
.ca-ai-btn.loading{animation:spin .6s linear infinite;pointer-events:none;}
@keyframes spin{to{transform:rotate(360deg);}}
.ca-cell{
  border-left:1px solid #f1f5f9;
  display:flex;align-items:center;padding:4px 5px;
}
.ca-sinput{
  border:none;outline:none;background:transparent;
  font-size:.74rem;color:#1e293b;font-family:inherit;
  width:100%;padding:2px 2px;
}
.ca-sinput[type=date]{font-size:.68rem;color:#475569;}
.ca-section-lbl{
  font-size:.62rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.06em;padding:5px 10px;
  border-bottom:1px solid #e2e8f0;
}
.ca-section-lbl.os-lbl{background:#eff6ff;color:#1d4ed8;border-left:3px solid #2563eb;}
.ca-section-lbl.nd-lbl{background:#f5f3ff;color:#5b21b6;border-left:3px solid #7c3aed;}

@media print{
  .topbar,.meta-bar,.legend,.sacts,.add-step-btn,.tbb,.consid-tabs{display:none!important;}
  body,.canvas-outer{background:#fff;}
  .consid-panel{display:block!important;}
  .actions-side{position:static;max-height:none;}
}
</style>
</head>
<body>

<div class="topbar">
  <span style="font-size:1.3rem">ğŸ”</span>
  <h1>5 Neden Analizi</h1>
  <div class="sp"></div>
  <button class="tbb" style="background:linear-gradient(135deg,rgba(124,58,237,.7),rgba(37,99,235,.7));border-color:rgba(167,139,250,.5);" onclick="openAiModal()">ğŸ¤– AI ile OluÅŸtur</button>
  <button class="tbb" id="yenileTech" style="background:linear-gradient(135deg,#059669,#0891b2);" onclick="aiRefresh('tech')" title="Technical iz adÄ±mlarÄ±nÄ± AI ile yeniden oluÅŸtur">ğŸ”„ Teknik Yenile</button>
  <button class="tbb" id="yenileSys" style="background:linear-gradient(135deg,#7c3aed,#a21caf);" onclick="aiRefresh('sys')" title="Systemic iz adÄ±mlarÄ±nÄ± AI ile yeniden oluÅŸtur">ğŸ”„ Sistemsel Yenile</button>
  <button class="tbb ok"    onclick="saveData()">ğŸ’¾ Kaydet</button>
  <button class="tbb"       onclick="loadData()">ğŸ“‚ YÃ¼kle</button>
  <button class="tbb"       onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r / PDF</button>
  <button class="tbb danger" onclick="resetAll()">ğŸ—‘ SÄ±fÄ±rla</button>
</div>

<div class="meta-bar">
  <div class="mf"><label>Problem / ParÃ§a No</label><input id="mPart" placeholder="Ã¶rn: Part# 12345 â€“ Vida"></div>
  <div class="mf"><label>MÃ¼ÅŸteri / Proje</label><input id="mCustomer" placeholder="Ã¶rn: ArÃ§elik A.Å."></div>
  <div class="mf" style="max-width:155px"><label>Tarih</label><input id="mDate" type="date"></div>
  <div class="mf"><label>Analist</label><input id="mAnalyst" placeholder="Ã¶rn: Kalite MÃ¼dÃ¼rÃ¼"></div>
  <div class="mf" style="max-width:172px"><label>Durum</label>
    <select id="mStatus">
      <option>ğŸ”„ Devam Ediyor</option>
      <option>âœ… TamamlandÄ±</option>
      <option>ğŸ” Ä°ncelemede</option>
    </select>
  </div>
</div>

<div class="legend">
  <strong>GÃ¶sterim:</strong>
  <div class="li"><div class="lb n"></div><span>Neden adÄ±mÄ±</span></div>
  <div class="li"><div class="lb r"></div><span>KÃ¶k neden (son adÄ±m)</span></div>
  <span style="color:#94a3b8;font-size:.65rem">
    | â• AdÄ±m Ekle â†’ zincire yeni neden ekler &nbsp;Â·&nbsp;
    ğŸª¢ Paralel Dal â†’ aynÄ± noktadan baÄŸÄ±msÄ±z bir zincir baÅŸlatÄ±r (5N literatÃ¼rÃ¼ndeki "branching") &nbsp;Â·&nbsp;
    Ã‡ift tÄ±kla â†’ bÃ¼yÃ¼k metin editÃ¶rÃ¼
  </span>
</div>

<!-- â”€â”€ CONSIDERATION TABS NAV â”€â”€ -->
<div class="consid-tabs">
  <button class="ctab active" id="ctab-tech" onclick="switchConsid('tech',this)">
    ğŸ”§ Technical Consideration <span class="cbadge">Teknik</span>
  </button>
  <button class="ctab" id="ctab-sys" onclick="switchConsid('sys',this)">
    ğŸ—ï¸ Systemic Consideration <span class="cbadge">Sistemsel</span>
  </button>
</div>

<!-- â•â•â•â• PANEL: TECHNICAL â•â•â•â• -->
<div class="consid-panel active" id="panel-tech">
  <div class="consid-banner">
    <span class="cbi">ğŸ”§</span>
    <div>
      <strong>Technical Consideration â€” Teknik DeÄŸerlendirme</strong>
      ÃœrÃ¼nÃ¼n, prosesin veya ekipmanÄ±n teknik olarak neden hataya yol aÃ§tÄ±ÄŸÄ±nÄ± inceler:
      Parametre yanlÄ±ÅŸlÄ±ÄŸÄ± Â· Makine ayarÄ± Â· Malzeme spesifikasyonu Â· Tolerans aÅŸÄ±mÄ± Â· Ã–lÃ§Ã¼m sistemi hatasÄ±
      <em style="font-style:normal;font-weight:700;"> â†’ "Hata nasÄ±l oluÅŸtu?"</em>
    </div>
  </div>
  <div class="panel-body">
    <div class="diagram-side">
      <div class="canvas-outer" id="co-tech">
        <!-- OluÅŸum track - Technical -->
        <div class="track-wrap">
          <div class="track-hdr">
            <span class="tbadge os">ğŸ”´ OluÅŸum</span>
            <span class="tsub">Neden problem oluÅŸtu? â€” her adÄ±m Ã¶ncekinin nedenidir</span>
          </div>
          <div class="diag" id="tech_osDiag"><svg id="tech_osSvg"></svg></div>
          <button class="add-step-btn" onclick="addStep('tech','os')">â• AdÄ±m Ekle</button>
        </div>
        <!-- Tespit track - Technical -->
        <div class="track-wrap">
          <div class="track-hdr">
            <span class="tbadge nd">ğŸŸ£ Tespit Edilememe</span>
            <span class="tsub">Problem neden fark edilmedi? (Teknik kontrol mekanizmasÄ±)</span>
          </div>
          <div class="diag" id="tech_ndDiag"><svg id="tech_ndSvg"></svg></div>
          <button class="add-step-btn nd" onclick="addStep('tech','nd')">â• AdÄ±m Ekle</button>
        </div>
      </div>
    </div>
    <div class="actions-side" id="actions-tech"></div>
  </div>
</div>

<!-- â•â•â•â• PANEL: SYSTEMIC â•â•â•â• -->
<div class="consid-panel" id="panel-sys">
  <div class="consid-banner sys">
    <span class="cbi">ğŸ—ï¸</span>
    <div>
      <strong>Systemic Consideration â€” Sistemsel DeÄŸerlendirme</strong>
      Bu teknik hatanÄ±n neden sistem tarafÄ±ndan engellenemediÄŸini inceler:
      Kontrol planÄ± yeterliliÄŸi Â· PFMEA risk tespiti Â· OperatÃ¶r eÄŸitimi Â· Denetim frekansÄ± Â· YÃ¶netim sistemi aÃ§Ä±ÄŸÄ±
      <em style="font-style:normal;font-weight:700;"> â†’ "Sistem neden yakalayamadÄ±?"</em>
    </div>
  </div>
  <div class="panel-body">
    <div class="diagram-side">
      <div class="canvas-outer" id="co-sys">
        <!-- OluÅŸum track - Systemic -->
        <div class="track-wrap">
          <div class="track-hdr">
            <span class="tbadge os">ğŸ”´ OluÅŸum</span>
            <span class="tsub">Sistem neden hatanÄ±n oluÅŸmasÄ±na izin verdi? â€” PFMEA / prosedÃ¼r / organizasyon aÃ§Ä±klarÄ±</span>
          </div>
          <div class="diag" id="sys_osDiag"><svg id="sys_osSvg"></svg></div>
          <button class="add-step-btn" onclick="addStep('sys','os')">â• AdÄ±m Ekle</button>
        </div>
        <!-- Tespit track - Systemic -->
        <div class="track-wrap">
          <div class="track-hdr">
            <span class="tbadge nd">ğŸŸ£ Tespit Edilememe</span>
            <span class="tsub">Sistem neden kaÃ§Ä±rmaya izin verdi? â€” Kontrol planÄ±, iÃ§ denetim, reaksiyon planÄ± eksiklikleri</span>
          </div>
          <div class="diag" id="sys_ndDiag"><svg id="sys_ndSvg"></svg></div>
          <button class="add-step-btn nd" onclick="addStep('sys','nd')">â• AdÄ±m Ekle</button>
        </div>
      </div>
    </div>
    <div class="actions-side" id="actions-sys"></div>
  </div>
</div>

<!-- AI MODAL -->
<div class="ai-modal" id="aiModal">
  <div class="ai-box">
    <h3>ğŸ¤– AI ile 5 Neden Analizi OluÅŸtur</h3>
    <!-- Provider selector -->
    <div class="ai-provider-tabs">
      <button class="ai-ptab active" id="tabGroq"   onclick="setProvider('groq')">ğŸŸ  Groq</button>
      <button class="ai-ptab or"  id="tabOR"     onclick="setProvider('openrouter')">ğŸŸ£ OpenRouter</button>
      <button class="ai-ptab gem" id="tabGemini" onclick="setProvider('gemini')">ğŸ”µ Gemini</button>
    </div>

    <!-- wizard progress dots -->
    <div class="wiz-dots" id="wizDots"></div>

    <!-- step content -->
    <div id="wizStep"></div>

    <!-- API key blocks (one shown at a time) -->
    <div id="keyBlockGroq">
      <label class="ai-label">Groq API Key</label>
      <input class="ai-key" id="aiKey" type="password" placeholder="gsk_...">
      <div class="key-hint">Ãœcretsiz Â· <a href="https://console.groq.com" target="_blank">console.groq.com â†’ API Keys â†’</a></div>
    </div>
    <div id="keyBlockGemini" style="display:none">
      <label class="ai-label">Google AI Studio API Key</label>
      <input class="ai-key" id="aiKeyGemini" type="password" placeholder="AIzaSy...">
      <div class="key-hint">Ãœcretsiz Â· <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com â†’ Get API key â†’</a></div>
    </div>
    <div id="keyBlockOR" style="display:none">
      <label class="ai-label">OpenRouter API Key</label>
      <input class="ai-key" id="aiKeyOR" type="password" placeholder="sk-or-...">
      <div class="key-hint">Ãœcretsiz Â· <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai â†’ Keys â†’</a></div>
      <select class="or-model-sel" id="orModel">
        <option value="deepseek/deepseek-r1:free">â­ DeepSeek R1 â€” En Ä°yi (Ã¼cretsiz)</option>
        <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B (Ã¼cretsiz)</option>
        <option value="qwen/qwen-2.5-72b-instruct:free">Qwen 2.5 72B (Ã¼cretsiz)</option>
        <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Ã¼cretsiz)</option>
        <option value="mistralai/mistral-small-3.1-24b-instruct:free">Mistral Small 3.1 (Ã¼cretsiz)</option>
      </select>
    </div>

    <div id="aiStatus" style="margin-top:10px;min-height:18px;"></div>

    <div class="ai-actions">
      <button class="aib cancel" onclick="closeAiModal()">Ä°ptal</button>
      <div class="ai-actions-right">
        <button class="aib back" id="wizBack" onclick="wizNav(-1)">â† Geri</button>
        <button class="aib next" id="wizNext" onclick="wizNav(1)">Ä°leri â†’</button>
        <button class="aib gen" id="aiGenBtn" onclick="aiGenerate()" style="display:none">âœ¨ Analizi OluÅŸtur</button>
      </div>
    </div>
  </div>
</div>

<div class="mo" id="editModal">
  <div class="mb">
    <h3 id="mTitle">âœï¸ Nedeni DÃ¼zenle</h3>
    <textarea id="mTa" rows="4" placeholder="Nedeni buraya yazÄ±nâ€¦"></textarea>
    <div class="mbts">
      <button class="mbt c" onclick="closeModal()">Ä°ptal</button>
      <button class="mbt s" onclick="saveModal()">Kaydet</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  5 NEDEN   â€“  STAIRCASE LAYOUT
//  Referans: Her "Neden?" kutusu Ã¶ncekinden saÄŸa ve
//  biraz aÅŸaÄŸÄ±ya kayar â†’ merdiven efekti.
//  "Paralel Dal": AynÄ± noktadan baÄŸÄ±msÄ±z ikinci bir
//  doÄŸrusal zincir baÅŸlar, ana zincirin altÄ±nda yÃ¼rÃ¼r.
//
//  Veri modeli:
//  track:
//    problem : string
//    rcText  : string
//    chains  : Chain[]        â† chains[0] = ana zincir, chains[1..] = paralel dallar
//
//  Chain:
//    startAfterStep : number | null  (hangi ana adÄ±mdan dallandÄ±ÄŸÄ±, null=ana)
//    steps          : Step[]
//
//  Step: { id, text, isRoot }
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BOX_W    = 175;
const BOX_H    = 92;
const PROB_W   = 170;
const PROB_H   = 84;
const RCB_W    = 155;
const RCB_H    = 108;
const H_GAP    = 80;    // horizontal gap between box right and next box left (arrow space)
const V_STEP   = 72;    // how much lower each main-chain step is vs the previous
const BRANCH_V = 28;    // extra vertical gap between branches at same column
const COL_W    = BOX_W + H_GAP;   // full column stride

let _activeTab = 'tech';   // 'tech' | 'sys'

function switchConsid(tab, btn){
  _activeTab = tab;
  document.querySelectorAll('.consid-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ctab').forEach(b=>b.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  btn.classList.add('active');
}

let _S = {
  meta: {},
  tech: {
    os: { problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(OluÅŸum)',
          problemPinned:false, rcPinned:false,
          chains: [ { startAfter:null, steps:[ mkStep() ] } ] },
    nd: { problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(Tespit Edilememe)',
          problemPinned:false, rcPinned:false,
          chains: [ { startAfter:null, steps:[ mkStep() ] } ] },
    actions: { os:[], nd:[] }
  },
  sys: {
    os: { problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Sistemsel KÃ¶k Neden\n(OluÅŸum)',
          problemPinned:false, rcPinned:false,
          chains: [ { startAfter:null, steps:[ mkStep() ] } ] },
    nd: { problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Sistemsel KÃ¶k Neden\n(Tespit Edilememe)',
          problemPinned:false, rcPinned:false,
          chains: [ { startAfter:null, steps:[ mkStep() ] } ] },
    actions: { os:[], nd:[] }
  }
};

function mkStep(t){ return {id:uid(), text:t||'', isRoot:false, pinned:false}; }
function uid(){ return 'n'+Math.random().toString(36).slice(2,9); }

let _mCb = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addStep(tab, tk){
  _S[tab][tk].chains[0].steps.push(mkStep());
  renderTrack(tab, tk);
}

function deleteStep(tab, tk, chainIdx, stepIdx){
  const chain = _S[tab][tk].chains[chainIdx];
  chain.steps.splice(stepIdx,1);
  if(chain.steps.length===0){
    if(chainIdx===0) chain.steps.push(mkStep());
    else _S[tab][tk].chains.splice(chainIdx,1);
  }
  renderTrack(tab, tk);
}

function addParallelBranch(tab, tk, afterMainStepIdx){
  _S[tab][tk].chains.push({ startAfter: afterMainStepIdx, steps: [mkStep()] });
  renderTrack(tab, tk);
}

function addBranchStep(tab, tk, chainIdx){
  _S[tab][tk].chains[chainIdx].steps.push(mkStep());
  renderTrack(tab, tk);
}

function toggleRoot(tab, tk, chainIdx, stepIdx){
  const s = _S[tab][tk].chains[chainIdx].steps[stepIdx];
  s.isRoot = !s.isRoot;
  renderTrack(tab, tk);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAYOUT  â€“ merdiven (staircase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLayout(tab, tk){
  const track = _S[tab][tk];
  const items = [];   // { type, data, x, y, w, h, cx, cy }
  const conns = [];   // { x1,y1,x2,y2, dashed, label }

  const mainChain = track.chains[0];
  const mainLen   = mainChain.steps.length;

  // â”€â”€ Main chain: step[i] at col i+1, y = i*V_STEP  (merdiven: right+down) â”€â”€
  const mainItems = [];
  for(let i=0;i<mainLen;i++){
    const x  = (i+1)*COL_W;
    const y  = i*V_STEP;
    const cx = x+BOX_W, cy = y+BOX_H/2;
    mainItems.push({ type:'step', chain:0, stepIdx:i, flatIdx:i,
      data:mainChain.steps[i], x, y, w:BOX_W, h:BOX_H, cx, cy, tab, tk });
    items.push(mainItems[i]);
  }

  // Problem box aligned to first main step
  const probCY = mainItems.length ? mainItems[0].cy : BOX_H/2;
  const probY  = probCY - PROB_H/2;
  items.unshift({ type:'prob', tk, x:0, y:probY, w:PROB_W, h:PROB_H, cx:PROB_W, cy:probCY });

  // Connectors: probâ†’step[0], step[i]â†’step[i+1]  forward direction (leftâ†’right / Neden?)
  if(mainItems.length>0)
    conns.push({ x1:PROB_W, y1:probCY, x2:mainItems[0].x, y2:mainItems[0].cy, label:'why' });
  for(let i=0;i<mainItems.length-1;i++)
    conns.push({ x1:mainItems[i].cx,  y1:mainItems[i].cy,
                 x2:mainItems[i+1].x, y2:mainItems[i+1].cy, label:'why' });

  // â”€â”€ Parallel branch chains â”€â”€
  // Each branch starts BELOW its fork step, continues staircase (right+down)
  // colBottomY tracks the lowest Y used at each column (main + branches)
  const colBottomY = {};
  // allPlaced holds every step item placed so far (main + branches) for fork lookup
  const allPlaced = [...mainItems];

  for(const it of mainItems){
    const col = Math.round(it.x / COL_W);
    colBottomY[col] = Math.max(colBottomY[col]||0, it.y + it.h);
  }

  const allBranchLastItems = [];   // last step of each branch chain (for RCB connectors)

  for(let ci=1; ci<track.chains.length; ci++){
    const chain    = track.chains[ci];
    const sa       = chain.startAfter ?? 0;   // column index of the fork step
    const forkCol  = sa;
    const startCol = sa;                      // branch STARTS at same column as fork (below it)  

    // Find the actual fork anchor from all placed items at forkCol
    const forkCandidates = allPlaced.filter(it => Math.round(it.x / COL_W) === forkCol);
    const forkAnchor = forkCandidates.length
      ? forkCandidates.reduce((a,b) => b.cy > a.cy ? b : a)
      : { cx: forkCol * COL_W + BOX_W/2, cy: probCY, y: probCY - BOX_H/2, h: BOX_H };

    // branchTopY: directly below the fork anchor, also below anything already at startCol
    let branchTopY = forkAnchor.y + forkAnchor.h + BRANCH_V;
    if(colBottomY[startCol] !== undefined)
      branchTopY = Math.max(branchTopY, colBottomY[startCol] + BRANCH_V);

    const brItems = [];

    // flat index offset for this branch chain
    let _brOffset = mainLen;
    for(let j=1;j<ci;j++) _brOffset += track.chains[j].steps.length;

    for(let si=0; si<chain.steps.length; si++){
      // Merdiven: each branch step also goes right+down like main chain
      const x  = (startCol + si) * COL_W;
      const y  = branchTopY + si * V_STEP;
      const cx = x+BOX_W, cy = y+BOX_H/2;
      const it = { type:'step', chain:ci, stepIdx:si, flatIdx:_brOffset+si,
        data:chain.steps[si], x, y, w:BOX_W, h:BOX_H, cx, cy, tab, tk, isBranch:true };
      brItems.push(it);
      items.push(it);
      allPlaced.push(it);
      const col = Math.round(x/COL_W);
      colBottomY[col] = Math.max(colBottomY[col]||0, y+BOX_H);
    }

    // Fork connector: straight DOWN from fork anchor to first branch step (same column)
    if(brItems.length)
      conns.push({ x1:forkAnchor.cx, y1:forkAnchor.cy,
                   x2:brItems[0].cx - BOX_W/2, y2:brItems[0].y, label:'', dashed:true });
    // Branch internal connectors (forward direction)
    for(let si=0; si<brItems.length-1; si++)
      conns.push({ x1:brItems[si].cx,  y1:brItems[si].cy,
                   x2:brItems[si+1].x, y2:brItems[si+1].cy, label:'why' });

    if(brItems.length) allBranchLastItems.push(brItems[brItems.length-1]);

    // "+ Dal AdÄ±mÄ±" button: positioned inline to the right of last branch step
    if(brItems.length){
      const last = brItems[brItems.length-1];
      items.push({ type:'addBranchStep', ci, tab, tk,
        x: last.cx + H_GAP * 0.3,
        y: last.y });   // renderer adds BOX_H/2 offset itself
    }
  }

  // â”€â”€ Root cause box â”€â”€
  // Always placed to the right of the RIGHTMOST step (main or branch),
  // so it's always visually at the bottom-right end of the staircase.
  const allStepItems = [...mainItems, ...allBranchLastItems];
  let rcbX, rcbY;
  if(allStepItems.length){
    // The anchor is whichever step has the largest cx (= rightmost edge)
    const anchor = allStepItems.reduce((a,b) => b.cx > a.cx ? b : a);
    rcbX = anchor.cx + H_GAP;
    rcbY = anchor.cy - RCB_H/2;
  } else {
    rcbX = COL_W; rcbY = 0;
  }

  // Main chain â†’ RCB connector
  if(mainItems.length){
    const last = mainItems[mainItems.length-1];
    conns.push({ x1:last.cx, y1:last.cy, x2:rcbX, y2:rcbY+RCB_H/2, label:'why', toRcb:true });
    // "+ Dal AdÄ±mÄ±" button for main chain's last step (in the gap before RCB)
    items.push({ type:'addBranchStep', ci:0, tab, tk,
      x: last.cx + H_GAP * 0.3,
      y: last.y });
  }
  // Each branch last step â†’ RCB connector (dashed)
  for(const bl of allBranchLastItems)
    conns.push({ x1:bl.cx, y1:bl.cy, x2:rcbX, y2:rcbY+RCB_H/2, label:'', dashed:true });

  items.push({ type:'rcb', tab, tk, x:rcbX, y:rcbY, w:RCB_W, h:RCB_H });

  // Canvas size
  const xs = items.map(i=>i.x+(i.w||BOX_W));
  const ys = items.map(i=>i.y+(i.h||BOX_H));
  const W = Math.max(...xs) + 40;
  const H = Math.max(...ys) + 30;
  return { items, conns, W, H };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  renderTrack('tech','os'); renderTrack('tech','nd');
  renderTrack('sys','os');  renderTrack('sys','nd');
  renderActionTable('tech');
  renderActionTable('sys');
}

function renderTrack(tab, tk){
  const diagId = tab+'_'+tk+'Diag';
  const svgId  = tab+'_'+tk+'Svg';
  const diag   = document.getElementById(diagId);
  const svg    = document.getElementById(svgId);
  if(!diag || !svg) return;
  // Clear all children except svg
  Array.from(diag.childNodes).forEach(c=>{ if(c!==svg) diag.removeChild(c); });
  svg.innerHTML = '';

  const {items, conns, W, H} = doLayout(tab, tk);
  diag.style.width  = W+'px';
  diag.style.height = H+'px';
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);

  const uid = tab+'_'+tk;
  svg.innerHTML = `<defs>
    <marker id="ab_${uid}"  markerWidth="12" markerHeight="8" refX="11" refY="4" orient="auto">
      <polygon points="0 0, 12 4, 0 8" fill="#3b82f6" opacity="0.85"/>
    </marker>
    <marker id="abr_${uid}" markerWidth="12" markerHeight="8" refX="11" refY="4" orient="auto">
      <polygon points="0 0, 12 4, 0 8" fill="#8b5cf6" opacity="0.75"/>
    </marker>
    <filter id="glow_${uid}" x="-30%" y="-30%" width="160%" height="160%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>`;

  for(const c of conns) drawConn(svg, c, uid);
  for(const it of items){
    if(it.type==='prob')          renderProbBox(diag, it, tab, tk);
    else if(it.type==='step')     renderStepBox(diag, it, tab, tk);
    else if(it.type==='rcb')      renderRcbBox(diag, it, tab, tk);
    else if(it.type==='addBranchStep') renderAddBranchBtn(diag, it, tab, tk);
  }
}

function drawConn(svg, c, tk){
  const dx = c.x2-c.x1, dy = c.y2-c.y1;
  const absDx = Math.abs(dx), absDy = Math.abs(dy);
  const isDiag = absDy > 10;
  let d;
  // Store control points so we can reuse them for label bezier evaluation
  let cx1, cy1, cx2, cy2;

  if(c.dashed && !c.label){
    // Fork / branch connector â€” vertical or near-vertical dashed drop
    if(absDx < 24){
      d = `M${c.x1},${c.y1} L${c.x2},${c.y2}`;
      cx1=c.x1; cy1=(c.y1+c.y2)/2; cx2=c.x2; cy2=(c.y1+c.y2)/2;
    } else {
      cx1 = c.x1; cy1 = c.y1 + absDy*0.45;
      cx2 = c.x2; cy2 = c.y2 - absDy*0.25;
      d = `M${c.x1},${c.y1} C${cx1},${cy1} ${cx2},${cy2} ${c.x2},${c.y2}`;
    }
  } else if(isDiag){
    // Staircase diagonal connector â€” horizontal S-bezier
    // Both control points locked to source/target Y â†’ departs & arrives perfectly horizontal.
    cx1 = c.x1 + absDx * 0.5; cy1 = c.y1;
    cx2 = c.x2 - absDx * 0.5; cy2 = c.y2;
    d = `M${c.x1},${c.y1} C${cx1},${cy1} ${cx2},${cy2} ${c.x2},${c.y2}`;
  } else {
    // Horizontal / near-horizontal connector
    cx1 = c.x1 + dx * 0.4; cy1 = c.y1;
    cx2 = c.x2 - dx * 0.4; cy2 = c.y2;
    d = `M${c.x1},${c.y1} C${cx1},${cy1} ${cx2},${cy2} ${c.x2},${c.y2}`;
  }

  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d', d);
  path.setAttribute('fill','none');

  const isViolet = !!c.dashed;
  const color  = isViolet ? '#8b5cf6' : '#3b82f6';
  const marker = isViolet ? `url(#abr_${tk})` : `url(#ab_${tk})`;
  path.setAttribute('stroke', color);
  path.setAttribute('stroke-width', isViolet ? '1.8' : '2.2');
  path.setAttribute('stroke-linecap', 'round');
  if(c.dashed) path.setAttribute('stroke-dasharray','7,4');
  path.setAttribute('marker-end', marker);
  svg.appendChild(path);

  if(c.label==='why' && !c.toRcb){
    // Rule: [Sol kutu] â€”â€”Neden?â€”â€”â†’ â€”â€”Ã‡Ã¼nkÃ¼â€”â€”â†’ [SaÄŸ kutu]
    // Labels sit ON the bezier curve at exact t-parameter positions:
    //   "Neden?"  tâ‰ˆ0.12  â†’ just after source box (reads as question FROM left box)
    //   "Ã‡Ã¼nkÃ¼"  tâ‰ˆ0.82  â†’ just before target box (reads as answer TO right box)
    const pQ = bezPt(c.x1,c.y1, cx1,cy1, cx2,cy2, c.x2,c.y2, 0.12);
    const pA = bezPt(c.x1,c.y1, cx1,cy1, cx2,cy2, c.x2,c.y2, 0.82);
    svgTxt(svg, pQ.x + 3, pQ.y - 6, 'Neden?', '#1d4ed8', true,  10);
    svgTxt(svg, pA.x - 22, pA.y - 6, 'Ã‡Ã¼nkÃ¼',  '#6b7280', false,  9);
  }
}

// Evaluate cubic bezier at parameter t â†’ {x, y}
function bezPt(x1,y1,cx1,cy1,cx2,cy2,x2,y2,t){
  const u=1-t;
  return {
    x: u*u*u*x1 + 3*u*u*t*cx1 + 3*u*t*t*cx2 + t*t*t*x2,
    y: u*u*u*y1 + 3*u*u*t*cy1 + 3*u*t*t*cy2 + t*t*t*y2
  };
}

function svgTxt(svg, x, y, t, fill, bold, size){
  const el = document.createElementNS('http://www.w3.org/2000/svg','text');
  el.setAttribute('x',x); el.setAttribute('y',y);
  el.setAttribute('fill',fill); el.setAttribute('font-size',size);
  el.setAttribute('font-family','Segoe UI,Arial,sans-serif');
  if(bold) el.setAttribute('font-weight','700');
  el.textContent = t;
  svg.appendChild(el);
}

function renderProbBox(diag, it, tab, tk){
  const pinned = !!_S[tab][tk].problemPinned;
  const d = div('pbox'+(tk==='nd'?' nd-t':'')+(pinned?' is-pinned':''), it.x, it.y, it.w, it.h);
  d.innerHTML = `<div class="plbl">Problem TanÄ±mÄ±</div>
    <textarea placeholder="Problemi yazÄ±nâ€¦"></textarea>
    <button class="pin-btn${pinned?' pinned':''}" title="${pinned?'Sabiti kaldÄ±r':'Sabitle'}">&#128204;</button>`;
  d.querySelector('textarea').value = _S[tab][tk].problem;
  d.querySelector('textarea').oninput = e => { _S[tab][tk].problem = e.target.value; };
  d.querySelector('.pin-btn').onclick = ()=>{ _S[tab][tk].problemPinned = !_S[tab][tk].problemPinned; renderTrack(tab, tk); };
  diag.appendChild(d);
}

function renderStepBox(diag, it, tab, tk){
  const node = it.data;
  const pinned = !!node.pinned;
  const prefix = tk === 'os' ? 'A' : 'B';
  const numLbl = it.flatIdx !== undefined ? prefix + (it.flatIdx + 1) : '';
  const el   = div('sbox'+(node.isRoot?' is-root':'')+(pinned?' is-pinned':''), it.x, it.y, it.w, it.h);
  el.innerHTML = (numLbl?`<span class="step-num-lbl${tk==='nd'?' nd-lbl':''}">${numLbl}</span>`:'')+
                 (node.isRoot?`<span class="stag">ğŸ¯ KÃ¶k Neden</span>`:'') +
    `<button class="pin-btn${pinned?' pinned':''}" title="${pinned?'Sabiti kaldÄ±r':'Sabitle'}">&#128204;</button>
     <textarea placeholder="Nedeni yazÄ±nâ€¦"></textarea>
     <div class="sacts">
       <button class="sa del" title="Sil">ğŸ—‘</button>
       <button class="sa add" title="Bu adÄ±mdan zincire devam et (saÄŸa uzat)">â• AdÄ±m</button>
       <button class="sa fork" title="Bu noktadan paralel baÄŸÄ±msÄ±z bir zincir baÅŸlat (dal)">ğŸª¢ Paralel Dal</button>
       <button class="sa root">${node.isRoot?'ğŸ¯ KÃ¶k âœ“':'ğŸ¯ KÃ¶k Neden'}</button>
     </div>`;
  el.querySelector('.pin-btn').onclick = ()=>{ node.pinned = !node.pinned; renderTrack(tab, tk); };

  const ta = el.querySelector('textarea');
  ta.value = node.text;
  ta.oninput = e => { node.text = e.target.value; };
  ta.addEventListener('dblclick', e=>{
    e.stopPropagation();
    openModal('âœï¸ Nedeni DÃ¼zenle', node.text, val=>{ node.text=val; renderTrack(tab, tk); });
  });
  el.querySelector('.del').onclick = ()=> deleteStep(tab, tk, it.chain, it.stepIdx);
  el.querySelector('.root').onclick = ()=> toggleRoot(tab, tk, it.chain, it.stepIdx);

  el.querySelector('.add').onclick = ()=>{
    // Extend THIS chain
    _S[tab][tk].chains[it.chain].steps.splice(it.stepIdx+1, 0, mkStep());
    renderTrack(tab, tk);
  };
  el.querySelector('.fork').onclick = ()=>{
    // column of the clicked step:
    //   main chain step[i]  â†’ col = i+1
    //   branch chain (startAfter=S) step[j] â†’ col = S+j
    let forkAt;
    if(it.chain === 0){
      forkAt = it.stepIdx + 1;   // main step i lives at column i+1
    } else {
      const sa = _S[tab][tk].chains[it.chain].startAfter ?? 0;
      forkAt = sa + it.stepIdx;  // branch step j of chain(startAfter=S) lives at col S+j
    }
    addParallelBranch(tab, tk, forkAt);
  };

  diag.appendChild(el);
}

function renderRcbBox(diag, it, tab, tk){
  const tabLabel = tab==='tech' ? 'Teknik' : 'Sistemsel';
  const trkLabel = tk==='os' ? 'KÃ¶k Neden (OluÅŸum)' : 'KÃ¶k Neden (Tespit)';
  const pinned = !!_S[tab][tk].rcPinned;
  const el = div('rcb'+(pinned?' is-pinned':''), it.x, it.y, it.w, it.h);
  el.innerHTML = `<div class="ri">â¬‡ï¸</div>
    <div class="rl">${tabLabel} ${trkLabel}</div>
    <textarea placeholder="KÃ¶k nedenâ€¦"></textarea>
    <button class="pin-btn${pinned?' pinned':''}" title="${pinned?'Sabiti kaldÄ±r':'Sabitle'}">&#128204;</button>`;
  el.querySelector('textarea').value = _S[tab][tk].rcText;
  el.querySelector('textarea').oninput = e => { _S[tab][tk].rcText = e.target.value; };
  el.querySelector('.pin-btn').onclick = ()=>{ _S[tab][tk].rcPinned = !_S[tab][tk].rcPinned; renderTrack(tab, tk); };
  diag.appendChild(el);
}

function renderAddBranchBtn(diag, it, tab, tk){
  // Small "add step to this branch" button
  const b = document.createElement('button');
  b.className = 'add-step-btn'+(tk==='nd'?' nd':'');
  b.style.cssText = `position:absolute;left:${it.x}px;top:${it.y+BOX_H/2}px;font-size:.64rem;padding:3px 9px;`;
  b.textContent = 'â• Dal AdÄ±mÄ±';
  b.onclick = () => addBranchStep(tab, tk, it.ci);
  diag.appendChild(b);
}

function div(cls, x, y, w, h){
  const el = document.createElement('div');
  el.className = cls;
  el.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${w}px;min-height:${h}px;`;
  return el;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, txt, cb){
  _mCb = cb;
  document.getElementById('mTitle').textContent = title;
  document.getElementById('mTa').value = txt;
  document.getElementById('editModal').classList.add('open');
  setTimeout(()=>document.getElementById('mTa').focus(), 60);
}
function closeModal(){ document.getElementById('editModal').classList.remove('open'); _mCb=null; }
function saveModal(){ if(_mCb) _mCb(document.getElementById('mTa').value); closeModal(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDEXED DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB='KaliteRaporDB', ST='payloads', KEY='5neden_v1';
function idbOpen(){
  return new Promise((ok,err)=>{
    const r=indexedDB.open(DB,1);
    r.onupgradeneeded=e=>e.target.result.createObjectStore(ST);
    r.onsuccess=e=>ok(e.target.result);
    r.onerror=e=>err(e.target.error);
  });
}
function idbPut(d){ return idbOpen().then(db=>new Promise((ok,er)=>{ const r=db.transaction(ST,'readwrite').objectStore(ST).put(d,KEY); r.onsuccess=()=>ok(); r.onerror=e=>er(e.target.error); })); }
function idbGet(){ return idbOpen().then(db=>new Promise((ok,er)=>{ const r=db.transaction(ST,'readonly').objectStore(ST).get(KEY); r.onsuccess=e=>ok(e.target.result); r.onerror=e=>er(e.target.error); })); }

function gatherMeta(){
  _S.meta={
    part:document.getElementById('mPart').value,
    customer:document.getElementById('mCustomer').value,
    date:document.getElementById('mDate').value,
    analyst:document.getElementById('mAnalyst').value,
    status:document.getElementById('mStatus').value
  };
}
function applyMeta(){
  const m=_S.meta||{};
  const map={mPart:'part',mCustomer:'customer',mDate:'date',mAnalyst:'analyst',mStatus:'status'};
  Object.entries(map).forEach(([id,k])=>{ if(m[k]) document.getElementById(id).value=m[k]; });
}
function saveData(){
  gatherMeta();
  idbPut(JSON.parse(JSON.stringify(_S)))
    .then(()=>alert('âœ… Analiz kaydedildi.'))
    .catch(e=>alert('âŒ '+e));
}
function loadData(){
  idbGet().then(d=>{
    if(!d){alert('KayÄ±tlÄ± analiz bulunamadÄ±.');return;}
    _S=d; applyMeta(); render(); alert('ğŸ“‚ Analiz yÃ¼klendi.');
  }).catch(e=>alert('âŒ '+e));
}
function resetAll(){
  if(!confirm('TÃ¼m analiz sÄ±fÄ±rlansÄ±n mÄ±?')) return;
  _S={
    meta:{},
    tech:{
      os:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden (OluÅŸum)',
          problemPinned:false, rcPinned:false, chains:[{startAfter:null, steps:[mkStep()]}]},
      nd:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden (Tespit)',
          problemPinned:false, rcPinned:false, chains:[{startAfter:null, steps:[mkStep()]}]},
      actions:{os:[],nd:[]}
    },
    sys:{
      os:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Sistemsel KÃ¶k Neden (OluÅŸum)',
          problemPinned:false, rcPinned:false, chains:[{startAfter:null, steps:[mkStep()]}]},
      nd:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Sistemsel KÃ¶k Neden (Tespit)',
          problemPinned:false, rcPinned:false, chains:[{startAfter:null, steps:[mkStep()]}]},
      actions:{os:[],nd:[]}
    }
  };
  ['mPart','mCustomer','mDate','mAnalyst'].forEach(id=>document.getElementById(id).value='');
  render();
}

document.getElementById('mDate').valueAsDate = new Date();
// Restore saved API keys and provider
(function(){
  const k  = localStorage.getItem('groq_api_key');   if(k)  document.getElementById('aiKey').value = k;
  const g  = localStorage.getItem('gemini_api_key'); if(g)  document.getElementById('aiKeyGemini').value = g;
  const or = localStorage.getItem('or_api_key');     if(or) document.getElementById('aiKeyOR').value = or;
  document.getElementById('aiKeyOR').oninput = e => localStorage.setItem('or_api_key', e.target.value.trim());
  const p = localStorage.getItem('ai_provider') || 'groq';
  setProvider(p);
})();
render();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CORRECTIVE ACTIONS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkAction(){ return {text:'', responsible:'', date:'', pinned:false}; }

function getAllSteps(tab, tk){
  const steps = [];
  _S[tab][tk].chains.forEach(ch => ch.steps.forEach(s => steps.push(s)));
  return steps;
}

function syncActions(tab, tk){
  if(!_S[tab].actions) _S[tab].actions = { os:[], nd:[] };
  const total = getAllSteps(tab, tk).length;
  while(_S[tab].actions[tk].length < total) _S[tab].actions[tk].push(mkAction());
  // trim extra if steps were deleted
  _S[tab].actions[tk].length = total;
}

function renderActionTable(tab){
  const el = document.getElementById('actions-'+tab);
  if(!el) return;
  ['os','nd'].forEach(tk => syncActions(tab, tk));

  el.innerHTML = '';
  const istech = tab === 'tech';

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'ca-hdr' + (istech ? '' : ' sys-hdr');
  hdr.textContent = istech ? 'DÃ¼zeltici Faaliyetler â€” Teknik' : 'DÃ¼zeltici Faaliyetler â€” Sistemsel';
  el.appendChild(hdr);

  // Column labels row
  const colHdr = document.createElement('div');
  colHdr.className = 'ca-row-hdr';
  colHdr.innerHTML =
    '<div class="ca-col">#</div>' +
    '<div class="ca-col" title="Sabitle">ğŸ“Œ</div>' +
    '<div class="ca-col" style="justify-content:flex-start;padding-left:8px;">Faaliyet</div>' +
    '<div class="ca-col">âš¡</div>' +
    '<div class="ca-col">Sorumlu</div>' +
    '<div class="ca-col">Termin</div>';
  el.appendChild(colHdr);

  buildActionSection(el, tab, 'os', 'A', 'ğŸ”´ OluÅŸum', 'os-lbl');
  buildActionSection(el, tab, 'nd', 'B', 'ğŸŸ£ Tespit',  'nd-lbl');
}

function buildActionSection(el, tab, tk, prefix, label, lblCls){
  const secLbl = document.createElement('div');
  secLbl.className = 'ca-section-lbl ' + lblCls;
  secLbl.textContent = label;
  el.appendChild(secLbl);

  const steps = getAllSteps(tab, tk);

  if(steps.length === 0){
    const empty = document.createElement('div');
    empty.style.cssText = 'font-size:.68rem;color:#94a3b8;padding:8px 12px;font-style:italic;';
    empty.textContent = 'HenÃ¼z adÄ±m eklenmedi.';
    el.appendChild(empty);
    return;
  }

  steps.forEach((step, i) => {
    if(!_S[tab].actions[tk][i]) _S[tab].actions[tk][i] = mkAction();
    const act = _S[tab].actions[tk][i];

    const row = document.createElement('div');
    row.className = 'ca-row' + (act.pinned ? ' act-pinned' : '');

    // #
    const lbl = document.createElement('div');
    lbl.className = 'ca-lbl';
    lbl.textContent = prefix + (i + 1);
    row.appendChild(lbl);

    // Pin button
    const pinBtn = document.createElement('button');
    pinBtn.className = 'ca-pin-btn' + (act.pinned ? ' pinned' : '');
    pinBtn.title = act.pinned ? 'Sabiti kaldÄ±r' : 'Faaliyet sabitle (AI yenilemesinde deÄŸiÅŸmez)';
    pinBtn.textContent = 'ğŸ“Œ';
    pinBtn.onclick = () => {
      act.pinned = !act.pinned;
      row.classList.toggle('act-pinned', act.pinned);
      pinBtn.classList.toggle('pinned', act.pinned);
      pinBtn.title = act.pinned ? 'Sabiti kaldÄ±r' : 'Faaliyet sabitle (AI yenilemesinde deÄŸiÅŸmez)';
    };
    row.appendChild(pinBtn);

    // Faaliyet textarea
    const ta = document.createElement('textarea');
    ta.className = 'ca-input';
    ta.placeholder = step.text ? step.text.slice(0, 35) + 'â€¦' : 'Faaliyet yazÄ±nâ€¦';
    ta.value = act.text;
    ta.title = step.text ? 'AdÄ±m: ' + step.text : '';
    ta.oninput = e => { act.text = e.target.value; };
    row.appendChild(ta);

    // AI suggest button
    const aiBtn = document.createElement('button');
    aiBtn.className = 'ca-ai-btn';
    aiBtn.title = 'AI ile faaliyet Ã¶ner';
    aiBtn.textContent = 'âš¡';
    aiBtn.onclick = () => aiSuggestAction(tab, tk, i, aiBtn, step, ta);
    row.appendChild(aiBtn);

    // Sorumlu
    const respCell = document.createElement('div');
    respCell.className = 'ca-cell';
    const resp = document.createElement('input');
    resp.className = 'ca-sinput';
    resp.type = 'text';
    resp.placeholder = 'Sorumluâ€¦';
    resp.value = act.responsible;
    resp.oninput = e => { act.responsible = e.target.value; };
    respCell.appendChild(resp);
    row.appendChild(respCell);

    // Tarih
    const dtCell = document.createElement('div');
    dtCell.className = 'ca-cell';
    const dt = document.createElement('input');
    dt.className = 'ca-sinput';
    dt.type = 'date';
    dt.value = act.date;
    dt.oninput = e => { act.date = e.target.value; };
    dtCell.appendChild(dt);
    row.appendChild(dtCell);

    el.appendChild(row);
  });
}

async function aiSuggestAction(tab, tk, idx, btn, step, ta){
  const _actProvider = localStorage.getItem('ai_provider') || 'groq';
  const _actKey = _actProvider==='gemini' ? localStorage.getItem('gemini_api_key') : localStorage.getItem('groq_api_key');
  if(!_actKey){ alert('Ã–nce "AI ile OluÅŸtur" butonundan API key girin.'); return; }
  const stepText = step.text || '';
  if(!stepText){ alert('Bu adÄ±mda henÃ¼z neden metni yok.'); return; }

  const tabLabel = tab === 'tech' ? 'Teknik' : 'Sistemsel';
  const trkLabel = tk  === 'os'   ? 'OluÅŸum (problem neden oluÅŸtu)' : 'Tespit Edilememe (neden fark edilemedi)';
  const problem  = _S[tab][tk].problem || '';

  btn.textContent = 'â³';
  btn.classList.add('loading');

  try{
    const raw = await callAI([
      { role:'system', content:'Sen bir kalite sistem mÃ¼hendisisin (IATF 16949 / VDA 6.3). KÄ±sa, spesifik ve uygulanabilir dÃ¼zeltici faaliyet Ã¶nerileri yap. YalnÄ±zca JSON dÃ¶ndÃ¼r.' },
      { role:'user',   content: 'KÄ±rÄ±lÄ±m: '+tabLabel+' â€” '+trkLabel+'\nProblem: "'+problem+'"\nKÃ¶k neden adÄ±mÄ±: "'+stepText+'"\n\nBu kÃ¶k neden iÃ§in bir dÃ¼zeltici faaliyet Ã¶ner.\nYALNIZCA JSON: {"action":"<faaliyet (en fazla 20 kelime)"}' }
    ], 150, 0.3);
    const parsed = JSON.parse(raw || '{}');
    const action = parsed.action || parsed.text || parsed.faaliyet || parsed.corrective_action || '';
    if(action){
      _S[tab].actions[tk][idx].text = action;
      if(ta) ta.value = action;
    }
  } catch(e){
    alert('AI Hata: ' + e.message);
  }
  btn.textContent = 'âš¡';
  btn.classList.remove('loading');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WIZ_STEPS = [
  { q: 'Ne oldu?',
    hint: 'ÃœrÃ¼n, parÃ§a veya sÃ¼reÃ§te gÃ¶zlemlenen sapma',
    ph: 'Ã¶rn: Montaj hattÄ±nda vida torku dÃ¼ÅŸÃ¼k Ã§Ä±ktÄ±',
    multi: true, id: 'wq1' },
  { q: 'Etki & Kapsam',
    hint: 'KaÃ§ adet? Hangi mÃ¼ÅŸteri / Ã¼rÃ¼n serisi?',
    ph: 'Ã¶rn: 1500 adet, A Serisi, mÃ¼ÅŸteri ÅŸikayeti var',
    multi: false, id: 'wq2' },
  { q: 'Nerede / Hangi SÃ¼reÃ§?',
    hint: 'Hat, makine, istasyon veya operasyon',
    ph: 'Ã¶rn: Hat-3, vida sÄ±kma istasyonu, gece vardiyasÄ±',
    multi: false, id: 'wq3' },
  { q: 'NasÄ±l Fark Edildi?',
    hint: 'Tespit yÃ¶ntemi ve ne zaman fark edildiÄŸi',
    ph: 'Ã¶rn: MÃ¼ÅŸteri iadesi, sevkiyattan 3 gÃ¼n sonra',
    multi: false, id: 'wq4' },
  { q: 'KaÃ§ neden adÄ±mÄ± olsun?',
    hint: 'Her bir iz iÃ§in ana zincirdeki adÄ±m sayÄ±sÄ±',
    chips: ['3','4','5','6','7'], def: '5', id: 'wq5' },
  { q: 'Paralel dal eklensin mi?',
    hint: 'Her izde kaÃ§ baÄŸÄ±msÄ±z dal zinciri oluÅŸturulsun',
    chips: ['Yok','1 Dal','2 Dal'], def: 'Yok', id: 'wq6' }
];

let _wizStep = 0;
const _wizAnswers = {};

function wizRender(){
  const s   = WIZ_STEPS[_wizStep];
  const tot = WIZ_STEPS.length;

  // Dots
  const dots = document.getElementById('wizDots');
  dots.innerHTML = WIZ_STEPS.map((_,i)=>
    `<div class="wiz-dot ${i<_wizStep?'done':i===_wizStep?'active':''}"></div>`
  ).join('') + `<span style="font-size:.64rem;color:#94a3b8;margin-left:6px;">${_wizStep+1} / ${tot}</span>`;

  // Step content
  const val = _wizAnswers[s.id] !== undefined ? _wizAnswers[s.id] : (s.def||'');
  let inner = `<div class="wiz-q">${s.q}</div><div class="wiz-hint">${s.hint}</div>`;
  if(s.chips){
    inner += `<div class="wiz-opts">${s.chips.map(c=>
      `<button class="wiz-chip${val===c?' sel':''}" onclick="wizChip('${s.id}','${c}',this)">${c}</button>`
    ).join('')}</div>`;
  } else if(s.multi){
    inner += `<textarea class="ai-ta" id="${s.id}" placeholder="${s.ph}" rows="3">${val}</textarea>`;
  } else {
    inner += `<input class="ai-input" id="${s.id}" placeholder="${s.ph}" value="${val.replace(/"/g,'&quot;')}">` ;
  }
  document.getElementById('wizStep').innerHTML = inner;

  // Button visibility
  const isLast = _wizStep === tot - 1;
  document.getElementById('wizBack').style.display = _wizStep === 0 ? 'none' : '';
  document.getElementById('wizNext').style.display = isLast ? 'none' : '';
  document.getElementById('aiGenBtn').style.display = isLast ? '' : 'none';

  // Focus input
  if(!s.chips) setTimeout(()=>{ const el=document.getElementById(s.id); if(el) el.focus(); }, 60);
}

function wizChip(id, val, btn){
  _wizAnswers[id] = val;
  btn.closest('.wiz-opts').querySelectorAll('.wiz-chip').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
}

function wizSaveCurrent(){
  const s  = WIZ_STEPS[_wizStep];
  if(s.chips) return;   // chip answers saved immediately on click
  const el = document.getElementById(s.id);
  if(el) _wizAnswers[s.id] = el.value.trim();
}

function wizNav(dir){
  wizSaveCurrent();
  _wizStep = Math.max(0, Math.min(WIZ_STEPS.length-1, _wizStep+dir));
  wizRender();
}

// â”€â”€ Provider toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProvider(p){
  localStorage.setItem('ai_provider', p);
  ['groq','openrouter','gemini'].forEach(id=>{
    const btn = document.getElementById('tab'+(id==='groq'?'Groq':id==='openrouter'?'OR':'Gemini'));
    if(btn) btn.classList.toggle('active', p===id);
  });
  document.getElementById('keyBlockGroq').style.display   = p==='groq'         ? '' : 'none';
  document.getElementById('keyBlockOR').style.display     = p==='openrouter'   ? '' : 'none';
  document.getElementById('keyBlockGemini').style.display = p==='gemini'       ? '' : 'none';
  // restore saved model selection
  if(p==='openrouter'){
    const m = localStorage.getItem('or_model');
    if(m) document.getElementById('orModel').value = m;
    document.getElementById('orModel').onchange = e => localStorage.setItem('or_model', e.target.value);
  }
}

// â”€â”€ Unified AI caller (Groq / OpenRouter / Gemini) â”€â”€â”€â”€â”€
async function callAI(messages, maxTokens, temperature){
  const provider = localStorage.getItem('ai_provider') || 'groq';
  const temp = temperature ?? 0.4;

  if(provider === 'openrouter'){
    const key = localStorage.getItem('or_api_key') || document.getElementById('aiKeyOR')?.value?.trim() || '';
    if(!key) throw new Error('OpenRouter API key girilmedi');
    const model = localStorage.getItem('or_model') || 'deepseek/deepseek-r1:free';
    const resp = await fetch('https://openrouter.ai/api/v1/chat/completions',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+key,
        'HTTP-Referer':'https://localhost',
        'X-Title':'5 Neden Analizi'
      },
      body: JSON.stringify({ model, messages, temperature:temp, max_tokens:maxTokens, response_format:{type:'json_object'} })
    });
    if(!resp.ok){
      const e=await resp.json().catch(()=>({}));
      if(resp.status===429) throw new Error('â³ OpenRouter rate limit â€” birkaÃ§ saniye bekleyip tekrar deneyin.');
      throw new Error(e?.error?.message||`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    return data?.choices?.[0]?.message?.content || '';

  } else if(provider === 'gemini'){
    const key = localStorage.getItem('gemini_api_key') || document.getElementById('aiKeyGemini')?.value?.trim() || '';
    if(!key) throw new Error('Gemini API key girilmedi');

    // Build Gemini native request from OpenAI-style messages
    const sysMsg  = messages.find(m=>m.role==='system')?.content || '';
    const userMsg = messages.find(m=>m.role==='user')?.content   || '';
    const combined = sysMsg ? sysMsg + '\n\n' + userMsg : userMsg;

    const fetchGemini = async (model) => {
      const resp = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
        { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            contents:[{ role:'user', parts:[{text: combined}] }],
            generationConfig:{ temperature:temp, maxOutputTokens:maxTokens, responseMimeType:'application/json' }
          })
        }
      );
      return resp;
    };

    // Try gemini-2.0-flash, on 429 wait and retry once
    let resp = await fetchGemini('gemini-2.0-flash');
    if(resp.status === 429 || resp.status === 503){
      await new Promise(r=>setTimeout(r,4000));
      resp = await fetchGemini('gemini-2.0-flash');
    }
    if(!resp.ok){
      const e = await resp.json().catch(()=>({}));
      const msg = e?.error?.message || `HTTP ${resp.status}`;
      throw new Error('Gemini: ' + msg);
    }
    const data = await resp.json();
    return data?.candidates?.[0]?.content?.parts?.[0]?.text || '';

  } else {
    const key = localStorage.getItem('groq_api_key') || document.getElementById('aiKey')?.value?.trim() || '';
    if(!key) throw new Error('Groq API key girilmedi');
    const resp = await fetch('https://api.groq.com/openai/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body: JSON.stringify({ model:'llama-3.3-70b-versatile', messages, temperature:temp, max_tokens:maxTokens, response_format:{type:'json_object'} })
    });
    if(!resp.ok){
      const e=await resp.json().catch(()=>({}));
      if(resp.status===429) throw new Error('â³ Rate limit â€” Groq kotasÄ± doldu. BirkaÃ§ saniye bekleyip tekrar deneyin.');
      throw new Error(e?.error?.message||`HTTP ${resp.status}`);
    }
    const data = await resp.json();
    return data?.choices?.[0]?.message?.content || '';
  }
}

function openAiModal(){
  _wizStep = 0;
  const prob = (_S.tech.os.problem && !_S.tech.os.problem.includes('buraya')) ? _S.tech.os.problem : '';
  _wizAnswers['wq1'] = prob;
  // pre-set chip defaults
  if(!_wizAnswers['wq5']) _wizAnswers['wq5'] = '5';
  if(!_wizAnswers['wq6']) _wizAnswers['wq6'] = 'Yok';
  document.getElementById('aiStatus').innerHTML = '';
  document.getElementById('aiModal').classList.add('open');
  wizRender();
}

function closeAiModal(){ document.getElementById('aiModal').classList.remove('open'); }

async function aiGenerate(){
  wizSaveCurrent();
  // Save the currently visible key
  const provider = localStorage.getItem('ai_provider') || 'groq';
  if(provider==='gemini'){
    const k = document.getElementById('aiKeyGemini').value.trim();
    if(!k){ setAiStatus('error','âš ï¸ LÃ¼tfen Gemini API key girin.'); return; }
    localStorage.setItem('gemini_api_key', k);
  } else if(provider==='openrouter'){
    const k = document.getElementById('aiKeyOR').value.trim();
    if(!k){ setAiStatus('error','âš ï¸ LÃ¼tfen OpenRouter API key girin.'); return; }
    localStorage.setItem('or_api_key', k);
  } else {
    const k = document.getElementById('aiKey').value.trim();
    if(!k){ setAiStatus('error','âš ï¸ LÃ¼tfen Groq API key girin.'); return; }
    localStorage.setItem('groq_api_key', k);
  }

  // Build context from wizard answers
  const q1 = _wizAnswers['wq1'] || '';
  const q2 = _wizAnswers['wq2'] || '';
  const q3 = _wizAnswers['wq3'] || '';
  const q4 = _wizAnswers['wq4'] || '';

  if(!q1){ setAiStatus('error','âš ï¸ LÃ¼tfen en az 1. soruyu yanÄ±tlayÄ±n.'); return; }

  const btn = document.getElementById('aiGenBtn');
  btn.disabled = true;
  const provLabel = provider==='gemini' ? 'Google Gemini analiz ediyorâ€¦' : 'Groq â€” Llama 3.3 analiz ediyorâ€¦';
  setAiStatus('loading', provLabel);

  const q5 = _wizAnswers['wq5'] || '5';
  const q6 = _wizAnswers['wq6'] || 'Yok';
  const stepCount   = parseInt(q5) || 5;
  const branchCount = q6==='1 Dal' ? 1 : q6==='2 Dal' ? 2 : 0;

  const context = [
    `Problem: ${q1}`,
    q2 ? `Etki/Kapsam: ${q2}` : '',
    q3 ? `SÃ¼reÃ§/Yer: ${q3}` : '',
    q4 ? `Tespit: ${q4}` : ''
  ].filter(Boolean).join('\n');

  // Distribute branches evenly across the main chain steps
  const branchExamplesAi = [];
  for(let b=0; b<branchCount; b++){
    const sa = Math.round((b+1)*stepCount/(branchCount+1)) - 1;
    branchExamplesAi.push(`{"startAfterStep": ${Math.max(0,sa)}, "steps": ["Dal Neden 1","Dal Neden 2","Dal Neden 3"], "rootCause": "Dal kÃ¶k"}`);
  }
  const branchInstruction = branchCount > 0
    ? `Her iz iÃ§in ${branchCount} baÄŸÄ±msÄ±z paralel dal zinciri de oluÅŸtur. Dallar farklÄ± startAfterStep deÄŸerlerine sahip olsun (zincire yayÄ±lmÄ±ÅŸ daÄŸÄ±lÄ±m).` : '';
  const branchJsonExample = branchCount > 0
    ? `,"branches":[${branchExamplesAi.join(',')}]` : '';

  const prompt = `Sen bir kalite sistem mÃ¼hendisisin (IATF 16949 / VDA 6.3). AÅŸaÄŸÄ±daki bilgileri kullanarak 5 Neden (5 Why) analizi yap.

âš ï¸ ZORUNLU NEDENSELLÄ°K KURALI:
Her adÄ±m, bir Ã¶nceki adÄ±mÄ±n DOÄRUDAN ve SOMUT nedeni olmalÄ±dÄ±r.
mainSteps[i], mainSteps[i-1]'e "Neden?" sorusunun TAM cevabÄ±dÄ±r.
Zincirin tamamÄ± aynÄ± problem alanÄ±nda kalmalÄ±; konu dÄ±ÅŸÄ±, genel veya alakasÄ±z nedenler YASAKTIR.
Ã–rnek zincir (vida torku problemi, oluÅŸum izi):
  AdÄ±m 1: "Vida torku spesifikasyon altÄ±nda kaldÄ±"        â† problem
  AdÄ±m 2: "Tornavida ucu aÅŸÄ±ndÄ±ÄŸÄ± iÃ§in kuvvet iletimi dÃ¼ÅŸtÃ¼" â† neden 1'in nedeni
  AdÄ±m 3: "Periyodik alet deÄŸiÅŸim planÄ± uygulanmadÄ±"       â† neden 2'nin nedeni
  AdÄ±m 4: "BakÄ±m talimatÄ± gÃ¼ncel deÄŸil"                    â† neden 3'Ã¼n nedeni
  AdÄ±m 5 (kÃ¶k): "BakÄ±m yÃ¶netim sistemi revize edilmedi"   â† kÃ¶k neden
Her adÄ±m bir Ã¶ncekini AÃ‡IKLAMALI; baÄŸÄ±msÄ±z, rastgele veya genel nedenler YAZMA.

4 ayrÄ± iz oluÅŸtur:
1. TEKNÄ°K OLUÅUM: Fiziksel/mÃ¼hendislik nedenler - Problem neden oluÅŸtu? (parametre, makine, malzeme, Ã¶lÃ§Ã¼m)
2. TEKNÄ°K TESPÄ°T: Fiziksel/mÃ¼hendislik nedenler - Problem neden fark edilemedi?
3. SÄ°STEMSEL OLUÅUM: YÃ¶netim sistemi nedenler - Sistem/prosedÃ¼r aÃ§Ä±sÄ±ndan neden oluÅŸtu? (FMEA, kontrol planÄ±, denetim)
4. SÄ°STEMSEL TESPÄ°T: YÃ¶netim sistemi nedenler - Sistem aÃ§Ä±sÄ±ndan neden fark edilemedi? (prosedÃ¼r, eÄŸitim, kural)

Her iz iÃ§in EXACTLY ${stepCount} adÄ±mlÄ±k ana neden zinciri oluÅŸtur. Son adÄ±m = kÃ¶k neden.
${branchInstruction}
Nedenler kÄ±sa ve teknik olsun (en fazla 10 kelime). Her adÄ±m bir Ã¶ncekinin nedeni; baÄŸÄ±msÄ±z madde YAZMAK YASAKTIR.

YALNIZCA aÅŸaÄŸÄ±daki JSON formatÄ±nda yanÄ±t ver:
{
  "tech": {
    "os": {"problem": "<kÄ±sa problem Ã¶zeti>", "mainSteps": ["Neden 1", "...(tam ${stepCount} adet)"], "rootCause": "<teknik kÃ¶k neden (oluÅŸum)>"${branchJsonExample}},
    "nd": {"problem": "<tespit aÃ§Ä±sÄ±ndan problem>", "mainSteps": ["Neden 1", "...(tam ${stepCount} adet)"], "rootCause": "<teknik kÃ¶k neden (tespit)>"${branchJsonExample}}
  },
  "sys": {
    "os": {"problem": "<sistemsel problem Ã¶zeti>", "mainSteps": ["Neden 1", "...(tam ${stepCount} adet)"], "rootCause": "<sistemsel kÃ¶k neden (oluÅŸum)>"${branchJsonExample}},
    "nd": {"problem": "<sistemsel tespit problem>", "mainSteps": ["Neden 1", "...(tam ${stepCount} adet)"], "rootCause": "<sistemsel kÃ¶k neden (tespit)>"${branchJsonExample}}
  }
}

${context}`;

  try {
    const raw = await callAI([
      { role: 'system', content: 'Sen bir kalite mÃ¼hendisisin (IATF 16949 / VDA 6.3). Sadece istenen JSON formatÄ±nda yanÄ±t ver. EN Ã–NEMLÄ° KURAL: 5 Neden zincirinde her adÄ±m bir Ã¶nceki adÄ±mÄ±n DOÄRUDAN nedeni olmalÄ±dÄ±r. Birbirinden baÄŸÄ±msÄ±z nedenler listesi kesinlikle kabul edilmez.' },
      { role: 'user',   content: prompt }
    ], 2800, 0.4);
    const jsonStr = raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'').trim();
    const parsed  = JSON.parse(jsonStr);

    applyAiResult(parsed, q1);
    closeAiModal();
    setAiStatus('','');

  } catch(e){
    setAiStatus('error', 'âŒ Hata: ' + e.message);
  } finally {
    btn.disabled = false;
  }
}

function buildChainsFromAi(iz){
  const mainSteps = (iz.mainSteps || iz.steps || []);
  const chains = [{ startAfter:null, steps: mainSteps.map((t,i,a)=>
    ({ id:uid(), text:t, isRoot: i===a.length-1 })
  )}];
  if(!chains[0].steps.length) chains[0].steps.push(mkStep());
  // parallel branches
  for(const br of (iz.branches||[])){
    const sa = typeof br.startAfterStep === 'number' ? br.startAfterStep : 0;
    const bSteps = (br.steps||[]).map((t,i,a)=>({ id:uid(), text:t, isRoot: i===a.length-1 }));
    if(bSteps.length) chains.push({ startAfter: sa, steps: bSteps });
  }
  return chains;
}

function collectPinnedSteps(chains){
  const map = {};
  chains.forEach((ch,ci)=>{ ch.steps.forEach((s,si)=>{ if(s.pinned) map[ci+'_'+si]=s.text; }); });
  return map;
}
function restorePinnedSteps(chains, map){
  Object.entries(map).forEach(([key,text])=>{
    const [ci,si] = key.split('_').map(Number);
    const s = chains[ci]?.steps[si];
    if(s){ s.text=text; s.pinned=true; }
  });
}

// Collect pinned actions by flat position index before AI rebuilds
function collectPinnedActions(tab, tk){
  const map = {};
  (_S[tab].actions?.[tk] || []).forEach((act, i)=>{
    if(act && act.pinned) map[i] = Object.assign({}, act);
  });
  return map;
}
// After AI rebuild: pinned actions survive at same position, others reset
function syncActionsAfterAi(tab, tk, pinnedMap){
  if(!_S[tab].actions) _S[tab].actions = { os:[], nd:[] };
  const total = getAllSteps(tab, tk).length;
  const newActions = [];
  for(let i = 0; i < total; i++){
    newActions.push(pinnedMap[i] ? pinnedMap[i] : mkAction());
  }
  _S[tab].actions[tk] = newActions;
}

function applyAiResult(parsed, originalProblem){
  ['tech','sys'].forEach(tab=>{
    ['os','nd'].forEach(tk=>{
      const iz = parsed?.[tab]?.[tk];
      if(iz){
        const pinnedSteps   = collectPinnedSteps(_S[tab][tk].chains);
        const pinnedActions = collectPinnedActions(tab, tk);
        if(!_S[tab][tk].problemPinned) _S[tab][tk].problem = iz.problem || originalProblem;
        if(!_S[tab][tk].rcPinned)      _S[tab][tk].rcText  = iz.rootCause || _S[tab][tk].rcText;
        _S[tab][tk].chains = buildChainsFromAi(iz);
        restorePinnedSteps(_S[tab][tk].chains, pinnedSteps);
        syncActionsAfterAi(tab, tk, pinnedActions);
      }
    });
  });
  if(originalProblem && !document.getElementById('mPart').value)
    document.getElementById('mPart').value = originalProblem.slice(0,60);
  render();
}

// Yenile: hem os hem nd izini yeniler (tab = 'tech' veya 'sys')
async function aiRefresh(tab){
  const _provider = localStorage.getItem('ai_provider') || 'groq';
  const _chkKey = _provider==='gemini' ? localStorage.getItem('gemini_api_key') : localStorage.getItem('groq_api_key');
  if(!_chkKey){ alert('Ã–nce "AI ile OluÅŸtur" butonundan API key girin.'); return; }

  const q1 = _wizAnswers['wq1'] || _S.tech.os.problem || _S.sys.os.problem || '';
  if(!q1 || q1.includes('buraya')){ alert('AI\'ye gÃ¶ndermek iÃ§in Ã¶nce problem tanÄ±mÄ± girin.'); return; }

  const btnId   = tab==='tech' ? 'yenileTech' : 'yenileSys';
  const tabLabel = tab==='tech' ? 'Teknik' : 'Sistemsel';
  const btn     = document.getElementById(btnId);
  const origTxt = btn.textContent;

  // Progress animation helper
  let _pct = 0;
  function setProgress(p, label){
    _pct = p;
    btn.style.setProperty('--prog', p+'%');
    btn.textContent = label + ' %' + p;
  }
  btn.disabled = true;
  btn.classList.add('tbb-prog');
  setProgress(10, tabLabel);

  const progTimer = setInterval(()=>{
    if(_pct < 85) setProgress(Math.min(85, _pct+8), tabLabel);
  }, 600);

  const q2 = _wizAnswers['wq2']||'', q3 = _wizAnswers['wq3']||'', q4 = _wizAnswers['wq4']||'';
  const chainState  = _S[tab].os;
  const stepCount   = chainState.chains[0].steps.length || 5;
  const branchCount = Math.max(0, chainState.chains.length - 1);

  const focusDesc = tab==='tech'
    ? 'FÄ°ZÄ°KSEL/MÃœHENDÄ°SLÄ°K nedenler (parametre, makine, malzeme, Ã¶lÃ§Ã¼m, tolerans)'
    : 'YÃ–NETÄ°M SÄ°STEMÄ°/PROSEDÃœR nedenler (FMEA, kontrol planÄ±, denetim, eÄŸitim, prosedÃ¼r)';

  const context = [`Problem: ${q1}`, q2?`Etki: ${q2}`:'', q3?`Yer: ${q3}`:'', q4?`Tespit: ${q4}`:''].filter(Boolean).join('\n');

  const branchExamples = [];
  for(let b=0; b<branchCount; b++){
    const sa = Math.round((b+1) * stepCount / (branchCount+1)) - 1;
    branchExamples.push(`{"startAfterStep": ${sa}, "steps": ["Dal Neden 1","Dal Neden 2","Dal Neden 3"], "rootCause": "Dal kÃ¶k"}`);
  }
  const branchInstruction = branchCount > 0
    ? `Her iz iÃ§in ${branchCount} baÄŸÄ±msÄ±z paralel dal zinciri oluÅŸtur. Dallar farklÄ± startAfterStep deÄŸerlerine sahip olsun.` : '';
  const brJsonPart = branchCount > 0
    ? `,"branches":[${branchExamples.join(',')}]` : '';

  const prompt = `Sen bir kalite sistem mÃ¼hendisisin (IATF 16949 / VDA 6.3). YalnÄ±zca ${tabLabel.toUpperCase()} kÄ±rÄ±lÄ±mÄ±nÄ± analiz et.
Odak: ${focusDesc}

âš ï¸ ZORUNLU NEDENSELLÄ°K KURALI:
Her adÄ±m, bir Ã¶nceki adÄ±mÄ±n DOÄRUDAN ve SOMUT nedeni olmalÄ±dÄ±r.
mainSteps[i], mainSteps[i-1]'e "Neden?" sorusunun TAM cevabÄ±dÄ±r.
TÃ¼m adÄ±mlar aynÄ± problem alanÄ±nda kalmalÄ±; konu dÄ±ÅŸÄ±, genel veya alakasÄ±z nedenler YASAKTIR.
YanlÄ±ÅŸ Ã¶rnek: ["Vida hatalÄ±", "Personel yorgun", "Makine eski"] â† birbiriyle alakasÄ±z, KABUL EDÄ°LMEZ.
DoÄŸru Ã¶rnek: ["Vida torku dÃ¼ÅŸÃ¼k", "Tornavida ucu aÅŸÄ±ndÄ±", "Alet deÄŸiÅŸim planÄ± yok", "BakÄ±m talimatÄ± eksik", "DokÃ¼man gÃ¼ncel deÄŸil"] â† her adÄ±m bir Ã¶ncekini aÃ§Ä±klÄ±yor.
Her adÄ±m bir Ã¶ncekini AÃ‡IKLAMALI; baÄŸÄ±msÄ±z, rastgele veya genel nedenler YAZMA.

2 iz oluÅŸtur:
1. OLUÅUM (os): Bu kÄ±rÄ±lÄ±mda problem neden oluÅŸtu?
2. TESPÄ°T (nd): Bu kÄ±rÄ±lÄ±mda problem neden fark edilemedi?

Her iz iÃ§in EXACTLY ${stepCount} adÄ±mlÄ±k ana neden zinciri oluÅŸtur. Son adÄ±m = kÃ¶k neden.
${branchInstruction}
Nedenler kÄ±sa ve teknik olsun (en fazla 10 kelime). Her adÄ±m bir Ã¶ncekinin nedeni; baÄŸÄ±msÄ±z madde YAZMAK YASAKTIR.

YALNIZCA JSON:
{"os":{"problem":"...","mainSteps":["Neden 1","...(tam ${stepCount} adet)"],"rootCause":"..."${brJsonPart}},"nd":{"problem":"...","mainSteps":["Neden 1","...(tam ${stepCount} adet)"],"rootCause":"..."${brJsonPart}}}

${context}`;

  try{
    const raw = await callAI([
      {role:'system',content:'Sen bir kalite mÃ¼hendisisin (IATF 16949 / VDA 6.3). Sadece istenen JSON formatÄ±nda yanÄ±t ver. EN Ã–NEMLÄ° KURAL: 5 Neden zincirinde her adÄ±m bir Ã¶nceki adÄ±mÄ±n DOÄRUDAN nedeni olmalÄ±dÄ±r. Birbirinden baÄŸÄ±msÄ±z nedenler listesi kesinlikle kabul edilmez.'},
      {role:'user',content:prompt}
    ], 1800, 0.45);
    const parsed = JSON.parse(raw.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'').trim());

    ['os','nd'].forEach(tk=>{
      const iz = parsed?.[tk];
      if(iz){
        const pinnedSteps   = collectPinnedSteps(_S[tab][tk].chains);
        const pinnedActions = collectPinnedActions(tab, tk);
        if(!_S[tab][tk].problemPinned) _S[tab][tk].problem = iz.problem || q1;
        if(!_S[tab][tk].rcPinned)      _S[tab][tk].rcText  = iz.rootCause || _S[tab][tk].rcText;
        _S[tab][tk].chains = buildChainsFromAi(iz);
        restorePinnedSteps(_S[tab][tk].chains, pinnedSteps);
        syncActionsAfterAi(tab, tk, pinnedActions);
      }
    });
    renderTrack(tab,'os');
    renderTrack(tab,'nd');
    renderActionTable(tab);

    clearInterval(progTimer);
    setProgress(100, 'âœ… Tamam');
    setTimeout(()=>{
      btn.classList.remove('tbb-prog');
      btn.style.removeProperty('--prog');
      btn.textContent = origTxt;
      btn.disabled = false;
    }, 1400);
  } catch(e){
    clearInterval(progTimer);
    btn.classList.remove('tbb-prog');
    btn.style.removeProperty('--prog');
    btn.textContent = origTxt;
    btn.disabled = false;
    alert('âŒ Yenile hatasÄ±: '+e.message);
  }
}

function setAiStatus(type, msg){
  const el = document.getElementById('aiStatus');
  if(!msg){ el.innerHTML=''; return; }
  if(type==='loading')
    el.innerHTML = `<div class="ai-status"><div class="ai-spinner"></div>${msg}</div>`;
  else if(type==='error')
    el.innerHTML = `<div style="color:#dc2626;font-size:.74rem;font-weight:600;">${msg}</div>`;
  else
    el.innerHTML = `<div style="color:#16a34a;font-size:.74rem;">${msg}</div>`;
}

document.addEventListener('keydown', e=>{
  if(e.key==='Escape') { closeAiModal(); closeModal(); }
  if(e.key==='Enter' && e.ctrlKey && document.getElementById('editModal').classList.contains('open')) saveModal();
  if(e.key==='Enter' && document.getElementById('aiModal').classList.contains('open')){
    const isLast = _wizStep === WIZ_STEPS.length - 1;
    if(isLast) aiGenerate(); else wizNav(1);
  }
});
</script>
</body>
</html>
