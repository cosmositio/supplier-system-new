<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5 Neden Analizi</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f4f8;color:#1e293b;min-height:100vh;}

/* â”€â”€ TOP BAR â”€â”€ */
.topbar{display:flex;align-items:center;gap:10px;padding:10px 18px;
  background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.22);flex-wrap:wrap;}
.topbar h1{font-size:1.1rem;font-weight:800;}
.topbar .spacer{flex:1;}
.tb-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.32);
  color:#fff;border-radius:7px;padding:5px 13px;font-size:.76rem;font-weight:600;
  cursor:pointer;transition:.15s;white-space:nowrap;}
.tb-btn:hover{background:rgba(255,255,255,.27);}
.tb-btn.danger{background:rgba(220,38,38,.38);border-color:rgba(220,38,38,.6);}
.tb-btn.success{background:rgba(22,163,74,.46);border-color:rgba(22,163,74,.7);}

/* â”€â”€ META â”€â”€ */
.meta-bar{display:flex;gap:10px;flex-wrap:wrap;padding:10px 18px;background:#fff;
  border-bottom:1px solid #e2e8f0;align-items:flex-end;}
.mf{display:flex;flex-direction:column;gap:3px;flex:1;min-width:160px;}
.mf label{font-size:.64rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;}
.mf input,.mf select{border:1.5px solid #e2e8f0;border-radius:6px;padding:4px 8px;
  font-size:.8rem;outline:none;transition:.2s;}
.mf input:focus,.mf select:focus{border-color:#2563eb;}

/* â”€â”€ LEGEND â”€â”€ */
.legend{display:flex;gap:14px;flex-wrap:wrap;padding:7px 18px;background:#f8faff;
  border-bottom:1px solid #e2e8f0;font-size:.72rem;align-items:center;}
.leg-item{display:flex;align-items:center;gap:5px;}
.lb{width:24px;height:14px;border-radius:3px;border:2px solid;}
.lb.n{background:#fff;border-color:#94a3b8;}
.lb.r{background:#fff5f5;border-color:#dc2626;border-style:dashed;}
.lb.b{background:#fefce8;border-color:#b45309;border-style:dashed;}

/* â”€â”€ CANVAS â”€â”€ */
.canvas-outer{overflow:auto;padding:24px 18px 48px;}
.track-section{margin-bottom:48px;}
.track-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.track-badge{font-size:.7rem;font-weight:800;color:#fff;border-radius:6px;
  padding:3px 11px;text-transform:uppercase;letter-spacing:.07em;}
.track-badge.olusum{background:#2563eb;}
.track-badge.tespit{background:#7c3aed;}
.track-sub{font-size:.68rem;font-style:italic;color:#94a3b8;}

/* â”€â”€ TREE DIAGRAM â”€â”€ */
.tree-canvas{position:relative;overflow:visible;}

/* â”€â”€ PROBLEM BOX â”€â”€ */
.prob-node{position:absolute;border:2.5px solid #2563eb;border-radius:8px;
  background:#f0f6ff;padding:8px 10px;}
.prob-node.nd-track{border-color:#7c3aed;background:#f5f3ff;}
.prob-lbl{font-size:.6rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:4px;color:#2563eb;}
.prob-node.nd-track .prob-lbl{color:#7c3aed;}
.prob-node textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.76rem;color:#1e293b;font-family:inherit;line-height:1.4;min-height:44px;}

/* â”€â”€ WHY NODE â”€â”€ */
.why-node{position:absolute;border:2px solid #cbd5e1;border-radius:8px;
  background:#fff;padding:7px 10px;
  box-shadow:0 1px 4px rgba(0,0,0,.07);transition:.15s;}
.why-node:hover{border-color:#93c5fd;box-shadow:0 2px 8px rgba(37,99,235,.12);}
.why-node.is-root{border-color:#dc2626;border-style:dashed;border-width:2.5px;background:#fff5f5;}
.why-node.is-branch{border-color:#b45309;border-style:dashed;border-width:2px;background:#fefce8;}
.ntag{position:absolute;top:-9px;left:8px;font-size:.58rem;font-weight:800;
  padding:1px 7px;border-radius:10px;color:#fff;white-space:nowrap;}
.ntag.r{background:#dc2626;}
.ntag.b{background:#b45309;}
.why-node textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.76rem;color:#1e293b;font-family:inherit;line-height:1.4;min-height:40px;}
.node-acts{display:flex;gap:3px;margin-top:5px;flex-wrap:wrap;}
.na{font-size:.58rem;padding:2px 6px;border-radius:4px;border:1px solid;
  cursor:pointer;font-weight:700;background:#fff;transition:.12s;white-space:nowrap;}
.na.add{color:#2563eb;border-color:#bfdbfe;background:#eff6ff;}
.na.add:hover{background:#2563eb;color:#fff;}
.na.root{color:#dc2626;border-color:#fca5a5;background:#fff5f5;}
.na.root:hover{background:#dc2626;color:#fff;}
.na.br{color:#b45309;border-color:#fde68a;background:#fefce8;}
.na.br:hover{background:#b45309;color:#fff;}
.na.del{color:#94a3b8;border-color:#e2e8f0;}
.na.del:hover{background:#ef4444;color:#fff;border-color:#ef4444;}

/* â”€â”€ ROOT CAUSE BOX â”€â”€ */
.rcb{position:absolute;border:2.5px dashed #dc2626;border-radius:10px;
  background:#fff5f5;padding:12px 14px;text-align:center;}
.rcb-icon{font-size:1.1rem;}
.rcb-lbl{font-size:.6rem;font-weight:800;text-transform:uppercase;
  color:#dc2626;letter-spacing:.04em;margin:3px 0;}
.rcb textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.7rem;color:#b91c1c;font-family:inherit;text-align:center;
  line-height:1.3;min-height:32px;}

/* â”€â”€ ADD BTN â”€â”€ */
.add-root-btn{display:inline-flex;align-items:center;gap:5px;
  font-size:.72rem;font-weight:700;color:#2563eb;background:#eff6ff;
  border:1.5px dashed #93c5fd;border-radius:8px;padding:6px 14px;
  cursor:pointer;margin-top:6px;transition:.15s;}
.add-root-btn:hover{background:#dbeafe;}
.add-root-btn.nd{color:#7c3aed;background:#f5f3ff;border-color:#c4b5fd;}
.add-root-btn.nd:hover{background:#ede9fe;}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.42);
  z-index:9000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal-box{background:#fff;border-radius:14px;padding:24px 26px 18px;
  max-width:440px;width:95%;box-shadow:0 8px 40px rgba(0,0,0,.18);}
.modal-box h3{font-size:.94rem;font-weight:800;margin-bottom:12px;color:#1e293b;}
.modal-box textarea{width:100%;min-height:80px;border:1.5px solid #e2e8f0;
  border-radius:8px;padding:8px 10px;font-size:.83rem;resize:vertical;
  font-family:inherit;outline:none;}
.modal-box textarea:focus{border-color:#2563eb;}
.mbts{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
.mb{padding:6px 18px;border-radius:7px;font-size:.8rem;font-weight:700;
  cursor:pointer;border:none;}
.mb.cancel{background:#f1f5f9;color:#64748b;}
.mb.confirm{background:#2563eb;color:#fff;}
.mb.confirm:hover{background:#1d4ed8;}

@media print{
  .topbar,.meta-bar,.legend,.node-acts,.add-root-btn,.tb-btn{display:none!important;}
  body,.canvas-outer{background:#fff;}
}
</style>
</head>
<body>

<div class="topbar">
  <span style="font-size:1.3rem">ğŸ”</span>
  <h1>5 Neden Analizi</h1>
  <div class="spacer"></div>
  <button class="tb-btn success" onclick="saveData()">ğŸ’¾ Kaydet</button>
  <button class="tb-btn" onclick="loadData()">ğŸ“‚ YÃ¼kle</button>
  <button class="tb-btn" onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r / PDF</button>
  <button class="tb-btn danger" onclick="resetAll()">ğŸ—‘ SÄ±fÄ±rla</button>
</div>

<div class="meta-bar">
  <div class="mf"><label>Problem / ParÃ§a No</label><input id="mPart" placeholder="Ã¶rn: Part# 12345 â€” Vida"></div>
  <div class="mf"><label>MÃ¼ÅŸteri / Proje</label><input id="mCustomer" placeholder="Ã¶rn: ArÃ§elik A.Å."></div>
  <div class="mf" style="max-width:160px"><label>Tarih</label><input id="mDate" type="date"></div>
  <div class="mf"><label>Analist</label><input id="mAnalyst" placeholder="Ã¶rn: Kalite MÃ¼dÃ¼rÃ¼"></div>
  <div class="mf" style="max-width:175px"><label>Durum</label>
    <select id="mStatus">
      <option>ğŸ”„ Devam Ediyor</option>
      <option>âœ… TamamlandÄ±</option>
      <option>ğŸ” Ä°ncelemede</option>
    </select>
  </div>
</div>

<div class="legend">
  <strong style="color:#475569">GÃ¶sterim:</strong>
  <div class="leg-item"><div class="lb n"></div><span>Normal neden</span></div>
  <div class="leg-item"><div class="lb r"></div><span>Teknik kÃ¶k neden</span></div>
  <div class="leg-item"><div class="lb b"></div><span>Dallanma noktasÄ±</span></div>
  <span style="color:#94a3b8;font-size:.67rem">| â• Neden â†’ alt dal ekler &nbsp;Â·&nbsp; Ã‡ift tÄ±kla â†’ bÃ¼yÃ¼k editÃ¶r &nbsp;Â·&nbsp; ğŸ—‘ â†’ sil (alt dallarÄ±yla birlikte)</span>
</div>

<div class="canvas-outer" id="canvasOuter">
  <div class="track-section">
    <div class="track-header">
      <span class="track-badge olusum">ğŸ”´ OluÅŸum</span>
      <span class="track-sub">Neden problem oluÅŸtu?</span>
    </div>
    <div class="tree-canvas" id="osCanvas">
      <svg id="osSvg" style="position:absolute;top:0;left:0;overflow:visible;pointer-events:none"></svg>
    </div>
    <button class="add-root-btn" onclick="addRootNode('os')">â• Yeni BaÅŸlangÄ±Ã§ DalÄ± Ekle</button>
  </div>

  <div class="track-section">
    <div class="track-header">
      <span class="track-badge tespit">ğŸŸ£ Tespit Edilememe</span>
      <span class="track-sub">Problem neden fark edilmedi?</span>
    </div>
    <div class="tree-canvas" id="ndCanvas">
      <svg id="ndSvg" style="position:absolute;top:0;left:0;overflow:visible;pointer-events:none"></svg>
    </div>
    <button class="add-root-btn nd" onclick="addRootNode('nd')">â• Yeni BaÅŸlangÄ±Ã§ DalÄ± Ekle</button>
  </div>
</div>

<div class="modal-overlay" id="editModal">
  <div class="modal-box">
    <h3 id="modalTitle">âœï¸ Nedeni DÃ¼zenle</h3>
    <textarea id="modalTa" rows="4" placeholder="Nedeni buraya yazÄ±nâ€¦"></textarea>
    <div class="mbts">
      <button class="mb cancel" onclick="closeModal()">Ä°ptal</button>
      <button class="mb confirm" onclick="saveModal()">Kaydet</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAYOUT CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOX_W   = 180;   // node box width px
const BOX_H   = 96;    // node box height (base unit)
const PROB_W  = 180;
const PROB_H  = 84;
const RCB_W   = 158;
const RCB_H   = 106;
const COL_GAP = 110;   // horizontal gap between box right edge and next box left edge (arrow area)
const ROW_GAP = 18;    // vertical gap between sibling boxes
const COL_W   = BOX_W + COL_GAP;  // full column stride

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// node: { id, text, isRoot, isBranch, children:[] }
let _S = {
  meta: {},
  os: { problem: 'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText: 'Teknik KÃ¶k Neden\n(OluÅŸum)',             tree: [mkNode()] },
  nd: { problem: 'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText: 'Teknik KÃ¶k Neden\n(Tespit Edilememe)',    tree: [mkNode()] }
};

let _modalCb = null;

function mkNode(t){ return { id: uid(), text: t||'', isRoot:false, isBranch:false, children:[] }; }
function uid(){ return 'n' + Math.random().toString(36).slice(2,9); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TREE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function findNode(arr, id){
  for(const n of arr){
    if(n.id===id) return n;
    const f = findNode(n.children, id);
    if(f) return f;
  }
  return null;
}
function findParent(arr, id){
  for(let i=0;i<arr.length;i++){
    if(arr[i].id===id) return {arr, i};
    const f = findParent(arr[i].children, id);
    if(f) return f;
  }
  return null;
}
// Leaf-unit height of subtree
function subH(node){
  if(!node.children.length) return 1;
  return node.children.reduce((s,c)=>s+subH(c),0);
}
// Total leaf units for an array of root nodes
function trackH(tree){ return tree.reduce((s,n)=>s+subH(n),0)||1; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAYOUT  â†’  flat list of positioned items + connectors
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLayout(tk){
  const track = _S[tk];
  const items  = [];  // {type, node?, x, y, w, h, cx, cy, trackKey}
  const conns  = [];  // {x1,y1, x2,y2, dashed}

  const unitPx = BOX_H + ROW_GAP;
  const totalUnits = trackH(track.tree);
  const totalH = totalUnits * unitPx;

  // â”€â”€ Problem start box â”€â”€
  const probCY = totalH / 2;
  const probX  = 0;
  const probY  = probCY - PROB_H / 2;
  items.push({ type:'prob', x:probX, y:probY, w:PROB_W, h:PROB_H,
                cx: probX+PROB_W, cy: probCY, trackKey:tk });

  // â”€â”€ Tree nodes â”€â”€
  let rowCursor = 0;
  for(const rootNode of track.tree){
    layoutNode(rootNode, 1, rowCursor, unitPx, probX+PROB_W, probCY, items, conns, tk);
    rowCursor += subH(rootNode);
  }

  // â”€â”€ Find rightmost col â”€â”€
  let maxCol = 0;
  for(const it of items) if(it.type==='node'){
    const col = Math.round(it.x / COL_W);
    if(col>maxCol) maxCol=col;
  }

  // â”€â”€ Root cause box â”€â”€
  const rcbX = (maxCol+1)*COL_W + 20;
  const rcbY = probCY - RCB_H/2;
  const rcbCX = rcbX, rcbCY2 = probCY;
  items.push({ type:'rcb', x:rcbX, y:rcbY, w:RCB_W, h:RCB_H, trackKey:tk });

  // Connectors: root-marked nodes â†’ rcb
  for(const it of items){
    if(it.type==='node' && it.node.isRoot){
      conns.push({ x1:it.x+it.w, y1:it.cy, x2:rcbCX, y2:rcbCY2, dashed:true });
    }
  }

  const W = Math.max(...items.map(i=>i.x+i.w)) + 40;
  const H = Math.max(...items.map(i=>i.y+i.h)) + 30;
  return { items, conns, W, H };
}

function layoutNode(node, col, rowOffset, unitPx, parentRX, parentCY, items, conns, tk){
  const units = subH(node);
  const cy    = (rowOffset + units/2) * unitPx;
  const x     = col * COL_W;
  const y     = cy - BOX_H/2;

  items.push({ type:'node', node, col, x, y, w:BOX_W, h:BOX_H, cx:x+BOX_W, cy, trackKey:tk });

  // Connector from parent
  conns.push({ x1:parentRX, y1:parentCY, x2:x, y2:cy, dashed:false });

  let childRow = rowOffset;
  for(const child of node.children){
    layoutNode(child, col+1, childRow, unitPx, x+BOX_W, cy, items, conns, tk);
    childRow += subH(child);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){ renderTrack('os'); renderTrack('nd'); }

function renderTrack(tk){
  const canvasEl = document.getElementById(tk+'Canvas');
  const svgEl    = document.getElementById(tk+'Svg');

  // Clear canvas (keep svg)
  Array.from(canvasEl.childNodes).forEach(c=>{ if(c!==svgEl) canvasEl.removeChild(c); });
  svgEl.innerHTML = '';

  const {items, conns, W, H} = doLayout(tk);
  canvasEl.style.width  = W+'px';
  canvasEl.style.height = H+'px';
  svgEl.setAttribute('width',  W);
  svgEl.setAttribute('height', H);

  // Arrow marker def
  svgEl.innerHTML = `<defs>
    <marker id="arr_${tk}" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#93c5fd"/>
    </marker>
    <marker id="arr_${tk}_red" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#fca5a5"/>
    </marker>
  </defs>`;

  // Connectors
  for(const c of conns) drawConn(svgEl, c, tk);

  // Boxes
  for(const it of items){
    if(it.type==='prob') renderProbBox(canvasEl, it, tk);
    if(it.type==='node') renderNodeBox(canvasEl, it, tk);
    if(it.type==='rcb')  renderRcbBox(canvasEl, it, tk);
  }
}

function drawConn(svg, c, tk){
  const dx = c.x2-c.x1, dy = c.y2-c.y1;
  // Bezier control points
  const cx1 = c.x1 + dx*0.45;
  const cy1 = c.y1;
  const cx2 = c.x2 - dx*0.45;
  const cy2 = c.y2;
  const d   = `M${c.x1},${c.y1} C${cx1},${cy1} ${cx2},${cy2} ${c.x2},${c.y2}`;

  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d', d);
  path.setAttribute('fill', 'none');
  if(c.dashed){
    path.setAttribute('stroke','#fca5a5');
    path.setAttribute('stroke-width','1.8');
    path.setAttribute('stroke-dasharray','5,4');
    path.setAttribute('marker-end',`url(#arr_${tk}_red)`);
  } else {
    path.setAttribute('stroke','#93c5fd');
    path.setAttribute('stroke-width','2');
    path.setAttribute('marker-end',`url(#arr_${tk})`);
  }
  svg.appendChild(path);

  if(!c.dashed && Math.abs(dx)>20){
    // "Neden?" label â€“ forward direction (right side of curve)
    const mx = c.x1 + dx*0.5;
    const my = c.y1 + dy*0.5;
    addSvgTxt(svg, mx+3, my-9,  'Neden?',     '#2563eb', true,  10);
    addSvgTxt(svg, mx-2, my+16, 'â† Bu yÃ¼zden','#94a3b8', false, 9);
  }
}

function addSvgTxt(svg, x, y, txt, color, bold, size){
  const t = document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x', x); t.setAttribute('y', y);
  t.setAttribute('fill', color);
  t.setAttribute('font-size', size);
  t.setAttribute('font-family','Segoe UI,Arial,sans-serif');
  if(bold) t.setAttribute('font-weight','700');
  t.textContent = txt;
  svg.appendChild(t);
}

function renderProbBox(canvas, it, tk){
  const div = document.createElement('div');
  div.className = 'prob-node' + (tk==='nd'?' nd-track':'');
  div.style.cssText = `left:${it.x}px;top:${it.y}px;width:${it.w}px;min-height:${it.h}px;`;
  div.innerHTML = `<div class="prob-lbl">Problem TanÄ±mÄ±</div>
    <textarea placeholder="Problemi buraya yazÄ±nâ€¦"></textarea>`;
  div.querySelector('textarea').value = _S[tk].problem;
  div.querySelector('textarea').addEventListener('input', e => { _S[tk].problem = e.target.value; });
  canvas.appendChild(div);
}

function renderNodeBox(canvas, it, tk){
  const node = it.node;
  const div  = document.createElement('div');
  div.className = 'why-node'+(node.isRoot?' is-root':'')+(node.isBranch?' is-branch':'');
  div.style.cssText = `left:${it.x}px;top:${it.y}px;width:${it.w}px;min-height:${it.h}px;`;

  let tagHtml = '';
  if(node.isRoot)        tagHtml = `<span class="ntag r">ğŸ¯ KÃ¶k Neden</span>`;
  else if(node.isBranch) tagHtml = `<span class="ntag b">ğŸŒ¿ Dallanma</span>`;

  div.innerHTML = `${tagHtml}
    <textarea placeholder="Nedeni yazÄ±nâ€¦" style="margin-top:${(node.isRoot||node.isBranch)?'10px':'0'}">${node.text}</textarea>
    <div class="node-acts">
      <button class="na del" title="Sil (alt dallarÄ±yla)">ğŸ—‘</button>
      <button class="na add" title="Alt neden (saÄŸa dal) ekle">â• Neden</button>
      <button class="na root">${node.isRoot?'ğŸ¯ KÃ¶k âœ“':'ğŸ¯ KÃ¶k Neden'}</button>
      <button class="na br">${node.isBranch?'ğŸŒ¿ Dal âœ“':'ğŸŒ¿ Dal'}</button>
    </div>`;

  const ta = div.querySelector('textarea');
  ta.addEventListener('input', e => { node.text = e.target.value; });
  ta.addEventListener('dblclick', e => {
    e.stopPropagation();
    openModal('âœï¸ Nedeni DÃ¼zenle', node.text, val => { node.text = val; renderTrack(tk); });
  });
  div.querySelector('.del').onclick  = () => deleteNode(tk, node.id);
  div.querySelector('.add').onclick  = () => { node.children.push(mkNode()); renderTrack(tk); };
  div.querySelector('.root').onclick = () => { node.isRoot   = !node.isRoot;   renderTrack(tk); };
  div.querySelector('.br').onclick   = () => { node.isBranch = !node.isBranch; renderTrack(tk); };

  canvas.appendChild(div);
}

function renderRcbBox(canvas, it, tk){
  const div = document.createElement('div');
  div.className = 'rcb';
  div.style.cssText = `left:${it.x}px;top:${it.y}px;width:${it.w}px;min-height:${it.h}px;`;
  div.innerHTML = `<div class="rcb-icon">â¬‡ï¸</div>
    <div class="rcb-lbl">Teknik KÃ¶k Neden</div>
    <textarea placeholder="KÃ¶k nedenâ€¦"></textarea>`;
  div.querySelector('textarea').value = _S[tk].rcText;
  div.querySelector('textarea').addEventListener('input', e => { _S[tk].rcText = e.target.value; });
  canvas.appendChild(div);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addRootNode(tk){
  _S[tk].tree.push(mkNode());
  renderTrack(tk);
}
function deleteNode(tk, id){
  const f = findParent(_S[tk].tree, id);
  if(!f) return;
  f.arr.splice(f.i, 1);
  if(_S[tk].tree.length===0) _S[tk].tree.push(mkNode());
  renderTrack(tk);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, txt, cb){
  _modalCb = cb;
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalTa').value = txt;
  document.getElementById('editModal').classList.add('open');
  setTimeout(()=>document.getElementById('modalTa').focus(), 60);
}
function closeModal(){ document.getElementById('editModal').classList.remove('open'); _modalCb=null; }
function saveModal(){ if(_modalCb) _modalCb(document.getElementById('modalTa').value); closeModal(); }
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') closeModal();
  if(e.key==='Enter'&&e.ctrlKey&&document.getElementById('editModal').classList.contains('open')) saveModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDEXED DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IDB_NAME='KaliteRaporDB', IDB_STORE='payloads', IDB_KEY='5neden_v1';
function idbOpen(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(IDB_NAME,1);
    req.onupgradeneeded=e=>e.target.result.createObjectStore(IDB_STORE);
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(e.target.error);
  });
}
function idbPut(d){ return idbOpen().then(db=>new Promise((res,rej)=>{ const r=db.transaction(IDB_STORE,'readwrite').objectStore(IDB_STORE).put(d,IDB_KEY); r.onsuccess=()=>res(); r.onerror=e=>rej(e.target.error); })); }
function idbGet(){ return idbOpen().then(db=>new Promise((res,rej)=>{ const r=db.transaction(IDB_STORE,'readonly').objectStore(IDB_STORE).get(IDB_KEY); r.onsuccess=e=>res(e.target.result); r.onerror=e=>rej(e.target.error); })); }

function gatherMeta(){
  _S.meta = {
    part:     document.getElementById('mPart').value,
    customer: document.getElementById('mCustomer').value,
    date:     document.getElementById('mDate').value,
    analyst:  document.getElementById('mAnalyst').value,
    status:   document.getElementById('mStatus').value
  };
}
function applyMeta(){
  const m=_S.meta||{};
  const map={mPart:'part',mCustomer:'customer',mDate:'date',mAnalyst:'analyst',mStatus:'status'};
  Object.entries(map).forEach(([id,k])=>{ if(m[k]) document.getElementById(id).value=m[k]; });
}
function saveData(){
  gatherMeta();
  idbPut(JSON.parse(JSON.stringify(_S)))
    .then(()=>alert('âœ… Analiz kaydedildi.'))
    .catch(e=>alert('âŒ '+e));
}
function loadData(){
  idbGet().then(d=>{
    if(!d){alert('KayÄ±tlÄ± analiz bulunamadÄ±.');return;}
    _S=d; applyMeta(); render(); alert('ğŸ“‚ Analiz yÃ¼klendi.');
  }).catch(e=>alert('âŒ '+e));
}
function resetAll(){
  if(!confirm('TÃ¼m analiz sÄ±fÄ±rlansÄ±n mÄ±?')) return;
  _S={
    meta:{},
    os:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(OluÅŸum)',            tree:[mkNode()]},
    nd:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(Tespit Edilememe)',   tree:[mkNode()]}
  };
  ['mPart','mCustomer','mDate','mAnalyst'].forEach(id=>document.getElementById(id).value='');
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('mDate').valueAsDate = new Date();
render();
</script>
</body>
</html>
