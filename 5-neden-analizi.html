<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5 Neden Analizi</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f4f8;color:#1e293b;min-height:100vh;}

.topbar{display:flex;align-items:center;gap:10px;padding:10px 18px;
  background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.22);flex-wrap:wrap;}
.topbar h1{font-size:1.1rem;font-weight:800;}
.topbar .sp{flex:1;}
.tbb{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.32);
  color:#fff;border-radius:7px;padding:5px 13px;font-size:.76rem;font-weight:600;
  cursor:pointer;transition:.15s;white-space:nowrap;}
.tbb:hover{background:rgba(255,255,255,.27);}
.tbb.danger{background:rgba(220,38,38,.38);border-color:rgba(220,38,38,.6);}
.tbb.ok{background:rgba(22,163,74,.46);border-color:rgba(22,163,74,.7);}

.meta-bar{display:flex;gap:10px;flex-wrap:wrap;padding:9px 18px;background:#fff;
  border-bottom:1px solid #e2e8f0;align-items:flex-end;}
.mf{display:flex;flex-direction:column;gap:2px;flex:1;min-width:150px;}
.mf label{font-size:.62rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;}
.mf input,.mf select{border:1.5px solid #e2e8f0;border-radius:6px;padding:4px 8px;
  font-size:.8rem;outline:none;transition:.2s;}
.mf input:focus,.mf select:focus{border-color:#2563eb;}

.legend{display:flex;gap:14px;flex-wrap:wrap;padding:6px 18px;background:#f8faff;
  border-bottom:1px solid #e2e8f0;font-size:.71rem;align-items:center;color:#475569;}
.li{display:flex;align-items:center;gap:5px;}
.lb{width:22px;height:13px;border-radius:2px;border:2px solid;}
.lb.n{background:#fff;border-color:#94a3b8;}
.lb.r{background:#fff5f5;border-color:#dc2626;border-style:dashed;}

/* â”€â”€ CANVAS â”€â”€ */
.canvas-outer{overflow:auto;padding:18px 18px 48px;background:#eef2f7;}
.track-wrap{margin-bottom:52px;}
.track-hdr{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.tbadge{font-size:.7rem;font-weight:800;color:#fff;border-radius:6px;
  padding:3px 11px;text-transform:uppercase;letter-spacing:.07em;}
.tbadge.os{background:#2563eb;} .tbadge.nd{background:#7c3aed;}
.tsub{font-size:.68rem;font-style:italic;color:#94a3b8;}

/* â”€â”€ DIAGRAM CANVAS â”€â”€ */
.diag{position:relative;overflow:visible;}
.diag svg{position:absolute;top:0;left:0;pointer-events:none;overflow:visible;}

/* â”€â”€ PROBLEM BOX â”€â”€ */
.pbox{position:absolute;border:2.5px solid #2563eb;border-radius:8px;
  background:#eef4ff;padding:8px 10px;}
.pbox.nd-t{border-color:#7c3aed;background:#f4f0ff;}
.plbl{font-size:.58rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:4px;color:#2563eb;}
.pbox.nd-t .plbl{color:#7c3aed;}
.pbox textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.75rem;color:#1e293b;font-family:inherit;line-height:1.4;min-height:46px;}

/* â”€â”€ STEP BOX â”€â”€ */
.sbox{position:absolute;border:2px solid #cbd5e1;border-radius:8px;
  background:#fff;padding:7px 10px;
  box-shadow:0 1px 5px rgba(0,0,0,.06);transition:border .15s,box-shadow .15s;}
.sbox:hover{border-color:#93c5fd;box-shadow:0 2px 8px rgba(37,99,235,.13);}
.sbox.is-root{border-color:#dc2626;border-style:dashed;border-width:2.5px;background:#fff7f7;}
.stag{position:absolute;top:-9px;left:8px;font-size:.57rem;font-weight:800;
  padding:1px 7px;border-radius:10px;background:#dc2626;color:#fff;white-space:nowrap;}
.sbox textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.75rem;color:#1e293b;font-family:inherit;line-height:1.4;
  min-height:38px;margin-top:0;}
.sbox.is-root textarea{margin-top:10px;}
.sacts{display:flex;gap:3px;margin-top:5px;flex-wrap:wrap;}
.sa{font-size:.58rem;padding:2px 6px;border-radius:4px;border:1px solid;
  cursor:pointer;font-weight:700;background:#fff;transition:.12s;white-space:nowrap;}
.sa.add{color:#2563eb;border-color:#bfdbfe;background:#eff6ff;}
.sa.add:hover{background:#2563eb;color:#fff;}
.sa.root{color:#dc2626;border-color:#fca5a5;background:#fff5f5;}
.sa.root:hover{background:#dc2626;color:#fff;}
.sa.fork{color:#7c3aed;border-color:#ddd6fe;background:#f5f3ff;}
.sa.fork:hover{background:#7c3aed;color:#fff;}
.sa.del{color:#94a3b8;border-color:#e2e8f0;}
.sa.del:hover{background:#ef4444;color:#fff;border-color:#ef4444;}

/* â”€â”€ ROOT CAUSE BOX â”€â”€ */
.rcb{position:absolute;border:2.5px dashed #dc2626;border-radius:10px;
  background:#fff5f5;padding:10px 12px;text-align:center;}
.rcb .ri{font-size:1.1rem;}
.rcb .rl{font-size:.6rem;font-weight:800;text-transform:uppercase;
  color:#dc2626;letter-spacing:.04em;margin:4px 0 2px;}
.rcb textarea{width:100%;border:none;outline:none;resize:none;background:transparent;
  font-size:.7rem;color:#b91c1c;font-family:inherit;text-align:center;
  line-height:1.3;min-height:30px;}

/* â”€â”€ STEP ADD BTN â”€â”€ */
.add-step-btn{display:inline-flex;align-items:center;gap:5px;
  font-size:.72rem;font-weight:700;color:#2563eb;background:#eff6ff;
  border:1.5px dashed #93c5fd;border-radius:8px;padding:5px 13px;
  cursor:pointer;margin-top:6px;transition:.15s;}
.add-step-btn:hover{background:#dbeafe;}
.add-step-btn.nd{color:#7c3aed;background:#f5f3ff;border-color:#c4b5fd;}
.add-step-btn.nd:hover{background:#ede9fe;}

/* â”€â”€ MODAL â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.42);
  z-index:9000;align-items:center;justify-content:center;}
.mo.open{display:flex;}
.mb{background:#fff;border-radius:14px;padding:22px 24px 18px;
  max-width:420px;width:95%;box-shadow:0 8px 40px rgba(0,0,0,.2);}
.mb h3{font-size:.92rem;font-weight:800;margin-bottom:12px;color:#1e293b;}
.mb textarea{width:100%;min-height:80px;border:1.5px solid #e2e8f0;
  border-radius:8px;padding:8px 10px;font-size:.82rem;resize:vertical;
  font-family:inherit;outline:none;}
.mb textarea:focus{border-color:#2563eb;}
.mbts{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}
.mbt{padding:6px 17px;border-radius:7px;font-size:.8rem;font-weight:700;
  cursor:pointer;border:none;}
.mbt.c{background:#f1f5f9;color:#64748b;}
.mbt.s{background:#2563eb;color:#fff;}
.mbt.s:hover{background:#1d4ed8;}

@media print{
  .topbar,.meta-bar,.legend,.sacts,.add-step-btn,.tbb{display:none!important;}
  body,.canvas-outer{background:#fff;}
}
</style>
</head>
<body>

<div class="topbar">
  <span style="font-size:1.3rem">ğŸ”</span>
  <h1>5 Neden Analizi</h1>
  <div class="sp"></div>
  <button class="tbb ok"    onclick="saveData()">ğŸ’¾ Kaydet</button>
  <button class="tbb"       onclick="loadData()">ğŸ“‚ YÃ¼kle</button>
  <button class="tbb"       onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r / PDF</button>
  <button class="tbb danger" onclick="resetAll()">ğŸ—‘ SÄ±fÄ±rla</button>
</div>

<div class="meta-bar">
  <div class="mf"><label>Problem / ParÃ§a No</label><input id="mPart" placeholder="Ã¶rn: Part# 12345 â€“ Vida"></div>
  <div class="mf"><label>MÃ¼ÅŸteri / Proje</label><input id="mCustomer" placeholder="Ã¶rn: ArÃ§elik A.Å."></div>
  <div class="mf" style="max-width:155px"><label>Tarih</label><input id="mDate" type="date"></div>
  <div class="mf"><label>Analist</label><input id="mAnalyst" placeholder="Ã¶rn: Kalite MÃ¼dÃ¼rÃ¼"></div>
  <div class="mf" style="max-width:172px"><label>Durum</label>
    <select id="mStatus">
      <option>ğŸ”„ Devam Ediyor</option>
      <option>âœ… TamamlandÄ±</option>
      <option>ğŸ” Ä°ncelemede</option>
    </select>
  </div>
</div>

<div class="legend">
  <strong>GÃ¶sterim:</strong>
  <div class="li"><div class="lb n"></div><span>Neden adÄ±mÄ±</span></div>
  <div class="li"><div class="lb r"></div><span>KÃ¶k neden (son adÄ±m)</span></div>
  <span style="color:#94a3b8;font-size:.65rem">
    | â• AdÄ±m Ekle â†’ zincire yeni neden ekler &nbsp;Â·&nbsp;
    ğŸª¢ Paralel Dal â†’ aynÄ± noktadan baÄŸÄ±msÄ±z bir zincir baÅŸlatÄ±r (5N literatÃ¼rÃ¼ndeki "branching") &nbsp;Â·&nbsp;
    Ã‡ift tÄ±kla â†’ bÃ¼yÃ¼k metin editÃ¶rÃ¼
  </span>
</div>

<div class="canvas-outer" id="co">
  <!-- OluÅŸum track -->
  <div class="track-wrap">
    <div class="track-hdr">
      <span class="tbadge os">ğŸ”´ OluÅŸum</span>
      <span class="tsub">Neden problem oluÅŸtu? â€” her adÄ±m Ã¶ncekinin nedenidir</span>
    </div>
    <div class="diag" id="osDiag">
      <svg id="osSvg"></svg>
    </div>
    <button class="add-step-btn" onclick="addStep('os')">â• AdÄ±m Ekle</button>
  </div>

  <!-- Tespit track -->
  <div class="track-wrap">
    <div class="track-hdr">
      <span class="tbadge nd">ğŸŸ£ Tespit Edilememe</span>
      <span class="tsub">Problem neden fark edilmedi?</span>
    </div>
    <div class="diag" id="ndDiag">
      <svg id="ndSvg"></svg>
    </div>
    <button class="add-step-btn nd" onclick="addStep('nd')">â• AdÄ±m Ekle</button>
  </div>
</div>

<div class="mo" id="editModal">
  <div class="mb">
    <h3 id="mTitle">âœï¸ Nedeni DÃ¼zenle</h3>
    <textarea id="mTa" rows="4" placeholder="Nedeni buraya yazÄ±nâ€¦"></textarea>
    <div class="mbts">
      <button class="mbt c" onclick="closeModal()">Ä°ptal</button>
      <button class="mbt s" onclick="saveModal()">Kaydet</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  5 NEDEN   â€“  STAIRCASE LAYOUT
//  Referans: Her "Neden?" kutusu Ã¶ncekinden saÄŸa ve
//  biraz aÅŸaÄŸÄ±ya kayar â†’ merdiven efekti.
//  "Paralel Dal": AynÄ± noktadan baÄŸÄ±msÄ±z ikinci bir
//  doÄŸrusal zincir baÅŸlar, ana zincirin altÄ±nda yÃ¼rÃ¼r.
//
//  Veri modeli:
//  track:
//    problem : string
//    rcText  : string
//    chains  : Chain[]        â† chains[0] = ana zincir, chains[1..] = paralel dallar
//
//  Chain:
//    startAfterStep : number | null  (hangi ana adÄ±mdan dallandÄ±ÄŸÄ±, null=ana)
//    steps          : Step[]
//
//  Step: { id, text, isRoot }
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BOX_W    = 175;
const BOX_H    = 92;
const PROB_W   = 170;
const PROB_H   = 84;
const RCB_W    = 155;
const RCB_H    = 108;
const H_GAP    = 80;    // horizontal gap between box right and next box left (arrow space)
const V_STEP   = 72;    // how much lower each main-chain step is vs the previous
const BRANCH_V = 28;    // extra vertical gap between branches at same column
const COL_W    = BOX_W + H_GAP;   // full column stride

let _S = {
  meta: {},
  os: { problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(OluÅŸum)',
        chains: [ { startAfter:null, steps:[ mkStep() ] } ] },
  nd: { problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(Tespit Edilememe)',
        chains: [ { startAfter:null, steps:[ mkStep() ] } ] }
};

function mkStep(t){ return {id:uid(), text:t||'', isRoot:false}; }
function uid(){ return 'n'+Math.random().toString(36).slice(2,9); }

let _mCb = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addStep(tk){
  _S[tk].chains[0].steps.push(mkStep());
  renderTrack(tk);
}

function deleteStep(tk, chainIdx, stepIdx){
  const chain = _S[tk].chains[chainIdx];
  chain.steps.splice(stepIdx,1);
  if(chain.steps.length===0){
    if(chainIdx===0) chain.steps.push(mkStep());  // keep at least 1 in main
    else _S[tk].chains.splice(chainIdx,1);        // remove empty branch
  }
  renderTrack(tk);
}

function addParallelBranch(tk, afterMainStepIdx){
  // Add a new parallel chain that "starts after" step afterMainStepIdx of main chain
  _S[tk].chains.push({ startAfter: afterMainStepIdx, steps: [mkStep()] });
  renderTrack(tk);
}

function addBranchStep(tk, chainIdx){
  _S[tk].chains[chainIdx].steps.push(mkStep());
  renderTrack(tk);
}

function toggleRoot(tk, chainIdx, stepIdx){
  const s = _S[tk].chains[chainIdx].steps[stepIdx];
  s.isRoot = !s.isRoot;
  renderTrack(tk);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAYOUT  â€“ merdiven (staircase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLayout(tk){
  const track = _S[tk];
  const items = [];   // { type, data, x, y, w, h, cx, cy }
  const conns = [];   // { x1,y1,x2,y2, dashed, label }

  // â”€â”€ Problem box â”€â”€
  // Position determined after computing main-chain height
  const mainChain = track.chains[0];
  const mainLen   = mainChain.steps.length;

  // Main chain: step[i] at col i+1, row = i (staircase)
  const mainItems = [];
  for(let i=0;i<mainLen;i++){
    const x  = (i+1)*COL_W;
    const y  = 0 + i*V_STEP;
    const cx = x+BOX_W, cy = y+BOX_H/2;
    mainItems.push({ type:'step', chain:0, stepIdx:i,
      data:mainChain.steps[i], x, y, w:BOX_W, h:BOX_H, cx, cy, tk });
    items.push(mainItems[i]);
  }

  // Problem box: left-aligned, centered vertically with first main step
  const probCY = mainItems.length ? mainItems[0].cy : BOX_H/2;
  const probY  = probCY - PROB_H/2;
  const probX  = 0;
  items.unshift({ type:'prob', tk, x:probX, y:probY, w:PROB_W, h:PROB_H, cx:PROB_W, cy:probCY });

  // Connector prob â†’ step[0]
  if(mainItems.length>0){
    conns.push({ x1:PROB_W, y1:probCY, x2:mainItems[0].x, y2:mainItems[0].cy, label:'why' });
  }
  // Connectors step[i] â†’ step[i+1]
  for(let i=0;i<mainItems.length-1;i++){
    conns.push({ x1:mainItems[i].cx, y1:mainItems[i].cy,
                 x2:mainItems[i+1].x, y2:mainItems[i+1].cy, label:'why' });
  }

  // Root cause box: to the right of last main step
  let rcbY, rcbX;
  if(mainItems.length){
    const last = mainItems[mainItems.length-1];
    rcbX = last.cx + H_GAP;
    rcbY = last.cy - RCB_H/2;
  } else {
    rcbX = COL_W;
    rcbY = 0;
  }

  // Connector last main step â†’ rcb (if chain ends)
  if(mainItems.length){
    const last = mainItems[mainItems.length-1];
    conns.push({ x1:last.cx, y1:last.cy, x2:rcbX, y2:last.cy, label:'why', toRcb:true });
  }

  items.push({ type:'rcb', tk, x:rcbX, y:rcbY, w:RCB_W, h:RCB_H });

  // â”€â”€ Parallel branch chains â”€â”€
  // Each branch chain "starts after" a specific main-chain step index
  // It runs BELOW the main chain, starting from col (startAfter+1)

  // Track how much vertical offset each starting column already uses
  const colBottomY = {};   // col â†’ bottom Y of last thing placed
  for(const it of mainItems){
    const col = Math.round(it.x / COL_W);
    colBottomY[col] = (colBottomY[col]||0) < it.y+it.h ? it.y+it.h : colBottomY[col];
  }

  for(let ci=1; ci<track.chains.length; ci++){
    const chain = track.chains[ci];
    const sa    = chain.startAfter ?? 0;  // starts after which main step
    const startCol = sa + 1;              // same column as next main step after fork

    // Find the bottom of that column in main chain
    let branchTopY = 0;
    // Bottom Y of startCol in main chain (if it exists) + gap
    if(mainItems[sa]){
      branchTopY = mainItems[sa].y + mainItems[sa].h + BRANCH_V;
    }
    // Also check already placed branches at same starting column
    const cKey = `${ci}_start`;
    if(colBottomY[startCol] !== undefined){
      branchTopY = Math.max(branchTopY, colBottomY[startCol] + BRANCH_V);
    }

    // Draw fork connector from main step[sa] down to first branch step
    const forkAnchor = mainItems[sa] || {cx: PROB_W, cy: probCY};
    const brItems = [];

    for(let si=0; si<chain.steps.length; si++){
      const x  = (startCol + si) * COL_W;
      const y  = branchTopY + si * V_STEP;
      const cx = x+BOX_W, cy = y+BOX_H/2;
      const it = { type:'step', chain:ci, stepIdx:si,
        data:chain.steps[si], x, y, w:BOX_W, h:BOX_H, cx, cy, tk, isBranch:true };
      brItems.push(it);
      items.push(it);
      // Update colBottomY
      const col = Math.round(x/COL_W);
      colBottomY[col] = Math.max(colBottomY[col]||0, y+BOX_H);
    }

    // Fork connector: from main step â†’ branch step[0] (dashed, going diagonally down)
    if(brItems.length){
      conns.push({ x1:forkAnchor.cx, y1:forkAnchor.cy,
                   x2:brItems[0].x, y2:brItems[0].cy, label:'why', dashed:true });
    }
    // Branch internal connectors
    for(let si=0; si<brItems.length-1; si++){
      conns.push({ x1:brItems[si].cx, y1:brItems[si].cy,
                   x2:brItems[si+1].x, y2:brItems[si+1].cy, label:'why', dashed:false });
    }
    // Branch â†’ rcb connector
    if(brItems.length){
      const bLast = brItems[brItems.length-1];
      // Dashed arrow to same root cause box (simplified)
      conns.push({ x1:bLast.cx, y1:bLast.cy, x2:rcbX, y2:rcbY+RCB_H/2, label:'', dashed:true });
    }

    // Add "Add branch step" button-item
    items.push({ type:'addBranchStep', ci, tk,
      x: startCol*COL_W + (chain.steps.length)*COL_W,
      y: branchTopY + (chain.steps.length-1)*V_STEP });
  }

  // Canvas size
  const xs = items.map(i=>i.x+(i.w||BOX_W));
  const ys = items.map(i=>i.y+(i.h||BOX_H));
  const W = Math.max(...xs) + 40;
  const H = Math.max(...ys) + 30;
  return { items, conns, W, H };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){ renderTrack('os'); renderTrack('nd'); }

function renderTrack(tk){
  const diag = document.getElementById(tk+'Diag');
  const svg  = document.getElementById(tk+'Svg');
  // Clear all children except svg
  Array.from(diag.childNodes).forEach(c=>{ if(c!==svg) diag.removeChild(c); });
  svg.innerHTML = '';

  const {items, conns, W, H} = doLayout(tk);
  diag.style.width  = W+'px';
  diag.style.height = H+'px';
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);

  // Arrow markers
  svg.innerHTML = `<defs>
    <marker id="ab_${tk}"  markerWidth="7" markerHeight="7" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L7,3 z" fill="#93c5fd"/>
    </marker>
    <marker id="abr_${tk}" markerWidth="7" markerHeight="7" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L7,3 z" fill="#c4b5fd"/>
    </marker>
  </defs>`;

  for(const c of conns) drawConn(svg, c, tk);
  for(const it of items){
    if(it.type==='prob')          renderProbBox(diag, it, tk);
    else if(it.type==='step')     renderStepBox(diag, it, tk);
    else if(it.type==='rcb')      renderRcbBox(diag, it, tk);
    else if(it.type==='addBranchStep') renderAddBranchBtn(diag, it, tk);
  }
}

function drawConn(svg, c, tk){
  const dx = c.x2-c.x1, dy = c.y2-c.y1;
  const isDiag = Math.abs(dy) > 8;
  let d;
  if(isDiag){
    // Curved connector (diagonal)
    const cpx1 = c.x1 + dx*0.5, cpy1 = c.y1;
    const cpx2 = c.x2 - dx*0.3, cpy2 = c.y2;
    d = `M${c.x1},${c.y1} C${cpx1},${cpy1} ${cpx2},${cpy2} ${c.x2},${c.y2}`;
  } else {
    // Horizontal connector (with slight step for staircase feel)
    // Elbow connector: go right halfway, then horizontally to target
    const mx = c.x1 + (c.x2-c.x1)*0.5;
    d = `M${c.x1},${c.y1} L${mx},${c.y1} L${mx},${c.y2} L${c.x2},${c.y2}`;
  }

  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d', d);
  path.setAttribute('fill','none');
  const color  = c.dashed ? '#c4b5fd' : '#93c5fd';
  const marker = c.dashed ? `url(#abr_${tk})` : `url(#ab_${tk})`;
  path.setAttribute('stroke', color);
  path.setAttribute('stroke-width', '2');
  if(c.dashed) path.setAttribute('stroke-dasharray','5,4');
  path.setAttribute('marker-end', marker);
  svg.appendChild(path);

  if(c.label==='why'){
    // "Neden?" forward label
    const mx  = (c.x1+c.x2)/2, my = (c.y1+c.y2)/2;
    const off = isDiag ? 0 : -2;
    svgTxt(svg, mx+2, my-10+off, 'Neden?',     '#2563eb', true,  10);
    svgTxt(svg, mx-6, my+14+off, 'â† Bu yÃ¼zden','#94a3b8', false, 9);
  }
}

function svgTxt(svg, x, y, t, fill, bold, size){
  const el = document.createElementNS('http://www.w3.org/2000/svg','text');
  el.setAttribute('x',x); el.setAttribute('y',y);
  el.setAttribute('fill',fill); el.setAttribute('font-size',size);
  el.setAttribute('font-family','Segoe UI,Arial,sans-serif');
  if(bold) el.setAttribute('font-weight','700');
  el.textContent = t;
  svg.appendChild(el);
}

function renderProbBox(diag, it, tk){
  const d = div('pbox'+(tk==='nd'?' nd-t':''), it.x, it.y, it.w, it.h);
  d.innerHTML = `<div class="plbl">Problem TanÄ±mÄ±</div><textarea placeholder="Problemi yazÄ±nâ€¦"></textarea>`;
  d.querySelector('textarea').value = _S[tk].problem;
  d.querySelector('textarea').oninput = e => { _S[tk].problem = e.target.value; };
  diag.appendChild(d);
}

function renderStepBox(diag, it, tk){
  const node = it.data;
  const el   = div('sbox'+(node.isRoot?' is-root':''), it.x, it.y, it.w, it.h);
  el.innerHTML = (node.isRoot?`<span class="stag">ğŸ¯ KÃ¶k Neden</span>`:'') +
    `<textarea placeholder="Nedeni yazÄ±nâ€¦"></textarea>
     <div class="sacts">
       <button class="sa del" title="Sil">ğŸ—‘</button>
       <button class="sa add" title="Bu adÄ±mdan zincire devam et (saÄŸa uzat)">â• AdÄ±m</button>
       <button class="sa fork" title="Bu noktadan paralel baÄŸÄ±msÄ±z bir zincir baÅŸlat (dal)">ğŸª¢ Paralel Dal</button>
       <button class="sa root">${node.isRoot?'ğŸ¯ KÃ¶k âœ“':'ğŸ¯ KÃ¶k Neden'}</button>
     </div>`;

  const ta = el.querySelector('textarea');
  ta.value = node.text;
  ta.oninput = e => { node.text = e.target.value; };
  ta.addEventListener('dblclick', e=>{
    e.stopPropagation();
    openModal('âœï¸ Nedeni DÃ¼zenle', node.text, val=>{ node.text=val; renderTrack(tk); });
  });
  el.querySelector('.del').onclick = ()=> deleteStep(tk, it.chain, it.stepIdx);
  el.querySelector('.root').onclick = ()=> toggleRoot(tk, it.chain, it.stepIdx);

  el.querySelector('.add').onclick = ()=>{
    // Extend THIS chain
    _S[tk].chains[it.chain].steps.splice(it.stepIdx+1, 0, mkStep());
    renderTrack(tk);
  };
  el.querySelector('.fork').onclick = ()=>{
    // Add a new parallel chain starting from this main-chain step
    // Only works from main chain (chain 0) for simplicity
    const mainStepIdx = it.chain===0 ? it.stepIdx : (_S[tk].chains[it.chain].startAfter ?? 0);
    addParallelBranch(tk, mainStepIdx);
  };

  diag.appendChild(el);
}

function renderRcbBox(diag, it, tk){
  const el = div('rcb', it.x, it.y, it.w, it.h);
  el.innerHTML = `<div class="ri">â¬‡ï¸</div>
    <div class="rl">Teknik KÃ¶k Neden</div>
    <textarea placeholder="KÃ¶k nedenâ€¦"></textarea>`;
  el.querySelector('textarea').value = _S[tk].rcText;
  el.querySelector('textarea').oninput = e => { _S[tk].rcText = e.target.value; };
  diag.appendChild(el);
}

function renderAddBranchBtn(diag, it, tk){
  // Small "add step to this branch" button
  const b = document.createElement('button');
  b.className = 'add-step-btn'+(tk==='nd'?' nd':'');
  b.style.cssText = `position:absolute;left:${it.x}px;top:${it.y+BOX_H/2}px;font-size:.64rem;padding:3px 9px;`;
  b.textContent = 'â• Dal AdÄ±mÄ±';
  b.onclick = () => addBranchStep(tk, it.ci);
  diag.appendChild(b);
}

function div(cls, x, y, w, h){
  const el = document.createElement('div');
  el.className = cls;
  el.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:${w}px;min-height:${h}px;`;
  return el;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, txt, cb){
  _mCb = cb;
  document.getElementById('mTitle').textContent = title;
  document.getElementById('mTa').value = txt;
  document.getElementById('editModal').classList.add('open');
  setTimeout(()=>document.getElementById('mTa').focus(), 60);
}
function closeModal(){ document.getElementById('editModal').classList.remove('open'); _mCb=null; }
function saveModal(){ if(_mCb) _mCb(document.getElementById('mTa').value); closeModal(); }

document.addEventListener('keydown', e=>{
  if(e.key==='Escape') closeModal();
  if(e.key==='Enter'&&e.ctrlKey&&document.getElementById('editModal').classList.contains('open')) saveModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDEXED DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB='KaliteRaporDB', ST='payloads', KEY='5neden_v1';
function idbOpen(){
  return new Promise((ok,err)=>{
    const r=indexedDB.open(DB,1);
    r.onupgradeneeded=e=>e.target.result.createObjectStore(ST);
    r.onsuccess=e=>ok(e.target.result);
    r.onerror=e=>err(e.target.error);
  });
}
function idbPut(d){ return idbOpen().then(db=>new Promise((ok,er)=>{ const r=db.transaction(ST,'readwrite').objectStore(ST).put(d,KEY); r.onsuccess=()=>ok(); r.onerror=e=>er(e.target.error); })); }
function idbGet(){ return idbOpen().then(db=>new Promise((ok,er)=>{ const r=db.transaction(ST,'readonly').objectStore(ST).get(KEY); r.onsuccess=e=>ok(e.target.result); r.onerror=e=>er(e.target.error); })); }

function gatherMeta(){
  _S.meta={
    part:document.getElementById('mPart').value,
    customer:document.getElementById('mCustomer').value,
    date:document.getElementById('mDate').value,
    analyst:document.getElementById('mAnalyst').value,
    status:document.getElementById('mStatus').value
  };
}
function applyMeta(){
  const m=_S.meta||{};
  const map={mPart:'part',mCustomer:'customer',mDate:'date',mAnalyst:'analyst',mStatus:'status'};
  Object.entries(map).forEach(([id,k])=>{ if(m[k]) document.getElementById(id).value=m[k]; });
}
function saveData(){
  gatherMeta();
  idbPut(JSON.parse(JSON.stringify(_S)))
    .then(()=>alert('âœ… Analiz kaydedildi.'))
    .catch(e=>alert('âŒ '+e));
}
function loadData(){
  idbGet().then(d=>{
    if(!d){alert('KayÄ±tlÄ± analiz bulunamadÄ±.');return;}
    _S=d; applyMeta(); render(); alert('ğŸ“‚ Analiz yÃ¼klendi.');
  }).catch(e=>alert('âŒ '+e));
}
function resetAll(){
  if(!confirm('TÃ¼m analiz sÄ±fÄ±rlansÄ±n mÄ±?')) return;
  _S={
    meta:{},
    os:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(OluÅŸum)',
        chains:[{startAfter:null, steps:[mkStep()]}]},
    nd:{problem:'Problem tanÄ±mÄ±nÄ± buraya yazÄ±nâ€¦', rcText:'Teknik KÃ¶k Neden\n(Tespit Edilememe)',
        chains:[{startAfter:null, steps:[mkStep()]}]}
  };
  ['mPart','mCustomer','mDate','mAnalyst'].forEach(id=>document.getElementById(id).value='');
  render();
}

document.getElementById('mDate').valueAsDate = new Date();
render();
</script>
</body>
</html>
