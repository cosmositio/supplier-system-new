<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COA Ar≈üiv - Analiz Sertifikasƒ± Y√∂netimi v2.1</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <!-- Cache Buster: <?php echo time(); ?> -->
    <!-- PDF.js for PDF compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- SheetJS for Excel reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Chart.js for COA Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        /* Mobile/Desktop visibility */
        .mobile-optimized .camera-btn {
            width: 100%;
        }
        
        @media (max-width: 768px), (hover: none) and (pointer: coarse) {
            .camera-btn {
                font-size: 1.1em;
                padding: 14px 20px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-width: 100%;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #2d5a3d;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 350px 1fr;
            }
        }
        
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile Layout Order */
            .container {
                display: flex;
                flex-direction: column;
            }
            
            #statsSection {
                order: 3; /* ƒ∞statistikler en alta */
                margin-top: 30px;
                margin-bottom: 20px;
            }
            
            .main-grid {
                order: 2; /* Form ve tablo ortada */
                display: flex;
                flex-direction: column;
            }
            
            .main-grid > .card:first-child {
                order: 1; /* Form √∂nce */
                margin-bottom: 20px;
            }
            
            .main-grid > .card:last-child {
                order: 2; /* Tablo sonra */
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .container {
                padding: 0 15px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 18px;
            }
            
            .stat-card .number {
                font-size: 1.8em;
            }
            
            .stat-card .label {
                font-size: 1em;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filters input,
            .filters select {
                width: 100%;
                min-width: auto;
                padding: 14px;
                font-size: 16px;
            }
            
            .card {
                padding: 25px 20px;
            }
            
            .card h2 {
                font-size: 1.3em;
                margin-bottom: 25px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 1.05em;
                margin-bottom: 8px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px; /* Prevent zoom on iOS */
                border-width: 2px;
            }
            
            .upload-area {
                padding: 35px 20px;
                min-height: 200px;
            }
            
            .upload-icon {
                font-size: 3em;
            }
            
            .upload-text {
                font-size: 1.05em;
            }
            
            .btn {
                padding: 16px 24px;
                font-size: 1.05em;
            }
            
            /* Tablo mobil optimize */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 800px; /* Kaydƒ±rma i√ßin */
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
            
            .back-btn {
                padding: 10px 18px;
                font-size: 0.95em;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2em;
            }
            
            .stat-card .label {
                font-size: 1.05em;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .card h2 {
                font-size: 1.2em;
            }
            
            .form-group input,
            .form-group select {
                padding: 16px;
                font-size: 16px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 1.05em;
                font-weight: 700;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-sm {
                padding: 10px 14px;
                font-size: 0.9em;
                width: 100%;
                justify-content: center;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            color: #2d5a3d;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2d5a3d;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #2d5a3d;
            background: #f0f7f2;
        }
        
        .upload-area.has-file {
            border-color: #28a745;
            background: #e8f5e9;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .upload-text {
            color: #666;
        }
        
        .file-name {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2d5a3d;
            font-weight: 600;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%);
            color: white;
            width: 100%;
            justify-content: center;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 90, 61, 0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85em;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters input,
        .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .filters input {
            flex: 1;
            min-width: 200px;
        }
        
        /* Multiselect */
        .multiselect-container {
            position: relative;
            min-width: 280px;
        }
        
        .multiselect-header {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .multiselect-header:hover {
            border-color: #2196F3;
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 320px;
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        
        .multiselect-dropdown.active {
            display: block;
        }
        
        .multiselect-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }
        
        .multiselect-option:hover {
            background: #f5f5f5;
        }
        
        .multiselect-option input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .multiselect-option label {
            cursor: pointer;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .multiselect-search {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
        }
        
        .multiselect-search input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .multiselect-actions {
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: white;
        }
        
        .multiselect-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .multiselect-actions .select-all {
            background: #4CAF50;
            color: white;
        }
        
        .multiselect-actions .clear-all {
            background: #f44336;
            color: white;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        /* Tedarik√ßi s√ºtunu i√ßin kompakt geni≈ülik */
        th:nth-child(2),
        td:nth-child(2) {
            min-width: 140px;
            max-width: 180px;
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Hammadde Kodu s√ºtunu i√ßin GENƒ∞≈û alan */
        th:nth-child(3),
        td:nth-child(3) {
            min-width: 350px;
            max-width: 550px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-weight: 500;
        }
        
        /* Tarih ve lot s√ºtunlarƒ± */
        th:nth-child(4), th:nth-child(5), th:nth-child(6),
        td:nth-child(4), td:nth-child(5), td:nth-child(6) {
            min-width: 100px;
        }
        
        /* Boyut s√ºtunu */
        th:nth-child(7),
        td:nth-child(7) {
            min-width: 80px;
            text-align: center;
        }
        
        /* Lokasyon s√ºtunu */
        th:nth-child(8),
        td:nth-child(8) {
            min-width: 100px;
        }
        
        /* ƒ∞≈ülem s√ºtunu */
        th:nth-child(9),
        td:nth-child(9) {
            min-width: 200px;
            text-align: center;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .thumbnail:hover {
            transform: scale(1.1);
        }
        
        .file-icon {
            width: 50px;
            height: 50px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.75em;
            cursor: pointer;
            text-align: center;
            line-height: 1.2;
        }
        
        .file-icon.pdf {
            background: #dc3545;
        }
        
        .file-icon.doc,
        .file-icon.docx {
            background: #2b579a;
        }
        
        .file-icon.xls,
        .file-icon.xlsx {
            background: #217346;
        }
        
        .file-icon.jpg,
        .file-icon.jpeg,
        .file-icon.png,
        .file-icon.gif {
            background: #4CAF50;
        }
        
        .file-icon.txt {
            background: #666;
        }
        
        .file-icon.unknown {
            background: #999;
        }
        
        /* Geriye d√∂n√ºk uyumluluk i√ßin */
        .pdf-icon {
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }
        
        .modal-content img {
            max-width: 100%;
            display: block;
        }
        
        .modal-close {
            position: fixed;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #333; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        /* Settings */
        .settings-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .settings-section h3 {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-dot.connected {
            background: #28a745;
        }
        
        /* Tedarik√ßi dropdown stilleri */
        .supplier-input-container {
            position: relative;
        }
        
        .supplier-input-wrapper {
            position: relative;
        }
        
        .supplier-dropdown-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #999;
            font-size: 0.8em;
        }
        
        #supplierInput {
            padding-right: 35px;
        }
        
        .supplier-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .supplier-dropdown-list.active {
            display: block;
        }
        
        .supplier-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .supplier-dropdown-item:hover {
            background: #f0f7ff;
        }
        
        .supplier-dropdown-item.selected {
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .supplier-dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #999;
        }
        
        .supplier-dropdown-count {
            padding: 8px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
            color: #666;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Scanner Modal */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }

        .scanner-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            position: relative;
        }

        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scanner-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .scanner-close {
            background: #f44336;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .scanner-video,
        .scanner-canvas {
            width: 100%;
            display: block;
        }

        .scanner-canvas {
            display: none;
        }

        .scanner-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .scanner-btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scanner-btn-capture {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .scanner-btn-process {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .scanner-btn-use {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .scanner-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .scanner-status.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .scanner-status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .scanner-options {
            display: grid;
            gap: 10px;
            margin: 15px 0;
        }

        .scanner-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f7fa;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .scanner-modal {
                padding: 10px;
            }

            .scanner-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã COA Ar≈üiv Sistemi</h1>
        <a href="index.html" class="back-btn">‚Üê Ana Sayfa</a>
    </div>
    
    <div class="container">
        <!-- Stats - Mobilde en alta gidecek -->
        <div class="stats-bar" id="statsSection">
            <div class="stat-card">
                <div class="number" id="statTotal">0</div>
                <div class="label">Toplam Sertifika</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statSuppliers">0</div>
                <div class="label">Tedarik√ßi</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statThisMonth">0</div>
                <div class="label">Bu Ay</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statTotalSize">0 MB</div>
                <div class="label">Toplam Dosya</div>
            </div>
            <div class="stat-card">
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Baƒülantƒ± kontrol ediliyor...</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- Form -->
            <div class="card">
                <h2>üì§ Yeni Sertifika Ekle</h2>
                
                <div class="form-group">
                    <label>Tedarik√ßi Firma * <span id="supplierCount" style="color:#2196F3; font-weight:normal; font-size:0.9em;"></span></label>
                    <div class="supplier-input-container">
                        <div class="supplier-input-wrapper">
                            <input type="text" 
                                   id="supplierInput" 
                                   placeholder="Tedarik√ßi ara veya yazƒ±n..." 
                                   autocomplete="off"
                                   onfocus="showSupplierDropdown()"
                                   oninput="filterSupplierDropdown()"
                                   onchange="filterMaterialsBySupplier()">
                            <span class="supplier-dropdown-arrow">‚ñº</span>
                            <div class="supplier-dropdown-list" id="supplierDropdownList">
                                <div class="supplier-dropdown-count" id="supplierDropdownCount"></div>
                                <div id="supplierDropdownItems"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                        <small style="color:#666; font-size:0.85em; flex: 1; min-width: 200px;">Excel dosyasƒ± y√ºkleyerek tedarik√ßi ve hammadde listelerini otomatik doldurun</small>
                        <label for="excelFileInput" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9em; cursor: pointer; white-space: nowrap; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(46, 204, 113, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(46, 204, 113, 0.3)'">
                            üìä Excel Y√ºkle
                        </label>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="loadExcelFile(event)" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Hammadde Kodu * <span id="materialCount" style="font-size: 0.8em; color: #666;"></span></label>
                    <div class="supplier-dropdown-wrapper" style="position: relative;">
                        <input type="text" id="materialCode" placeholder="üîç Hammadde ara veya yazƒ±n..." 
                               autocomplete="off" 
                               oninput="filterMaterials(this.value)" 
                               onfocus="showMaterialDropdown()" 
                               onblur="handleMaterialBlur()"
                               style="width: 100%;">
                        <div id="materialDropdown" class="supplier-dropdown-list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div style="padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                                <span id="materialDropdownCount" style="font-size: 0.85em; color: #666; font-weight: 500;">0 hammadde</span>
                            </div>
                            <div id="materialDropdownItems"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        ƒ∞rsaliye Tarihi *
                        <input type="checkbox" id="autoFillDeliveryDate" style="margin-left: 10px; width: 18px; height: 18px; vertical-align: middle; cursor: pointer;">
                        <span style="font-size: 0.85em; color: #666; margin-left: 5px;">Excel'den otomatik doldur</span>
                    </label>
                    <input type="date" id="deliveryDate">
                </div>
                
                <div class="form-group">
                    <label>
                        ƒ∞rsaliye No
                        <input type="checkbox" id="autoFillDeliveryNo" style="margin-left: 10px; width: 18px; height: 18px; vertical-align: middle; cursor: pointer;">
                        <span style="font-size: 0.85em; color: #666; margin-left: 5px;">Excel'den otomatik doldur</span>
                    </label>
                    <input type="text" id="deliveryNo" placeholder="√ñrn: IRS-2024-001">
                </div>
                
                <div class="form-group">
                    <label>Parti/Lot No</label>
                    <input type="text" id="lotNumber" placeholder="√ñrn: 2I02618">
                </div>
                
                <div class="form-group">
                    <label>Lokasyon</label>
                    <select id="location">
                        <option value="">Lokasyon se√ßin...</option>
                        <option value="√áerkezk√∂y">√áerkezk√∂y</option>
                        <option value="Velik√∂y">Velik√∂y</option>
                        <option value="Ankara">Ankara</option>
                        <option value="Bursa">Bursa</option>
                        <option value="Adana">Adana</option>
                        <option value="Eski≈üehir">Eski≈üehir</option>
                        <option value="Ultech1">Ultech1</option>
                        <option value="Ultech2">Ultech2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Sertifika Dosyasƒ± *</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="openDocumentScanner()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            üì∑ Belge Tara
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            üìÅ Dosya Y√ºkle
                        </button>
                    </div>
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(event)">
                    <input type="file" id="fileInput" accept="image/*,.pdf,.xlsx,.xls,.docx,.doc" style="display:none" onchange="handleFile(this.files[0])">
                    <div class="upload-area" id="uploadArea" style="display: none;">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Fotoƒüraf veya PDF s√ºr√ºkleyin<br>veya tƒ±klayarak se√ßin</div>
                        <input type="file" id="fileInput" accept="image/*,.pdf,.xlsx,.xls,.docx,.doc" style="display:none">
                    </div>
                    <div id="filePreview"></div>
                </div>
                
                <div class="form-group">
                    <label>Not (Opsiyonel)</label>
                    <input type="text" id="notes" placeholder="Ek bilgi...">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveCOA()" style="flex: 1;">üíæ Kaydet</button>
                    <button class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">‚ùå ƒ∞ptal</button>
                </div>
                
                <!-- Settings -->
                <div class="settings-section">
                    <h3>‚öôÔ∏è Google Sheets Baƒülantƒ±sƒ±</h3>
                    <input type="text" id="googleScriptUrl" value="https://script.google.com/macros/s/AKfycbyraboE_BkQd7N2QJkSVW826ZPiZP6X40MZ4qqeyA6QRj3jjsXx9ojQOzvzb3_D_MXc/exec" placeholder="Google Apps Script URL" style="width:100%; margin-bottom:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="connectGoogleSheets()">üîó Baƒülan</button>
                </div>
                
                <!-- TDS Management -->
                <div class="settings-section" style="margin-top: 20px;">
                    <h3>üìä TDS Y√∂netimi</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Hammadde √∂zellikleri ve toleranslarƒ± tanƒ±mlayƒ±n</p>
                    <button class="btn btn-primary btn-sm" onclick="openTDSModal()" style="width: 100%;">‚öôÔ∏è TDS Ayarlarƒ±nƒ± A√ß</button>
                </div>
                
                <!-- COA Analysis -->
                <div class="settings-section" style="margin-top: 20px;">
                    <h3>üìà COA Analiz</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Hammadde √∂zelliklerini grafiklerle analiz edin</p>
                    <button class="btn btn-primary btn-sm" onclick="openCOAAnalysisModal()" style="width: 100%; background: #ff9800; border-color: #ff9800;">üìä Analiz A√ß</button>
                </div>
            </div>
            
            <!-- List -->
            <div class="card">
                <h2>üìã Sertifika Listesi</h2>
                
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="üîç Ara (tedarik√ßi, hammadde, lot no...)">
                    
                    <div class="multiselect-container">
                        <div class="multiselect-header" id="supplierMultiselectHeader">
                            <span id="supplierMultiselectText">T√ºm Tedarik√ßiler</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="multiselect-dropdown" id="supplierMultiselectDropdown">
                            <div class="multiselect-search">
                                <input type="text" id="supplierSearchInput" placeholder="Tedarik√ßi ara...">
                            </div>
                            <div id="supplierMultiselectOptions"></div>
                            <div class="multiselect-actions">
                                <button class="select-all" onclick="selectAllSuppliers()">‚úì T√ºm√ºn√º Se√ß</button>
                                <button class="clear-all" onclick="clearAllSuppliers()">‚úó Temizle</button>
                            </div>
                        </div>
                    </div>
                    
                    <input type="month" id="filterMonth">
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">
                        üóë Se√ßilenleri Sil (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="exportToExcel()" style="margin-left: auto;">
                        üìä Excel ƒ∞ndir
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="coaTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()" style="cursor: pointer;"></th>
                                <th>Dosya</th>
                                <th>Tedarik√ßi</th>
                                <th>Hammadde Kodu</th>
                                <th>ƒ∞rsaliye Tarihi</th>
                                <th>ƒ∞rsaliye No</th>
                                <th>Lot No</th>
                                <th>Boyut</th>
                                <th>Lokasyon</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="coaTableBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptyState">
                        <div class="icon">üì≠</div>
                        <p>Hen√ºz sertifika eklenmemi≈ü</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="">
        </div>
    </div>
    
    <!-- TDS Management Modal -->
    <div class="modal" id="tdsModal">
        <span class="modal-close" onclick="closeTDSModal()">&times;</span>
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">üìä TDS (Technical Data Sheet) Y√∂netimi</h2>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666; width: 120px;">OCR Motor:</label>
                        <select id="ocrEngineSelect" onchange="localStorage.setItem('ocr_engine', this.value); showToast('‚úÖ OCR motoru kaydedildi', 'success');" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85em; flex: 1;">
                            <option value="ocrspace">OCR.space (Hƒ±zlƒ±)</option>
                            <option value="azure">Microsoft Azure (Taranmƒ±≈ü i√ßin g√º√ßl√º)</option>
                            <option value="both">ƒ∞kisini de dene (En iyi sonucu se√ß)</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666; width: 120px;">üîë OCR.space Key:</label>
                        <input 
                            type="text" 
                            id="ocrApiKeyInput" 
                            placeholder="K82811583888957" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.85em; width: 200px;"
                            onchange="localStorage.setItem('ocrspace_api_key', this.value); showToast('‚úÖ API key kaydedildi', 'success');">
                        <a href="https://ocr.space/ocrapi" target="_blank" style="font-size: 0.85em; color: #2196F3; text-decoration: none;">üîó Key Al</a>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666; width: 120px;">üîë Azure Key:</label>
                        <input 
                            type="text" 
                            id="azureApiKeyInput" 
                            placeholder="Azure Computer Vision Key" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.85em; width: 200px;"
                            onchange="localStorage.setItem('azure_api_key', this.value); showToast('‚úÖ Azure key kaydedildi', 'success');">
                        <input 
                            type="text" 
                            id="azureEndpointInput" 
                            placeholder="https://YOUR-RESOURCE.cognitiveservices.azure.com/" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.85em; flex: 1;"
                            onchange="localStorage.setItem('azure_endpoint', this.value); showToast('‚úÖ Azure endpoint kaydedildi', 'success');">
                        <a href="https://portal.azure.com/" target="_blank" style="font-size: 0.85em; color: #2196F3; text-decoration: none;">üîó Key Al</a>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hammadde Kodu Se√ß:</label>
                <select id="tdsMaterialSelect" onchange="loadTDSForMaterial()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <option value="">Hammadde se√ßin...</option>
                </select>
            </div>
            
            <div id="tdsContent" style="display: none;">
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <strong>üìù Not:</strong> √ñzellikleri tanƒ±mlayƒ±n. COA y√ºklenirken bu deƒüerlerle kar≈üƒ±la≈ütƒ±rƒ±lacak.
                </div>
                
                <button class="btn btn-sm btn-primary" onclick="addTDSProperty()" style="margin-bottom: 15px;">
                    ‚ûï Yeni √ñzellik Ekle
                </button>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; min-width: 150px;">√ñzellik Adƒ±</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; min-width: 80px;">Birim</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; min-width: 100px;">Standart</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 80px;">Operat√∂r</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px;">Standart Deƒüer</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px;">Alt Tolerans (-)</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px;">√úst Tolerans (+)</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #e8f5e9;">Alt Limit</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #e8f5e9;">√úst Limit</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #e3f2fd;">COA Deƒüeri</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #fff3e0;">Durum</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 70px;">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="tdsPropertiesTable">
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeTDSModal()">ƒ∞ptal</button>
                    <button class="btn btn-primary" onclick="saveTDS()">üíæ TDS Kaydet</button>
                </div>
            </div>
            
            <div id="tdsEmptyState" style="text-align: center; padding: 40px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                <p>Hammadde se√ßin ve √∂zellikleri tanƒ±mlayƒ±n</p>
            </div>
        </div>
    </div>
    
    <!-- COA Analysis Modal -->
    <div class="modal" id="coaAnalysisModal">
        <span class="modal-close" onclick="closeCOAAnalysisModal()">&times;</span>
        <div class="modal-content" style="max-width: 95%; width: 1800px; max-height: 95vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìà COA Analiz - √ñzellik Trendleri</h2>
                <button id="exportAnalysisPdfBtn" onclick="exportAnalysisToPDF()" style="display: none; padding: 10px 20px; background: linear-gradient(135deg, #9c27b0, #673ab7); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;">
                    üìÑ PDF Dƒ±≈üa Aktar
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tedarik√ßi Se√ß:</label>
                    <select id="analysisSupplierSelect" onchange="loadAnalysisMaterials()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Tedarik√ßi se√ßin...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hammadde Kodu Se√ß:</label>
                    <select id="analysisMaterialSelect" onchange="loadAnalysisProperties()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">√ñnce tedarik√ßi se√ßin...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Lokasyon:</label>
                    <select id="analysisLocationSelect" onchange="loadAnalysisChart()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">T√ºm√º</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Ba≈ülangƒ±√ß Tarihi:</label>
                    <input type="date" id="analysisStartDate" onchange="loadAnalysisChart()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Biti≈ü Tarihi:</label>
                    <input type="date" id="analysisEndDate" onchange="loadAnalysisChart()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">√ñzellikler Se√ß (√áoklu):</label>
                <div id="analysisPropertyContainer" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; max-height: 200px; overflow-y: auto; background: white;">
                    <div style="color: #999; text-align: center; padding: 20px;">√ñnce hammadde se√ßin...</div>
                </div>
                <button onclick="loadAnalysisChart()" style="margin-top: 10px; padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üìä Grafik Olu≈ütur</button>
            </div>
            
            <div id="analysisChartsContainer" style="display: none;">
                <!-- Her √∂zellik i√ßin ayrƒ± grafik buraya eklenecek -->
            </div>
            
            <div id="analysisEmptyState" style="text-align: center; padding: 60px; color: #999;">
                <div style="font-size: 64px; margin-bottom: 15px;">üìä</div>
                <p style="font-size: 1.1em;">Tedarik√ßi, hammadde ve √∂zellik se√ßin</p>
                <p style="font-size: 0.9em; margin-top: 10px;">COA kayƒ±tlarƒ±nƒ±zdaki √∂zelliklerin zaman i√ßindeki deƒüi≈üimini g√∂r√ºn</p>
            </div>
            

        </div>
    </div>
    
    <!-- Camera Modal -->
    <div class="modal" id="cameraModal">
        <span class="modal-close" onclick="closeCameraModal()">&times;</span>
        <div class="modal-content" style="background: #000; padding: 20px; max-width: 800px;">
            <h3 style="color: white; text-align: center; margin-bottom: 15px;">üì∑ Fotoƒüraf √áek</h3>
            <video id="cameraStream" autoplay playsinline style="width: 100%; max-height: 500px; border-radius: 8px; background: #000;"></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                <button class="btn btn-primary" onclick="capturePhoto()" style="padding: 12px 30px; font-size: 1.1em;">
                    üì∏ Fotoƒüraf √áek
                </button>
                <button class="btn btn-secondary" onclick="closeCameraModal()" style="padding: 12px 30px; font-size: 1.1em;">
                    ‚ùå ƒ∞ptal
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ==================== Global Variables ====================
        let coaData = [];
        let suppliers = [];
        let materials = []; // Hammadde listesi
        let tdsData = {}; // TDS verileri: { materialCode: { properties: [] } }
        let selectedSuppliers = new Set(); // Se√ßili tedarik√ßiler
        let googleScriptUrl = 'https://script.google.com/macros/s/AKfycbyraboE_BkQd7N2QJkSVW826ZPiZP6X40MZ4qqeyA6QRj3jjsXx9ojQOzvzb3_D_MXc/exec';
        let selectedFile = null;
        let selectedFileData = null;
        let editMode = false;
        let editingId = null;
        let selectedItems = new Set();
        let currentTDSMaterial = null; // ≈ûu an d√ºzenlenen TDS hammaddesi
        let lastOCRMaterialCode = null; // Son OCR yapƒ±lan hammadde (modal a√ßƒ±lƒ±≈üta deƒüerleri korumak i√ßin)
        
        // Dosya tipine g√∂re ikon olu≈ütur
        function getFileIcon(fileName, fileType, itemId) {
            // Dosya uzantƒ±sƒ±nƒ± al
            const extension = fileName ? fileName.split('.').pop().toLowerCase() : '';
            
            // Dosya tipine g√∂re ikon ve class belirle
            let iconText = '';
            let iconClass = '';
            
            // PDF
            if (extension === 'pdf' || fileType?.includes('pdf')) {
                iconText = 'PDF';
                iconClass = 'pdf';
            }
            // Word
            else if (extension === 'doc' || extension === 'docx' || fileType?.includes('word')) {
                iconText = 'DOC';
                iconClass = extension || 'doc';
            }
            // Excel
            else if (extension === 'xls' || extension === 'xlsx' || fileType?.includes('excel') || fileType?.includes('spreadsheet')) {
                iconText = 'XLS';
                iconClass = extension || 'xls';
            }
            // Resim formatlarƒ±
            else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension) || fileType?.startsWith('image/')) {
                iconText = extension.toUpperCase();
                iconClass = extension;
            }
            // Text
            else if (extension === 'txt' || fileType?.includes('text')) {
                iconText = 'TXT';
                iconClass = 'txt';
            }
            // Bilinmeyen
            else {
                iconText = extension ? extension.toUpperCase().substring(0, 3) : 'FILE';
                iconClass = 'unknown';
            }
            
            return '<div class="file-icon ' + iconClass + '" onclick="viewFile(\'' + itemId + '\')">' + iconText + '</div>';
        }
        
        // URL parametresinden tedarik√ßileri otomatik y√ºkle (Mobil link i√ßin)
        // NOT: URL √ßok uzun olduƒüu i√ßin (20,000+ karakter) WhatsApp ve √ßoƒüu tarayƒ±cƒ± keser
        // En iyi √ß√∂z√ºm: JSON dosyasƒ± indirip manuel y√ºklemek
        function loadSuppliersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const suppliersData = urlParams.get('suppliers');
            
            console.log('üîç URL kontrol ediliyor...');
            console.log('URL parametresi var mƒ±?', suppliersData ? 'Evet' : 'Hayƒ±r');
            
            if (suppliersData) {
                try {
                    console.log('üîì Base64 decode ediliyor... (uzunluk: ' + suppliersData.length + ')');
                    
                    // URL √ßok uzunsa uyarƒ± ver
                    if (suppliersData.length < 1000) {
                        showToast('‚ö†Ô∏è URL verisi eksik g√∂r√ºn√ºyor. JSON dosyasƒ± y√ºkleyin.', 'warning', 5000);
                        return false;
                    }
                    
                    // Base64 decode ve parse et
                    const suppliers = JSON.parse(decodeURIComponent(atob(suppliersData)));
                    
                    console.log('‚úÖ Parse ba≈üarƒ±lƒ±. Tedarik√ßi sayƒ±sƒ±:', suppliers.length);
                    
                    if (Array.isArray(suppliers) && suppliers.length > 0) {
                        // localStorage'a kaydet
                        localStorage.setItem('supplierListForCOA', JSON.stringify(suppliers));
                        console.log('üíæ localStorage\'a kaydedildi');
                        
                        // Dropdown'ƒ± g√ºncelle
                        const select = document.getElementById('supplier');
                        // Mevcut se√ßenekleri temizle (placeholder hari√ß)
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        // Tedarik√ßileri alfabetik sƒ±rala ve ekle
                        suppliers.sort().forEach(supplier => {
                            const option = document.createElement('option');
                            option.value = supplier;
                            option.textContent = supplier;
                            select.appendChild(option);
                        });
                        console.log('üîΩ Dropdown g√ºncellendi');
                        
                        // Ba≈üarƒ± mesajƒ± g√∂ster
                        showToast('‚úÖ ' + suppliers.length + ' tedarik√ßi mobilde y√ºklendi!', 'success', 4000);
                        
                        // URL'i temizle (parametreyi kaldƒ±r)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        console.log('üì± Mobil linkten tedarik√ßi y√ºklendi:', suppliers.length);
                        return true; // Ba≈üarƒ±lƒ±
                    }
                } catch (error) {
                    console.error('‚ùå URL\'den tedarik√ßi y√ºkleme hatasƒ±:', error);
                    showToast('‚ö†Ô∏è URL √ßok uzun veya bozuk. JSON dosyasƒ± y√ºkleyin.', 'warning', 5000);
                }
            }
            return false; // URL'de tedarik√ßi verisi yok
        }
        
        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Eski ana sayfadan gelen tedarik√ßi listesini temizle (artƒ±k kullanmƒ±yoruz)
            localStorage.removeItem('supplierListForCOA');
            
            // √ñnce URL'den tedarik√ßileri y√ºkle (mobil link varsa)
            loadSuppliersFromURL();
            
            // Google Sheets'ten TDS verilerini y√ºkle (arka planda)
            loadTDSFromGoogleSheets().catch(err => {
                console.log('‚ö†Ô∏è Google Sheets TDS y√ºkleme ba≈üarƒ±sƒ±z, localStorage kullanƒ±lƒ±yor');
            });
            
            // Set default date to today
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            
            // Init upload area
            initUploadArea();
            
            // Init filters
            document.getElementById('searchInput').addEventListener('input', filterList);
            document.getElementById('filterMonth').addEventListener('change', filterList);
            
            // Init multiselect
            initSupplierMultiselect();
            
            // Load suppliers from localStorage (from index.html)
            loadSuppliers();
            
            // TEST: Kaydet butonunu test et
            console.log('üîß TEST: Kaydet butonu kontrol√º');
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                console.log('‚úÖ Kaydet butonu bulundu');
                console.log('üîç onclick:', saveBtn.onclick);
            } else {
                console.error('‚ùå Kaydet butonu bulunamadƒ±!');
            }
            
            // Load TDS data
            loadTDSData();
            
            // Load materials from localStorage
            loadMaterials();
            
            // ƒ∞rsaliye checkbox'larƒ±na event listener ekle
            const autoFillDateCheckbox = document.getElementById('autoFillDeliveryDate');
            const autoFillNoCheckbox = document.getElementById('autoFillDeliveryNo');
            
            if (autoFillDateCheckbox) {
                autoFillDateCheckbox.addEventListener('change', function() {
                    const materialInput = document.getElementById('materialCode');
                    const value = materialInput?.value?.trim();
                    if (value) {
                        handleMaterialBlur();
                    }
                });
            }
            
            if (autoFillNoCheckbox) {
                autoFillNoCheckbox.addEventListener('change', function() {
                    const materialInput = document.getElementById('materialCode');
                    const value = materialInput?.value?.trim();
                    if (value) {
                        handleMaterialBlur();
                    }
                });
            }
            
            // ƒ∞lk y√ºklemede localStorage'dan y√ºkle (hƒ±zlƒ± ba≈ülangƒ±√ß)
            loadFromLocalStorage();
            if (coaData.length > 0) {
                renderTable();
                updateStats();
                
                // Kullanƒ±cƒ±ya bilgi g√∂ster
                const recordCount = coaData.length;
                showToast(`‚úÖ ${recordCount} kayƒ±t y√ºklendi`, 'success', 3000);
            }
            
            // Tedarik√ßi ve hammadde sayƒ±larƒ±nƒ± g√∂ster
            if (suppliers.length > 0) {
                console.log(`üìã ${suppliers.length} tedarik√ßi y√ºklendi`);
            }
            if (materials.length > 0) {
                console.log(`üîß ${materials.length} hammadde kodu y√ºklendi`);
            }
            
            // Doƒüru URL - her zaman bu URL kullanƒ±lsƒ±n
            const correctUrl = 'https://script.google.com/macros/s/AKfycbyraboE_BkQd7N2QJkSVW826ZPiZP6X40MZ4qqeyA6QRj3jjsXx9ojQOzvzb3_D_MXc/exec';
            
            // Her zaman default URL'yi kullan ve kaydet
            localStorage.setItem('google_script_url', correctUrl);
            document.getElementById('googleScriptUrl').value = correctUrl;
            googleScriptUrl = correctUrl;
            
            // Baƒülantƒ±yƒ± ba≈ülat
            setTimeout(function() {
                connectGoogleSheets(true);
            }, 100);
        });
        
        // ==================== JSONP Helper ====================
        function jsonp(url, retries = 3) {
            return new Promise((resolve, reject) => {
                let currentRetry = 0;
                
                function tryConnect() {
                    const callbackName = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    const script = document.createElement('script');
                    
                    const timeout = setTimeout(() => {
                        cleanup();
                        if (currentRetry < retries) {
                            currentRetry++;
                            console.log(`Baƒülantƒ± denemesi ${currentRetry}/${retries}...`);
                            tryConnect();
                        } else {
                            reject(new Error('Timeout - T√ºm denemeler ba≈üarƒ±sƒ±z'));
                        }
                    }, 30000); // 30 saniye timeout (b√ºy√ºk dosyalar i√ßin)
                    
                    function cleanup() {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        if (script.parentNode) script.parentNode.removeChild(script);
                    }
                    
                    window[callbackName] = (data) => {
                        cleanup();
                        resolve(data);
                    };
                    
                    script.onerror = () => {
                        cleanup();
                        if (currentRetry < retries) {
                            currentRetry++;
                            console.log(`Baƒülantƒ± hatasƒ±, deneme ${currentRetry}/${retries}...`);
                            setTimeout(tryConnect, 1000);
                        } else {
                            reject(new Error('Baƒülantƒ± kurulamadƒ±'));
                        }
                    };
                    
                    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                    document.body.appendChild(script);
                }
                
                tryConnect();
            });
        }
        
        // ==================== Google Sheets ====================
        async function connectGoogleSheets(silent = false) {
            const url = document.getElementById('googleScriptUrl').value.trim();
            if (!url) {
                if (!silent) showToast('‚ùå URL gerekli!', 'error');
                return;
            }
            
            // URL formatƒ±nƒ± kontrol et
            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                if (!silent) showToast('‚ùå Ge√ßersiz Google Apps Script URL!', 'error');
                return;
            }
            
            document.getElementById('statusText').textContent = 'Baƒülanƒ±yor...';
            
            try {
                const data = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 10000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', url, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'test');
                    
                    xhr.send(formData.toString());
                });
                
                if (data.success) {
                    googleScriptUrl = url;
                    localStorage.setItem('google_script_url', url);
                    document.getElementById('statusDot').classList.add('connected');
                    document.getElementById('statusText').textContent = 'Google Sheets Baƒülƒ± ‚úì';
                    await loadFromGoogleSheets();
                    if (!silent) showToast('‚úÖ Baƒülantƒ± ba≈üarƒ±lƒ±! ' + (data.message || ''), 'success');
                    
                    // Bekleyen kayƒ±tlarƒ± senkronize et
                    setTimeout(() => syncPendingRecords(), 2000);
                } else {
                    throw new Error(data.error || 'Bilinmeyen hata');
                }
            } catch (error) {
                console.error('Google Sheets baƒülantƒ± hatasƒ±:', error);
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Baƒülantƒ± ba≈üarƒ±sƒ±z';
                loadFromLocalStorage();
                if (!silent) {
                    showToast('‚ùå Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                    showToast('üí° ƒ∞pucu: Apps Script\'i yeniden deploy edin', 'info');
                }
            }
            updateUI();
        }
        
        async function loadFromGoogleSheets() {
            try {
                console.log('Google Sheets\'ten veri y√ºkleniyor...');
                showToast('üîÑ Veriler y√ºkleniyor...', 'info');
                
                const data = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 30000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'getAllCOA');
                    formData.append('includeFileData', 'true');
                    
                    xhr.send(formData.toString());
                });
                
                if (data && data.success) {
                    // Kayƒ±tlarƒ± al (fileData dahil)
                    coaData = (data.data || []).map(record => {
                        return {
                            id: record.id,
                            supplier: record.supplier,
                            materialCode: record.materialCode,
                            deliveryDate: record.deliveryDate,
                            deliveryNo: record.deliveryNo || '',
                            lotNumber: record.lotNumber || '',
                            location: record.location || '',
                            notes: record.notes || '',
                            fileName: record.fileName || '',
                            fileType: record.fileType || '',
                            fileUrl: record.fileUrl || '',
                            // fileData bo≈üsa (PDF/√ßok sayfalƒ±), Drive\'dan y√ºklenecek
                            fileData: record.fileData || '',
                            fileSize: record.fileSize || 0,
                            driveFileId: record.driveFileId || '',
                            createdAt: record.createdAt || '',
                            updatedAt: record.updatedAt || '',
                            // Eƒüer fileData bo≈ü ama driveFileId varsa, direkt Drive linkini kullan
                            useDirectDriveLink: (!record.fileData && record.driveFileId) ? true : false
                        };
                    });
                    
                    console.log('Y√ºklenen kayƒ±t sayƒ±sƒ±:', coaData.length);
                    const withFiles = coaData.filter(r => r.fileData).length;
                    const withFileSize = coaData.filter(r => r.fileSize).length;
                    console.log('Dosyalƒ± kayƒ±t sayƒ±sƒ±:', withFiles);
                    console.log('fileSize bilgisi olan:', withFileSize);
                    
                    // ƒ∞lk kayƒ±ttan √∂rnek g√∂ster
                    if (coaData.length > 0) {
                        console.log('ƒ∞lk kayƒ±t √∂rneƒüi:', {
                            id: coaData[0].id,
                            fileName: coaData[0].fileName,
                            fileSize: coaData[0].fileSize,
                            hasFileData: !!coaData[0].fileData
                        });
                    }
                    
                    // Yerel yedek olarak da kaydet
                    saveToLocalStorage();
                    
                    // Tabloyu g√ºncelle
                    renderTable();
                    updateUI();
                    
                    // Sheets'ten istatistikleri de y√ºkle
                    loadStatsFromGoogleSheets();
                    
                    showToast('‚úÖ ' + coaData.length + ' kayƒ±t y√ºklendi (' + withFiles + ' dosyalƒ±)', 'success');
                } else {
                    console.error('Veri y√ºkleme hatasƒ±:', data?.error);
                    loadFromLocalStorage();
                    renderTable();
                    showToast('‚ö†Ô∏è Sheets hatasƒ±, yerel veriler kullanƒ±lƒ±yor', 'warning');
                }
            } catch (error) {
                console.error('Y√ºkleme hatasƒ±:', error);
                // Yerel veriden y√ºkle
                loadFromLocalStorage();
                renderTable();
                showToast('‚ö†Ô∏è √áevrimdƒ±≈üƒ± mod - yerel veriler kullanƒ±lƒ±yor', 'warning');
            }
        }
        
        async function loadStatsFromGoogleSheets() {
            if (!googleScriptUrl) return;
            
            try {
                const url = googleScriptUrl + '?action=getStats';
                const result = await jsonp(url);
                
                if (result && result.success && result.data) {
                    const stats = result.data;
                    
                    // Toplam dosya boyutunu g√ºncelle
                    if (stats.totalFileSizeMB !== undefined) {
                        document.getElementById('statTotalSize').textContent = stats.totalFileSizeMB + ' MB';
                        console.log('üìä Sheets\'ten dosya boyutu g√ºncellendi:', stats.totalFileSizeMB, 'MB');
                    }
                }
            } catch (error) {
                console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error);
            }
        }
        
        async function saveToGoogleSheets(record) {
            try {
                showToast('üì§ Kaydediliyor...', 'info');
                
                let fileUrl = '';
                let driveFileId = '';
                let fileSize = 0;
                
                // Dosya varsa Drive'a y√ºkle
                if (record.fileData && record.fileName) {
                    console.log('Dosya Drive\'a y√ºkleniyor...', record.fileName);
                    showToast('‚òÅÔ∏è Google Drive\'a y√ºkleniyor...', 'info');
                    
                    try {
                        // ORJƒ∞NAL DOSYAYI DRIVE'A Y√úKLE (SIKI≈ûTIRILMAMI≈û)
                        // PDF, Excel, Word ve √ßok sayfalƒ± i√ßin sƒ±kƒ±≈ütƒ±rma YOK
                        const fileName = record.fileName || '';
                        const fileType = record.fileType || '';
                        
                        const isPDF = fileType.includes('pdf') || fileName.toLowerCase().endsWith('.pdf');
                        const isExcel = fileType.includes('spreadsheet') || fileName.toLowerCase().endsWith('.xlsx') || fileName.toLowerCase().endsWith('.xls');
                        const isWord = fileType.includes('wordprocessing') || fileName.toLowerCase().endsWith('.docx') || fileName.toLowerCase().endsWith('.doc');
                        const isOfficeDoc = isPDF || isExcel || isWord;
                        const isLargeFile = record.fileData.length > 3000000; // 3MB+
                        const isMobile = /Mobile|Android|iPhone/i.test(navigator.userAgent);
                        
                        console.log('üìÑ Dosya tipi kontrol√º:', { fileName, fileType, isPDF, isExcel, isWord, isOfficeDoc });
                        
                        let uploadData;
                        if (isOfficeDoc || isLargeFile) {
                            // ORJƒ∞NAL dosyayƒ± y√ºkle, sƒ±kƒ±≈ütƒ±rma YOK - DOƒûRUDAN KULLAN
                            uploadData = record.fileData;
                            let fileTypeLabel = isPDF ? 'PDF' : (isExcel ? 'Excel' : (isWord ? 'Word' : 'B√ºy√ºk dosya'));
                            console.log('‚úÖ ' + fileTypeLabel + ' - ORJƒ∞NAL dosya y√ºkleniyor (sƒ±kƒ±≈ütƒ±rmasƒ±z):', Math.round(uploadData.length / 1024), 'KB');
                        } else {
                            // Sadece k√º√ß√ºk resimler i√ßin hafif sƒ±kƒ±≈ütƒ±rma
                            const targetSize = isMobile ? 350 : 400;
                            uploadData = await compressForSheets(record.fileData, targetSize);
                            console.log('üì∑ K√º√ß√ºk resim - Hafif sƒ±kƒ±≈ütƒ±rma:', Math.round(uploadData.length / 1024), 'KB');
                        }
                        
                        const compressedData = uploadData;
                        
                        // fetch() ile POST (XMLHttpRequest CORS problemi yaratƒ±yor)
                        let lastError = null;
                        let uploadResult = null;
                        
                        for (let attempt = 1; attempt <= 3; attempt++) {
                            try {
                                if (attempt > 1) {
                                    console.log('‚ö†Ô∏è Tekrar deneniyor... Deneme:', attempt + '/3');
                                    showToast('‚ö†Ô∏è Tekrar deneniyor (' + attempt + '/3)...', 'warning', 2000);
                                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 saniye bekle
                                }
                                
                                // fetch() ile POST - CORS uyumlu
                                const formData = new URLSearchParams();
                                formData.append('action', 'uploadFile');
                                formData.append('fileData', compressedData);
                                formData.append('fileName', record.fileName);
                                // PDF i√ßin doƒüru mimeType g√∂nder
                                const mimeType = isPDF ? 'application/pdf' : (record.fileType || 'image/jpeg');
                                formData.append('mimeType', mimeType);
                                
                                console.log('G√∂nderilen veri:', {
                                    fileName: record.fileName,
                                    mimeType: mimeType,
                                    boyut: Math.round(formData.toString().length / 1024) + ' KB',
                                    isPDF: isPDF
                                });
                                
                                const controller = new AbortController();
                                const timeout = isMobile ? 240000 : 120000;
                                const timeoutId = setTimeout(() => controller.abort(), timeout);
                                
                                const response = await fetch(googleScriptUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                    body: formData.toString(),
                                    signal: controller.signal
                                });
                                
                                clearTimeout(timeoutId);
                                
                                if (!response.ok) {
                                    throw new Error('HTTP ' + response.status);
                                }
                                
                                uploadResult = await response.json();
                                
                                // Ba≈üarƒ±lƒ±ysa loop'tan √ßƒ±k
                                break;
                            } catch (attemptError) {
                                lastError = attemptError;
                                console.error('Deneme ' + attempt + ' ba≈üarƒ±sƒ±z:', attemptError.message);
                                if (attempt === 3) {
                                    throw new Error('3 deneme ba≈üarƒ±sƒ±z: ' + attemptError.message);
                                }
                            }
                        }
                        
                        console.log('Drive upload sonucu:', uploadResult);
                        console.log('Upload response keys:', Object.keys(uploadResult || {}));
                        
                        if (uploadResult && uploadResult.success) {
                            fileUrl = uploadResult.viewUrl || uploadResult.directUrl;
                            driveFileId = uploadResult.fileId;
                            fileSize = uploadResult.fileSize || 0;
                            console.log('‚úÖ Drive y√ºkleme ba≈üarƒ±lƒ±:', { fileUrl, driveFileId, fileSize });
                            showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
                        } else {
                            console.error('Drive upload hatasƒ±:', uploadResult?.error);
                            console.error('Tam response:', JSON.stringify(uploadResult));
                            alert('Drive Hatasƒ±: ' + (uploadResult?.error || 'Bilinmeyen hata'));
                            throw new Error(uploadResult?.error || 'Dosya Drive\'a y√ºklenemedi');
                        }
                    } catch (uploadErr) {
                        console.error('Drive upload exception:', uploadErr);
                        console.error('Error stack:', uploadErr.stack);
                        alert('Upload Exception: ' + uploadErr.message);
                        throw new Error('Drive y√ºkleme hatasƒ±: ' + uploadErr.message);
                    }
                }
                
                // Kayƒ±t verisini hazƒ±rla
                // PDF ve √ßok sayfalƒ± dok√ºmanlar i√ßin fileData kaydedilmez (sadece Drive link)
                const isPDF = record.fileType && record.fileType.includes('pdf');
                const isMultiPage = record.fileData && record.fileData.length > 3000000; // 3MB+
                const shouldSkipFileData = isPDF || isMultiPage;
                
                if (shouldSkipFileData) {
                    console.log('üìÑ PDF/√áok sayfalƒ± dok√ºman - fileData Sheets\'e kaydedilmiyor (sadece Drive link)');
                }
                
                const saveData = {
                    id: record.id,
                    supplier: record.supplier,
                    materialCode: record.materialCode,
                    deliveryDate: record.deliveryDate,
                    deliveryNo: record.deliveryNo || '',
                    lotNumber: record.lotNumber || '',
                    location: record.location || '',
                    notes: record.notes || '',
                    fileName: record.fileName || '',
                    fileType: record.fileType || '',
                    fileUrl: fileUrl,
                    driveFileId: driveFileId,
                    fileData: shouldSkipFileData ? '' : '', // PDF ve √ßok sayfalƒ±lar i√ßin bo≈ü
                    fileSize: fileSize || record.fileSize || 0, // Dosya boyutu
                    createdAt: record.createdAt || new Date().toISOString()
                };
                
                // XMLHttpRequest POST ile metadata g√∂nder
                console.log('Metadata kaydediliyor...');
                
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 30000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'addCOA');
                    formData.append('data', JSON.stringify(saveData));
                    
                    xhr.send(formData.toString());
                });
                
                console.log('Kayƒ±t sonucu:', result);
                console.log('Kayƒ±t response keys:', Object.keys(result || {}));
                
                if (!result || !result.success) {
                    console.error('Kayƒ±t hatasƒ± detay:', JSON.stringify(result));
                    alert('Kayƒ±t Hatasƒ±: ' + (result?.error || 'Bilinmeyen hata'));
                    throw new Error(result?.error || 'Kayƒ±t olu≈üturulamadƒ±');
                }
                
                console.log('‚úÖ Kayƒ±t ba≈üarƒ±lƒ±, ID:', result.id);
                showToast('‚úÖ Kayƒ±t ve dosya ba≈üarƒ±yla Drive\'a eklendi!', 'success');
                return true;
                
            } catch (error) {
                console.error('Kaydetme hatasƒ±:', error);
                console.error('Error stack:', error.stack);
                alert('Kaydetme Hatasƒ±: ' + error.message);
                showToast('‚ùå Hata: ' + error.message, 'error');
                return false;
            }
        }
        
        // Dosyayƒ± Google Drive'a chunk'lar halinde y√ºkle
        async function uploadToDriveChunked(fileData, fileName, mimeType) {
            const CHUNK_SIZE = 5000; // 5KB per chunk (URL-safe ve hƒ±zlƒ±)
            const chunks = [];
            
            // Dosyayƒ± par√ßala
            for (let i = 0; i < fileData.length; i += CHUNK_SIZE) {
                chunks.push(fileData.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('Drive upload - Toplam chunk sayƒ±sƒ±:', chunks.length, '(her biri ~5KB)');
            
            try {
                // 1. Upload ba≈ülat
                const initUrl = googleScriptUrl + 
                    '?action=initUpload' +
                    '&fileName=' + encodeURIComponent(fileName) +
                    '&mimeType=' + encodeURIComponent(mimeType || 'image/jpeg') +
                    '&totalChunks=' + chunks.length +
                    '&totalSize=' + fileData.length;
                
                console.log('Init URL uzunluƒüu:', initUrl.length);
                const initResult = await jsonp(initUrl);
                
                if (!initResult || !initResult.success) {
                    console.error('Upload init hatasƒ±:', initResult?.error);
                    return { success: false, error: initResult?.error || 'Init hatasƒ±' };
                }
                
                const uploadId = initResult.uploadId;
                console.log('Upload ba≈ülatƒ±ldƒ±, ID:', uploadId);
                
                // 2. Chunk'larƒ± g√∂nder
                for (let i = 0; i < chunks.length; i++) {
                    // Her 10 chunk'ta bir progress g√∂ster
                    if (i % 10 === 0 || i === chunks.length - 1) {
                        showToast('üì§ Drive\'a y√ºkleniyor... ' + Math.round((i + 1) / chunks.length * 100) + '%', 'info');
                    }
                    
                    const chunkUrl = googleScriptUrl + 
                        '?action=uploadChunk' +
                        '&uploadId=' + encodeURIComponent(uploadId) +
                        '&chunkIndex=' + i +
                        '&totalChunks=' + chunks.length +
                        '&chunk=' + encodeURIComponent(chunks[i]);
                    
                    // Retry mekanizmasƒ±
                    let chunkResult = null;
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    while (retryCount < maxRetries) {
                        try {
                            chunkResult = await jsonp(chunkUrl);
                            if (chunkResult && chunkResult.success) {
                                break; // Ba≈üarƒ±lƒ±
                            }
                        } catch (e) {
                            console.log('Chunk', i, 'retry', retryCount + 1);
                        }
                        retryCount++;
                        await new Promise(r => setTimeout(r, 500)); // 500ms bekle
                    }
                    
                    if (!chunkResult || !chunkResult.success) {
                        const errorMsg = chunkResult?.error || 'Bilinmeyen hata';
                        console.error('Chunk hatasƒ±:', i, errorMsg);
                        return { success: false, error: 'Chunk ' + i + ' hatasƒ±: ' + errorMsg };
                    }
                    
                    // Her 20 chunk'ta bir log
                    if (i % 20 === 0 || i === chunks.length - 1) {
                        console.log('Chunk g√∂nderildi:', i + 1, '/', chunks.length);
                    }
                    
                    // Rate limiting - daha kƒ±sa bekle (200ms)
                    if (i < chunks.length - 1) {
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
                
                // 3. Upload tamamla
                showToast('üì§ Dosya birle≈ütiriliyor...', 'info');
                const finalizeUrl = googleScriptUrl + 
                    '?action=finalizeUpload' +
                    '&uploadId=' + encodeURIComponent(uploadId) +
                    '&fileName=' + encodeURIComponent(fileName) +
                    '&mimeType=' + encodeURIComponent(mimeType || 'image/jpeg');
                
                const finalResult = await jsonp(finalizeUrl);
                
                if (!finalResult || !finalResult.success) {
                    console.error('Finalize hatasƒ±:', finalResult?.error);
                    return { success: false, error: finalResult?.error || 'Finalize hatasƒ±' };
                }
                
                console.log('Upload tamamlandƒ±:', finalResult);
                return finalResult;
                
            } catch (error) {
                console.error('Chunk upload hatasƒ±:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Eski fonksiyon - Sheets'e chunk (artƒ±k kullanƒ±lmƒ±yor)
        async function uploadFileInChunks(recordId, fileData) {
            const CHUNK_SIZE = 1500;
            const chunks = [];
            
            // Dosyayƒ± par√ßala
            for (let i = 0; i < fileData.length; i += CHUNK_SIZE) {
                chunks.push(fileData.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('Toplam chunk sayƒ±sƒ±:', chunks.length);
            
            // Her chunk'ƒ± sƒ±rayla g√∂nder
            for (let i = 0; i < chunks.length; i++) {
                showToast('üì§ Dosya y√ºkleniyor... ' + Math.round((i + 1) / chunks.length * 100) + '%', 'info');
                
                // URL'yi manuel olu≈ütur (encodeURIComponent ile)
                const chunkUrl = googleScriptUrl + 
                    '?action=appendFileData' +
                    '&id=' + encodeURIComponent(recordId) +
                    '&chunk=' + encodeURIComponent(chunks[i]) +
                    '&chunkIndex=' + i +
                    '&totalChunks=' + chunks.length;
                
                console.log('Chunk URL uzunluƒüu:', chunkUrl.length);
                
                try {
                    const chunkResult = await jsonp(chunkUrl);
                    
                    if (!chunkResult || !chunkResult.success) {
                        console.error('Chunk hatasƒ±:', i, chunkResult?.error);
                        return false;
                    }
                    
                    console.log('Chunk g√∂nderildi:', i + 1, '/', chunks.length);
                } catch (e) {
                    console.error('Chunk g√∂nderme hatasƒ±:', i, e);
                    return false;
                }
                
                // Rate limiting - √ßok hƒ±zlƒ± istek atmayalƒ±m
                if (i < chunks.length - 1) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }
            
            return true;
        }
        
        // Dosya y√ºkleme fonksiyonu - birden fazla servis dener
        async function uploadToImgBB(base64Data) {
            // Base64 verisi hazƒ±rla
            let imageData = base64Data;
            if (imageData.includes(',')) {
                imageData = imageData.split(',')[1];
            }
            
            // 1. √ñnce imgbb.com dene (√ºcretsiz API)
            try {
                console.log('imgBB\'ye y√ºkleniyor...');
                const formData = new FormData();
                formData.append('image', imageData);
                
                // √úcretsiz API key (sƒ±nƒ±rlƒ± kullanƒ±m)
                const response = await fetch('https://api.imgbb.com/1/upload?key=00d1452b3d2add1cfe46862457505d88', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.url) {
                    console.log('imgBB ba≈üarƒ±lƒ±:', result.data.url);
                    return {
                        success: true,
                        url: result.data.url
                    };
                }
            } catch (e) {
                console.warn('imgBB hatasƒ±:', e.message);
            }
            
            // 2. freeimage.host dene
            try {
                console.log('freeimage.host\'a y√ºkleniyor...');
                const formData = new FormData();
                formData.append('source', imageData);
                formData.append('type', 'base64');
                formData.append('action', 'upload');
                
                const response = await fetch('https://freeimage.host/api/1/upload?key=6d207e02198a847aa98d0a2a901485a5', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status_code === 200 && result.image && result.image.url) {
                    console.log('freeimage ba≈üarƒ±lƒ±:', result.image.url);
                    return {
                        success: true,
                        url: result.image.url
                    };
                }
            } catch (e) {
                console.warn('freeimage hatasƒ±:', e.message);
            }
            
            // T√ºm servisler ba≈üarƒ±sƒ±z - dosya yerel olarak saklanacak
            console.log('T√ºm upload servisleri ba≈üarƒ±sƒ±z, dosya yerel olarak saklanacak');
            return { success: false, error: 'Upload servisleri kullanƒ±lamƒ±yor' };
        }
        
        // Data URL'i daha fazla sƒ±kƒ±≈ütƒ±r
        async function compressDataUrl(dataUrl, maxSizeKB) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = maxSizeKB * 1024;
                    
                    // Boyutu k√º√ß√ºlt
                    const maxDim = 800;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.5;
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse daha da k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale = Math.sqrt(maxSize / result.length) * 0.8;
                        canvas.width = Math.round(width * scale);
                        canvas.height = Math.round(height * scale);
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.4);
                    }
                    
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }
        
        // Sheets i√ßin √∂zel sƒ±kƒ±≈ütƒ±rma - SADECE RESƒ∞MLER ƒ∞√áƒ∞N
        async function compressForSheets(dataUrl, maxSizeKB = 250) {
            return new Promise((resolve, reject) => {
                // PDF, Excel, Word gibi dosyalar i√ßin direkt geri d√∂n (sƒ±kƒ±≈ütƒ±rma YOK)
                if (dataUrl.includes('application/pdf') || 
                    dataUrl.includes('spreadsheet') || 
                    dataUrl.includes('wordprocessing') ||
                    dataUrl.includes('application/vnd.ms-excel') ||
                    dataUrl.includes('application/vnd.openxmlformats')) {
                    console.warn('Office/PDF dosyasƒ± - sƒ±kƒ±≈ütƒ±rma atlanƒ±yor, orjinal d√∂nd√ºr√ºl√ºyor');
                    resolve(dataUrl);
                    return;
                }
                
                // Resim deƒüilse direkt geri d√∂n
                if (!dataUrl.startsWith('data:image/')) {
                    console.warn('Resim deƒüil - sƒ±kƒ±≈ütƒ±rma atlanƒ±yor');
                    resolve(dataUrl);
                    return;
                }
                
                const img = new Image();
                img.onerror = () => {
                    console.error('Resim y√ºklenemedi');
                    resolve(dataUrl); // Hata durumunda orjinali d√∂n
                };
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = maxSizeKB * 1024;
                    
                    // Hedef boyuta g√∂re ba≈ülangƒ±√ß boyutu ayarla - Y√úKSEK KALƒ∞TE
                    let maxDim;
                    if (maxSizeKB >= 2000) {
                        maxDim = 4500; // 2MB+ i√ßin MUHTEkMEL √ß√∂z√ºn√ºrl√ºk (PDF/√ßok sayfalƒ± - minimal sƒ±kƒ±≈ütƒ±rma)
                    } else if (maxSizeKB >= 1000) {
                        maxDim = 3500; // 1MB+ i√ßin √ßok y√ºksek √ß√∂z√ºn√ºrl√ºk
                    } else if (maxSizeKB >= 500) {
                        maxDim = 3000; // 500KB+ i√ßin y√ºksek √ß√∂z√ºn√ºrl√ºk
                    } else if (maxSizeKB >= 300) {
                        maxDim = 2400; // 300KB+ i√ßin iyi √ß√∂z√ºn√ºrl√ºk
                    } else if (maxSizeKB >= 200) {
                        maxDim = 2000;
                    } else if (maxSizeKB >= 100) {
                        maxDim = 1600;
                    } else if (maxSizeKB >= 50) {
                        maxDim = 1000;
                    } else {
                        maxDim = 600;
                    }
                    
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kalite ba≈ülangƒ±cƒ± - Y√úKSEK KALƒ∞TE
                    let quality;
                    if (maxSizeKB >= 2000) {
                        quality = 0.98; // 2MB+ i√ßin MUHTEkMEL kalite (neredeyse sƒ±kƒ±≈ütƒ±rmasƒ±z)
                    } else if (maxSizeKB >= 1000) {
                        quality = 0.96; // 1MB+ i√ßin √ßok y√ºksek kalite
                    } else if (maxSizeKB >= 500) {
                        quality = 0.95; // 500KB+ i√ßin y√ºksek kalite
                    } else if (maxSizeKB >= 300) {
                        quality = 0.92; // 300KB i√ßin iyi kalite
                    } else if (maxSizeKB >= 200) {
                        quality = 0.90;
                    } else if (maxSizeKB >= 100) {
                        quality = 0.85;
                    } else if (maxSizeKB >= 50) {
                        quality = 0.7;
                    } else {
                        quality = 0.6;
                    }
                    
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    // Boyut b√ºy√ºkse kaliteyi d√º≈ü√ºr
                    while (result.length > maxSize && quality > 0.3) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        maxDim = Math.round(maxDim * 0.7);
                        if (img.width > img.height) {
                            canvas.width = maxDim;
                            canvas.height = Math.round(maxDim * img.height / img.width);
                        } else {
                            canvas.height = maxDim;
                            canvas.width = Math.round(maxDim * img.width / img.height);
                        }
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.5);
                    }
                    
                    // Hala b√ºy√ºkse daha da k√º√ß√ºlt
                    if (result.length > maxSize) {
                        maxDim = Math.round(maxDim * 0.7);
                        if (img.width > img.height) {
                            canvas.width = maxDim;
                            canvas.height = Math.round(maxDim * img.height / img.width);
                        } else {
                            canvas.height = maxDim;
                            canvas.width = Math.round(maxDim * img.width / img.height);
                        }
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.4);
                    }
                    
                    console.log('Sƒ±kƒ±≈ütƒ±rma sonucu:', Math.round(result.length/1024), 'KB, boyut:', canvas.width, 'x', canvas.height, 'kalite:', quality);
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }
        
        // Bekleyen kayƒ±tlarƒ± senkronize et
        async function syncPendingRecords() {
            if (!googleScriptUrl) return;
            
            const pending = coaData.filter(r => r.pending);
            if (pending.length === 0) return;
            
            console.log('Bekleyen kayƒ±t sayƒ±sƒ±:', pending.length);
            showToast('üîÑ ' + pending.length + ' bekleyen kayƒ±t senkronize ediliyor...', 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const record of pending) {
                try {
                    // Dosyayƒ± sƒ±kƒ±≈ütƒ±r ve Sheets'e kaydet
                    if (record.fileData) {
                        try {
                            record.fileData = await compressForSheets(record.fileData, 40);
                        } catch (e) {
                            console.warn('Sƒ±kƒ±≈ütƒ±rma hatasƒ±, orijinal kullanƒ±lƒ±yor');
                        }
                    }
                    
                    delete record.pending;
                    
                    // Sheets'e kaydet (fileData dahil)
                    const params = new URLSearchParams();
                    params.append('action', 'addCOA');
                    params.append('data', JSON.stringify(record));
                    
                    const result = await jsonp(googleScriptUrl + '?' + params.toString());
                    if (result && result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        record.pending = true; // Ba≈üarƒ±sƒ±zsa tekrar beklemede yap
                    }
                    
                    console.log('Senkronize edildi:', record.id);
                } catch (e) {
                    failCount++;
                    record.pending = true;
                    console.error('Senkronizasyon hatasƒ±:', record.id, e);
                }
            }
            
            saveToLocalStorage();
            
            if (failCount === 0) {
                showToast('‚úÖ ' + successCount + ' kayƒ±t senkronize edildi', 'success');
            } else {
                showToast('‚ö†Ô∏è ' + successCount + ' ba≈üarƒ±lƒ±, ' + failCount + ' ba≈üarƒ±sƒ±z', 'warning');
            }
        }
        
        async function deleteFromGoogleSheets(id) {
            try {
                const params = new URLSearchParams();
                params.append('action', 'deleteCOA');
                params.append('id', id);
                
                const result = await jsonp(googleScriptUrl + '?' + params.toString());
                return result.success;
            } catch (error) {
                return false;
            }
        }
        
        async function updateToGoogleSheets(record) {
            try {
                // fileData √ßok b√ºy√ºkse g√∂nderme (zaten Drive'da var)
                const recordToSend = { ...record };
                
                // Eƒüer fileData √ßok b√ºy√ºkse (>50KB) g√∂nderme
                if (recordToSend.fileData && recordToSend.fileData.length > 50000) {
                    console.log('fileData √ßok b√ºy√ºk, g√∂nderilmiyor (Drive\'da mevcut)');
                    delete recordToSend.fileData;
                }
                
                // JSONP ile POST g√∂nder (fetch yerine)
                const updateUrl = googleScriptUrl + 
                    '?action=updateCOA' +
                    '&id=' + encodeURIComponent(record.id) +
                    '&data=' + encodeURIComponent(JSON.stringify(recordToSend));
                
                console.log('Update URL olu≈üturuldu, uzunluk:', updateUrl.length);
                
                const result = await jsonp(updateUrl);
                
                if (result && result.success) {
                    console.log('Google Sheets g√ºncellendi:', record.id);
                    return true;
                } else {
                    console.error('G√ºncelleme hatasƒ±:', result?.error);
                    showToast('‚ö†Ô∏è Google Sheets g√ºncellenemedi: ' + (result?.error || 'Bilinmeyen hata'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('updateToGoogleSheets hatasƒ±:', error);
                showToast('‚ö†Ô∏è Google Sheets baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                return false;
            }
        }
        
        // ==================== Local Storage ====================
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('coa_arsiv_data');
            if (saved) {
                coaData = JSON.parse(saved);
                console.log('localStorage\'dan y√ºklendi:', coaData.length, 'kayƒ±t');
            }
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('coa_arsiv_data', JSON.stringify(coaData));
        }
        
        // ==================== Suppliers ====================
        function loadSuppliers() {
            let supplierNames = [];
            
            // Artƒ±k index.html'den tedarik√ßi listesi almƒ±yoruz
            // Sadece COA ar≈üiv kendi Excel dosyasƒ±ndan tedarik√ßi listesi alacak
            
            // COA Excel'inden kaydedilmi≈ü tedarik√ßileri y√ºkle
            const coaSuppliers = localStorage.getItem('coaSupplierList');
            if (coaSuppliers) {
                try {
                    supplierNames = JSON.parse(coaSuppliers);
                    console.log('Tedarik√ßi listesi y√ºklendi (coaSupplierList):', supplierNames.length);
                } catch(e) {
                    console.error('coaSupplierList parse hatasƒ±:', e);
                }
            }
            
            // supplierStatusMap'ten al (COA ar≈üiv kendi Excel'inden)
            if (supplierNames.length === 0) {
                const supplierMap = localStorage.getItem('supplierStatusMap');
                if (supplierMap) {
                    try {
                        const map = JSON.parse(supplierMap);
                        supplierNames = Object.keys(map);
                        console.log('Tedarik√ßi listesi y√ºklendi (supplierStatusMap):', supplierNames.length);
                    } catch(e) {
                        console.error('supplierStatusMap parse hatasƒ±:', e);
                    }
                }
            }
            
            // supplierInfoMap'ten al
            if (supplierNames.length === 0) {
                const supplierInfo = localStorage.getItem('supplierInfoMap');
                if (supplierInfo) {
                    try {
                        const info = JSON.parse(supplierInfo);
                        supplierNames = Object.keys(info);
                        console.log('Tedarik√ßi listesi y√ºklendi (supplierInfoMap):', supplierNames.length);
                    } catch(e) {}
                }
            }
            
            // Mevcut COA verilerinden de ekle
            coaData.forEach(c => {
                if (c.supplier && !supplierNames.includes(c.supplier)) {
                    supplierNames.push(c.supplier);
                }
            });
            
            suppliers = supplierNames.sort();
            updateSupplierDropdowns();
            
            if (suppliers.length === 0) {
                console.warn('‚ö†Ô∏è Tedarik√ßi listesi bo≈ü! L√ºtfen COA Ar≈üiv sayfasƒ±nda Excel y√ºkleyin.');
            }
        }
        
        // JSON dosyasƒ±ndan tedarik√ßi listesi y√ºkle
        function loadSupplierJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìÇ JSON dosyasƒ± okunuyor...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Validasyon
                    if (!jsonData.suppliers || !Array.isArray(jsonData.suppliers)) {
                        showToast('‚ùå Ge√ßersiz JSON formatƒ±!', 'error');
                        return;
                    }
                    
                    // Tedarik√ßi listesini g√ºncelle
                    const supplierNames = jsonData.suppliers.filter(n => n && n.trim());
                    
                    if (supplierNames.length === 0) {
                        showToast('‚ö†Ô∏è JSON dosyasƒ±nda tedarik√ßi bulunamadƒ±!', 'warning');
                        return;
                    }
                    
                    // localStorage'a kaydet
                    localStorage.setItem('supplierListForCOA', JSON.stringify(supplierNames));
                    
                    // Listeyi yenile
                    suppliers = supplierNames.sort();
                    updateSupplierDropdowns();
                    
                    showToast(`‚úÖ ${supplierNames.length} tedarik√ßi y√ºklendi!`, 'success');
                    console.log('‚úÖ JSON\'dan y√ºklendi:', supplierNames.length, 'tedarik√ßi');
                    console.log('ƒ∞lk 5:', supplierNames.slice(0, 5));
                    
                } catch (error) {
                    console.error('JSON okuma hatasƒ±:', error);
                    showToast('‚ùå JSON okuma hatasƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Input'u temizle (aynƒ± dosyayƒ± tekrar y√ºkleyebilmek i√ßin)
            event.target.value = '';
        }
        
        // Excel dosyasƒ±ndan tedarik√ßi ve hammadde listesi y√ºkle
        function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìä Excel dosyasƒ± okunuyor...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: false });
                    
                    // ƒ∞lk sayfayƒ± al
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: true });
                    
                    if (jsonData.length < 2) {
                        showToast('‚ö†Ô∏è Excel dosyasƒ± bo≈ü!', 'warning');
                        return;
                    }
                    
                    // Header satƒ±rƒ±nƒ± bul
                    const headers = jsonData[0];
                    
                    // S√ºtun indekslerini bul
                    let cariAdiIndex = -1;
                    let stokKoduIndex = -1;
                    let stokAdiIndex = -1;
                    let irsaliyeTarihiIndex = -1;
                    let irsaliyeSeriIndex = -1;
                    let irsaliyeNoIndex = -1;
                    
                    headers.forEach((header, index) => {
                        const h = String(header).trim().toLowerCase();
                        if (h === 'cari adƒ±' || h === 'cari adi' || h === 'cariadƒ±' || h === 'cariadi') {
                            cariAdiIndex = index;
                        }
                        if (h === 'stok kodu' || h === 'stokkodu') {
                            stokKoduIndex = index;
                        }
                        if (h === 'stok adƒ±' || h === 'stok adi' || h === 'stokadƒ±' || h === 'stokadi') {
                            stokAdiIndex = index;
                        }
                        if (h === 'irsaliye tarihi' || h === 'irsaliye kayit tarihi' || h === 'irsaliye kayƒ±t tarihi') {
                            irsaliyeTarihiIndex = index;
                        }
                        if (h === 'irsaliye evrak seri' || h === 'irsaliye evrak seri no') {
                            irsaliyeSeriIndex = index;
                        }
                        if (h === 'irsaliye evrak no' || h === 'irsaliye evrak sira no' || h === 'irsaliye evrak sƒ±ra no' || h === 'irsaliye evrak sira' || h === 'irsaliye evrak sƒ±ra') {
                            irsaliyeNoIndex = index;
                        }
                    });
                    
                    // Kontrol
                    if (cariAdiIndex === -1 || stokKoduIndex === -1 || stokAdiIndex === -1) {
                        showToast('‚ùå Excel\'de gerekli s√ºtunlar bulunamadƒ±! (Cari Adƒ±, Stok Kodu, Stok Adƒ±)', 'error');
                        console.error('Bulunan headers:', headers);
                        console.error('Cari Adƒ± indeks:', cariAdiIndex, 'Stok Kodu indeks:', stokKoduIndex, 'Stok Adƒ± indeks:', stokAdiIndex);
                        return;
                    }
                    
                    // ƒ∞rsaliye s√ºtun kontrol√º
                    console.log('üìã ƒ∞rsaliye s√ºtunlarƒ±:', 'Tarih:', irsaliyeTarihiIndex, 'Seri:', irsaliyeSeriIndex, 'Sƒ±ra:', irsaliyeNoIndex);
                    
                    // Verileri topla
                    const supplierSet = new Set();
                    const materialMap = new Map(); // stokKodu -> {code, name, suppliers: [], deliveries: []}
                    
                    // Checkbox durumlarƒ±nƒ± kontrol et
                    const autoFillDate = document.getElementById('autoFillDeliveryDate')?.checked || false;
                    const autoFillNo = document.getElementById('autoFillDeliveryNo')?.checked || false;
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // Tedarik√ßi adƒ± (tekrarlayanlarƒ± alma)
                        const cariAdi = row[cariAdiIndex];
                        if (cariAdi && String(cariAdi).trim()) {
                            supplierSet.add(String(cariAdi).trim());
                        }
                        
                        // Hammadde kodu ve adƒ± (tekrarlayan kodlarƒ± alma)
                        const stokKodu = row[stokKoduIndex];
                        const stokAdi = row[stokAdiIndex];
                        if (stokKodu && String(stokKodu).trim() && stokAdi && String(stokAdi).trim()) {
                            const code = String(stokKodu).trim();
                            const name = String(stokAdi).trim();
                            const supplier = cariAdi ? String(cariAdi).trim() : null;
                            
                            // Hammadde-tedarik√ßi ili≈ükisini kaydet
                            if (!materialMap.has(code)) {
                                materialMap.set(code, { code, name, suppliers: [], deliveries: [] });
                            }
                            
                            // Bu tedarik√ßiyi hammaddenin supplier listesine ekle
                            if (supplier && !materialMap.get(code).suppliers.includes(supplier)) {
                                materialMap.get(code).suppliers.push(supplier);
                            }
                            
                            // ƒ∞rsaliye bilgilerini ekle (eƒüer checkbox i≈üaretliyse ve veriler varsa)
                            if ((autoFillDate || autoFillNo) && (irsaliyeTarihiIndex >= 0 || irsaliyeSeriIndex >= 0 || irsaliyeNoIndex >= 0)) {
                                const delivery = {};
                                
                                if (autoFillDate && irsaliyeTarihiIndex >= 0 && row[irsaliyeTarihiIndex]) {
                                    // Tarihi gg.aa.yyyy formatƒ±na √ßevir
                                    const excelDate = row[irsaliyeTarihiIndex];
                                    const formattedDate = formatExcelDateToDisplay(excelDate);
                                    delivery.date = formattedDate;
                                    
                                    // Debug i√ßin ilk 5 tarihi konsola yazdƒ±r
                                    if (materialMap.size <= 5) {
                                        console.log('üîç Excel deƒüeri:', excelDate, 'Tipi:', typeof excelDate, '‚Üí Formatlanmƒ±≈ü:', formattedDate);
                                    }
                                }
                                
                                if (autoFillNo) {
                                    // Seri ve numarayƒ± ayrƒ± ayrƒ± kaydet
                                    if (irsaliyeSeriIndex >= 0 && row[irsaliyeSeriIndex]) {
                                        delivery.serie = String(row[irsaliyeSeriIndex]).trim();
                                    }
                                    if (irsaliyeNoIndex >= 0 && row[irsaliyeNoIndex]) {
                                        delivery.no = String(row[irsaliyeNoIndex]).trim();
                                    }
                                    
                                    // Debug: ƒ∞lk 3 irsaliye i√ßin konsola yazdƒ±r
                                    if (materialMap.size <= 3) {
                                        console.log('üìù ƒ∞rsaliye:', 'Seri:', delivery.serie, 'No:', delivery.no, '‚Üí Format:', delivery.serie && delivery.no ? `${delivery.serie} | ${delivery.no}` : (delivery.no || delivery.serie));
                                    }
                                }
                                
                                // ƒ∞rsaliye bilgisi varsa ekle
                                if (delivery.date || delivery.serie || delivery.no) {
                                    delivery.supplier = supplier;
                                    materialMap.get(code).deliveries.push(delivery);
                                }
                            }
                        }
                    }
                    
                    // Array'lere √ßevir
                    const supplierArray = Array.from(supplierSet).sort();
                    const materialArray = Array.from(materialMap.values());
                    
                    if (supplierArray.length === 0 && materialArray.length === 0) {
                        showToast('‚ö†Ô∏è Excel dosyasƒ±nda veri bulunamadƒ±!', 'warning');
                        return;
                    }
                    
                    // LocalStorage'a kaydet
                    if (supplierArray.length > 0) {
                        // Hem supplierListForCOA hem de coaSupplierList'e kaydet (uyumluluk i√ßin)
                        localStorage.setItem('coaSupplierList', JSON.stringify(supplierArray));
                        suppliers = supplierArray;
                        updateSupplierDropdowns();
                    }
                    
                    if (materialArray.length > 0) {
                        materials = materialArray;
                        saveMaterials();
                        updateMaterialDropdown();
                    }
                    
                    showToast(`‚úÖ Excel y√ºklendi! ${supplierArray.length} tedarik√ßi, ${materialArray.length} hammadde`, 'success');
                    console.log('‚úÖ Excel\'den y√ºklendi:');
                    console.log('- Tedarik√ßiler:', supplierArray.length);
                    console.log('- Hammaddeler:', materialArray.length);
                    console.log('ƒ∞lk 3 tedarik√ßi:', supplierArray.slice(0, 3));
                    console.log('ƒ∞lk 3 hammadde:', materialArray.slice(0, 3));
                    
                    // ƒ∞rsaliye bilgilerini g√∂ster
                    if (autoFillDate || autoFillNo) {
                        const totalDeliveries = materialArray.reduce((sum, mat) => sum + (mat.deliveries?.length || 0), 0);
                        console.log('- ƒ∞rsaliye kayƒ±tlarƒ±:', totalDeliveries);
                        if (materialArray.length > 0 && materialArray[0].deliveries?.length > 0) {
                            console.log('ƒ∞lk hammaddenin irsaliyeleri:', materialArray[0].deliveries.slice(0, 3));
                        }
                    }
                    
                } catch (error) {
                    console.error('Excel okuma hatasƒ±:', error);
                    showToast('‚ùå Excel okuma hatasƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // Input'u temizle (aynƒ± dosyayƒ± tekrar y√ºkleyebilmek i√ßin)
            event.target.value = '';
        }
        
        function updateSupplierDropdowns() {
            const datalist = document.getElementById('supplierList');
            const filter = document.getElementById('filterSupplier');
            const countSpan = document.getElementById('supplierCount');
            
            // Clear existing options
            datalist.innerHTML = '';
            filter.innerHTML = '<option value="">T√ºm Tedarik√ßiler</option>';
            
            suppliers.forEach(s => {
                datalist.innerHTML += `<option value="${s}">`;
                filter.innerHTML += `<option value="${s}">${s}</option>`;
            });
            
            // Tedarik√ßi sayƒ±sƒ±nƒ± g√∂ster
            if (countSpan) {
                if (suppliers.length === 0) {
                    countSpan.innerHTML = '(‚ö†Ô∏è Liste bo≈ü - Ana sayfada Excel y√ºkleyin)';
                    countSpan.style.color = '#f44336';
                } else {
                    countSpan.innerHTML = `(üìä ${suppliers.length} tedarik√ßi)`;
                    countSpan.style.color = '#4CAF50';
                }
            }
        }
        
        // ==================== Multiselect ====================
        function initSupplierMultiselect() {
            const header = document.getElementById('supplierMultiselectHeader');
            const dropdown = document.getElementById('supplierMultiselectDropdown');
            const searchInput = document.getElementById('supplierSearchInput');
            
            // Toggle dropdown
            header.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multiselect-container')) {
                    dropdown.classList.remove('active');
                }
            });
            
            // Search suppliers
            searchInput.addEventListener('input', (e) => {
                e.stopPropagation();
                const search = e.target.value.toLowerCase();
                const options = document.querySelectorAll('.multiselect-option');
                options.forEach(opt => {
                    const text = opt.textContent.toLowerCase();
                    opt.style.display = text.includes(search) ? 'flex' : 'none';
                });
            });
        }
        
        function updateSupplierDropdowns() {
            const optionsContainer = document.getElementById('supplierMultiselectOptions');
            const countSpan = document.getElementById('supplierCount');
            
            // Clear existing options
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                suppliers.forEach(s => {
                    // Multiselect i√ßin
                    const isChecked = selectedSuppliers.has(s);
                    const option = document.createElement('div');
                    option.className = 'multiselect-option';
                    option.innerHTML = `
                        <input type="checkbox" id="supplier_${s.replace(/\s+/g, '_')}" 
                               ${isChecked ? 'checked' : ''} 
                               onchange="toggleSupplier('${s.replace(/'/g, "\\'")}')">
                        <label for="supplier_${s.replace(/\s+/g, '_')}">${s}</label>
                    `;
                    optionsContainer.appendChild(option);
                });
                
                updateSupplierMultiselectText();
            }
            
            // Form input dropdown'ƒ± g√ºncelle
            updateSupplierInputDropdown();
            
            // Tedarik√ßi sayƒ±sƒ±nƒ± g√∂ster
            if (countSpan) {
                if (suppliers.length === 0) {
                    countSpan.innerHTML = '(‚ö†Ô∏è Liste bo≈ü - Ana sayfada Excel y√ºkleyin)';
                    countSpan.style.color = '#f44336';
                } else {
                    countSpan.innerHTML = `(üìä ${suppliers.length} tedarik√ßi)`;
                    countSpan.style.color = '#4CAF50';
                }
            }
        }
        
        // Tedarik√ßi input dropdown'ƒ±nƒ± g√ºncelle
        function updateSupplierInputDropdown(filterText = '') {
            const itemsContainer = document.getElementById('supplierDropdownItems');
            const countElement = document.getElementById('supplierDropdownCount');
            
            if (!itemsContainer) return;
            
            const searchTerm = filterText.toLowerCase();
            const filtered = suppliers.filter(s => s.toLowerCase().includes(searchTerm));
            
            itemsContainer.innerHTML = '';
            
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<div class="supplier-dropdown-empty">üîç Tedarik√ßi bulunamadƒ±</div>';
                countElement.textContent = '0 tedarik√ßi';
                return;
            }
            
            countElement.textContent = `${filtered.length} tedarik√ßi`;
            
            filtered.forEach(s => {
                const item = document.createElement('div');
                item.className = 'supplier-dropdown-item';
                item.textContent = s;
                item.onclick = () => selectSupplier(s);
                itemsContainer.appendChild(item);
            });
        }
        
        // Dropdown'ƒ± g√∂ster
        function showSupplierDropdown() {
            const dropdown = document.getElementById('supplierDropdownList');
            const input = document.getElementById('supplierInput');
            
            if (suppliers.length === 0) {
                return;
            }
            
            updateSupplierInputDropdown(input.value);
            dropdown.classList.add('active');
        }
        
        // Dropdown'da arama yap
        function filterSupplierDropdown() {
            const input = document.getElementById('supplierInput');
            updateSupplierInputDropdown(input.value);
            showSupplierDropdown();
        }
        
        // Tedarik√ßi se√ß
        function selectSupplier(supplierName) {
            const input = document.getElementById('supplierInput');
            const dropdown = document.getElementById('supplierDropdownList');
            
            input.value = supplierName;
            dropdown.classList.remove('active');
            
            // Tedarik√ßi se√ßilince hammaddeleri filtrele
            filterMaterialsBySupplier();
        }
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('supplierDropdownList');
            const input = document.getElementById('supplierInput');
            
            if (dropdown && input && !e.target.closest('.supplier-input-container')) {
                dropdown.classList.remove('active');
            }
        });
        
        function toggleSupplier(supplier) {
            if (selectedSuppliers.has(supplier)) {
                selectedSuppliers.delete(supplier);
            } else {
                selectedSuppliers.add(supplier);
            }
            updateSupplierMultiselectText();
            filterList();
        }
        
        function selectAllSuppliers() {
            selectedSuppliers.clear();
            suppliers.forEach(s => selectedSuppliers.add(s));
            updateSupplierDropdowns();
            filterList();
        }
        
        function clearAllSuppliers() {
            selectedSuppliers.clear();
            updateSupplierDropdowns();
            filterList();
        }
        
        function updateSupplierMultiselectText() {
            const text = document.getElementById('supplierMultiselectText');
            if (selectedSuppliers.size === 0) {
                text.textContent = 'T√ºm Tedarik√ßiler';
            } else if (selectedSuppliers.size === 1) {
                text.textContent = Array.from(selectedSuppliers)[0];
            } else {
                text.textContent = `${selectedSuppliers.size} tedarik√ßi se√ßili`;
            }
        }
        
        // ==================== Material Functions ====================
        function loadMaterials() {
            const savedMaterials = localStorage.getItem('coa_materials');
            if (savedMaterials) {
                try {
                    materials = JSON.parse(savedMaterials);
                    console.log('‚úÖ Hammadde listesi y√ºklendi:', materials.length);
                    updateMaterialDropdown();
                } catch (e) {
                    console.error('Hammadde parse hatasƒ±:', e);
                    materials = [];
                }
            }
        }
        
        function saveMaterials(materialsToSave) {
            const dataToSave = materialsToSave || materials;
            localStorage.setItem('coa_materials', JSON.stringify(dataToSave));
            console.log('üíæ Hammadde listesi kaydedildi:', dataToSave.length, 'adet');
        }
        
        function loadMaterialJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Veri formatƒ±nƒ± kontrol et
                    if (Array.isArray(jsonData)) {
                        materials = jsonData;
                    } else if (jsonData.materials && Array.isArray(jsonData.materials)) {
                        materials = jsonData.materials;
                    } else {
                        throw new Error('Ge√ßersiz JSON formatƒ±. Array veya {materials: []} bekleniyor.');
                    }
                    
                    // Verileri localStorage'a kaydet
                    saveMaterials();
                    updateMaterialDropdown();
                    
                    showToast(`‚úÖ ${materials.length} hammadde y√ºklendi!`, 'success');
                    console.log('üì¶ Hammadde JSON y√ºklendi:', materials);
                } catch (error) {
                    console.error('JSON parse hatasƒ±:', error);
                    showToast('‚ùå JSON dosyasƒ± okunamadƒ±: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Input'u sƒ±fƒ±rla (aynƒ± dosya tekrar se√ßilebilsin)
            event.target.value = '';
        }
        
        function showMaterialDropdown() {
            const dropdown = document.getElementById('materialDropdown');
            dropdown.style.display = 'block';
            updateMaterialDropdown();
        }
        
        function hideMaterialDropdown() {
            setTimeout(() => {
                const dropdown = document.getElementById('materialDropdown');
                dropdown.style.display = 'none';
            }, 200);
        }
        
        function filterMaterials(searchText) {
            showMaterialDropdown();
            updateMaterialDropdown(searchText);
        }
        
        function updateMaterialDropdown(filterText = '') {
            const itemsContainer = document.getElementById('materialDropdownItems');
            const countElement = document.getElementById('materialDropdownCount');
            const materialCountLabel = document.getElementById('materialCount');
            
            if (!itemsContainer) return;
            
            // Se√ßili tedarik√ßiyi al
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            
            const searchTerm = filterText.toLowerCase();
            const filtered = materials.filter(m => {
                const code = (m.code || m.stockCode || m.stokKodu || '').toLowerCase();
                const name = (m.name || m.stockName || m.stokAdƒ± || '').toLowerCase();
                const matchesSearch = code.includes(searchTerm) || name.includes(searchTerm);
                
                // Tedarik√ßi se√ßiliyse, sadece o tedarik√ßinin hammaddelerini g√∂ster
                if (selectedSupplier && m.suppliers && m.suppliers.length > 0) {
                    const matchesSupplier = m.suppliers.includes(selectedSupplier);
                    return matchesSearch && matchesSupplier;
                }
                
                return matchesSearch;
            });
            
            itemsContainer.innerHTML = '';
            
            if (filtered.length === 0 && materials.length === 0) {
                itemsContainer.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">üì¶ Hammadde listesi bo≈ü<br><small>Excel y√ºkleyin (Tedarik√ßi bilgilerinin √ºst√ºnde)</small></div>';
                countElement.textContent = '0 hammadde';
                materialCountLabel.innerHTML = '<span style="color: #f44336;">(‚ö†Ô∏è Excel y√ºkleyin)</span>';
                return;
            }
            
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #666;">üîç Sonu√ß bulunamadƒ±</div>';
                countElement.textContent = '0 sonu√ß';
                return;
            }
            
            countElement.textContent = `${filtered.length} hammadde`;
            materialCountLabel.innerHTML = `<span style="color: #4CAF50;">(üì¶ ${materials.length} hammadde)</span>`;
            
            filtered.forEach(material => {
                const code = material.code || material.stockCode || material.stokKodu || '';
                const name = material.name || material.stockName || material.stokAdƒ± || '';
                const displayText = `${code} | ${name}`;
                
                const item = document.createElement('div');
                item.className = 'supplier-dropdown-item';
                item.textContent = displayText;
                item.onclick = () => selectMaterial(code, name);
                itemsContainer.appendChild(item);
            });
        }
        
        function selectMaterial(code, name) {
            const input = document.getElementById('materialCode');
            input.value = `${code} | ${name}`;
            hideMaterialDropdown();
            
            // ƒ∞rsaliye checkbox'larƒ± i≈üaretliyse, o hammaddenin irsaliyelerini g√∂ster
            updateDeliveryOptions(code);
        }
        
        function updateDeliveryOptions(materialCode) {
            const autoFillDateCheckbox = document.getElementById('autoFillDeliveryDate');
            const autoFillNoCheckbox = document.getElementById('autoFillDeliveryNo');
            
            console.log('üîç updateDeliveryOptions √ßaƒürƒ±ldƒ±:', 'Hammadde:', materialCode, 'Tarih CB:', autoFillDateCheckbox?.checked, 'No CB:', autoFillNoCheckbox?.checked);
            
            // Checkbox'lar i≈üaretli deƒüilse devam etme
            if (!autoFillDateCheckbox?.checked && !autoFillNoCheckbox?.checked) {
                console.log('‚ö†Ô∏è Checkbox\'lar i≈üaretli deƒüil, dropdown olu≈üturulmayacak');
                return;
            }
            
            // Hammaddeyi bul
            const material = materials.find(m => 
                (m.code || m.stockCode || m.stokKodu) === materialCode
            );
            
            console.log('üîç Bulunan hammadde:', material ? material.code : 'YOK', 'Deliveries:', material?.deliveries?.length || 0);
            
            if (!material || !material.deliveries || material.deliveries.length === 0) {
                showToast('‚ÑπÔ∏è Bu hammadde i√ßin irsaliye bilgisi bulunamadƒ±', 'info', 2000);
                return;
            }
            
            // Se√ßili tedarik√ßiyi al
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            
            // Tedarik√ßiye g√∂re filtrele
            let filteredDeliveries = material.deliveries;
            if (selectedSupplier) {
                filteredDeliveries = material.deliveries.filter(d => d.supplier === selectedSupplier);
                console.log('üîç Tedarik√ßiye g√∂re filtrelendi:', selectedSupplier, 'Sonu√ß:', filteredDeliveries.length, 'kayƒ±t');
            }
            
            if (filteredDeliveries.length === 0) {
                showToast(`‚ÑπÔ∏è ${selectedSupplier} i√ßin irsaliye bilgisi bulunamadƒ±`, 'info', 2000);
                console.log('‚ö†Ô∏è Filtrelenmi≈ü delivery yok');
                return;
            }
            
            console.log('‚úÖ Dropdown\'lar olu≈üturulacak:', filteredDeliveries.length, 'kayƒ±t');
            
            // ƒ∞rsaliye tarihi dropdown'ƒ±nƒ± olu≈ütur
            if (autoFillDateCheckbox?.checked) {
                console.log('üìÖ Tarih dropdown olu≈üturuluyor...');
                createDeliveryDateDropdown(filteredDeliveries);
            }
            
            // ƒ∞rsaliye no dropdown'ƒ±nƒ± olu≈ütur
            if (autoFillNoCheckbox?.checked) {
                console.log('üìù No dropdown olu≈üturuluyor...');
                createDeliveryNoDropdown(filteredDeliveries);
            }
            
            showToast(`üì¶ ${filteredDeliveries.length} irsaliye kaydƒ± bulundu`, 'success', 2000);
        }
        
        function createDeliveryDateDropdown(deliveries) {
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (!deliveryDateInput) return;
            
            // Mevcut dropdown varsa kaldƒ±r
            const existingDropdown = document.getElementById('deliveryDateDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Yeni dropdown olu≈ütur
            const dropdown = document.createElement('select');
            dropdown.id = 'deliveryDateDropdown';
            dropdown.style.cssText = 'width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;';
            
            // Bo≈ü se√ßenek
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ƒ∞rsaliye tarihi se√ßin...';
            dropdown.appendChild(emptyOption);
            
            // Tarihleri grupla ve sƒ±rala
            // √ñnce tarihleri formatla (eƒüer formatlanmamƒ±≈üsa)
            const formattedDeliveries = deliveries.map(d => ({
                ...d,
                date: d.date && d.date.includes('.') ? d.date : formatExcelDateToDisplay(d.date)
            }));
            
            const uniqueDates = [...new Set(formattedDeliveries.map(d => d.date))].sort().reverse();
            
            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                
                // Value: YYYY-MM-DD formatƒ± (HTML date input i√ßin)
                // gg.aa.yyyy -> YYYY-MM-DD
                const parts = date.split('.');
                if (parts.length === 3) {
                    option.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                } else {
                    // Eƒüer hala formatlanmamƒ±≈üsa, tekrar dene
                    const formatted = formatExcelDateToDisplay(date);
                    const formattedParts = formatted.split('.');
                    if (formattedParts.length === 3) {
                        option.value = `${formattedParts[2]}-${formattedParts[1]}-${formattedParts[0]}`;
                    } else {
                        option.value = date;
                    }
                }
                
                // Text: gg.aa.yyyy formatƒ± (kullanƒ±cƒ± i√ßin)
                const count = formattedDeliveries.filter(d => d.date === date).length;
                option.textContent = `${date} (${count} kayƒ±t)`;
                option.dataset.displayDate = date; // Orijinal formatƒ± sakla
                
                dropdown.appendChild(option);
            });
            
            // Se√ßim yapƒ±lƒ±nca input'u doldur
            dropdown.onchange = function() {
                if (this.value) {
                    // Value zaten YYYY-MM-DD formatƒ±nda
                    deliveryDateInput.value = this.value;
                    
                    // Orijinal gg.aa.yyyy formatƒ±nƒ± al
                    const selectedOption = this.options[this.selectedIndex];
                    const displayDate = selectedOption.dataset.displayDate;
                    
                    // Aynƒ± tarihteki irsaliye numaralarƒ±nƒ± g√∂ster (formatlanmƒ±≈ü tarih ile filtrele)
                    const sameDateDeliveries = formattedDeliveries.filter(d => d.date === displayDate);
                    updateDeliveryNoForDate(sameDateDeliveries);
                }
            };
            
            // Input'tan sonra ekle
            deliveryDateInput.parentNode.insertBefore(dropdown, deliveryDateInput.nextSibling);
        }
        
        function createDeliveryNoDropdown(deliveries) {
            const deliveryNoInput = document.getElementById('deliveryNo');
            if (!deliveryNoInput) return;
            
            console.log('üîß ƒ∞rsaliye No dropdown olu≈üturuluyor:', deliveries.length, 'kayƒ±t');
            
            // Mevcut dropdown varsa kaldƒ±r
            const existingDropdown = document.getElementById('deliveryNoDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Yeni dropdown olu≈ütur
            const dropdown = document.createElement('select');
            dropdown.id = 'deliveryNoDropdown';
            dropdown.style.cssText = 'width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;';
            
            // Bo≈ü se√ßenek
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ƒ∞rsaliye numarasƒ± se√ßin...';
            dropdown.appendChild(emptyOption);
            
            // Numaralarƒ± sƒ±rala
            const sortedDeliveries = [...deliveries].sort((a, b) => {
                // √ñnce tarihe g√∂re, sonra numaraya g√∂re sƒ±rala
                if (a.date !== b.date) {
                    return b.date.localeCompare(a.date);
                }
                return b.no.localeCompare(a.no);
            });
            
            sortedDeliveries.forEach((delivery, index) => {
                const option = document.createElement('option');
                
                // Seri ve numarayƒ± birle≈ütir (format: SERIE | NUMARA)
                const displayText = delivery.serie && delivery.no 
                    ? `${delivery.serie} | ${delivery.no}`
                    : (delivery.no || delivery.serie || '');
                
                // ƒ∞lk 3 kayƒ±t i√ßin debug
                if (index < 3) {
                    console.log('üìã Dropdown item:', index, 'Seri:', delivery.serie, 'No:', delivery.no, 'Display:', displayText);
                }
                
                option.value = displayText;
                option.dataset.date = delivery.date;
                option.dataset.supplier = delivery.supplier;
                
                option.textContent = displayText;
                
                dropdown.appendChild(option);
            });
            
            // Se√ßim yapƒ±lƒ±nca input'u doldur
            dropdown.onchange = function() {
                if (this.value) {
                    deliveryNoInput.value = this.value;
                    
                    // ƒ∞lgili tarihi de doldur
                    const selectedOption = this.options[this.selectedIndex];
                    const date = selectedOption.dataset.date;
                    if (date) {
                        // gg.aa.yyyy formatƒ±nƒ± YYYY-MM-DD'ye √ßevir
                        const parts = date.split('.');
                        if (parts.length === 3) {
                            document.getElementById('deliveryDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        } else {
                            document.getElementById('deliveryDate').value = date;
                        }
                    }
                }
            };
            
            // Input'tan sonra ekle
            deliveryNoInput.parentNode.insertBefore(dropdown, deliveryNoInput.nextSibling);
        }
        
        function updateDeliveryNoForDate(deliveries) {
            const deliveryNoDropdown = document.getElementById('deliveryNoDropdown');
            if (!deliveryNoDropdown) return;
            
            // Dropdown'ƒ± temizle ve yeniden doldur
            deliveryNoDropdown.innerHTML = '';
            
            // Bo≈ü se√ßenek
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ƒ∞rsaliye numarasƒ± se√ßin...';
            deliveryNoDropdown.appendChild(emptyOption);
            
            // Sadece bu tarihteki kayƒ±tlarƒ± g√∂ster
            deliveries.forEach(delivery => {
                const option = document.createElement('option');
                
                // Seri ve numarayƒ± birle≈ütir (format: SERIE | NUMARA)
                const displayText = delivery.serie && delivery.no 
                    ? `${delivery.serie} | ${delivery.no}`
                    : (delivery.no || delivery.serie || '');
                
                option.value = displayText;
                option.dataset.date = delivery.date;
                option.textContent = displayText;
                deliveryNoDropdown.appendChild(option);
            });
        }
        
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            
            // Excel'den gelen tarih formatƒ±: YYYY-MM-DD
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            
            return dateStr;
        }
        
        function formatExcelDateToDisplay(dateValue) {
            if (!dateValue) return '';
            
            // Excel serial number'ƒ± tarih nesnesine √ßevir
            if (typeof dateValue === 'number') {
                // Excel'de 1900-01-01 = 1 (ama Excel'de 1900'√ºn ≈üubat 29 hatasƒ± var)
                // JavaScript Date ile d√∂n√º≈üt√ºr
                const excelEpoch = new Date(Date.UTC(1899, 11, 30)); // 30 Aralƒ±k 1899
                const msPerDay = 24 * 60 * 60 * 1000;
                const date = new Date(excelEpoch.getTime() + (dateValue * msPerDay));
                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                return `${day}.${month}.${year}`;
            }
            
            // Date nesnesi ise
            if (dateValue instanceof Date) {
                const day = String(dateValue.getDate()).padStart(2, '0');
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const year = dateValue.getFullYear();
                return `${day}.${month}.${year}`;
            }
            
            // String ise formatƒ± kontrol et
            const str = String(dateValue).trim();
            
            // YYYY-MM-DD formatƒ±
            if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
                const parts = str.split('-');
                return `${parts[2].substring(0,2)}.${parts[1]}.${parts[0]}`;
            }
            
            // DD.MM.YYYY veya DD/MM/YYYY formatƒ± (zaten doƒüru)
            if (/^\d{1,2}[\.\/-]\d{1,2}[\.\/-]\d{4}/.test(str)) {
                const parts = str.split(/[\.\/-]/);
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                return `${day}.${month}.${parts[2]}`;
            }
            
            // Sayƒ± stringi ise (√∂rn: "45769")
            const numValue = parseFloat(str);
            if (!isNaN(numValue) && numValue > 1000) {
                // Excel serial number olarak tekrar dene
                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                const msPerDay = 24 * 60 * 60 * 1000;
                const date = new Date(excelEpoch.getTime() + (numValue * msPerDay));
                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                return `${day}.${month}.${year}`;
            }
            
            return str;
        }
        
        function handleMaterialBlur() {
            // Kƒ±sa bir gecikme ile dropdown tƒ±klamalarƒ±na izin ver
            setTimeout(() => {
                const materialInput = document.getElementById('materialCode');
                const value = materialInput?.value?.trim();
                
                if (!value) return;
                
                // Hammadde kodunu ayƒ±kla (format: "KOD | ƒ∞Sƒ∞M")
                let materialCode = value;
                if (value.includes(' | ')) {
                    materialCode = value.split(' | ')[0].trim();
                } else if (value.includes(' - ')) {
                    // Eski format desteƒüi
                    materialCode = value.split(' - ')[0].trim();
                }
                
                // ƒ∞rsaliye bilgilerini g√ºncelle
                updateDeliveryOptions(materialCode);
            }, 200);
        }
        
        // Tedarik√ßi se√ßilince hammaddeleri filtrele
        function filterMaterialsBySupplier() {
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            const materialInput = document.getElementById('materialCode');
            
            if (selectedSupplier) {
                // Hammadde dropdown'ƒ±nƒ± g√ºncelle
                updateMaterialDropdown(materialInput.value);
                
                // Placeholder'ƒ± g√ºncelle
                materialInput.placeholder = `üîç ${selectedSupplier} hammaddelerini ara...`;
                
                // Bilgi g√∂ster
                const filteredCount = materials.filter(m => 
                    m.suppliers && m.suppliers.includes(selectedSupplier)
                ).length;
                
                if (filteredCount > 0) {
                    showToast(`üì¶ ${selectedSupplier} i√ßin ${filteredCount} hammadde bulundu`, 'info', 2000);
                } else {
                    showToast(`‚ö†Ô∏è ${selectedSupplier} i√ßin hammadde bulunamadƒ±`, 'warning', 2000);
                }
            } else {
                // Tedarik√ßi se√ßili deƒüilse t√ºm hammaddeleri g√∂ster
                materialInput.placeholder = 'üîç Hammadde ara veya yazƒ±n...';
                updateMaterialDropdown(materialInput.value);
            }
        }
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', function(e) {
            const materialWrapper = document.querySelector('.supplier-dropdown-wrapper');
            const materialDropdown = document.getElementById('materialDropdown');
            
            if (materialWrapper && !materialWrapper.contains(e.target)) {
                if (materialDropdown) {
                    materialDropdown.style.display = 'none';
                }
            }
        });
        
        // ==================== File Upload ====================
        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#2d5a3d';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }
        
        // PDF'i resme √ßevirip sƒ±kƒ±≈ütƒ±r (pdf.js kullanarak)
        async function compressPDF(file, maxSizeKB = 400) {
            return new Promise(async (resolve) => {
                try {
                    const maxSize = maxSizeKB * 1024;
                    
                    // PDF.js worker ayarla
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    // Dosyayƒ± ArrayBuffer olarak oku
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // PDF'i y√ºkle
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const numPages = pdf.numPages;
                    
                    console.log('PDF sayfa sayƒ±sƒ±: ' + numPages);
                    showToast('üìÑ PDF ' + numPages + ' sayfa, d√∂n√º≈üt√ºr√ºl√ºyor...', 'info');
                    
                    // T√ºm sayfalarƒ± tek bir canvas'a √ßiz
                    const scale = 1.5; // Kalite i√ßin scale
                    let totalHeight = 0;
                    let maxWidth = 0;
                    const pageCanvases = [];
                    
                    // Her sayfayƒ± render et
                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: scale });
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                        
                        pageCanvases.push(canvas);
                        totalHeight += viewport.height;
                        if (viewport.width > maxWidth) maxWidth = viewport.width;
                    }
                    
                    // T√ºm sayfalarƒ± birle≈ütir
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = maxWidth;
                    finalCanvas.height = totalHeight;
                    const finalCtx = finalCanvas.getContext('2d');
                    finalCtx.fillStyle = 'white';
                    finalCtx.fillRect(0, 0, maxWidth, totalHeight);
                    
                    let yOffset = 0;
                    for (const canvas of pageCanvases) {
                        finalCtx.drawImage(canvas, 0, yOffset);
                        yOffset += canvas.height;
                    }
                    
                    // JPEG olarak sƒ±kƒ±≈ütƒ±r
                    let quality = 0.85;
                    let result = finalCanvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.2) {
                        quality -= 0.1;
                        result = finalCanvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale2 = Math.sqrt(maxSize / result.length) * 0.9;
                        finalCanvas.width = Math.round(maxWidth * scale2);
                        finalCanvas.height = Math.round(totalHeight * scale2);
                        finalCtx.fillStyle = 'white';
                        finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                        
                        yOffset = 0;
                        for (const canvas of pageCanvases) {
                            const newHeight = canvas.height * scale2;
                            finalCtx.drawImage(canvas, 0, yOffset, finalCanvas.width, newHeight);
                            yOffset += newHeight;
                        }
                        result = finalCanvas.toDataURL('image/jpeg', 0.7);
                    }
                    
                    console.log('PDF Sƒ±kƒ±≈ütƒ±rma: ' + Math.round(file.size/1024) + 'KB -> ' + Math.round(result.length/1024) + 'KB');
                    resolve({ 
                        data: result, 
                        compressed: true, 
                        originalSize: file.size, 
                        newSize: result.length,
                        convertedToImage: true
                    });
                    
                } catch (error) {
                    console.error('PDF sƒ±kƒ±≈ütƒ±rma hatasƒ±:', error);
                    // Hata olursa orijinal dosyayƒ± d√∂nd√ºr
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, compressed: false, error: error.message });
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Resmi sƒ±kƒ±≈ütƒ±r (max 500KB)
        async function compressImage(file, maxSizeKB = 400) {
            return new Promise((resolve) => {
                const maxSize = maxSizeKB * 1024;
                
                // Resim deƒüilse direkt oku
                if (!file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, compressed: false });
                    reader.readAsDataURL(file);
                    return;
                }
                
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Max boyut 1920px
                    const maxDim = 1920;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kaliteyi d√º≈ü√ºrerek sƒ±kƒ±≈ütƒ±r
                    let quality = 0.9;
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale = Math.sqrt(maxSize / result.length);
                        canvas.width = Math.round(width * scale);
                        canvas.height = Math.round(height * scale);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.8);
                    }
                    
                    console.log('Sƒ±kƒ±≈ütƒ±rma: ' + Math.round(file.size/1024) + 'KB -> ' + Math.round(result.length/1024) + 'KB');
                    resolve({ data: result, compressed: true, originalSize: file.size, newSize: result.length });
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function handleFile(file) {
            selectedFile = file;
            const uploadArea = document.getElementById('uploadArea');
            const preview = document.getElementById('filePreview');
            
            uploadArea.classList.add('has-file');
            
            const fileSizeKB = Math.round(file.size / 1024);
            showToast('üìÅ Dosya: ' + file.name + ' (' + fileSizeKB + 'KB)', 'info');
            
            // PDF - ORJƒ∞NAL olarak sakla, resme d√∂n√º≈üt√ºrme
            if (file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    preview.innerHTML = '<div class="file-name" style="color:green;">üìÑ ' + file.name + ' (PDF - orjinal kalite)</div>';
                    showToast('‚úÖ PDF hazƒ±r (orjinal kalite)', 'success');
                    
                    // PDF y√ºklendikten sonra OCR ba≈ülat
                    startOCRAnalysis();
                };
                reader.readAsDataURL(file);
            }
            // Excel dosyalarƒ± (.xlsx, .xls)
            else if (file.type.includes('spreadsheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    preview.innerHTML = '<div class="file-name" style="color:#107c41;">üìä ' + file.name + ' (Excel - orjinal)</div>';
                    showToast('‚úÖ Excel dosyasƒ± hazƒ±r', 'success');
                };
                reader.readAsDataURL(file);
            }
            // Word dosyalarƒ± (.docx, .doc)
            else if (file.type.includes('wordprocessing') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    preview.innerHTML = '<div class="file-name" style="color:#2b579a;">üìù ' + file.name + ' (Word - orjinal)</div>';
                    showToast('‚úÖ Word dosyasƒ± hazƒ±r', 'success');
                };
                reader.readAsDataURL(file);
            }
            // Resim sƒ±kƒ±≈ütƒ±rma (400KB √ºst√º)
            else if (file.type.startsWith('image/') && file.size > 400 * 1024) {
                showToast('üîÑ Resim sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...', 'info');
                const compressed = await compressImage(file, 400);
                selectedFileData = compressed.data; // Drive i√ßin sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü (400KB)
                
                if (compressed.compressed) {
                    const newSizeKB = Math.round(compressed.newSize / 1024);
                    showToast('‚úÖ Sƒ±kƒ±≈ütƒ±rƒ±ldƒ±: ' + fileSizeKB + 'KB -> ' + newSizeKB + 'KB', 'success');
                }
                
                preview.innerHTML = '<div class="file-name">üì∑ ' + file.name + ' (sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü)</div>' +
                    '<img src="' + selectedFileData + '" class="preview-image">';
                
                // üì∏ OCR i√ßin ORƒ∞Jƒ∞NAL dosyayƒ± kullan ama akƒ±llƒ±ca optimize et
                console.log('üîç OCR i√ßin orijinal dosya i≈üleniyor (y√ºksek kalite)...');
                showToast('üîç OCR optimizasyonu (orijinal kalite)...', 'info');
                
                const ocrReader = new FileReader();
                ocrReader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Akƒ±llƒ± boyut kontrol√º - OCR.space 1MB limiti i√ßin
                        let maxWidth = 1300; // Daha b√ºy√ºk ba≈ülangƒ±√ß (daha fazla detay)
                        let quality = 0.87; // Dengeli kalite
                        let result = null;
                        
                        // Boyut limitini a≈üana kadar deneme yap
                        for (let attempt = 0; attempt < 3; attempt++) {
                            const canvas = document.createElement('canvas');
                            let targetWidth = Math.min(img.width, maxWidth);
                            let targetHeight = Math.round((img.height * targetWidth) / img.width);
                            
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            const ctx = canvas.getContext('2d');
                            
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                            
                            // Kontrast artƒ±rma (dengeli - √ßok fazla detay kaybettirmemeli)
                            const imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
                            const data = imageData.data;
                            const contrastFactor = 1.35; // %35 kontrast (dengeli)
                            const brightness = 6; // Dengeli parlaklƒ±k
                            
                            for (let i = 0; i < data.length; i += 4) {
                                data[i] = Math.min(255, Math.max(0, contrastFactor * (data[i] - 128) + 128 + brightness));
                                data[i + 1] = Math.min(255, Math.max(0, contrastFactor * (data[i + 1] - 128) + 128 + brightness));
                                data[i + 2] = Math.min(255, Math.max(0, contrastFactor * (data[i + 2] - 128) + 128 + brightness));
                            }
                            
                            ctx.putImageData(imageData, 0, 0);
                            
                            const testResult = canvas.toDataURL('image/jpeg', quality);
                            const sizeKB = Math.round(testResult.length / 1024);
                            
                            console.log(`üîç Deneme ${attempt + 1}: ${targetWidth}x${targetHeight}, Q${quality.toFixed(2)}, ${sizeKB}KB`);
                            
                            // 780KB altƒ±ndaysa kabul et
                            if (sizeKB < 780) {
                                result = testResult;
                                console.log(`‚úÖ OCR optimize: ${sizeKB}KB (${targetWidth}x${targetHeight})`);
                                break;
                            }
                            
                            // Daha k√º√ß√ºlt
                            maxWidth = Math.round(maxWidth * 0.8);
                            quality = Math.max(0.75, quality - 0.05);
                        }
                        
                        window.originalFileDataForOCR = result || canvas.toDataURL('image/jpeg', 0.70);
                        startOCRAnalysis();
                    };
                    img.src = e.target.result; // ORƒ∞Jƒ∞NAL dosyadan oku
                };
                ocrReader.readAsDataURL(file); // ORƒ∞Jƒ∞NAL dosyayƒ± oku (sƒ±kƒ±≈ütƒ±rƒ±lmamƒ±≈ü)
            }
            // K√º√ß√ºk resim veya diƒüer dosyalar
            else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    
                    if (file.type.startsWith('image/')) {
                        preview.innerHTML = '<div class="file-name">üì∑ ' + file.name + '</div>' +
                            '<img src="' + e.target.result + '" class="preview-image">';
                        
                        // Resim y√ºklendikten sonra OCR ba≈ülat
                        startOCRAnalysis();
                    } else {
                        preview.innerHTML = '<div class="file-name">üìÑ ' + file.name + '</div>';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // OCR analizini ba≈ülat (dosya y√ºklenir y√ºklenmez)
        function startOCRAnalysis() {
            console.log('üéØ startOCRAnalysis √ßaƒürƒ±ldƒ±');
            
            // OCR i√ßin orijinal dosya varsa onu kullan (y√ºksek kalite)
            // Yoksa sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü selectedFileData'yƒ± kullan
            const fileDataForOCR = window.originalFileDataForOCR || selectedFileData;
            
            if (!fileDataForOCR) {
                console.log('‚ö†Ô∏è Dosya verisi yok, OCR ba≈ülatƒ±lamadƒ±');
                return;
            }
            
            console.log('üìÑ OCR i√ßin kullanƒ±lan dosya:', window.originalFileDataForOCR ? 'ORƒ∞Jƒ∞NAL (y√ºksek kalite)' : 'SIKI≈ûTIRILMI≈û');
            
            const materialCode = document.getElementById('materialCode').value.trim();
            
            // Hammadde kodu yoksa sadece OCR yap, e≈üle≈ütirme yapma
            if (!materialCode) {
                console.log('‚ö†Ô∏è Material code bo≈ü, OCR yapƒ±lacak ama e≈üle≈ütirme ertelenecek');
                const fileDataCopy = fileDataForOCR + '';
                
                extractCOAProperties(fileDataCopy)
                    .then(coaProperties => {
                        console.log('‚úÖ OCR tamamlandƒ± (e≈üle≈ütirme yok - hammadde se√ßilmemi≈ü)');
                        // Ge√ßici olarak sakla
                        window.lastOCRProperties = coaProperties;
                        showToast('‚úÖ Belge okundu, hammadde se√ßin', 'info');
                    })
                    .catch(error => {
                        console.error('‚ùå OCR hatasƒ±:', error);
                        showToast('‚ö†Ô∏è OCR hatasƒ±: ' + error.message, 'warning');
                    });
                return;
            }
            
            const materialCodeOnly = materialCode.includes(' | ') ? materialCode.split(' | ')[0].trim() : 
                                     materialCode.includes(' - ') ? materialCode.split(' - ')[0].trim() : 
                                     materialCode;
            
            console.log('üîë Hammadde kodu:', materialCodeOnly);
            console.log('üöÄ OCR ba≈ülatƒ±lƒ±yor...');
            
            const fileDataCopy = fileDataForOCR + '';
            
            extractCOAProperties(fileDataCopy)
                .then(coaProperties => {
                    console.log('‚úÖ OCR tamamlandƒ±!');
                    const matchCount = matchCOAWithTDS(materialCodeOnly, coaProperties);
                    
                    // OCR tamamlandƒ±ƒüƒ±nƒ± i≈üaretle (modal a√ßƒ±lƒ±rken deƒüerleri korumak i√ßin)
                    lastOCRMaterialCode = materialCodeOnly;
                    console.log('üîñ lastOCRMaterialCode set:', lastOCRMaterialCode);
                    
                    // TDS modalƒ± yenile (a√ßƒ±k olsun olmasƒ±n)
                    console.log('üîÑ TDS verisi g√ºncellendi, modal yenileniyor...');
                    const tdsModal = document.getElementById('tdsModal');
                    if (tdsModal && tdsModal.classList.contains('active') && currentTDSMaterial === materialCodeOnly) {
                        // Modal a√ßƒ±ksa ve aynƒ± hammadde ise refresh et (COA deƒüerlerini KORUYARAK)
                        loadTDSForMaterial(false); // false = COA deƒüerlerini temizleme
                        showToast(`‚úÖ ${matchCount} √∂zellik e≈üle≈ütirildi ve g√ºncellendi`, 'success', 5000);
                    } else if (matchCount > 0) {
                        showToast(`‚úÖ ${matchCount} √∂zellik e≈üle≈ütirildi, TDS modalƒ±nƒ± a√ßƒ±n`, 'success', 5000);
                    }
                })
                .catch(error => {
                    console.error('‚ùå OCR hatasƒ±:', error);
                    showToast('‚ö†Ô∏è OCR hatasƒ±: ' + error.message, 'warning');
                });
        }
        
        // ==================== CRUD Operations ====================
        async function saveCOA() {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üíæüíæüíæ saveCOA FONKSIYONU √áAƒûRILDI! üíæüíæüíæ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìù editMode:', editMode);
            console.log('üìÑ selectedFileData var mƒ±:', !!selectedFileData);
            console.log('üìÑ selectedFileData uzunluƒüu:', selectedFileData ? selectedFileData.length : 0);
            
            const supplier = document.getElementById('supplierInput').value.trim();
            const materialCode = document.getElementById('materialCode').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryNo = document.getElementById('deliveryNo').value.trim();
            const lotNumber = document.getElementById('lotNumber').value.trim();
            const location = document.getElementById('location').value;
            const notes = document.getElementById('notes').value.trim();
            
            console.log('üì¶ Material Code:', materialCode);
            
            // Validation
            if (!supplier) {
                showToast('‚ùå Tedarik√ßi adƒ± girin!', 'error');
                return;
            }
            if (!materialCode) {
                showToast('‚ùå Hammadde kodu girin!', 'error');
                return;
            }
            if (!deliveryDate) {
                showToast('‚ùå ƒ∞rsaliye tarihi girin!', 'error');
                return;
            }
            
            console.log('‚úÖ Validasyon ge√ßti');
            
            // Edit mode - dosya opsiyonel
            if (editMode) {
                console.log('üìù Edit mode aktif');
                const existingRecord = coaData.find(c => c.id === editingId);
                if (!existingRecord) {
                    showToast('‚ùå Kayƒ±t bulunamadƒ±!', 'error');
                    return;
                }
                
                // Yeni dosya y√ºklendiyse Drive'a upload et
                let uploadResult = null;
                if (selectedFileData) {
                    console.log('üìÑ Edit modda yeni dosya y√ºklendi, OCR ba≈ülatƒ±lƒ±yor...');
                    showToast('‚òÅÔ∏è Yeni dosya Drive\'a y√ºkleniyor...', 'info');
                    
                    try {
                        // XMLHttpRequest POST (b√ºy√ºk veri i√ßin)
                        const compressedData = await compressForSheets(selectedFileData, 200);
                        console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                        console.log('Cihaz:', /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobil' : 'Desktop');
                        
                        uploadResult = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.timeout = 120000; // 120 saniye (mobil i√ßin)
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        resolve(JSON.parse(xhr.responseText));
                                    } catch(e) {
                                        reject(new Error('JSON parse hatasƒ±'));
                                    }
                                } else {
                                    reject(new Error('HTTP ' + xhr.status));
                                }
                            };
                            
                            xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                            xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                            
                            xhr.open('POST', googleScriptUrl, true);
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            
                            const formData = new URLSearchParams();
                            formData.append('action', 'uploadFile');
                            formData.append('fileData', compressedData);
                            formData.append('fileName', selectedFile.name);
                            formData.append('mimeType', selectedFile.type || 'image/jpeg');
                            
                            xhr.send(formData.toString());
                        });
                        
                        console.log('Drive upload sonucu:', uploadResult);
                        
                        if (!uploadResult || !uploadResult.success) {
                            showToast('‚ùå Dosya y√ºklenemedi: ' + (uploadResult?.error || 'Bilinmeyen hata'), 'error');
                            return;
                        }
                        showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
                    } catch (uploadErr) {
                        console.error('Drive upload hatasƒ±:', uploadErr);
                        showToast('‚ùå Dosya y√ºkleme hatasƒ±: ' + uploadErr.message, 'error');
                        return;
                    }
                }
                
                // Record olu≈ütur - yeni dosya varsa onun bilgilerini kullan, yoksa eski dosyayƒ± koru
                const record = {
                    id: editingId,
                    supplier: supplier,
                    materialCode: materialCode,
                    deliveryDate: deliveryDate,
                    deliveryNo: deliveryNo,
                    lotNumber: lotNumber,
                    location: location,
                    notes: notes,
                    fileName: uploadResult ? uploadResult.fileName : existingRecord.fileName,
                    fileType: uploadResult ? selectedFile.type : existingRecord.fileType,
                    fileData: uploadResult ? selectedFileData : existingRecord.fileData,
                    fileUrl: uploadResult ? uploadResult.viewUrl : existingRecord.fileUrl,
                    driveFileId: uploadResult ? uploadResult.fileId : existingRecord.driveFileId,
                    fileSize: uploadResult ? uploadResult.fileSize : existingRecord.fileSize, // Ger√ßek boyut
                    createdAt: existingRecord.createdAt,
                    updatedAt: new Date().toISOString()
                };
                
                // OCR zaten fotoƒüraf √ßekilirken yapƒ±ldƒ±, tekrar yapmaya gerek yok
                console.log('‚ÑπÔ∏è Edit modda OCR atlanƒ±yor (√ßekim sƒ±rasƒ±nda yapƒ±ldƒ±)');
                
                // Google Sheets'e g√ºncelle
                if (googleScriptUrl) {
                    const result = await updateToGoogleSheets(record);
                    if (result) {
                        const idx = coaData.findIndex(c => c.id === editingId);
                        if (idx >= 0) {
                            coaData[idx] = record;
                        }
                        saveToLocalStorage();
                        showToast('‚úÖ COA g√ºncellendi!', 'success');
                    }
                } else {
                    const idx = coaData.findIndex(c => c.id === editingId);
                    if (idx >= 0) {
                        coaData[idx] = record;
                    }
                    saveToLocalStorage();
                    showToast('‚úÖ Yerel olarak g√ºncellendi!', 'success');
                }
                
                cancelEdit();
                updateUI();
                return;
            }
            
            // Yeni kayƒ±t - dosya zorunlu
            console.log('üìÑ Yeni kayƒ±t modu');
            if (!selectedFileData) {
                showToast('‚ùå Sertifika dosyasƒ± y√ºkleyin!', 'error');
                return;
            }
            
            console.log('‚úÖ Dosya var, Drive y√ºkleme ba≈ülƒ±yor...');
            
            // √ñnce Drive'a y√ºkle
            showToast('‚òÅÔ∏è Dosya Drive\'a y√ºkleniyor...', 'info');
            let uploadResult = null;
            
            try {
                const compressedData = await compressForSheets(selectedFileData, 200);
                console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                console.log('Cihaz:', /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobil' : 'Desktop');
                
                uploadResult = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 120000; // 120 saniye (mobil i√ßin)
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'uploadFile');
                    formData.append('fileData', compressedData);
                    formData.append('fileName', selectedFile.name);
                    formData.append('mimeType', selectedFile.type || 'image/jpeg');
                    
                    xhr.send(formData.toString());
                });
                
                console.log('Drive upload sonucu:', uploadResult);
                
                if (!uploadResult || !uploadResult.success) {
                    showToast('‚ùå Dosya y√ºklenemedi: ' + (uploadResult?.error || 'Bilinmeyen hata'), 'error');
                    return;
                }
                showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
            } catch (uploadErr) {
                console.error('Drive upload hatasƒ±:', uploadErr);
                showToast('‚ùå Dosya y√ºkleme hatasƒ±: ' + uploadErr.message, 'error');
                return;
            }
            
            const record = {
                id: 'coa_' + Date.now(),
                supplier: supplier,
                materialCode: materialCode,
                deliveryDate: deliveryDate,
                deliveryNo: deliveryNo,
                lotNumber: lotNumber,
                location: location,
                notes: notes,
                fileName: uploadResult.fileName,
                fileType: selectedFile.type,
                fileData: selectedFileData,
                fileUrl: uploadResult.viewUrl,
                driveFileId: uploadResult.fileId,
                fileSize: uploadResult.fileSize, // Ger√ßek dosya boyutu (bytes)
                createdAt: new Date().toISOString()
            };
            
            // OCR zaten fotoƒüraf √ßekilirken yapƒ±ldƒ± (startOCRAnalysis), tekrar yapmaya gerek yok
            console.log('‚ÑπÔ∏è OCR atlanƒ±yor (√ßekim sƒ±rasƒ±nda yapƒ±ldƒ±)');
            
            // Save
            if (googleScriptUrl) {
                const success = await saveToGoogleSheets(record);
                if (success) {
                    coaData.unshift(record);
                    showToast('‚úÖ Google Sheets\'e kaydedildi!', 'success');
                    console.log('‚úÖ KAYIT TAMAMLANDI - OCR √áAƒûRISI YOK!');
                    
                    // COA_Records'a da kaydet (TDS tanƒ±mlƒ±ysa)
                    // materialCode'dan sadece kod kƒ±smƒ±nƒ± √ßƒ±kar (pipe √∂ncesi)
                    const cleanMaterialCode = materialCode.includes('|') 
                        ? materialCode.split('|')[0].trim() 
                        : materialCode.trim();
                    
                    console.log('üîë Clean Material Code for Records:', cleanMaterialCode);
                    
                    if (tdsData[cleanMaterialCode]) {
                        console.log('üìä COA_Records kaydƒ± ba≈ülatƒ±lƒ±yor...');
                        await saveCOARecordToSheets(cleanMaterialCode, tdsData[cleanMaterialCode].properties);
                    } else {
                        console.log('‚ö†Ô∏è TDS tanƒ±mlƒ± deƒüil:', cleanMaterialCode);
                    }
                } else {
                    showToast('‚ùå Kayƒ±t hatasƒ±!', 'error');
                    return;
                }
            } else {
                console.log('‚ö†Ô∏è Google Sheets URL yok, sadece local kayƒ±t yapƒ±lƒ±yor');
                coaData.unshift(record);
                saveToLocalStorage();
                showToast('‚úÖ Yerel olarak kaydedildi!', 'success');
                console.log('‚úÖ KAYIT TAMAMLANDI - OCR √áAƒûRISI YOK!');
            }
            
            console.log('‚úÖ Kayƒ±t tamamlandƒ±, form temizleniyor...');
            
            // Reset form
            clearForm();
            updateUI();
            loadSuppliers();
        }
        
        function clearForm() {
            document.getElementById('supplierInput').value = '';
            document.getElementById('materialCode').value = '';
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryNo').value = '';
            document.getElementById('lotNumber').value = '';
            document.getElementById('location').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('uploadArea').classList.remove('has-file');
            selectedFile = null;
            selectedFileData = null;
            editMode = false;
            editingId = null;
            document.getElementById('saveBtn').textContent = 'üíæ Kaydet';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }
        
        function editCOA(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±!', 'error');
                return;
            }
            
            // Forma verileri doldur
            document.getElementById('supplierInput').value = record.supplier || '';
            document.getElementById('materialCode').value = record.materialCode || '';
            // Tarih formatƒ±nƒ± d√ºzelt (YYYY-MM-DD)
            const deliveryDate = record.deliveryDate || '';
            document.getElementById('deliveryDate').value = deliveryDate.split('T')[0];
            document.getElementById('deliveryNo').value = record.deliveryNo || '';
            document.getElementById('lotNumber').value = record.lotNumber || '';
            document.getElementById('location').value = record.location || '';
            document.getElementById('notes').value = record.notes || '';
            
            // Mevcut dosya √∂nizlemesi
            if (record.fileData) {
                const preview = document.getElementById('filePreview');
                // T√ºm dosyalar i√ßin ikon g√∂ster
                const fileIconHtml = getFileIcon(record.fileName, record.fileType, record.id);
                preview.innerHTML = fileIconHtml + '<p style="margin-top: 10px; color: #666;">Mevcut dosya: ' + record.fileName + '</p><p style="font-size: 0.9em; color: #999;">Yeni dosya y√ºklerseniz deƒüi≈ütirilir</p>';
                document.getElementById('uploadArea').classList.add('has-file');
            }
            
            // Edit mode'a ge√ß
            editMode = true;
            editingId = id;
            document.getElementById('saveBtn').textContent = '‚úèÔ∏è G√ºncelle';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Forma scroll
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            showToast('üìù D√ºzenleme modu aktif', 'info');
        }
        
        function cancelEdit() {
            clearForm();
            showToast('‚ùå D√ºzenleme iptal edildi', 'info');
        }
        
        function toggleRowSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateBulkActions();
        }
        
        function toggleSelectAll() {
            const filtered = getFilteredData();
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            if (headerCheckbox.checked) {
                // T√ºm√ºn√º se√ß
                filtered.forEach(c => selectedItems.add(c.id));
            } else {
                // T√ºm√ºn√º kaldƒ±r
                filtered.forEach(c => selectedItems.delete(c.id));
            }
            
            renderTable();
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const count = selectedItems.size;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            countSpan.textContent = count;
            
            if (count > 0) {
                deleteBtn.style.display = 'inline-block';
            } else {
                deleteBtn.style.display = 'none';
            }
            
            // Header checkbox durumu
            if (headerCheckbox) {
                const filtered = getFilteredData();
                const allSelected = filtered.length > 0 && filtered.every(c => selectedItems.has(c.id));
                headerCheckbox.checked = allSelected;
            }
        }
        
        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showToast('‚ùå Silinecek kayƒ±t se√ßin!', 'error');
                return;
            }
            
            if (!confirm(`${selectedItems.size} adet kaydƒ± silmek istediƒüinizden emin misiniz?`)) {
                return;
            }
            
            const idsToDelete = Array.from(selectedItems);
            let successCount = 0;
            
            for (const id of idsToDelete) {
                if (googleScriptUrl) {
                    await deleteFromGoogleSheets(id);
                }
                
                coaData = coaData.filter(c => c.id !== id);
                selectedItems.delete(id);
                successCount++;
            }
            
            saveToLocalStorage();
            updateUI();
            showToast(`‚úÖ ${successCount} kayƒ±t silindi!`, 'success');
        }
        
        async function deleteCOA(id) {
            if (!confirm('Bu sertifikayƒ± silmek istediƒüinizden emin misiniz?')) return;
            
            if (googleScriptUrl) {
                await deleteFromGoogleSheets(id);
            }
            
            coaData = coaData.filter(c => c.id !== id);
            saveToLocalStorage();
            updateUI();
            showToast('‚úÖ Silindi!', 'success');
        }
        
        function viewFile(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            // PDF veya √ßok sayfalƒ± dok√ºmanlar i√ßin direkt Drive link kullan (useDirectDriveLink flag'i)
            if (record.useDirectDriveLink && record.fileUrl) {
                console.log('üìÑ PDF/√áok sayfalƒ± dok√ºman - Direkt Drive\'dan a√ßƒ±lƒ±yor (tam kalite)');
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            // √ñnce yerel dosya verisi kontrol et (localStorage'da) - tek sayfa i√ßin
            if (record.fileData) {
                if (record.fileType === 'application/pdf' || record.fileName?.endsWith('.pdf')) {
                    const pdfWindow = window.open();
                    pdfWindow.document.write(`
                        <html>
                        <head><title>${record.fileName || 'COA PDF'}</title></head>
                        <body style="margin:0;padding:0;">
                        <iframe src="${record.fileData}" style="width:100%;height:100%;border:none;"></iframe>
                        </body>
                        </html>
                    `);
                } else {
                    document.getElementById('modalImage').src = record.fileData;
                    document.getElementById('imageModal').classList.add('active');
                }
                return;
            }
            
            // URL varsa onu kullan
            if (record.fileUrl) {
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            showToast('‚ùå Dosya bulunamadƒ± - Bu kayƒ±t dosyasƒ±z veya dosya y√ºklenemedi', 'error');
        }
        
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        function downloadFile(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            // √ñnce yerel dosya verisi kontrol et
            if (record.fileData) {
                const link = document.createElement('a');
                link.href = record.fileData;
                link.download = record.fileName || 'coa_file';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // URL varsa yeni sekmede a√ß
            if (record.fileUrl) {
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            showToast('‚ùå Dosya bulunamadƒ±', 'error');
        }
        
        // ==================== Excel Export ====================
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function exportToExcel() {
            if (coaData.length === 0) {
                showToast('‚ö†Ô∏è Dƒ±≈üa aktarƒ±lacak veri yok', 'warning');
                return;
            }
            
            showToast('üìä Excel olu≈üturuluyor...', 'info');
            
            // Filtrelenmi≈ü veriyi al
            const filteredData = getFilteredData();
            
            // Excel i√ßin veri hazƒ±rla
            const excelData = filteredData.map((record, index) => {
                // Tarihi formatla (T21:00:00.000Z kƒ±smƒ±nƒ± kaldƒ±r)
                let deliveryDate = record.deliveryDate || '';
                if (deliveryDate && deliveryDate.includes('T')) {
                    deliveryDate = deliveryDate.split('T')[0];
                }
                
                // Lot numarasƒ±nƒ± string olarak kaydet (E+12 notasyonunu √∂nle)
                let lotNumber = record.lotNumber || '';
                if (lotNumber) {
                    lotNumber = String(lotNumber);
                }
                
                return {
                    'Sƒ±ra': index + 1,
                    'Tedarik√ßi': record.supplier || '',
                    'Hammadde Kodu': record.materialCode || '',
                    'ƒ∞rsaliye Tarihi': deliveryDate,
                    'ƒ∞rsaliye No': record.deliveryNo || '',
                    'Parti/Lot No': lotNumber,
                    'Lokasyon': record.location || '',
                    'Dosya Adƒ±': record.fileName || '',
                    'Dosya Boyutu': record.fileSize ? formatFileSize(record.fileSize) : '',
                    'Eklenme Tarihi': record.timestamp ? new Date(record.timestamp).toLocaleDateString('tr-TR') : '',
                    'Drive Link': record.fileUrl || ''
                };
            });
            
            // Workbook olu≈ütur
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Parti/Lot No s√ºtununu text formatƒ±nda zorla (√ºstel notasyonu √∂nle)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const cellAddress = XLSX.utils.encode_cell({ r: row, c: 5 }); // 5. s√ºtun = Parti/Lot No
                if (ws[cellAddress]) {
                    ws[cellAddress].t = 's'; // String olarak i≈üaretle
                    ws[cellAddress].z = '@'; // Text format
                }
            }
            
            // S√ºtun geni≈üliklerini ayarla
            ws['!cols'] = [
                { wch: 6 },  // Sƒ±ra
                { wch: 35 }, // Tedarik√ßi
                { wch: 50 }, // Hammadde Kodu
                { wch: 15 }, // ƒ∞rsaliye Tarihi
                { wch: 20 }, // ƒ∞rsaliye No
                { wch: 20 }, // Lot No
                { wch: 15 }, // Lokasyon
                { wch: 35 }, // Dosya Adƒ±
                { wch: 12 }, // Dosya Boyutu
                { wch: 15 }, // Eklenme Tarihi
                { wch: 70 }  // Drive Link
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'COA Listesi');
            
            // Dosya adƒ± olu≈ütur (tarih ile)
            const now = new Date();
            const dateStr = now.toLocaleDateString('tr-TR').replace(/\./g, '-');
            const timeStr = now.toLocaleTimeString('tr-TR').replace(/:/g, '-');
            const fileName = `COA_Arsiv_${dateStr}_${timeStr}.xlsx`;
            
            // Excel dosyasƒ±nƒ± indir
            XLSX.writeFile(wb, fileName);
            
            showToast(`‚úÖ Excel dosyasƒ± indirildi: ${filteredData.length} kayƒ±t`, 'success');
        }
        
        // Filtrelenmi≈ü veriyi al (arama ve filtrelerle)
        function getFilteredData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterMonth = document.getElementById('filterMonth').value;
            
            return coaData.filter(record => {
                // Arama filtresi
                const searchMatch = !searchTerm || 
                    String(record.supplier || '').toLowerCase().includes(searchTerm) ||
                    String(record.materialCode || '').toLowerCase().includes(searchTerm) ||
                    String(record.lotNumber || '').toLowerCase().includes(searchTerm) ||
                    String(record.deliveryNo || '').toLowerCase().includes(searchTerm) ||
                    String(record.location || '').toLowerCase().includes(searchTerm);
                
                // Ay filtresi
                const monthMatch = !filterMonth || 
                    (record.deliveryDate && record.deliveryDate.startsWith(filterMonth));
                
                // Tedarik√ßi filtresi
                const supplierMatch = selectedSuppliers.size === 0 || 
                    selectedSuppliers.has(record.supplier);
                
                return searchMatch && monthMatch && supplierMatch;
            });
        }
        
        // ==================== UI Updates ====================
        function updateUI() {
            updateStats();
            renderTable();
            updateBulkActions();
        }
        
        function updateStats() {
            document.getElementById('statTotal').textContent = coaData.length;
            
            const uniqueSuppliers = [...new Set(coaData.map(c => c.supplier))];
            document.getElementById('statSuppliers').textContent = uniqueSuppliers.length;
            
            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthCount = coaData.filter(c => c.deliveryDate?.startsWith(thisMonth)).length;
            document.getElementById('statThisMonth').textContent = thisMonthCount;
            
            // Toplam dosya boyutunu hesapla - √∂nce fileSize kullan, yoksa fileData'dan hesapla
            let totalBytes = 0;
            let fromFileSize = 0;
            let fromFileData = 0;
            
            coaData.forEach(c => {
                if (c.fileSize) {
                    // Drive'dan gelen ger√ßek dosya boyutu (bytes)
                    totalBytes += parseInt(c.fileSize);
                    fromFileSize++;
                } else if (c.fileData) {
                    // Base64 boyutunu ger√ßek boyuta √ßevir (base64 %33 daha b√ºy√ºk)
                    const base64Length = c.fileData.length;
                    const realSize = Math.ceil(base64Length * 0.75);
                    totalBytes += realSize;
                    fromFileData++;
                }
            });
            
            const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
            document.getElementById('statTotalSize').textContent = totalMB + ' MB';
            
            console.log('üìä Dosya boyutu istatistikleri:');
            console.log('- fileSize kullanan:', fromFileSize);
            console.log('- fileData kullanan:', fromFileData);
            console.log('- Toplam:', totalMB, 'MB');
        }
        
        function renderTable() {
            const tbody = document.getElementById('coaTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('coaTable');
            
            const filtered = getFilteredData();
            
            if (filtered.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = filtered.map(c => {
                const isChecked = selectedItems.has(c.id) ? 'checked' : '';
                
                // Dosya √∂nizlemesi - t√ºm dosyalar i√ßin ikon g√∂ster
                let filePreview = getFileIcon(c.fileName, c.fileType, c.id);
                
                const onlineIcon = c.fileData ? ' üíæ' : (c.fileUrl ? ' ‚òÅÔ∏è' : '');
                
                // Dosya boyutunu hesapla
                let fileSizeDisplay = '-';
                if (c.fileSize) {
                    const sizeInMB = (c.fileSize / (1024 * 1024)).toFixed(2);
                    fileSizeDisplay = sizeInMB + ' MB';
                } else if (c.fileData) {
                    const base64Length = c.fileData.length;
                    const sizeInBytes = Math.ceil(base64Length * 0.75);
                    const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
                    fileSizeDisplay = sizeInMB + ' MB';
                }
                
                return '<tr>' +
                    '<td><input type="checkbox" class="row-checkbox" data-id="' + c.id + '" onchange="toggleRowSelection(\'' + c.id + '\')" ' + isChecked + ' style="cursor: pointer;"></td>' +
                    '<td>' + filePreview + '</td>' +
                    '<td><strong>' + c.supplier + '</strong>' + onlineIcon + '</td>' +
                    '<td>' + c.materialCode + '</td>' +
                    '<td>' + formatDate(c.deliveryDate) + '</td>' +
                    '<td>' + (c.deliveryNo || '-') + '</td>' +
                    '<td>' + (c.lotNumber || '-') + '</td>' +
                    '<td style="font-size: 0.85em; color: #666;">' + fileSizeDisplay + '</td>' +
                    '<td>' + (c.location || '-') + '</td>' +
                    '<td class="actions">' +
                        '<button class="btn btn-secondary btn-sm" onclick="viewFile(\'' + c.id + '\')" title="G√∂r√ºnt√ºle">üëÅ</button>' +
                        '<button class="btn btn-secondary btn-sm" onclick="downloadFile(\'' + c.id + '\')" title="ƒ∞ndir">üì•</button>' +
                        '<button class="btn btn-primary btn-sm" onclick="editCOA(\'' + c.id + '\')" title="D√ºzenle">‚úèÔ∏è</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteCOA(\'' + c.id + '\')" title="Sil">üóë</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }
        
        function getFilteredData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const month = document.getElementById('filterMonth').value;
            
            return coaData.filter(c => {
                const matchSearch = !search || 
                    String(c.supplier || '').toLowerCase().includes(search) ||
                    String(c.materialCode || '').toLowerCase().includes(search) ||
                    String(c.deliveryNo || '').toLowerCase().includes(search) ||
                    String(c.lotNumber || '').toLowerCase().includes(search) ||
                    String(c.location || '').toLowerCase().includes(search);
                    
                // √áoklu tedarik√ßi filtresi: Hi√ß se√ßilmemi≈üse t√ºm√ºn√º g√∂ster, se√ßilmi≈üse sadece se√ßilenleri g√∂ster
                const matchSupplier = selectedSuppliers.size === 0 || selectedSuppliers.has(c.supplier);
                const matchMonth = !month || String(c.deliveryDate || '').startsWith(month);
                
                return matchSearch && matchSupplier && matchMonth;
            });
        }
        
        function filterList() {
            renderTable();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR');
        }
        
        // ==================== Toast ====================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), duration);
        }
        
        // ==================== TDS MANAGEMENT ====================
        
        // OCR.space API ile OCR i≈ülemi
        async function performOCRSpaceOCR(imageData) {
            console.log('üü¢ OCR.space API isteƒüi hazƒ±rlanƒ±yor...');
            showToast('üîç OCR i≈ülemi ba≈üladƒ± (OCR.space)', 'info', 3000);
            
            // API key al
            const apiKey = localStorage.getItem('ocrspace_api_key') || 'K82811583888957';
            console.log('üîë API Key:', apiKey.substring(0, 5) + '...');
            
            // Base64'√º blob'a √ßevir
            console.log('üì¶ Blob olu≈üturuluyor...');
            const base64Data = imageData.split(',')[1];
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/png' });
            console.log('‚úÖ Blob olu≈üturuldu:', Math.round(blob.size / 1024), 'KB');
            
            // FormData olu≈ütur - mobil i√ßin optimize edilmi≈ü parametreler
            const formData = new FormData();
            formData.append('file', blob, 'coa.png');
            formData.append('apikey', apiKey);
            formData.append('language', 'eng');
            formData.append('isOverlayRequired', 'false');
            formData.append('detectOrientation', 'true');
            formData.append('scale', 'true'); // Otomatik upscaling
            formData.append('OCREngine', '2'); // Engine 2 daha iyi
            formData.append('isTable', 'true'); // Tablo modu
            formData.append('filetype', 'PNG'); // PNG format
            console.log('‚úÖ FormData hazƒ±r');
            
            console.log('üåê API\'ye istek g√∂nderiliyor...');
            const response = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData
            });
            console.log('üì° API yanƒ±t aldƒ±, status:', response.status);
            
            if (!response.ok) {
                throw new Error(`OCR API hatasƒ±: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('üîç OCR.space Response:', result);
            
            if (!result.IsErroredOnProcessing && result.ParsedResults && result.ParsedResults.length > 0) {
                const text = result.ParsedResults[0].ParsedText;
                console.log('‚úÖ OCR.space ba≈üarƒ±lƒ±:', text.length, 'karakter');
                return text;
            } else {
                const errorMsg = result.ErrorMessage || result.OCRExitCode || 'OCR ba≈üarƒ±sƒ±z';
                console.error('‚ùå OCR sonucu hatalƒ±:', errorMsg);
                throw new Error(errorMsg);
            }
        }
        
        // OCR ile COA'dan √∂zellikleri √ßƒ±kar
        async function performAzureOCR(imageData) {
            console.log('üîµ Azure Computer Vision OCR ba≈ülatƒ±lƒ±yor...');
            
            const azureKey = localStorage.getItem('azure_api_key');
            const azureEndpoint = localStorage.getItem('azure_endpoint');
            
            if (!azureKey || !azureEndpoint) {
                throw new Error('Azure API key veya endpoint tanƒ±mlƒ± deƒüil');
            }
            
            // Base64'√º binary'ye √ßevir
            const base64Data = imageData.split(',')[1];
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            
            console.log('üì¶ Image binary boyutu:', Math.round(byteArray.length / 1024), 'KB');
            
            // Azure Read API - async i≈ülem ba≈ülat
            const analyzeUrl = `${azureEndpoint}/vision/v3.2/read/analyze`;
            
            console.log('üåê Azure analyze isteƒüi g√∂nderiliyor...');
            const analyzeResponse = await fetch(analyzeUrl, {
                method: 'POST',
                headers: {
                    'Ocp-Apim-Subscription-Key': azureKey,
                    'Content-Type': 'application/octet-stream'
                },
                body: byteArray
            });
            
            if (!analyzeResponse.ok) {
                const errorText = await analyzeResponse.text();
                console.error('‚ùå Azure analyze hatasƒ±:', errorText);
                throw new Error(`Azure analyze hatasƒ±: ${analyzeResponse.status} - ${errorText}`);
            }
            
            // Operation-Location header'ƒ±ndan sonu√ß URL'ini al
            const operationLocation = analyzeResponse.headers.get('Operation-Location');
            if (!operationLocation) {
                throw new Error('Azure Operation-Location header bulunamadƒ±');
            }
            
            console.log('‚è≥ Azure OCR i≈üleniyor, sonu√ß bekleniyor...');
            showToast('‚è≥ Azure OCR i≈üleniyor (5-10 saniye)...', 'info', 10000);
            
            // Sonu√ß i√ßin polling yap (max 30 saniye)
            let resultResponse;
            let attempts = 0;
            const maxAttempts = 30;
            
            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 saniye bekle
                attempts++;
                
                resultResponse = await fetch(operationLocation, {
                    headers: {
                        'Ocp-Apim-Subscription-Key': azureKey
                    }
                });
                
                if (!resultResponse.ok) {
                    throw new Error(`Azure sonu√ß hatasƒ±: ${resultResponse.status}`);
                }
                
                const result = await resultResponse.json();
                
                if (result.status === 'succeeded') {
                    console.log('‚úÖ Azure OCR tamamlandƒ±');
                    console.log('üìù Azure yanƒ±tƒ±:', result);
                    
                    // Line-by-line array + full result d√∂nd√ºr
                    const linesArray = [];
                    const wordsArray = [];
                    
                    if (result.analyzeResult && result.analyzeResult.readResults) {
                        result.analyzeResult.readResults.forEach(page => {
                            // Satƒ±rlarƒ± topla
                            page.lines.forEach(line => {
                                linesArray.push(line.text);
                            });
                            
                            // Kelimeleri topla (koordinatlarƒ±yla birlikte)
                            if (page.words) {
                                page.words.forEach(word => {
                                    wordsArray.push({
                                        text: word.text,
                                        x: word.boundingBox[0], // Sol √ºst x koordinatƒ±
                                        y: word.boundingBox[1], // Sol √ºst y koordinatƒ±
                                        confidence: word.confidence
                                    });
                                });
                            }
                        });
                    }
                    
                    console.log('üìù Azure OCR toplam satƒ±r:', linesArray.length);
                    console.log('üìù Azure OCR toplam kelime:', wordsArray.length);
                    console.log('üìù ƒ∞lk 10 satƒ±r:', linesArray.slice(0, 10));
                    
                    // Parse etmek i√ßin satƒ±rlarƒ±, kelimeleri ve tam result'ƒ± d√∂nd√ºr
                    return { 
                        text: linesArray.join('\n'), 
                        lines: linesArray,
                        words: wordsArray,
                        fullResult: result
                    };
                } else if (result.status === 'failed') {
                    throw new Error('Azure OCR ba≈üarƒ±sƒ±z oldu');
                }
                
                // Hala running durumunda, bekle
                console.log(`‚è≥ Deneme ${attempts}/${maxAttempts}, durum: ${result.status}`);
            }
            
            throw new Error('Azure OCR zaman a≈üƒ±mƒ± (30 saniye)');
        }
        
        async function extractCOAProperties(fileData) {
            console.log('üöÄ extractCOAProperties fonksiyonu √ßaƒürƒ±ldƒ±');
            
            return new Promise(async (resolve, reject) => {
                try {
                    if (!fileData) {
                        console.error('‚ùå fileData bo≈ü!');
                        reject(new Error('Dosya verisi bulunamadƒ±'));
                        return;
                    }
                    
                    console.log('üìÑ Dosya tipi:', fileData.substring(0, 50));
                    console.log('üìä Dosya boyutu:', Math.round(fileData.length / 1024), 'KB');
                    
                    // PDF ise √∂nce canvas'a √ßevir (orijinal dosyayƒ± etkilemeden)
                    let imageData = fileData;
                    if (fileData.startsWith('data:application/pdf')) {
                        console.log('üìÑ PDF tespit edildi, resme d√∂n√º≈üt√ºr√ºl√ºyor...');
                        showToast('üìÑ PDF resme d√∂n√º≈üt√ºr√ºl√ºyor...', 'info');
                        try {
                            // PDF'i canvas'a √ßevir
                            const base64Data = fileData.split(',')[1];
                            const binaryData = atob(base64Data);
                            const uint8Array = new Uint8Array(binaryData.length);
                            for (let i = 0; i < binaryData.length; i++) {
                                uint8Array[i] = binaryData.charCodeAt(i);
                            }
                            
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            const pdf = await pdfjsLib.getDocument({ data: uint8Array }).promise;
                            const page = await pdf.getPage(1); // ƒ∞lk sayfa
                            
                            // OCR engine'e g√∂re scale ayarla
                            const ocrEngine = localStorage.getItem('ocr_engine') || 'ocrspace';
                            let scale = 5.0; // Varsayƒ±lan: ultra y√ºksek kalite
                            
                            // OCR.space i√ßin dosya boyutu limiti var (1 MB), scale'i d√º≈ü√ºr
                            if (ocrEngine === 'ocrspace') {
                                scale = 2.0; // Daha d√º≈ü√ºk scale = daha k√º√ß√ºk dosya (genelde 300-600 KB)
                                console.log('üîß OCR.space i√ßin scale=2.0 kullanƒ±lƒ±yor (dosya boyutu optimizasyonu)');
                            } else {
                                scale = 5.0; // Azure i√ßin y√ºksek kalite
                                console.log('üîß Azure i√ßin scale=5.0 kullanƒ±lƒ±yor (maksimum kalite)');
                            }
                            
                            const viewport = page.getViewport({ scale: scale });
                            const canvas = document.createElement('canvas');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            const ctx = canvas.getContext('2d');
                            
                            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                            imageData = canvas.toDataURL('image/png');
                            console.log(`‚úÖ PDF resme d√∂n√º≈üt√ºr√ºld√º (scale=${scale})`);
                        } catch (pdfError) {
                            console.error('‚ùå PDF d√∂n√º≈üt√ºrme hatasƒ±:', pdfError);
                            showToast('‚ùå PDF okunamadƒ±', 'error');
                            reject(pdfError);
                            return;
                        }
                    }
                    
                    // OCR engine se√ßimi
                    const ocrEngine = localStorage.getItem('ocr_engine') || 'ocrspace';
                    console.log('üîß Se√ßili OCR motoru:', ocrEngine);
                    
                    let text = '';
                    let lines = []; // Azure i√ßin satƒ±r dizisi
                    let words = []; // Azure words (koordinatlarƒ±yla)
                    let ocrSuccess = false;
                    
                    // OCR motoruna g√∂re i≈ülem yap
                    if (ocrEngine === 'azure') {
                        // Sadece Azure kullan
                        try {
                            console.log('üîµ Azure OCR kullanƒ±lƒ±yor...');
                            const azureResult = await performAzureOCR(imageData);
                            text = azureResult.text;
                            lines = azureResult.lines;
                            words = azureResult.words || [];
                            ocrSuccess = true;
                        } catch (azureError) {
                            console.error('‚ùå Azure OCR hatasƒ±:', azureError);
                            showToast('‚ùå Azure OCR hatasƒ±: ' + azureError.message, 'error');
                            reject(azureError);
                            return;
                        }
                    } else if (ocrEngine === 'both') {
                        // ƒ∞kisini de dene, hangisi daha fazla √∂zellik bulursa onu kullan
                        console.log('üîÑ Her iki OCR motoru da denenecek...');
                        
                        let ocrSpaceText = '';
                        let azureResult = null;
                        
                        // OCR.space dene
                        try {
                            console.log('1Ô∏è‚É£ OCR.space deneniyor...');
                            ocrSpaceText = await performOCRSpaceOCR(imageData);
                            console.log('‚úÖ OCR.space tamamlandƒ±:', ocrSpaceText.length, 'karakter');
                        } catch (ocrSpaceError) {
                            console.warn('‚ö†Ô∏è OCR.space ba≈üarƒ±sƒ±z:', ocrSpaceError.message);
                        }
                        
                        // Azure dene
                        try {
                            console.log('2Ô∏è‚É£ Azure deneniyor...');
                            azureResult = await performAzureOCR(imageData);
                            console.log('‚úÖ Azure tamamlandƒ±:', azureResult.text.length, 'karakter');
                        } catch (azureError) {
                            console.warn('‚ö†Ô∏è Azure ba≈üarƒ±sƒ±z:', azureError.message);
                        }
                        
                        // Hangisi daha uzun sonu√ß verdi? (genelde daha fazla √∂zellik demektir)
                        if (azureResult && azureResult.text.length > ocrSpaceText.length) {
                            console.log('üèÜ Azure daha iyi sonu√ß verdi');
                            text = azureResult.text;
                            lines = azureResult.lines;
                            ocrSuccess = true;
                        } else if (ocrSpaceText.length > 0) {
                            console.log('üèÜ OCR.space daha iyi sonu√ß verdi');
                            text = ocrSpaceText;
                            lines = []; // OCR.space satƒ±r dizisi yok
                            ocrSuccess = true;
                        } else {
                            throw new Error('Her iki OCR motoru da ba≈üarƒ±sƒ±z oldu');
                        }
                    } else {
                        // Varsayƒ±lan: OCR.space kullan
                        try {
                            console.log('üü¢ OCR.space kullanƒ±lƒ±yor...');
                            text = await performOCRSpaceOCR(imageData);
                            lines = []; // OCR.space satƒ±r dizisi yok
                            ocrSuccess = true;
                        } catch (ocrSpaceError) {
                            console.error('‚ùå OCR.space hatasƒ±:', ocrSpaceError);
                            showToast('‚ùå OCR.space hatasƒ±: ' + ocrSpaceError.message, 'error');
                            reject(ocrSpaceError);
                            return;
                        }
                    }
                    
                    if (!ocrSuccess || !text) {
                        throw new Error('OCR metni alƒ±namadƒ±');
                    }
                    
                    console.log('üìù OCR Text uzunluƒüu:', text.length, 'karakter');
                    
                    // √ñzellikleri parse et
                    const properties = {};
                    
                    // Azure words varsa koordinatlarla parse et (EN DOƒûRU Y√ñNTEM)
                    if (words && words.length > 0) {
                        console.log('üéØ Azure word koordinatlarƒ± kullanƒ±lƒ±yor...');
                        console.log('üì¶ Toplam kelime:', words.length);
                        
                        // "TEST RESULT" ba≈ülƒ±ƒüƒ±nƒ±n x koordinatƒ±nƒ± bul
                        let testResultX = null;
                        for (let i = 0; i < words.length; i++) {
                            const word = words[i];
                            if (word.text.toUpperCase().includes('RESULT') || 
                                word.text.toUpperCase().includes('SONU√á') ||
                                word.text.toUpperCase().includes('TEST')) {
                                testResultX = word.x;
                                console.log(`‚úÖ TEST RESULT s√ºtunu bulundu, x = ${testResultX}, word: "${word.text}"`);
                                break;
                            }
                        }
                        
                        if (testResultX === null) {
                            console.warn('‚ö†Ô∏è TEST RESULT ba≈ülƒ±ƒüƒ± bulunamadƒ±, fallback mode');
                        } else {
                            // Her √∂zellik i√ßin TEST RESULT s√ºtunundaki deƒüeri bul
                            const propertyPatterns = [
                                { tr: 'Dansite', en: 'DENSITY', key: 'Density' },
                                { tr: 'Sertlik', en: 'HARDNESS', key: 'Sertlik' },
                                { tr: 'Kopma Direnci', en: 'TENSILE', key: 'Kopma Direnci' },
                                { tr: 'Kopma Uzama', en: 'ELONGATION', key: 'Kopma Uzama' },
                                { tr: 'Elastikiyet', en: 'RESILIENCE', key: 'Elastikiyet' },
                                { tr: 'Deformasyon', en: 'COMPRESSION', key: 'Deformasyon' }
                            ];
                            
                            for (const pattern of propertyPatterns) {
                                // Bu √∂zelliƒüin y koordinatƒ±nƒ± bul
                                let propertyY = null;
                                for (let i = 0; i < words.length; i++) {
                                    const word = words[i];
                                    if (word.text.includes(pattern.tr) || 
                                        word.text.toUpperCase().includes(pattern.en)) {
                                        propertyY = word.y;
                                        console.log(`üéØ ${pattern.key} bulundu, y = ${propertyY}`);
                                        break;
                                    }
                                }
                                
                                if (propertyY !== null) {
                                    // Bu satƒ±rda (y¬±20 tolerance) ve TEST RESULT s√ºtununda (x¬±50) olan sayƒ±yƒ± bul
                                    for (let i = 0; i < words.length; i++) {
                                        const word = words[i];
                                        
                                        // Aynƒ± satƒ±rda mƒ±? (y koordinatƒ± yakƒ±n)
                                        if (Math.abs(word.y - propertyY) > 30) continue;
                                        
                                        // TEST RESULT s√ºtununda mƒ±? (x koordinatƒ± yakƒ±n)
                                        if (Math.abs(word.x - testResultX) > 100) continue;
                                        
                                        // Sayƒ± mƒ±?
                                        const cleaned = word.text.replace(/,/g, '.');
                                        const value = parseFloat(cleaned);
                                        
                                        if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                            console.log(`  ‚úÖ ${pattern.key} = ${cleaned} (x=${word.x}, y=${word.y})`);
                                            properties[pattern.key] = cleaned;
                                            properties[pattern.key.toLowerCase()] = cleaned;
                                            properties[pattern.tr] = cleaned;
                                            properties[pattern.tr.toLowerCase()] = cleaned;
                                            break;
                                        }
                                    }
                                }
                            }
                            
                            console.log('üìä Koordinat bazlƒ± √ßƒ±karƒ±m tamamlandƒ±:', properties);
                        }
                    }
                    
                    // Fallback: Eski parsing (koordinat bazlƒ± ba≈üarƒ±sƒ±zsa veya OCR.space kullanƒ±lƒ±yorsa)
                    if (Object.keys(properties).length === 0) {
                        console.log('‚ö†Ô∏è Fallback parsing kullanƒ±lƒ±yor...');
                        
                        // Her √∂zellik i√ßin arama patterns (√ßoklu varyasyonlarla)
                        const propertyPatterns = [
                            { 
                                tr: 'Dansite', 
                                en: ['DENSITY', 'TOTAL WEIGHT', 'WEIGHT'], 
                                key: 'Density',
                                aliases: ['dansite', 'density', 'total weight', 'weight', 'aƒüƒ±rlƒ±k']
                            },
                            { 
                                tr: 'Sertlik', 
                                en: ['HARDNESS'], 
                                key: 'Sertlik',
                                aliases: ['sertlik', 'hardness']
                            },
                            { 
                                tr: 'Kopma Direnci', 
                                en: ['TENSILE STRENGTH', 'TENSILE STRENGHT', 'TENSILE'], 
                                key: 'Kopma Direnci',
                                aliases: ['kopma direnci', 'tensile strength', 'tensile', '√ßekme mukavemeti']
                            },
                            { 
                                tr: 'Kopma Uzama', 
                                en: ['ELONGATION AT BREAK', 'ELONGATION', 'BREAK ELONGATION'], 
                                key: 'Kopma Uzama',
                                aliases: ['kopma uzama', 'elongation', 'uzama']
                            },
                            { 
                                tr: 'Elastikiyet', 
                                en: ['RESILIENCE', 'REBOUND'], 
                                key: 'Elastikiyet',
                                aliases: ['elastikiyet', 'resilience', 'rebound']
                            },
                            { 
                                tr: 'Deformasyon', 
                                en: ['COMPRESSION SET', 'COMPRESSION'], 
                                key: 'Deformasyon',
                                aliases: ['deformasyon', 'compression set', 'compression']
                            }
                        ];
                        
                        // Azure: line-based parsing (satƒ±r satƒ±r yapƒ±landƒ±rƒ±lmƒ±≈ü)
                        if (lines.length > 0) {
                            console.log('üìã Azure line-based parsing (satƒ±r satƒ±r)');
                            console.log('üìã Toplam satƒ±r:', lines.length);
                            console.log('üìã ƒ∞lk 15 satƒ±r:', lines.slice(0, 15));
                            
                            for (const pattern of propertyPatterns) {
                                // Bu √∂zelliƒüin herhangi bir varyasyonunu i√ßeren satƒ±rƒ± bul
                                let propertyLineIndex = -1;
                                
                                for (let i = 0; i < lines.length; i++) {
                                    const line = lines[i];
                                    const lineUpper = line.toUpperCase();
                                    const lineLower = line.toLowerCase();
                                    
                                    // T√ºrk√ße adƒ± kontrol et
                                    if (line.includes(pattern.tr)) {
                                        propertyLineIndex = i;
                                        console.log(`üéØ ${pattern.key} bulundu (TR, satƒ±r ${i}): "${line}"`);
                                        break;
                                    }
                                    
                                    // ƒ∞ngilizce varyasyonlarƒ± kontrol et
                                    const enVariants = Array.isArray(pattern.en) ? pattern.en : [pattern.en];
                                    for (const enVariant of enVariants) {
                                        if (lineUpper.includes(enVariant)) {
                                            propertyLineIndex = i;
                                            console.log(`üéØ ${pattern.key} bulundu (EN: "${enVariant}", satƒ±r ${i}): "${line}"`);
                                            break;
                                        }
                                    }
                                    
                                    if (propertyLineIndex !== -1) break;
                                }
                                
                                if (propertyLineIndex === -1) {
                                    console.log(`‚ö†Ô∏è ${pattern.key} bulunamadƒ±`);
                                    continue;
                                }
                                
                                // Bu satƒ±rdan SONRA, ilk SADE SAYIYI bul (¬±, >, < i√ßermeyen)
                                let testValue = null;
                                for (let i = propertyLineIndex + 1; i < Math.min(propertyLineIndex + 8, lines.length); i++) {
                                    const line = lines[i].trim();
                                    
                                    if (!line) continue;
                                    if (/ISO\s*\d+|ASTM|SO\d+/i.test(line)) {
                                        console.log(`    ‚è≠Ô∏è Standart atlandƒ±: "${line}"`);
                                        continue;
                                    }
                                    if (/[¬±‚â§‚â•><+%()]/.test(line)) {
                                        console.log(`    ‚è≠Ô∏è Standart deƒüer atlandƒ±: "${line}"`);
                                        continue;
                                    }
                                    
                                    if (/^[\d.,]+$/.test(line)) {
                                        const cleaned = line.replace(/,/g, '.');
                                        const value = parseFloat(cleaned);
                                        
                                        if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                            testValue = cleaned;
                                            console.log(`    ‚úÖ ${pattern.key} TEST RESULT bulundu: "${line}" ‚Üí ${testValue} (satƒ±r ${i})`);
                                            break;
                                        }
                                    }
                                }
                                
                                if (testValue) {
                                    properties[pattern.key] = testValue;
                                    properties[pattern.key.toLowerCase()] = testValue;
                                    properties[pattern.tr] = testValue;
                                    properties[pattern.tr.toLowerCase()] = testValue;
                                } else {
                                    console.log(`    ‚ùå ${pattern.key} i√ßin TEST RESULT bulunamadƒ±`);
                                }
                            }
                        } 
                        // OCR.space: regex-based parsing (t√ºm text tek blok)
                        else {
                            console.log('üü¢ OCR.space regex-based parsing');
                            console.log('üìù Text uzunluƒüu:', text.length, 'karakter');
                            console.log('üìù ƒ∞lk 500 karakter:', text.substring(0, 500));
                            
                            for (const pattern of propertyPatterns) {
                                console.log(`\nüîç ${pattern.key} aranƒ±yor...`);
                                
                                // T√ºm varyasyonlarƒ± i√ßeren regex olu≈ütur
                                const enVariants = Array.isArray(pattern.en) ? pattern.en : [pattern.en];
                                const allVariants = [pattern.tr, ...enVariants];
                                const searchPattern = `(${allVariants.join('|')})`;
                                const regex = new RegExp(searchPattern, 'i');
                                const match = text.match(regex);
                                
                                if (match) {
                                    const matchIndex = match.index;
                                    console.log(`  ‚úÖ "${match[0]}" bulundu (index: ${matchIndex})`);
                                    
                                    // Bu √∂zellikten sonraki 300 karakteri al
                                    const afterProperty = text.substring(matchIndex + match[0].length, matchIndex + match[0].length + 300);
                                    console.log(`  üì¶ Chunk (${afterProperty.length} karakter):`, afterProperty.substring(0, 100));
                                    
                                    // TAB veya √ßok bo≈ülukla ayrƒ±lmƒ±≈ü kolonlarƒ± parse et
                                    // Format: Dansite\tDENSITY\tkg/m3\tISO845\t18+1,5\t17,54
                                    const parts = afterProperty.split(/[\t\n]+/).map(p => p.trim()).filter(p => p);
                                    console.log(`  üîß Parse edilen par√ßalar:`, parts);
                                    
                                    // Par√ßalardan SADE SAYILARI bul (¬±, >, <, +, % i√ßermeyenler)
                                    for (const part of parts) {
                                        // ƒ∞√ßinde ¬±, >, <, +, % varsa atla (standart deƒüer)
                                        if (/[¬±‚â§‚â•><+%()]/.test(part)) {
                                            console.log(`    ‚è≠Ô∏è Standart atlandƒ±: "${part}"`);
                                            continue;
                                        }
                                        
                                        // ISO/ASTM atla
                                        if (/ISO|ASTM|STANDARD/i.test(part)) {
                                            console.log(`    ‚è≠Ô∏è ISO/ASTM atlandƒ±: "${part}"`);
                                            continue;
                                        }
                                        
                                        // Sadece sayƒ± + virg√ºl/nokta mƒ±?
                                        if (/^\d+[.,]?\d*$/.test(part)) {
                                            const cleaned = part.replace(/,/g, '.');
                                            const value = parseFloat(cleaned);
                                            
                                            if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                                console.log(`    ‚úÖ ${pattern.key} TEST RESULT = ${cleaned}`);
                                                properties[pattern.key] = cleaned;
                                                properties[pattern.key.toLowerCase()] = cleaned;
                                                properties[pattern.tr] = cleaned;
                                                properties[pattern.tr.toLowerCase()] = cleaned;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // Eƒüer yukarƒ±daki y√∂ntem ba≈üarƒ±sƒ±zsa, fallback: regex ile sayƒ± ara
                                    if (!properties[pattern.key]) {
                                        console.log(`  üîÑ Fallback: Regex ile sayƒ± aranƒ±yor...`);
                                        const numberMatches = afterProperty.match(/\b\d+[.,]\d+\b/g);
                                        
                                        if (numberMatches && numberMatches.length > 0) {
                                            console.log(`  üìä Bulunan sayƒ±lar:`, numberMatches);
                                            
                                            // ƒ∞lk sade sayƒ±yƒ± al
                                            for (const numStr of numberMatches) {
                                                const cleaned = numStr.replace(/,/g, '.');
                                                const value = parseFloat(cleaned);
                                                
                                                if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                                    console.log(`    ‚úÖ ${pattern.key} TEST RESULT (fallback) = ${cleaned}`);
                                                    properties[pattern.key] = cleaned;
                                                    properties[pattern.key.toLowerCase()] = cleaned;
                                                    properties[pattern.tr] = cleaned;
                                                    properties[pattern.tr.toLowerCase()] = cleaned;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    console.log(`  ‚ùå "${pattern.tr}" veya "${pattern.en}" bulunamadƒ±`);
                                }
                            }
                        }
                        
                        // √ñNEMLƒ∞: "INSPECTED VALUES" parsing - T√úM OCR MOTORLARI ƒ∞√áƒ∞N
                        // Bu format: Carcano gibi firmalarƒ±n COA'larƒ±nda kullanƒ±lƒ±r
                        // Azure veya OCR.space hi√ßbir deƒüer bulamadƒ±ysa burasƒ± √ßalƒ±≈üƒ±r
                        if (Object.keys(properties).length === 0) {
                            console.log('\nüîç INSPECTED VALUES ba≈ülƒ±ƒüƒ± aranƒ±yor...');
                            
                            // "INSPECTED VALUES" veya "AVERAGE VALUE" ba≈ülƒ±ƒüƒ±nƒ± bul
                            const inspectedMatch = text.match(/(INSPECTED VALUES|AVERAGE VALUE OF THE LOT|TEST RESULTS|MEASURED VALUES)/i);
                                
                                if (inspectedMatch) {
                                    console.log(`‚úÖ "${inspectedMatch[0]}" ba≈ülƒ±ƒüƒ± bulundu (index: ${inspectedMatch.index})!`);
                                    
                                    // Bu ba≈ülƒ±ktan sonraki 500 karakteri al (√ñNCEKƒ∞ DEƒûƒ∞L!)
                                    const startIndex = inspectedMatch.index + inspectedMatch[0].length;
                                    const inspectedChunk = text.substring(startIndex, startIndex + 500);
                                    console.log('üì¶ Inspected chunk:', inspectedChunk.substring(0, 200));
                                    
                                    // Bu chunk i√ßinde TAB-separated deƒüerleri parse et
                                    // Format: Total weight (g/m¬≤) | Tensile strength (N/mm¬≤) | Elongation (%)
                                    //         137.0               | 86.7                     | 13.3
                                    
                                    const inspectedLines = inspectedChunk.split(/[\n\r]+/).map(l => l.trim()).filter(l => l);
                                    console.log('üìã Inspected lines:', inspectedLines.slice(0, 10));
                                    
                                    // ƒ∞lk satƒ±r genelde ba≈ülƒ±klar (optional)
                                    // Sonraki satƒ±rlarda sayƒ±lar var
                                    
                                    // Her satƒ±rƒ± parse et, TAB ile ayrƒ±lmƒ±≈ü sayƒ±larƒ± bul
                                    for (const line of inspectedLines) {
                                        // "Average value of the lot" gibi ba≈ülƒ±k satƒ±rlarƒ± atla
                                        if (/average|value|lot/i.test(line)) continue;
                                        
                                        // TAB ile ayrƒ±lmƒ±≈ü par√ßalara b√∂l
                                        const parts = line.split(/[\t]+/).map(p => p.trim()).filter(p => p);
                                        
                                        // Sadece sayƒ±larƒ± al
                                        const numbers = parts.filter(p => /^\d+[.,]?\d*$/.test(p));
                                        
                                        if (numbers.length >= 2) {
                                            console.log(`üî¢ Sayƒ±lar bulundu:`, numbers);
                                            
                                            // ƒ∞lk 3 sayƒ±yƒ± √∂zelliklere e≈üle:
                                            // numbers[0] = Total weight (Density)
                                            // numbers[1] = Tensile strength (Kopma Direnci)
                                            // numbers[2] = Elongation (Kopma Uzama)
                                            
                                            if (numbers[0]) {
                                                const val0 = numbers[0].replace(/,/g, '.');
                                                properties['Density'] = val0;
                                                properties['density'] = val0;
                                                properties['Dansite'] = val0;
                                                properties['dansite'] = val0;
                                                console.log(`  ‚úÖ Density (inspected) = ${val0}`);
                                            }
                                            
                                            if (numbers[1]) {
                                                const val1 = numbers[1].replace(/,/g, '.');
                                                properties['Kopma Direnci'] = val1;
                                                properties['kopma direnci'] = val1;
                                                console.log(`  ‚úÖ Kopma Direnci (inspected) = ${val1}`);
                                            }
                                            
                                            if (numbers[2]) {
                                                const val2 = numbers[2].replace(/,/g, '.');
                                                properties['Kopma Uzama'] = val2;
                                                properties['kopma uzama'] = val2;
                                                console.log(`  ‚úÖ Kopma Uzama (inspected) = ${val2}`);
                                            }
                                            
                                            break; // ƒ∞lk sayƒ± satƒ±rƒ±nƒ± bulduk, √ßƒ±k
                                        }
                                    }
                                } else {
                                    console.log('‚ö†Ô∏è INSPECTED VALUES ba≈ülƒ±ƒüƒ± bulunamadƒ±');
                                }
                        }
                    } // Fallback bloƒüu sonu
                    
                    console.log('üìä √áƒ±karƒ±lan √ñzellikler:', properties);
                    const propCount = Object.keys(properties).length;
                    
                    if (propCount > 0) {
                        showToast(`‚úÖ ${propCount} √∂zellik bulundu`, 'success');
                    } else {
                        showToast('‚ö†Ô∏è Hi√ßbir √∂zellik bulunamadƒ±', 'warning');
                    }
                    
                    resolve(properties);
                    
                } catch (error) {
                    console.error('OCR Hatasƒ±:', error);
                    const errorMsg = '‚ùå OCR hatasƒ±: ' + error.message;
                    showToast(errorMsg, 'error', 10000); // 10 saniye g√∂r√ºns√ºn
                    
                    // Mobil i√ßin alert de g√∂ster (daha kolay g√∂r√ºn√ºr)
                    if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                        alert('OCR HATASI:\n\n' + error.message + '\n\nAPI Key: ' + (localStorage.getItem('ocrspace_api_key') || 'K82811583888957').substring(0, 10) + '...');
                    }
                    
                    // Hata durumunda bo≈ü obje d√∂nd√ºr
                    resolve({});
                }
            });
        }
        
        // Benzerlik hesaplama (0-1 arasƒ±, 1=tam e≈üle≈üme)
        function calculateSimilarity(str1, str2) {
            str1 = str1.toLowerCase().trim();
            str2 = str2.toLowerCase().trim();
            
            // Tam e≈üle≈üme
            if (str1 === str2) return 1.0;
            
            // √ñzel durumlar - Sertlik varyasyonlarƒ±
            const hardnessVariants = ['sertlik', 'sertik', 'sertlƒ±k', 'hardness'];
            const isStr1Hardness = hardnessVariants.includes(str1);
            const isStr2Hardness = hardnessVariants.includes(str2);
            if (isStr1Hardness && isStr2Hardness) {
                console.log('  üéØ Sertlik varyasyonu tespit edildi:', str1, '‚âà', str2);
                return 0.95; // √áok y√ºksek benzerlik
            }
            
            // Levenshtein distance (daha doƒüru hesaplama)
            const matrix = [];
            const n = str1.length;
            const m = str2.length;
            
            if (n === 0) return m === 0 ? 1.0 : 0;
            if (m === 0) return 0;
            
            // Matris olu≈ütur
            for (let i = 0; i <= n; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= m; j++) {
                matrix[0][j] = j;
            }
            
            // Mesafe hesapla
            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }
            
            const distance = matrix[n][m];
            const maxLen = Math.max(n, m);
            const similarity = 1 - (distance / maxLen);
            
            return similarity;
        }
        
        // TDS'deki √∂zellikleri COA verileriyle e≈üle≈ütir
        function matchCOAWithTDS(materialCode, coaProperties) {
            console.log('üîç matchCOAWithTDS √ßaƒürƒ±ldƒ±:', materialCode, coaProperties);
            
            if (!tdsData[materialCode]) {
                console.log('‚ö†Ô∏è Bu hammadde i√ßin TDS tanƒ±mlanmamƒ±≈ü:', materialCode);
                showToast('‚ö†Ô∏è Bu hammadde i√ßin TDS tanƒ±mlanmamƒ±≈ü', 'warning');
                return;
            }
            
            const tds = tdsData[materialCode];
            let matchedCount = 0;
            
            console.log('üìã TDS √ñzellikleri:', tds.properties);
            console.log('üìã COA √ñzellikleri:', coaProperties);
            console.log('üìã COA Keys:', Object.keys(coaProperties));
            console.log('üìã COA Values:', Object.values(coaProperties));
            
            // Her TDS √∂zelliƒüi i√ßin COA'da e≈üle≈üme ara
            tds.properties.forEach((prop, propIndex) => {
                const propName = prop.name.toLowerCase().trim();
                
                // Parantez i√ßini temizle (TDS'den)
                const propNameClean = propName.replace(/\s*\([^)]*\)/g, '').trim();
                
                console.log(`\nüîé TDS √ñzelliƒüi [${propIndex}]: "${prop.name}" ‚Üí temiz: "${propNameClean}"`);
                
                let bestMatch = null;
                let bestSimilarity = 0;
                let exactMatchFound = false;
                
                // COA properties i√ßinde en iyi e≈üle≈ümeyi ara
                for (const [coaKey, coaValue] of Object.entries(coaProperties)) {
                    const coaKeyLower = coaKey.toLowerCase().trim();
                    
                    // Parantez i√ßini temizle (COA'dan)
                    const coaKeyClean = coaKeyLower.replace(/\s*\([^)]*\)/g, '').trim();
                    
                    console.log(`   üîç COA: "${coaKey}" ‚Üí clean: "${coaKeyClean}" | TDS clean: "${propNameClean}"`);
                    
                    // √ñZEL DURUM: Sertlik/Hardness √ßapraz e≈üle≈üme
                    const hardnessVariants = ['sertlik', 'sertik', 'sertlƒ±k', 'hardness'];
                    const isTdsHardness = hardnessVariants.includes(propNameClean);
                    const isCoaHardness = hardnessVariants.includes(coaKeyClean);
                    
                    if (isTdsHardness && isCoaHardness) {
                        prop.coaValue = coaValue;
                        matchedCount++;
                        exactMatchFound = true;
                        console.log(`   ‚úÖ SERTLƒ∞K √ñZEL e≈üle≈üme: "${prop.name}" ‚Üî "${coaKey}" = ${coaValue}`);
                        break;
                    }
                    
                    // Tam e≈üle≈üme (temizlenmi≈ü versiyonlarla)
                    if (coaKeyClean === propNameClean || coaKeyLower === propName) {
                        prop.coaValue = coaValue;
                        matchedCount++;
                        exactMatchFound = true;
                        console.log(`   ‚úÖ TAM e≈üle≈üme: "${prop.name}" = ${coaValue}`);
                        break; // Tam e≈üle≈üme bulundu, d√∂ng√ºden √ßƒ±k
                    }
                    
                    // Benzerlik hesapla (temizlenmi≈ü versiyonlarla)
                    const similarity = calculateSimilarity(propNameClean, coaKeyClean);
                    console.log(`   üìä Benzerlik: ${Math.round(similarity * 100)}%`);
                    
                    // %65 ve √ºzeri benzerlik varsa kabul et (daha esnek - "Sertik" vs "Sertlik" i√ßin)
                    if (similarity >= 0.65) {
                        if (similarity > bestSimilarity) {
                            bestSimilarity = similarity;
                            bestMatch = { key: coaKey, value: coaValue };
                            console.log(`   ‚≠ê Yeni en iyi e≈üle≈üme: ${Math.round(similarity * 100)}%`);
                        }
                    }
                    
                    // Kƒ±smi e≈üle≈üme (temizlenmi≈ü versiyonlarla)
                    if (coaKeyClean.includes(propNameClean) || propNameClean.includes(coaKeyClean)) {
                        if (0.85 > bestSimilarity) {
                            bestSimilarity = 0.85;
                            bestMatch = { key: coaKey, value: coaValue };
                            console.log(`   ‚≠ê Kƒ±smi e≈üle≈üme (85%): "${propNameClean}" ‚äÜ "${coaKeyClean}"`);
                        }
                    }
                }
                
                // Tam e≈üle≈üme yoksa benzerlik e≈üle≈ümesini kullan
                if (!exactMatchFound) {
                    if (bestMatch) {
                        prop.coaValue = bestMatch.value;
                        matchedCount++;
                        console.log(`   ‚úÖ BENZERLƒ∞K e≈üle≈üme (${Math.round(bestSimilarity * 100)}%): "${prop.name}" ‚âà "${bestMatch.key}" = ${bestMatch.value}`);
                    } else {
                        console.log(`   ‚ùå E≈üle≈üme bulunamadƒ±: "${prop.name}"`);
                    }
                }
            });
            
            // TDS'yi g√ºncelle
            saveTDSData();
            console.log('üíæ TDS kaydedildi, e≈üle≈üen:', matchedCount);
            
            // NOT: COA_Records'a kaydetme i≈ülemini buradan kaldƒ±rdƒ±k
            // Artƒ±k sadece saveCOA() i√ßinde, kaydet butonuna basƒ±ldƒ±ƒüƒ±nda yapƒ±lacak
            
            if (matchedCount > 0) {
                showToast(`‚úÖ ${matchedCount} √∂zellik e≈üle≈ütirildi, TDS modalƒ±nƒ± a√ßƒ±n`, 'success', 5000);
            } else {
                showToast('‚ö†Ô∏è Hi√ßbir √∂zellik e≈üle≈ütirilemedi', 'warning');
            }
            
            return matchedCount;
        }
        
        // TDS verilerini y√ºkle
        function loadTDSData() {
            const saved = localStorage.getItem('tdsData');
            if (saved) {
                try {
                    tdsData = JSON.parse(saved);
                    
                    // Eski TDS verilerini g√ºncelle: Eksik alanlarƒ± ekle
                    Object.keys(tdsData).forEach(materialCode => {
                        if (tdsData[materialCode] && tdsData[materialCode].properties) {
                            tdsData[materialCode].properties.forEach(prop => {
                                // Operator yoksa varsayƒ±lan 'range' ekle
                                if (!prop.operator) {
                                    prop.operator = 'range';
                                }
                                // standardValue yoksa ama lowerTolerance ve upperTolerance varsa hesapla
                                if (!prop.standardValue && prop.lowerTolerance && prop.upperTolerance) {
                                    // Min ve max'tan ortayƒ± al
                                    if (prop.min && prop.max) {
                                        const minVal = parseFloat(prop.min);
                                        const maxVal = parseFloat(prop.max);
                                        prop.standardValue = ((minVal + maxVal) / 2).toFixed(2);
                                    }
                                }
                            });
                        }
                    });
                    
                    console.log('‚úÖ TDS verileri y√ºklendi ve g√ºncellendi');
                } catch (e) {
                    console.error('TDS y√ºkleme hatasƒ±:', e);
                    tdsData = {};
                }
            }
        }
        
        // TDS verilerini kaydet
        function saveTDSData() {
            localStorage.setItem('tdsData', JSON.stringify(tdsData));
            // Google Sheets'e senkronize et (sadece deƒüi≈üen hammadde)
            if (currentTDSMaterial && tdsData[currentTDSMaterial]) {
                syncTDSToGoogleSheets(currentTDSMaterial, tdsData[currentTDSMaterial].properties);
            }
        }
        
        // Google Sheets'e TDS senkronizasyonu
        async function syncTDSToGoogleSheets(materialCode, properties) {
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil, sadece localStorage\'a kaydedildi');
                return;
            }
            
            try {
                const url = `${googleScriptUrl}?action=saveTDS&materialCode=${encodeURIComponent(materialCode)}&data=${encodeURIComponent(JSON.stringify(properties))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚òÅÔ∏è TDS Google Sheets\'e kaydedildi:', materialCode);
                } else {
                    console.error('‚ùå Google Sheets kayƒ±t hatasƒ±:', result.error);
                }
            } catch(error) {
                console.error('‚ùå Google Sheets senkronizasyon hatasƒ±:', error);
            }
        }
        
        // TDS property'lerde eksik alanlarƒ± doldur (v2)
        function ensureTDSPropertyFields(properties) {
            return properties.map(prop => {
                // Operator yoksa varsayƒ±lan
                if (!prop.operator) {
                    prop.operator = 'range';
                }
                
                // StandardValue yoksa hesapla
                if (!prop.standardValue && prop.min && prop.max) {
                    const minVal = parseFloat(prop.min);
                    const maxVal = parseFloat(prop.max);
                    if (!isNaN(minVal) && !isNaN(maxVal)) {
                        prop.standardValue = ((minVal + maxVal) / 2).toFixed(2);
                    }
                }
                
                return prop;
            });
        }
        
        // COA kayƒ±tlarƒ±nƒ± satƒ±r bazlƒ± Google Sheets'e kaydet
        async function saveCOARecordToSheets(materialCode, tdsProperties) {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìäüìäüìä SHEETS\'E KAYIT BA≈ûLIYOR! üìäüìäüìä');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîë Material Code:', materialCode);
            console.log('üìã TDS Properties Count:', tdsProperties.length);
            console.log('üìã TDS Properties RAW:', tdsProperties);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil');
                return;
            }
            
            try {
                // TDS property'lerde eksik alanlarƒ± doldur
                tdsProperties = ensureTDSPropertyFields(tdsProperties);
                
                // Mevcut COA form verilerini al
                const deliveryDate = document.getElementById('deliveryDate').value || new Date().toISOString().split('T')[0];
                const deliveryNo = document.getElementById('deliveryNo').value.trim() || '-';
                const lotNumber = document.getElementById('lotNumber').value.trim() || '-';
                const supplier = document.getElementById('supplierInput').value.trim() || '-';
                const location = document.getElementById('location').value.trim() || '';
                
                // Properties array olu≈ütur (sadece COA deƒüeri olanlar)
                const properties = tdsProperties
                    .filter(prop => prop.coaValue) // Sadece deƒüer girilenleri al
                    .map(prop => {
                        // COA deƒüerini al
                        let coaValue = String(prop.coaValue || '').trim();
                        let unit = String(prop.unit || '').trim();
                        
                        console.log(`üîç ƒ∞≈üleniyor: ${prop.name} | COA="${coaValue}" | Unit="${unit}"`);
                        console.log(`  üìã Orijinal prop:`, { coaValue: prop.coaValue, unit: prop.unit, min: prop.min, max: prop.max });
                        console.log(`  üî¢ prop.coaValue RAW type: ${typeof prop.coaValue}, RAW value:`, prop.coaValue);
                        
                        // T√úM virg√ºlleri noktaya √ßevir (T√ºrk√ße ondalƒ±k ayƒ±rƒ±cƒ±sƒ±)
                        coaValue = coaValue.replace(/,/g, '.');
                        
                        // Eƒüer COA deƒüeri i√ßinde bo≈üluk ve birim varsa ayƒ±r (√∂rn: "14.38 kg/m3")
                        if (coaValue && coaValue.includes(' ')) {
                            const match = coaValue.match(/^([\d.,]+)\s+(.+)$/);
                            if (match) {
                                const extractedValue = match[1].replace(/,/g, '.');
                                const extractedUnit = match[2];
                                console.log(`  üîß COA ayrƒ±klandƒ±: "${coaValue}" ‚Üí Value=${extractedValue}, Unit=${extractedUnit}`);
                                coaValue = extractedValue;
                                if (!unit) {
                                    unit = extractedUnit;
                                }
                            }
                        }
                        
                        // SADECE COA deƒüeri tamamen bo≈üsa VE unit sayƒ± ile ba≈ülƒ±yorsa ayƒ±r
                        // √ñrnek: COA bo≈ü + Unit="122 N" ‚Üí COA=122, Unit=N
                        // Ama: COA="0.09" + Unit="N/mm2" ‚Üí DOKUNMA!
                        if ((!coaValue || coaValue === '') && unit && /^[\d.,]+\s/.test(unit)) {
                            const unitMatch = unit.match(/^([\d.,]+)\s+(.*)$/);
                            if (unitMatch) {
                                coaValue = unitMatch[1].replace(/,/g, '.');
                                unit = unitMatch[2].trim();
                                console.log(`  üîß Unit'ten COA √ßƒ±karƒ±ldƒ±: "${prop.unit}" ‚Üí COA=${coaValue}, Unit=${unit}`);
                            }
                        }
                        
                        // √ñZEL DURUM: Eƒüer COA deƒüeri var ama √ßok k√º√ß√ºkse (√∂rn: 0.07)
                        // VE unit sayƒ± ile ba≈ülƒ±yorsa (√∂rn: "90 N/mm2")
                        // Bu durumda unit'teki sayƒ±yƒ± KULLANMA, sadece birimi temizle
                        if (coaValue && unit && /^[\d.,]+\s/.test(unit)) {
                            const unitMatch = unit.match(/^[\d.,]+\s+(.*)$/);
                            if (unitMatch) {
                                // Unit'teki sayƒ±yƒ± at, sadece birimi al
                                unit = unitMatch[1].trim();
                                console.log(`  ‚ö†Ô∏è Unit'teki yanlƒ±≈ü sayƒ± temizlendi: "${prop.unit}" ‚Üí Unit="${unit}"`);
                            }
                        }
                        
                        // Alt/√úst limit - √∂nce property'den kontrol et, yoksa hesapla
                        let lowerLimit = prop.min;
                        let upperLimit = prop.max;
                        
                        // Limit deƒüerlerinde virg√ºl varsa noktaya √ßevir
                        if (lowerLimit) lowerLimit = String(lowerLimit).replace(/,/g, '.');
                        if (upperLimit) upperLimit = String(upperLimit).replace(/,/g, '.');
                        
                        // Eƒüer property'de yoksa hesapla
                        if (!lowerLimit || !upperLimit) {
                            const stdValue = parseFloat(String(prop.standardValue || 0).replace(/,/g, '.'));
                            const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                            const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                            lowerLimit = (stdValue - lowerTol).toFixed(2);
                            upperLimit = (stdValue + upperTol).toFixed(2);
                        }
                        
                        // Operat√∂r ve Standart Deƒüer kontrol√º - virg√ºl/nokta d√∂n√º≈ü√ºm√º ile
                        const operator = prop.operator || prop.operat√∂r || 'range';
                        let standardValue = prop.standardValue || prop.standardDeger || '';
                        if (standardValue) standardValue = String(standardValue).replace(/,/g, '.');
                        
                        // Operat√∂re g√∂re limit g√∂sterimi
                        let finalMin = lowerLimit;
                        let finalMax = upperLimit;
                        
                        if (operator === '>' || operator === '>=') {
                            // B√ºy√ºkt√ºr: sadece alt limit g√∂ster
                            finalMax = '';
                        } else if (operator === '<' || operator === '<=') {
                            // K√º√ß√ºkt√ºr: sadece √ºst limit g√∂ster
                            finalMin = '';
                        }
                        // range i√ßin her ikisi de g√∂sterilir (zaten set)
                        
                        console.log(`üìä ${prop.name}: op=${operator}, stdVal=${standardValue}, min=${finalMin}, max=${finalMax} (COA: ${coaValue}, Unit: ${unit})`);
                        console.log(`  üéØ FINAL coaValue type: ${typeof coaValue}, value: "${coaValue}"`);
                        
                        return {
                            name: prop.name,
                            coaValue: coaValue,
                            unit: unit,
                            standard: prop.standard || '',
                            operator: operator,
                            standardValue: standardValue,
                            min: finalMin,
                            max: finalMax,
                            status: calculatePropertyStatus(coaValue, lowerLimit, upperLimit, operator)
                        };
                    });
                
                if (properties.length === 0) {
                    console.log('‚ö†Ô∏è Kaydedilecek COA deƒüeri yok');
                    return;
                }
                
                const data = {
                    date: deliveryDate,
                    deliveryNo: deliveryNo,
                    lotNumber: lotNumber,
                    materialCode: materialCode,
                    supplier: supplier,
                    location: location,
                    properties: properties
                };
                
                console.log('');
                console.log('üöÄüöÄüöÄ GOOGLE SHEETS\'E G√ñNDERƒ∞Lƒ∞YOR! üöÄüöÄüöÄ');
                console.log('üì¶ G√∂nderilen DATA:', JSON.stringify(data, null, 2));
                console.log('üöÄüöÄüöÄ G√ñNDERƒ∞M BA≈ûLIYOR! üöÄüöÄüöÄ');
                console.log('');
                
                console.log('üìä COA_Records\'a g√∂nderiliyor:', data);
                
                const url = `${googleScriptUrl}?action=saveCOARecord&data=${encodeURIComponent(JSON.stringify(data))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ COA_Records\'a kaydedildi:', result.recordCount, 'satƒ±r');
                    showToast(`üìä ${result.recordCount} √∂zellik COA_Records'a kaydedildi`, 'success', 3000);
                } else {
                    console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', result.error);
                }
            } catch(error) {
                console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', error);
            }
        }
        
        // √ñzellik durumunu hesapla (‚úÖ/‚ùå)
        function calculatePropertyStatus(coaValue, min, max, operator = 'range') {
            if (!coaValue) return '-';
            
            const val = parseFloat(String(coaValue).replace(/,/g, '.'));
            if (isNaN(val)) return '-';
            
            // Operat√∂re g√∂re kontrol
            if (operator === '>' || operator === '>=') {
                // B√ºy√ºkt√ºr: sadece alt limit kontrol
                if (!min) return '-';
                const minVal = parseFloat(String(min).replace(/,/g, '.'));
                if (isNaN(minVal)) return '-';
                return (operator === '>' ? val > minVal : val >= minVal) ? '‚úÖ' : '‚ùå';
            } 
            else if (operator === '<' || operator === '<=') {
                // K√º√ß√ºkt√ºr: sadece √ºst limit kontrol
                if (!max) return '-';
                const maxVal = parseFloat(String(max).replace(/,/g, '.'));
                if (isNaN(maxVal)) return '-';
                return (operator === '<' ? val < maxVal : val <= maxVal) ? '‚úÖ' : '‚ùå';
            }
            else {
                // range: her ikisi de kontrol
                if (!min || !max) return '-';
                const minVal = parseFloat(String(min).replace(/,/g, '.'));
                const maxVal = parseFloat(String(max).replace(/,/g, '.'));
                if (isNaN(minVal) || isNaN(maxVal)) return '-';
                return (val >= minVal && val <= maxVal) ? '‚úÖ' : '‚ùå';
            }
        }
        
        // Google Sheets'ten TDS verilerini y√ºkle
        async function loadTDSFromGoogleSheets() {
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil, sadece localStorage kullanƒ±lƒ±yor');
                return false;
            }
            
            try {
                console.log('‚òÅÔ∏è Google Sheets\'ten TDS verileri y√ºkleniyor...');
                const url = `${googleScriptUrl}?action=getTDS`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Google Sheets'teki veri DAIMA g√ºncel - √ºzerine yaz
                    Object.keys(result.data).forEach(materialCode => {
                        tdsData[materialCode] = result.data[materialCode];
                    });
                    localStorage.setItem('tdsData', JSON.stringify(tdsData));
                    console.log('‚úÖ Google Sheets\'ten', Object.keys(result.data).length, 'TDS y√ºklendi');
                    return true;
                } else {
                    console.log('‚ö†Ô∏è Google Sheets\'te TDS verisi yok');
                    return false;
                }
            } catch(error) {
                console.error('‚ùå Google Sheets y√ºkleme hatasƒ±:', error);
                return false;
            }
        }
        
        // TDS modalƒ±nƒ± a√ß
        function openTDSModal(preselectedMaterialCode = null) {
            if (materials.length === 0) {
                showToast('‚ö†Ô∏è √ñnce Excel y√ºkleyip hammadde listesini olu≈üturun', 'warning');
                return;
            }
            
            // API key'leri ve OCR engine'i input'lara y√ºkle
            const apiKeyInput = document.getElementById('ocrApiKeyInput');
            if (apiKeyInput) {
                apiKeyInput.value = localStorage.getItem('ocrspace_api_key') || 'K82811583888957';
            }
            
            const azureKeyInput = document.getElementById('azureApiKeyInput');
            if (azureKeyInput) {
                azureKeyInput.value = localStorage.getItem('azure_api_key') || '';
            }
            
            const azureEndpointInput = document.getElementById('azureEndpointInput');
            if (azureEndpointInput) {
                azureEndpointInput.value = localStorage.getItem('azure_endpoint') || '';
            }
            
            const ocrEngineSelect = document.getElementById('ocrEngineSelect');
            if (ocrEngineSelect) {
                ocrEngineSelect.value = localStorage.getItem('ocr_engine') || 'ocrspace';
            }
            
            // Eƒüer parametre g√∂nderilmediyse, COA formundaki hammaddeyi kontrol et
            if (!preselectedMaterialCode) {
                const materialInput = document.getElementById('materialCode');
                console.log('üîç Material input deƒüeri:', materialInput ? materialInput.value : 'Bulunamadƒ±');
                
                if (materialInput && materialInput.value) {
                    const value = materialInput.value.trim();
                    // Format: "KOD | ƒ∞Sƒ∞M" veya "KOD - ƒ∞Sƒ∞M"
                    if (value.includes(' | ')) {
                        preselectedMaterialCode = value.split(' | ')[0].trim();
                    } else if (value.includes(' - ')) {
                        preselectedMaterialCode = value.split(' - ')[0].trim();
                    } else {
                        preselectedMaterialCode = value;
                    }
                    console.log('‚úÇÔ∏è √áƒ±karƒ±lan hammadde kodu:', preselectedMaterialCode);
                }
            }
            
            const select = document.getElementById('tdsMaterialSelect');
            select.innerHTML = '<option value="">Hammadde se√ßin...</option>';
            
            let foundMatch = false;
            materials.forEach(m => {
                const code = m.code || m.stockCode || m.stokKodu;
                const name = m.name || m.stockName || m.stokAdƒ±;
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} | ${name}`;
                
                // Eƒüer bu hammadde se√ßili olacaksa i≈üaretle
                if (preselectedMaterialCode && code === preselectedMaterialCode) {
                    console.log('‚úÖ E≈üle≈üme bulundu:', code);
                    option.selected = true;
                    foundMatch = true;
                }
                
                select.appendChild(option);
            });
            
            console.log('üìä Toplam hammadde sayƒ±sƒ±:', materials.length);
            console.log('üéØ Aranan kod:', preselectedMaterialCode);
            console.log('üîó E≈üle≈üme durumu:', foundMatch);
            
            document.getElementById('tdsModal').classList.add('active');
            
            // Eƒüer e≈üle≈üen hammadde varsa otomatik y√ºkle
            if (foundMatch && preselectedMaterialCode) {
                select.value = preselectedMaterialCode;
                console.log('üîÑ loadTDSForMaterial √ßaƒürƒ±lƒ±yor...');
                // Eƒüer bu hammadde i√ßin OCR yeni yapƒ±ldƒ±ysa deƒüerleri koru
                const shouldClear = (lastOCRMaterialCode !== preselectedMaterialCode);
                console.log('üßπ shouldClear:', shouldClear, '| lastOCR:', lastOCRMaterialCode, '| current:', preselectedMaterialCode);
                loadTDSForMaterial(shouldClear);
                
                // Flag'i temizle (bir kez kullanƒ±ldƒ±)
                if (lastOCRMaterialCode === preselectedMaterialCode) {
                    lastOCRMaterialCode = null;
                    console.log('üßπ lastOCRMaterialCode temizlendi');
                }
            } else {
                document.getElementById('tdsContent').style.display = 'none';
                document.getElementById('tdsEmptyState').style.display = 'block';
            }
        }
        
        // TDS modalƒ±nƒ± kapat
        function closeTDSModal() {
            document.getElementById('tdsModal').classList.remove('active');
            currentTDSMaterial = null;
        }
        
        // Hammadde se√ßildiƒüinde TDS y√ºkle
        function loadTDSForMaterial(clearCOAValues = true) {
            const materialCode = document.getElementById('tdsMaterialSelect').value;
            if (!materialCode) {
                document.getElementById('tdsContent').style.display = 'none';
                document.getElementById('tdsEmptyState').style.display = 'block';
                return;
            }
            
            // TDS verilerini yeniden y√ºkle (localStorage'dan en g√ºncel verileri al)
            loadTDSData();
            
            currentTDSMaterial = materialCode;
            document.getElementById('tdsContent').style.display = 'block';
            document.getElementById('tdsEmptyState').style.display = 'none';
            
            // Mevcut TDS varsa y√ºkle
            const tds = tdsData[materialCode];
            if (tds && tds.properties) {
                // Normal modal a√ßƒ±lƒ±≈üta eski COA deƒüerlerini temizle, OCR sonrasƒ± koru
                if (clearCOAValues) {
                    tds.properties.forEach(prop => {
                        delete prop.coaValue;
                    });
                    // Temizlenmi≈ü hali sadece localStorage'a kaydet (Sheets'e kaydetme!)
                    localStorage.setItem('tdsData', JSON.stringify(tdsData));
                }
                renderTDSProperties(tds.properties);
            } else {
                // Bo≈ü ba≈ülat
                renderTDSProperties([]);
            }
        }
        
        // TDS √∂zelliklerini tablo olarak render et
        function renderTDSProperties(properties) {
            const tbody = document.getElementById('tdsPropertiesTable');
            tbody.innerHTML = '';
            
            if (properties.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="padding: 20px; text-align: center; color: #999;">√ñzellik eklenmemi≈ü. "Yeni √ñzellik Ekle" butonuna tƒ±klayƒ±n.</td></tr>';
                return;
            }
            
            properties.forEach((prop, index) => {
                // Limit hesapla
                const stdValue = parseFloat(prop.standardValue || 0);
                const lowerTol = parseFloat(prop.lowerTolerance || 0);
                const upperTol = parseFloat(prop.upperTolerance || 0);
                const lowerLimit = (stdValue - lowerTol).toFixed(2);
                const upperLimit = (stdValue + upperTol).toFixed(2);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${prop.name || ''}" onchange="updateTDSProperty(${index}, 'name', this.value)" 
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="√ñrn: Dansite">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${prop.unit || ''}" onchange="updateTDSProperty(${index}, 'unit', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="kg/m3">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${prop.standard || ''}" onchange="updateTDSProperty(${index}, 'standard', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="ISO845">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <select value="${prop.operator || '='}" onchange="updateTDSProperty(${index}, 'operator', this.value)"
                                style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            <option value="=" ${prop.operator === '=' ? 'selected' : ''}>=</option>
                            <option value="<" ${prop.operator === '<' ? 'selected' : ''}>&lt;</option>
                            <option value=">" ${prop.operator === '>' ? 'selected' : ''}>&gt;</option>
                            <option value="<=" ${prop.operator === '<=' ? 'selected' : ''}>‚â§</option>
                            <option value=">=" ${prop.operator === '>=' ? 'selected' : ''}>‚â•</option>
                            <option value="range" ${prop.operator === 'range' ? 'selected' : ''}>Aralƒ±k</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="number" step="0.01" value="${prop.standardValue || ''}" oninput="updateTDSPropertyWithCalc(${index}, 'standardValue', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center;" placeholder="15">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="number" step="0.01" value="${prop.lowerTolerance || ''}" oninput="updateTDSPropertyWithCalc(${index}, 'lowerTolerance', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center;" placeholder="1.5">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="number" step="0.01" value="${prop.upperTolerance || ''}" oninput="updateTDSPropertyWithCalc(${index}, 'upperTolerance', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center;" placeholder="1.5">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; font-weight: 600; color: #33691e;">
                        ${isNaN(parseFloat(lowerLimit)) ? '-' : lowerLimit}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; font-weight: 600; color: #33691e;">
                        ${isNaN(parseFloat(upperLimit)) ? '-' : upperLimit}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #e3f2fd; font-weight: 600; color: #1565c0;">
                        ${prop.coaValue || '-'}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fff3e0; font-weight: 600;">
                        <span id="compliance_${index}">-</span>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <button onclick="deleteTDSProperty(${index})" class="btn btn-sm" style="background: #f44336; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üóë</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Uygunluk kontrol√º yap
                if (prop.coaValue && prop.standardValue) {
                    const complianceSpan = document.getElementById(`compliance_${index}`);
                    const value = parseFloat(prop.coaValue);
                    const operator = prop.operator || 'range';
                    let isCompliant = false;
                    
                    if (operator === 'range') {
                        isCompliant = value >= parseFloat(lowerLimit) && value <= parseFloat(upperLimit);
                    } else if (operator === '>') {
                        isCompliant = value > stdValue;
                    } else if (operator === '<') {
                        isCompliant = value < stdValue;
                    } else if (operator === '>=') {
                        isCompliant = value >= stdValue;
                    } else if (operator === '<=') {
                        isCompliant = value <= stdValue;
                    } else if (operator === '=') {
                        isCompliant = Math.abs(value - stdValue) < 0.01;
                    }
                    
                    if (complianceSpan) {
                        complianceSpan.textContent = isCompliant ? '‚úÖ Uygun' : '‚ùå Uygun Deƒüil';
                        complianceSpan.style.color = isCompliant ? '#4caf50' : '#f44336';
                    }
                }
            });
        }
        
        // Yeni √∂zellik ekle
        function addTDSProperty() {
            if (!currentTDSMaterial) return;
            
            if (!tdsData[currentTDSMaterial]) {
                tdsData[currentTDSMaterial] = { properties: [] };
            }
            
            tdsData[currentTDSMaterial].properties.push({
                name: '',
                unit: '',
                standard: '',
                operator: '=',
                standardValue: '',
                lowerTolerance: '',
                upperTolerance: ''
            });
            
            renderTDSProperties(tdsData[currentTDSMaterial].properties);
        }
        
        // √ñzellik g√ºncelle (hesaplama olmadan)
        function updateTDSProperty(index, field, value) {
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            if (tdsData[currentTDSMaterial].properties[index]) {
                // Sayƒ±sal alanlarda virg√ºl/nokta d√∂n√º≈ü√ºm√º yap
                if (['standardValue', 'lowerTolerance', 'upperTolerance', 'min', 'max'].includes(field)) {
                    value = String(value).replace(/,/g, '.');
                }
                tdsData[currentTDSMaterial].properties[index][field] = value;
            }
        }
        
        // √ñzellik g√ºncelle ve limitleri yeniden hesapla
        function updateTDSPropertyWithCalc(index, field, value) {
            updateTDSProperty(index, field, value);
            renderTDSProperties(tdsData[currentTDSMaterial].properties);
        }
        
        // √ñzellik sil
        function deleteTDSProperty(index) {
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            if (confirm('Bu √∂zelliƒüi silmek istediƒüinizden emin misiniz?')) {
                tdsData[currentTDSMaterial].properties.splice(index, 1);
                renderTDSProperties(tdsData[currentTDSMaterial].properties);
            }
        }
        
        // TDS kaydet
        function saveTDS() {
            if (!currentTDSMaterial) return;
            
            // Alt/√úst limitleri hesapla ve property'lere ekle
            const tds = tdsData[currentTDSMaterial];
            if (tds && tds.properties) {
                tds.properties.forEach(prop => {
                    // T√ºm sayƒ±sal deƒüerlerde virg√ºl/nokta d√∂n√º≈ü√ºm√º yap
                    const stdValue = parseFloat(String(prop.standardValue || 0).replace(/,/g, '.'));
                    const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                    const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                    
                    // Deƒüerleri normalize et (virg√ºls√ºz kaydet)
                    prop.standardValue = stdValue.toString();
                    prop.lowerTolerance = lowerTol.toString();
                    prop.upperTolerance = upperTol.toString();
                    
                    // Operator varsayƒ±lan deƒüeri kontrol et
                    if (!prop.operator) {
                        prop.operator = 'range';
                    }
                    
                    // Operat√∂re g√∂re limit hesapla
                    if (prop.operator === '>' || prop.operator === '>=') {
                        // B√ºy√ºkt√ºr: sadece alt limit
                        prop.min = (stdValue - lowerTol).toFixed(2);
                        prop.max = '';
                    } else if (prop.operator === '<' || prop.operator === '<=') {
                        // K√º√ß√ºkt√ºr: sadece √ºst limit
                        prop.min = '';
                        prop.max = (stdValue + upperTol).toFixed(2);
                    } else {
                        // range: her ikisi de
                        prop.min = (stdValue - lowerTol).toFixed(2);
                        prop.max = (stdValue + upperTol).toFixed(2);
                    }
                });
            }
            
            saveTDSData();
            showToast('‚úÖ TDS kaydedildi', 'success');
            closeTDSModal();
        }
        
        // Close modal on click outside
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') closeModal();
        });

        // ==================== KAMERA TARAYICI ====================
        
        let cameraStream = null;
        
        // Kamera modalƒ±nƒ± a√ß
        // OSS-DocumentScanner uygulamasƒ±nƒ± a√ß
        function openDocumentScanner() {
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            if (isAndroid) {
                // Normal kamera kullan
                showToast('üì∑ Kamera a√ßƒ±lƒ±yor...', 'info');
                document.getElementById('cameraInput').click();
                
            } else {
                showToast('‚ö†Ô∏è Sadece mobil cihazlarda √ßalƒ±≈üƒ±r', 'warning');
                document.getElementById('cameraInput').click();
            }
        }
        
        // Mobile Detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
        }
        
        async function openCameraModal() {
            // Mobil cihazda doƒürudan native kamera inputunu kullan
            if (isMobileDevice()) {
                document.getElementById('cameraInput').click();
                return;
            }
            
            // Desktop i√ßin modal ile kamera a√ß
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraStream');
            
            try {
                // Kamera eri≈üimi iste
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Arka kamera (mobilde)
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                video.srcObject = cameraStream;
                modal.classList.add('active');
                showToast('üì∑ Kamera a√ßƒ±ldƒ±', 'success');
            } catch (error) {
                console.error('Kamera eri≈üim hatasƒ±:', error);
                showToast('‚ùå Kamera eri≈üimi reddedildi veya kamera bulunamadƒ±', 'error');
                
                // Fallback: dosya se√ßiciye y√∂nlendir
                document.getElementById('cameraInput').click();
            }
        }
        
        // Kamera modalƒ±nƒ± kapat
        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraStream');
            
            // Kamera akƒ±≈üƒ±nƒ± durdur
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.classList.remove('active');
        }
        
        // Fotoƒüraf √ßek
        function capturePhoto() {
            const video = document.getElementById('cameraStream');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // Canvas boyutunu video boyutuna ayarla
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Video frame'ini canvas'a √ßiz
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Canvas'ƒ± blob'a √ßevir
            canvas.toBlob(function(blob) {
                // Blob'u file'a √ßevir
                const fileName = 'camera_' + Date.now() + '.jpg';
                const file = new File([blob], fileName, { type: 'image/jpeg' });
                
                // FileReader ile preview olu≈ütur
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFile = file;
                    selectedFileData = e.target.result;
                    
                    const uploadArea = document.getElementById('uploadArea');
                    const preview = document.getElementById('filePreview');
                    
                    uploadArea.classList.add('has-file');
                    
                    // Dosya tipi ikonunu g√∂ster
                    const fileIconHtml = getFileIcon(fileName, 'image/jpeg', 'preview');
                    preview.innerHTML = fileIconHtml + '<p style="margin-top: 10px; color: #4CAF50; font-weight: 600;">‚úÖ Fotoƒüraf eklendi!</p>';
                    
                    showToast('‚úÖ Fotoƒüraf forma eklendi!', 'success');
                };
                reader.readAsDataURL(file);
                
                // Kamera modalƒ±nƒ± kapat
                closeCameraModal();
            }, 'image/jpeg', 0.9);
        }
        
        // Kamera ile fotoƒüraf √ßekme (basit, tarama yok) - Mobil fallback
        function handleCameraCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üì∏ Kamera ile fotoƒüraf √ßekildi:', file.name);
            
            // PC'deki handleFile fonksiyonunu kullan (aynƒ± logic)
            handleFile(file);
            
            // Input'u sƒ±fƒ±rla (aynƒ± fotoƒürafƒ± tekrar √ßekebilmek i√ßin)
            event.target.value = '';
        }
        
        // Eski tarayƒ±cƒ± fonksiyonlarƒ± (kullanƒ±lmƒ±yor artƒ±k)
        let scannerStream = null;
        let scannerCapturedData = null;
        let scannerWindow = null;
        
        function openProfessionalScanner() {
            // KAPALI - Artƒ±k kullanƒ±lmƒ±yor
            showToast('‚ùå Profesyonel tarayƒ±cƒ± devre dƒ±≈üƒ±. "Kamera ile √áek" kullanƒ±n.', 'error');
            return;
            // Yeni pencerede profesyonel tarayƒ±cƒ±yƒ± a√ß
            const width = Math.min(600, window.innerWidth - 20);
            const height = Math.min(900, window.innerHeight - 20);
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;
            
            scannerWindow = window.open(
                'profesyonel-tarayici.html',
                'Belge Tarayƒ±cƒ±',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            if (!scannerWindow) {
                showToast('‚ùå Pop-up engellendi! L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan izin verin', 'error');
            }
        }
        
        // Tarayƒ±cƒ±dan gelen mesajlarƒ± dinle
        window.addEventListener('message', async (event) => {
            if (event.data.type === 'scannedImage') {
                const dataURL = event.data.data;
                
                // Convert to File object
                const blob = await (await fetch(dataURL)).blob();
                const file = new File([blob], 'scanned_' + Date.now() + '.jpg', { type: 'image/jpeg' });
                
                // Set as selected file
                selectedFile = file;
                selectedFileData = dataURL;
                
                const uploadArea = document.getElementById('uploadArea');
                const preview = document.getElementById('filePreview');
                
                uploadArea.classList.add('has-file');
                preview.innerHTML = '<img src="' + dataURL + '" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px;"><p style="margin-top: 10px; color: #4CAF50; font-weight: 600;">‚úÖ Profesyonel tarama tamamlandƒ±!</p>';
                
                showToast('‚úÖ Taranmƒ±≈ü belge forma eklendi!', 'success');
                
                // Close scanner window
                if (scannerWindow) {
                    scannerWindow.close();
                }
            }
        });
        
        function openScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.add('active');
            startScannerCamera();
        }
        
        function closeScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.remove('active');
            
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            document.getElementById('scannerCaptureBtn').style.display = 'block';
            document.getElementById('scannerProcessBtn').style.display = 'none';
            document.getElementById('scannerUseBtn').style.display = 'none';
        }
        
        async function startScannerCamera() {
            try {
                showScannerStatus('üîÑ Kamera ba≈ülatƒ±lƒ±yor...', 'info');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('scannerVideo');
                video.srcObject = scannerStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    showScannerStatus('‚úÖ Belgeyi √ßer√ßeveleyin ve "√áek" butonuna basƒ±n', 'success');
                };
            } catch (error) {
                console.error('Kamera hatasƒ±:', error);
                showScannerStatus('‚ùå Kamera a√ßƒ±lamadƒ±: ' + error.message, 'error');
            }
        }
        
        function captureScannerImage() {
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            scannerCapturedData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            
            document.getElementById('scannerCaptureBtn').style.display = 'none';
            document.getElementById('scannerProcessBtn').style.display = 'block';
            
            showScannerStatus('‚úÖ G√∂r√ºnt√º yakalandƒ±! "ƒ∞≈üle ve D√ºzelt" butonuna basƒ±n', 'success');
        }
        
        function processScannerImage() {
            showScannerStatus('‚öôÔ∏è G√∂r√ºnt√º i≈üleniyor ve d√ºzeltiliyor...', 'info');
            
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            // Auto perspective correction
            const corners = detectDocumentCorners(scannerCapturedData, canvas.width, canvas.height);
            
            // Create output canvas with A4 aspect ratio
            const outputCanvas = document.createElement('canvas');
            const outputCtx = outputCanvas.getContext('2d');
            const dstWidth = 1200;
            const dstHeight = Math.round(dstWidth * 1.414); // A4
            outputCanvas.width = dstWidth;
            outputCanvas.height = dstHeight;
            
            // Perspective transform
            perspectiveTransformSimple(scannerCapturedData, corners, outputCanvas, dstWidth, dstHeight);
            
            // Enhance image
            enhanceDocument(outputCanvas);
            
            // Display result
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = outputCanvas.width;
            canvas.height = outputCanvas.height;
            ctx.drawImage(outputCanvas, 0, 0);
            
            document.getElementById('scannerProcessBtn').style.display = 'none';
            document.getElementById('scannerUseBtn').style.display = 'block';
            
            showScannerStatus('‚úÖ G√∂r√ºnt√º d√ºzeltildi! "Kullan" butonuna basƒ±n', 'success');
        }
        
        function detectDocumentCorners(imageData, width, height) {
            // Simplified corner detection - use image boundaries with margin
            const margin = Math.min(width, height) * 0.05;
            
            return [
                { x: margin, y: margin },
                { x: width - margin, y: margin },
                { x: width - margin, y: height - margin },
                { x: margin, y: height - margin }
            ];
        }
        
        function perspectiveTransformSimple(srcImageData, srcCorners, dstCanvas, dstWidth, dstHeight) {
            const src = srcImageData.data;
            const srcWidth = srcImageData.width;
            const srcHeight = srcImageData.height;
            const ctx = dstCanvas.getContext('2d');
            
            const dstImageData = ctx.createImageData(dstWidth, dstHeight);
            const dst = dstImageData.data;
            
            for (let y = 0; y < dstHeight; y++) {
                for (let x = 0; x < dstWidth; x++) {
                    const u = x / dstWidth;
                    const v = y / dstHeight;
                    
                    // Bilinear interpolation
                    const srcX = (1-u)*(1-v)*srcCorners[0].x + u*(1-v)*srcCorners[1].x +
                                u*v*srcCorners[2].x + (1-u)*v*srcCorners[3].x;
                    const srcY = (1-u)*(1-v)*srcCorners[0].y + u*(1-v)*srcCorners[1].y +
                                u*v*srcCorners[2].y + (1-u)*v*srcCorners[3].y;
                    
                    const srcXi = Math.floor(srcX);
                    const srcYi = Math.floor(srcY);
                    
                    if (srcXi >= 0 && srcXi < srcWidth && srcYi >= 0 && srcYi < srcHeight) {
                        const srcIdx = (srcYi * srcWidth + srcXi) * 4;
                        const dstIdx = (y * dstWidth + x) * 4;
                        
                        dst[dstIdx] = src[srcIdx];
                        dst[dstIdx + 1] = src[srcIdx + 1];
                        dst[dstIdx + 2] = src[srcIdx + 2];
                        dst[dstIdx + 3] = 255;
                    }
                }
            }
            
            ctx.putImageData(dstImageData, 0, 0);
        }
        
        function enhanceDocument(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Auto-contrast
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = (data[i] + data[i+1] + data[i+2]) / 3;
                min = Math.min(min, gray);
                max = Math.max(max, gray);
            }
            
            const scale = 255 / (max - min + 1);
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - min) * scale));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - min) * scale));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - min) * scale));
            }
            
            // Sharpen
            const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
            const output = new Uint8ClampedArray(data);
            const width = canvas.width;
            const height = canvas.height;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += data[idx] * kernel[(ky+1)*3 + (kx+1)];
                            }
                        }
                        const idx = (y * width + x) * 4 + c;
                        output[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = output[i];
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        async function useScannerImage() {
            const canvas = document.getElementById('scannerCanvas');
            const dataURL = canvas.toDataURL('image/jpeg', 0.92);
            
            // Convert to File object
            const blob = await (await fetch(dataURL)).blob();
            const file = new File([blob], 'scanned_' + Date.now() + '.jpg', { type: 'image/jpeg' });
            
            // Use existing handleFile function
            selectedFile = file;
            selectedFileData = dataURL;
            
            const uploadArea = document.getElementById('uploadArea');
            const preview = document.getElementById('filePreview');
            
            uploadArea.classList.add('has-file');
            preview.innerHTML = '<img src="' + dataURL + '" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px;"><p style="margin-top: 10px; color: #4CAF50; font-weight: 600;">‚úÖ Taranmƒ±≈ü belge hazƒ±r</p>';
            
            closeScanner();
            showToast('‚úÖ Taranmƒ±≈ü belge forma eklendi!', 'success');
        }
        
        function showScannerStatus(message, type) {
            const statusEl = document.getElementById('scannerStatus');
            statusEl.textContent = message;
            statusEl.className = 'scanner-status ' + type;
        }
    </script>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-container">
            <div class="scanner-header">
                <h2>üì∑ Belge Tarayƒ±cƒ±</h2>
                <button class="scanner-close" onclick="closeScanner()">√ó</button>
            </div>

            <div id="scannerStatus" class="scanner-status info">
                üîÑ Kamera ba≈ülatƒ±lƒ±yor...
            </div>

            <div class="scanner-video-container">
                <video id="scannerVideo" class="scanner-video" autoplay playsinline></video>
                <canvas id="scannerCanvas" class="scanner-canvas"></canvas>
            </div>

            <div class="scanner-controls">
                <button id="scannerCaptureBtn" class="scanner-btn scanner-btn-capture" onclick="captureScannerImage()">
                    üì∏ √áek
                </button>
                <button id="scannerProcessBtn" class="scanner-btn scanner-btn-process" onclick="processScannerImage()" style="display: none;">
                    ‚ú® ƒ∞≈üle ve D√ºzelt
                </button>
                <button id="scannerUseBtn" class="scanner-btn scanner-btn-use" onclick="useScannerImage()" style="display: none;">
                    ‚úÖ Kullan
                </button>
            </div>

            <div class="scanner-options">
                <div style="padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em; color: #856404;">
                    <strong>üí° ƒ∞pu√ßlarƒ±:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Belgeyi d√ºz zemine koyun</li>
                        <li>ƒ∞yi ƒ±≈üƒ±klandƒ±rƒ±lmƒ±≈ü ortamda √ßekin</li>
                        <li>Belgenin tamamƒ± g√∂r√ºns√ºn</li>
                        <li>G√∂lge d√º≈ü√ºrmemeye √ßalƒ±≈üƒ±n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== COA ANALYSIS ====================
        let analysisCharts = [];
        let analysisData = [];
        
        async function openCOAAnalysisModal() {
            document.getElementById('coaAnalysisModal').classList.add('active');
            
            // Eski grafikleri temizle
            analysisCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            analysisCharts = [];
            
            // Container'larƒ± temizle
            const chartsContainer = document.getElementById('analysisChartsContainer');
            if (chartsContainer) {
                chartsContainer.innerHTML = '';
                chartsContainer.style.display = 'none';
            }
            
            // Empty state'i g√∂ster
            const emptyState = document.getElementById('analysisEmptyState');
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            
            await loadAnalysisSuppliers();
        }
        
        function closeCOAAnalysisModal() {
            document.getElementById('coaAnalysisModal').classList.remove('active');
            // T√ºm grafikleri temizle
            analysisCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            analysisCharts = [];
        }
        
        async function loadAnalysisSuppliers() {
            try {
                showToast('üìä Veriler y√ºkleniyor...', 'info');
                
                const response = await fetch(googleScriptUrl + '?action=getCOARecords');
                const result = await response.json();
                
                if (!result.success) {
                    showToast('‚ùå Veri y√ºklenemedi: ' + result.error, 'error');
                    return;
                }
                
                analysisData = result.data || [];
                console.log('üìä Y√ºklenen kayƒ±t sayƒ±sƒ±:', analysisData.length);
                
                // Tedarik√ßileri √ßƒ±kar
                const suppliers = [...new Set(analysisData.map(r => r.supplier))].sort();
                const locations = [...new Set(analysisData.map(r => r.location).filter(Boolean))].sort();
                
                const supplierSelect = document.getElementById('analysisSupplierSelect');
                supplierSelect.innerHTML = '<option value="">Tedarik√ßi se√ßin...</option>';
                suppliers.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    supplierSelect.appendChild(option);
                });
                
                // Lokasyon dropdown'u doldur
                const locationSelect = document.getElementById('analysisLocationSelect');
                locationSelect.innerHTML = '<option value="">T√ºm√º</option>';
                locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                });
                
                showToast(`‚úÖ ${analysisData.length} kayƒ±t y√ºklendi`, 'success');
                
            } catch(error) {
                console.error('‚ùå Analiz veri y√ºkleme hatasƒ±:', error);
                showToast('‚ùå Veriler y√ºklenemedi', 'error');
            }
        }
        
        function loadAnalysisMaterials() {
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const materialSelect = document.getElementById('analysisMaterialSelect');
            const propertyContainer = document.getElementById('analysisPropertyContainer');
            
            materialSelect.innerHTML = '<option value="">Hammadde se√ßin...</option>';
            propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">√ñnce hammadde se√ßin...</div>';
            
            if (!supplier) {
                materialSelect.innerHTML = '<option value="">√ñnce tedarik√ßi se√ßin...</option>';
                return;
            }
            
            const materials = [...new Set(
                analysisData.filter(r => r.supplier === supplier).map(r => r.materialCode)
            )].sort();
            
            materials.forEach(m => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m;
                materialSelect.appendChild(option);
            });
        }
        
        function loadAnalysisProperties() {
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const material = document.getElementById('analysisMaterialSelect').value;
            const propertyContainer = document.getElementById('analysisPropertyContainer');
            
            propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Y√ºkleniyor...</div>';
            
            if (!supplier || !material) {
                propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">√ñnce hammadde se√ßin...</div>';
                return;
            }
            
            const properties = [...new Set(
                analysisData
                    .filter(r => r.supplier === supplier && r.materialCode === material)
                    .map(r => r.propertyName)
            )].sort();
            
            // Checkbox listesi olu≈ütur
            propertyContainer.innerHTML = '';
            if (properties.length === 0) {
                propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Bu hammadde i√ßin √∂zellik bulunamadƒ±</div>';
                return;
            }
            
            properties.forEach(p => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.style.borderBottom = '1px solid #f0f0f0';
                label.innerHTML = `
                    <input type="checkbox" value="${p}" style="margin-right: 8px;" onchange="updatePropertySelection()">
                    <span>${p}</span>
                `;
                propertyContainer.appendChild(label);
            });
        }
        
        function updatePropertySelection() {
            // Se√ßili √∂zellik sayƒ±sƒ±nƒ± g√∂ster
            const checkboxes = document.querySelectorAll('#analysisPropertyContainer input[type="checkbox"]:checked');
            console.log('Se√ßili √∂zellik sayƒ±sƒ±:', checkboxes.length);
        }
        
                
        function loadAnalysisChart() {
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const material = document.getElementById('analysisMaterialSelect').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;
            const location = document.getElementById('analysisLocationSelect').value;
            
            // Se√ßili √∂zellikleri al
            const selectedProperties = Array.from(
                document.querySelectorAll('#analysisPropertyContainer input[type="checkbox"]:checked')
            ).map(cb => cb.value);
            
            if (!supplier || !material || selectedProperties.length === 0) {
                showToast('‚ö†Ô∏è Tedarik√ßi, hammadde ve en az bir √∂zellik se√ßmelisiniz', 'warning');
                return;
            }
            
            // Eski grafikleri temizle
            analysisCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            analysisCharts = [];
            
            // Container'ƒ± temizle
            const chartsContainer = document.getElementById('analysisChartsContainer');
            chartsContainer.innerHTML = '';
            chartsContainer.style.display = 'block';
            
            document.getElementById('analysisEmptyState').style.display = 'none';
            
            let allValues = [];
            
            // Her √∂zellik i√ßin ayrƒ± grafik olu≈ütur
            selectedProperties.forEach((property, propIndex) => {
                // Bu √∂zellik i√ßin verileri filtrele
                let propData = analysisData.filter(r => {
                    if (r.supplier !== supplier || r.materialCode !== material || r.propertyName !== property) return false;
                    
                    // Tarih filtresi
                    if (startDate || endDate) {
                        const recordDate = new Date(r.date);
                        if (startDate && recordDate < new Date(startDate)) return false;
                        if (endDate && recordDate > new Date(endDate)) return false;
                    }
                    
                    // Lokasyon filtresi
                    if (location && r.location !== location) return false;
                    
                    return true;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (propData.length === 0) return;
                
                // Grafik container olu≈ütur (flex layout ile grafik + istatistikler)
                const chartWrapper = document.createElement('div');
                chartWrapper.style.cssText = 'background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 20px;';
                
                // Sol taraf - Grafik
                const chartDiv = document.createElement('div');
                chartDiv.style.cssText = 'flex: 1; height: 450px;';
                
                const canvas = document.createElement('canvas');
                canvas.id = `analysisChart_${propIndex}`;
                canvas.style.height = '400px';
                chartDiv.appendChild(canvas);
                
                // Saƒü taraf - ƒ∞statistikler
                const statsDiv = document.createElement('div');
                statsDiv.style.cssText = 'width: 250px; background: #f8f9fa; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px;';
                statsDiv.id = `stats_${propIndex}`;
                
                chartWrapper.appendChild(chartDiv);
                chartWrapper.appendChild(statsDiv);
                chartsContainer.appendChild(chartWrapper);
                
                // Label'lar
                const labels = propData.map(r => {
                    const date = new Date(r.date).toLocaleDateString('tr-TR');
                    return `${date} - ${r.deliveryNo || 'N/A'}`;
                });
                
                // Deƒüerleri ve renkleri hazƒ±rla
                const values = [];
                const backgroundColors = [];
                const borderColors = [];
                const pointBackgroundColors = [];
                const pointBorderColors = [];
                
                const colors = [
                    { bg: 'rgba(33, 150, 243, 0.7)', border: 'rgba(33, 150, 243, 1)' },
                    { bg: 'rgba(76, 175, 80, 0.7)', border: 'rgba(76, 175, 80, 1)' },
                    { bg: 'rgba(255, 152, 0, 0.7)', border: 'rgba(255, 152, 0, 1)' },
                    { bg: 'rgba(156, 39, 176, 0.7)', border: 'rgba(156, 39, 176, 1)' },
                    { bg: 'rgba(0, 188, 212, 0.7)', border: 'rgba(0, 188, 212, 1)' }
                ];
                
                propData.forEach(r => {
                    const val = parseFloat(r.coaValue);
                    if (isNaN(val)) {
                        values.push(null);
                        backgroundColors.push(colors[propIndex % colors.length].bg);
                        borderColors.push(colors[propIndex % colors.length].border);
                        pointBackgroundColors.push(colors[propIndex % colors.length].border);
                        pointBorderColors.push(colors[propIndex % colors.length].border);
                        return;
                    }
                    
                    values.push(val);
                    allValues.push(val);
                    
                    // Tolerans kontrol√º
                    const operator = r.operator || 'range';
                    const stdValue = parseFloat(r.standardValue);
                    const minLimit = parseFloat(r.minLimit);
                    const maxLimit = parseFloat(r.maxLimit);
                    let isCompliant = false;
                    
                    if (operator === 'range') {
                        isCompliant = val >= minLimit && val <= maxLimit;
                    } else if (operator === '>') {
                        isCompliant = val > stdValue;
                    } else if (operator === '<') {
                        isCompliant = val < stdValue;
                    } else if (operator === '>=') {
                        isCompliant = val >= stdValue;
                    } else if (operator === '<=') {
                        isCompliant = val <= stdValue;
                    } else if (operator === '=') {
                        isCompliant = Math.abs(val - stdValue) < 0.01;
                    }
                    
                    // Uygunluƒüa g√∂re renk
                    if (isCompliant) {
                        backgroundColors.push(colors[propIndex % colors.length].bg);
                        borderColors.push(colors[propIndex % colors.length].border);
                        pointBackgroundColors.push(colors[propIndex % colors.length].border);
                        pointBorderColors.push(colors[propIndex % colors.length].border);
                    } else {
                        backgroundColors.push('rgba(244, 67, 54, 0.7)');
                        borderColors.push('rgba(244, 67, 54, 1)');
                        pointBackgroundColors.push('rgba(244, 67, 54, 1)');
                        pointBorderColors.push('rgba(244, 67, 54, 1)');
                    }
                });
                
                // Operat√∂r kontrol√º - range ise line, diƒüerleri bar
                const firstOperator = propData[0]?.operator || 'range';
                const chartType = firstOperator === 'range' ? 'line' : 'bar';
                
                // Datasets - Mixed chart i√ßin her dataset'in type'ƒ± belirtilmeli
                const datasets = [{
                    type: chartType,
                    label: property,
                    data: values,
                    backgroundColor: chartType === 'line' ? colors[propIndex % colors.length].bg : backgroundColors,
                    borderColor: chartType === 'line' ? colors[propIndex % colors.length].border : borderColors,
                    borderWidth: 2,
                    tension: 0.1,
                    pointBackgroundColor: chartType === 'line' ? pointBackgroundColors : undefined,
                    pointBorderColor: chartType === 'line' ? pointBorderColors : undefined,
                    pointRadius: chartType === 'line' ? 6 : undefined,
                    pointHoverRadius: chartType === 'line' ? 8 : undefined
                }];
                
                // Limit √ßizgilerini operat√∂re g√∂re ekle
                if (chartType === 'line') {
                    // Range operat√∂r - hem alt hem √ºst limit ekle
                    const minValues = propData.map(r => {
                        const val = parseFloat(r.minLimit);
                        return isNaN(val) ? null : val;
                    });
                    
                    const maxValues = propData.map(r => {
                        const val = parseFloat(r.maxLimit);
                        return isNaN(val) ? null : val;
                    });
                    
                    datasets.push({
                        label: 'Alt Limit',
                        data: minValues,
                        borderColor: 'rgba(255, 152, 0, 0.8)',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0,
                        type: 'line'
                    });
                    
                    datasets.push({
                        label: '√úst Limit',
                        data: maxValues,
                        borderColor: 'rgba(244, 67, 54, 0.8)',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0,
                        type: 'line'
                    });
                } else {
                    // Bar chart - operat√∂re g√∂re ilgili limit √ßizgisi ekle
                    const firstRecord = propData[0];
                    const operator = firstRecord?.operator;
                    
                    if (operator === '<' || operator === '<=') {
                        // √úst limit var
                        const limitValues = propData.map(r => {
                            const val = parseFloat(r.standardValue);
                            return isNaN(val) ? null : val;
                        });
                        
                        datasets.push({
                            label: '√úst Limit',
                            data: limitValues,
                            borderColor: 'rgba(244, 67, 54, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            type: 'line'
                        });
                    } else if (operator === '>' || operator === '>=') {
                        // Alt limit var
                        const limitValues = propData.map(r => {
                            const val = parseFloat(r.standardValue);
                            return isNaN(val) ? null : val;
                        });
                        
                        datasets.push({
                            label: 'Alt Limit',
                            data: limitValues,
                            borderColor: 'rgba(255, 152, 0, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            type: 'line'
                        });
                    } else if (operator === '=') {
                        // Hedef deƒüer
                        const targetValues = propData.map(r => {
                            const val = parseFloat(r.standardValue);
                            return isNaN(val) ? null : val;
                        });
                        
                        datasets.push({
                            label: 'Hedef',
                            data: targetValues,
                            borderColor: 'rgba(76, 175, 80, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            type: 'line'
                        });
                    }
                }
                
                // Grafik olu≈ütur 
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: chartType === 'line' ? 'line' : 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${supplier} - ${material} - ${property}`,
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 15 }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: { size: 13 },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: propData[0]?.unit || '',
                                    font: { size: 13, weight: 'bold' }
                                },
                                ticks: {
                                    font: { size: 12 }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 13, weight: '500' }
                                }
                            }
                        }
                    }
                });
                
                analysisCharts.push(chart);
                
                // Bu grafik i√ßin istatistikleri hesapla ve g√∂ster
                const validValues = values.filter(v => v !== null);
                const propStats = {
                    count: validValues.length,
                    min: validValues.length > 0 ? Math.min(...validValues) : 0,
                    max: validValues.length > 0 ? Math.max(...validValues) : 0,
                    avg: validValues.length > 0 ? validValues.reduce((a, b) => a + b, 0) / validValues.length : 0,
                    target: propData[0]?.standardValue || '-',
                    minLimit: propData[0]?.minLimit || '-',
                    maxLimit: propData[0]?.maxLimit || '-',
                    operator: propData[0]?.operator || 'range'
                };
                
                // Tolerans dƒ±≈üƒ± sayƒ±sƒ±
                let outOfSpec = 0;
                propData.forEach(r => {
                    const val = parseFloat(r.coaValue);
                    if (isNaN(val)) return;
                    
                    const operator = r.operator || 'range';
                    const stdValue = parseFloat(r.standardValue);
                    const minLimit = parseFloat(r.minLimit);
                    const maxLimit = parseFloat(r.maxLimit);
                    let isCompliant = false;
                    
                    if (operator === 'range') {
                        isCompliant = val >= minLimit && val <= maxLimit;
                    } else if (operator === '>') {
                        isCompliant = val > stdValue;
                    } else if (operator === '<') {
                        isCompliant = val < stdValue;
                    } else if (operator === '>=') {
                        isCompliant = val >= stdValue;
                    } else if (operator === '<=') {
                        isCompliant = val <= stdValue;
                    } else if (operator === '=') {
                        isCompliant = Math.abs(val - stdValue) < 0.01;
                    }
                    
                    if (!isCompliant) outOfSpec++;
                });
                
                propStats.outOfSpec = outOfSpec;
                
                // ƒ∞statistikleri statsDiv'e ekle
                const statsContainer = document.getElementById(`stats_${propIndex}`);
                statsContainer.innerHTML = `
                    <div style="text-align: center; font-weight: bold; color: #2d5a3d; border-bottom: 2px solid #2d5a3d; padding-bottom: 8px; margin-bottom: 8px;">
                        üìä ƒ∞statistikler
                    </div>
                    ${propStats.operator === 'range' ? `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üéØ Hedef:</span>
                        <span style="font-weight: 600;">${typeof propStats.target === 'number' ? propStats.target.toFixed(2) : propStats.target}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üìâ Alt Limit:</span>
                        <span style="font-weight: 600; color: #ff9800;">${typeof propStats.minLimit === 'number' ? propStats.minLimit.toFixed(2) : propStats.minLimit}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üìà √úst Limit:</span>
                        <span style="font-weight: 600; color: #f44336;">${typeof propStats.maxLimit === 'number' ? propStats.maxLimit.toFixed(2) : propStats.maxLimit}</span>
                    </div>
                    ` : `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üéØ ${propStats.operator === '>' || propStats.operator === '>=' ? 'Min' : propStats.operator === '<' || propStats.operator === '<=' ? 'Max' : 'Hedef'}:</span>
                        <span style="font-weight: 600;">${typeof propStats.target === 'number' ? propStats.target.toFixed(2) : propStats.target}</span>
                    </div>
                    `}
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">‚¨áÔ∏è Min Deƒüer:</span>
                        <span style="font-weight: 600; color: #2196f3;">${propStats.min.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">‚¨ÜÔ∏è Max Deƒüer:</span>
                        <span style="font-weight: 600; color: #9c27b0;">${propStats.max.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üìä Ortalama:</span>
                        <span style="font-weight: 600; color: #4caf50;">${propStats.avg.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üî¢ Kayƒ±t Sayƒ±sƒ±:</span>
                        <span style="font-weight: 600;">${propStats.count}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; background: ${propStats.outOfSpec > 0 ? '#ffebee' : '#e8f5e9'}; margin: 8px -8px -8px -8px; padding: 10px 8px; border-radius: 0 0 8px 8px;">
                        <span style="color: #666; font-size: 0.9em; font-weight: 600;">‚ùå Hedef Dƒ±≈üƒ±:</span>
                        <span style="font-weight: 700; font-size: 1.1em; color: ${propStats.outOfSpec > 0 ? '#d32f2f' : '#2e7d32'};">${propStats.outOfSpec}</span>
                    </div>
                `;
            });
            
            // PDF butonu g√∂ster
            document.getElementById('exportAnalysisPdfBtn').style.display = 'block';
            
            showToast(`‚úÖ ${selectedProperties.length} √∂zellik i√ßin grafik olu≈üturuldu`, 'success');
        }
        
        // COA Analiz PDF Dƒ±≈üa Aktarma
        async function exportAnalysisToPDF() {
            const { jsPDF } = window.jspdf;
            
            showToast('üìÑ PDF olu≈üturuluyor...', 'info');
            
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const material = document.getElementById('analysisMaterialSelect').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;
            const location = document.getElementById('analysisLocationSelect').value;
            
            const selectedProperties = Array.from(
                document.querySelectorAll('#analysisPropertyContainer input[type="checkbox"]:checked')
            ).map(cb => cb.value);
            
            // T√ºrk√ße karakter d√∂n√º≈üt√ºrme fonksiyonu
            function toAscii(text) {
                if (!text) return '';
                return text
                    .replace(/≈ü/g, 's').replace(/≈û/g, 'S')
                    .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I')
                    .replace(/√∂/g, 'o').replace(/√ñ/g, 'O')
                    .replace(/√º/g, 'u').replace(/√ú/g, 'U')
                    .replace(/√ß/g, 'c').replace(/√á/g, 'C')
                    .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G');
            }
            
            // Birim bilgilerini al (analysisData'dan)
            function getUnitForProperty(propName) {
                const propData = analysisData.find(r => 
                    r.supplier === supplier && 
                    r.materialCode === material && 
                    r.propertyName === propName
                );
                return propData?.unit || '';
            }
            
            // PDF olu≈ütur (A4 boyut)
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let yPosition = margin;
            
            // Header - Ba≈ülƒ±k
            pdf.setFillColor(45, 90, 61);
            pdf.rect(0, 0, pageWidth, 35, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont('helvetica', 'bold');
            pdf.text('COA Analiz Raporu', pageWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Olusturulma Tarihi: ' + new Date().toLocaleDateString('tr-TR') + ' ' + new Date().toLocaleTimeString('tr-TR'), pageWidth / 2, 25, { align: 'center' });
            
            yPosition = 45;
            
            // Hammadde Bilgileri Kutusu
            pdf.setFillColor(248, 249, 250);
            pdf.roundedRect(margin, yPosition, contentWidth, 45, 3, 3, 'F');
            pdf.setDrawColor(45, 90, 61);
            pdf.setLineWidth(0.5);
            pdf.roundedRect(margin, yPosition, contentWidth, 45, 3, 3, 'S');
            
            pdf.setTextColor(45, 90, 61);
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Hammadde Bilgileri', margin + 5, yPosition + 8);
            
            pdf.setTextColor(51, 51, 51);
            pdf.setFontSize(9);
            
            const infoStartY = yPosition + 16;
            const labelWidth = 35;
            const col1X = margin + 5;
            const col2X = margin + contentWidth / 2 + 10;
            
            // Satƒ±r 1
            pdf.setFont('helvetica', 'bold');
            pdf.text('Tedarikci:', col1X, infoStartY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(toAscii(supplier) || '-', col1X + labelWidth, infoStartY);
            
            pdf.setFont('helvetica', 'bold');
            pdf.text('Hammadde Kodu:', col2X, infoStartY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(material || '-', col2X + 35, infoStartY);
            
            // Satƒ±r 2
            pdf.setFont('helvetica', 'bold');
            pdf.text('Lokasyon:', col1X, infoStartY + 8);
            pdf.setFont('helvetica', 'normal');
            pdf.text(toAscii(location) || 'Tumu', col1X + labelWidth, infoStartY + 8);
            
            pdf.setFont('helvetica', 'bold');
            pdf.text('Tarih Araligi:', col2X, infoStartY + 8);
            pdf.setFont('helvetica', 'normal');
            const startDateText = startDate ? new Date(startDate).toLocaleDateString('tr-TR') : 'Baslangic';
            const endDateText = endDate ? new Date(endDate).toLocaleDateString('tr-TR') : 'Bitis';
            pdf.text(startDateText + ' - ' + endDateText, col2X + 35, infoStartY + 8);
            
            // Satƒ±r 3 - Se√ßili √ñzellikler
            pdf.setFont('helvetica', 'bold');
            pdf.text('Secili Ozellikler:', col1X, infoStartY + 16);
            pdf.setFont('helvetica', 'normal');
            const propsText = toAscii(selectedProperties.join(', '));
            const maxPropsWidth = contentWidth - 45;
            const propsLines = pdf.splitTextToSize(propsText, maxPropsWidth);
            pdf.text(propsLines[0] || '-', col1X + labelWidth, infoStartY + 16);
            if (propsLines[1]) {
                pdf.text(propsLines[1], col1X + labelWidth, infoStartY + 21);
            }
            
            yPosition = yPosition + 55;
            
            // Her grafik i√ßin
            const chartWrappers = document.querySelectorAll('#analysisChartsContainer > div');
            
            for (let i = 0; i < chartWrappers.length; i++) {
                const wrapper = chartWrappers[i];
                const canvas = wrapper.querySelector('canvas');
                const statsDiv = wrapper.querySelector('[id^="stats_"]');
                
                if (!canvas) continue;
                
                // Yeni sayfa gerekli mi kontrol et
                const itemHeight = 90;
                if (yPosition + itemHeight > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                }
                
                // √ñzellik ba≈ülƒ±ƒüƒ± ve birim
                const propName = selectedProperties[i] || 'Ozellik ' + (i + 1);
                const unit = getUnitForProperty(propName);
                const headerText = toAscii(propName) + (unit ? ' (' + toAscii(unit) + ')' : '');
                
                pdf.setFillColor(45, 90, 61);
                pdf.roundedRect(margin, yPosition, contentWidth, 10, 2, 2, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text(headerText, margin + 5, yPosition + 7);
                yPosition += 14;
                
                // Grafik ve istatistik yan yana
                const chartWidth = contentWidth * 0.65;
                const statsWidth = contentWidth * 0.32;
                const rowHeight = 68;
                
                // Grafik
                try {
                    const chartImage = canvas.toDataURL('image/png', 1.0);
                    pdf.addImage(chartImage, 'PNG', margin, yPosition, chartWidth, rowHeight);
                } catch (e) {
                    console.error('Grafik resmi alinamadi:', e);
                    pdf.setTextColor(150, 150, 150);
                    pdf.setFontSize(10);
                    pdf.text('Grafik yuklenemedi', margin + chartWidth / 2, yPosition + rowHeight / 2, { align: 'center' });
                }
                
                // ƒ∞statistikler kutusu
                const statsX = margin + chartWidth + 5;
                pdf.setFillColor(248, 249, 250);
                pdf.roundedRect(statsX, yPosition, statsWidth, rowHeight, 2, 2, 'F');
                pdf.setDrawColor(200, 200, 200);
                pdf.roundedRect(statsX, yPosition, statsWidth, rowHeight, 2, 2, 'S');
                
                // ƒ∞statistik ba≈ülƒ±ƒüƒ±
                pdf.setFillColor(45, 90, 61);
                pdf.roundedRect(statsX, yPosition, statsWidth, 8, 2, 2, 'F');
                pdf.rect(statsX, yPosition + 4, statsWidth, 4, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Istatistikler', statsX + statsWidth / 2, yPosition + 5.5, { align: 'center' });
                
                // ƒ∞statistik verilerini al
                if (statsDiv) {
                    const statLines = statsDiv.querySelectorAll('div[style*="display: flex"]');
                    let statY = yPosition + 14;
                    pdf.setFontSize(8);
                    
                    statLines.forEach((line, idx) => {
                        if (statY > yPosition + rowHeight - 5) return;
                        
                        let label = line.querySelector('span:first-child')?.textContent || '';
                        // Emoji ve √∂zel karakterleri temizle
                        label = label.replace(/[^\w\s:√∂√º√ßƒüƒ±≈ü√ñ√ú√áƒûƒ∞≈ûa-zA-Z0-9]/g, '').trim();
                        label = toAscii(label);
                        
                        const value = line.querySelector('span:last-child')?.textContent || '';
                        
                        pdf.setTextColor(80, 80, 80);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(label, statsX + 3, statY);
                        
                        // Hedef dƒ±≈üƒ± i√ßin √∂zel renk
                        if (label.toLowerCase().includes('hedef') && label.toLowerCase().includes('dis')) {
                            const numVal = parseFloat(value);
                            if (numVal > 0) {
                                pdf.setTextColor(211, 47, 47);
                            } else {
                                pdf.setTextColor(46, 125, 50);
                            }
                        } else {
                            pdf.setTextColor(51, 51, 51);
                        }
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(value, statsX + statsWidth - 5, statY, { align: 'right' });
                        
                        statY += 7;
                    });
                }
                
                yPosition += rowHeight + 8;
            }
            
            // Footer her sayfaya
            const totalPages = pdf.internal.getNumberOfPages();
            for (let p = 1; p <= totalPages; p++) {
                pdf.setPage(p);
                pdf.setFillColor(45, 90, 61);
                pdf.rect(0, pageHeight - 10, pageWidth, 10, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.text('Sayfa ' + p + ' / ' + totalPages, pageWidth / 2, pageHeight - 4, { align: 'center' });
                pdf.text('COA Analiz Sistemi', margin, pageHeight - 4);
            }
            
            // PDF kaydet
            const fileName = 'COA_Analiz_' + toAscii(supplier) + '_' + material + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            pdf.save(fileName);
            
            showToast('‚úÖ PDF ba≈üarƒ±yla olu≈üturuldu', 'success');
        }
    </script>
</body>
</html>