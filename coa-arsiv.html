<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COA Ar≈üiv - Analiz Sertifikasƒ± Y√∂netimi v2.1</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <!-- Cache Buster: <?php echo time(); ?> -->
    <!-- Shared Config for COA Integration -->
    <script src="shared-config.js"></script>
    <!-- PDF.js for PDF compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- SheetJS for Excel reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js" 
            onerror="console.error('‚ùå Primary XLSX CDN failed'); this.onerror=null; this.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';"></script>
    <!-- Mammoth.js for Word reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"
            onerror="console.error('‚ùå Mammoth CDN failed');"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Chart.js for COA Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        /* Mobile/Desktop visibility */
        .mobile-optimized .camera-btn {
            width: 100%;
        }
        
        @media (max-width: 768px), (hover: none) and (pointer: coarse) {
            .camera-btn {
                font-size: 1.1em;
                padding: 14px 20px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-width: 100%;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #2d5a3d;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 350px 1fr;
            }
        }
        
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile Layout Order */
            .container {
                display: flex;
                flex-direction: column;
            }
            
            #statsSection {
                order: 3; /* ƒ∞statistikler en alta */
                margin-top: 30px;
                margin-bottom: 20px;
            }
            
            .main-grid {
                order: 2; /* Form ve tablo ortada */
                display: flex;
                flex-direction: column;
            }
            
            .main-grid > .card:first-child {
                order: 1; /* Form √∂nce */
                margin-bottom: 20px;
            }
            
            .main-grid > .card:last-child {
                order: 2; /* Tablo sonra */
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .container {
                padding: 0 15px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-card {
                padding: 18px;
            }
            
            .stat-card .number {
                font-size: 1.8em;
            }
            
            .stat-card .label {
                font-size: 1em;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filters input,
            .filters select {
                width: 100%;
                min-width: auto;
                padding: 14px;
                font-size: 16px;
            }
            
            .card {
                padding: 25px 20px;
            }
            
            .card h2 {
                font-size: 1.3em;
                margin-bottom: 25px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 1.05em;
                margin-bottom: 8px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px; /* Prevent zoom on iOS */
                border-width: 2px;
            }
            
            .upload-area {
                padding: 35px 20px;
                min-height: 200px;
            }
            
            .upload-icon {
                font-size: 3em;
            }
            
            .upload-text {
                font-size: 1.05em;
            }
            
            .btn {
                padding: 16px 24px;
                font-size: 1.05em;
            }
            
            /* Tablo mobil optimize */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 800px; /* Kaydƒ±rma i√ßin */
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
            
            .back-btn {
                padding: 10px 18px;
                font-size: 0.95em;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card .number {
                font-size: 2em;
            }
            
            .stat-card .label {
                font-size: 1.05em;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .card h2 {
                font-size: 1.2em;
            }
            
            .form-group input,
            .form-group select {
                padding: 16px;
                font-size: 16px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 1.05em;
                font-weight: 700;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-sm {
                padding: 10px 14px;
                font-size: 0.9em;
                width: 100%;
                justify-content: center;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            color: #2d5a3d;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2d5a3d;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #2d5a3d;
            background: #f0f7f2;
        }
        
        .upload-area.has-file {
            border-color: #28a745;
            background: #e8f5e9;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .upload-text {
            color: #666;
        }
        
        .file-name {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2d5a3d;
            font-weight: 600;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%);
            color: white;
            width: 100%;
            justify-content: center;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 90, 61, 0.3);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85em;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filters input,
        .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .filters input {
            flex: 1;
            min-width: 200px;
        }
        
        /* Multiselect */
        .multiselect-container {
            position: relative;
            min-width: 280px;
        }
        
        .multiselect-header {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .multiselect-header:hover {
            border-color: #2196F3;
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 320px;
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        
        .multiselect-dropdown.active {
            display: block;
        }
        
        .multiselect-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }
        
        .multiselect-option:hover {
            background: #f5f5f5;
        }
        
        .multiselect-option input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .multiselect-option label {
            cursor: pointer;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .multiselect-search {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
        }
        
        .multiselect-search input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .multiselect-actions {
            padding: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: white;
        }
        
        .multiselect-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .multiselect-actions .select-all {
            background: #4CAF50;
            color: white;
        }
        
        .multiselect-actions .clear-all {
            background: #f44336;
            color: white;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        /* Tedarik√ßi s√ºtunu i√ßin kompakt geni≈ülik */
        th:nth-child(2),
        td:nth-child(2) {
            min-width: 140px;
            max-width: 180px;
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Hammadde Kodu s√ºtunu i√ßin GENƒ∞≈û alan */
        th:nth-child(3),
        td:nth-child(3) {
            min-width: 350px;
            max-width: 550px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-weight: 500;
        }
        
        /* Tarih ve lot s√ºtunlarƒ± */
        th:nth-child(4), th:nth-child(5), th:nth-child(6),
        td:nth-child(4), td:nth-child(5), td:nth-child(6) {
            min-width: 100px;
        }
        
        /* Boyut s√ºtunu */
        th:nth-child(7),
        td:nth-child(7) {
            min-width: 80px;
            text-align: center;
        }
        
        /* Lokasyon s√ºtunu */
        th:nth-child(8),
        td:nth-child(8) {
            min-width: 100px;
        }
        
        /* ƒ∞≈ülem s√ºtunu */
        th:nth-child(9),
        td:nth-child(9) {
            min-width: 200px;
            text-align: center;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .thumbnail:hover {
            transform: scale(1.1);
        }
        
        .file-icon {
            width: 50px;
            height: 50px;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.75em;
            cursor: pointer;
            text-align: center;
            line-height: 1.2;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .file-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .file-icon.pdf {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
        }
        
        .file-icon.doc,
        .file-icon.docx {
            background: linear-gradient(135deg, #2b579a 0%, #3b6fb3 100%);
        }
        
        .file-icon.xls,
        .file-icon.xlsx {
            background: linear-gradient(135deg, #217346 0%, #34a853 100%);
        }
        
        .file-icon.jpg,
        .file-icon.jpeg,
        .file-icon.png {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
        }
        
        .file-icon.gif {
            background: linear-gradient(135deg, #9C27B0 0%, #BA68C8 100%);
        }
        
        .file-icon.bmp,
        .file-icon.webp {
            background: linear-gradient(135deg, #00897B 0%, #26A69A 100%);
        }
        
        .file-icon.txt {
            background: linear-gradient(135deg, #607D8B 0%, #78909C 100%);
        }
        
        .file-icon.unknown {
            background: linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%);
        }
        
        /* Geriye d√∂n√ºk uyumluluk i√ßin */
        .pdf-icon {
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active,
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 95%;
            max-height: 90%;
            overflow: auto;
        }
        
        .modal-content img {
            max-width: 100%;
            display: block;
        }
        
        .modal-close {
            position: fixed;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #333; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6);
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        /* Settings */
        .settings-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .settings-section h3 {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-dot.connected {
            background: #28a745;
        }
        
        /* Tedarik√ßi dropdown stilleri */
        .supplier-input-container {
            position: relative;
        }
        
        .supplier-input-wrapper {
            position: relative;
        }
        
        .supplier-dropdown-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #999;
            font-size: 0.8em;
        }
        
        #supplierInput {
            padding-right: 35px;
        }
        
        .supplier-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .supplier-dropdown-list.active {
            display: block;
        }
        
        .supplier-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .supplier-dropdown-item:hover {
            background: #f0f7ff;
        }
        
        .supplier-dropdown-item.selected {
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .supplier-dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #999;
        }
        
        .supplier-dropdown-count {
            padding: 8px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85em;
            color: #666;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Scanner Modal */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }

        .scanner-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            position: relative;
        }

        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scanner-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .scanner-close {
            background: #f44336;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .scanner-video,
        .scanner-canvas {
            width: 100%;
            display: block;
        }

        .scanner-canvas {
            display: none;
        }

        .scanner-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .scanner-btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scanner-btn-capture {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            grid-column: 1 / -1;
        }

        .scanner-btn-process {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .scanner-btn-use {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .scanner-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .scanner-status.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .scanner-status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .scanner-options {
            display: grid;
            gap: 10px;
            margin: 15px 0;
        }

        .scanner-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f7fa;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .scanner-modal {
                padding: 10px;
            }

            .scanner-container {
                padding: 15px;
            }
        }
        
        /* Template Load Item Styles */
        .template-load-item:hover {
            border-color: #2c5f2d !important;
            background: #f0f9f4 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 95, 45, 0.15);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã COA Ar≈üiv Sistemi</h1>
        <a href="index.html" class="back-btn">‚Üê Ana Sayfa</a>
    </div>
    
    <div class="container">
        <!-- Stats - Mobilde en alta gidecek -->
        <div class="stats-bar" id="statsSection">
            <div class="stat-card">
                <div class="number" id="statTotal">0</div>
                <div class="label">Toplam Sertifika</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statSuppliers">0</div>
                <div class="label">Tedarik√ßi</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statThisMonth">0</div>
                <div class="label">Bu Ay</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statTotalSize">0 MB</div>
                <div class="label">Toplam Dosya</div>
            </div>
            <div class="stat-card">
                <div class="connection-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Baƒülantƒ± kontrol ediliyor...</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- Form -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üì§ Yeni Sertifika Ekle</h2>
                    <button onclick="window.location.reload()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';"
                            title="Sayfayƒ± yenile ve formu temizle">
                        üîÑ Yeni Sorgu
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Tedarik√ßi Firma * <span id="supplierCount" style="color:#2196F3; font-weight:normal; font-size:0.9em;"></span></label>
                    <div class="supplier-input-container">
                        <div class="supplier-input-wrapper">
                            <input type="text" 
                                   id="supplierInput" 
                                   placeholder="Tedarik√ßi ara veya yazƒ±n..." 
                                   autocomplete="off"
                                   onfocus="showSupplierDropdown()"
                                   oninput="filterSupplierDropdown()"
                                   onchange="filterMaterialsBySupplier()">
                            <span class="supplier-dropdown-arrow">‚ñº</span>
                            <div class="supplier-dropdown-list" id="supplierDropdownList">
                                <div class="supplier-dropdown-count" id="supplierDropdownCount"></div>
                                <div id="supplierDropdownItems"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                        <small style="color:#666; font-size:0.85em; flex: 1; min-width: 200px;">Excel dosyasƒ± y√ºkleyerek tedarik√ßi ve hammadde listelerini otomatik doldurun</small>
                        <label for="excelFileInput" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9em; cursor: pointer; white-space: nowrap; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(46, 204, 113, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(46, 204, 113, 0.3)'">
                            üìä Excel Y√ºkle
                        </label>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="loadExcelFile(event)" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Hammadde Kodu * <span id="materialCount" style="font-size: 0.8em; color: #666;"></span></label>
                    <div class="supplier-dropdown-wrapper" style="position: relative;">
                        <input type="text" id="materialCode" placeholder="üîç Hammadde ara veya yazƒ±n..." 
                               autocomplete="off" 
                               oninput="filterMaterials(this.value)" 
                               onfocus="showMaterialDropdown()" 
                               onblur="handleMaterialBlur()"
                               style="width: 100%;">
                        <div id="materialDropdown" class="supplier-dropdown-list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 250px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div style="padding: 8px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                                <span id="materialDropdownCount" style="font-size: 0.85em; color: #666; font-weight: 500;">0 hammadde</span>
                            </div>
                            <div id="materialDropdownItems"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        ƒ∞rsaliye Tarihi *
                        <input type="checkbox" id="autoFillDeliveryDate" style="margin-left: 10px; width: 18px; height: 18px; vertical-align: middle; cursor: pointer;">
                        <span style="font-size: 0.85em; color: #666; margin-left: 5px;">Excel'den otomatik doldur</span>
                    </label>
                    <input type="date" id="deliveryDate">
                </div>
                
                <div class="form-group">
                    <label>
                        ƒ∞rsaliye No
                        <input type="checkbox" id="autoFillDeliveryNo" style="margin-left: 10px; width: 18px; height: 18px; vertical-align: middle; cursor: pointer;">
                        <span style="font-size: 0.85em; color: #666; margin-left: 5px;">Excel'den otomatik doldur</span>
                    </label>
                    <input type="text" id="deliveryNo" placeholder="√ñrn: IRS-2024-001">
                </div>
                
                <div class="form-group">
                    <label>Parti/Lot No</label>
                    <input type="text" id="lotNumber" placeholder="√ñrn: 2I02618">
                </div>
                
                <div class="form-group">
                    <label>Lokasyon</label>
                    <select id="location">
                        <option value="">Lokasyon se√ßin...</option>
                        <option value="√áerkezk√∂y">√áerkezk√∂y</option>
                        <option value="Velik√∂y">Velik√∂y</option>
                        <option value="Ankara">Ankara</option>
                        <option value="Bursa">Bursa</option>
                        <option value="Adana">Adana</option>
                        <option value="Eski≈üehir">Eski≈üehir</option>
                        <option value="Ultech1">Ultech1</option>
                        <option value="Ultech2">Ultech2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Sertifika Dosyasƒ± *</label>
                    
                    <!-- Drag & Drop Alan -->
                    <div id="dragDropArea" style="border: 2px dashed #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 10px; text-align: center; background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%); cursor: pointer; transition: all 0.3s;" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 1.5em; margin-bottom: 5px;">üìÅ</div>
                        <div style="font-size: 0.9em; color: #1976D2; font-weight: 500;">Dosya s√ºr√ºkleyip bƒ±rakƒ±n veya tƒ±klayƒ±n</div>
                        <div style="font-size: 0.75em; color: #666; margin-top: 3px;">PDF, Resim, Excel, Word</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="openDocumentScanner()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            üì∑ Belge Tara
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            üìÅ Dosya Y√ºkle
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div style="padding: 12px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; display: flex; flex-direction: column; gap: 6px; transition: all 0.2s;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="templateModeCheckbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: #ffc107;" onchange="toggleTemplateMode()">
                                <label for="templateModeCheckbox" style="margin: 0; cursor: pointer; font-size: 0.95em; color: #856404; font-weight: 600;">
                                    üé® Template Olu≈ütur
                                </label>
                            </div>
                            <div style="font-size: 0.75em; color: #856404; margin-left: 26px; line-height: 1.3;">
                                Y√ºklenen belge √ºzerinde b√∂lgeleri i≈üaretleyin ve kaydedin.
                            </div>
                        </div>
                        <button type="button" class="btn" onclick="editExistingTemplate()" style="padding: 12px; background: #17a2b8; color: white; border: 2px solid #117a8b; border-radius: 8px; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; text-align: center;" onmouseover="this.style.background='#138496'" onmouseout="this.style.background='#17a2b8'">
                            <span style="font-size: 1.1em;">‚úèÔ∏è Template D√ºzenle</span>
                            <span style="font-size: 0.75em; opacity: 0.9;">Kayƒ±tlƒ± template'i d√ºzenleyin</span>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 10px; background: #d1ecf1; border-radius: 6px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #0c5460; font-weight: 600;">
                            üìã Kayƒ±tlƒ± Template Kullan (OCR i√ßin)
                        </label>
                        <div style="display: flex; gap: 5px;">
                            <select id="templateSelect" onchange="applyTemplate(this.value)" style="flex: 1; padding: 8px; border: 1px solid #bee5eb; border-radius: 4px; font-size: 14px;">
                                <option value="">-- Template Se√ß --</option>
                            </select>
                            <button type="button" onclick="clearSelectedTemplate()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                                ‚ùå
                            </button>
                        </div>
                    </div>
                    
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(event)">
                    <input type="file" id="fileInput" accept="image/*,.pdf,.xlsx,.xls,.docx,.doc" style="display:none">
                    <div class="upload-area" id="uploadArea" style="display: none;">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Fotoƒüraf veya PDF s√ºr√ºkleyin<br>veya tƒ±klayarak se√ßin</div>
                    </div>
                    <div id="filePreview"></div>
                </div>
                
                <div class="form-group">
                    <label>Not (Opsiyonel)</label>
                    <input type="text" id="notes" placeholder="Ek bilgi...">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveCOA()" style="flex: 1;">üíæ Kaydet</button>
                    <button class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">‚ùå ƒ∞ptal</button>
                </div>
                
                <!-- Bulk Upload Toggle -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; text-align: center;">
                    <button class="btn" onclick="toggleBulkUploadSection()" style="background: white; color: #667eea; font-weight: 600; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 1em; box-shadow: 0 4px 12px rgba(0,0,0,0.2); width: 100%; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        üì¶ Toplu COA Y√ºkleme
                    </button>
                </div>
                
                <!-- Bulk Upload Section (Hidden by default) -->
                <div id="bulkUploadSection" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 2px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üì¶</span>
                        <span>Toplu COA Y√ºkleme</span>
                        <button onclick="toggleBulkUploadSection()" style="margin-left: auto; background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">‚úñ Kapat</button>
                    </h3>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #495057;">üìù Toplu y√ºkleme i√ßin dosya adƒ± formatƒ±:</h4>
                        <code style="background: #e9ecef; padding: 8px 12px; border-radius: 4px; display: block; margin-bottom: 10px; font-size: 0.9em;">
                            [Hammadde Kodu] - [GG.AA.YYYY].[uzantƒ±]
                        </code>
                        <p style="font-size: 0.85em; color: #666; margin: 0;">
                            <strong>√ñrnekler:</strong><br>
                            ‚Ä¢ 944.4.KFR30-20.4 - 20.09.2025.pdf<br>
                            ‚Ä¢ MDE - 10.02.2026.xlsx<br>
                            ‚Ä¢ SAH - 15.01.2026.docx
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <div style="font-size: 0.9em; color: #1976D2; margin-bottom: 6px;">
                            <strong>‚ÑπÔ∏è Otomatik Bilgiler:</strong>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 0.85em; color: #1976D2;">
                            <li><strong>Tedarik√ßi:</strong> Yukarƒ±daki formdan otomatik alƒ±nƒ±r</li>
                            <li><strong>ƒ∞rsaliye No:</strong> Excel'den y√ºklenen verilerden tarihe g√∂re otomatik √ßekilir</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">1Ô∏è‚É£ COA Dosyalarƒ±nƒ± Y√ºkleyin (√áoklu) *</label>
                        <div style="border: 3px dashed #667eea; border-radius: 8px; padding: 30px; text-align: center; background: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%); cursor: pointer; transition: all 0.3s;" onclick="document.getElementById('bulkFileInput').click()" onmouseover="this.style.borderColor='#764ba2'; this.style.background='linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%)'" onmouseout="this.style.borderColor='#667eea'; this.style.background='linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%)'">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">üìÅ</div>
                            <div style="font-size: 1.1em; color: #667eea; font-weight: 600; margin-bottom: 5px;">Dosyalarƒ± s√ºr√ºkleyin veya tƒ±klayƒ±n</div>
                            <div style="font-size: 0.85em; color: #666;">Birden fazla dosya se√ßebilirsiniz (PDF, Resim, Excel, Word)</div>
                        </div>
                        <input type="file" id="bulkFileInput" accept="image/*,.pdf,.xlsx,.xls,.docx,.doc" multiple style="display: none;" onchange="handleBulkFileSelect(event)">
                    </div>
                    
                    <div id="bulkFilesList" style="display: none; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #495057;">2Ô∏è‚É£ Y√ºklenecek Dosyalar:</h4>
                        <div id="bulkFilesContainer"></div>
                    </div>
                    
                    <div id="bulkSummary" style="display: none; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 8px; color: #155724;">‚úÖ √ñzet</h4>
                        <p id="bulkSummaryText" style="margin: 0; color: #155724; font-size: 0.95em;"></p>
                    </div>
                    
                    <!-- Bulk Upload Progress -->
                    <div id="bulkUploadProgress" style="display: none; padding: 20px; background: white; border-radius: 8px; margin-bottom: 15px; border: 2px solid #667eea;">
                        <h4 style="margin-bottom: 12px; color: #667eea; display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="spinner" style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></span>
                                <span id="bulkProgressTitle">COA'lar i≈üleniyor...</span>
                            </div>
                            <button onclick="cancelBulkUpload()" class="btn btn-sm" style="background: #dc3545; color: white; padding: 5px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;" title="ƒ∞≈ülemi iptal et">üõë ƒ∞ptal</button>
                        </h4>
                        <div style="background: #f0f0f0; border-radius: 10px; height: 30px; overflow: hidden; margin-bottom: 12px;">
                            <div id="bulkProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9em;"></div>
                        </div>
                        <div id="bulkProgressDetails" style="font-size: 0.9em; color: #666;">
                            <div id="bulkCurrentFile" style="margin-bottom: 6px;"></div>
                            <div id="bulkProgressStats" style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <span>‚úÖ Ba≈üarƒ±lƒ±: <strong id="bulkSuccessCount">0</strong></span>
                                <span>‚ùå Hata: <strong id="bulkErrorCount">0</strong></span>
                                <span>üìÑ Toplam: <strong id="bulkTotalCount">0</strong></span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveBulkCOAs()" style="flex: 1; padding: 12px; font-size: 1em; font-weight: 600;">üíæ T√ºm√ºn√º Kaydet</button>
                        <button class="btn btn-secondary" onclick="clearBulkUpload()">üóëÔ∏è Temizle</button>
                    </div>
                </div>
                
                <!-- Settings -->
                <div class="settings-section">
                    <h3>‚öôÔ∏è Google Sheets Baƒülantƒ±sƒ±</h3>
                    <input type="text" id="googleScriptUrl" value="https://script.google.com/macros/s/AKfycbz3KZblRoWV0uU7_LU24Wih4npAl2x8_vFWDjmc-F0bDeRHgmrSEi0XB-YsaaD0_i4u/exec" placeholder="Google Apps Script URL" style="width:100%; margin-bottom:10px;">
                    <button class="btn btn-secondary btn-sm" onclick="connectGoogleSheets()">üîó Baƒülan</button>
                </div>
                
                <!-- Central Archive Folder -->
                <div class="settings-section" style="margin-top: 20px; background: linear-gradient(135deg, #f0f9f4 0%, #e8f5e9 100%); border: 2px solid #2c5f2d; box-shadow: 0 2px 8px rgba(44,95,45,0.15);">
                    <h3 style="color: #2c5f2d;">üìÅ Merkezi Ar≈üiv</h3>
                    <p style="font-size: 0.85em; color: #1b5e20; margin-bottom: 10px; line-height: 1.5;">
                        ‚ú® <strong>Otomatik Ar≈üivleme Aktif!</strong>
                        <br><br>
                        T√ºm y√ºklenen COA ve template dosyalarƒ± anƒ±nda <strong>COA_Merkezi_Arsiv</strong> klas√∂r√ºne kopyalanƒ±r.
                        <br><br>
                        üéØ Manuel i≈ülem gerektirmez - Sistem otomatik √ßalƒ±≈üƒ±r!
                    </p>
                    <div style="display: flex; gap: 8px; flex-direction: column;">
                        <button class="btn btn-success btn-sm" onclick="openCentralArchive()" style="width: 100%; background: #2c5f2d; border-color: #2c5f2d; font-weight: 600; box-shadow: 0 2px 6px rgba(44,95,45,0.3);">
                            üìÇ Merkezi Ar≈üivi A√ß
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="syncExistingFiles()" style="width: 100%; background: #546e7a; border-color: #546e7a; font-weight: 600;">
                            üîÑ Mevcut Dosyalarƒ± Senkronize Et
                        </button>
                    </div>
                </div>
                
                <div class="settings-section" style="margin-top: 20px;">
                    <h3>üìä TDS Y√∂netimi</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Hammadde √∂zellikleri ve toleranslarƒ± tanƒ±mlayƒ±n</p>
                    <button class="btn btn-primary btn-sm" onclick="openTDSModal()" style="width: 100%;">‚öôÔ∏è TDS Ayarlarƒ±nƒ± A√ß</button>
                </div>
                
                <!-- COA Analysis -->
                <div class="settings-section" style="margin-top: 20px;">
                    <h3>üìà COA Analiz</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Hammadde √∂zelliklerini grafiklerle analiz edin</p>
                    <button class="btn btn-primary btn-sm" onclick="openCOAAnalysisModal()" style="width: 100%; background: #ff9800; border-color: #ff9800;">üìä Analiz A√ß</button>
                </div>
                
                <!-- Missing COA Reports -->
                <div class="settings-section" style="margin-top: 20px;">
                    <h3>üìÑ Raporlar</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">ƒ∞rsaliye bazƒ±nda COA y√ºklenme durumunu g√∂r√ºn</p>
                    <button class="btn btn-primary btn-sm" onclick="openMissingCOAModal()" style="width: 100%; background: #667eea; border-color: #667eea;">üìä COA Durum Raporu</button>
                </div>
                
                <!-- JSON Backup -->
                <div class="settings-section" style="margin-top: 20px;">
                    <h3>üíæ Yedekleme & Geri Y√ºkleme</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">T√ºm COA kayƒ±tlarƒ±nƒ± JSON dosyasƒ± olarak yedekleyin veya geri y√ºkleyin</p>
                    <div style="display: flex; gap: 8px; flex-direction: column;">
                        <button class="btn btn-success btn-sm" onclick="downloadJSONBackup()" style="width: 100%; background: #28a745; border-color: #28a745;">
                            üì• JSON ƒ∞ndir (Yedekle)
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('jsonUploadInput').click()" style="width: 100%; background: #007bff; border-color: #007bff;">
                            üì§ JSON Y√ºkle (Geri Y√ºkle)
                        </button>
                        <input type="file" id="jsonUploadInput" accept=".json,application/json" style="display: none;" onchange="uploadJSONBackup(event)">
                    </div>
                </div>
            </div>
            
            <!-- List -->
            <div class="card">
                <h2>üìã Sertifika Listesi</h2>
                
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="üîç Ara (tedarik√ßi, hammadde, lot no...)">
                    
                    <div class="multiselect-container">
                        <div class="multiselect-header" id="supplierMultiselectHeader">
                            <span id="supplierMultiselectText">T√ºm Tedarik√ßiler</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="multiselect-dropdown" id="supplierMultiselectDropdown">
                            <div class="multiselect-search">
                                <input type="text" id="supplierSearchInput" placeholder="Tedarik√ßi ara...">
                            </div>
                            <div id="supplierMultiselectOptions"></div>
                            <div class="multiselect-actions">
                                <button class="select-all" onclick="selectAllSuppliers()">‚úì T√ºm√ºn√º Se√ß</button>
                                <button class="clear-all" onclick="clearAllSuppliers()">‚úó Temizle</button>
                            </div>
                        </div>
                    </div>
                    
                    <input type="month" id="filterMonth">
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">
                        üóë Se√ßilenleri Sil (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="exportToExcel()" style="margin-left: auto;">
                        üìä Excel ƒ∞ndir
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="coaTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()" style="cursor: pointer;"></th>
                                <th>Dosya</th>
                                <th>Tedarik√ßi</th>
                                <th>Hammadde Kodu</th>
                                <th>ƒ∞rsaliye Tarihi</th>
                                <th>ƒ∞rsaliye No</th>
                                <th>Lot No</th>
                                <th>Boyut</th>
                                <th>Lokasyon</th>
                                <th style="min-width: 120px;">COA Deƒüerleri</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="coaTableBody">
                        </tbody>
                    </table>
                    <div class="empty-state" id="emptyState">
                        <div class="icon">üì≠</div>
                        <p>Hen√ºz sertifika eklenmemi≈ü</p>
                    </div>
                </div>
                
                <!-- Sayfalama Kontrol√º -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666;">Sayfa ba≈üƒ±na kayƒ±t:</label>
                        <select id="rowsPerPage" onchange="changeRowsPerPage()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="all">T√ºm√º</option>
                        </select>
                    </div>
                    
                    <!-- Sayfa Numaralarƒ± -->
                    <div id="paginationControls" style="display: flex; align-items: center; gap: 5px;">
                    </div>
                    
                    <div id="recordInfo" style="font-size: 0.9em; color: #666;">
                        Toplam: 0 kayƒ±t
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="">
        </div>
    </div>
    
    <!-- TDS Management Modal -->
    <div class="modal" id="tdsModal">
        <span class="modal-close" onclick="closeTDSModal()">&times;</span>
        <div class="modal-content" style="max-width: 95%; width: 1800px; max-height: 95vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">üìä TDS (Technical Data Sheet) Y√∂netimi</h2>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666; width: 120px;">OCR Motor:</label>
                        <select id="ocrEngineSelect" onchange="localStorage.setItem('ocr_engine', this.value); showToast('‚úÖ OCR motoru kaydedildi', 'success');" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85em; flex: 1;">
                            <option value="ocrspace">OCR.space (Hƒ±zlƒ±)</option>
                            <option value="azure">Microsoft Azure (Taranmƒ±≈ü i√ßin g√º√ßl√º)</option>
                            <option value="both">ƒ∞kisini de dene (En iyi sonucu se√ß)</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666; width: 120px;">üîë OCR.space Key:</label>
                        <input 
                            type="text" 
                            id="ocrApiKeyInput" 
                            placeholder="K82811583888957" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.85em; width: 200px;"
                            onchange="localStorage.setItem('ocrspace_api_key', this.value); showToast('‚úÖ API key kaydedildi', 'success');">
                        <a href="https://ocr.space/ocrapi" target="_blank" style="font-size: 0.85em; color: #2196F3; text-decoration: none;">üîó Key Al</a>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9em; color: #666; width: 120px;">üîë Azure Key:</label>
                        <input 
                            type="text" 
                            id="azureApiKeyInput" 
                            placeholder="Azure Computer Vision Key" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.85em; width: 200px;"
                            onchange="localStorage.setItem('azure_api_key', this.value); showToast('‚úÖ Azure key kaydedildi', 'success');">
                        <input 
                            type="text" 
                            id="azureEndpointInput" 
                            placeholder="https://YOUR-RESOURCE.cognitiveservices.azure.com/" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 0.85em; flex: 1;"
                            onchange="localStorage.setItem('azure_endpoint', this.value); showToast('‚úÖ Azure endpoint kaydedildi', 'success');">
                        <a href="https://portal.azure.com/" target="_blank" style="font-size: 0.85em; color: #2196F3; text-decoration: none;">üîó Key Al</a>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hammadde Kodu Se√ß:</label>
                <select id="tdsMaterialSelect" onchange="loadTDSForMaterial(false)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <option value="">Hammadde se√ßin...</option>
                </select>
            </div>
            
            <!-- Template ile TDS Otomatik Doldur -->
            <div id="tdsTemplateSection" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
                <div style="color: white; margin-bottom: 12px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 16px;">üé® Template ile TDS Doldur</h3>
                    <p style="margin: 0; font-size: 12px; opacity: 0.9;">Template se√ßin, √∂zellik adlarƒ± TDS'e eklensin</p>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; color: white; font-size: 13px; font-weight: 500;">üéØ Template Se√ß</label>
                        <select id="tdsTemplateSelect" style="width: 100%; padding: 9px; border: none; border-radius: 5px; font-size: 13px; background: white;">
                            <option value="">Template se√ßin...</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="processTDSTemplateOCR()" id="tdsProcessBtn" disabled
                            style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 14px; font-weight: 500; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap;">
                        ‚ûï TDS'e Ekle
                    </button>
                </div>
            </div>
            
            <div id="tdsContent" style="display: none;">
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <strong>üìù Not:</strong> √ñzellikleri tanƒ±mlayƒ±n. COA y√ºklenirken bu deƒüerlerle kar≈üƒ±la≈ütƒ±rƒ±lacak.
                </div>
                
                <button class="btn btn-sm btn-primary" onclick="addTDSProperty()" style="margin-bottom: 15px;">
                    ‚ûï Yeni √ñzellik Ekle
                </button>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; min-width: 150px;">√ñzellik Adƒ±</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; min-width: 80px;">Birim</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; min-width: 100px;">Standart</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 80px;">Operat√∂r</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px;">Standart Deƒüer</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px;">Alt Tolerans (-)</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px;">√úst Tolerans (+)</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #e8f5e9;">Alt Limit</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #e8f5e9;">√úst Limit</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #e3f2fd;">COA Deƒüeri</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; min-width: 100px; background: #fff3e0;">Durum</th>
                                <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 70px;">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="tdsPropertiesTable">
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                    <div id="ocrDataInfo" style="display: none; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 13px; color: #1976d2;">
                        üìä <span id="ocrDataCount">0</span> √∂zellik OCR ile okundu
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: auto;">
                        <button class="btn btn-secondary" onclick="closeTDSModal()">ƒ∞ptal</button>
                        <button id="transferOCRBtn" class="btn btn-success" onclick="transferOCRDataToCOA()" style="display: none; background: #4CAF50;">
                            üíæ Kaydet
                        </button>
                        <button class="btn btn-primary" onclick="saveTDS()">üíæ TDS Kaydet</button>
                    </div>
                </div>
            </div>
            
            <div id="tdsEmptyState" style="text-align: center; padding: 40px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                <p>Hammadde se√ßin ve √∂zellikleri tanƒ±mlayƒ±n</p>
            </div>
        </div>
    </div>
    
    <!-- Template Editor Modal -->
    <div class="modal" id="templateEditorModal">
        <span class="modal-close" onclick="closeTemplateEditor()">&times;</span>
        <div class="modal-content" style="max-width: 98%; width: 1900px; max-height: 98vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                <h2 style="margin: 0;">üé® COA Template Editor</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-info" onclick="document.getElementById('templateFileChangeInput').click()">üîÑ Dosya Deƒüi≈ütir</button>
                    <button class="btn btn-success" onclick="saveTemplateWithImage()">üíæ Template Kaydet</button>
                    <button class="btn btn-primary" onclick="loadTemplateWithImage()">üìÇ Template Y√ºkle</button>
                    <button class="btn btn-secondary" onclick="closeTemplateEditor()">‚ùå Kapat</button>
                </div>
            </div>
            <input type="file" id="templateFileChangeInput" accept="image/*,.pdf,.xlsx,.xls,.docx,.doc" style="display: none;" onchange="changeTemplateDocument(event)">
            
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                <strong>üìã Talimatlar:</strong>
                <ol style="margin: 8px 0 0 20px; padding: 0;">
                    <li>Mouse ile s√ºr√ºkleyerek her √∂zellik i√ßin 2 b√∂lge √ßizin: (1) √ñzellik adƒ± (sol), (2) COA deƒüeri (requirement s√ºtunu)</li>
                    <li>"üíæ Template Kaydet" ile Google Sheets'e kaydet (Mevcut varsa version artar: v1.0‚Üív1.1‚Üív1.2...)</li>
                    <li>Se√ßili b√∂lgelere tƒ±klayarak d√ºzenleyin: Ta≈üƒ±, yeniden boyutlandƒ±r, sil</li>
                    <li>"üìÇ Template Y√ºkle" ile Google Sheets'ten geri √ßaƒüƒ±r - g√∂rsel ve b√∂lgeler birebir gelecek!</li>
                </ol>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label style="font-size: 0.9em; font-weight: 600; margin-right: 5px;">Tedarik√ßi:</label>
                    <input type="text" id="templateSupplierName" placeholder="√ñrn: BASF" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 200px;">
                </div>
                <button class="btn btn-danger btn-sm" onclick="clearTemplateRegions()">üóëÔ∏è T√ºm√ºn√º Temizle</button>
            </div>
            
            <div style="display: flex; gap: 15px; flex: 1; overflow: hidden;">
                <div style="flex: 1; border: 2px solid #ddd; border-radius: 6px; overflow: auto; background: #f9f9f9; position: relative;">
                    <canvas id="templateCanvas" style="cursor: crosshair; display: block;"></canvas>
                </div>
                
                <div style="width: 320px; border: 2px solid #ddd; border-radius: 6px; padding: 12px; overflow-y: auto; background: white;">
                    <h3 style="color: #2c5f2d; margin-bottom: 12px; font-size: 16px;">üìç B√∂lgeler (<span id="templateRegionCount">0</span>)</h3>
                    <div id="templateRegionsList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Template Load Modal -->
    <div id="templateLoadModal" class="modal" style="z-index: 10002;">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                <h3 style="margin: 0; color: #2c5f2d;">üìÇ Kayƒ±tlƒ± Template'leri Y√ºkle</h3>
                <button onclick="document.getElementById('templateLoadModal').style.display='none'" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 16px;">‚ùå</button>
            </div>
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 0.9em; color: #0c5460;">
                    üìä Google Sheets'teki kayƒ±tlƒ± template'lerinizi se√ßin. G√∂rsel ve b√∂lgeler birebir y√ºklenecek.
                </p>
            </div>
            <div id="templateLoadList" style="flex: 1; overflow-y: auto; padding-right: 10px;"></div>
        </div>
    </div>
    
    <!-- Template Region Edit Modal -->
    <div class="modal" id="templateRegionModal" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 500px; padding: 25px;">
            <h3 style="color: #2c5f2d; margin-bottom: 20px;">B√∂lge Bilgileri</h3>
            
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label style="font-weight: 600;">TDS √ñzellik Adƒ±:</label>
                    <button type="button" onclick="showAddPropertyModal()" style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">‚ûï Ekle</button>
                </div>
                <select id="templatePropertyName" onchange="handlePropertyNameChange()" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Se√ßiniz --</option>
                </select>
            </div>
            
            <div id="templateSelectedPropertyInfo" style="margin-bottom: 15px; display: none; background: #e8f5e9; padding: 10px; border-radius: 4px; border-left: 4px solid #4caf50;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">Se√ßili √ñzellik:</div>
                        <div id="selectedPropertyDisplay" style="font-size: 14px; color: #1b5e20; font-weight: 500; margin-top: 2px;"></div>
                    </div>
                    <button type="button" onclick="removeSelectedProperty()" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">üóëÔ∏è Sil</button>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">B√∂lge Tipi:</label>
                <select id="templateRegionType" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="value">COA Deƒüeri (Requirement S√ºtunu)</option>
                    <option value="propertyName">√ñzellik Adƒ± (Sol S√ºtun)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">üîç OCR ile Okunan Deƒüer:</label>
                <div style="position: relative;">
                    <input type="text" id="templateOcrValue" placeholder="OCR okuma bekleniyor..." 
                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: #f8f9fa;">
                    <div id="templateOcrLoading" style="display: none; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
                        <span style="font-size: 12px; color: #666;">‚è≥ Okunuyor...</span>
                    </div>
                </div>
                <small style="color: #666; font-size: 12px;">üí° ƒ∞pucu: Otomatik okunan deƒüer yanlƒ±≈üsa manuel d√ºzenleyebilirsiniz</small>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveTemplateRegion()">‚úÖ Kaydet</button>
                <button class="btn btn-danger" onclick="closeTemplateRegionModal()">‚ùå ƒ∞ptal</button>
            </div>
        </div>
    </div>
    
    <!-- COA Analysis Modal -->
    <div class="modal" id="coaAnalysisModal">
        <span class="modal-close" onclick="closeCOAAnalysisModal()">&times;</span>
        <div class="modal-content" style="max-width: 95%; width: 1800px; max-height: 95vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìà COA Analiz - √ñzellik Trendleri</h2>
                <button id="exportAnalysisPdfBtn" onclick="exportAnalysisToPDF()" style="display: none; padding: 10px 20px; background: linear-gradient(135deg, #9c27b0, #673ab7); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;">
                    üìÑ PDF Dƒ±≈üa Aktar
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tedarik√ßi Se√ß:</label>
                    <select id="analysisSupplierSelect" onchange="loadAnalysisMaterials()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Tedarik√ßi se√ßin...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Hammadde Kodu Se√ß:</label>
                    <select id="analysisMaterialSelect" onchange="loadAnalysisProperties()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">√ñnce tedarik√ßi se√ßin...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Lokasyon:</label>
                    <select id="analysisLocationSelect" onchange="loadAnalysisChart()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">T√ºm√º</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Ba≈ülangƒ±√ß Tarihi:</label>
                    <input type="date" id="analysisStartDate" onchange="loadAnalysisChart()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Biti≈ü Tarihi:</label>
                    <input type="date" id="analysisEndDate" onchange="loadAnalysisChart()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">√ñzellikler Se√ß (√áoklu):</label>
                <div id="analysisPropertyContainer" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; max-height: 200px; overflow-y: auto; background: white;">
                    <div style="color: #999; text-align: center; padding: 20px;">√ñnce hammadde se√ßin...</div>
                </div>
                <button onclick="loadAnalysisChart()" style="margin-top: 10px; padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üìä Grafik Olu≈ütur</button>
            </div>
            
            <div id="analysisChartsContainer" style="display: none;">
                <!-- Her √∂zellik i√ßin ayrƒ± grafik buraya eklenecek -->
            </div>
            
            <div id="analysisEmptyState" style="text-align: center; padding: 60px; color: #999;">
                <div style="font-size: 64px; margin-bottom: 15px;">üìä</div>
                <p style="font-size: 1.1em;">Tedarik√ßi, hammadde ve √∂zellik se√ßin</p>
                <p style="font-size: 0.9em; margin-top: 10px;">COA kayƒ±tlarƒ±nƒ±zdaki √∂zelliklerin zaman i√ßindeki deƒüi≈üimini g√∂r√ºn</p>
            </div>
            

        </div>
    </div>
    
    <!-- Camera Modal -->
    <div class="modal" id="cameraModal">
        <span class="modal-close" onclick="closeCameraModal()">&times;</span>
        <div class="modal-content" style="background: #000; padding: 20px; max-width: 800px;">
            <h3 style="color: white; text-align: center; margin-bottom: 15px;">üì∑ Fotoƒüraf √áek</h3>
            <video id="cameraStream" autoplay playsinline style="width: 100%; max-height: 500px; border-radius: 8px; background: #000;"></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                <button class="btn btn-primary" onclick="capturePhoto()" style="padding: 12px 30px; font-size: 1.1em;">
                    üì∏ Fotoƒüraf √áek
                </button>
                <button class="btn btn-secondary" onclick="closeCameraModal()" style="padding: 12px 30px; font-size: 1.1em;">
                    ‚ùå ƒ∞ptal
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ==================== Library Loading Utilities ====================
        async function ensureLibraryLoaded(libraryName, checkFunc, fallbackUrls = []) {
            // Library already loaded
            if (checkFunc()) {
                console.log(`‚úÖ ${libraryName} zaten y√ºkl√º`);
                return true;
            }
            
            console.log(`‚è≥ ${libraryName} y√ºkleniyor...`);
            
            // Wait for library to load (max 5 seconds)
            const loaded = await new Promise(resolve => {
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (checkFunc()) {
                        clearInterval(checkInterval);
                        console.log(`‚úÖ ${libraryName} y√ºklendi`);
                        resolve(true);
                    } else if (attempts > 50) {
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
            
            if (loaded) return true;
            
            // Try fallback URLs
            for (const url of fallbackUrls) {
                console.log(`üîÑ ${libraryName} fallback deneniyor: ${url}`);
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = url;
                        script.onload = () => {
                            console.log(`‚úÖ ${libraryName} fallback ba≈üarƒ±lƒ±`);
                            resolve();
                        };
                        script.onerror = () => reject(new Error('Script load failed'));
                        document.head.appendChild(script);
                    });
                    
                    // Check again after loading
                    if (checkFunc()) {
                        return true;
                    }
                } catch (e) {
                    console.error(`‚ùå ${libraryName} fallback ba≈üarƒ±sƒ±z:`, e);
                }
            }
            
            throw new Error(`${libraryName} y√ºklenemedi`);
        }
        
        // ==================== Global Variables ====================
        let coaData = [];
        let suppliers = [];
        let materials = []; // Hammadde listesi
        let tdsData = {}; // TDS verileri: { materialCode: { properties: [] } }
        let selectedSuppliers = new Set(); // Se√ßili tedarik√ßiler
        let googleScriptUrl = 'https://script.google.com/macros/s/AKfycbz3KZblRoWV0uU7_LU24Wih4npAl2x8_vFWDjmc-F0bDeRHgmrSEi0XB-YsaaD0_i4u/exec';
        let selectedFile = null;
        let selectedFileData = null;
        let editMode = false;
        let editingId = null;
        let selectedItems = new Set();
        let currentTDSMaterial = null; // ≈ûu an d√ºzenlenen TDS hammaddesi
        let lastOCRMaterialCode = null; // Son OCR yapƒ±lan hammadde (modal a√ßƒ±lƒ±≈üta deƒüerleri korumak i√ßin)
        let currentRenderTask = null; // Aktif PDF render i≈ülemi
        let isProcessingFile = false; // Dosya i≈üleme kilidi
        let currentPage = 1; // Aktif sayfa numarasƒ±
        
        // Template √∂zellik adlarƒ± (localStorage'dan y√ºklenecek)
        let templatePropertyNames = [
            'Density',
            'hardness',
            'Fire behavior',
            'Thermal conductivity',
            'Emission of VOC'
        ];
        
        // Template Editor Global Variables
        let templateCanvas, templateCtx;
        let templateRegions = [];
        let currentTemplateRegion = null;
        let isTemplateDrawing = false;
        let templateStartX, templateStartY;
        let selectedTemplateRegionIndex = null;
        let templateImageObj = null;
        let templateScaleFactor = 1;
        let templateMode = false;
        let pendingTemplateFile = null;
        
        // B√∂lge d√ºzenleme deƒüi≈ükenleri
        let isDraggingRegion = false;
        let isResizingRegion = false;
        let resizeHandle = null; // 'tl', 'tr', 'bl', 'br', 'top', 'right', 'bottom', 'left'
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let editingRegionIndex = null; // D√ºzenlenmekte olan b√∂lgenin index'i
        
        // Dosya tipine g√∂re ikon olu≈ütur
        function getFileIcon(fileName, fileType, itemId) {
            // Dosya uzantƒ±sƒ±nƒ± al
            const extension = fileName ? fileName.split('.').pop().toLowerCase() : '';
            
            // Dosya tipine g√∂re ikon ve class belirle
            let iconEmoji = '';
            let iconText = '';
            let iconClass = '';
            
            // PDF
            if (extension === 'pdf' || fileType?.includes('pdf')) {
                iconEmoji = 'üìÑ';
                iconText = extension.toUpperCase(); // PDF
                iconClass = 'pdf';
            }
            // Word
            else if (extension === 'doc' || extension === 'docx' || fileType?.includes('word')) {
                iconEmoji = 'üìù';
                iconText = extension.toUpperCase(); // DOC veya DOCX
                iconClass = extension || 'doc';
            }
            // Excel
            else if (extension === 'xls' || extension === 'xlsx' || fileType?.includes('excel') || fileType?.includes('spreadsheet')) {
                iconEmoji = 'üìä';
                iconText = extension.toUpperCase(); // XLS veya XLSX
                iconClass = extension || 'xls';
            }
            // PNG / JPEG / JPG
            else if (['jpg', 'jpeg', 'png'].includes(extension) || (fileType?.startsWith('image/') && !['gif', 'bmp', 'webp'].includes(extension))) {
                iconEmoji = 'üñºÔ∏è';
                iconText = extension.toUpperCase(); // JPG, JPEG veya PNG
                iconClass = extension;
            }
            // GIF
            else if (extension === 'gif') {
                iconEmoji = 'üéûÔ∏è';
                iconText = extension.toUpperCase(); // GIF
                iconClass = 'gif';
            }
            // Diƒüer resim formatlarƒ± (BMP, WEBP)
            else if (['bmp', 'webp'].includes(extension) || fileType?.startsWith('image/')) {
                iconEmoji = 'üñºÔ∏è';
                iconText = extension.toUpperCase(); // BMP veya WEBP
                iconClass = extension;
            }
            // Text
            else if (extension === 'txt' || fileType?.includes('text')) {
                iconEmoji = 'üìã';
                iconText = extension.toUpperCase(); // TXT
                iconClass = 'txt';
            }
            // Bilinmeyen
            else {
                iconEmoji = 'üìé';
                iconText = extension ? extension.toUpperCase().substring(0, 3) : 'FILE';
                iconClass = 'unknown';
            }
            
            return '<div class="file-icon ' + iconClass + '" onclick="viewFile(\'' + itemId + '\')">' + 
                   '<div style="font-size: 1.5em; margin-bottom: 2px;">' + iconEmoji + '</div>' + 
                   '<div style="font-size: 0.65em; font-weight: 600;">' + iconText + '</div>' + 
                   '</div>';
        }
        
        // URL parametresinden tedarik√ßileri otomatik y√ºkle (Mobil link i√ßin)
        // NOT: URL √ßok uzun olduƒüu i√ßin (20,000+ karakter) WhatsApp ve √ßoƒüu tarayƒ±cƒ± keser
        // En iyi √ß√∂z√ºm: JSON dosyasƒ± indirip manuel y√ºklemek
        function loadSuppliersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const suppliersData = urlParams.get('suppliers');
            
            console.log('üîç URL kontrol ediliyor...');
            console.log('URL parametresi var mƒ±?', suppliersData ? 'Evet' : 'Hayƒ±r');
            
            if (suppliersData) {
                try {
                    console.log('üîì Base64 decode ediliyor... (uzunluk: ' + suppliersData.length + ')');
                    
                    // URL √ßok uzunsa uyarƒ± ver
                    if (suppliersData.length < 1000) {
                        showToast('‚ö†Ô∏è URL verisi eksik g√∂r√ºn√ºyor. JSON dosyasƒ± y√ºkleyin.', 'warning', 5000);
                        return false;
                    }
                    
                    // Base64 decode ve parse et
                    const suppliers = JSON.parse(decodeURIComponent(atob(suppliersData)));
                    
                    console.log('‚úÖ Parse ba≈üarƒ±lƒ±. Tedarik√ßi sayƒ±sƒ±:', suppliers.length);
                    
                    if (Array.isArray(suppliers) && suppliers.length > 0) {
                        // localStorage'a kaydet
                        localStorage.setItem('supplierListForCOA', JSON.stringify(suppliers));
                        console.log('üíæ localStorage\'a kaydedildi');
                        
                        // Dropdown'ƒ± g√ºncelle
                        const select = document.getElementById('supplier');
                        // Mevcut se√ßenekleri temizle (placeholder hari√ß)
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        // Tedarik√ßileri alfabetik sƒ±rala ve ekle
                        suppliers.sort().forEach(supplier => {
                            const option = document.createElement('option');
                            option.value = supplier;
                            option.textContent = supplier;
                            select.appendChild(option);
                        });
                        console.log('üîΩ Dropdown g√ºncellendi');
                        
                        // Ba≈üarƒ± mesajƒ± g√∂ster
                        showToast('‚úÖ ' + suppliers.length + ' tedarik√ßi mobilde y√ºklendi!', 'success', 4000);
                        
                        // URL'i temizle (parametreyi kaldƒ±r)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        console.log('üì± Mobil linkten tedarik√ßi y√ºklendi:', suppliers.length);
                        return true; // Ba≈üarƒ±lƒ±
                    }
                } catch (error) {
                    console.error('‚ùå URL\'den tedarik√ßi y√ºkleme hatasƒ±:', error);
                    showToast('‚ö†Ô∏è URL √ßok uzun veya bozuk. JSON dosyasƒ± y√ºkleyin.', 'warning', 5000);
                }
            }
            return false; // URL'de tedarik√ßi verisi yok
        }
        
        // ==================== Template Property Management ====================
        function loadTemplatePropertyNames() {
            const saved = localStorage.getItem('template_property_names');
            if (saved) {
                try {
                    templatePropertyNames = JSON.parse(saved);
                    console.log('üìã Template √∂zellik adlarƒ± y√ºklendi:', templatePropertyNames.length);
                    console.log('üÜî DOSYA VERSIYONU: 2026-02-11-04:02 (FUZZY TEMPLATE MATCHING + TDS SAVE IN BULK)');
                } catch (e) {
                    console.error('‚ùå Template property names parse hatasƒ±:', e);
                }
            }
        }
        
        function saveTemplatePropertyNames() {
            localStorage.setItem('template_property_names', JSON.stringify(templatePropertyNames));
        }
        
        function updateTemplatePropertyDropdown() {
            const select = document.getElementById('templatePropertyName');
            if (!select) return;
            
            const currentValue = select.value;
            
            // Clear existing options except first
            select.innerHTML = '<option value="">-- Se√ßiniz --</option>';
            
            // Add all property names
            templatePropertyNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (currentValue && templatePropertyNames.includes(currentValue)) {
                select.value = currentValue;
            }
            
            console.log('üîÑ Template property dropdown g√ºncellendi:', templatePropertyNames.length, '√∂zellik');
        }
        
        function handlePropertyNameChange() {
            const select = document.getElementById('templatePropertyName');
            const selectedValue = select.value;
            const infoDiv = document.getElementById('templateSelectedPropertyInfo');
            const displayDiv = document.getElementById('selectedPropertyDisplay');
            
            if (selectedValue) {
                infoDiv.style.display = 'block';
                displayDiv.textContent = selectedValue;
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        function showAddPropertyModal() {
            const propertyName = prompt('üéØ Yeni TDS √∂zellik adƒ±nƒ± girin:');
            if (propertyName && propertyName.trim()) {
                addPropertyToList(propertyName.trim());
            }
        }
        
        function addPropertyToList(propertyName) {
            // Check if already exists (case insensitive)
            const exists = templatePropertyNames.some(name => 
                name.toLowerCase() === propertyName.toLowerCase()
            );
            
            if (exists) {
                showToast('‚ö†Ô∏è Bu √∂zellik zaten listede mevcut', 'warning');
                return false;
            }
            
            // Add to list
            templatePropertyNames.push(propertyName);
            saveTemplatePropertyNames();
            updateTemplatePropertyDropdown();
            
            // Auto-select the new property
            document.getElementById('templatePropertyName').value = propertyName;
            handlePropertyNameChange();
            
            showToast(`‚úÖ "${propertyName}" listeye eklendi`, 'success');
            console.log('‚ûï Yeni √∂zellik eklendi:', propertyName);
            return true;
        }
        
        function removeSelectedProperty() {
            const select = document.getElementById('templatePropertyName');
            const propertyName = select.value;
            
            if (!propertyName) {
                showToast('‚ö†Ô∏è √ñnce bir √∂zellik se√ßin', 'warning');
                return;
            }
            
            if (!confirm(`"${propertyName}" √∂zelliƒüini listeden silmek istediƒüinizden emin misiniz?`)) {
                return;
            }
            
            // Remove from list
            const index = templatePropertyNames.indexOf(propertyName);
            if (index > -1) {
                templatePropertyNames.splice(index, 1);
                saveTemplatePropertyNames();
                updateTemplatePropertyDropdown();
                
                // Hide info div
                document.getElementById('templateSelectedPropertyInfo').style.display = 'none';
                
                showToast(`‚úÖ "${propertyName}" listeden silindi`, 'success');
                console.log('‚ûñ √ñzellik silindi:', propertyName);
            }
        }
        
        // Template'i d√ºzenlemek i√ßin y√ºkle
        async function editExistingTemplate() {
            // Mode'u i≈üaretle
            window.currentTemplateLoadMode = 'edit';
            
            // Google Sheets'ten template'leri y√ºkle
            await loadTemplatesFromGoogleSheets();
            
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            
            if (templates.length === 0) {
                showToast('‚ö†Ô∏è Kayƒ±tlƒ± template bulunamadƒ±! L√ºtfen √∂nce template olu≈üturun.', 'warning');
                return;
            }
            
            // Modal a√ß ve template'leri listele (edit mode i√ßin)
            const modal = document.getElementById('templateLoadModal');
            const list = document.getElementById('templateLoadList');
            
            list.innerHTML = templates.map((template, index) => {
                const date = new Date(template.createdAt).toLocaleDateString('tr-TR');
                const time = new Date(template.createdAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const hasImage = (template.imageUrl || template.imageData) ? '‚úÖ' : '‚ùå';
                const regionCount = template.regions?.length || template.template?.regions?.length || 0;
                
                return `
                    <div class="template-load-item" style="padding: 15px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 8px; transition: all 0.3s; background: white; position: relative;">
                        <div onclick="selectTemplateToEdit(${index})" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; padding-right: 35px;">
                                <div style="font-weight: 600; color: #2c5f2d; font-size: 1.1em;">${template.supplier}</div>
                                <div style="font-size: 0.85em; color: #666;">${date} ${time}</div>
                            </div>
                            <div style="display: flex; gap: 15px; font-size: 0.9em; color: #555;">
                                <span>${hasImage} G√∂rsel</span>
                                <span>üìç ${regionCount} B√∂lge</span>
                                <span>üìä v${template.version || '1.0'}</span>
                            </div>
                        </div>
                        <button onclick="deleteTemplate('${template.supplier}', ${index}); event.stopPropagation();" 
                                style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: background 0.3s;"
                                onmouseover="this.style.background='#c82333'" 
                                onmouseout="this.style.background='#dc3545'">
                            üóëÔ∏è Sil
                        </button>
                    </div>
                `;
            }).join('');
            
            modal.style.display = 'flex';
        }
        
        // Template'i edit i√ßin se√ß ve a√ß
        async function selectTemplateToEdit(index) {
            const modal = document.getElementById('templateLoadModal');
            if (!modal) {
                console.error('‚ùå templateLoadModal bulunamadƒ±');
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const template = templates[index];
            
            if (!template) {
                showToast('‚ùå Template bulunamadƒ±!', 'error');
                return;
            }
            
            console.log('‚úèÔ∏è Template edit i√ßin y√ºkleniyor:', template.supplier, 'v' + (template.version || '1.0'));
            
            // Modal'ƒ± kapat
            modal.style.display = 'none';
            
            // Template'i global deƒüi≈ükene y√ºkle
            window.currentEditingTemplate = template;
            window.currentEditingTemplateIndex = index;
            
            // Drive'dan g√∂rseli y√ºkle
            let imageLoaded = false;
            if (template.imageUrl) {
                // Drive linkinden file ID √ßƒ±kar
                const fileId = extractDriveFileId(template.imageUrl);
                console.log("üì• Template g√∂rseli Drive'dan y√ºkleniyor:", template.imageUrl);
                console.log("üÜî Drive File ID:", fileId);
                showToast('üì• Template g√∂rseli y√ºkleniyor...', 'info');
                
                try {
                    const imageData = await loadTemplateImageFromDrive(fileId);
                    if (imageData) {
                        selectedFileData = imageData;
                        
                        // Fake file object olu≈ütur
                        const fileName = `${template.supplier}_template.png`;
                        const byteString = atob(imageData.split(',')[1]);
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        const blob = new Blob([ab], { type: 'image/png' });
                        selectedFile = new File([blob], fileName, { type: 'image/png' });
                        
                        console.log("‚úÖ Template g√∂rseli Drive'dan y√ºklendi:", fileName);
                        imageLoaded = true;
                    }
                } catch (error) {
                    console.error('‚ùå Drive g√∂rsel y√ºkleme hatasƒ±:', error);
                    showToast('‚ö†Ô∏è G√∂rsel y√ºklenemedi, yeni bir g√∂rsel y√ºkleyin.', 'warning');
                }
            }
            
            // Eƒüer Drive'dan y√ºkleyemediysek ve template'de imageData varsa onu kullan (fallback)
            if (!imageLoaded && template.template && template.template.imageData) {
                console.log("üìÑ Template g√∂rseli imageData'dan y√ºkleniyor (fallback)");
                selectedFileData = template.template.imageData;
                
                const fileName = `${template.supplier}_template.png`;
                const byteString = atob(template.template.imageData.split(',')[1]);
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([ab], { type: 'image/png' });
                selectedFile = new File([blob], fileName, { type: 'image/png' });
                
                console.log("‚úÖ Template g√∂rseli imageData'dan y√ºklendi:", fileName);
                imageLoaded = true;
            }
            
            if (!imageLoaded) {
                showToast('‚ö†Ô∏è Bu template g√∂rsel i√ßermiyor. Yeni bir g√∂rsel y√ºkleyin.', 'warning');
            }
            
            // Template editor'ƒ± a√ß (edit mode)
            templateMode = true;
            document.getElementById('templateModeCheckbox').checked = true;
            
            // Kaydedilmi≈ü template bilgilerini sakla (scale i√ßin)
            const templateObj = template.template || template;
            window.savedTemplateConfig = {
                canvasWidth: templateObj.canvasWidth,
                canvasHeight: templateObj.canvasHeight,
                scaleFactor: templateObj.scaleFactor || 1
            };
            console.log('üìå Kaydedilmi≈ü template config y√ºklendi:', window.savedTemplateConfig);
            
            // Template b√∂lgelerini √ñNCE y√ºkle (openTemplateEditorWithFile i√ßinde kullanƒ±lacak)
            if (templateObj.regions && templateObj.regions.length > 0) {
                console.log('üìç Template b√∂lgeleri hazƒ±rlanƒ±yor:', templateObj.regions.length, 'b√∂lge');
                window.pendingTemplateRegions = templateObj.regions;
            }
            
            // Editor'ƒ± a√ß (pendingTemplateRegions kullanacak)
            await openTemplateEditorWithFile(selectedFile);
        }
        
        // Drive linkinden file ID √ßƒ±kar
        function extractDriveFileId(url) {
            if (!url) return '';
            
            // Eƒüer zaten file ID ise (hi√ß / i√ßermiyor), direkt d√∂nd√ºr
            if (!url.includes('/') && !url.includes(':')) {
                return url;
            }
            
            // https://drive.google.com/file/d/FILE_ID/view formatƒ±
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return match[1];
            }
            
            // https://drive.google.com/open?id=FILE_ID formatƒ±
            const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (match2 && match2[1]) {
                return match2[1];
            }
            
            // Diƒüer durumlar i√ßin URL'in kendisini d√∂nd√ºr
            return url;
        }
        
        // Drive'dan template g√∂rselini y√ºkle
        async function loadTemplateImageFromDrive(fileId) {
            if (!fileId) {
                console.error('‚ùå File ID bo≈ü!');
                return null;
            }
            
            try {
                const response = await new Promise((resolve, reject) => {
                    const callbackName = 'jsonpCallback_' + Math.random().toString(36).substring(7);
                    
                    window[callbackName] = function(data) {
                        delete window[callbackName];
                        resolve(data);
                    };
                    
                    const script = document.createElement('script');
                    script.src = `${googleScriptUrl}?action=getTemplateImage&fileId=${encodeURIComponent(fileId)}&callback=${callbackName}`;
                    script.onerror = () => reject(new Error('Script y√ºklenemedi'));
                    document.body.appendChild(script);
                    
                    setTimeout(() => {
                        document.body.removeChild(script);
                        reject(new Error('Timeout'));
                    }, 30000);
                });
                
                if (response.success) {
                    console.log('‚úÖ Drive g√∂rsel ba≈üarƒ±yla y√ºklendi');
                    return response.imageData;
                } else {
                    console.error('‚ùå Drive g√∂rsel y√ºkleme hatasƒ±:', response.error);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Drive g√∂rsel y√ºkleme exception:', error);
                return null;
            }
        }
        
        async function saveTemplate() {
            const supplierName = document.getElementById('templateSupplierName').value.trim();
            
            if (!supplierName) {
                alert('L√ºtfen tedarik√ßi adƒ± girin!');
                return;
            }
            
            if (templateRegions.length === 0) {
                alert('L√ºtfen en az bir b√∂lge i≈üaretleyin!');
                return;
            }
            
            // Mevcut template'leri y√ºkle ve aynƒ± supplier'ƒ± bul
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const existingIndex = templates.findIndex(t => {
                const tSupplier = (t.template?.supplier || t.supplier || '').trim().toLowerCase();
                return tSupplier === supplierName.toLowerCase();
            });
            
            let newVersion = '1.0';
            let isUpdate = false;
            
            if (existingIndex !== -1) {
                // Mevcut template var - version'ƒ± artƒ±r
                const existing = templates[existingIndex].template || templates[existingIndex];
                const currentVersion = existing.version || '1.0';
                const [major, minor] = currentVersion.split('.').map(Number);
                
                // Minor version artƒ±r (1.0 -> 1.1 -> 1.2 ...)
                newVersion = `${major}.${minor + 1}`;
                isUpdate = true;
                
                console.log(`üîÑ Mevcut template g√ºncelleniyor: v${currentVersion} ‚Üí v${newVersion}`);
            } else {
                console.log('‚ûï Yeni template olu≈üturuluyor: v1.0');
            }
            
            // Orijinal g√∂rseli kaydet (b√∂lgeler olmadan)
            let originalImageData = null;
            if (templateImageObj) {
                // Ge√ßici canvas olu≈ütur ve sadece g√∂rseli √ßiz (b√∂lgeler olmadan)
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = templateCanvas.width;
                tempCanvas.height = templateCanvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(templateImageObj, 0, 0, templateCanvas.width, templateCanvas.height);
                originalImageData = tempCanvas.toDataURL('image/png', 1.0);
                console.log('üì∏ Orijinal g√∂rsel kaydedildi (b√∂lgeler olmadan)');
            }
            
            const template = {
                supplier: supplierName,
                version: newVersion,
                createdAt: new Date().toISOString(),
                canvasWidth: templateCanvas.width,
                canvasHeight: templateCanvas.height,
                scaleFactor: templateScaleFactor,
                imageData: originalImageData || templateCanvas.toDataURL('image/png', 1.0), // Orijinal g√∂rsel (b√∂lgeler olmadan)
                regions: templateRegions.map(r => ({
                    propertyName: r.propertyName,
                    type: r.type,
                    x: Math.round(r.x / templateScaleFactor),
                    y: Math.round(r.y / templateScaleFactor),
                    width: Math.round(r.width / templateScaleFactor),
                    height: Math.round(r.height / templateScaleFactor)
                }))
            };
            
            // Save to localStorage and Google Sheets
            try {
                if (isUpdate) {
                    // Mevcut template'i g√ºncelle
                    templates[existingIndex] = template;
                    console.log(`‚úÖ Template g√ºncellendi: ${supplierName} v${newVersion}`);
                } else {
                    // Yeni template ekle
                    templates.push(template);
                    console.log(`‚úÖ Yeni template eklendi: ${supplierName} v${newVersion}`);
                }
                
                localStorage.setItem('coaTemplates', JSON.stringify(templates));
                
                showToast(`üíæ Template kaydediliyor (v${newVersion})...`, 'info');
                
                // Google Sheets'e kaydet
                await saveTemplateToGoogleSheets(template, isUpdate);
                
                // Edit mode deƒüi≈ükenlerini temizle
                if (window.currentEditingTemplate) {
                    console.log('‚úÖ Edit mode tamamlandƒ±. Deƒüi≈ükenler temizleniyor.');
                    window.currentEditingTemplate = null;
                    window.currentEditingTemplateIndex = null;
                }
                
            } catch (error) {
                console.error('‚ùå Template kaydetme hatasƒ±:', error);
                alert('‚ùå Template kaydetme hatasƒ±: ' + error.message);
            }
        }
        
        async function saveTemplateToGoogleSheets(template, isUpdate = false) {
            console.log('üíæ Template localStorage\'da kaydedildi');
            
            // Google Sheets'e kaydet (XMLHttpRequest POST)
            if (googleScriptUrl) {
                try {
                    // Her zaman saveTemplate action kullan (backend zaten update/insert karar veriyor)
                    console.log(`üì§ Google Sheets'e template g√∂nderiliyor (${isUpdate ? 'G√úNCELLEME' : 'YENƒ∞'})...`);
                    
                    // Template'i imageData ile birlikte g√∂nder (Drive'a y√ºklenecek)
                    const templateForSheets = {
                        supplier: template.supplier,
                        version: template.version,
                        createdAt: template.createdAt,
                        canvasWidth: template.canvasWidth,
                        canvasHeight: template.canvasHeight,
                        scaleFactor: template.scaleFactor,
                        imageData: template.imageData, // Drive'a y√ºklenecek
                        regions: template.regions
                    };
                    
                    const result = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.timeout = 120000; // 120 saniye (b√ºy√ºk template dosyalarƒ± i√ßin)
                        
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                try {
                                    resolve(JSON.parse(xhr.responseText));
                                } catch(e) {
                                    reject(new Error('JSON parse hatasƒ±'));
                                }
                            } else {
                                reject(new Error('HTTP ' + xhr.status));
                            }
                        };
                        
                        xhr.onerror = () => reject(new Error('Network error'));
                        xhr.ontimeout = () => reject(new Error('Timeout'));
                        
                        xhr.open('POST', googleScriptUrl, true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        
                        const formData = new URLSearchParams();
                        formData.append('action', 'saveTemplate'); // Her zaman saveTemplate
                        formData.append('template', JSON.stringify(templateForSheets));
                        
                        xhr.send(formData.toString());
                    });
                    
                    if (result && result.success) {
                        console.log(`‚úÖ Template Google Sheets'e ${isUpdate ? 'g√ºncellendi' : 'kaydedildi'}: v${template.version}`);
                        showToast(`‚úÖ Template ba≈üarƒ±yla ${isUpdate ? 'g√ºncellendi' : 'kaydedildi'} (v${template.version})!`, 'success', 5000);
                        
                        // Template listesini g√ºncelle
                        await loadTemplatesFromGoogleSheets();
                    } else {
                        console.warn('‚ö†Ô∏è Template kaydedilemedi:', result?.error);
                        showToast('‚ö†Ô∏è Template sadece local\'de', 'warning');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Google Sheets template kaydetme hatasƒ±:', error.message);
                    showToast('‚ö†Ô∏è Template sadece local\'de', 'warning');
                }
            }
            
            closeTemplateEditor();
        }
        
        async function saveTemplateWithImage() {
            // Sadece Google Sheets'e kaydet (JSON indirme kaldƒ±rƒ±ldƒ±)
            await saveTemplate();
        }
        
        function closeTemplateEditor() {
            document.getElementById('templateEditorModal').classList.remove('show');
            document.getElementById('templateModeCheckbox').checked = false;
            templateMode = false;
            templateRegions = [];
            selectedTemplateRegionIndex = null;
            pendingTemplateFile = null;
            editingRegionIndex = null;
        }
        
        // Template d√ºzenleme sƒ±rasƒ±nda dosya deƒüi≈ütir
        async function changeTemplateDocument(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üîÑ Template dosyasƒ± deƒüi≈ütiriliyor:', file.name);
            
            // Mevcut b√∂lgeleri sakla
            const keepRegions = templateRegions.length > 0 && confirm(
                `üìç Mevcut ${templateRegions.length} b√∂lge var.\n\n` +
                '‚úÖ EVET: B√∂lgeleri koru (koordinatlarƒ± yeni dosyaya g√∂re ayarlanacak)\n' +
                '‚ùå HAYIR: B√∂lgeleri sil ve sƒ±fƒ±rdan ba≈üla'
            );
            
            const oldRegions = keepRegions ? [...templateRegions] : [];
            const oldWidth = templateCanvas.width;
            const oldHeight = templateCanvas.height;
            
            // Canvas'ƒ± temizle
            if (!keepRegions) {
                templateRegions = [];
                selectedTemplateRegionIndex = null;
            }
            
            // Dosyayƒ± y√ºkle
            try {
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
                    await loadTemplatePDF(file);
                } else if (fileType.includes('spreadsheet') || fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    await loadTemplateExcel(file);
                } else if (fileType.includes('word') || fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                    await loadTemplateWord(file);
                } else if (fileType.startsWith('image/')) {
                    await loadTemplateImage(file);
                } else {
                    showToast('‚ö†Ô∏è Desteklenmeyen dosya t√ºr√º!', 'warning');
                    return;
                }
                
                // B√∂lgeleri koru ve √∂l√ßeklendir
                if (keepRegions && oldRegions.length > 0) {
                    const scaleX = templateCanvas.width / oldWidth;
                    const scaleY = templateCanvas.height / oldHeight;
                    
                    templateRegions = oldRegions.map(region => ({
                        ...region,
                        x: region.x * scaleX,
                        y: region.y * scaleY,
                        width: region.width * scaleX,
                        height: region.height * scaleY
                    }));
                    
                    console.log(`‚úÖ ${templateRegions.length} b√∂lge yeni dosyaya uyarlandƒ± (${scaleX.toFixed(2)}x, ${scaleY.toFixed(2)}y)`);
                    updateTemplateRegionsList();
                    redrawTemplateCanvas();
                }
                
                showToast(`‚úÖ ${file.name} y√ºklendi!`, 'success');
            } catch (error) {
                console.error('‚ùå Dosya y√ºkleme hatasƒ±:', error);
                showToast('‚ùå Dosya y√ºklenemedi: ' + error.message, 'error');
            }
            
            // Input'u temizle
            event.target.value = '';
        }
        
        // B√∂lge d√ºzenleme fonksiyonu (HTML inline handler'dan eri≈üilebilir olmalƒ±)
        function editTemplateRegion(index) {
            editingRegionIndex = index;
            const region = templateRegions[index];
            
            // Modal'ƒ± a√ß ve mevcut deƒüerleri y√ºkle
            document.getElementById('templateRegionModal').classList.add('show');
            document.getElementById('templatePropertyName').value = region.propertyName || '';
            document.getElementById('templateRegionType').value = region.type || 'value';
            
            const ocrInput = document.getElementById('templateOcrValue');
            if (ocrInput) {
                ocrInput.value = region.ocrValue || '';
                ocrInput.placeholder = 'OCR deƒüeri';
                ocrInput.style.background = '#ffffff';
            }
            
            // currentTemplateRegion'u g√ºncelle (resize/drag i√ßin)
            currentTemplateRegion = { ...region };
            
            console.log('‚úèÔ∏è B√∂lge d√ºzenleme modu:', region.propertyName);
        }
        
        function toggleTemplateMode() {
            templateMode = document.getElementById('templateModeCheckbox').checked;
            
            if (templateMode) {
                // Template mode ON
                showToast('üé® Template modu aktif - Dosya y√ºkleyin', 'info');
            } else {
                // Template mode OFF
                closeTemplateEditor();
            }
        }
        
        // Drag & Drop i≈ülevselliƒüi
        function initDragDrop() {
            const dragDropArea = document.getElementById('dragDropArea');
            const fileInput = document.getElementById('fileInput');
            
            if (!dragDropArea || !fileInput) return;
            
            // Drag events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Highlight on drag
            ['dragenter', 'dragover'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, () => {
                    dragDropArea.style.borderColor = '#4CAF50';
                    dragDropArea.style.background = 'linear-gradient(135deg, #c8e6c9 0%, #e8f5e9 100%)';
                    dragDropArea.style.transform = 'scale(1.02)';
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, () => {
                    dragDropArea.style.borderColor = '#2196F3';
                    dragDropArea.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%)';
                    dragDropArea.style.transform = 'scale(1)';
                }, false);
            });
            
            // Handle drop
            dragDropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // FileInput'a dosyayƒ± ata ve change event'ini tetikle
                    fileInput.files = files;
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }, false);
        }
        
        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // PDF.js worker ayarla (global)
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                console.log('‚úÖ PDF.js worker ayarlandƒ±');
            }
            
            // Load template property names from localStorage
            loadTemplatePropertyNames();
            updateTemplatePropertyDropdown();
            
            // K√ºt√ºphane y√ºkleme kontrol√º
            console.log('üìö K√ºt√ºphane kontrol√º:');
            console.log('  - XLSX:', typeof XLSX !== 'undefined' ? '‚úÖ Y√ºklendi' : '‚ùå Y√ºklenmedi');
            console.log('  - mammoth:', typeof mammoth !== 'undefined' ? '‚úÖ Y√ºklendi' : '‚ùå Y√ºklenmedi');
            console.log('  - html2canvas:', typeof html2canvas !== 'undefined' ? '‚úÖ Y√ºklendi' : '‚ùå Y√ºklenmedi');
            console.log('  - pdfjsLib:', typeof pdfjsLib !== 'undefined' ? '‚úÖ Y√ºklendi' : '‚ùå Y√ºklenmedi');
            console.log('  - Tesseract:', typeof Tesseract !== 'undefined' ? '‚úÖ Y√ºklendi' : '‚ùå Y√ºklenmedi');
            
            // Eski ana sayfadan gelen tedarik√ßi listesini temizle (artƒ±k kullanmƒ±yoruz)
            localStorage.removeItem('supplierListForCOA');
            
            // √ñnce URL'den tedarik√ßileri y√ºkle (mobil link varsa)
            loadSuppliersFromURL();
            
            // Google Sheets'ten TDS verilerini y√ºkle (arka planda)
            loadTDSFromGoogleSheets().catch(err => {
                console.log('‚ö†Ô∏è Google Sheets TDS y√ºkleme ba≈üarƒ±sƒ±z, localStorage kullanƒ±lƒ±yor');
            });
            
            // Template listesini y√ºkle
            loadTemplatesFromGoogleSheets().catch(err => {
                console.log('‚ö†Ô∏è Template listesi y√ºklenemedi, localStorage kullanƒ±lƒ±yor');
                updateTemplateDropdown(); // LocalStorage'dakilerle dropdown'ƒ± doldur
            });
            
            // Set default date to today
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            
            // Init upload area
            initUploadArea();
            
            // Init drag & drop
            initDragDrop();
            
            // Init filters
            document.getElementById('searchInput').addEventListener('input', filterList);
            document.getElementById('filterMonth').addEventListener('change', filterList);
            
            // Init multiselect
            initSupplierMultiselect();
            
            // Load suppliers from localStorage (from index.html)
            loadSuppliers();
            
            // TEST: Kaydet butonunu test et
            console.log('üîß TEST: Kaydet butonu kontrol√º');
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                console.log('‚úÖ Kaydet butonu bulundu');
                console.log('üîç onclick:', saveBtn.onclick);
            } else {
                console.error('‚ùå Kaydet butonu bulunamadƒ±!');
            }
            
            // Load TDS data
            loadTDSData();
            
            // Load materials from localStorage
            loadMaterials();
            
            // ƒ∞rsaliye checkbox'larƒ±na event listener ekle
            const autoFillDateCheckbox = document.getElementById('autoFillDeliveryDate');
            const autoFillNoCheckbox = document.getElementById('autoFillDeliveryNo');
            
            if (autoFillDateCheckbox) {
                autoFillDateCheckbox.addEventListener('change', function() {
                    const materialInput = document.getElementById('materialCode');
                    const value = materialInput?.value?.trim();
                    if (value) {
                        handleMaterialBlur();
                    }
                });
            }
            
            if (autoFillNoCheckbox) {
                autoFillNoCheckbox.addEventListener('change', function() {
                    const materialInput = document.getElementById('materialCode');
                    const value = materialInput?.value?.trim();
                    if (value) {
                        handleMaterialBlur();
                    }
                });
            }
            
            // üíæ ƒ∞lk y√ºklemede localStorage'dan y√ºkle (FALLBACK - Sheets yoksa)
            // Sheets baƒülantƒ±sƒ± sonra connectGoogleSheets() ile g√ºncelleyecek
            await loadFromLocalStorage();
            
            // Sayfa ba≈üƒ±na kayƒ±t sayƒ±sƒ±nƒ± localStorage'dan y√ºkle
            const savedRowsPerPage = localStorage.getItem('rowsPerPage');
            if (savedRowsPerPage) {
                const rowsSelect = document.getElementById('rowsPerPage');
                if (rowsSelect) {
                    rowsSelect.value = savedRowsPerPage;
                }
            }
            
            if (coaData.length > 0) {
                renderTable();
                updateStats();
                
                // Kullanƒ±cƒ±ya bilgi g√∂ster
                const recordCount = coaData.length;
                showToast(`‚úÖ ${recordCount} kayƒ±t y√ºklendi`, 'success', 3000);
            }
            
            // Tedarik√ßi ve hammadde sayƒ±larƒ±nƒ± g√∂ster
            if (suppliers.length > 0) {
                console.log(`üìã ${suppliers.length} tedarik√ßi y√ºklendi`);
            }
            if (materials.length > 0) {
                console.log(`üîß ${materials.length} hammadde kodu y√ºklendi`);
            }
            
            // Doƒüru URL - her zaman bu URL kulanƒ±lsƒ±n
            const correctUrl = 'https://script.google.com/macros/s/AKfycbz3KZblRoWV0uU7_LU24Wih4npAl2x8_vFWDjmc-F0bDeRHgmrSEi0XB-YsaaD0_i4u/exec';
            
            // Her zaman default URL'yi kullan ve kaydet
            localStorage.setItem('google_script_url', correctUrl);
            document.getElementById('googleScriptUrl').value = correctUrl;
            googleScriptUrl = correctUrl;
            
            // Baƒülantƒ±yƒ± ba≈ülat
            setTimeout(function() {
                connectGoogleSheets(true);
            }, 100);
        });
        
        // ==================== JSONP Helper ====================
        function jsonp(url, retries = 3) {
            return new Promise((resolve, reject) => {
                let currentRetry = 0;
                
                function tryConnect() {
                    const callbackName = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    const script = document.createElement('script');
                    script.charset = 'utf-8';
                    
                    const timeout = setTimeout(() => {
                        cleanup();
                        if (currentRetry < retries) {
                            currentRetry++;
                            console.log(`‚è±Ô∏è Timeout - Baƒülantƒ± denemesi ${currentRetry}/${retries}...`);
                            tryConnect();
                        } else {
                            reject(new Error('Timeout - T√ºm denemeler ba≈üarƒ±sƒ±z'));
                        }
                    }, 15000); // 15 saniye timeout
                    
                    function cleanup() {
                        clearTimeout(timeout);
                        delete window[callbackName];
                        if (script.parentNode) script.parentNode.removeChild(script);
                    }
                    
                    window[callbackName] = (data) => {
                        console.log('‚úÖ JSONP callback alƒ±ndƒ±:', callbackName);
                        cleanup();
                        resolve(data);
                    };
                    
                    script.onload = () => {
                        console.log('üìú Script y√ºklendi, callback bekleniyor...:', callbackName);
                    };
                    
                    script.onerror = () => {
                        console.warn('‚ùå Script loading hatasƒ±:', url);
                        cleanup();
                        if (currentRetry < retries) {
                            currentRetry++;
                            console.log(`üîÑ Baƒülantƒ± hatasƒ±, deneme ${currentRetry}/${retries}...`);
                            setTimeout(tryConnect, 1500);
                        } else {
                            reject(new Error('Script loading hatasƒ±'));
                        }
                    };
                    
                    const fullUrl = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                    console.log('üåê JSONP URL:', fullUrl.substring(0, 150) + '...');
                    script.src = fullUrl;
                    document.body.appendChild(script);
                }
                
                tryConnect();
            });
        }
        
        // JSONP Request with parameters
        function jsonpRequest(baseUrl, params = {}, retries = 3) {
            const queryString = Object.keys(params)
                .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                .join('&');
            const url = baseUrl + (baseUrl.includes('?') ? '&' : '?') + queryString;
            return jsonp(url, retries);
        }
        
        // ==================== Google Sheets ====================
        async function collectAllFiles() {
            if (!googleScriptUrl) {
                showToast('‚ùå Google Sheets baƒülantƒ±sƒ± gerekli!', 'error');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Dosyalar toplanƒ±yor...';
            
            try {
                showToast('üìÅ T√ºm COA ve template dosyalarƒ± toplanƒ±yor...', 'info');
                
                // JSONP ile API √ßaƒürƒ±sƒ±
                const result = await jsonpRequest(googleScriptUrl, { action: 'collectAllFiles' });
                
                if (result.success) {
                    const stats = result.stats;
                    const message = `
                        ‚úÖ Dosyalar ba≈üarƒ±yla toplandƒ±!
                        \nüì¶ Bulunan: ${stats.totalFound}
                        \n‚úÖ Kopyalanan: ${stats.copied}
                        \n‚ùå Hata: ${stats.errors}
                    `;
                    
                    showToast(message, 'success');
                    
                    // Modal ile sonu√ßlarƒ± g√∂ster
                    const modalContent = `
                        <div style="padding: 20px;">
                            <h2 style="color: #2c5f2d; margin-bottom: 20px;">üìÅ Dosya Toplama Sonu√ßlarƒ±</h2>
                            
                            <div style="background: #f0f9f4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="margin-bottom: 15px;">üìä ƒ∞statistikler</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: bold; color: #2c5f2d;">${stats.totalFound}</div>
                                        <div style="color: #666;">Toplam Bulunan</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: bold; color: #4a8f5c;">${stats.copied}</div>
                                        <div style="color: #666;">Kopyalanan</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 2em; font-weight: bold; color: #e74c3c;">${stats.errors}</div>
                                        <div style="color: #666;">Hata</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="margin-bottom: 10px;">üìÇ Drive Klas√∂r√º</h3>
                                <p style="margin-bottom: 10px;"><strong>Klas√∂r Adƒ±:</strong> ${result.folderName}</p>
                                <a href="${result.folderUrl}" target="_blank" style="display: inline-block; background: #2c5f2d; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; margin-top: 10px;">
                                    üîó Klas√∂r√º A√ß
                                </a>
                            </div>
                            
                            ${result.copiedFiles && result.copiedFiles.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h3 style="margin-bottom: 10px;">‚úÖ Kopyalanan Dosyalar</h3>
                                    <div style="max-height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                                        ${result.copiedFiles.map(f => `
                                            <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                                <strong>${f.fileName}</strong>
                                                <div style="color: #666; font-size: 0.9em;">
                                                    Kaynak: ${f.source}${f.supplier ? ` - ${f.supplier}` : ''}${f.row ? ` (Satƒ±r ${f.row})` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${result.errorFiles && result.errorFiles.length > 0 ? `
                                <div>
                                    <h3 style="margin-bottom: 10px; color: #e74c3c;">‚ùå Hata Alan Dosyalar</h3>
                                    <div style="max-height: 200px; overflow-y: auto; background: #fff5f5; padding: 15px; border-radius: 6px; border: 1px solid #fcc;">
                                        ${result.errorFiles.map(f => `
                                            <div style="padding: 8px; border-bottom: 1px solid #fcc;">
                                                <strong>Kaynak:</strong> ${f.source}${f.supplier ? ` - ${f.supplier}` : ''}${f.row ? ` (Satƒ±r ${f.row})` : ''}
                                                <div style="color: #c0392b; font-size: 0.9em;">${f.error}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="document.getElementById('collectFilesModal').style.display='none'" style="background: #2c5f2d; color: white; padding: 10px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;">
                                    Kapat
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Modal olu≈ütur veya g√ºncelle
                    let modal = document.getElementById('collectFilesModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'collectFilesModal';
                        modal.className = 'modal';
                        document.body.appendChild(modal);
                    }
                    modal.innerHTML = `<div class="modal-content" style="max-width: 900px;">${modalContent}</div>`;
                    modal.style.display = 'block';
                    
                    // Modal dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    };
                } else {
                    showToast('‚ùå Hata: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('‚ùå Dosya toplama hatasƒ±:', error);
                showToast('‚ùå Dosya toplama hatasƒ±: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function connectGoogleSheets(silent = false) {
            const url = document.getElementById('googleScriptUrl').value.trim();
            if (!url) {
                if (!silent) showToast('‚ùå URL gerekli!', 'error');
                return;
            }
            
            // URL formatƒ±nƒ± kontrol et
            if (!url.includes('script.google.com') || !url.includes('/exec')) {
                if (!silent) showToast('‚ùå Ge√ßersiz Google Apps Script URL!', 'error');
                return;
            }
            
            document.getElementById('statusText').textContent = 'Baƒülanƒ±yor...';
            
            try {
                // JSONP ile baƒülantƒ± testi (CORS sorunsuz)
                console.log('üîó Google Sheets baƒülantƒ± testi ba≈ülatƒ±lƒ±yor (JSONP)...');
                
                const data = await jsonpRequest(url, { action: 'test' }, 2);
                console.log('üì¶ Test response:', data);
                
                if (data.success) {
                    googleScriptUrl = url;
                    localStorage.setItem('google_script_url', url);
                    document.getElementById('statusDot').classList.add('connected');
                    document.getElementById('statusText').textContent = 'Google Sheets Baƒülƒ± ‚úì';
                    await loadFromGoogleSheets();
                    if (!silent) {
                        showToast('‚úÖ Baƒülantƒ± ba≈üarƒ±lƒ±! ' + (data.message || ''), 'success');
                        showToast('üìÅ Not: T√ºm dosyalar otomatik olarak "COA_Merkezi_Arsiv" klas√∂r√ºne kopyalanƒ±r', 'info', 5000);
                    }
                    
                    // Bekleyen kayƒ±tlarƒ± senkronize et
                    setTimeout(() => syncPendingRecords(), 2000);
                } else {
                    throw new Error(data.error || 'Bilinmeyen hata');
                }
            } catch (error) {
                console.error('Google Sheets baƒülantƒ± hatasƒ±:', error);
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Baƒülantƒ± ba≈üarƒ±sƒ±z';
                
                // FALLBACK: localStorage'dan y√ºkle
                const localCount = coaData.length;
                if (localCount > 0) {
                    console.log(`üíæ FALLBACK: ${localCount} kayƒ±t localStorage'dan kullanƒ±lƒ±yor`);
                    if (!silent) {
                        showToast(`‚ö†Ô∏è Sheets baƒülantƒ±sƒ± yok, ${localCount} yerel kayƒ±t kullanƒ±lƒ±yor`, 'warning', 5000);
                        showToast('üí° Apps Script deployment yapƒ±n', 'info', 5000);
                    }
                } else {
                    if (!silent) {
                        showToast('üö® NE SHEETS NE DE YEREL VERƒ∞ YOK!', 'error', 8000);
                        showToast('üí° Apps Script\'i deploy edin veya yedek dosya y√ºkleyin', 'info', 8000);
                    }
                }
            }
            updateUI();
        }
        
        async function loadFromGoogleSheets() {
            try {
                console.log('Google Sheets\'ten veri y√ºkleniyor...');
                showToast('üîÑ Veriler y√ºkleniyor...', 'info');
                
                const data = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 120000; // 120 saniye (b√ºy√ºk dosyalar i√ßin)
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'getAllCOA');
                    formData.append('includeFileData', 'true');
                    
                    xhr.send(formData.toString());
                });
                
                if (data && data.success) {
                    // Kayƒ±tlarƒ± al (fileData dahil)
                    coaData = (data.data || []).map(record => {
                        // ocrProperties parse et (JSON string ise)
                        let ocrProps = null;
                        if (record.ocrProperties) {
                            try {
                                ocrProps = typeof record.ocrProperties === 'string' 
                                    ? JSON.parse(record.ocrProperties) 
                                    : record.ocrProperties;
                            } catch(e) {
                                console.warn('ocrProperties parse hatasƒ±:', e);
                            }
                        }
                        
                        return {
                            id: record.id,
                            supplier: record.supplier,
                            materialCode: record.materialCode,
                            deliveryDate: record.deliveryDate,
                            deliveryNo: record.deliveryNo || '',
                            lotNumber: record.lotNumber || '',
                            location: record.location || '',
                            notes: record.notes || '',
                            fileName: record.fileName || '',
                            fileType: record.fileType || '',
                            fileUrl: record.fileUrl || '',
                            // fileData bo≈üsa (PDF/√ßok sayfalƒ±), Drive\'dan y√ºklenecek
                            fileData: record.fileData || '',
                            fileSize: record.fileSize || 0,
                            driveFileId: record.driveFileId || '',
                            ocrProperties: ocrProps, // COA deƒüerleri
                            createdAt: record.createdAt || '',
                            updatedAt: record.updatedAt || '',
                            // Eƒüer fileData bo≈ü ama driveFileId varsa, direkt Drive linkini kullan
                            useDirectDriveLink: (!record.fileData && record.driveFileId) ? true : false
                        };
                    });
                    
                    console.log('Y√ºklenen kayƒ±t sayƒ±sƒ±:', coaData.length);
                    const withFiles = coaData.filter(r => r.fileData).length;
                    const withFileSize = coaData.filter(r => r.fileSize).length;
                    const withOcrProperties = coaData.filter(r => r.ocrProperties && Object.keys(r.ocrProperties).length > 0).length;
                    console.log('Dosyalƒ± kayƒ±t sayƒ±sƒ±:', withFiles);
                    console.log('fileSize bilgisi olan:', withFileSize);
                    console.log('üìä ocrProperties olan COA sayƒ±sƒ±:', withOcrProperties);
                    
                    // ƒ∞lk kayƒ±ttan √∂rnek g√∂ster
                    if (coaData.length > 0) {
                        console.log('ƒ∞lk kayƒ±t √∂rneƒüi:', {
                            id: coaData[0].id,
                            fileName: coaData[0].fileName,
                            fileSize: coaData[0].fileSize,
                            hasFileData: !!coaData[0].fileData,
                            hasOcrProperties: !!coaData[0].ocrProperties,
                            ocrPropsCount: coaData[0].ocrProperties ? Object.keys(coaData[0].ocrProperties).length : 0
                        });
                    }
                    
                    // Sheets'ten ba≈üarƒ±yla y√ºklendiysaveToLocalStorage() ile yedekle
                    saveToLocalStorage();
                    
                    // COA_Records'tan deƒüerleri y√ºkle
                    await loadCOARecordsForAll();
                    
                    // Tabloyu g√ºncelle
                    renderTable();
                    updateUI();
                    
                    // Sheets'ten istatistikleri de y√ºkle
                    loadStatsFromGoogleSheets();
                    
                    showToast('‚úÖ ' + coaData.length + ' kayƒ±t y√ºklendi (' + withFiles + ' dosyalƒ±)', 'success');
                } else {
                    console.error('Veri y√ºkleme hatasƒ±:', data?.error);
                    // FALLBACK: Zaten localStorage'dan y√ºklenmi≈ü olabilir
                    renderTable();
                    const localCount = coaData.length;
                    if (localCount > 0) {
                        showToast(`‚ö†Ô∏è Sheets hatasƒ±, ${localCount} yerel kayƒ±t kullanƒ±lƒ±yor`, 'warning', 5000);
                    } else {
                        showToast('üö® VERƒ∞ Y√úKLENEMEDƒ∞!', 'error', 8000);
                    }
                }
            } catch (error) {
                console.error('Y√ºkleme hatasƒ±:', error);
                // FALLBACK: localStorage zaten y√ºklenmi≈ü olabilir (DOMContentLoaded'da)
                renderTable();
                const localCount = coaData.length;
                if (localCount > 0) {
                    showToast(`üíæ √áevrimdƒ±≈üƒ± mod: ${localCount} yerel kayƒ±t`, 'warning', 5000);
                } else {
                    showToast('üö® GOOGLE SHEETS ERƒ∞≈ûƒ∞LEMƒ∞YOR!', 'error', 8000);
                    showToast('üí° Apps Script deployment veya internet kontrol√º', 'info', 8000);
                }
            }
        }
        
        async function loadStatsFromGoogleSheets() {
            if (!googleScriptUrl) return;
            
            try {
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 10000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.ontimeout = () => reject(new Error('Timeout'));
                    
                    xhr.open('GET', googleScriptUrl + '?action=getStats', true);
                    xhr.send();
                });
                
                if (result && result.success && result.data) {
                    const stats = result.data;
                    
                    // Toplam dosya boyutunu g√ºncelle
                    if (stats.totalFileSizeMB !== undefined) {
                        document.getElementById('statTotalSize').textContent = stats.totalFileSizeMB + ' MB';
                        console.log('üìä Sheets\'ten dosya boyutu g√ºncellendi:', stats.totalFileSizeMB, 'MB');
                    }
                }
            } catch (error) {
                console.error('ƒ∞statistik y√ºkleme hatasƒ±:', error);
            }
        }
        
        async function saveToGoogleSheets(record) {
            try {
                showToast('üì§ Kaydediliyor...', 'info');
                
                let fileUrl = '';
                let driveFileId = '';
                let fileSize = 0;
                
                // Dosya varsa Drive'a y√ºkle
                if (record.fileData && record.fileName) {
                    console.log('Dosya Drive\'a y√ºkleniyor...', record.fileName);
                    showToast('‚òÅÔ∏è Google Drive\'a y√ºkleniyor...', 'info');
                    
                    try {
                        // ORJƒ∞NAL DOSYAYI DRIVE'A Y√úKLE (SIKI≈ûTIRILMAMI≈û)
                        // PDF, Excel, Word ve √ßok sayfalƒ± i√ßin sƒ±kƒ±≈ütƒ±rma YOK
                        const fileName = record.fileName || '';
                        const fileType = record.fileType || '';
                        
                        const isPDF = fileType.includes('pdf') || fileName.toLowerCase().endsWith('.pdf');
                        const isExcel = fileType.includes('spreadsheet') || fileName.toLowerCase().endsWith('.xlsx') || fileName.toLowerCase().endsWith('.xls');
                        const isWord = fileType.includes('wordprocessing') || fileName.toLowerCase().endsWith('.docx') || fileName.toLowerCase().endsWith('.doc');
                        const isOfficeDoc = isPDF || isExcel || isWord;
                        const isLargeFile = record.fileData.length > 3000000; // 3MB+
                        const isMobile = /Mobile|Android|iPhone/i.test(navigator.userAgent);
                        
                        console.log('üìÑ Dosya tipi kontrol√º:', { fileName, fileType, isPDF, isExcel, isWord, isOfficeDoc });
                        
                        let uploadData;
                        if (isOfficeDoc || isLargeFile) {
                            // ORJƒ∞NAL dosyayƒ± y√ºkle, sƒ±kƒ±≈ütƒ±rma YOK - DOƒûRUDAN KULLAN
                            uploadData = record.fileData;
                            let fileTypeLabel = isPDF ? 'PDF' : (isExcel ? 'Excel' : (isWord ? 'Word' : 'B√ºy√ºk dosya'));
                            console.log('‚úÖ ' + fileTypeLabel + ' - ORJƒ∞NAL dosya y√ºkleniyor (sƒ±kƒ±≈ütƒ±rmasƒ±z):', Math.round(uploadData.length / 1024), 'KB');
                        } else {
                            // Sadece k√º√ß√ºk resimler i√ßin hafif sƒ±kƒ±≈ütƒ±rma
                            const targetSize = isMobile ? 350 : 400;
                            uploadData = await compressForSheets(record.fileData, targetSize);
                            console.log('üì∑ K√º√ß√ºk resim - Hafif sƒ±kƒ±≈ütƒ±rma:', Math.round(uploadData.length / 1024), 'KB');
                        }
                        
                        const compressedData = uploadData;
                        
                        // fetch() ile POST (XMLHttpRequest CORS problemi yaratƒ±yor)
                        let lastError = null;
                        let uploadResult = null;
                        
                        for (let attempt = 1; attempt <= 3; attempt++) {
                            try {
                                if (attempt > 1) {
                                    console.log('‚ö†Ô∏è Tekrar deneniyor... Deneme:', attempt + '/3');
                                    showToast('‚ö†Ô∏è Tekrar deneniyor (' + attempt + '/3)...', 'warning', 2000);
                                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 saniye bekle
                                }
                                
                                // fetch() ile POST - CORS uyumlu
                                const formData = new URLSearchParams();
                                formData.append('action', 'uploadFile');
                                formData.append('fileData', compressedData);
                                formData.append('fileName', record.fileName);
                                // PDF i√ßin doƒüru mimeType g√∂nder
                                const mimeType = isPDF ? 'application/pdf' : (record.fileType || 'image/jpeg');
                                formData.append('mimeType', mimeType);
                                
                                console.log('G√∂nderilen veri:', {
                                    fileName: record.fileName,
                                    mimeType: mimeType,
                                    boyut: Math.round(formData.toString().length / 1024) + ' KB',
                                    isPDF: isPDF
                                });
                                
                                const controller = new AbortController();
                                const timeout = isMobile ? 240000 : 120000;
                                const timeoutId = setTimeout(() => controller.abort(), timeout);
                                
                                const response = await fetch(googleScriptUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                    body: formData.toString(),
                                    signal: controller.signal
                                });
                                
                                clearTimeout(timeoutId);
                                
                                if (!response.ok) {
                                    throw new Error('HTTP ' + response.status);
                                }
                                
                                uploadResult = await response.json();
                                
                                // Ba≈üarƒ±lƒ±ysa loop'tan √ßƒ±k
                                break;
                            } catch (attemptError) {
                                lastError = attemptError;
                                console.error('Deneme ' + attempt + ' ba≈üarƒ±sƒ±z:', attemptError.message);
                                if (attempt === 3) {
                                    throw new Error('3 deneme ba≈üarƒ±sƒ±z: ' + attemptError.message);
                                }
                            }
                        }
                        
                        console.log('Drive upload sonucu:', uploadResult);
                        console.log('Upload response keys:', Object.keys(uploadResult || {}));
                        
                        if (uploadResult && uploadResult.success) {
                            fileUrl = uploadResult.viewUrl || uploadResult.directUrl;
                            driveFileId = uploadResult.fileId;
                            fileSize = uploadResult.fileSize || 0;
                            console.log('‚úÖ Drive y√ºkleme ba≈üarƒ±lƒ±:', { fileUrl, driveFileId, fileSize });
                            showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
                        } else {
                            console.error('Drive upload hatasƒ±:', uploadResult?.error);
                            console.error('Tam response:', JSON.stringify(uploadResult));
                            alert('Drive Hatasƒ±: ' + (uploadResult?.error || 'Bilinmeyen hata'));
                            throw new Error(uploadResult?.error || 'Dosya Drive\'a y√ºklenemedi');
                        }
                    } catch (uploadErr) {
                        console.error('Drive upload exception:', uploadErr);
                        console.error('Error stack:', uploadErr.stack);
                        alert('Upload Exception: ' + uploadErr.message);
                        throw new Error('Drive y√ºkleme hatasƒ±: ' + uploadErr.message);
                    }
                }
                
                // Kayƒ±t verisini hazƒ±rla
                // PDF ve √ßok sayfalƒ± dok√ºmanlar i√ßin fileData kaydedilmez (sadece Drive link)
                const isPDF = record.fileType && record.fileType.includes('pdf');
                const isMultiPage = record.fileData && record.fileData.length > 3000000; // 3MB+
                const shouldSkipFileData = isPDF || isMultiPage;
                
                if (shouldSkipFileData) {
                    console.log('üìÑ PDF/√áok sayfalƒ± dok√ºman - fileData Sheets\'e kaydedilmiyor (sadece Drive link)');
                }
                
                const saveData = {
                    id: record.id,
                    supplier: record.supplier,
                    materialCode: record.materialCode,
                    deliveryDate: record.deliveryDate,
                    deliveryNo: record.deliveryNo || '',
                    lotNumber: record.lotNumber || '',
                    location: record.location || '',
                    notes: record.notes || '',
                    fileName: record.fileName || '',
                    fileType: record.fileType || '',
                    fileUrl: fileUrl,
                    driveFileId: driveFileId,
                    fileData: shouldSkipFileData ? '' : '', // PDF ve √ßok sayfalƒ±lar i√ßin bo≈ü
                    fileSize: fileSize || record.fileSize || 0, // Dosya boyutu
                    ocrProperties: record.ocrProperties ? JSON.stringify(record.ocrProperties) : '', // COA deƒüerleri
                    createdAt: record.createdAt || new Date().toISOString()
                };
                
                // XMLHttpRequest POST ile metadata g√∂nder
                console.log('Metadata kaydediliyor...');
                console.log('üìÅ Drive File ID:', driveFileId);
                console.log('üì¶ SaveData:', JSON.stringify(saveData, null, 2));
                
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 120000; // 120 saniye (b√ºy√ºk dosyalar i√ßin)
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'addCOA');
                    formData.append('data', JSON.stringify(saveData));
                    
                    xhr.send(formData.toString());
                });
                
                console.log('Kayƒ±t sonucu:', result);
                console.log('Kayƒ±t response keys:', Object.keys(result || {}));
                
                if (!result || !result.success) {
                    console.error('Kayƒ±t hatasƒ± detay:', JSON.stringify(result));
                    alert('Kayƒ±t Hatasƒ±: ' + (result?.error || 'Bilinmeyen hata'));
                    throw new Error(result?.error || 'Kayƒ±t olu≈üturulamadƒ±');
                }
                
                console.log('‚úÖ Kayƒ±t ba≈üarƒ±lƒ±, ID:', result.id);
                showToast('‚úÖ Kayƒ±t ve dosya ba≈üarƒ±yla Drive\'a eklendi!', 'success');
                return true;
                
            } catch (error) {
                console.error('Kaydetme hatasƒ±:', error);
                console.error('Error stack:', error.stack);
                alert('Kaydetme Hatasƒ±: ' + error.message);
                showToast('‚ùå Hata: ' + error.message, 'error');
                return false;
            }
        }
        
        // Dosyayƒ± Google Drive'a chunk'lar halinde y√ºkle
        async function uploadToDriveChunked(fileData, fileName, mimeType) {
            const CHUNK_SIZE = 5000; // 5KB per chunk (URL-safe ve hƒ±zlƒ±)
            const chunks = [];
            
            // Dosyayƒ± par√ßala
            for (let i = 0; i < fileData.length; i += CHUNK_SIZE) {
                chunks.push(fileData.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('Drive upload - Toplam chunk sayƒ±sƒ±:', chunks.length, '(her biri ~5KB)');
            
            try {
                // 1. Upload ba≈ülat
                const initUrl = googleScriptUrl + 
                    '?action=initUpload' +
                    '&fileName=' + encodeURIComponent(fileName) +
                    '&mimeType=' + encodeURIComponent(mimeType || 'image/jpeg') +
                    '&totalChunks=' + chunks.length +
                    '&totalSize=' + fileData.length;
                
                console.log('Init URL uzunluƒüu:', initUrl.length);
                const initResult = await jsonp(initUrl);
                
                if (!initResult || !initResult.success) {
                    console.error('Upload init hatasƒ±:', initResult?.error);
                    return { success: false, error: initResult?.error || 'Init hatasƒ±' };
                }
                
                const uploadId = initResult.uploadId;
                console.log('Upload ba≈ülatƒ±ldƒ±, ID:', uploadId);
                
                // 2. Chunk'larƒ± g√∂nder
                for (let i = 0; i < chunks.length; i++) {
                    // Her 10 chunk'ta bir progress g√∂ster
                    if (i % 10 === 0 || i === chunks.length - 1) {
                        showToast('üì§ Drive\'a y√ºkleniyor... ' + Math.round((i + 1) / chunks.length * 100) + '%', 'info');
                    }
                    
                    const chunkUrl = googleScriptUrl + 
                        '?action=uploadChunk' +
                        '&uploadId=' + encodeURIComponent(uploadId) +
                        '&chunkIndex=' + i +
                        '&totalChunks=' + chunks.length +
                        '&chunk=' + encodeURIComponent(chunks[i]);
                    
                    // Retry mekanizmasƒ±
                    let chunkResult = null;
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    while (retryCount < maxRetries) {
                        try {
                            chunkResult = await jsonp(chunkUrl);
                            if (chunkResult && chunkResult.success) {
                                break; // Ba≈üarƒ±lƒ±
                            }
                        } catch (e) {
                            console.log('Chunk', i, 'retry', retryCount + 1);
                        }
                        retryCount++;
                        await new Promise(r => setTimeout(r, 500)); // 500ms bekle
                    }
                    
                    if (!chunkResult || !chunkResult.success) {
                        const errorMsg = chunkResult?.error || 'Bilinmeyen hata';
                        console.error('Chunk hatasƒ±:', i, errorMsg);
                        return { success: false, error: 'Chunk ' + i + ' hatasƒ±: ' + errorMsg };
                    }
                    
                    // Her 20 chunk'ta bir log
                    if (i % 20 === 0 || i === chunks.length - 1) {
                        console.log('Chunk g√∂nderildi:', i + 1, '/', chunks.length);
                    }
                    
                    // Rate limiting - daha kƒ±sa bekle (200ms)
                    if (i < chunks.length - 1) {
                        await new Promise(r => setTimeout(r, 200));
                    }
                }
                
                // 3. Upload tamamla
                showToast('üì§ Dosya birle≈ütiriliyor...', 'info');
                const finalizeUrl = googleScriptUrl + 
                    '?action=finalizeUpload' +
                    '&uploadId=' + encodeURIComponent(uploadId) +
                    '&fileName=' + encodeURIComponent(fileName) +
                    '&mimeType=' + encodeURIComponent(mimeType || 'image/jpeg');
                
                const finalResult = await jsonp(finalizeUrl);
                
                if (!finalResult || !finalResult.success) {
                    console.error('Finalize hatasƒ±:', finalResult?.error);
                    return { success: false, error: finalResult?.error || 'Finalize hatasƒ±' };
                }
                
                console.log('Upload tamamlandƒ±:', finalResult);
                return finalResult;
                
            } catch (error) {
                console.error('Chunk upload hatasƒ±:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Eski fonksiyon - Sheets'e chunk (artƒ±k kullanƒ±lmƒ±yor)
        async function uploadFileInChunks(recordId, fileData) {
            const CHUNK_SIZE = 1500;
            const chunks = [];
            
            // Dosyayƒ± par√ßala
            for (let i = 0; i < fileData.length; i += CHUNK_SIZE) {
                chunks.push(fileData.substring(i, i + CHUNK_SIZE));
            }
            
            console.log('Toplam chunk sayƒ±sƒ±:', chunks.length);
            
            // Her chunk'ƒ± sƒ±rayla g√∂nder
            for (let i = 0; i < chunks.length; i++) {
                showToast('üì§ Dosya y√ºkleniyor... ' + Math.round((i + 1) / chunks.length * 100) + '%', 'info');
                
                // URL'yi manuel olu≈ütur (encodeURIComponent ile)
                const chunkUrl = googleScriptUrl + 
                    '?action=appendFileData' +
                    '&id=' + encodeURIComponent(recordId) +
                    '&chunk=' + encodeURIComponent(chunks[i]) +
                    '&chunkIndex=' + i +
                    '&totalChunks=' + chunks.length;
                
                console.log('Chunk URL uzunluƒüu:', chunkUrl.length);
                
                try {
                    const chunkResult = await jsonp(chunkUrl);
                    
                    if (!chunkResult || !chunkResult.success) {
                        console.error('Chunk hatasƒ±:', i, chunkResult?.error);
                        return false;
                    }
                    
                    console.log('Chunk g√∂nderildi:', i + 1, '/', chunks.length);
                } catch (e) {
                    console.error('Chunk g√∂nderme hatasƒ±:', i, e);
                    return false;
                }
                
                // Rate limiting - √ßok hƒ±zlƒ± istek atmayalƒ±m
                if (i < chunks.length - 1) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }
            
            return true;
        }
        
        // Dosya y√ºkleme fonksiyonu - birden fazla servis dener
        async function uploadToImgBB(base64Data) {
            // Base64 verisi hazƒ±rla
            let imageData = base64Data;
            if (imageData.includes(',')) {
                imageData = imageData.split(',')[1];
            }
            
            // 1. √ñnce imgbb.com dene (√ºcretsiz API)
            try {
                console.log('imgBB\'ye y√ºkleniyor...');
                const formData = new FormData();
                formData.append('image', imageData);
                
                // √úcretsiz API key (sƒ±nƒ±rlƒ± kullanƒ±m)
                const response = await fetch('https://api.imgbb.com/1/upload?key=00d1452b3d2add1cfe46862457505d88', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.url) {
                    console.log('imgBB ba≈üarƒ±lƒ±:', result.data.url);
                    return {
                        success: true,
                        url: result.data.url
                    };
                }
            } catch (e) {
                console.warn('imgBB hatasƒ±:', e.message);
            }
            
            // 2. freeimage.host dene
            try {
                console.log('freeimage.host\'a y√ºkleniyor...');
                const formData = new FormData();
                formData.append('source', imageData);
                formData.append('type', 'base64');
                formData.append('action', 'upload');
                
                const response = await fetch('https://freeimage.host/api/1/upload?key=6d207e02198a847aa98d0a2a901485a5', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status_code === 200 && result.image && result.image.url) {
                    console.log('freeimage ba≈üarƒ±lƒ±:', result.image.url);
                    return {
                        success: true,
                        url: result.image.url
                    };
                }
            } catch (e) {
                console.warn('freeimage hatasƒ±:', e.message);
            }
            
            // T√ºm servisler ba≈üarƒ±sƒ±z - dosya yerel olarak saklanacak
            console.log('T√ºm upload servisleri ba≈üarƒ±sƒ±z, dosya yerel olarak saklanacak');
            return { success: false, error: 'Upload servisleri kullanƒ±lamƒ±yor' };
        }
        
        // Data URL'i daha fazla sƒ±kƒ±≈ütƒ±r
        async function compressDataUrl(dataUrl, maxSizeKB) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = maxSizeKB * 1024;
                    
                    // Boyutu k√º√ß√ºlt
                    const maxDim = 800;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    let quality = 0.5;
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse daha da k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale = Math.sqrt(maxSize / result.length) * 0.8;
                        canvas.width = Math.round(width * scale);
                        canvas.height = Math.round(height * scale);
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.4);
                    }
                    
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }
        
        // Sheets i√ßin √∂zel sƒ±kƒ±≈ütƒ±rma - SADECE RESƒ∞MLER ƒ∞√áƒ∞N
        async function compressForSheets(dataUrl, maxSizeKB = 250) {
            return new Promise((resolve, reject) => {
                // PDF, Excel, Word gibi dosyalar i√ßin direkt geri d√∂n (sƒ±kƒ±≈ütƒ±rma YOK)
                if (dataUrl.includes('application/pdf') || 
                    dataUrl.includes('spreadsheet') || 
                    dataUrl.includes('wordprocessing') ||
                    dataUrl.includes('application/vnd.ms-excel') ||
                    dataUrl.includes('application/vnd.openxmlformats')) {
                    console.warn('Office/PDF dosyasƒ± - sƒ±kƒ±≈ütƒ±rma atlanƒ±yor, orjinal d√∂nd√ºr√ºl√ºyor');
                    resolve(dataUrl);
                    return;
                }
                
                // Resim deƒüilse direkt geri d√∂n
                if (!dataUrl.startsWith('data:image/')) {
                    console.warn('Resim deƒüil - sƒ±kƒ±≈ütƒ±rma atlanƒ±yor');
                    resolve(dataUrl);
                    return;
                }
                
                const img = new Image();
                img.onerror = () => {
                    console.error('Resim y√ºklenemedi');
                    resolve(dataUrl); // Hata durumunda orjinali d√∂n
                };
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = maxSizeKB * 1024;
                    
                    // Hedef boyuta g√∂re ba≈ülangƒ±√ß boyutu ayarla - Y√úKSEK KALƒ∞TE
                    let maxDim;
                    if (maxSizeKB >= 2000) {
                        maxDim = 4500; // 2MB+ i√ßin MUHTEkMEL √ß√∂z√ºn√ºrl√ºk (PDF/√ßok sayfalƒ± - minimal sƒ±kƒ±≈ütƒ±rma)
                    } else if (maxSizeKB >= 1000) {
                        maxDim = 3500; // 1MB+ i√ßin √ßok y√ºksek √ß√∂z√ºn√ºrl√ºk
                    } else if (maxSizeKB >= 500) {
                        maxDim = 3000; // 500KB+ i√ßin y√ºksek √ß√∂z√ºn√ºrl√ºk
                    } else if (maxSizeKB >= 300) {
                        maxDim = 2400; // 300KB+ i√ßin iyi √ß√∂z√ºn√ºrl√ºk
                    } else if (maxSizeKB >= 200) {
                        maxDim = 2000;
                    } else if (maxSizeKB >= 100) {
                        maxDim = 1600;
                    } else if (maxSizeKB >= 50) {
                        maxDim = 1000;
                    } else {
                        maxDim = 600;
                    }
                    
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kalite ba≈ülangƒ±cƒ± - Y√úKSEK KALƒ∞TE
                    let quality;
                    if (maxSizeKB >= 2000) {
                        quality = 0.98; // 2MB+ i√ßin MUHTEkMEL kalite (neredeyse sƒ±kƒ±≈ütƒ±rmasƒ±z)
                    } else if (maxSizeKB >= 1000) {
                        quality = 0.96; // 1MB+ i√ßin √ßok y√ºksek kalite
                    } else if (maxSizeKB >= 500) {
                        quality = 0.95; // 500KB+ i√ßin y√ºksek kalite
                    } else if (maxSizeKB >= 300) {
                        quality = 0.92; // 300KB i√ßin iyi kalite
                    } else if (maxSizeKB >= 200) {
                        quality = 0.90;
                    } else if (maxSizeKB >= 100) {
                        quality = 0.85;
                    } else if (maxSizeKB >= 50) {
                        quality = 0.7;
                    } else {
                        quality = 0.6;
                    }
                    
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    // Boyut b√ºy√ºkse kaliteyi d√º≈ü√ºr
                    while (result.length > maxSize && quality > 0.3) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        maxDim = Math.round(maxDim * 0.7);
                        if (img.width > img.height) {
                            canvas.width = maxDim;
                            canvas.height = Math.round(maxDim * img.height / img.width);
                        } else {
                            canvas.height = maxDim;
                            canvas.width = Math.round(maxDim * img.width / img.height);
                        }
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.5);
                    }
                    
                    // Hala b√ºy√ºkse daha da k√º√ß√ºlt
                    if (result.length > maxSize) {
                        maxDim = Math.round(maxDim * 0.7);
                        if (img.width > img.height) {
                            canvas.width = maxDim;
                            canvas.height = Math.round(maxDim * img.height / img.width);
                        } else {
                            canvas.height = maxDim;
                            canvas.width = Math.round(maxDim * img.width / img.height);
                        }
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.4);
                    }
                    
                    console.log('Sƒ±kƒ±≈ütƒ±rma sonucu:', Math.round(result.length/1024), 'KB, boyut:', canvas.width, 'x', canvas.height, 'kalite:', quality);
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }
        
        // Bekleyen kayƒ±tlarƒ± senkronize et
        async function syncPendingRecords() {
            if (!googleScriptUrl) return;
            
            const pending = coaData.filter(r => r.pending);
            if (pending.length === 0) return;
            
            console.log('Bekleyen kayƒ±t sayƒ±sƒ±:', pending.length);
            showToast('üîÑ ' + pending.length + ' bekleyen kayƒ±t senkronize ediliyor...', 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const record of pending) {
                try {
                    // Dosyayƒ± sƒ±kƒ±≈ütƒ±r ve Sheets'e kaydet
                    if (record.fileData) {
                        try {
                            record.fileData = await compressForSheets(record.fileData, 40);
                        } catch (e) {
                            console.warn('Sƒ±kƒ±≈ütƒ±rma hatasƒ±, orijinal kullanƒ±lƒ±yor');
                        }
                    }
                    
                    delete record.pending;
                    
                    // Sheets'e kaydet (fileData dahil)
                    const params = new URLSearchParams();
                    params.append('action', 'addCOA');
                    params.append('data', JSON.stringify(record));
                    
                    const result = await jsonp(googleScriptUrl + '?' + params.toString());
                    if (result && result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        record.pending = true; // Ba≈üarƒ±sƒ±zsa tekrar beklemede yap
                    }
                    
                    console.log('Senkronize edildi:', record.id);
                } catch (e) {
                    failCount++;
                    record.pending = true;
                    console.error('Senkronizasyon hatasƒ±:', record.id, e);
                }
            }
            
            saveToLocalStorage(); // Senkronizasyon sonrasƒ± localStorage'a kaydet
            
            if (failCount === 0) {
                showToast('‚úÖ ' + successCount + ' kayƒ±t senkronize edildi', 'success');
            } else {
                showToast('‚ö†Ô∏è ' + successCount + ' ba≈üarƒ±lƒ±, ' + failCount + ' ba≈üarƒ±sƒ±z', 'warning');
            }
        }
        
        async function deleteFromGoogleSheets(id) {
            try {
                console.log('üóëÔ∏è Sheet\'ten COA Ar≈üiv kaydƒ± siliniyor:', id);
                const params = new URLSearchParams();
                params.append('action', 'deleteCOA');
                params.append('id', id);
                
                const result = await jsonp(googleScriptUrl + '?' + params.toString());
                console.log('üì¶ deleteCOA sonucu:', result);
                
                if (result.success) {
                    console.log('‚úÖ COA Ar≈üiv sheet\'inden silindi');
                } else {
                    console.warn('‚ö†Ô∏è COA Ar≈üiv sheet\'inden silinemedi:', result.error);
                }
                
                return result.success;
            } catch (error) {
                console.error('‚ùå deleteFromGoogleSheets hatasƒ±:', error);
                return false;
            }
        }
        
        async function deleteCOARecordFromSheets(materialCode, deliveryDate, deliveryNo) {
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil');
                return false;
            }
            
            // deliveryNo opsiyonel, bo≈ü string olabilir
            deliveryNo = deliveryNo || '';
            
            try {
                // Date object varsa YYYY-MM-DD formatƒ±na √ßevir
                let formattedDate = deliveryDate;
                if (deliveryDate instanceof Date) {
                    formattedDate = deliveryDate.toISOString().split('T')[0];
                    console.log('üìÖ Date object YYYY-MM-DD formatƒ±na d√∂n√º≈üt√ºr√ºld√º:', formattedDate);
                } else if (typeof deliveryDate === 'string' && deliveryDate.includes('T')) {
                    formattedDate = deliveryDate.split('T')[0];
                    console.log('üìÖ ISO string YYYY-MM-DD formatƒ±na d√∂n√º≈üt√ºr√ºld√º:', formattedDate);
                }
                
                console.log('üóëÔ∏è COA_Records\'dan siliniyor:');
                console.log('  üì¶ Material Code:', materialCode);
                console.log('  üìÖ Delivery Date:', formattedDate, '(orijinal:', deliveryDate, ')');
                console.log('  üìã Delivery No:', deliveryNo || '(bo≈ü)');
                
                const params = new URLSearchParams();
                params.append('action', 'deleteCOARecord');
                params.append('materialCode', materialCode);
                params.append('deliveryDate', formattedDate);
                params.append('deliveryNo', deliveryNo);
                
                console.log('üåê Silme isteƒüi URL parametreleri:', params.toString());
                
                const result = await jsonp(googleScriptUrl + '?' + params.toString());
                
                console.log('üì¶ Silme sonucu:', result);
                
                if (result && result.success) {
                    console.log('‚úÖ COA_Records\'dan silindi:', result.message || '');
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è COA_Records silme hatasƒ±:', result?.error);
                    
                    // Debug bilgilerini g√∂ster
                    if (result && result.debug) {
                        console.group('üîç DEBUG Bƒ∞LGƒ∞LERƒ∞:');
                        console.log('üì§ G√∂nderilen:');
                        console.table(result.debug.searchParams);
                        console.log('üìã Sheet Headers:');
                        console.table(result.debug.sheetInfo.headers);
                        console.log('üìù Sheet ƒ∞lk Satƒ±rlar:');
                        console.table(result.debug.sampleRows);
                        console.groupEnd();
                    }
                    
                    return false;
                }
            } catch (error) {
                console.error('‚ùå COA_Records silme hatasƒ±:', error);
                return false;
            }
        }
        
        async function updateToGoogleSheets(record) {
            try {
                // fileData √ßok b√ºy√ºkse g√∂nderme (zaten Drive'da var)
                const recordToSend = { ...record };
                
                // Eƒüer fileData √ßok b√ºy√ºkse (>50KB) g√∂nderme
                if (recordToSend.fileData && recordToSend.fileData.length > 50000) {
                    console.log('fileData √ßok b√ºy√ºk, g√∂nderilmiyor (Drive\'da mevcut)');
                    delete recordToSend.fileData;
                }
                
                // JSONP ile POST g√∂nder (fetch yerine)
                const updateUrl = googleScriptUrl + 
                    '?action=updateCOA' +
                    '&id=' + encodeURIComponent(record.id) +
                    '&data=' + encodeURIComponent(JSON.stringify(recordToSend));
                
                console.log('Update URL olu≈üturuldu, uzunluk:', updateUrl.length);
                
                const result = await jsonp(updateUrl);
                
                if (result && result.success) {
                    console.log('Google Sheets g√ºncellendi:', record.id);
                    return true;
                } else {
                    console.error('G√ºncelleme hatasƒ±:', result?.error);
                    showToast('‚ö†Ô∏è Google Sheets g√ºncellenemedi: ' + (result?.error || 'Bilinmeyen hata'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('updateToGoogleSheets hatasƒ±:', error);
                showToast('‚ö†Ô∏è Google Sheets baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                return false;
            }
        }
        
        // ==================== Local Storage [FALLBACK SYSTEM] ====================
        // üö® FALLBACK (YEDEKLeme) Sƒ∞STEMƒ∞:
        // 1. √ñNCE Google Sheets'ten y√ºklemeyi dene (√∂ncelik)
        // 2. Ba≈üarƒ±sƒ±z olursa localStorage'dan y√ºkle (fallback)
        // 3. Sheets √ßalƒ±≈ütƒ±ƒüƒ±nda otomatik localStorage'a kaydet (senkronize)
        
        async function loadFromLocalStorage() {
            const saved = localStorage.getItem('coa_arsiv_data');
            if (saved) {
                coaData = JSON.parse(saved);
                console.log('üíæ localStorage\'dan y√ºklendi (FALLBACK):', coaData.length, 'kayƒ±t');
                console.warn('‚ö†Ô∏è Google Sheets baƒülantƒ±sƒ± olmadƒ±ƒüƒ± i√ßin yerel veriler kullanƒ±lƒ±yor!');
                
                // COA_Records'tan deƒüerleri y√ºkle (eƒüer Sheets √ßalƒ±≈üƒ±yorsa)
                try {
                    await loadCOARecordsForAll();
                } catch (e) {
                    console.warn('COA_Records y√ºklenemedi (Sheets baƒülantƒ±sƒ± yok):', e.message);
                }
            } else {
                console.error('üö® NE SHEETS NE DE localStorage VERƒ∞Sƒ∞ YOK - PROGRAM BO≈û!');
            }
        }
        
        function saveToLocalStorage() {
            // Sheets √ßalƒ±≈ütƒ±ƒüƒ±nda localStorage'a yedek kaydet
            try {
                localStorage.setItem('coa_arsiv_data', JSON.stringify(coaData));
                console.log('üíæ localStorage senkronize edildi:', coaData.length, 'kayƒ±t');
            } catch (e) {
                console.error('localStorage kaydetme hatasƒ±:', e);
            }
        }
        
        // ==================== JSON Backup & Restore ====================
        function downloadJSONBackup() {
            try {
                const backup = {
                    version: '2.1',
                    exportDate: new Date().toISOString(),
                    recordCount: coaData.length,
                    data: coaData
                };
                
                const jsonString = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                a.download = `coa-arsiv-backup-${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast(`‚úÖ ${coaData.length} kayƒ±t JSON olarak indirildi`, 'success');
                console.log('üì• JSON yedekleme indirildi:', backup);
            } catch (error) {
                console.error('‚ùå JSON indirme hatasƒ±:', error);
                showToast('‚ùå JSON indirilemedi: ' + error.message, 'error');
            }
        }
        
        function uploadJSONBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showToast('‚ùå L√ºtfen .json uzantƒ±lƒ± dosya se√ßin', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validate backup structure
                    if (!backup.data || !Array.isArray(backup.data)) {
                        throw new Error('Ge√ßersiz JSON formatƒ±');
                    }
                    
                    // Confirm before restore
                    const confirmMsg = `üì§ ${backup.recordCount || backup.data.length} kayƒ±t y√ºklenecek.\n\n` +
                                     `Mevcut ${coaData.length} kayƒ±t √ºzerine yazƒ±lacak.\n\n` +
                                     `Devam etmek istiyor musunuz?`;
                    
                    if (!confirm(confirmMsg)) {
                        showToast('‚ö†Ô∏è ƒ∞≈ülem iptal edildi', 'warning');
                        event.target.value = ''; // Reset file input
                        return;
                    }
                    
                    // Restore data
                    coaData = backup.data;
                    saveToLocalStorage(); // JSON'dan y√ºklenince localStorage'ƒ± g√ºncelle
                    renderTable();
                    updateStats();
                    
                    showToast(`‚úÖ ${coaData.length} kayƒ±t ba≈üarƒ±yla y√ºklendi`, 'success');
                    console.log('üì§ JSON yedekleme geri y√ºklendi:', backup);
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    console.error('‚ùå JSON y√ºkleme hatasƒ±:', error);
                    showToast('‚ùå JSON y√ºklenemedi: ' + error.message, 'error');
                    event.target.value = '';
                }
            };
            
            reader.onerror = function() {
                showToast('‚ùå Dosya okunamadƒ±', 'error');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // ==================== Suppliers ====================
        function loadSuppliers() {
            let supplierNames = [];
            
            // Artƒ±k index.html'den tedarik√ßi listesi almƒ±yoruz
            // Sadece COA ar≈üiv kendi Excel dosyasƒ±ndan tedarik√ßi listesi alacak
            
            // COA Excel'inden kaydedilmi≈ü tedarik√ßileri y√ºkle
            const coaSuppliers = localStorage.getItem('coaSupplierList');
            if (coaSuppliers) {
                try {
                    supplierNames = JSON.parse(coaSuppliers);
                    console.log('Tedarik√ßi listesi y√ºklendi (coaSupplierList):', supplierNames.length);
                } catch(e) {
                    console.error('coaSupplierList parse hatasƒ±:', e);
                }
            }
            
            // supplierStatusMap'ten al (COA ar≈üiv kendi Excel'inden)
            if (supplierNames.length === 0) {
                const supplierMap = localStorage.getItem('supplierStatusMap');
                if (supplierMap) {
                    try {
                        const map = JSON.parse(supplierMap);
                        supplierNames = Object.keys(map);
                        console.log('Tedarik√ßi listesi y√ºklendi (supplierStatusMap):', supplierNames.length);
                    } catch(e) {
                        console.error('supplierStatusMap parse hatasƒ±:', e);
                    }
                }
            }
            
            // supplierInfoMap'ten al
            if (supplierNames.length === 0) {
                const supplierInfo = localStorage.getItem('supplierInfoMap');
                if (supplierInfo) {
                    try {
                        const info = JSON.parse(supplierInfo);
                        supplierNames = Object.keys(info);
                        console.log('Tedarik√ßi listesi y√ºklendi (supplierInfoMap):', supplierNames.length);
                    } catch(e) {}
                }
            }
            
            // Mevcut COA verilerinden de ekle
            coaData.forEach(c => {
                if (c.supplier && !supplierNames.includes(c.supplier)) {
                    supplierNames.push(c.supplier);
                }
            });
            
            suppliers = supplierNames.sort();
            updateSupplierDropdowns();
            
            if (suppliers.length === 0) {
                console.warn('‚ö†Ô∏è Tedarik√ßi listesi bo≈ü! L√ºtfen COA Ar≈üiv sayfasƒ±nda Excel y√ºkleyin.');
            }
        }
        
        // JSON dosyasƒ±ndan tedarik√ßi listesi y√ºkle
        function loadSupplierJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìÇ JSON dosyasƒ± okunuyor...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Validasyon
                    if (!jsonData.suppliers || !Array.isArray(jsonData.suppliers)) {
                        showToast('‚ùå Ge√ßersiz JSON formatƒ±!', 'error');
                        return;
                    }
                    
                    // Tedarik√ßi listesini g√ºncelle
                    const supplierNames = jsonData.suppliers.filter(n => n && n.trim());
                    
                    if (supplierNames.length === 0) {
                        showToast('‚ö†Ô∏è JSON dosyasƒ±nda tedarik√ßi bulunamadƒ±!', 'warning');
                        return;
                    }
                    
                    // localStorage'a kaydet
                    localStorage.setItem('supplierListForCOA', JSON.stringify(supplierNames));
                    
                    // Listeyi yenile
                    suppliers = supplierNames.sort();
                    updateSupplierDropdowns();
                    
                    showToast(`‚úÖ ${supplierNames.length} tedarik√ßi y√ºklendi!`, 'success');
                    console.log('‚úÖ JSON\'dan y√ºklendi:', supplierNames.length, 'tedarik√ßi');
                    console.log('ƒ∞lk 5:', supplierNames.slice(0, 5));
                    
                } catch (error) {
                    console.error('JSON okuma hatasƒ±:', error);
                    showToast('‚ùå JSON okuma hatasƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Input'u temizle (aynƒ± dosyayƒ± tekrar y√ºkleyebilmek i√ßin)
            event.target.value = '';
        }
        
        // Excel dosyasƒ±ndan tedarik√ßi ve hammadde listesi y√ºkle
        function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìä Excel dosyasƒ± okunuyor...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: false });
                    
                    // ƒ∞lk sayfayƒ± al
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: true });
                    
                    if (jsonData.length < 2) {
                        showToast('‚ö†Ô∏è Excel dosyasƒ± bo≈ü!', 'warning');
                        return;
                    }
                    
                    // Header satƒ±rƒ±nƒ± bul
                    const headers = jsonData[0];
                    
                    // S√ºtun indekslerini bul
                    let cariAdiIndex = -1;
                    let stokKoduIndex = -1;
                    let stokAdiIndex = -1;
                    let irsaliyeTarihiIndex = -1;
                    let irsaliyeSeriIndex = -1;
                    let irsaliyeNoIndex = -1;
                    
                    console.log('üìã Excel ba≈ülƒ±klarƒ±:', headers);
                    
                    headers.forEach((header, index) => {
                        const h = String(header).trim().toLowerCase();
                        // T√ºrk√ße karakterleri normalize et
                        const normalized = h.replace(/ƒ±/g, 'i').replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's').replace(/√∂/g, 'o').replace(/√ß/g, 'c');
                        
                        if (h === 'cari adƒ±' || h === 'cari adi' || h === 'cariadƒ±' || h === 'cariadi') {
                            cariAdiIndex = index;
                        }
                        if (h === 'stok kodu' || h === 'stokkodu') {
                            stokKoduIndex = index;
                        }
                        if (h === 'stok adƒ±' || h === 'stok adi' || h === 'stokadƒ±' || h === 'stokadi') {
                            stokAdiIndex = index;
                        }
                        // ƒ∞rsaliye Tarihi - sadece bu s√ºtun (ƒ∞rsaliye Kayƒ±t Tarihi DEƒûƒ∞L)
                        if ((h === 'irsaliye tarih' || h === 'irsaliye tarihi' || normalized === 'irsaliye tarih' || normalized === 'irsaliye tarihi') 
                            && !h.includes('kayit') && !h.includes('kayƒ±t')) {
                            console.log('‚úÖ ƒ∞rsaliye Tarihi bulundu:', header, 'Index:', index);
                            irsaliyeTarihiIndex = index;
                        }
                        if (h === 'irsaliye evrak seri' || h === 'irsaliye evrak seri no') {
                            irsaliyeSeriIndex = index;
                        }
                        if (h === 'irsaliye evrak no' || h === 'irsaliye evrak sira no' || h === 'irsaliye evrak sƒ±ra no' || h === 'irsaliye evrak sira' || h === 'irsaliye evrak sƒ±ra') {
                            irsaliyeNoIndex = index;
                        }
                    });
                    
                    // Kontrol
                    if (cariAdiIndex === -1 || stokKoduIndex === -1 || stokAdiIndex === -1) {
                        showToast('‚ùå Excel\'de gerekli s√ºtunlar bulunamadƒ±! (Cari Adƒ±, Stok Kodu, Stok Adƒ±)', 'error');
                        console.error('Bulunan headers:', headers);
                        console.error('Cari Adƒ± indeks:', cariAdiIndex, 'Stok Kodu indeks:', stokKoduIndex, 'Stok Adƒ± indeks:', stokAdiIndex);
                        return;
                    }
                    
                    // ƒ∞rsaliye s√ºtun kontrol√º
                    console.log('üìã ƒ∞rsaliye s√ºtunlarƒ±:', 'Tarih:', irsaliyeTarihiIndex, 'Seri:', irsaliyeSeriIndex, 'Sƒ±ra:', irsaliyeNoIndex);
                    
                    // Verileri topla
                    const supplierSet = new Set();
                    const materialMap = new Map(); // stokKodu -> {code, name, suppliers: [], deliveries: []}
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // Tedarik√ßi adƒ± (tekrarlayanlarƒ± alma)
                        const cariAdi = row[cariAdiIndex];
                        if (cariAdi && String(cariAdi).trim()) {
                            supplierSet.add(String(cariAdi).trim());
                        }
                        
                        // Hammadde kodu ve adƒ± (tekrarlayan kodlarƒ± alma)
                        const stokKodu = row[stokKoduIndex];
                        const stokAdi = row[stokAdiIndex];
                        if (stokKodu && String(stokKodu).trim() && stokAdi && String(stokAdi).trim()) {
                            const code = String(stokKodu).trim();
                            const name = String(stokAdi).trim();
                            const supplier = cariAdi ? String(cariAdi).trim() : null;
                            
                            // Hammadde-tedarik√ßi ili≈ükisini kaydet
                            if (!materialMap.has(code)) {
                                materialMap.set(code, { code, name, suppliers: [], deliveries: [] });
                            }
                            
                            // Bu tedarik√ßiyi hammaddenin supplier listesine ekle
                            if (supplier && !materialMap.get(code).suppliers.includes(supplier)) {
                                materialMap.get(code).suppliers.push(supplier);
                            }
                            
                            // ƒ∞rsaliye bilgilerini HER ZAMAN ekle (checkbox checkbox'lar sadece dropdown g√∂stermek i√ßin)
                            if (irsaliyeTarihiIndex >= 0 || irsaliyeSeriIndex >= 0 || irsaliyeNoIndex >= 0) {
                                const delivery = {};
                                
                                // Tarihi kaydet (varsa)
                                if (irsaliyeTarihiIndex >= 0 && row[irsaliyeTarihiIndex]) {
                                    // Tarihi gg.aa.yyyy formatƒ±na √ßevir
                                    const excelDate = row[irsaliyeTarihiIndex];
                                    const formattedDate = formatExcelDateToDisplay(excelDate);
                                    delivery.date = formattedDate;
                                    
                                    // Debug i√ßin ilk 5 tarihi konsola yazdƒ±r
                                    if (materialMap.size <= 5) {
                                        console.log('üîç Excel deƒüeri:', excelDate, 'Tipi:', typeof excelDate, '‚Üí Formatlanmƒ±≈ü:', formattedDate);
                                    }
                                }
                                
                                // Seri ve numarayƒ± kaydet (varsa)
                                if (irsaliyeSeriIndex >= 0 && row[irsaliyeSeriIndex]) {
                                    delivery.serie = String(row[irsaliyeSeriIndex]).trim();
                                }
                                if (irsaliyeNoIndex >= 0 && row[irsaliyeNoIndex]) {
                                    delivery.no = String(row[irsaliyeNoIndex]).trim();
                                }
                                
                                // Debug: ƒ∞lk 3 irsaliye i√ßin konsola yazdƒ±r
                                if (materialMap.size <= 3) {
                                    console.log('üìù ƒ∞rsaliye:', 'Seri:', delivery.serie, 'No:', delivery.no, '‚Üí Format:', delivery.serie && delivery.no ? `${delivery.serie} | ${delivery.no}` : (delivery.no || delivery.serie));
                                }
                                
                                // ƒ∞rsaliye bilgisi varsa ekle
                                if (delivery.date || delivery.serie || delivery.no) {
                                    delivery.supplier = supplier;
                                    materialMap.get(code).deliveries.push(delivery);
                                }
                            }
                        }
                    }
                    
                    // Array'lere √ßevir
                    const supplierArray = Array.from(supplierSet).sort();
                    const materialArray = Array.from(materialMap.values());
                    
                    if (supplierArray.length === 0 && materialArray.length === 0) {
                        showToast('‚ö†Ô∏è Excel dosyasƒ±nda veri bulunamadƒ±!', 'warning');
                        return;
                    }
                    
                    // LocalStorage'a kaydet
                    if (supplierArray.length > 0) {
                        // Hem supplierListForCOA hem de coaSupplierList'e kaydet (uyumluluk i√ßin)
                        localStorage.setItem('coaSupplierList', JSON.stringify(supplierArray));
                        suppliers = supplierArray;
                        updateSupplierDropdowns();
                    }
                    
                    if (materialArray.length > 0) {
                        materials = materialArray;
                        saveMaterials();
                        updateMaterialDropdown();
                    }
                    
                    showToast(`‚úÖ Excel y√ºklendi! ${supplierArray.length} tedarik√ßi, ${materialArray.length} hammadde`, 'success');
                    console.log('‚úÖ Excel\'den y√ºklendi:');
                    console.log('- Tedarik√ßiler:', supplierArray.length);
                    console.log('- Hammaddeler:', materialArray.length);
                    console.log('ƒ∞lk 3 tedarik√ßi:', supplierArray.slice(0, 3));
                    console.log('ƒ∞lk 3 hammadde:', materialArray.slice(0, 3));
                    
                    // ƒ∞rsaliye bilgilerini g√∂ster
                    const totalDeliveries = materialArray.reduce((sum, mat) => sum + (mat.deliveries?.length || 0), 0);
                    console.log('- ƒ∞rsaliye kayƒ±tlarƒ±:', totalDeliveries);
                    if (totalDeliveries > 0 && materialArray.length > 0 && materialArray[0].deliveries?.length > 0) {
                        console.log('ƒ∞lk hammaddenin irsaliyeleri:', materialArray[0].deliveries.slice(0, 3));
                    }
                    
                } catch (error) {
                    console.error('Excel okuma hatasƒ±:', error);
                    showToast('‚ùå Excel okuma hatasƒ±: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // Input'u temizle (aynƒ± dosyayƒ± tekrar y√ºkleyebilmek i√ßin)
            event.target.value = '';
        }
        
        function updateSupplierDropdowns() {
            const datalist = document.getElementById('supplierList');
            const filter = document.getElementById('filterSupplier');
            const countSpan = document.getElementById('supplierCount');
            
            // Clear existing options
            datalist.innerHTML = '';
            filter.innerHTML = '<option value="">T√ºm Tedarik√ßiler</option>';
            
            suppliers.forEach(s => {
                datalist.innerHTML += `<option value="${s}">`;
                filter.innerHTML += `<option value="${s}">${s}</option>`;
            });
            
            // Tedarik√ßi sayƒ±sƒ±nƒ± g√∂ster
            if (countSpan) {
                if (suppliers.length === 0) {
                    countSpan.innerHTML = '(‚ö†Ô∏è Liste bo≈ü - Ana sayfada Excel y√ºkleyin)';
                    countSpan.style.color = '#f44336';
                } else {
                    countSpan.innerHTML = `(üìä ${suppliers.length} tedarik√ßi)`;
                    countSpan.style.color = '#4CAF50';
                }
            }
        }
        
        // ==================== Multiselect ====================
        function initSupplierMultiselect() {
            const header = document.getElementById('supplierMultiselectHeader');
            const dropdown = document.getElementById('supplierMultiselectDropdown');
            const searchInput = document.getElementById('supplierSearchInput');
            
            // Toggle dropdown
            header.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multiselect-container')) {
                    dropdown.classList.remove('active');
                }
            });
            
            // Search suppliers
            searchInput.addEventListener('input', (e) => {
                e.stopPropagation();
                const search = e.target.value.toLowerCase();
                const options = document.querySelectorAll('.multiselect-option');
                options.forEach(opt => {
                    const text = opt.textContent.toLowerCase();
                    opt.style.display = text.includes(search) ? 'flex' : 'none';
                });
            });
        }
        
        function updateSupplierDropdowns() {
            const optionsContainer = document.getElementById('supplierMultiselectOptions');
            const countSpan = document.getElementById('supplierCount');
            
            // Clear existing options
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                suppliers.forEach(s => {
                    // Multiselect i√ßin
                    const isChecked = selectedSuppliers.has(s);
                    const option = document.createElement('div');
                    option.className = 'multiselect-option';
                    option.innerHTML = `
                        <input type="checkbox" id="supplier_${s.replace(/\s+/g, '_')}" 
                               ${isChecked ? 'checked' : ''} 
                               onchange="toggleSupplier('${s.replace(/'/g, "\\'")}')">
                        <label for="supplier_${s.replace(/\s+/g, '_')}">${s}</label>
                    `;
                    optionsContainer.appendChild(option);
                });
                
                updateSupplierMultiselectText();
            }
            
            // Form input dropdown'ƒ± g√ºncelle
            updateSupplierInputDropdown();
            
            // Tedarik√ßi sayƒ±sƒ±nƒ± g√∂ster
            if (countSpan) {
                if (suppliers.length === 0) {
                    countSpan.innerHTML = '(‚ö†Ô∏è Liste bo≈ü - Ana sayfada Excel y√ºkleyin)';
                    countSpan.style.color = '#f44336';
                } else {
                    countSpan.innerHTML = `(üìä ${suppliers.length} tedarik√ßi)`;
                    countSpan.style.color = '#4CAF50';
                }
            }
        }
        
        // Tedarik√ßi input dropdown'ƒ±nƒ± g√ºncelle
        function updateSupplierInputDropdown(filterText = '') {
            const itemsContainer = document.getElementById('supplierDropdownItems');
            const countElement = document.getElementById('supplierDropdownCount');
            
            if (!itemsContainer) return;
            
            const searchTerm = filterText.toLowerCase();
            const filtered = suppliers.filter(s => s.toLowerCase().includes(searchTerm));
            
            itemsContainer.innerHTML = '';
            
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<div class="supplier-dropdown-empty">üîç Tedarik√ßi bulunamadƒ±</div>';
                countElement.textContent = '0 tedarik√ßi';
                return;
            }
            
            countElement.textContent = `${filtered.length} tedarik√ßi`;
            
            filtered.forEach(s => {
                const item = document.createElement('div');
                item.className = 'supplier-dropdown-item';
                item.textContent = s;
                item.onclick = () => selectSupplier(s);
                itemsContainer.appendChild(item);
            });
        }
        
        // Dropdown'ƒ± g√∂ster
        function showSupplierDropdown() {
            const dropdown = document.getElementById('supplierDropdownList');
            const input = document.getElementById('supplierInput');
            
            if (suppliers.length === 0) {
                return;
            }
            
            updateSupplierInputDropdown(input.value);
            dropdown.classList.add('active');
        }
        
        // Dropdown'da arama yap
        function filterSupplierDropdown() {
            const input = document.getElementById('supplierInput');
            updateSupplierInputDropdown(input.value);
            showSupplierDropdown();
        }
        
        // Tedarik√ßi se√ß
        function selectSupplier(supplierName) {
            const input = document.getElementById('supplierInput');
            const dropdown = document.getElementById('supplierDropdownList');
            
            input.value = supplierName;
            dropdown.classList.remove('active');
            
            // Tedarik√ßi se√ßilince hammaddeleri filtrele
            filterMaterialsBySupplier();
        }
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('supplierDropdownList');
            const input = document.getElementById('supplierInput');
            
            if (dropdown && input && !e.target.closest('.supplier-input-container')) {
                dropdown.classList.remove('active');
            }
        });
        
        function toggleSupplier(supplier) {
            if (selectedSuppliers.has(supplier)) {
                selectedSuppliers.delete(supplier);
            } else {
                selectedSuppliers.add(supplier);
            }
            updateSupplierMultiselectText();
            filterList();
        }
        
        function selectAllSuppliers() {
            selectedSuppliers.clear();
            suppliers.forEach(s => selectedSuppliers.add(s));
            updateSupplierDropdowns();
            filterList();
        }
        
        function clearAllSuppliers() {
            selectedSuppliers.clear();
            updateSupplierDropdowns();
            filterList();
        }
        
        function updateSupplierMultiselectText() {
            const text = document.getElementById('supplierMultiselectText');
            if (selectedSuppliers.size === 0) {
                text.textContent = 'T√ºm Tedarik√ßiler';
            } else if (selectedSuppliers.size === 1) {
                text.textContent = Array.from(selectedSuppliers)[0];
            } else {
                text.textContent = `${selectedSuppliers.size} tedarik√ßi se√ßili`;
            }
        }
        
        // ==================== Material Functions ====================
        function loadMaterials() {
            const savedMaterials = localStorage.getItem('coa_materials');
            if (savedMaterials) {
                try {
                    materials = JSON.parse(savedMaterials);
                    console.log('‚úÖ Hammadde listesi y√ºklendi:', materials.length);
                    updateMaterialDropdown();
                } catch (e) {
                    console.error('Hammadde parse hatasƒ±:', e);
                    materials = [];
                }
            }
        }
        
        function saveMaterials(materialsToSave) {
            const dataToSave = materialsToSave || materials;
            localStorage.setItem('coa_materials', JSON.stringify(dataToSave));
            console.log('üíæ Hammadde listesi kaydedildi:', dataToSave.length, 'adet');
        }
        
        function loadMaterialJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Veri formatƒ±nƒ± kontrol et
                    if (Array.isArray(jsonData)) {
                        materials = jsonData;
                    } else if (jsonData.materials && Array.isArray(jsonData.materials)) {
                        materials = jsonData.materials;
                    } else {
                        throw new Error('Ge√ßersiz JSON formatƒ±. Array veya {materials: []} bekleniyor.');
                    }
                    
                    // Verileri localStorage'a kaydet
                    saveMaterials();
                    updateMaterialDropdown();
                    
                    showToast(`‚úÖ ${materials.length} hammadde y√ºklendi!`, 'success');
                    console.log('üì¶ Hammadde JSON y√ºklendi:', materials);
                } catch (error) {
                    console.error('JSON parse hatasƒ±:', error);
                    showToast('‚ùå JSON dosyasƒ± okunamadƒ±: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Input'u sƒ±fƒ±rla (aynƒ± dosya tekrar se√ßilebilsin)
            event.target.value = '';
        }
        
        function showMaterialDropdown() {
            const dropdown = document.getElementById('materialDropdown');
            dropdown.style.display = 'block';
            updateMaterialDropdown();
        }
        
        function hideMaterialDropdown() {
            setTimeout(() => {
                const dropdown = document.getElementById('materialDropdown');
                dropdown.style.display = 'none';
            }, 200);
        }
        
        function filterMaterials(searchText) {
            showMaterialDropdown();
            updateMaterialDropdown(searchText);
        }
        
        function updateMaterialDropdown(filterText = '') {
            const itemsContainer = document.getElementById('materialDropdownItems');
            const countElement = document.getElementById('materialDropdownCount');
            const materialCountLabel = document.getElementById('materialCount');
            
            if (!itemsContainer) return;
            
            // Se√ßili tedarik√ßiyi al
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            
            const searchTerm = filterText.toLowerCase();
            const filtered = materials.filter(m => {
                const code = (m.code || m.stockCode || m.stokKodu || '').toLowerCase();
                const name = (m.name || m.stockName || m.stokAdƒ± || '').toLowerCase();
                const matchesSearch = code.includes(searchTerm) || name.includes(searchTerm);
                
                // Tedarik√ßi se√ßiliyse, sadece o tedarik√ßinin hammaddelerini g√∂ster
                if (selectedSupplier && m.suppliers && m.suppliers.length > 0) {
                    const matchesSupplier = m.suppliers.includes(selectedSupplier);
                    return matchesSearch && matchesSupplier;
                }
                
                return matchesSearch;
            });
            
            itemsContainer.innerHTML = '';
            
            if (filtered.length === 0 && materials.length === 0) {
                itemsContainer.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">üì¶ Hammadde listesi bo≈ü<br><small>Excel y√ºkleyin (Tedarik√ßi bilgilerinin √ºst√ºnde)</small></div>';
                countElement.textContent = '0 hammadde';
                materialCountLabel.innerHTML = '<span style="color: #f44336;">(‚ö†Ô∏è Excel y√ºkleyin)</span>';
                return;
            }
            
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #666;">üîç Sonu√ß bulunamadƒ±</div>';
                countElement.textContent = '0 sonu√ß';
                return;
            }
            
            countElement.textContent = `${filtered.length} hammadde`;
            materialCountLabel.innerHTML = `<span style="color: #4CAF50;">(üì¶ ${materials.length} hammadde)</span>`;
            
            filtered.forEach(material => {
                const code = material.code || material.stockCode || material.stokKodu || '';
                const name = material.name || material.stockName || material.stokAdƒ± || '';
                const displayText = `${code} | ${name}`;
                
                const item = document.createElement('div');
                item.className = 'supplier-dropdown-item';
                item.textContent = displayText;
                item.onclick = () => selectMaterial(code, name);
                itemsContainer.appendChild(item);
            });
        }
        
        function selectMaterial(code, name) {
            const input = document.getElementById('materialCode');
            input.value = `${code} | ${name}`;
            hideMaterialDropdown();
            
            // ƒ∞rsaliye checkbox'larƒ± i≈üaretliyse, o hammaddenin irsaliyelerini g√∂ster
            updateDeliveryOptions(code);
        }
        
        function updateDeliveryOptions(materialCode) {
            const autoFillDateCheckbox = document.getElementById('autoFillDeliveryDate');
            const autoFillNoCheckbox = document.getElementById('autoFillDeliveryNo');
            
            console.log('üîç updateDeliveryOptions √ßaƒürƒ±ldƒ±:', 'Hammadde:', materialCode, 'Tarih CB:', autoFillDateCheckbox?.checked, 'No CB:', autoFillNoCheckbox?.checked);
            
            // Checkbox'lar i≈üaretli deƒüilse devam etme
            if (!autoFillDateCheckbox?.checked && !autoFillNoCheckbox?.checked) {
                console.log('‚ö†Ô∏è Checkbox\'lar i≈üaretli deƒüil, dropdown olu≈üturulmayacak');
                // Mevcut dropdown'larƒ± temizle
                document.getElementById('deliveryDateDropdown')?.remove();
                document.getElementById('deliveryNoDropdown')?.remove();
                return;
            }
            
            // Hammaddeyi bul
            const material = materials.find(m => 
                (m.code || m.stockCode || m.stokKodu) === materialCode
            );
            
            console.log('üîç Bulunan hammadde:', material ? material.code : 'YOK', 'Deliveries:', material?.deliveries?.length || 0);
            
            if (!material || !material.deliveries || material.deliveries.length === 0) {
                showToast('‚ÑπÔ∏è Bu hammadde i√ßin irsaliye bilgisi bulunamadƒ±', 'info', 2000);
                return;
            }
            
            // Se√ßili tedarik√ßiyi al
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            
            // Tedarik√ßiye g√∂re filtrele
            let filteredDeliveries = material.deliveries;
            if (selectedSupplier) {
                filteredDeliveries = material.deliveries.filter(d => d.supplier === selectedSupplier);
                console.log('üîç Tedarik√ßiye g√∂re filtrelendi:', selectedSupplier, 'Sonu√ß:', filteredDeliveries.length, 'kayƒ±t');
            }
            
            if (filteredDeliveries.length === 0) {
                showToast(`‚ÑπÔ∏è ${selectedSupplier} i√ßin irsaliye bilgisi bulunamadƒ±`, 'info', 2000);
                console.log('‚ö†Ô∏è Filtrelenmi≈ü delivery yok');
                // Mevcut dropdown'larƒ± temizle
                document.getElementById('deliveryDateDropdown')?.remove();
                document.getElementById('deliveryNoDropdown')?.remove();
                return;
            }
            
            console.log('‚úÖ Dropdown\'lar olu≈üturulacak:', filteredDeliveries.length, 'kayƒ±t');
            console.log('üì¶ ƒ∞lk 3 delivery:', filteredDeliveries.slice(0, 3));
            
            // ƒ∞rsaliye tarihi dropdown'ƒ±nƒ± olu≈ütur
            if (autoFillDateCheckbox?.checked) {
                console.log('üìÖ Tarih dropdown olu≈üturuluyor...');
                createDeliveryDateDropdown(filteredDeliveries);
            }
            
            // ƒ∞rsaliye no dropdown'ƒ±nƒ± olu≈ütur
            if (autoFillNoCheckbox?.checked) {
                console.log('üìù No dropdown olu≈üturuluyor...');
                createDeliveryNoDropdown(filteredDeliveries);
            }
            
            showToast(`üì¶ ${filteredDeliveries.length} irsaliye kaydƒ± bulundu`, 'success', 2000);
        }
        
        function createDeliveryDateDropdown(deliveries) {
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (!deliveryDateInput) return;
            
            // Mevcut dropdown varsa kaldƒ±r
            const existingDropdown = document.getElementById('deliveryDateDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Yeni dropdown olu≈ütur
            const dropdown = document.createElement('select');
            dropdown.id = 'deliveryDateDropdown';
            dropdown.style.cssText = 'width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;';
            
            // Bo≈ü se√ßenek
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ƒ∞rsaliye tarihi se√ßin...';
            dropdown.appendChild(emptyOption);
            
            // Tarihleri grupla ve sƒ±rala
            // √ñnce tarihleri formatla (eƒüer formatlanmamƒ±≈üsa)
            const formattedDeliveries = deliveries.map(d => ({
                ...d,
                date: d.date && d.date.includes('.') ? d.date : formatExcelDateToDisplay(d.date)
            }));
            
            // Undefined/null tarihleri filtrele
            const validDates = formattedDeliveries.filter(d => d.date && d.date !== 'undefined').map(d => d.date);
            const uniqueDates = [...new Set(validDates)].sort().reverse();
            
            console.log('üìÖ Bulunan irsaliye tarihleri:', uniqueDates.length, 'benzersiz tarih');
            uniqueDates.forEach((date, index) => {
                const count = validDates.filter(d => d === date).length;
                console.log(`   ${index + 1}. ${date} (${count} kayƒ±t)`);
            });
            
            uniqueDates.forEach(date => {
                const option = document.createElement('option');
                
                // Value: YYYY-MM-DD formatƒ± (HTML date input i√ßin)
                // gg.aa.yyyy -> YYYY-MM-DD
                const parts = date.split('.');
                if (parts.length === 3) {
                    option.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                } else {
                    // Eƒüer hala formatlanmamƒ±≈üsa, tekrar dene
                    const formatted = formatExcelDateToDisplay(date);
                    const formattedParts = formatted.split('.');
                    if (formattedParts.length === 3) {
                        option.value = `${formattedParts[2]}-${formattedParts[1]}-${formattedParts[0]}`;
                    } else {
                        option.value = date;
                    }
                }
                
                // Text: gg.aa.yyyy formatƒ± (kullanƒ±cƒ± i√ßin)
                const count = formattedDeliveries.filter(d => d.date === date).length;
                option.textContent = `${date} (${count} kayƒ±t)`;
                option.dataset.displayDate = date; // Orijinal formatƒ± sakla
                
                dropdown.appendChild(option);
            });
            
            // Se√ßim yapƒ±lƒ±nca input'u doldur
            dropdown.onchange = function() {
                if (this.value) {
                    // Value zaten YYYY-MM-DD formatƒ±nda
                    deliveryDateInput.value = this.value;
                    
                    // Orijinal gg.aa.yyyy formatƒ±nƒ± al
                    const selectedOption = this.options[this.selectedIndex];
                    const displayDate = selectedOption.dataset.displayDate;
                    
                    // Aynƒ± tarihteki irsaliye numaralarƒ±nƒ± g√∂ster (formatlanmƒ±≈ü tarih ile filtrele)
                    const sameDateDeliveries = formattedDeliveries.filter(d => d.date === displayDate);
                    updateDeliveryNoForDate(sameDateDeliveries);
                }
            };
            
            // Input'tan sonra ekle
            deliveryDateInput.parentNode.insertBefore(dropdown, deliveryDateInput.nextSibling);
        }
        
        function createDeliveryNoDropdown(deliveries) {
            const deliveryNoInput = document.getElementById('deliveryNo');
            if (!deliveryNoInput) return;
            
            console.log('üîß ƒ∞rsaliye No dropdown olu≈üturuluyor:', deliveries.length, 'kayƒ±t');
            
            // Mevcut dropdown varsa kaldƒ±r
            const existingDropdown = document.getElementById('deliveryNoDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Yeni dropdown olu≈ütur
            const dropdown = document.createElement('select');
            dropdown.id = 'deliveryNoDropdown';
            dropdown.style.cssText = 'width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;';
            
            // Bo≈ü se√ßenek
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ƒ∞rsaliye numarasƒ± se√ßin...';
            dropdown.appendChild(emptyOption);
            
            // Numaralarƒ± sƒ±rala
            const sortedDeliveries = [...deliveries].sort((a, b) => {
                // √ñnce tarihe g√∂re, sonra numaraya g√∂re sƒ±rala
                if (a.date !== b.date) {
                    return b.date.localeCompare(a.date);
                }
                return b.no.localeCompare(a.no);
            });
            
            sortedDeliveries.forEach((delivery, index) => {
                const option = document.createElement('option');
                
                // Seri ve numarayƒ± birle≈ütir (format: SERIE | NUMARA)
                const displayText = delivery.serie && delivery.no 
                    ? `${delivery.serie} | ${delivery.no}`
                    : (delivery.no || delivery.serie || '');
                
                // ƒ∞lk 3 kayƒ±t i√ßin debug
                if (index < 3) {
                    console.log('üìã Dropdown item:', index, 'Seri:', delivery.serie, 'No:', delivery.no, 'Display:', displayText);
                }
                
                option.value = displayText;
                option.dataset.date = delivery.date;
                option.dataset.supplier = delivery.supplier;
                
                option.textContent = displayText;
                
                dropdown.appendChild(option);
            });
            
            // Se√ßim yapƒ±lƒ±nca input'u doldur
            dropdown.onchange = function() {
                if (this.value) {
                    deliveryNoInput.value = this.value;
                    
                    // ƒ∞lgili tarihi de doldur
                    const selectedOption = this.options[this.selectedIndex];
                    const date = selectedOption.dataset.date;
                    if (date) {
                        // gg.aa.yyyy formatƒ±nƒ± YYYY-MM-DD'ye √ßevir
                        const parts = date.split('.');
                        if (parts.length === 3) {
                            document.getElementById('deliveryDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        } else {
                            document.getElementById('deliveryDate').value = date;
                        }
                    }
                }
            };
            
            // Input'tan sonra ekle
            deliveryNoInput.parentNode.insertBefore(dropdown, deliveryNoInput.nextSibling);
        }
        
        function updateDeliveryNoForDate(deliveries) {
            const deliveryNoDropdown = document.getElementById('deliveryNoDropdown');
            if (!deliveryNoDropdown) return;
            
            // Dropdown'ƒ± temizle ve yeniden doldur
            deliveryNoDropdown.innerHTML = '';
            
            // Bo≈ü se√ßenek
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'ƒ∞rsaliye numarasƒ± se√ßin...';
            deliveryNoDropdown.appendChild(emptyOption);
            
            // Sadece bu tarihteki kayƒ±tlarƒ± g√∂ster
            deliveries.forEach(delivery => {
                const option = document.createElement('option');
                
                // Seri ve numarayƒ± birle≈ütir (format: SERIE | NUMARA)
                const displayText = delivery.serie && delivery.no 
                    ? `${delivery.serie} | ${delivery.no}`
                    : (delivery.no || delivery.serie || '');
                
                option.value = displayText;
                option.dataset.date = delivery.date;
                option.textContent = displayText;
                deliveryNoDropdown.appendChild(option);
            });
        }
        
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            
            // Excel'den gelen tarih formatƒ±: YYYY-MM-DD
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            
            return dateStr;
        }
        
        function formatExcelDateToDisplay(dateValue) {
            if (!dateValue) return '';
            
            // Excel serial number'ƒ± tarih nesnesine √ßevir
            if (typeof dateValue === 'number') {
                // Excel'de 1900-01-01 = 1 (ama Excel'de 1900'√ºn ≈üubat 29 hatasƒ± var)
                // JavaScript Date ile d√∂n√º≈üt√ºr
                const excelEpoch = new Date(Date.UTC(1899, 11, 30)); // 30 Aralƒ±k 1899
                const msPerDay = 24 * 60 * 60 * 1000;
                const date = new Date(excelEpoch.getTime() + (dateValue * msPerDay));
                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                return `${day}.${month}.${year}`;
            }
            
            // Date nesnesi ise
            if (dateValue instanceof Date) {
                const day = String(dateValue.getDate()).padStart(2, '0');
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const year = dateValue.getFullYear();
                return `${day}.${month}.${year}`;
            }
            
            // String ise formatƒ± kontrol et
            const str = String(dateValue).trim();
            
            // YYYY-MM-DD formatƒ±
            if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
                const parts = str.split('-');
                return `${parts[2].substring(0,2)}.${parts[1]}.${parts[0]}`;
            }
            
            // DD.MM.YYYY veya DD/MM/YYYY formatƒ± (zaten doƒüru)
            if (/^\d{1,2}[\.\/-]\d{1,2}[\.\/-]\d{4}/.test(str)) {
                const parts = str.split(/[\.\/-]/);
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                return `${day}.${month}.${parts[2]}`;
            }
            
            // Sayƒ± stringi ise (√∂rn: "45769")
            const numValue = parseFloat(str);
            if (!isNaN(numValue) && numValue > 1000) {
                // Excel serial number olarak tekrar dene
                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                const msPerDay = 24 * 60 * 60 * 1000;
                const date = new Date(excelEpoch.getTime() + (numValue * msPerDay));
                
                const day = String(date.getUTCDate()).padStart(2, '0');
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const year = date.getUTCFullYear();
                
                return `${day}.${month}.${year}`;
            }
            
            return str;
        }
        
        function handleMaterialBlur() {
            // Kƒ±sa bir gecikme ile dropdown tƒ±klamalarƒ±na izin ver
            setTimeout(() => {
                const materialInput = document.getElementById('materialCode');
                const value = materialInput?.value?.trim();
                
                if (!value) return;
                
                // Hammadde kodunu ayƒ±kla (format: "KOD | ƒ∞Sƒ∞M")
                let materialCode = value;
                if (value.includes(' | ')) {
                    materialCode = value.split(' | ')[0].trim();
                } else if (value.includes(' - ')) {
                    // Eski format desteƒüi
                    materialCode = value.split(' - ')[0].trim();
                }
                
                // ƒ∞rsaliye bilgilerini g√ºncelle
                updateDeliveryOptions(materialCode);
            }, 200);
        }
        
        // Tedarik√ßi se√ßilince hammaddeleri filtrele
        function filterMaterialsBySupplier() {
            const selectedSupplier = document.getElementById('supplierInput')?.value?.trim();
            const materialInput = document.getElementById('materialCode');
            
            if (selectedSupplier) {
                // Hammadde dropdown'ƒ±nƒ± g√ºncelle
                updateMaterialDropdown(materialInput.value);
                
                // Placeholder'ƒ± g√ºncelle
                materialInput.placeholder = `üîç ${selectedSupplier} hammaddelerini ara...`;
                
                // Bilgi g√∂ster
                const filteredCount = materials.filter(m => 
                    m.suppliers && m.suppliers.includes(selectedSupplier)
                ).length;
                
                if (filteredCount > 0) {
                    showToast(`üì¶ ${selectedSupplier} i√ßin ${filteredCount} hammadde bulundu`, 'info', 2000);
                } else {
                    showToast(`‚ö†Ô∏è ${selectedSupplier} i√ßin hammadde bulunamadƒ±`, 'warning', 2000);
                }
            } else {
                // Tedarik√ßi se√ßili deƒüilse t√ºm hammaddeleri g√∂ster
                materialInput.placeholder = 'üîç Hammadde ara veya yazƒ±n...';
                updateMaterialDropdown(materialInput.value);
            }
        }
        
        // Dropdown dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
        document.addEventListener('click', function(e) {
            const materialWrapper = document.querySelector('.supplier-dropdown-wrapper');
            const materialDropdown = document.getElementById('materialDropdown');
            
            if (materialWrapper && !materialWrapper.contains(e.target)) {
                if (materialDropdown) {
                    materialDropdown.style.display = 'none';
                }
            }
        });
        
        // ==================== File Upload ====================
        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#2d5a3d';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ccc';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }
        
        // PDF'i resme √ßevirip sƒ±kƒ±≈ütƒ±r (pdf.js kullanarak)
        async function compressPDF(file, maxSizeKB = 400) {
            return new Promise(async (resolve) => {
                try {
                    const maxSize = maxSizeKB * 1024;
                    
                    // PDF.js worker ayarla
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    // Dosyayƒ± ArrayBuffer olarak oku
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // PDF'i y√ºkle
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const numPages = pdf.numPages;
                    
                    console.log('PDF sayfa sayƒ±sƒ±: ' + numPages);
                    showToast('üìÑ PDF ' + numPages + ' sayfa, d√∂n√º≈üt√ºr√ºl√ºyor...', 'info');
                    
                    // T√ºm sayfalarƒ± tek bir canvas'a √ßiz
                    const scale = 1.5; // Kalite i√ßin scale
                    let totalHeight = 0;
                    let maxWidth = 0;
                    const pageCanvases = [];
                    
                    // Her sayfayƒ± render et
                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: scale });
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                        
                        pageCanvases.push(canvas);
                        totalHeight += viewport.height;
                        if (viewport.width > maxWidth) maxWidth = viewport.width;
                    }
                    
                    // T√ºm sayfalarƒ± birle≈ütir
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = maxWidth;
                    finalCanvas.height = totalHeight;
                    const finalCtx = finalCanvas.getContext('2d');
                    finalCtx.fillStyle = 'white';
                    finalCtx.fillRect(0, 0, maxWidth, totalHeight);
                    
                    let yOffset = 0;
                    for (const canvas of pageCanvases) {
                        finalCtx.drawImage(canvas, 0, yOffset);
                        yOffset += canvas.height;
                    }
                    
                    // JPEG olarak sƒ±kƒ±≈ütƒ±r
                    let quality = 0.85;
                    let result = finalCanvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.2) {
                        quality -= 0.1;
                        result = finalCanvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale2 = Math.sqrt(maxSize / result.length) * 0.9;
                        finalCanvas.width = Math.round(maxWidth * scale2);
                        finalCanvas.height = Math.round(totalHeight * scale2);
                        finalCtx.fillStyle = 'white';
                        finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                        
                        yOffset = 0;
                        for (const canvas of pageCanvases) {
                            const newHeight = canvas.height * scale2;
                            finalCtx.drawImage(canvas, 0, yOffset, finalCanvas.width, newHeight);
                            yOffset += newHeight;
                        }
                        result = finalCanvas.toDataURL('image/jpeg', 0.7);
                    }
                    
                    console.log('PDF Sƒ±kƒ±≈ütƒ±rma: ' + Math.round(file.size/1024) + 'KB -> ' + Math.round(result.length/1024) + 'KB');
                    resolve({ 
                        data: result, 
                        compressed: true, 
                        originalSize: file.size, 
                        newSize: result.length,
                        convertedToImage: true
                    });
                    
                } catch (error) {
                    console.error('PDF sƒ±kƒ±≈ütƒ±rma hatasƒ±:', error);
                    // Hata olursa orijinal dosyayƒ± d√∂nd√ºr
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, compressed: false, error: error.message });
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Resmi sƒ±kƒ±≈ütƒ±r (max 500KB)
        async function compressImage(file, maxSizeKB = 400) {
            return new Promise((resolve) => {
                const maxSize = maxSizeKB * 1024;
                
                // Resim deƒüilse direkt oku
                if (!file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ data: e.target.result, compressed: false });
                    reader.readAsDataURL(file);
                    return;
                }
                
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Max boyut 1920px
                    const maxDim = 1920;
                    if (width > maxDim || height > maxDim) {
                        if (width > height) {
                            height = Math.round(height * maxDim / width);
                            width = maxDim;
                        } else {
                            width = Math.round(width * maxDim / height);
                            height = maxDim;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Kaliteyi d√º≈ü√ºrerek sƒ±kƒ±≈ütƒ±r
                    let quality = 0.9;
                    let result = canvas.toDataURL('image/jpeg', quality);
                    
                    while (result.length > maxSize && quality > 0.1) {
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    // Hala b√ºy√ºkse boyutu k√º√ß√ºlt
                    if (result.length > maxSize) {
                        const scale = Math.sqrt(maxSize / result.length);
                        canvas.width = Math.round(width * scale);
                        canvas.height = Math.round(height * scale);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        result = canvas.toDataURL('image/jpeg', 0.8);
                    }
                    
                    console.log('Sƒ±kƒ±≈ütƒ±rma: ' + Math.round(file.size/1024) + 'KB -> ' + Math.round(result.length/1024) + 'KB');
                    resolve({ data: result, compressed: true, originalSize: file.size, newSize: result.length });
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function handleFile(file) {
            if (!file) return;
            
            // Eƒüer dosya i≈üleme devam ediyorsa, √ßƒ±kƒ±≈ü yap (duplicate event)
            if (isProcessingFile) {
                console.log('‚ö†Ô∏è Dosya zaten i≈üleniyor, duplicate event atlandƒ±');
                return;
            }
            
            isProcessingFile = true;
            console.log('üìÅ handleFile √ßaƒürƒ±ldƒ±:', file.name, 'Template mode:', templateMode);
            
            // Template mode kontrol√º
            if (templateMode) {
                console.log('üé® Template mode aktif - Editor a√ßƒ±lacak');
                pendingTemplateFile = file;
                try {
                    await openTemplateEditorWithFile(file);
                } catch (error) {
                    console.error('‚ùå Template editor hatasƒ±:', error);
                } finally {
                    isProcessingFile = false;
                }
                return;
            }
            
            console.log('üìã Normal mode - COA kaydƒ± olu≈üturulacak');
            
            // Normal mode
            try {
                selectedFile = file;
                const uploadArea = document.getElementById('uploadArea');
                const preview = document.getElementById('filePreview');
                
                uploadArea.classList.add('has-file');
                
                const fileSizeKB = Math.round(file.size / 1024);
                showToast('üìÅ Dosya: ' + file.name + ' (' + fileSizeKB + 'KB)', 'info');
            
            // PDF - ORJƒ∞NAL olarak sakla, resme d√∂n√º≈üt√ºrme
            if (file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    preview.innerHTML = '<div class="file-name" style="color:green;">üìÑ ' + file.name + ' (PDF - orjinal kalite)</div>';
                    showToast('‚úÖ PDF hazƒ±r (orjinal kalite)', 'success');
                    
                    // Template varsa template OCR, yoksa normal OCR ba≈ülat
                    if (window.currentTemplate) {
                        console.log('üé® Template mevcut, template OCR ba≈ülatƒ±lacak');
                        startCOATemplateOCR();
                    } else {
                        startOCRAnalysis();
                    }
                    isProcessingFile = false; // OCR arka planda devam edecek
                };
                reader.readAsDataURL(file);
            }
            // Excel dosyalarƒ± (.xlsx, .xls)
            else if (file.type.includes('spreadsheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    preview.innerHTML = '<div class="file-name" style="color:#107c41;">üìä ' + file.name + ' (Excel - orjinal)</div>';
                    showToast('‚úÖ Excel dosyasƒ± hazƒ±r', 'success');
                    
                    // Template varsa template OCR ba≈ülat
                    if (window.currentTemplate) {
                        console.log('üé® Template mevcut, Excel template OCR ba≈ülatƒ±lacak');
                        startCOATemplateOCR();
                    }
                    
                    isProcessingFile = false;
                };
                reader.readAsDataURL(file);
            }
            // Word dosyalarƒ± (.docx, .doc)
            else if (file.type.includes('wordprocessing') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    preview.innerHTML = '<div class="file-name" style="color:#2b579a;">üìù ' + file.name + ' (Word - orjinal)</div>';
                    showToast('‚úÖ Word dosyasƒ± hazƒ±r', 'success');
                    
                    // Template varsa template OCR ba≈ülat
                    if (window.currentTemplate) {
                        console.log('üé® Template mevcut, Word template OCR ba≈ülatƒ±lacak');
                        startCOATemplateOCR();
                    }
                    
                    isProcessingFile = false;
                };
                reader.readAsDataURL(file);
            }
            // Resim sƒ±kƒ±≈ütƒ±rma (400KB √ºst√º)
            else if (file.type.startsWith('image/') && file.size > 400 * 1024) {
                showToast('üîÑ Resim sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...', 'info');
                const compressed = await compressImage(file, 400);
                selectedFileData = compressed.data; // Drive i√ßin sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü (400KB)
                
                if (compressed.compressed) {
                    const newSizeKB = Math.round(compressed.newSize / 1024);
                    showToast('‚úÖ Sƒ±kƒ±≈ütƒ±rƒ±ldƒ±: ' + fileSizeKB + 'KB -> ' + newSizeKB + 'KB', 'success');
                }
                
                preview.innerHTML = '<div class="file-name">üì∑ ' + file.name + ' (sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü)</div>' +
                    '<img src="' + selectedFileData + '" class="preview-image">';
                
                // üì∏ OCR i√ßin ORƒ∞Jƒ∞NAL dosyayƒ± kullan ama akƒ±llƒ±ca optimize et
                console.log('üîç OCR i√ßin orijinal dosya i≈üleniyor (y√ºksek kalite)...');
                showToast('üîç OCR optimizasyonu (orijinal kalite)...', 'info');
                
                const ocrReader = new FileReader();
                ocrReader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Akƒ±llƒ± boyut kontrol√º - OCR.space 1MB limiti i√ßin
                        let maxWidth = 1300; // Daha b√ºy√ºk ba≈ülangƒ±√ß (daha fazla detay)
                        let quality = 0.87; // Dengeli kalite
                        let result = null;
                        
                        // Boyut limitini a≈üana kadar deneme yap
                        for (let attempt = 0; attempt < 3; attempt++) {
                            const canvas = document.createElement('canvas');
                            let targetWidth = Math.min(img.width, maxWidth);
                            let targetHeight = Math.round((img.height * targetWidth) / img.width);
                            
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            const ctx = canvas.getContext('2d');
                            
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                            
                            // Kontrast artƒ±rma (dengeli - √ßok fazla detay kaybettirmemeli)
                            const imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
                            const data = imageData.data;
                            const contrastFactor = 1.35; // %35 kontrast (dengeli)
                            const brightness = 6; // Dengeli parlaklƒ±k
                            
                            for (let i = 0; i < data.length; i += 4) {
                                data[i] = Math.min(255, Math.max(0, contrastFactor * (data[i] - 128) + 128 + brightness));
                                data[i + 1] = Math.min(255, Math.max(0, contrastFactor * (data[i + 1] - 128) + 128 + brightness));
                                data[i + 2] = Math.min(255, Math.max(0, contrastFactor * (data[i + 2] - 128) + 128 + brightness));
                            }
                            
                            ctx.putImageData(imageData, 0, 0);
                            
                            const testResult = canvas.toDataURL('image/jpeg', quality);
                            const sizeKB = Math.round(testResult.length / 1024);
                            
                            console.log(`üîç Deneme ${attempt + 1}: ${targetWidth}x${targetHeight}, Q${quality.toFixed(2)}, ${sizeKB}KB`);
                            
                            // 780KB altƒ±ndaysa kabul et
                            if (sizeKB < 780) {
                                result = testResult;
                                console.log(`‚úÖ OCR optimize: ${sizeKB}KB (${targetWidth}x${targetHeight})`);
                                break;
                            }
                            
                            // Daha k√º√ß√ºlt
                            maxWidth = Math.round(maxWidth * 0.8);
                            quality = Math.max(0.75, quality - 0.05);
                        }
                        
                        window.originalFileDataForOCR = result || canvas.toDataURL('image/jpeg', 0.70);
                        startOCRAnalysis();
                        isProcessingFile = false; // OCR arka planda devam edecek
                    };
                    img.src = e.target.result; // ORƒ∞Jƒ∞NAL dosyadan oku
                };
                ocrReader.readAsDataURL(file); // ORƒ∞Jƒ∞NAL dosyayƒ± oku (sƒ±kƒ±≈ütƒ±rƒ±lmamƒ±≈ü)
            }
            // K√º√ß√ºk resim veya diƒüer dosyalar
            else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileData = e.target.result;
                    
                    if (file.type.startsWith('image/')) {
                        preview.innerHTML = '<div class="file-name">üì∑ ' + file.name + '</div>' +
                            '<img src="' + e.target.result + '" class="preview-image">';
                        
                        // Resim y√ºklendikten sonra OCR ba≈ülat
                        startOCRAnalysis();
                    } else {
                        preview.innerHTML = '<div class="file-name">üìÑ ' + file.name + '</div>';
                    }
                    
                    isProcessingFile = false; // Kilidi serbest bƒ±rak
                };
                reader.readAsDataURL(file);
            }
            } catch (error) {
                console.error('‚ùå Dosya i≈üleme hatasƒ±:', error);
                showToast('‚ùå Dosya y√ºklenemedi', 'error');
                isProcessingFile = false;
            }
        }
        
        // OCR analizini ba≈ülat (dosya y√ºklenir y√ºklenmez)
        function startOCRAnalysis() {
            console.log('üéØ startOCRAnalysis √ßaƒürƒ±ldƒ±');
            
            // OCR i√ßin orijinal dosya varsa onu kullan (y√ºksek kalite)
            // Yoksa sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü selectedFileData'yƒ± kullan
            const fileDataForOCR = window.originalFileDataForOCR || selectedFileData;
            
            if (!fileDataForOCR) {
                console.log('‚ö†Ô∏è Dosya verisi yok, OCR ba≈ülatƒ±lamadƒ±');
                return;
            }
            
            console.log('üìÑ OCR i√ßin kullanƒ±lan dosya:', window.originalFileDataForOCR ? 'ORƒ∞Jƒ∞NAL (y√ºksek kalite)' : 'SIKI≈ûTIRILMI≈û');
            
            const materialCode = document.getElementById('materialCode').value.trim();
            
            // Hammadde kodu yoksa sadece OCR yap, e≈üle≈ütirme yapma
            if (!materialCode) {
                console.log('‚ö†Ô∏è Material code bo≈ü, OCR yapƒ±lacak ama e≈üle≈ütirme ertelenecek');
                const fileDataCopy = fileDataForOCR + '';
                
                extractCOAProperties(fileDataCopy)
                    .then(coaProperties => {
                        console.log('‚úÖ OCR tamamlandƒ± (e≈üle≈ütirme yok - hammadde se√ßilmemi≈ü)');
                        // Ge√ßici olarak sakla
                        window.lastOCRProperties = coaProperties;
                        showToast('‚úÖ Belge okundu, hammadde se√ßin', 'info');
                    })
                    .catch(error => {
                        console.error('‚ùå OCR hatasƒ±:', error);
                        showToast('‚ö†Ô∏è OCR hatasƒ±: ' + error.message, 'warning');
                    });
                return;
            }
            
            const materialCodeOnly = materialCode.includes(' | ') ? materialCode.split(' | ')[0].trim() : 
                                     materialCode.includes(' - ') ? materialCode.split(' - ')[0].trim() : 
                                     materialCode;
            
            console.log('üîë Hammadde kodu:', materialCodeOnly);
            console.log('üöÄ OCR ba≈ülatƒ±lƒ±yor...');
            
            const fileDataCopy = fileDataForOCR + '';
            
            extractCOAProperties(fileDataCopy)
                .then(coaProperties => {
                    console.log('‚úÖ OCR tamamlandƒ±!');
                    const matchCount = matchCOAWithTDS(materialCodeOnly, coaProperties);
                    
                    // OCR tamamlandƒ±ƒüƒ±nƒ± i≈üaretle (modal a√ßƒ±lƒ±rken deƒüerleri korumak i√ßin)
                    lastOCRMaterialCode = materialCodeOnly;
                    console.log('üîñ lastOCRMaterialCode set:', lastOCRMaterialCode);
                    
                    // TDS modalƒ± yenile (a√ßƒ±k olsun olmasƒ±n)
                    console.log('üîÑ TDS verisi g√ºncellendi, modal yenileniyor...');
                    const tdsModal = document.getElementById('tdsModal');
                    if (tdsModal && tdsModal.classList.contains('active') && currentTDSMaterial === materialCodeOnly) {
                        // Modal a√ßƒ±ksa ve aynƒ± hammadde ise refresh et (COA deƒüerlerini KORUYARAK)
                        loadTDSForMaterial(false); // false = COA deƒüerlerini temizleme
                        showToast(`‚úÖ ${matchCount} √∂zellik e≈üle≈ütirildi ve g√ºncellendi`, 'success', 5000);
                    } else if (matchCount > 0) {
                        showToast(`‚úÖ ${matchCount} √∂zellik e≈üle≈ütirildi, TDS modalƒ±nƒ± a√ßƒ±n`, 'success', 5000);
                    }
                })
                .catch(error => {
                    console.error('‚ùå OCR hatasƒ±:', error);
                    showToast('‚ö†Ô∏è OCR hatasƒ±: ' + error.message, 'warning');
                });
        }
        
        // ==================== CRUD Operations ====================
        async function saveCOA() {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üíæüíæüíæ saveCOA FONKSIYONU √áAƒûRILDI! üíæüíæüíæ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìù editMode:', editMode);
            console.log('üìÑ selectedFileData var mƒ±:', !!selectedFileData);
            console.log('üìÑ selectedFileData uzunluƒüu:', selectedFileData ? selectedFileData.length : 0);
            
            const supplier = document.getElementById('supplierInput').value.trim();
            const materialCode = document.getElementById('materialCode').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryNo = document.getElementById('deliveryNo').value.trim();
            const lotNumber = document.getElementById('lotNumber').value.trim();
            const location = document.getElementById('location').value;
            const notes = document.getElementById('notes').value.trim();
            
            console.log('üì¶ Material Code:', materialCode);
            
            // Validation
            if (!supplier) {
                showToast('‚ùå Tedarik√ßi adƒ± girin!', 'error');
                return;
            }
            if (!materialCode) {
                showToast('‚ùå Hammadde kodu girin!', 'error');
                return;
            }
            if (!deliveryDate) {
                showToast('‚ùå ƒ∞rsaliye tarihi girin!', 'error');
                return;
            }
            
            console.log('‚úÖ Validasyon ge√ßti');
            
            // Edit mode - dosya opsiyonel
            if (editMode) {
                console.log('üìù Edit mode aktif');
                const existingRecord = coaData.find(c => c.id === editingId);
                if (!existingRecord) {
                    showToast('‚ùå Kayƒ±t bulunamadƒ±!', 'error');
                    return;
                }
                
                // Yeni dosya y√ºklendiyse Drive'a upload et
                let uploadResult = null;
                if (selectedFileData) {
                    console.log('üìÑ Edit modda yeni dosya y√ºklendi, OCR ba≈ülatƒ±lƒ±yor...');
                    showToast('‚òÅÔ∏è Yeni dosya Drive\'a y√ºkleniyor...', 'info');
                    
                    try {
                        // XMLHttpRequest POST (b√ºy√ºk veri i√ßin)
                        const compressedData = await compressForSheets(selectedFileData, 200);
                        console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                        console.log('Cihaz:', /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobil' : 'Desktop');
                        
                        uploadResult = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.timeout = 120000; // 120 saniye (mobil i√ßin)
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        resolve(JSON.parse(xhr.responseText));
                                    } catch(e) {
                                        reject(new Error('JSON parse hatasƒ±'));
                                    }
                                } else {
                                    reject(new Error('HTTP ' + xhr.status));
                                }
                            };
                            
                            xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                            xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                            
                            xhr.open('POST', googleScriptUrl, true);
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            
                            const formData = new URLSearchParams();
                            formData.append('action', 'uploadFile');
                            formData.append('fileData', compressedData);
                            formData.append('fileName', selectedFile.name);
                            formData.append('mimeType', selectedFile.type || 'image/jpeg');
                            
                            xhr.send(formData.toString());
                        });
                        
                        console.log('Drive upload sonucu:', uploadResult);
                        
                        if (!uploadResult || !uploadResult.success) {
                            showToast('‚ùå Dosya y√ºklenemedi: ' + (uploadResult?.error || 'Bilinmeyen hata'), 'error');
                            return;
                        }
                        showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
                    } catch (uploadErr) {
                        console.error('Drive upload hatasƒ±:', uploadErr);
                        showToast('‚ùå Dosya y√ºkleme hatasƒ±: ' + uploadErr.message, 'error');
                        return;
                    }
                }
                
                // Record olu≈ütur - yeni dosya varsa onun bilgilerini kullan, yoksa eski dosyayƒ± koru
                const record = {
                    id: editingId,
                    supplier: supplier,
                    materialCode: materialCode,
                    deliveryDate: deliveryDate,
                    deliveryNo: deliveryNo,
                    lotNumber: lotNumber,
                    location: location,
                    notes: notes,
                    fileName: uploadResult ? uploadResult.fileName : existingRecord.fileName,
                    fileType: uploadResult ? selectedFile.type : existingRecord.fileType,
                    fileData: uploadResult ? selectedFileData : existingRecord.fileData,
                    fileUrl: uploadResult ? uploadResult.viewUrl : existingRecord.fileUrl,
                    driveFileId: uploadResult ? uploadResult.fileId : existingRecord.driveFileId,
                    fileSize: uploadResult ? uploadResult.fileSize : existingRecord.fileSize, // Ger√ßek boyut
                    ocrProperties: existingRecord.ocrProperties || {},  // ‚úÖ OCR deƒüerlerini koru
                    createdAt: existingRecord.createdAt,
                    updatedAt: new Date().toISOString()
                };
                
                // ‚úÖ TDS'teki manuel deƒüerleri ocrProperties'e merge et
                const tds = tdsData[materialCode];
                if (tds && tds.properties) {
                    console.log('üîÑ TDS\'teki manuel deƒüerler ocrProperties\'e aktarƒ±lƒ±yor...');
                    tds.properties.forEach(prop => {
                        if (prop.coaValue) {  // Sadece COA deƒüeri olanlarƒ±
                            if (!record.ocrProperties) record.ocrProperties = {};
                            
                            // Mevcut ocrProperty'yi g√ºncelle veya yeni olu≈ütur
                            if (!record.ocrProperties[prop.name]) {
                                record.ocrProperties[prop.name] = {};
                            }
                            
                            // Manuel girilen COA deƒüerleri ile g√ºncelle
                            const requirement = prop.requirement || record.ocrProperties[prop.name].requirement || '';
                            const minLimit = prop.min || record.ocrProperties[prop.name].lowerLimit || '';
                            const maxLimit = prop.max || record.ocrProperties[prop.name].upperLimit || '';
                            const stdValue = prop.standardValue || record.ocrProperties[prop.name].standardValue || '';
                            
                            // ‚úÖ Otomatik compliance hesaplama
                            const autoStatus = calculateCompliance(prop.coaValue, requirement, minLimit, maxLimit, stdValue);
                            
                            record.ocrProperties[prop.name] = {
                                ...record.ocrProperties[prop.name],  // Eski deƒüerleri koru
                                coaValue: prop.coaValue,  // ‚úÖ Manuel deƒüer
                                status: autoStatus,  // ‚úÖ OTOMATIK HESAPLANAN deƒüer (artƒ±k manuel deƒüil!)
                                tdsValue: stdValue,
                                unit: prop.unit || record.ocrProperties[prop.name].unit || '',
                                method: prop.standard || record.ocrProperties[prop.name].method || '',
                                lowerLimit: minLimit,
                                upperLimit: maxLimit,
                                standardValue: stdValue,
                                requirement: requirement
                            };
                            console.log(`   ‚úèÔ∏è ${prop.name}: "${prop.coaValue}" [${autoStatus}] (otomatik)`);
                        }
                    });
                }
                
                // OCR zaten fotoƒüraf √ßekilirken yapƒ±ldƒ±, tekrar yapmaya gerek yok
                console.log('‚ÑπÔ∏è Edit modda OCR atlanƒ±yor (√ßekim sƒ±rasƒ±nda yapƒ±ldƒ±)');
                
                // üìä OCR deƒüerleri varsa COA_Records'a da kaydet
                if (record.ocrProperties && Object.keys(record.ocrProperties).length > 0) {
                    console.log('üìä Edit modda ocrProperties COA_Records\'a kaydediliyor:', Object.keys(record.ocrProperties).length, '√∂zellik');
                    
                    // Object formatƒ±ndan Array formatƒ±na √ßevir
                    const propertiesArray = Object.entries(record.ocrProperties).map(([name, data]) => {
                        const propData = {
                            name: name,
                            coaValue: data.coaValue || '',
                            unit: data.unit || '',
                            standard: data.method || '',
                            operator: 'range',
                            standardValue: data.standardValue || '',
                            min: data.lowerLimit || '',
                            max: data.upperLimit || '',
                            requirement: data.requirement || '',
                            status: data.status || data.compliance || 'Bilinmiyor'
                        };
                        
                        // 0, ile ba≈ülayan deƒüerleri logla
                        if (propData.coaValue && /^0[,\.]/.test(propData.coaValue)) {
                            console.log(`   üîç ${name} COA deƒüeri: "${propData.coaValue}"`);
                        }
                        if (propData.min && /^0[,\.]/.test(propData.min)) {
                            console.log(`   üîç ${name} Min: "${propData.min}"`);
                        }
                        if (propData.max && /^0[,\.]/.test(propData.max)) {
                            console.log(`   üîç ${name} Max: "${propData.max}"`);
                        }
                        if (propData.standardValue && /^0[,\.]/.test(propData.standardValue)) {
                            console.log(`   üîç ${name} StandardValue: "${propData.standardValue}"`);
                        }
                        
                        return propData;
                    });
                    
                    const recordData = {
                        date: deliveryDate,
                        deliveryNo: deliveryNo || '',
                        lotNumber: lotNumber || '',
                        materialCode: materialCode,  // ‚úÖ Apps Script'in e≈üle≈ütirme yapmasƒ± i√ßin gerekli
                        supplier: supplier,
                        location: location || '',
                        properties: propertiesArray
                    };
                    
                    try {
                        const dataStr = JSON.stringify(recordData);
                        const url = `${googleScriptUrl}?action=saveCOARecord&data=${encodeURIComponent(dataStr)}`;
                        const saveResponse = await fetch(url);
                        const saveResult = await saveResponse.json();
                        
                        if (saveResult.success) {
                            console.log(`‚úÖ ${saveResult.recordCount} √∂zellik COA_Records'a g√ºncellendi`);
                        } else {
                            console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', saveResult.error);
                        }
                    } catch(err) {
                        console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', err);
                    }
                }
                
                // Google Sheets'e g√ºncelle
                if (googleScriptUrl) {
                    const result = await updateToGoogleSheets(record);
                    if (result) {
                        const idx = coaData.findIndex(c => c.id === editingId);
                        if (idx >= 0) {
                            coaData[idx] = record;
                        }
                        saveToLocalStorage(); // G√ºncelleme sonrasƒ± yedekle
                        showToast('‚úÖ COA g√ºncellendi!', 'success');
                    }
                } else {
                    const idx = coaData.findIndex(c => c.id === editingId);
                    if (idx >= 0) {
                        coaData[idx] = record;
                    }
                    saveToLocalStorage(); // Sheets yokken yerel g√ºncelleme
                    showToast('‚úÖ Yerel olarak g√ºncellendi!', 'success');
                }
                
                cancelEdit();
                updateUI();
                return;
            }
            
            // Yeni kayƒ±t - dosya zorunlu
            console.log('üìÑ Yeni kayƒ±t modu');
            if (!selectedFileData) {
                showToast('‚ùå Sertifika dosyasƒ± y√ºkleyin!', 'error');
                return;
            }
            
            console.log('‚úÖ Dosya var, Drive y√ºkleme ba≈ülƒ±yor...');
            
            // √ñnce Drive'a y√ºkle
            showToast('‚òÅÔ∏è Dosya Drive\'a y√ºkleniyor...', 'info');
            let uploadResult = null;
            
            try {
                const compressedData = await compressForSheets(selectedFileData, 200);
                console.log('Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                console.log('Cihaz:', /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobil' : 'Desktop');
                
                uploadResult = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 120000; // 120 saniye (mobil i√ßin)
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                    xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'uploadFile');
                    formData.append('fileData', compressedData);
                    formData.append('fileName', selectedFile.name);
                    formData.append('mimeType', selectedFile.type || 'image/jpeg');
                    
                    xhr.send(formData.toString());
                });
                
                console.log('Drive upload sonucu:', uploadResult);
                
                if (!uploadResult || !uploadResult.success) {
                    showToast('‚ùå Dosya y√ºklenemedi: ' + (uploadResult?.error || 'Bilinmeyen hata'), 'error');
                    return;
                }
                showToast('‚úÖ Dosya Drive\'a y√ºklendi!', 'success');
            } catch (uploadErr) {
                console.error('Drive upload hatasƒ±:', uploadErr);
                showToast('‚ùå Dosya y√ºkleme hatasƒ±: ' + uploadErr.message, 'error');
                return;
            }
            
            const record = {
                id: 'coa_' + Date.now(),
                supplier: supplier,
                materialCode: materialCode,
                deliveryDate: deliveryDate,
                deliveryNo: deliveryNo,
                lotNumber: lotNumber,
                location: location,
                notes: notes,
                fileName: uploadResult.fileName,
                fileType: selectedFile.type,
                fileData: selectedFileData,
                fileUrl: uploadResult.viewUrl,
                driveFileId: uploadResult.fileId,
                fileSize: uploadResult.fileSize, // Ger√ßek dosya boyutu (bytes)
                createdAt: new Date().toISOString()
            };
            
            // OCR'dan transfer edilen verileri ekle (varsa)
            if (window.pendingOCRData && window.pendingOCRData.properties) {
                // Array'i Object'e √ßevir: [{name, coaValue}, ...] -> {name: {coaValue, status}, ...}
                const ocrPropsObject = {};
                window.pendingOCRData.properties.forEach(prop => {
                    ocrPropsObject[prop.name] = {
                        tdsValue: prop.tdsValue || '',
                        coaValue: prop.coaValue || '',
                        unit: prop.unit || '',
                        status: prop.coaCompliance || prop.status || '-',
                        method: prop.standard || '',
                        lowerLimit: prop.lowerLimit || '',
                        upperLimit: prop.upperLimit || '',
                        standardValue: prop.standardValue || '',
                        requirement: prop.requirement || ''
                    };
                });
                record.ocrProperties = ocrPropsObject;
                console.log('üìä OCR verileri COA kaydƒ±na eklendi (Object formatƒ±nda):', Object.keys(ocrPropsObject).length, '√∂zellik');
            } else {
                // pendingOCRData yoksa TDS'teki manuel deƒüerleri kullan
                const tds = tdsData[materialCode];
                if (tds && tds.properties) {
                    console.log('üìã TDS\'teki manuel deƒüerler ocrProperties\'e aktarƒ±lƒ±yor...');
                    const ocrPropsObject = {};
                    tds.properties.forEach(prop => {
                        if (prop.coaValue) {  // Sadece COA deƒüeri olanlarƒ±
                            ocrPropsObject[prop.name] = {
                                tdsValue: prop.standardValue || '',
                                coaValue: prop.coaValue || '',
                                unit: prop.unit || '',
                                status: prop.coaCompliance || 'Bilinmiyor',
                                method: prop.standard || '',
                                lowerLimit: prop.min || '',
                                upperLimit: prop.max || '',
                                standardValue: prop.standardValue || '',
                                requirement: prop.requirement || ''
                            };
                        }
                    });
                    if (Object.keys(ocrPropsObject).length > 0) {
                        record.ocrProperties = ocrPropsObject;
                        console.log('üìä TDS manuel deƒüerleri COA kaydƒ±na eklendi:', Object.keys(ocrPropsObject).length, '√∂zellik');
                    }
                }
            }
            
            // OCR zaten fotoƒüraf √ßekilirken yapƒ±ldƒ± (startOCRAnalysis), tekrar yapmaya gerek yok
            console.log('‚ÑπÔ∏è OCR atlanƒ±yor (√ßekim sƒ±rasƒ±nda yapƒ±ldƒ±)');
            
            // Save - Google Sheets'e kaydet
            if (googleScriptUrl) {
                const success = await saveToGoogleSheets(record);
                if (success) {
                    coaData.unshift(record);
                    showToast('‚úÖ Google Sheets\'e kaydedildi!', 'success');
                    console.log('‚úÖ KAYIT TAMAMLANDI - SHEETS\'E G√ñNDERƒ∞LDƒ∞!');
                    
                    // COA_Records'a da kaydet (TDS tanƒ±mlƒ±ysa)
                    // materialCode'dan sadece kod kƒ±smƒ±nƒ± √ßƒ±kar (pipe √∂ncesi)
                    const cleanMaterialCode = materialCode.includes('|') 
                        ? materialCode.split('|')[0].trim() 
                        : materialCode.trim();
                    
                    console.log('üîë Clean Material Code for Records:', cleanMaterialCode);
                    
                    // OCR'dan gelen veriler varsa onlarƒ± kullan, yoksa TDS'i kullan
                    let propertiesToSave = null;
                    if (window.pendingOCRData && window.pendingOCRData.properties) {
                        // Array formatƒ±nda zaten
                        propertiesToSave = window.pendingOCRData.properties;
                        console.log('üìä COA_Records i√ßin OCR verileri kullanƒ±lƒ±yor:', propertiesToSave.length, '√∂zellik');
                    } else if (tdsData[cleanMaterialCode]) {
                        // OCR yoksa TDS'i kullan ama bo≈ü COA deƒüerleri ve "Bekliyor" durumu ile
                        propertiesToSave = tdsData[cleanMaterialCode].properties.map(prop => ({
                            ...prop,
                            coaValue: '',
                            status: 'Bekliyor'
                        }));
                        console.log('üìä COA_Records i√ßin TDS verileri kullanƒ±lƒ±yor (COA deƒüerleri bo≈ü)');
                    }
                    
                    if (propertiesToSave) {
                        console.log('üìä COA_Records kaydƒ± ba≈ülatƒ±lƒ±yor...');
                        await saveCOARecordToSheets(cleanMaterialCode, propertiesToSave);
                        
                        // Pending OCR data'yƒ± temizle
                        if (window.pendingOCRData) {
                            console.log('üßπ pendingOCRData temizlendi');
                            window.pendingOCRData = null;
                        }
                    } else {
                        console.log('‚ö†Ô∏è TDS tanƒ±mlƒ± deƒüil:', cleanMaterialCode);
                    }
                } else {
                    showToast('‚ùå Kayƒ±t hatasƒ±!', 'error');
                    return;
                }
            } else {
                // Sheets yokken FALLBACK: localStorage'a kaydet
                console.log('‚ö†Ô∏è Google Sheets URL yok, yerel kayƒ±t yapƒ±lƒ±yor...');
                coaData.unshift(record);
                saveToLocalStorage();
                showToast('‚ö†Ô∏è Sheets olmadan yerel kayƒ±t yapƒ±ldƒ±!', 'warning', 5000);
                showToast('üí° Sheets baƒülandƒ±ƒüƒ±nda senkronize edin', 'info', 5000);
                console.log('‚úÖ KAYIT TAMAMLANDI - LOCAL ONLY (FALLBACK)!');
            }
            
            console.log('‚úÖ Kayƒ±t tamamlandƒ±, form temizleniyor...');
            
            // Reset form
            clearForm();
            updateUI();
            loadSuppliers();
        }
        
        function clearForm() {
            document.getElementById('supplierInput').value = '';
            document.getElementById('materialCode').value = '';
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryNo').value = '';
            document.getElementById('lotNumber').value = '';
            document.getElementById('location').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('uploadArea').classList.remove('has-file');
            selectedFile = null;
            selectedFileData = null;
            editMode = false;
            editingId = null;
            document.getElementById('saveBtn').textContent = 'üíæ Kaydet';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Pending OCR data'yƒ± temizle
            if (window.pendingOCRData) {
                console.log('üßπ clearForm: pendingOCRData temizlendi');
                window.pendingOCRData = null;
            }
            
            // lastOCRMaterialCode'u temizle (yeni sorgu ba≈ülƒ±yor)
            if (lastOCRMaterialCode) {
                console.log('üßπ clearForm: lastOCRMaterialCode temizlendi:', lastOCRMaterialCode);
                lastOCRMaterialCode = null;
            }
            
            // TDS'teki t√ºm COA deƒüerlerini temizle (yeni sorgu)
            Object.keys(tdsData).forEach(materialCode => {
                if (tdsData[materialCode] && tdsData[materialCode].properties) {
                    tdsData[materialCode].properties.forEach(prop => {
                        delete prop.coaValue;
                        delete prop.coaCompliance;
                    });
                }
            });
            localStorage.setItem('tdsData', JSON.stringify(tdsData));
            console.log('üßπ clearForm: T√ºm TDS COA deƒüerleri temizlendi');
        }
        
        function editCOA(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±!', 'error');
                return;
            }
            
            // Forma verileri doldur
            document.getElementById('supplierInput').value = record.supplier || '';
            document.getElementById('materialCode').value = record.materialCode || '';
            // Tarih formatƒ±nƒ± d√ºzelt (YYYY-MM-DD)
            const deliveryDate = record.deliveryDate || '';
            document.getElementById('deliveryDate').value = deliveryDate.split('T')[0];
            document.getElementById('deliveryNo').value = record.deliveryNo || '';
            document.getElementById('lotNumber').value = record.lotNumber || '';
            document.getElementById('location').value = record.location || '';
            document.getElementById('notes').value = record.notes || '';
            
            // Mevcut dosya √∂nizlemesi
            if (record.fileData) {
                const preview = document.getElementById('filePreview');
                // T√ºm dosyalar i√ßin ikon g√∂ster
                const fileIconHtml = getFileIcon(record.fileName, record.fileType, record.id);
                preview.innerHTML = fileIconHtml + '<p style="margin-top: 10px; color: #666;">Mevcut dosya: ' + record.fileName + '</p><p style="font-size: 0.9em; color: #999;">Yeni dosya y√ºklerseniz deƒüi≈ütirilir</p>';
                document.getElementById('uploadArea').classList.add('has-file');
            }
            
            // Edit mode'a ge√ß
            editMode = true;
            editingId = id;
            document.getElementById('saveBtn').textContent = '‚úèÔ∏è G√ºncelle';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Forma scroll
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            showToast('üìù D√ºzenleme modu aktif', 'info');
        }
        
        function cancelEdit() {
            clearForm();
            showToast('‚ùå D√ºzenleme iptal edildi', 'info');
        }
        
        // ==================== Bulk Upload Operations ====================
        let bulkFiles = [];
        let bulkUploadCancelled = false;
        
        // Excel'den y√ºklenen verilerden irsaliye numarasƒ±nƒ± bul
        function getDeliveryNoFromExcel(materialCode, deliveryDate) {
            // materialCode ve deliveryDate'e g√∂re Excel verilerinde arama yap
            const material = materials.find(m => m.code === materialCode);
            
            if (!material || !material.deliveries || material.deliveries.length === 0) {
                console.warn(`‚ö†Ô∏è ${materialCode} i√ßin Excel'de irsaliye verisi bulunamadƒ±`);
                return [];
            }
            
            // Tarihi DD.MM.YYYY formatƒ±na √ßevir (Excel'deki format)
            const [year, month, day] = deliveryDate.split('-');
            const searchDate = `${day}.${month}.${year}`;
            
            // Aynƒ± tarihe sahip T√úM delivery'leri bul
            const deliveries = material.deliveries.filter(d => d.date === searchDate);
            
            if (deliveries.length > 0) {
                // Her irsaliye i√ßin numaralarƒ±nƒ± olu≈ütur (Seri | No formatƒ±nda)
                const deliveryNumbers = deliveries.map(delivery => {
                    let deliveryNo = '';
                    if (delivery.serie && delivery.no) {
                        deliveryNo = `${delivery.serie} | ${delivery.no}`;
                    } else if (delivery.no) {
                        deliveryNo = delivery.no;
                    } else if (delivery.serie) {
                        deliveryNo = delivery.serie;
                    }
                    return deliveryNo;
                }).filter(no => no !== ''); // Bo≈ü olanlarƒ± filtrele
                
                console.log(`‚úÖ ${materialCode} - ${searchDate} i√ßin ${deliveryNumbers.length} irsaliye bulundu:`, deliveryNumbers);
                return deliveryNumbers;
            }
            
            console.warn(`‚ö†Ô∏è ${materialCode} i√ßin ${searchDate} tarihinde irsaliye bulunamadƒ±`);
            return [];
        }
        
        function toggleBulkUploadSection() {
            const section = document.getElementById('bulkUploadSection');
            const supplier = document.getElementById('supplierInput').value.trim();
            
            if (section.style.display === 'none') {
                // Tedarik√ßi kontrol√º
                if (!supplier) {
                    showToast('‚ùå √ñnce yukarƒ±daki formda tedarik√ßi se√ßin!', 'error');
                    return;
                }
                
                // Excel y√ºkl√º m√º kontrol√º
                if (!materials || materials.length === 0) {
                    showToast('‚ö†Ô∏è √ñnce Excel dosyasƒ± y√ºkleyin! (Tedarik√ßi ve hammadde bilgileri i√ßin)', 'warning');
                    return;
                }
                
                // Excel'de irsaliye bilgileri var mƒ± kontrol√º
                const hasDeliveries = materials.some(m => m.deliveries && m.deliveries.length > 0);
                if (!hasDeliveries) {
                    showToast('‚ö†Ô∏è Excel\'de irsaliye bilgileri bulunamadƒ±! L√ºtfen irsaliye tarihi ve numarasƒ± i√ßeren bir Excel y√ºkleyin.', 'warning');
                    return;
                }
                
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
                clearBulkUpload();
            }
        }
        
        // Bulk upload i√ßin basit emoji d√∂nd√ºr (sadece emoji, HTML div deƒüil)
        function getFileIconSimple(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'ÔøΩ',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'gif': 'üéûÔ∏è',
                'bmp': 'üñºÔ∏è',
                'webp': 'üñºÔ∏è',
                'xlsx': 'üìä',
                'xls': 'üìä',
                'docx': 'üìù',
                'doc': 'üìù',
                'txt': 'üìã'
            };
            return icons[ext] || 'üìé';
        }
        
        // UYARI: Bu fonksiyon Bƒ∞Rƒ∞NCƒ∞ getFileIcon() (line ~2000) √ºzerine yazƒ±yor!
        // Bulk upload i√ßin basit wrapper - ger√ßek fonksiyonu kullan
        // Artƒ±k HTML div d√∂nd√ºrmek yerine sadece bu fonksiyonu silelim
        // √ß√ºnk√º JavaScript'te son tanƒ±m √∂ncekini ezer!
        
        function handleBulkFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Ana formdan tedarik√ßi bilgisini al
            const supplier = document.getElementById('supplierInput').value.trim();
            if (!supplier) {
                showToast('‚ùå √ñnce yukarƒ±daki formda tedarik√ßi se√ßin!', 'error');
                e.target.value = '';
                return;
            }
            
            // Parse file names and add to bulk array
            files.forEach(file => {
                // Dosya tipi kontrol√º
                const ext = file.name.split('.').pop().toLowerCase();
                const allowedTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'xlsx', 'xls', 'docx', 'doc'];
                
                if (!allowedTypes.includes(ext)) {
                    showToast(`‚ö†Ô∏è Desteklenmeyen dosya tipi: ${file.name}`, 'warning');
                    return;
                }
                
                // Expected format: [MaterialCode] - [DD.MM.YYYY].extension
                const match = file.name.match(/^(.+?)\s*-\s*(\d{2})\.(\d{2})\.(\d{4})/);
                
                if (match) {
                    const materialCode = match[1].trim();
                    const day = match[2];
                    const month = match[3];
                    const year = match[4];
                    
                    // Convert to YYYY-MM-DD format for internal use
                    const deliveryDate = `${year}-${month}-${day}`;
                    
                    // Excel'den irsaliye numaralarƒ±nƒ± bul (array d√∂ner)
                    const deliveryNumbers = getDeliveryNoFromExcel(materialCode, deliveryDate);
                    
                    if (deliveryNumbers.length === 0) {
                        showToast(`‚ö†Ô∏è ${file.name}: Excel'de ${day}.${month}.${year} tarihi i√ßin irsaliye bulunamadƒ±!`, 'warning');
                        
                        // ƒ∞rsaliye bulunamadƒ±ysa tek bir BULUNAMADI kaydƒ± olu≈ütur
                        const fileObj = {
                            id: Date.now() + Math.random(),
                            file: file,
                            materialCode: materialCode,
                            deliveryDate: deliveryDate,
                            deliveryNo: 'BULUNAMADI',
                            supplier: supplier,
                            fileType: ext
                        };
                        bulkFiles.push(fileObj);
                    } else {
                        // Her irsaliye numarasƒ± i√ßin ayrƒ± bir kayƒ±t olu≈ütur
                        deliveryNumbers.forEach((deliveryNo, index) => {
                            const fileObj = {
                                id: Date.now() + Math.random() + index,
                                file: file,
                                materialCode: materialCode,
                                deliveryDate: deliveryDate,
                                deliveryNo: deliveryNo,
                                supplier: supplier,
                                fileType: ext,
                                isMultiple: deliveryNumbers.length > 1, // Birden fazla irsaliye var mƒ±?
                                multipleIndex: index + 1, // Ka√ßƒ±ncƒ± irsaliye?
                                multipleTotal: deliveryNumbers.length // Toplam ka√ß irsaliye?
                            };
                            bulkFiles.push(fileObj);
                        });
                        
                        if (deliveryNumbers.length > 1) {
                            console.log(`üì¶ ${file.name}: ${deliveryNumbers.length} adet irsaliye i√ßin ayrƒ± kayƒ±t olu≈üturuldu`);
                        }
                    }
                } else {
                    showToast(`‚ö†Ô∏è Hatalƒ± dosya adƒ± formatƒ±: ${file.name}`, 'warning');
                }
            });
            
            renderBulkFiles();
            e.target.value = '';
        }
        
        function renderBulkFiles() {
            const container = document.getElementById('bulkFilesContainer');
            const listSection = document.getElementById('bulkFilesList');
            const summary = document.getElementById('bulkSummary');
            const summaryText = document.getElementById('bulkSummaryText');
            
            if (bulkFiles.length === 0) {
                listSection.style.display = 'none';
                summary.style.display = 'none';
                return;
            }
            
            listSection.style.display = 'block';
            summary.style.display = 'block';
            
            // ƒ∞rsaliye bulunamayan dosya sayƒ±sƒ±nƒ± kontrol et
            const missingDeliveryCount = bulkFiles.filter(f => f.deliveryNo === 'BULUNAMADI').length;
            
            // Benzersiz dosya sayƒ±sƒ±nƒ± hesapla (aynƒ± dosyanƒ±n farklƒ± irsaliyeleri i√ßin)
            const uniqueFiles = new Set(bulkFiles.map(f => f.file.name));
            const uniqueFileCount = uniqueFiles.size;
            
            // Birden fazla irsaliye olan dosya sayƒ±sƒ±
            const multipleDeliveryCount = bulkFiles.filter(f => f.isMultiple).length;
            
            let summaryHTML = `${bulkFiles.length} COA kaydƒ± y√ºklenmeye hazƒ±r`;
            
            // Benzersiz dosya sayƒ±sƒ± farklƒ±ysa g√∂ster
            if (uniqueFileCount !== bulkFiles.length) {
                summaryHTML += ` <span style="color: #28a745; font-weight: 600;">(${uniqueFileCount} benzersiz dosya)</span>`;
            }
            
            if (missingDeliveryCount > 0) {
                summaryHTML += ` <span style="color: #dc3545; font-weight: 600;">(‚ö†Ô∏è ${missingDeliveryCount} adet i√ßin irsaliye no bulunamadƒ±)</span>`;
            } else {
                summaryHTML += ` ‚úÖ`;
            }
            
            summaryText.innerHTML = summaryHTML;
            
            container.innerHTML = bulkFiles.map(fileObj => {
                // Convert YYYY-MM-DD to DD.MM.YYYY for display
                const [year, month, day] = fileObj.deliveryDate.split('-');
                const displayDate = `${day}.${month}.${year}`;
                
                // ƒ∞rsaliye bulunamadƒ±ysa farklƒ± stil
                const isMissing = fileObj.deliveryNo === 'BULUNAMADI';
                const borderColor = isMissing ? '#dc3545' : (fileObj.isMultiple ? '#28a745' : '#dee2e6');
                const bgColor = isMissing ? '#fff5f5' : (fileObj.isMultiple ? '#f0fff4' : 'white');
                const deliveryStyle = isMissing ? 'color: #dc3545; font-weight: 600;' : (fileObj.isMultiple ? 'color: #28a745; font-weight: 600;' : '');
                
                // Dosya tipine g√∂re ikon (bulk upload i√ßin sadece emoji)
                const fileIcon = getFileIconSimple(fileObj.file.name);
                
                // Birden fazla irsaliye varsa g√∂ster
                const multipleIndicator = fileObj.isMultiple ? ` <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em;">(${fileObj.multipleIndex}/${fileObj.multipleTotal})</span>` : '';
                
                return `
                <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #495057; margin-bottom: 4px;">${fileIcon} ${fileObj.file.name}${fileObj.isMultiple ? ' <span style="color: #28a745;">üìã √ó' + fileObj.multipleTotal + '</span>' : ''}</div>
                        <div style="font-size: 0.85em; color: #666; display: flex; gap: 15px; flex-wrap: wrap;">
                            <span><strong>Hammadde:</strong> ${fileObj.materialCode}</span>
                            <span><strong>ƒ∞rsaliye Tarihi:</strong> ${displayDate}</span>
                            <span style="${deliveryStyle}"><strong>ƒ∞rsaliye No:</strong> ${isMissing ? '‚ö†Ô∏è ' : ''}${fileObj.deliveryNo}${multipleIndicator}</span>
                        </div>
                        ${isMissing ? '<div style="font-size: 0.75em; color: #dc3545; margin-top: 4px;">‚ö†Ô∏è Excel\'de bu tarih i√ßin irsaliye kaydƒ± bulunamadƒ±!</div>' : ''}
                        ${fileObj.isMultiple ? '<div style="font-size: 0.75em; color: #28a745; margin-top: 4px;">‚úÖ Aynƒ± tarihte birden fazla irsaliye var - Her biri ayrƒ± satƒ±r olarak kaydedilecek</div>' : ''}
                    </div>
                    <button onclick="removeBulkFile('${fileObj.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                        üóëÔ∏è Sil
                    </button>
                </div>
            `;
            }).join('');
        }
        
        function removeBulkFile(id) {
            bulkFiles = bulkFiles.filter(f => f.id != id);
            renderBulkFiles();
        }
        
        function clearBulkUpload() {
            bulkFiles = [];
            bulkUploadCancelled = false; // ƒ∞ptal durumunu sƒ±fƒ±rla
            document.getElementById('bulkFileInput').value = '';
            renderBulkFiles();
        }
        
        function cancelBulkUpload() {
            if (confirm('‚ö†Ô∏è Y√ºkleme i≈ülemini iptal etmek istediƒüinizden emin misiniz?')) {
                bulkUploadCancelled = true;
                showToast('‚ö†Ô∏è ƒ∞≈ülem iptal ediliyor...', 'warning');
            }
        }
        
        // Kalan s√ºreyi formatla (saniye -> "2dk 30sn" formatƒ±)
        function formatRemainingTime(seconds) {
            if (seconds < 60) {
                return Math.round(seconds) + 'sn';
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return secs > 0 ? `${minutes}dk ${secs}sn` : `${minutes}dk`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return minutes > 0 ? `${hours}sa ${minutes}dk` : `${hours}sa`;
            }
        }
        
        // Excel'de kayƒ±tlƒ± ama COA'sƒ± olmayan irsaliyeleri kontrol et (Bulk upload sonrasƒ±)
        // Excel'de kayƒ±tlƒ± ama COA'sƒ± olmayan irsaliyeleri kontrol et (Bulk upload sonrasƒ±)
        function checkMissingCOAs() {
            try {
                const missingCOAs = [];
                let totalDeliveries = 0;
                
                // Excel'deki t√ºm hammaddelerin t√ºm irsaliyelerini kontrol et
                materials.forEach(material => {
                    const materialCode = material.materialCode || material.code;
                    
                    if (material.deliveries && Array.isArray(material.deliveries)) {
                        material.deliveries.forEach(delivery => {
                            totalDeliveries++;
                            
                            // ƒ∞rsaliye numarasƒ±nƒ± olu≈ütur
                            const deliveryStr = delivery.deliverySerial && delivery.deliveryNo 
                                ? `${delivery.deliverySerial} | ${delivery.deliveryNo}` 
                                : (delivery.deliverySerial || delivery.deliveryNo || '');
                            
                            if (!deliveryStr) return; // ƒ∞rsaliye numarasƒ± yoksa atla
                            
                            // Bu irsaliye i√ßin COA var mƒ± kontrol et (coaData'da)
                            const hasCOA = coaData.some(coa => {
                                // COA'nƒ±n irsaliye numarasƒ±nƒ± al (string veya array olabilir)
                                const coaDeliveries = Array.isArray(coa.deliveryNo) ? coa.deliveryNo : [coa.deliveryNo];
                                return coaDeliveries.includes(deliveryStr) && 
                                       (coa.materialCode === materialCode || coa.material === materialCode);
                            });
                            
                            // COA yoksa listeye ekle
                            if (!hasCOA) {
                                missingCOAs.push(deliveryStr);
                            }
                        });
                    }
                });
                
                const uploadedCount = totalDeliveries - missingCOAs.length;
                
                // Durum raporunu g√∂ster
                if (missingCOAs.length > 0) {
                    console.log(`üìä COA Durumu: ${uploadedCount}/${totalDeliveries} y√ºkl√º, ${missingCOAs.length} eksik`);
                    
                    // 2 saniye sonra modal'ƒ± a√ß
                    setTimeout(() => {
                        showToast(`üìä ${uploadedCount}/${totalDeliveries} COA y√ºkl√º. Detaylƒ± rapor a√ßƒ±lƒ±yor...`, 'info', 3000);
                        setTimeout(() => {
                            openMissingCOAModal();
                        }, 500);
                    }, 2000);
                } else {
                    console.log('‚úÖ T√ºm Excel irsaliyeleri i√ßin COA mevcut!');
                    setTimeout(() => {
                        showToast(`‚úÖ Harika! T√ºm ${totalDeliveries} irsaliye i√ßin COA y√ºkl√º!`, 'success', 3000);
                    }, 1000);
                }
            } catch (error) {
                console.error('‚ùå COA durum kontrol√º hatasƒ±:', error);
            }
        }
        
        async function saveBulkCOAs() {
            // ƒ∞ptal flag'ini sƒ±fƒ±rla
            bulkUploadCancelled = false;
            
            // Batch COA_Records kayƒ±tlarƒ± i√ßin array
            const batchCOARecords = [];
            
            // Ana formdan tedarik√ßi bilgisini al
            const supplier = document.getElementById('supplierInput').value.trim();
            
            if (!supplier) {
                showToast('‚ùå √ñnce yukarƒ±daki formda tedarik√ßi se√ßin!', 'error');
                return;
            }
            
            if (bulkFiles.length === 0) {
                showToast('‚ùå Dosya y√ºkleyin!', 'error');
                return;
            }
            
            if (!googleScriptUrl) {
                showToast('‚ùå Google Sheets baƒülantƒ±sƒ± yapƒ±lmamƒ±≈ü!', 'error');
                return;
            }
            
            // ƒ∞rsaliye numarasƒ± bulunamayan dosyalarƒ± kontrol et
            const missingDeliveries = bulkFiles.filter(f => f.deliveryNo === 'BULUNAMADI');
            
            // Sadece dosya adƒ±ndan irsaliye alƒ±namayanlarƒ± uyar
            if (missingDeliveries.length > 0) {
                const fileNames = missingDeliveries.map(f => f.file.name).join('\\n  - ');
                const warningMsg = `üìã ƒ∞rsaliye Numarasƒ± Bulunamadƒ± (${missingDeliveries.length} dosya):\\n  - ${fileNames}\\n\\nYine de devam etmek istiyor musunuz?`;
                if (!confirm(warningMsg)) {
                    return;
                }
            }
            
            // Progress bar g√∂ster
            const progressContainer = document.getElementById('bulkUploadProgress');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressTitle = document.getElementById('bulkProgressTitle');
            const currentFileSpan = document.getElementById('bulkCurrentFile');
            const successCountSpan = document.getElementById('bulkSuccessCount');
            const errorCountSpan = document.getElementById('bulkErrorCount');
            const totalCountSpan = document.getElementById('bulkTotalCount');
            
            progressContainer.style.display = 'block';
            totalCountSpan.textContent = bulkFiles.length;
            
            let successCount = 0;
            let errorCount = 0;
            
            // S√ºre tahmini i√ßin deƒüi≈ükenler
            const fileTimes = []; // Her dosyanƒ±n i≈ülem s√ºresi
            let fileStartTime = null;
            
            // Her dosyayƒ± sƒ±rayla i≈üle (manuel kayƒ±t mantƒ±ƒüƒ± ile)
            for (let i = 0; i < bulkFiles.length; i++) {
                // ƒ∞ptal kontrol√º
                if (bulkUploadCancelled) {
                    console.log('‚ö†Ô∏è ƒ∞≈ülem kullanƒ±cƒ± tarafƒ±ndan iptal edildi');
                    progressTitle.textContent = 'üõë ƒ∞ptal Edildi';
                    showToast(`‚ö†Ô∏è ƒ∞≈ülem iptal edildi. ${successCount} COA kaydedildi, ${bulkFiles.length - i} atlandƒ±.`, 'warning', 5000);
                    
                    // Ba≈üarƒ±lƒ± kayƒ±tlarƒ± localStorage'a kaydet
                    if (successCount > 0) {
                        saveToLocalStorage();
                        renderTable();
                    }
                    
                    // Progress bar'ƒ± gizle ve temizle
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        clearBulkUpload();
                    }, 3000);
                    
                    return; // Fonksiyondan tamamen √ßƒ±k
                }
                
                const fileObj = bulkFiles[i];
                const fileNumber = i + 1;
                
                try {
                    // Dosya ba≈ülangƒ±√ß zamanƒ±nƒ± kaydet
                    fileStartTime = Date.now();
                    
                    // Progress g√ºncelle
                    const displayFileName = fileObj.isMultiple 
                        ? `${fileObj.file.name} [ƒ∞rsaliye ${fileObj.multipleIndex}/${fileObj.multipleTotal}]`
                        : fileObj.file.name;
                    
                    const progressPercent = Math.round((i / bulkFiles.length) * 100);
                    progressBar.style.width = progressPercent + '%';
                    
                    // Tahmini kalan s√ºreyi hesapla
                    let timeEstimate = '';
                    if (fileTimes.length > 0) {
                        const avgTime = fileTimes.reduce((a, b) => a + b, 0) / fileTimes.length;
                        const remainingFiles = bulkFiles.length - i;
                        const estimatedSeconds = (avgTime * remainingFiles) / 1000;
                        timeEstimate = ` - ~${formatRemainingTime(estimatedSeconds)} kaldƒ±`;
                    }
                    
                    progressTitle.textContent = `Dosya ${fileNumber}/${bulkFiles.length} i≈üleniyor... (${progressPercent}%${timeEstimate})`;
                    currentFileSpan.textContent = displayFileName;
                    
                    console.log(`üìÑ [${fileNumber}/${bulkFiles.length}] ƒ∞≈üleniyor: ${displayFileName}`);
                    
                    // Convert file to base64
                    const fileData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(fileObj.file);
                    });
                    
                    // 1. ADIM: Drive'a dosyayƒ± y√ºkle (manuel kayƒ±t mantƒ±ƒüƒ±)
                    progressTitle.textContent = `‚òÅÔ∏è Drive'a y√ºkleniyor... (${fileNumber}/${bulkFiles.length})`;
                    console.log('‚òÅÔ∏è Drive y√ºkleme ba≈ülatƒ±lƒ±yor...');
                    
                    const compressedData = await compressForSheets(fileData, 200);
                    console.log('üì¶ Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü boyut:', Math.round(compressedData.length / 1024), 'KB');
                    
                    const uploadResult = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.timeout = 120000; // 120 saniye
                        
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                try {
                                    resolve(JSON.parse(xhr.responseText));
                                } catch(e) {
                                    reject(new Error('JSON parse hatasƒ±'));
                                }
                            } else {
                                reject(new Error('HTTP ' + xhr.status));
                            }
                        };
                        
                        xhr.onerror = () => reject(new Error('Baƒülantƒ± hatasƒ±'));
                        xhr.ontimeout = () => reject(new Error('Zaman a≈üƒ±mƒ±'));
                        
                        xhr.open('POST', googleScriptUrl, true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        
                        const formData = new URLSearchParams();
                        formData.append('action', 'uploadFile');
                        formData.append('fileData', compressedData);
                        formData.append('fileName', fileObj.file.name);
                        formData.append('mimeType', fileObj.file.type || 'application/octet-stream');
                        
                        xhr.send(formData.toString());
                    });
                    
                    if (!uploadResult || !uploadResult.success) {
                        throw new Error('Drive y√ºkleme ba≈üarƒ±sƒ±z: ' + (uploadResult?.error || 'Bilinmeyen hata'));
                    }
                    
                    console.log('‚úÖ Drive y√ºkleme ba≈üarƒ±lƒ±:', uploadResult);
                    
                    // 2. ADIM: OCR ve TDS kar≈üƒ±la≈ütƒ±rmasƒ±
                    let ocrProperties = {};
                    const fileExt = fileObj.file.name.split('.').pop().toLowerCase();
                    const isImageOrPDF = ['pdf', 'jpg', 'jpeg', 'png', 'gif'].includes(fileExt);
                    const isExcelOrOffice = ['xlsx', 'xls', 'docx', 'doc'].includes(fileExt);
                    const isTemplateCompatible = ['pdf', 'xlsx', 'xls', 'docx', 'doc', 'jpg', 'jpeg', 'png'].includes(fileExt);
                    
                    // Template-based Extraction (PDF, Excel, Office, Image)
                    if (isTemplateCompatible) {
                        progressTitle.textContent = `üìä Template ile COA okunuyor... (${fileNumber}/${bulkFiles.length})`;
                        console.log('üìä Template ile deƒüerler √ßƒ±karƒ±lƒ±yor...');
                        
                        try {
                            // Tedarik√ßiye g√∂re template bul - Fuzzy matching ile
                            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
                            console.log('üîç Template arama:', fileObj.supplier, '| Mevcut template sayƒ±sƒ±:', templates.length);
                            
                            const matchedTemplate = templates.find(t => {
                                const templateSupplier = (t.supplier || t.template?.supplier || '').toLowerCase();
                                const fileSupplier = (fileObj.supplier || '').toLowerCase();
                                
                                console.log('  üîé Kontrol ediliyor:', templateSupplier, 'vs', fileSupplier);
                                
                                // 1. Tam e≈üle≈üme
                                if (templateSupplier === fileSupplier) {
                                    console.log('  ‚úÖ Tam e≈üle≈üme bulundu!');
                                    return true;
                                }
                                
                                // 2. Supplier adƒ±nƒ±n i√ßinde template adƒ± ge√ßiyorsa (veya tersi)
                                if (templateSupplier && fileSupplier) {
                                    // "berkosan", "yal", "tecrit" gibi anlamlƒ± kelimeler √ßƒ±kar
                                    const templateWords = templateSupplier.split(/[\s_.-]+/).filter(w => w.length > 3);
                                    const fileWords = fileSupplier.split(/[\s_.-]+/).filter(w => w.length > 3);
                                    
                                    // En az 1 ortak kelime varsa match et
                                    const commonWords = templateWords.filter(tw => 
                                        fileWords.some(fw => fw.includes(tw) || tw.includes(fw))
                                    );
                                    
                                    if (commonWords.length > 0) {
                                        console.log('  ‚úÖ Fuzzy match bulundu! Ortak kelimeler:', commonWords);
                                        return true;
                                    }
                                }
                                
                                return false;
                            });
                            
                            if (matchedTemplate) {
                                console.log('üé® Template bulundu:', matchedTemplate.supplier || matchedTemplate.template?.supplier);
                                const actualTemplate = matchedTemplate.template || matchedTemplate;
                                
                                // Template ile deƒüerleri √ßƒ±kar
                                const extractedProperties = await extractCOAPropertiesWithTemplate(fileData, actualTemplate);
                                console.log('‚úÖ Template extraction tamamlandƒ±:', Object.keys(extractedProperties).length, '√∂zellik');
                                
                                // TDS ile kar≈üƒ±la≈ütƒ±r
                                if (tdsData[fileObj.materialCode] && tdsData[fileObj.materialCode].properties) {
                                    console.log('üìä TDS kar≈üƒ±la≈ütƒ±rmasƒ± yapƒ±lƒ±yor...');
                                    const comparisonResults = await compareCOAValuesWithTDS(fileObj.materialCode, extractedProperties);
                                    
                                    console.log('üíæ TDS\'e kaydediliyor (toplu y√ºkleme)...');
                                    // TDS'e kaydet (tekli y√ºklemedeki gibi)
                                    await saveTDSPropertiesFromOCR(fileObj.materialCode, comparisonResults.properties);
                                    
                                    // ocrProperties formatƒ±na √ßevir (property adƒ± -> deƒüer+durum)
                                    if (comparisonResults && comparisonResults.properties) {
                                        Object.entries(comparisonResults.properties).forEach(([propName, propData]) => {
                                            ocrProperties[propName] = {
                                                tdsValue: propData.tdsValue || '',
                                                coaValue: propData.value || '',
                                                unit: propData.unit || '',
                                                status: propData.status || '-',
                                                method: propData.standard || '',
                                                lowerLimit: propData.lowerLimit || '',
                                                upperLimit: propData.upperLimit || '',
                                                standardValue: propData.standardValue || '',
                                                requirement: propData.requirement || ''
                                            };
                                        });
                                    }
                                    
                                    console.log('‚úÖ TDS kar≈üƒ±la≈ütƒ±rma ve kayƒ±t tamamlandƒ±:', Object.keys(ocrProperties).length, '√∂zellik');
                                } else {
                                    // TDS yoksa direkt extracted properties'i kullan
                                    console.log('‚ö†Ô∏è TDS yok, sadece extraction sonu√ßlarƒ± kaydediliyor');
                                    
                                    // TDS olmadan da tick/pass kontrol√º yap
                                    Object.entries(extractedProperties).forEach(([propName, propValue]) => {
                                        const cleanedValue = (propValue || '').toString().trim();
                                        
                                        // Tick i≈üareti veya pass/fail kontrol√º
                                        const hasTickMark = /[‚úì‚úî‚àö]/u.test(cleanedValue) || 
                                                           /\b(pass|ok|uygun|ge√ßti|ba≈üarƒ±lƒ±|conform)\b/i.test(cleanedValue);
                                        const hasFailMark = /[‚úó‚úò√ó]/u.test(cleanedValue) || 
                                                            /\b(fail|not ok|uygun deƒüil|ge√ßmedi|ba≈üarƒ±sƒ±z|non-conform)\b/i.test(cleanedValue);
                                        
                                        let status = '-';
                                        if (hasTickMark) {
                                            status = 'Uygun';
                                        } else if (hasFailMark) {
                                            status = 'Uygun Deƒüil';
                                        }
                                        
                                        ocrProperties[propName] = {
                                            tdsValue: '',
                                            coaValue: cleanedValue,
                                            unit: '',
                                            status: status,
                                            method: '',
                                            lowerLimit: '',
                                            upperLimit: '',
                                            standardValue: '',
                                            requirement: ''
                                        };
                                    });
                                    console.log('‚úÖ Extraction sonu√ßlarƒ± kaydedildi:', Object.keys(ocrProperties).length, '√∂zellik');
                                }
                            } else {
                                console.log('‚ö†Ô∏è Bu tedarik√ßi i√ßin template bulunamadƒ±:', fileObj.supplier);
                                showToast('‚ö†Ô∏è Template yok, COA deƒüerleri manuel girilmeli', 'warning', 3000);
                            }
                        } catch (extractError) {
                            console.error('‚ùå Template extraction hatasƒ±:', extractError);
                        }
                    }
                    
                    // 3. ADIM: COA kaydƒ±nƒ± olu≈ütur (manuel kayƒ±t yapƒ±sƒ±)
                    const record = {
                        id: 'coa_bulk_' + Date.now() + '_' + fileNumber,
                        supplier: fileObj.supplier,
                        materialCode: fileObj.materialCode,
                        deliveryDate: fileObj.deliveryDate,
                        deliveryNo: fileObj.deliveryNo,
                        lotNumber: `BULK-${Date.now()}-${fileNumber}`,
                        location: document.getElementById('location').value || '',
                        fileName: uploadResult.fileName,
                        fileType: fileObj.file.type,
                        fileData: fileData,
                        fileUrl: uploadResult.viewUrl,
                        driveFileId: uploadResult.fileId,
                        fileSize: uploadResult.fileSize,
                        notes: `Toplu y√ºkleme - ${new Date().toLocaleString('tr-TR')} - ${Object.keys(ocrProperties).length} √∂zellik OCR ile okundu`,
                        createdAt: new Date().toISOString()
                    };
                    
                    // OCR properties'i ekle (varsa)
                    if (Object.keys(ocrProperties).length > 0) {
                        record.ocrProperties = ocrProperties;
                    }
                    
                    // 4. ADIM: Google Sheets'e COA kaydƒ±nƒ± kaydet
                    progressTitle.textContent = `üíæ Sheets'e kaydediliyor... (${fileNumber}/${bulkFiles.length})`;
                    console.log('üíæ Sheets\'e COA kaydediliyor...');
                    
                    const saveSuccess = await saveToGoogleSheets(record);
                    if (!saveSuccess) {
                        throw new Error('Sheets kayƒ±t ba≈üarƒ±sƒ±z');
                    }
                    
                    console.log('‚úÖ Sheets kayƒ±t ba≈üarƒ±lƒ±');
                    
                    // 5. ADIM: COA_Records'a kaydet (TDS varsa)
                    const cleanMaterialCode = fileObj.materialCode.includes('|') 
                        ? fileObj.materialCode.split('|')[0].trim() 
                        : fileObj.materialCode.trim();
                    
                    console.log('üîë Clean Material Code for Records:', cleanMaterialCode);
                    
                    // TDS varsa COA_Records'a kaydet
                    let propertiesToSave = null;
                    
                    // OCR properties varsa TDS ile merge et
                    if (Object.keys(ocrProperties).length > 0 && tdsData[cleanMaterialCode]) {
                        console.log('üìä OCR verileri var, TDS ile merge ediliyor...');
                        propertiesToSave = tdsData[cleanMaterialCode].properties.map(prop => {
                            const ocrProp = ocrProperties[prop.name];
                            if (ocrProp) {
                                // OCR'dan deƒüer bulundu
                                return {
                                    ...prop,
                                    coaValue: ocrProp.coaValue || ocrProp.value || ocrProp,
                                    status: ocrProp.status || 'Uygun'
                                };
                            }
                            // OCR'da bu √∂zellik bulunamadƒ± - bo≈ü deƒüer ile kaydet
                            return {
                                ...prop,
                                coaValue: '',
                                status: '-'
                            };
                        });
                    } 
                    // TDS yok AMA OCR var -> direkt OCR sonu√ßlarƒ±nƒ± kaydet
                    else if (Object.keys(ocrProperties).length > 0) {
                        console.log('üìä TDS yok, sadece OCR verileri kaydediliyor...');
                        propertiesToSave = Object.entries(ocrProperties).map(([propName, propData]) => ({
                            name: propName,
                            coaValue: propData.coaValue || propData.value || propData,
                            status: propData.status || '-',
                            unit: '',
                            testStandard: '',
                            min: '',
                            max: ''
                        }));
                    }
                    // OCR yoksa ama TDS varsa sadece TDS'i kullan (bo≈ü COA deƒüerleriyle)
                    else if (tdsData[cleanMaterialCode]) {
                        console.log('üìä OCR yok, TDS verileri kullanƒ±lƒ±yor');
                        propertiesToSave = tdsData[cleanMaterialCode].properties.map(prop => ({
                            ...prop,
                            coaValue: '',
                            status: '-'
                        }));
                    }
                    
                    if (propertiesToSave) {
                        console.log('ÔøΩ Batch\'e ekleniyor...', propertiesToSave.length, '√∂zellik');
                        
                        // Record data objesini olu≈ütur
                        const recordDataForSheets = {
                            deliveryDate: fileObj.deliveryDate,
                            deliveryNo: fileObj.deliveryNo,
                            lotNumber: record.lotNumber,
                            supplier: fileObj.supplier,
                            location: record.location
                        };
                        
                        // ‚úÖ Batch array'ine ekle (hemen kaydetme, sonra topluca g√∂nder)
                        batchCOARecords.push({
                            materialCode: cleanMaterialCode,
                            properties: propertiesToSave,
                            recordData: recordDataForSheets
                        });
                        
                        console.log(`üì¶ Batch'e eklendi (toplam: ${batchCOARecords.length})`);
                    } else {
                        console.log('‚ö†Ô∏è TDS tanƒ±mlƒ± deƒüil:', cleanMaterialCode);
                    }
                    
                    // Memory'e ekle
                    coaData.unshift(record);
                    
                    // Dosya i≈ülem s√ºresini kaydet
                    if (fileStartTime) {
                        const duration = Date.now() - fileStartTime;
                        fileTimes.push(duration);
                    }
                    
                    successCount++;
                    successCountSpan.textContent = successCount;
                    console.log(`‚úÖ [${fileNumber}/${bulkFiles.length}] Tamamlandƒ±: ${fileObj.file.name}`);
                    
                } catch (error) {
                    console.error(`‚ùå [${fileNumber}/${bulkFiles.length}] Hata:`, fileObj.file.name, error);
                    errorCount++;
                    errorCountSpan.textContent = errorCount;
                }
                
                // Google Sheets'i rahatlatmak i√ßin her dosya arasƒ±nda kƒ±sa bekleme
                // (Son dosya deƒüilse ve iptal edilmediyse)
                if (i < bulkFiles.length - 1 && !bulkUploadCancelled) {
                    await new Promise(resolve => setTimeout(resolve, 1500)); // 1.5 saniye bekle
                }
            }
            
            // Progress bar tamamlandƒ±
            progressBar.style.width = '100%';
            progressTitle.textContent = '‚úÖ Dosyalar y√ºklendi, COA_Records kaydediliyor...';
            
            // ‚úÖ Batch COA_Records kayƒ±tlarƒ±nƒ± toplu olarak g√∂nder
            if (batchCOARecords.length > 0 && !bulkUploadCancelled) {
                console.log('');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log(`üìä BATCH COA_RECORDS KAYDI BA≈ûLIYOR: ${batchCOARecords.length} kayƒ±t`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                let batchSaveSuccess = 0;
                let batchSaveError = 0;
                
                // Her kayƒ±t i√ßin sƒ±rayla g√∂nder (rate limit korumasƒ±)
                for (let i = 0; i < batchCOARecords.length; i++) {
                    const batchItem = batchCOARecords[i];
                    
                    try {
                        progressTitle.textContent = `üìä COA_Records kaydediliyor... (${i + 1}/${batchCOARecords.length})`;
                        
                        console.log(`üìä [${i + 1}/${batchCOARecords.length}] Kaydediliyor: ${batchItem.materialCode} (${batchItem.properties.length} √∂zellik)`);
                        
                        await saveCOARecordToSheets(
                            batchItem.materialCode, 
                            batchItem.properties, 
                            batchItem.recordData
                        );
                        
                        batchSaveSuccess++;
                        console.log(`‚úÖ [${i + 1}/${batchCOARecords.length}] Kaydedildi: ${batchItem.materialCode}`);
                        
                        // Rate limit korumasƒ±: Her kayƒ±t arasƒ±nda 300ms bekle
                        if (i < batchCOARecords.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                        
                    } catch (error) {
                        batchSaveError++;
                        console.error(`‚ùå [${i + 1}/${batchCOARecords.length}] Hata: ${batchItem.materialCode}`, error);
                    }
                }
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log(`‚úÖ BATCH KAYIT TAMAMLANDI: ${batchSaveSuccess} ba≈üarƒ±lƒ±, ${batchSaveError} hata`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('');
                
                if (batchSaveSuccess > 0) {
                    showToast(`‚úÖ ${batchSaveSuccess} COA_Records kaydƒ± tamamlandƒ±`, 'success', 4000);
                }
                
                if (batchSaveError > 0) {
                    showToast(`‚ö†Ô∏è ${batchSaveError} COA_Records kaydedilemedi`, 'warning', 4000);
                }
            }
            
            progressTitle.textContent = '‚úÖ Tamamlandƒ±!';
            
            // Update UI
            if (successCount > 0) {
                saveToLocalStorage(); // Toplu y√ºkleme sonrasƒ± yedekle
                
                showToast(`‚úÖ ${successCount} COA ba≈üarƒ±yla kaydedildi!`, 'success', 5000);
                renderTable();
            }
            
            if (errorCount > 0) {
                showToast(`‚ö†Ô∏è ${errorCount} COA kaydedilemedi!`, 'warning', 5000);
            }
            
            // Eksik COA kontrol√º yap ve rapor g√∂ster
            checkMissingCOAs();
            
            // 3 saniye sonra progress bar'ƒ± gizle ve bulk upload'ƒ± temizle
            setTimeout(() => {
                progressContainer.style.display = 'none';
                clearBulkUpload();
            }, 3000);
        }
        
        // OCR metnini TDS ile kar≈üƒ±la≈ütƒ±r
        async function matchOCRTextWithTDS(ocrText, materialCode) {
            const properties = {};
            
            if (!tdsData[materialCode] || !Array.isArray(tdsData[materialCode].properties)) {
                return properties;
            }
            
            const tdsProperties = tdsData[materialCode].properties;
            
            // Her TDS √∂zelliƒüi i√ßin metinde ara
            for (const prop of tdsProperties) {
                if (!prop.name) continue;
                
                // √ñzellik adƒ±ndan sonra gelen sayƒ±yƒ± bul
                const regex = new RegExp(prop.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '[\\s:]*([0-9.,]+)', 'i');
                const match = ocrText.match(regex);
                
                if (match && match[1]) {
                    const value = match[1].trim();
                    properties[prop.name] = {
                        value: value,
                        status: 'uygun', // Basit durum, ger√ßek kar≈üƒ±la≈ütƒ±rma yapƒ±labilir
                        reason: 'OCR ile okundu'
                    };
                }
            }
            
            return properties;
        }
        
        function toggleRowSelection(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateBulkActions();
        }
        
        function toggleSelectAll() {
            const filtered = getFilteredData();
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            if (headerCheckbox.checked) {
                // T√ºm√ºn√º se√ß
                filtered.forEach(c => selectedItems.add(c.id));
            } else {
                // T√ºm√ºn√º kaldƒ±r
                filtered.forEach(c => selectedItems.delete(c.id));
            }
            
            renderTable();
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const count = selectedItems.size;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            countSpan.textContent = count;
            
            if (count > 0) {
                deleteBtn.style.display = 'inline-block';
            } else {
                deleteBtn.style.display = 'none';
            }
            
            // Header checkbox durumu
            if (headerCheckbox) {
                const filtered = getFilteredData();
                const allSelected = filtered.length > 0 && filtered.every(c => selectedItems.has(c.id));
                headerCheckbox.checked = allSelected;
            }
        }
        
        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showToast('‚ùå Silinecek kayƒ±t se√ßin!', 'error');
                return;
            }
            
            if (!confirm(`${selectedItems.size} adet kaydƒ± silmek istediƒüinizden emin misiniz?\n\nSheet kayƒ±tlarƒ± VE Drive dosyalarƒ± silinecek!`)) {
                return;
            }
            
            const idsToDelete = Array.from(selectedItems);
            let successCount = 0;
            let driveDeletedCount = 0;
            let driveErrorCount = 0;
            
            for (const id of idsToDelete) {
                const record = coaData.find(c => c.id === id);
                
                if (googleScriptUrl) {
                    // Drive'daki dosyayƒ± sil (driveFileId varsa)
                    if (record && record.driveFileId) {
                        console.log(`üóëÔ∏è [${successCount + 1}/${idsToDelete.length}] Drive dosyasƒ± siliniyor:`, record.driveFileId);
                        try {
                            const deleteResult = await jsonpRequest(googleScriptUrl, { 
                                action: 'deleteDriveFile',
                                fileId: record.driveFileId
                            });
                            
                            if (deleteResult.success) {
                                console.log('‚úÖ Drive silme ba≈üarƒ±lƒ±:', record.fileName);
                                driveDeletedCount++;
                            } else {
                                console.warn('‚ö†Ô∏è Drive dosyasƒ± silinemedi:', deleteResult.error);
                                driveErrorCount++;
                            }
                        } catch(driveError) {
                            console.error('‚ùå Drive silme hatasƒ±:', driveError);
                            driveErrorCount++;
                        }
                    }
                    
                    // COA Ar≈üiv'den sil
                    await deleteFromGoogleSheets(id);
                    
                    // COA_Records'dan da sil (materyal kodu, tarih ve irsaliye no ile)
                    if (record) {
                        const cleanMaterialCode = record.materialCode.includes('|') 
                            ? record.materialCode.split('|')[0].trim() 
                            : record.materialCode.trim();
                        
                        await deleteCOARecordFromSheets(
                            cleanMaterialCode,
                            record.deliveryDate,
                            record.deliveryNo
                        );
                    }
                }
                
                coaData = coaData.filter(c => c.id !== id);
                selectedItems.delete(id);
                successCount++;
            }
            
            saveToLocalStorage(); // Toplu silme sonrasƒ± yedekle
            updateUI();
            
            // Detaylƒ± sonu√ß mesajƒ±
            let message = `‚úÖ ${successCount} kayƒ±t silindi!`;
            if (driveDeletedCount > 0) {
                message += ` (${driveDeletedCount} Drive dosyasƒ± silindi)`;
            }
            if (driveErrorCount > 0) {
                message = `‚ö†Ô∏è ${successCount} kayƒ±t silindi, ancak ${driveErrorCount} Drive dosyasƒ± silinemedi`;
            }
            
            showToast(message, driveErrorCount > 0 ? 'warning' : 'success', 5000);
        }
        
        async function deleteCOA(id) {
            if (!confirm('Bu sertifikayƒ± silmek istediƒüinizden emin misiniz?\n\nSheet kayƒ±tlarƒ± VE Drive\'daki dosya silinecek!')) return;
            
            const record = coaData.find(c => c.id === id);
            
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            console.log('üóëÔ∏è Silme i≈ülemi ba≈ülatƒ±lƒ±yor:', {
                id: record.id,
                fileName: record.fileName,
                driveFileId: record.driveFileId,
                hasDriveFileId: !!record.driveFileId
            });
            
            let driveFileDeleted = false;
            let driveError = null;
            
            if (googleScriptUrl) {
                // Drive'daki dosyayƒ± sil (driveFileId varsa)
                if (record.driveFileId) {
                    console.log('üóëÔ∏è Drive dosyasƒ± siliniyor:', record.driveFileId);
                    try {
                        const deleteResult = await jsonpRequest(googleScriptUrl, { 
                            action: 'deleteDriveFile',
                            fileId: record.driveFileId
                        });
                        
                        console.log('üì¶ deleteDriveFile sonucu:', deleteResult);
                        
                        if (deleteResult.success) {
                            console.log('‚úÖ Drive silme ba≈üarƒ±lƒ±:', deleteResult);
                            
                            if (deleteResult.deletedFiles && deleteResult.deletedFiles.length > 0) {
                                console.log('üì¶ Silinen dosyalar:');
                                deleteResult.deletedFiles.forEach(f => {
                                    console.log(`  - ${f.location}: ${f.fileName}`);
                                });
                            }
                            
                            driveFileDeleted = true;
                        } else {
                            driveError = deleteResult.error || 'Drive silme ba≈üarƒ±sƒ±z';
                            console.warn('‚ö†Ô∏è Drive dosyasƒ± silinemedi:', driveError);
                        }
                    } catch(driveErr) {
                        driveError = driveErr.message || 'Drive silme hatasƒ±';
                        console.error('‚ùå Drive silme hatasƒ±:', driveErr);
                        // Devam et, sheet silme i≈ülemini engelleme
                    }
                } else {
                    console.log('‚ÑπÔ∏è Drive File ID bulunamadƒ±, dosya silme atlandƒ±');
                    driveError = 'Drive File ID bulunamadƒ±';
                }
                
                // COA Ar≈üiv'den sil
                await deleteFromGoogleSheets(id);
                
                // COA_Records'dan da sil (materyal kodu, tarih ve irsaliye no ile)
                const cleanMaterialCode = record.materialCode.includes('|') 
                    ? record.materialCode.split('|')[0].trim() 
                    : record.materialCode.trim();
                
                await deleteCOARecordFromSheets(
                    cleanMaterialCode,
                    record.deliveryDate,
                    record.deliveryNo || ''
                );
            }
            
            coaData = coaData.filter(c => c.id !== id);
            saveToLocalStorage(); // Silme sonrasƒ± yedekle
            updateUI();
            
            let message, toastType;
            if (driveFileDeleted) {
                message = '‚úÖ COA, kayƒ±tlar ve Drive dosyalarƒ± silindi!';
                toastType = 'success';
            } else if (driveError) {
                message = `‚ö†Ô∏è COA ve kayƒ±tlar silindi, ancak Drive dosyasƒ± silinemedi: ${driveError}`;
                toastType = 'warning';
            } else {
                message = '‚úÖ COA ve kayƒ±tlar silindi!';
                toastType = 'success';
            }
            showToast(message, toastType, 5000);
        }
        
        function viewFile(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            // PDF veya √ßok sayfalƒ± dok√ºmanlar i√ßin direkt Drive link kullan (useDirectDriveLink flag'i)
            if (record.useDirectDriveLink && record.fileUrl) {
                console.log('üìÑ PDF/√áok sayfalƒ± dok√ºman - Direkt Drive\'dan a√ßƒ±lƒ±yor (tam kalite)');
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            // √ñnce yerel dosya verisi kontrol et (localStorage'da) - tek sayfa i√ßin
            if (record.fileData) {
                if (record.fileType === 'application/pdf' || record.fileName?.endsWith('.pdf')) {
                    const pdfWindow = window.open();
                    pdfWindow.document.write(`
                        <html>
                        <head><title>${record.fileName || 'COA PDF'}</title></head>
                        <body style="margin:0;padding:0;">
                        <iframe src="${record.fileData}" style="width:100%;height:100%;border:none;"></iframe>
                        </body>
                        </html>
                    `);
                } else {
                    document.getElementById('modalImage').src = record.fileData;
                    document.getElementById('imageModal').classList.add('active');
                }
                return;
            }
            
            // URL varsa onu kullan
            if (record.fileUrl) {
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            showToast('‚ùå Dosya bulunamadƒ± - Bu kayƒ±t dosyasƒ±z veya dosya y√ºklenemedi', 'error');
        }
        
        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        function downloadFile(id) {
            const record = coaData.find(c => c.id === id);
            if (!record) {
                showToast('‚ùå Kayƒ±t bulunamadƒ±', 'error');
                return;
            }
            
            // √ñnce yerel dosya verisi kontrol et
            if (record.fileData) {
                const link = document.createElement('a');
                link.href = record.fileData;
                link.download = record.fileName || 'coa_file';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }
            
            // URL varsa yeni sekmede a√ß
            if (record.fileUrl) {
                window.open(record.fileUrl, '_blank');
                return;
            }
            
            showToast('‚ùå Dosya bulunamadƒ±', 'error');
        }
        
        // ==================== Excel Export ====================
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function exportToExcel() {
            if (coaData.length === 0) {
                showToast('‚ö†Ô∏è Dƒ±≈üa aktarƒ±lacak veri yok', 'warning');
                return;
            }
            
            showToast('üìä Excel olu≈üturuluyor...', 'info');
            
            // Filtrelenmi≈ü veriyi al
            const filteredData = getFilteredData();
            
            // Excel i√ßin veri hazƒ±rla
            const excelData = filteredData.map((record, index) => {
                // Tarihi formatla (T21:00:00.000Z kƒ±smƒ±nƒ± kaldƒ±r)
                let deliveryDate = record.deliveryDate || '';
                if (deliveryDate && deliveryDate.includes('T')) {
                    deliveryDate = deliveryDate.split('T')[0];
                }
                
                // Lot numarasƒ±nƒ± string olarak kaydet (E+12 notasyonunu √∂nle)
                let lotNumber = record.lotNumber || '';
                if (lotNumber) {
                    lotNumber = String(lotNumber);
                }
                
                return {
                    'Sƒ±ra': index + 1,
                    'Tedarik√ßi': record.supplier || '',
                    'Hammadde Kodu': record.materialCode || '',
                    'ƒ∞rsaliye Tarihi': deliveryDate,
                    'ƒ∞rsaliye No': record.deliveryNo || '',
                    'Parti/Lot No': lotNumber,
                    'Lokasyon': record.location || '',
                    'Dosya Adƒ±': record.fileName || '',
                    'Dosya Boyutu': record.fileSize ? formatFileSize(record.fileSize) : '',
                    'Eklenme Tarihi': record.timestamp ? new Date(record.timestamp).toLocaleDateString('tr-TR') : '',
                    'Drive Link': record.fileUrl || ''
                };
            });
            
            // Workbook olu≈ütur
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Parti/Lot No s√ºtununu text formatƒ±nda zorla (√ºstel notasyonu √∂nle)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const cellAddress = XLSX.utils.encode_cell({ r: row, c: 5 }); // 5. s√ºtun = Parti/Lot No
                if (ws[cellAddress]) {
                    ws[cellAddress].t = 's'; // String olarak i≈üaretle
                    ws[cellAddress].z = '@'; // Text format
                }
            }
            
            // S√ºtun geni≈üliklerini ayarla
            ws['!cols'] = [
                { wch: 6 },  // Sƒ±ra
                { wch: 35 }, // Tedarik√ßi
                { wch: 50 }, // Hammadde Kodu
                { wch: 15 }, // ƒ∞rsaliye Tarihi
                { wch: 20 }, // ƒ∞rsaliye No
                { wch: 20 }, // Lot No
                { wch: 15 }, // Lokasyon
                { wch: 35 }, // Dosya Adƒ±
                { wch: 12 }, // Dosya Boyutu
                { wch: 15 }, // Eklenme Tarihi
                { wch: 70 }  // Drive Link
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'COA Listesi');
            
            // Dosya adƒ± olu≈ütur (tarih ile)
            const now = new Date();
            const dateStr = now.toLocaleDateString('tr-TR').replace(/\./g, '-');
            const timeStr = now.toLocaleTimeString('tr-TR').replace(/:/g, '-');
            const fileName = `COA_Arsiv_${dateStr}_${timeStr}.xlsx`;
            
            // Excel dosyasƒ±nƒ± indir
            XLSX.writeFile(wb, fileName);
            
            showToast(`‚úÖ Excel dosyasƒ± indirildi: ${filteredData.length} kayƒ±t`, 'success');
        }
        
        // Filtrelenmi≈ü veriyi al (arama ve filtrelerle)
        function getFilteredData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterMonth = document.getElementById('filterMonth').value;
            
            return coaData.filter(record => {
                // Arama filtresi
                const searchMatch = !searchTerm || 
                    String(record.supplier || '').toLowerCase().includes(searchTerm) ||
                    String(record.materialCode || '').toLowerCase().includes(searchTerm) ||
                    String(record.lotNumber || '').toLowerCase().includes(searchTerm) ||
                    String(record.deliveryNo || '').toLowerCase().includes(searchTerm) ||
                    String(record.location || '').toLowerCase().includes(searchTerm);
                
                // Ay filtresi
                const monthMatch = !filterMonth || 
                    (record.deliveryDate && record.deliveryDate.startsWith(filterMonth));
                
                // Tedarik√ßi filtresi
                const supplierMatch = selectedSuppliers.size === 0 || 
                    selectedSuppliers.has(record.supplier);
                
                return searchMatch && monthMatch && supplierMatch;
            });
        }
        
        // ==================== UI Updates ====================
        function updateUI() {
            updateStats();
            renderTable();
            updateBulkActions();
        }
        
        function updateStats() {
            document.getElementById('statTotal').textContent = coaData.length;
            
            const uniqueSuppliers = [...new Set(coaData.map(c => c.supplier))];
            document.getElementById('statSuppliers').textContent = uniqueSuppliers.length;
            
            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthCount = coaData.filter(c => c.deliveryDate?.startsWith(thisMonth)).length;
            document.getElementById('statThisMonth').textContent = thisMonthCount;
            
            // Toplam dosya boyutunu hesapla - √∂nce fileSize kullan, yoksa fileData'dan hesapla
            let totalBytes = 0;
            let fromFileSize = 0;
            let fromFileData = 0;
            
            coaData.forEach(c => {
                if (c.fileSize) {
                    // Drive'dan gelen ger√ßek dosya boyutu (bytes)
                    totalBytes += parseInt(c.fileSize);
                    fromFileSize++;
                } else if (c.fileData) {
                    // Base64 boyutunu ger√ßek boyuta √ßevir (base64 %33 daha b√ºy√ºk)
                    const base64Length = c.fileData.length;
                    const realSize = Math.ceil(base64Length * 0.75);
                    totalBytes += realSize;
                    fromFileData++;
                }
            });
            
            const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
            document.getElementById('statTotalSize').textContent = totalMB + ' MB';
            
            console.log('üìä Dosya boyutu istatistikleri:');
            console.log('- fileSize kullanan:', fromFileSize);
            console.log('- fileData kullanan:', fromFileData);
            console.log('- Toplam:', totalMB, 'MB');
        }
        
        // COA_Records'tan t√ºm COA kayƒ±tlarƒ± i√ßin deƒüerleri y√ºkle
        async function loadCOARecordsForAll() {
            try {
                if (typeof SharedConfig === 'undefined' || !SharedConfig.isConnected()) {
                    console.log('‚ö†Ô∏è SharedConfig baƒülantƒ±sƒ± yok, COA deƒüerleri y√ºklenemedi');
                    return;
                }
                
                console.log('üìä COA_Records\'tan deƒüerler y√ºkleniyor...');
                const allCOARecords = await SharedConfig.getCOARecords();
                console.log('üì¶ Toplam COA_Records kaydƒ±:', allCOARecords.length);
                
                if (allCOARecords.length === 0) {
                    console.log('‚ö†Ô∏è COA_Records\'ta veri yok');
                    return;
                }
                
                // DEBUG: Console log (alert kaldƒ±rƒ±ldƒ±)
                if (allCOARecords.length > 0 && coaData.length > 0) {
                    console.log('üìã DEBUG - ƒ∞lk kayƒ±tlar:', {
                        firstRecord: allCOARecords[0],
                        firstCOA: coaData[0]
                    });
                }
                
                // Console i√ßin de log
                if (allCOARecords.length > 0) {
                    console.log('üìã ƒ∞lk COA_Records √∂rneƒüi:', {
                        supplier: allCOARecords[0].supplier,
                        materialCode: allCOARecords[0].materialCode,
                        date: allCOARecords[0].date,
                        dateType: typeof allCOARecords[0].date,
                        deliveryNo: allCOARecords[0].deliveryNo,
                        propertyName: allCOARecords[0].propertyName
                    });
                }
                if (coaData.length > 0) {
                    console.log('üìã ƒ∞lk coaData √∂rneƒüi:', {
                        supplier: coaData[0].supplier,
                        materialCode: coaData[0].materialCode,
                        deliveryDate: coaData[0].deliveryDate,
                        dateType: typeof coaData[0].deliveryDate,
                        deliveryNo: coaData[0].deliveryNo
                    });
                }
                
                let enrichedCount = 0;
                
                // Her COA kaydƒ± i√ßin ilgili COA_Records verilerini bul ve ekle
                coaData.forEach(coa => {
                    // ‚úÖ COA_Records'tan veri varsa OVERRIDE et (Sheets √∂ncelikli)
                    // TDS'ten gelmi≈ü ocrProperties varsa bile, Sheets'teki g√ºncel veri √ºzerine yazmalƒ±
                    
                    // Bu COA'ya ait kayƒ±tlarƒ± bul (tedarik√ßi + hammadde kodu + ƒ∞RSALƒ∞YE NO)
                    const matchingRecords = allCOARecords.filter(record => {
                        const recordSupplier = (record.supplier || '').trim().toLowerCase();
                        const coaSupplier = (coa.supplier || '').trim().toLowerCase();
                        
                        const recordMaterial = (record.materialCode || '').trim().toLowerCase();
                        const coaMaterial = (coa.materialCode || '').trim().toLowerCase();
                        
                        const supplierMatch = recordSupplier === coaSupplier;
                        const materialMatch = recordMaterial === coaMaterial;
                        
                        // ‚úÖ TARƒ∞H ve ƒ∞RSALƒ∞YE NO KONTROL√ú EKLENDƒ∞!
                        // COA_Records'taki tarih formatƒ±nƒ± normalize et
                        let recordDate = record.date || '';
                        if (recordDate instanceof Date || typeof recordDate === 'object') {
                            recordDate = new Date(recordDate).toISOString().split('T')[0]; // YYYY-MM-DD
                        } else {
                            recordDate = String(recordDate).split('T')[0]; // Zaten ISO string ise
                        }
                        
                        // coaData'daki deliveryDate formatƒ±nƒ± normalize et (DD.MM.YYYY ‚Üí YYYY-MM-DD)
                        let coaDate = coa.deliveryDate || '';
                        if (/^\d{2}\.\d{2}\.\d{4}$/.test(coaDate)) {
                            const [day, month, year] = coaDate.split('.');
                            coaDate = `${year}-${month}-${day}`;
                        } else if (/^\d{4}-\d{2}-\d{2}$/.test(coaDate)) {
                            // Zaten YYYY-MM-DD formatƒ±nda
                            coaDate = coaDate;
                        }
                        
                        // ƒ∞rsaliye no e≈üle≈ümesi kontrol√º
                        const recordDeliveryNo = (record.deliveryNo || '').trim();
                        const coaDeliveryNo = (coa.deliveryNo || '').trim();
                        
                        // ESNEK MATCHING: ƒ∞rsaliye no varsa √∂ncelik ona!
                        if (recordDeliveryNo && coaDeliveryNo) {
                            // ƒ∞kisi de varsa: supplier + material + deliveryNo KESIN e≈üle≈ümeli
                            // Tarih ¬±1 g√ºn toleranslƒ± (timezone farkƒ± i√ßin)
                            const deliveryMatch = recordDeliveryNo === coaDeliveryNo;
                            
                            if (deliveryMatch) {
                                // Date tolerance: ¬±1 g√ºn
                                const date1 = new Date(recordDate);
                                const date2 = new Date(coaDate);
                                const dayDiff = Math.abs((date1 - date2) / (1000 * 60 * 60 * 24));
                                const dateMatchFlexible = dayDiff <= 1;
                                
                                return supplierMatch && materialMatch && deliveryMatch && dateMatchFlexible;
                            }
                            return false;
                        } else {
                            // ƒ∞rsaliye no yoksa: Kesin tarih + supplier + material
                            const dateMatch = recordDate === coaDate;
                            return supplierMatch && materialMatch && dateMatch;
                        }
                    });
                    
                    if (matchingRecords.length > 0) {
                        // OCR properties olu≈ütur
                        coa.ocrProperties = {};
                        
                        matchingRecords.forEach(record => {
                            const propName = record.propertyName || 'Unknown';
                            
                            // Deƒüerleri temizle ve bo≈üluk normalization yap
                            const cleanValue = (val) => {
                                if (!val) return '';
                                let cleaned = String(val).trim();
                                // Bo≈üluklu ondalƒ±k: "0 035" ‚Üí "0.035"
                                if (/^\d\s+\d+$/.test(cleaned)) {
                                    const parts = cleaned.split(/\s+/);
                                    cleaned = parts[0] === '0' ? '0.' + parts[1] : parts[0] + '.' + parts[1];
                                }
                                return cleaned;
                            };
                            
                            // TDS deƒüeri: standardValue, minLimit-maxLimit formatƒ±nda olabilir
                            const cleanStdValue = cleanValue(record.standardValue);
                            const cleanMinLimit = cleanValue(record.minLimit);
                            const cleanMaxLimit = cleanValue(record.maxLimit);
                            
                            let tdsValue = cleanStdValue;
                            if (cleanMinLimit && cleanMaxLimit) {
                                tdsValue = `${cleanMinLimit} - ${cleanMaxLimit}`;
                            } else if (cleanMinLimit) {
                                tdsValue = `‚â• ${cleanMinLimit}`;
                            } else if (cleanMaxLimit) {
                                tdsValue = `‚â§ ${cleanMaxLimit}`;
                            }
                            
                            // Status kontrol√º: pass/fail veya uygun/deƒüil
                            let displayStatus = 'pass';
                            const statusLower = (record.status || '').toLowerCase();
                            if (statusLower.includes('uygun deƒüil') || statusLower.includes('fail')) {
                                displayStatus = 'fail';
                            }
                            
                            coa.ocrProperties[propName] = {
                                tdsValue: tdsValue,
                                coaValue: cleanValue(record.coaValue),
                                unit: record.unit || '',
                                status: displayStatus,
                                compliance: displayStatus,
                                method: record.standard || '',
                                lowerLimit: cleanMinLimit,
                                upperLimit: cleanMaxLimit,
                                standardValue: cleanStdValue,
                                requirement: record.requirement || ''
                            };
                        });
                        
                        enrichedCount++;
                        console.log(`‚úÖ ${coa.materialCode} i√ßin ${matchingRecords.length} √∂zellik eklendi (ƒ∞rsaliye: ${coa.deliveryNo || 'yok'})`);
                    } else if (enrichedCount < 5) {
                        // ƒ∞lk 3 e≈üle≈ümeyen kayƒ±t i√ßin debug g√∂ster
                        console.log(`‚ö†Ô∏è ${coa.materialCode} (${coa.supplier}) - COA_Records'ta veri yok`);
                    }
                });
                
                console.log(`‚úÖ Toplam ${enrichedCount} COA kaydƒ±na COA_Records'tan deƒüerler eklendi`);
                const fromSheets = coaData.filter(c => c.ocrProperties && Object.keys(c.ocrProperties).length > 0).length - enrichedCount;
                if (fromSheets > 0) {
                    console.log(`üìä ${fromSheets} COA, Sheets'ten ocrProperties ile geldi`);
                }
                
                // Toplam COA deƒüeri olan kayƒ±t sayƒ±sƒ±nƒ± g√∂ster
                const totalWithValues = coaData.filter(c => c.ocrProperties && Object.keys(c.ocrProperties).length > 0).length;
                const totalCOAs = coaData.length;
                
                if (totalWithValues === 0 && totalCOAs > 0) {
                    console.warn(`‚ö†Ô∏è Hi√ßbir COA'da deƒüer yok! ${totalCOAs} COA var ama hepsinde ocrProperties bo≈ü`);
                    console.warn(`üí° √á√∂z√ºm: Yeni COA ekleyin veya mevcut bir COA'yƒ± d√ºzenleyip tekrar kaydedin`);
                } else if (totalWithValues > 0) {
                    console.log(`‚úÖ ${totalWithValues}/${totalCOAs} COA'da deƒüerler mevcut`);
                }
                
            } catch (error) {
                console.error('‚ùå COA_Records y√ºkleme hatasƒ±:', error);
            }
        }
        
        function renderTable() {
            const tbody = document.getElementById('coaTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('coaTable');
            const recordInfo = document.getElementById('recordInfo');
            
            const filtered = getFilteredData();
            
            // Sayfa ba≈üƒ±na kayƒ±t sayƒ±sƒ± kontrol√º
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const rowsPerPage = rowsPerPageSelect ? rowsPerPageSelect.value : '25';
            
            let displayData = filtered;
            let totalPages = 1;
            
            if (rowsPerPage !== 'all') {
                const rowsPerPageNum = parseInt(rowsPerPage);
                totalPages = Math.ceil(filtered.length / rowsPerPageNum);
                
                // Sayfa numarasƒ± kontrol (ge√ßerli aralƒ±kta mƒ±?)
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;
                
                // Mevcut sayfadaki verileri al
                const startIndex = (currentPage - 1) * rowsPerPageNum;
                const endIndex = startIndex + rowsPerPageNum;
                displayData = filtered.slice(startIndex, endIndex);
            }
            
            // Sayfa kontrollerini render et
            renderPaginationControls(totalPages, filtered.length, rowsPerPage);
            
            // Kayƒ±t bilgisi g√ºncelle
            if (recordInfo) {
                if (filtered.length === 0) {
                    recordInfo.textContent = 'Toplam: 0 kayƒ±t';
                } else if (rowsPerPage === 'all') {
                    recordInfo.textContent = `Toplam: ${filtered.length} kayƒ±t`;
                } else {
                    const startRecord = (currentPage - 1) * parseInt(rowsPerPage) + 1;
                    const endRecord = Math.min(currentPage * parseInt(rowsPerPage), filtered.length);
                    recordInfo.textContent = `${startRecord}-${endRecord} / ${filtered.length} kayƒ±t`;
                }
            }
            
            if (filtered.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = displayData.map(c => {
                const isChecked = selectedItems.has(c.id) ? 'checked' : '';
                
                // Dosya √∂nizlemesi - t√ºm dosyalar i√ßin ikon g√∂ster
                let filePreview = getFileIcon(c.fileName, c.fileType, c.id);
                
                const onlineIcon = c.fileData ? ' üíæ' : (c.fileUrl ? ' ‚òÅÔ∏è' : '');
                
                // Dosya boyutunu hesapla
                let fileSizeDisplay = '-';
                if (c.fileSize) {
                    const sizeInMB = (c.fileSize / (1024 * 1024)).toFixed(2);
                    fileSizeDisplay = sizeInMB + ' MB';
                } else if (c.fileData) {
                    const base64Length = c.fileData.length;
                    const sizeInBytes = Math.ceil(base64Length * 0.75);
                    const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
                    fileSizeDisplay = sizeInMB + ' MB';
                }
                
                // COA Deƒüerleri ve Durum
                let coaValuesDisplay = '-';
                if (c.ocrProperties && Object.keys(c.ocrProperties).length > 0) {
                    const propCount = Object.keys(c.ocrProperties).length;
                    const passCount = Object.values(c.ocrProperties).filter(p => p.status === 'pass' || p.status === 'uygun').length;
                    const failCount = Object.values(c.ocrProperties).filter(p => p.status === 'fail' || p.status === 'uygun deƒüil').length;
                    
                    let statusBadge = '';
                    if (failCount > 0) {
                        statusBadge = '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; font-weight: bold; margin-left: 5px;">‚ùå ' + failCount + '</span>';
                    } else if (passCount > 0) {
                        statusBadge = '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; font-weight: bold; margin-left: 5px;">‚úÖ ' + passCount + '</span>';
                    }
                    
                    coaValuesDisplay = `<button onclick="showCOAProperties('${c.id}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        üìä ${propCount} √ñzellik${statusBadge}
                    </button>`;
                } else {
                    coaValuesDisplay = '<span style="color: #999; font-size: 0.85em;">Veri yok</span>';
                }
                
                return '<tr>' +
                    '<td><input type="checkbox" class="row-checkbox" data-id="' + c.id + '" onchange="toggleRowSelection(\'' + c.id + '\')" ' + isChecked + ' style="cursor: pointer;"></td>' +
                    '<td>' + filePreview + '</td>' +
                    '<td><strong>' + c.supplier + '</strong>' + onlineIcon + '</td>' +
                    '<td>' + c.materialCode + '</td>' +
                    '<td>' + formatDate(c.deliveryDate) + '</td>' +
                    '<td>' + (c.deliveryNo || '-') + '</td>' +
                    '<td>' + (c.lotNumber || '-') + '</td>' +
                    '<td style="font-size: 0.85em; color: #666;">' + fileSizeDisplay + '</td>' +
                    '<td>' + (c.location || '-') + '</td>' +
                    '<td>' + coaValuesDisplay + '</td>' +
                    '<td class="actions">' +
                        '<button class="btn btn-secondary btn-sm" onclick="viewFile(\'' + c.id + '\')" title="G√∂r√ºnt√ºle">üëÅ</button>' +
                        '<button class="btn btn-secondary btn-sm" onclick="downloadFile(\'' + c.id + '\')" title="ƒ∞ndir">üì•</button>' +
                        '<button class="btn btn-primary btn-sm" onclick="editCOA(\'' + c.id + '\')" title="D√ºzenle">‚úèÔ∏è</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteCOA(\'' + c.id + '\')" title="Sil">üóë</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }
        
        function getFilteredData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const month = document.getElementById('filterMonth').value;
            
            return coaData.filter(c => {
                const matchSearch = !search || 
                    String(c.supplier || '').toLowerCase().includes(search) ||
                    String(c.materialCode || '').toLowerCase().includes(search) ||
                    String(c.deliveryNo || '').toLowerCase().includes(search) ||
                    String(c.lotNumber || '').toLowerCase().includes(search) ||
                    String(c.location || '').toLowerCase().includes(search);
                    
                // √áoklu tedarik√ßi filtresi: Hi√ß se√ßilmemi≈üse t√ºm√ºn√º g√∂ster, se√ßilmi≈üse sadece se√ßilenleri g√∂ster
                const matchSupplier = selectedSuppliers.size === 0 || selectedSuppliers.has(c.supplier);
                const matchMonth = !month || String(c.deliveryDate || '').startsWith(month);
                
                return matchSearch && matchSupplier && matchMonth;
            });
        }
        
        function filterList() {
            currentPage = 1; // Filtre deƒüi≈üince ilk sayfaya d√∂n
            renderTable();
        }
        
        function renderPaginationControls(totalPages, totalRecords, rowsPerPage) {
            const container = document.getElementById('paginationControls');
            if (!container) return;
            
            // Eƒüer "T√ºm√º" se√ßiliyse veya tek sayfa varsa g√∂sterme
            if (rowsPerPage === 'all' || totalPages <= 1) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.innerHTML = '';
            
            // √ñnceki butonu
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '‚Üê √ñnceki';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => goToPage(currentPage - 1);
            prevBtn.style.cssText = 'padding: 5px 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85em; ' + (currentPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : '');
            container.appendChild(prevBtn);
            
            // Sayfa numaralarƒ± (max 7 sayfa g√∂ster)
            let startPage = Math.max(1, currentPage - 3);
            let endPage = Math.min(totalPages, startPage + 6);
            
            // Eƒüer sonda isek, ba≈ülangƒ±cƒ± ayarla
            if (endPage - startPage < 6) {
                startPage = Math.max(1, endPage - 6);
            }
            
            // ƒ∞lk sayfa
            if (startPage > 1) {
                addPageButton(container, 1);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.cssText = 'padding: 5px 10px; color: #666;';
                    container.appendChild(dots);
                }
            }
            
            // Sayfa numaralarƒ±
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(container, i);
            }
            
            // Son sayfa
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.cssText = 'padding: 5px 10px; color: #666;';
                    container.appendChild(dots);
                }
                addPageButton(container, totalPages);
            }
            
            // Sonraki butonu
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = 'Sonraki ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => goToPage(currentPage + 1);
            nextBtn.style.cssText = 'padding: 5px 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85em; ' + (currentPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : '');
            container.appendChild(nextBtn);
        }
        
        function addPageButton(container, pageNum) {
            const btn = document.createElement('button');
            btn.textContent = pageNum;
            btn.onclick = () => goToPage(pageNum);
            const isActive = pageNum === currentPage;
            btn.style.cssText = 'padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.85em; min-width: 35px; ' +
                (isActive ? 'background: #4CAF50; color: white; font-weight: bold; border-color: #4CAF50;' : 'background: white; color: #333;');
            container.appendChild(btn);
        }
        
        function goToPage(pageNum) {
            currentPage = pageNum;
            renderTable();
            // Sayfanƒ±n √ºst√ºne scroll
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function changeRowsPerPage() {
            const select = document.getElementById('rowsPerPage');
            if (select) {
                currentPage = 1; // Sayfa ba≈üƒ±na kayƒ±t deƒüi≈üince ilk sayfaya d√∂n
                localStorage.setItem('rowsPerPage', select.value);
                renderTable();
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR');
        }
        
        // ==================== Toast ====================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), duration);
        }
        
        // ==================== COMPLIANCE CHECK (BASF) ====================
        function checkCompliance(testResult, requirement) {
            if (!testResult || !requirement) return 'Bilinmiyor';
            
            const test = testResult.trim();
            const req = requirement.trim();
            
            console.log(`  üîç Compliance check: "${test}" vs "${req}"`);
            
            // 1) Range check (7,5 - 10,5 kg/m3)
            const rangeMatch = req.match(/(\d+[.,]\d+)\s*-\s*(\d+[.,]\d+)/);
            if (rangeMatch) {
                const min = parseFloat(rangeMatch[1].replace(',', '.'));
                const max = parseFloat(rangeMatch[2].replace(',', '.'));
                const value = parseFloat(test.replace(',', '.'));
                
                if (!isNaN(value) && !isNaN(min) && !isNaN(max)) {
                    const result = value >= min && value <= max ? 'Uygun' : 'Uygun Deƒüil';
                    console.log(`    üìè Range: ${min} ‚â§ ${value} ‚â§ ${max} ‚Üí ${result}`);
                    return result;
                }
            }
            
            // 2) Greater than or equal (‚â• 45 N)
            const gteMatch = req.match(/[‚â•>=]\s*(\d+[.,]?\d*)/);
            if (gteMatch) {
                const minValue = parseFloat(gteMatch[1].replace(',', '.'));
                const value = parseFloat(test.replace(',', '.'));
                
                if (!isNaN(value) && !isNaN(minValue)) {
                    const result = value >= minValue ? 'Uygun' : 'Uygun Deƒüil';
                    console.log(`    ‚¨ÜÔ∏è Greater than: ${value} ‚â• ${minValue} ‚Üí ${result}`);
                    return result;
                }
            }
            
            // 3) Less than or equal (‚â§ 0,035 W/mK)
            const lteMatch = req.match(/[‚â§<=]\s*(\d+[.,]?\d*)/);
            if (lteMatch) {
                const maxValue = parseFloat(lteMatch[1].replace(',', '.'));
                
                // Extract numeric value from test result (handle "Œª10 ‚â§ 0,035 W/mK" format)
                const testNumMatch = test.match(/(\d+[.,]?\d*)/);
                if (testNumMatch) {
                    const value = parseFloat(testNumMatch[0].replace(',', '.'));
                    
                    if (!isNaN(value) && !isNaN(maxValue)) {
                        const result = value <= maxValue ? 'Uygun' : 'Uygun Deƒüil';
                        console.log(`    ‚¨áÔ∏è Less than: ${value} ‚â§ ${maxValue} ‚Üí ${result}`);
                        return result;
                    }
                }
            }
            
            // 4) Text match (Class A, B1, etc.)
            // Clean both sides (remove language variants)
            const cleanTest = test.split('/')[0].trim().toUpperCase();
            const cleanReq = req.split('/')[0].trim().toUpperCase();
            
            // Extract codes (B1, Class A, etc.)
            const testCode = cleanTest.match(/\b(B\d|CLASS\s*[A-Z]|[A-Z]\d+)\b/i);
            const reqCode = cleanReq.match(/\b(B\d|CLASS\s*[A-Z]|[A-Z]\d+)\b/i);
            
            if (testCode && reqCode) {
                const result = testCode[0].toUpperCase() === reqCode[0].toUpperCase() ? 'Uygun' : 'Uygun Deƒüil';
                console.log(`    üî§ Text match: "${testCode[0]}" vs "${reqCode[0]}" ‚Üí ${result}`);
                return result;
            }
            
            // 5) Exact string match (case-insensitive, ignore whitespace and special chars)
            const normalizeStr = (str) => str.replace(/\s+/g, '').replace(/[ŒªŒõ]/g, 'lambda').toLowerCase();
            const normalizedTest = normalizeStr(test);
            const normalizedReq = normalizeStr(req);
            
            if (normalizedTest === normalizedReq) {
                console.log(`    ‚úÖ Exact match (normalized) ‚Üí Uygun`);
                return 'Uygun';
            }
            
            // Also check cleaned versions
            if (cleanTest === cleanReq) {
                console.log(`    ‚úÖ Exact match ‚Üí Uygun`);
                return 'Uygun';
            }
            
            // 6) Contains match
            if (cleanTest.includes(cleanReq) || cleanReq.includes(cleanTest)) {
                console.log(`    ‚úÖ Contains match ‚Üí Uygun`);
                return 'Uygun';
            }
            
            // Default: Unknown
            console.log(`    ‚ùì No match pattern found ‚Üí Bilinmiyor`);
            return 'Bilinmiyor';
        }
        
        // ==================== TDS MANAGEMENT ====================
        
        // OCR.space API ile OCR i≈ülemi
        async function performOCRSpaceOCR(imageData) {
            console.log('üü¢ OCR.space API isteƒüi hazƒ±rlanƒ±yor...');
            showToast('üîç OCR i≈ülemi ba≈üladƒ± (OCR.space)', 'info', 3000);
            
            // API key al
            const apiKey = localStorage.getItem('ocrspace_api_key') || 'K82811583888957';
            console.log('üîë API Key:', apiKey.substring(0, 5) + '...');
            
            // Base64'√º blob'a √ßevir
            console.log('üì¶ Blob olu≈üturuluyor...');
            const base64Data = imageData.split(',')[1];
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/png' });
            console.log('‚úÖ Blob olu≈üturuldu:', Math.round(blob.size / 1024), 'KB');
            
            // FormData olu≈ütur - mobil i√ßin optimize edilmi≈ü parametreler
            const formData = new FormData();
            formData.append('file', blob, 'coa.png');
            formData.append('apikey', apiKey);
            formData.append('language', 'tur'); // T√ºrk√ße (ƒû, ƒ∞, ≈û, √á gibi karakterler i√ßin)
            formData.append('isOverlayRequired', 'false');
            formData.append('detectOrientation', 'true');
            formData.append('scale', 'true'); // Otomatik upscaling
            formData.append('OCREngine', '2'); // Engine 2 daha iyi
            formData.append('isTable', 'true'); // Tablo modu
            formData.append('filetype', 'PNG'); // PNG format
            console.log('‚úÖ FormData hazƒ±r (T√ºrk√ße dil desteƒüi)');
            
            console.log('üåê API\'ye istek g√∂nderiliyor...');
            const response = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData
            });
            console.log('üì° API yanƒ±t aldƒ±, status:', response.status);
            
            if (!response.ok) {
                throw new Error(`OCR API hatasƒ±: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('üîç OCR.space Response:', result);
            
            if (!result.IsErroredOnProcessing && result.ParsedResults && result.ParsedResults.length > 0) {
                const text = result.ParsedResults[0].ParsedText;
                console.log('‚úÖ OCR.space ba≈üarƒ±lƒ±:', text.length, 'karakter');
                return text;
            } else {
                const errorMsg = result.ErrorMessage || result.OCRExitCode || 'OCR ba≈üarƒ±sƒ±z';
                console.error('‚ùå OCR sonucu hatalƒ±:', errorMsg);
                throw new Error(errorMsg);
            }
        }
        
        // OCR ile COA'dan √∂zellikleri √ßƒ±kar
        // G√∂r√ºnt√º kalitesini artƒ±r (OCR i√ßin optimize)
        function enhanceImageForOCR(canvas) {
            const enhancedCanvas = document.createElement('canvas');
            enhancedCanvas.width = canvas.width;
            enhancedCanvas.height = canvas.height;
            const ctx = enhancedCanvas.getContext('2d');
            
            // Orijinal g√∂r√ºnt√ºy√º √ßiz
            ctx.drawImage(canvas, 0, 0);
            
            // ImageData al
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 1. KONTRAST ARTIRMA (contrast enhancement)
            const contrast = 1.3; // %30 daha fazla kontrast
            const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // RGB'yi grayscale'e √ßevir (OCR i√ßin daha iyi)
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // Kontrast uygula
                let enhanced = factor * (gray - 128) + 128;
                enhanced = Math.max(0, Math.min(255, enhanced));
                
                // 2. KESKƒ∞NLE≈ûTƒ∞RME i√ßin hafif threshold
                if (enhanced > 180) {
                    enhanced = 255; // Beyaz yap
                } else if (enhanced < 80) {
                    enhanced = 0; // Siyah yap
                }
                
                data[i] = enhanced;
                data[i + 1] = enhanced;
                data[i + 2] = enhanced;
                // Alpha kalsƒ±n (data[i + 3])
            }
            
            // Geli≈ütirilmi≈ü veriyi geri yaz
            ctx.putImageData(imageData, 0, 0);
            
            console.log('  üé® G√∂r√ºnt√º iyile≈ütirildi: Kontrast +30%, Keskinle≈ütirme, Grayscale');
            
            return enhancedCanvas;
        }
        
        async function performAzureOCR(imageData) {
            console.log('üîµ Azure Computer Vision OCR ba≈ülatƒ±lƒ±yor...');
            
            const azureKey = localStorage.getItem('azure_api_key');
            const azureEndpoint = localStorage.getItem('azure_endpoint');
            
            if (!azureKey || !azureEndpoint) {
                const errorMsg = 'Azure API key veya endpoint tanƒ±mlƒ± deƒüil';
                console.error('‚ùå', errorMsg);
                throw new Error(errorMsg);
            }
            
            // Endpoint'in doƒüru formatta olduƒüunu kontrol et
            if (!azureEndpoint.startsWith('http://') && !azureEndpoint.startsWith('https://')) {
                const errorMsg = 'Azure endpoint ge√ßersiz (http:// veya https:// ile ba≈ülamalƒ±)';
                console.error('‚ùå', errorMsg, '| Mevcut:', azureEndpoint);
                throw new Error(errorMsg);
            }
            
            console.log('üîë Azure Endpoint:', azureEndpoint);
            console.log('üîë Azure Key length:', azureKey.length, 'chars');
            
            // Base64'√º binary'ye √ßevir - PNG olduƒüundan emin ol
            if (!imageData.startsWith('data:image/png')) {
                console.warn('‚ö†Ô∏è Image PNG deƒüil, d√∂n√º≈üt√ºr√ºl√ºyor...');
                // Canvas'a √ßevir ve PNG olarak export et
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = imageData;
                });
                
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                imageData = canvas.toDataURL('image/png');
                console.log('‚úÖ PNG\'ye d√∂n√º≈üt√ºr√ºld√º');
            }
            
            const base64Data = imageData.split(',')[1];
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            
            console.log('üì¶ Image binary boyutu:', Math.round(byteArray.length / 1024), 'KB');
            
            // Azure Read API - async i≈ülem ba≈ülat
            const analyzeUrl = `${azureEndpoint}/vision/v3.2/read/analyze`;
            
            console.log('üåê Azure analyze isteƒüi g√∂nderiliyor:', analyzeUrl);
            
            try {
                const analyzeResponse = await fetch(analyzeUrl, {
                    method: 'POST',
                    headers: {
                        'Ocp-Apim-Subscription-Key': azureKey,
                        'Content-Type': 'application/octet-stream'
                    },
                    body: byteArray
                });
                
                if (!analyzeResponse.ok) {
                    const errorText = await analyzeResponse.text();
                    console.error('‚ùå Azure analyze hatasƒ±:', analyzeResponse.status, errorText);
                    throw new Error(`Azure analyze hatasƒ±: ${analyzeResponse.status} - ${errorText}`);
                }
                
                // Operation-Location header'ƒ±ndan sonu√ß URL'ini al
                const operationLocation = analyzeResponse.headers.get('Operation-Location');
                if (!operationLocation) {
                    console.error('‚ùå Operation-Location header yok');
                    throw new Error('Azure Operation-Location header bulunamadƒ±');
                }
                
                console.log('‚è≥ Azure OCR i≈üleniyor, sonu√ß bekleniyor...');
                console.log('üîó Operation URL:', operationLocation);
                
                // Sonu√ß i√ßin polling yap (max 30 saniye)
                let resultResponse;
                let attempts = 0;
                const maxAttempts = 30;
                
                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 saniye bekle
                    attempts++;
                    
                    try {
                        resultResponse = await fetch(operationLocation, {
                            headers: {
                                'Ocp-Apim-Subscription-Key': azureKey
                            }
                        });
                        
                        if (!resultResponse.ok) {
                            const errorText = await resultResponse.text();
                            console.error(`‚ùå Azure sonu√ß hatasƒ± (${attempts}/${maxAttempts}):`, resultResponse.status, errorText);
                            throw new Error(`Azure sonu√ß hatasƒ±: ${resultResponse.status} - ${errorText}`);
                        }
                        
                        const result = await resultResponse.json();
                        console.log(`üîÑ Azure durum (${attempts}/${maxAttempts}):`, result.status);
                        
                        if (result.status === 'succeeded') {
                            console.log('‚úÖ Azure OCR tamamlandƒ±!');
                            
                            // Line-by-line array + full result d√∂nd√ºr
                            const linesArray = [];
                            const wordsArray = [];
                            
                            if (result.analyzeResult && result.analyzeResult.readResults) {
                                result.analyzeResult.readResults.forEach(page => {
                                    // Satƒ±rlarƒ± topla
                                    if (page.lines) {
                                        page.lines.forEach(line => {
                                            linesArray.push(line.text);
                                        });
                                    }
                                    
                                    // Kelimeleri topla (koordinatlarƒ±yla birlikte) - v3.2'de words yok, lines i√ßinde
                                    // V3.2'de her line'da words array'i var
                                    if (page.lines) {
                                        page.lines.forEach(line => {
                                            if (line.words) {
                                                line.words.forEach(word => {
                                                    wordsArray.push({
                                                        text: word.text,
                                                        boundingBox: word.boundingBox,
                                                        confidence: word.confidence
                                                    });
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                            
                            console.log('üìù Azure OCR toplam satƒ±r:', linesArray.length);
                            console.log('üìù Azure OCR toplam kelime:', wordsArray.length);
                            if (linesArray.length > 0) {
                                console.log('üìù Okunan text:', linesArray.join(' '));
                            }
                            
                            // Parse etmek i√ßin satƒ±rlarƒ±, kelimeleri ve tam result'ƒ± d√∂nd√ºr
                            return { 
                                text: linesArray.join('\n'), 
                                lines: linesArray,
                                words: wordsArray,
                                fullResult: result
                            };
                        } else if (result.status === 'failed') {
                            console.error('‚ùå Azure OCR ba≈üarƒ±sƒ±z:', result);
                            throw new Error('Azure OCR ba≈üarƒ±sƒ±z oldu: ' + JSON.stringify(result));
                        }
                        
                        // Hala running durumunda, bekle
                        if (attempts % 5 === 0) {
                            console.log(`‚è≥ Bekleniyor... ${attempts}/${maxAttempts} saniye`);
                        }
                        
                    } catch (fetchError) {
                        console.error(`‚ùå Azure polling hatasƒ± (${attempts}/${maxAttempts}):`, fetchError);
                        if (attempts >= maxAttempts) {
                            throw fetchError;
                        }
                        // Devam et, tekrar dene
                    }
                }
                
                throw new Error('Azure OCR zaman a≈üƒ±mƒ± (30 saniye)');
                
            } catch (mainError) {
                console.error('‚ùå Azure OCR ana hata:', mainError);
                throw mainError;
            }
        }
        
        // Convert Excel to Canvas (same method as template editor)
        async function convertExcelToCanvas(fileData) {
            // Ensure XLSX library is loaded
            await ensureLibraryLoaded(
                'XLSX',
                () => typeof XLSX !== 'undefined',
                [
                    'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
                ]
            );
            
            // Ensure html2canvas library is loaded
            await ensureLibraryLoaded(
                'html2canvas',
                () => typeof html2canvas !== 'undefined',
                [
                    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                    'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
                ]
            );
            
            // Convert data URL to ArrayBuffer
            const base64Data = fileData.split(',')[1];
            const binaryData = atob(base64Data);
            const arrayBuffer = new Uint8Array(binaryData.length);
            for (let i = 0; i < binaryData.length; i++) {
                arrayBuffer[i] = binaryData.charCodeAt(i);
            }
            
            const workbook = XLSX.read(arrayBuffer, { type: 'array', cellStyles: true });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Get column widths and row heights from Excel
            const colWidths = worksheet['!cols'] || [];
            const rowHeights = worksheet['!rows'] || [];
            
            // Convert to HTML
            const htmlString = XLSX.utils.sheet_to_html(worksheet, { header: '', footer: '' });
            
            // Create temporary div to render HTML
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            tempDiv.style.background = 'white';
            tempDiv.style.padding = '0';
            tempDiv.innerHTML = htmlString;
            document.body.appendChild(tempDiv);
            
            // Style the table with exact Excel dimensions
            const table = tempDiv.querySelector('table');
            if (table) {
                table.style.borderCollapse = 'collapse';
                table.style.fontSize = '11px';
                table.style.fontFamily = 'Calibri, Arial, sans-serif';
                table.style.border = 'none';
                table.style.margin = '0';
                table.style.padding = '0';
                
                // Apply column widths
                const rows = table.querySelectorAll('tr');
                if (rows.length > 0) {
                    const firstRowCells = rows[0].querySelectorAll('td, th');
                    firstRowCells.forEach((cell, index) => {
                        const colInfo = colWidths[index];
                        if (colInfo && colInfo.wpx) {
                            cell.style.width = colInfo.wpx + 'px';
                            cell.style.minWidth = colInfo.wpx + 'px';
                            cell.style.maxWidth = colInfo.wpx + 'px';
                        } else if (colInfo && colInfo.wch) {
                            const pixelWidth = Math.round(colInfo.wch * 7);
                            cell.style.width = pixelWidth + 'px';
                            cell.style.minWidth = pixelWidth + 'px';
                            cell.style.maxWidth = pixelWidth + 'px';
                        } else {
                            cell.style.width = '64px';
                            cell.style.minWidth = '64px';
                            cell.style.maxWidth = '64px';
                        }
                    });
                }
                
                // Apply row heights and cell styles
                rows.forEach((row, rowIndex) => {
                    const rowInfo = rowHeights[rowIndex];
                    if (rowInfo && rowInfo.hpx) {
                        row.style.height = rowInfo.hpx + 'px';
                    } else if (rowInfo && rowInfo.hpt) {
                        const pixelHeight = Math.round(rowInfo.hpt * 1.333);
                        row.style.height = pixelHeight + 'px';
                    } else {
                        row.style.height = '20px';
                    }
                    
                    const cells = row.querySelectorAll('td, th');
                    cells.forEach((cell, colIndex) => {
                        cell.style.border = '1px solid #d0d0d0';
                        cell.style.padding = '2px 4px';
                        cell.style.textAlign = 'left';
                        cell.style.verticalAlign = 'middle';
                        cell.style.overflow = 'hidden';
                        cell.style.whiteSpace = 'nowrap';
                        cell.style.boxSizing = 'border-box';
                        
                        const colInfo = colWidths[colIndex];
                        if (colInfo && colInfo.wpx) {
                            cell.style.width = colInfo.wpx + 'px';
                            cell.style.minWidth = colInfo.wpx + 'px';
                            cell.style.maxWidth = colInfo.wpx + 'px';
                        } else if (colInfo && colInfo.wch) {
                            const pixelWidth = Math.round(colInfo.wch * 7);
                            cell.style.width = pixelWidth + 'px';
                            cell.style.minWidth = pixelWidth + 'px';
                            cell.style.maxWidth = pixelWidth + 'px';
                        }
                    });
                });
            }
            
            // Convert to canvas using html2canvas
            const canvas = await html2canvas(tempDiv, {
                backgroundColor: '#ffffff',
                scale: 1,
                logging: false,
                useCORS: true
            });
            
            // Remove temporary div
            document.body.removeChild(tempDiv);
            
            return canvas;
        }
        
        // Convert Word to Canvas (same method as template editor)
        async function convertWordToCanvas(fileData) {
            // Ensure mammoth library is loaded
            await ensureLibraryLoaded(
                'mammoth',
                () => typeof mammoth !== 'undefined',
                [
                    'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js',
                    'https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js'
                ]
            );
            
            // Ensure html2canvas library is loaded
            await ensureLibraryLoaded(
                'html2canvas',
                () => typeof html2canvas !== 'undefined',
                [
                    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                    'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
                ]
            );
            
            // Convert data URL to ArrayBuffer
            const base64Data = fileData.split(',')[1];
            const binaryData = atob(base64Data);
            const arrayBuffer = new Uint8Array(binaryData.length);
            for (let i = 0; i < binaryData.length; i++) {
                arrayBuffer[i] = binaryData.charCodeAt(i);
            }
            
            const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
            
            // Create temporary div to render HTML
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            tempDiv.style.background = 'white';
            tempDiv.style.padding = '40px';
            tempDiv.style.width = '800px';
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.style.fontSize = '12px';
            tempDiv.style.lineHeight = '1.5';
            tempDiv.innerHTML = result.value;
            document.body.appendChild(tempDiv);
            
            // Style tables if any
            const tables = tempDiv.querySelectorAll('table');
            tables.forEach(table => {
                table.style.borderCollapse = 'collapse';
                table.style.width = '100%';
                table.style.marginBottom = '20px';
                const cells = table.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.border = '1px solid #ddd';
                    cell.style.padding = '8px';
                });
            });
            
            // Convert to canvas using html2canvas
            const canvas = await html2canvas(tempDiv, {
                backgroundColor: '#ffffff',
                scale: 1,
                logging: false,
                useCORS: true
            });
            
            // Remove temporary div
            document.body.removeChild(tempDiv);
            
            return canvas;
        }
        
        // Extract COA properties using template regions
        async function extractCOAPropertiesWithTemplate(fileData, template) {
            console.log('üé® Template ile OCR ba≈ülatƒ±lƒ±yor:', template.supplier || 'Bilinmeyen');
            
            // Template validation
            if (!template || !template.regions || !Array.isArray(template.regions)) {
                console.error('‚ùå Template yapƒ±sƒ± hatalƒ±:', template);
                showToast('‚ùå Template yapƒ±sƒ± hatalƒ±', 'error');
                throw new Error('Template yapƒ±sƒ± hatalƒ±: regions array yok');
            }
            
            console.log('‚úÖ Template ge√ßerli:', template.regions.length, 'b√∂lge');
            showToast('üé® Template b√∂lgeleri tek tek okunuyor...', 'info');
            
            return new Promise(async (resolve, reject) => {
                try {
                    // File type detection
                    const isExcel = fileData.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') || 
                                   fileData.includes('application/vnd.ms-excel');
                    const isWord = fileData.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
                                  fileData.includes('application/msword');
                    
                    // Canvas'a √ßevir
                    let canvas, canvasWidth, canvasHeight;
                    
                    if (isExcel) {
                        // Excel dosyasƒ±nƒ± canvas'a √ßevir (template ile aynƒ± ≈üekilde)
                        console.log('üìä Excel canvas\'a √ßeviriliyor...');
                        canvas = await convertExcelToCanvas(fileData);
                        canvasWidth = canvas.width;
                        canvasHeight = canvas.height;
                        console.log('‚úÖ Excel canvas\'a √ßevrildi:', canvasWidth, 'x', canvasHeight);
                    } else if (isWord) {
                        // Word dosyasƒ±nƒ± canvas'a √ßevir
                        console.log('üìù Word canvas\'a √ßeviriliyor...');
                        canvas = await convertWordToCanvas(fileData);
                        canvasWidth = canvas.width;
                        canvasHeight = canvas.height;
                        console.log('‚úÖ Word canvas\'a √ßevrildi:', canvasWidth, 'x', canvasHeight);
                    } else if (fileData.startsWith('data:application/pdf')) {
                        console.log('üìÑ PDF canvas\'a √ßeviriliyor...');
                        const base64Data = fileData.split(',')[1];
                        const binaryData = atob(base64Data);
                        const uint8Array = new Uint8Array(binaryData.length);
                        for (let i = 0; i < binaryData.length; i++) {
                            uint8Array[i] = binaryData.charCodeAt(i);
                        }
                        
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        const pdf = await pdfjsLib.getDocument({ data: uint8Array }).promise;
                        const page = await pdf.getPage(1);
                        
                        const viewport = page.getViewport({ scale: 2.0 });
                        canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        canvasWidth = viewport.width;
                        canvasHeight = viewport.height;
                        const ctx = canvas.getContext('2d');
                        
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                        console.log('‚úÖ PDF canvas\'a √ßevrildi:', canvasWidth, 'x', canvasHeight);
                    } else {
                        // Image ise direkt canvas'a √ßiz
                        console.log('üñºÔ∏è Image canvas\'a √ßeviriliyor...');
                        canvas = document.createElement('canvas');
                        const img = new Image();
                        
                        await new Promise((resolveImg, rejectImg) => {
                            img.onload = () => {
                                canvas.width = img.width;
                                canvas.height = img.height;
                                canvasWidth = img.width;
                                canvasHeight = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                resolveImg();
                            };
                            img.onerror = rejectImg;
                            img.src = fileData;
                        });
                        console.log('‚úÖ Image canvas\'a √ßevrildi:', canvasWidth, 'x', canvasHeight);
                    }
                    
                    // Template canvas boyutlarƒ± ile ger√ßek canvas boyutlarƒ±nƒ±n oranƒ±nƒ± hesapla
                    const scaleX = canvasWidth / (template.canvasWidth || canvasWidth);
                    const scaleY = canvasHeight / (template.canvasHeight || canvasHeight);
                    console.log('üìè √ñl√ßek oranlarƒ± - X:', scaleX.toFixed(2), 'Y:', scaleY.toFixed(2));
                    
                    // OCR engine se√ßimi
                    const ocrEngine = localStorage.getItem('ocr_engine') || 'ocrspace';
                    console.log('üîß OCR motoru:', ocrEngine);
                    
                    // ADIM 1: T√ºm b√∂lgeleri kƒ±rp ve hazƒ±rla
                    console.log('üì¶ ADIM 1: T√ºm b√∂lgeler kƒ±rpƒ±lƒ±yor...');
                    showToast('üì¶ T√ºm b√∂lgeler hazƒ±rlanƒ±yor...', 'info', 2000);
                    
                    const regionsToProcess = [];
                    
                    for (let i = 0; i < template.regions.length; i++) {
                        const region = template.regions[i];
                        
                        if (region.type !== 'value' || !region.propertyName) {
                            console.log(`‚è≠Ô∏è B√∂lge ${i+1} atlandƒ± (label veya isim yok)`);
                            continue;
                        }
                        
                        // B√∂lge koordinatlarƒ±nƒ± √∂l√ßeklendir
                        const x = Math.round(region.x * scaleX);
                        const y = Math.round(region.y * scaleY);
                        const width = Math.round(region.width * scaleX);
                        const height = Math.round(region.height * scaleY);
                        
                        console.log(`üìê B√∂lge ${i+1}/${template.regions.length}: ${region.propertyName} (${x},${y},${width}x${height})`);
                        
                        // Minimum boyut kontrol√º kaldƒ±rƒ±ldƒ± - b√ºy√ºtme her durumda yapƒ±lacak
                        // Azure ve OCR.space i√ßin k√º√ß√ºk b√∂lgeler otomatik b√ºy√ºt√ºlecek
                        
                        // Canvas'tan bu b√∂lgeyi kƒ±rp
                        const croppedCanvas = document.createElement('canvas');
                        croppedCanvas.width = width;
                        croppedCanvas.height = height;
                        const croppedCtx = croppedCanvas.getContext('2d');
                        
                        croppedCtx.drawImage(
                            canvas,
                            x, y, width, height,
                            0, 0, width, height
                        );
                        
                        // ‚ú® YENƒ∞: G√∂r√ºnt√º kalitesini artƒ±r (OCR i√ßin optimize et)
                        const enhancedCanvas = enhanceImageForOCR(croppedCanvas);
                        
                        // Azure i√ßin minimum boyut kontrol√º ve upscaling
                        let finalImageData;
                        if (ocrEngine === 'azure') {
                            // Azure i√ßin daha agresif b√ºy√ºtme: minimum 150x150px hedefle
                            const targetSize = 150; // Azure i√ßin ideal boyut
                            let scaleFactor = 1;
                            
                            if (width < targetSize || height < targetSize) {
                                const scaleW = width < targetSize ? targetSize / width : 1;
                                const scaleH = height < targetSize ? targetSize / height : 1;
                                scaleFactor = Math.max(scaleW, scaleH);
                                
                                const scaledCanvas = document.createElement('canvas');
                                scaledCanvas.width = Math.ceil(width * scaleFactor);
                                scaledCanvas.height = Math.ceil(height * scaleFactor);
                                const scaledCtx = scaledCanvas.getContext('2d');
                                
                                scaledCtx.imageSmoothingEnabled = true;
                                scaledCtx.imageSmoothingQuality = 'high';
                                
                                scaledCtx.drawImage(
                                    enhancedCanvas,
                                    0, 0, width, height,
                                    0, 0, scaledCanvas.width, scaledCanvas.height
                                );
                                
                                finalImageData = scaledCanvas.toDataURL('image/png');
                                console.log(`   üìè Azure b√ºy√ºtme: ${width}x${height} ‚Üí ${scaledCanvas.width}x${scaledCanvas.height}px (${scaleFactor.toFixed(1)}x)`);
                            } else {
                                finalImageData = enhancedCanvas.toDataURL('image/png');
                            }
                        } else {
                            // OCR.space i√ßin 2.5x b√ºy√ºtme (k√º√ß√ºk b√∂lgeler i√ßin)
                            if (width < 150 || height < 60) { // Daha liberal limit: 150x60px altƒ±ndaki her ≈üeyi b√ºy√ºt
                                const scaleFactor = 2.5; // 2.5x b√ºy√ºt
                                const scaledCanvas = document.createElement('canvas');
                                scaledCanvas.width = Math.ceil(width * scaleFactor);
                                scaledCanvas.height = Math.ceil(height * scaleFactor);
                                const scaledCtx = scaledCanvas.getContext('2d');
                                
                                scaledCtx.imageSmoothingEnabled = true;
                                scaledCtx.imageSmoothingQuality = 'high';
                                
                                scaledCtx.drawImage(
                                    enhancedCanvas,
                                    0, 0, width, height,
                                    0, 0, scaledCanvas.width, scaledCanvas.height
                                );
                                
                                finalImageData = scaledCanvas.toDataURL('image/png');
                                console.log(`   üìè OCR.space b√ºy√ºtme: ${width}x${height} ‚Üí ${scaledCanvas.width}x${scaledCanvas.height}px (2.5x)`);
                            } else {
                                finalImageData = enhancedCanvas.toDataURL('image/png');
                            }
                        }
                        
                        regionsToProcess.push({
                            propertyName: region.propertyName,
                            imageData: finalImageData,
                            index: i + 1
                        });
                    }
                    
                    console.log(`‚úÇÔ∏è ${regionsToProcess.length} b√∂lge hazƒ±r!\n`);
                    
                    // ADIM 2: T√ºm b√∂lgeleri SIRALI olarak OCR'a g√∂nder (Rate Limit korumasƒ±)
                    console.log('üöÄ ADIM 2: T√ºm b√∂lgeler SIRALI OCR\'a g√∂nderiliyor (Rate Limit korumasƒ±)...');
                    showToast(`üöÄ ${regionsToProcess.length} b√∂lge sƒ±ralƒ± taranƒ±yor...`, 'info', 3000);
                    
                    const results = [];
                    
                    // Sequential processing with delay (Rate Limit korumasƒ±)
                    for (let i = 0; i < regionsToProcess.length; i++) {
                        const region = regionsToProcess[i];
                        
                        try {
                            let ocrText = '';
                            
                            if (ocrEngine === 'azure') {
                                console.log(`üîµ [${region.index}] ${region.propertyName} - Azure OCR ba≈ülatƒ±ldƒ±`);
                                const azureResult = await performAzureOCR(region.imageData);
                                ocrText = azureResult?.text || '';
                            } else {
                                console.log(`üü¢ [${region.index}/${regionsToProcess.length}] ${region.propertyName} - OCR.space ba≈ülatƒ±ldƒ±`);
                                ocrText = await performOCRSpaceOCR(region.imageData);
                            }
                            
                            // Temizle
                            let cleanText = ocrText.trim().replace(/\s+/g, ' ');
                            cleanText = cleanText.replace(/(\d+)\.\s+(\d+)/g, '$1.$2');
                            
                            console.log(`‚úÖ [${region.index}/${regionsToProcess.length}] ${region.propertyName}: "${cleanText}"`);
                            
                            results.push({
                                propertyName: region.propertyName,
                                value: cleanText
                            });
                            
                            // Rate Limit korumasƒ±: Her istek arasƒ±nda 600ms bekle (free tier: 10/dakika)
                            if (i < regionsToProcess.length - 1) {
                                console.log('‚è≥ Rate limit korumasƒ± - 600ms bekleniyor...');
                                await new Promise(resolve => setTimeout(resolve, 600));
                            }
                            
                        } catch (error) {
                            console.error(`‚ùå [${region.index}] ${region.propertyName} OCR hatasƒ±:`, error.message);
                            results.push({
                                propertyName: region.propertyName,
                                value: '',
                                error: true
                            });
                        }
                    }
                    
                    // Sonu√ßlarƒ± properties objesine d√∂n√º≈üt√ºr
                    const properties = {};
                    let successCount = 0;
                    let errorCount = 0;
                    
                    results.forEach(result => {
                        if (result.value) {
                            properties[result.propertyName] = result.value;
                            successCount++;
                        } else if (result.error) {
                            errorCount++;
                        }
                    });
                    
                    console.log(`\n‚úÖ SEQUENTIAL OCR TAMAMLANDI: ${successCount} ba≈üarƒ±lƒ±, ${errorCount} hata`);
                    showToast(`‚úÖ ${successCount} √∂zellik okundu ${errorCount > 0 ? `(${errorCount} hata)` : ''}`, 'success');
                    resolve(properties);
                    
                } catch (error) {
                    console.error('‚ùå Template OCR hatasƒ±:', error);
                    showToast('‚ùå Template OCR hatasƒ±', 'error');
                    reject(error);
                }
            });
        }
        
        async function extractCOAProperties(fileData) {
            console.log('üöÄ extractCOAProperties fonksiyonu √ßaƒürƒ±ldƒ±');
            
            // Template se√ßili mi kontrol et
            const selectedTemplate = window.currentTemplate;
            if (selectedTemplate) {
                console.log('üé® Template kullanƒ±larak OCR yapƒ±lacak:', selectedTemplate.supplier);
                return extractCOAPropertiesWithTemplate(fileData, selectedTemplate);
            }
            
            return new Promise(async (resolve, reject) => {
                try {
                    if (!fileData) {
                        console.error('‚ùå fileData bo≈ü!');
                        reject(new Error('Dosya verisi bulunamadƒ±'));
                        return;
                    }
                    
                    console.log('üìÑ Dosya tipi:', fileData.substring(0, 50));
                    console.log('üìä Dosya boyutu:', Math.round(fileData.length / 1024), 'KB');
                    
                    // PDF ise √∂nce canvas'a √ßevir (orijinal dosyayƒ± etkilemeden)
                    let imageData = fileData;
                    if (fileData.startsWith('data:application/pdf')) {
                        console.log('üìÑ PDF tespit edildi, resme d√∂n√º≈üt√ºr√ºl√ºyor...');
                        showToast('üìÑ PDF resme d√∂n√º≈üt√ºr√ºl√ºyor...', 'info');
                        try {
                            // PDF'i canvas'a √ßevir
                            const base64Data = fileData.split(',')[1];
                            const binaryData = atob(base64Data);
                            const uint8Array = new Uint8Array(binaryData.length);
                            for (let i = 0; i < binaryData.length; i++) {
                                uint8Array[i] = binaryData.charCodeAt(i);
                            }
                            
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            const pdf = await pdfjsLib.getDocument({ data: uint8Array }).promise;
                            const page = await pdf.getPage(1); // ƒ∞lk sayfa
                            
                            // OCR engine'e g√∂re scale ayarla
                            const ocrEngine = localStorage.getItem('ocr_engine') || 'ocrspace';
                            let scale = 5.0; // Varsayƒ±lan: ultra y√ºksek kalite
                            
                            // OCR.space i√ßin dosya boyutu limiti var (1 MB), scale'i d√º≈ü√ºr
                            if (ocrEngine === 'ocrspace') {
                                scale = 2.0; // Daha d√º≈ü√ºk scale = daha k√º√ß√ºk dosya (genelde 300-600 KB)
                                console.log('üîß OCR.space i√ßin scale=2.0 kullanƒ±lƒ±yor (dosya boyutu optimizasyonu)');
                            } else {
                                scale = 5.0; // Azure i√ßin y√ºksek kalite
                                console.log('üîß Azure i√ßin scale=5.0 kullanƒ±lƒ±yor (maksimum kalite)');
                            }
                            
                            const viewport = page.getViewport({ scale: scale });
                            const canvas = document.createElement('canvas');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            const ctx = canvas.getContext('2d');
                            
                            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                            imageData = canvas.toDataURL('image/png');
                            console.log(`‚úÖ PDF resme d√∂n√º≈üt√ºr√ºld√º (scale=${scale})`);
                        } catch (pdfError) {
                            console.error('‚ùå PDF d√∂n√º≈üt√ºrme hatasƒ±:', pdfError);
                            showToast('‚ùå PDF okunamadƒ±', 'error');
                            reject(pdfError);
                            return;
                        }
                    }
                    
                    // OCR engine se√ßimi
                    const ocrEngine = localStorage.getItem('ocr_engine') || 'ocrspace';
                    console.log('üîß Se√ßili OCR motoru:', ocrEngine);
                    
                    let text = '';
                    let lines = []; // Azure i√ßin satƒ±r dizisi
                    let words = []; // Azure words (koordinatlarƒ±yla)
                    let ocrSuccess = false;
                    
                    // OCR motoruna g√∂re i≈ülem yap
                    if (ocrEngine === 'azure') {
                        // Sadece Azure kullan
                        try {
                            console.log('üîµ Azure OCR kullanƒ±lƒ±yor...');
                            const azureResult = await performAzureOCR(imageData);
                            text = azureResult.text;
                            lines = azureResult.lines;
                            words = azureResult.words || [];
                            ocrSuccess = true;
                        } catch (azureError) {
                            console.error('‚ùå Azure OCR hatasƒ±:', azureError);
                            showToast('‚ùå Azure OCR hatasƒ±: ' + azureError.message, 'error');
                            reject(azureError);
                            return;
                        }
                    } else if (ocrEngine === 'both') {
                        // ƒ∞kisini de dene, hangisi daha fazla √∂zellik bulursa onu kullan
                        console.log('üîÑ Her iki OCR motoru da denenecek...');
                        
                        let ocrSpaceText = '';
                        let azureResult = null;
                        
                        // Dosya boyutunu kontrol et (OCR.space limit: 1 MB)
                        const imageSizeKB = Math.round((imageData.length * 3) / 4 / 1024); // Base64 ‚Üí KB
                        console.log(`üìè Image boyutu: ${imageSizeKB} KB`);
                        
                        // OCR.space dene (sadece dosya <1MB ise)
                        if (imageSizeKB <= 1024) {
                            try {
                                console.log('1Ô∏è‚É£ OCR.space deneniyor...');
                                ocrSpaceText = await performOCRSpaceOCR(imageData);
                                console.log('‚úÖ OCR.space tamamlandƒ±:', ocrSpaceText.length, 'karakter');
                            } catch (ocrSpaceError) {
                                console.warn('‚ö†Ô∏è OCR.space ba≈üarƒ±sƒ±z:', ocrSpaceError.message);
                            }
                        } else {
                            console.log('‚è≠Ô∏è OCR.space atlandƒ± (dosya √ßok b√ºy√ºk:', imageSizeKB, 'KB > 1024 KB)');
                        }
                        
                        // Azure dene
                        try {
                            console.log('2Ô∏è‚É£ Azure deneniyor...');
                            azureResult = await performAzureOCR(imageData);
                            console.log('‚úÖ Azure tamamlandƒ±:', azureResult.text.length, 'karakter');
                        } catch (azureError) {
                            console.warn('‚ö†Ô∏è Azure ba≈üarƒ±sƒ±z:', azureError.message);
                        }
                        
                        // Hangisi daha uzun sonu√ß verdi? (genelde daha fazla √∂zellik demektir)
                        if (azureResult && azureResult.text.length > ocrSpaceText.length) {
                            console.log('üèÜ Azure daha iyi sonu√ß verdi');
                            text = azureResult.text;
                            lines = azureResult.lines;
                            ocrSuccess = true;
                        } else if (ocrSpaceText.length > 0) {
                            console.log('üèÜ OCR.space daha iyi sonu√ß verdi');
                            text = ocrSpaceText;
                            lines = []; // OCR.space satƒ±r dizisi yok
                            ocrSuccess = true;
                        } else {
                            throw new Error('Her iki OCR motoru da ba≈üarƒ±sƒ±z oldu');
                        }
                    } else {
                        // Varsayƒ±lan: OCR.space kullan
                        try {
                            console.log('üü¢ OCR.space kullanƒ±lƒ±yor...');
                            text = await performOCRSpaceOCR(imageData);
                            lines = []; // OCR.space satƒ±r dizisi yok
                            ocrSuccess = true;
                        } catch (ocrSpaceError) {
                            console.error('‚ùå OCR.space hatasƒ±:', ocrSpaceError);
                            showToast('‚ùå OCR.space hatasƒ±: ' + ocrSpaceError.message, 'error');
                            reject(ocrSpaceError);
                            return;
                        }
                    }
                    
                    if (!ocrSuccess || !text) {
                        throw new Error('OCR metni alƒ±namadƒ±');
                    }
                    
                    console.log('üìù OCR Text uzunluƒüu:', text.length, 'karakter');
                    
                    // √ñzellikleri parse et
                    const properties = {};
                    
                    // ========================================
                    // BASF FORMAT DETECTION & COMPLIANCE CHECK
                    // ========================================
                    const isBASFFormat = /Pruefmerkmale|Pruefergebnis|Requirement/i.test(text) && 
                                        /Certificate of Analysis|Certificate of Compliance|BASF/i.test(text);
                    
                    if (isBASFFormat) {
                        console.log('üî∑ BASF format detected - Using compliance check system');
                        
                        // BASF property patterns (DE + aliases)
                        const basfPatterns = [
                            { name: 'Materialdichte', aliases: ['density', 'dichte', 'dansite'], tdsProp: 'Density' },
                            { name: 'Stempeldruckkraft', aliases: ['hardness', 'sertlik', 'druckkraft'], tdsProp: 'Sertlik' },
                            { name: 'Brandverhalten', aliases: ['fire', 'flammability', 'yanma'], tdsProp: 'Fire Behavior' },
                            { name: 'W√§rmeleitf√§higkeit', aliases: ['thermal conductivity', 'ƒ±sƒ± iletkenliƒüi'], tdsProp: 'Thermal Conductivity' },
                            { name: 'Emission', aliases: ['emission', 'voc', 'emisyon'], tdsProp: 'VOC Emission' }
                        ];
                        
                        // Find header to determine column order
                        let pruefergebnisCol = -1;
                        let requirementCol = -1;
                        
                        const headerMatch = text.match(/Pruefmerkmale[\s\S]{0,200}?(Pruefergebnis|Test\s+Result)[\s\S]{0,200}?(Requirement|Standard)/i);
                        if (headerMatch) {
                            // Detect column positions from header
                            const headerStart = headerMatch.index;
                            const headerChunk = text.substring(headerStart, headerStart + 300);
                            const headerLines = headerChunk.split(/[\n\r]+/);
                            
                            for (let line of headerLines) {
                                const parts = line.split(/[\t]+/);
                                for (let i = 0; i < parts.length; i++) {
                                    if (/Pruefergebnis|Test Result/i.test(parts[i])) {
                                        pruefergebnisCol = i;
                                    }
                                    if (/Requirement|Standard/i.test(parts[i])) {
                                        requirementCol = i;
                                    }
                                }
                                if (pruefergebnisCol > -1 && requirementCol > -1) break;
                            }
                            
                            console.log(`üìç Detected columns: Pruefergebnis=${pruefergebnisCol}, Requirement=${requirementCol}`);
                        }
                        
                        // Parse BASF table structure
                        for (const pattern of basfPatterns) {
                            const regex = new RegExp(pattern.name, 'i');
                            const match = text.match(regex);
                            
                            if (match) {
                                const idx = match.index;
                                
                                // Extract surrounding context (before and after property name)
                                const contextBefore = text.substring(Math.max(0, idx - 100), idx);
                                const contextAfter = text.substring(idx, idx + 400);
                                
                                console.log(`\nüîç Searching for "${pattern.name}"...`);
                                console.log(`  Context: ...${contextBefore.slice(-50)}[MATCH]${contextAfter.slice(0, 100)}...`);
                                
                                // Find the line containing the property name AND the next line (for Azure OCR)
                                const lines = (contextBefore + contextAfter).split(/[\n\r]+/).map(l => l.trim()).filter(l => l);
                                let propertyLine = '';
                                let propertyLineIndex = -1;
                                
                                for (let i = 0; i < lines.length; i++) {
                                    if (lines[i].toLowerCase().includes(pattern.name.toLowerCase())) {
                                        propertyLine = lines[i];
                                        propertyLineIndex = i;
                                        break;
                                    }
                                }
                                
                                if (!propertyLine) {
                                    console.log(`‚ö†Ô∏è Property line not found for ${pattern.name}`);
                                    continue;
                                }
                                
                                console.log(`  üìù Full line: "${propertyLine}"`);
                                
                                // Split the property line by TAB or multiple spaces
                                let parts = propertyLine.split(/[\t]+/).map(p => p.trim()).filter(p => p);
                                
                                console.log(`  üîß TAB split ‚Üí ${parts.length} parts:`, parts);
                                
                                // If TAB split didn't work well, try multiple spaces (2+)
                                if (parts.length < 2) {
                                    parts = propertyLine.split(/\s{2,}/).map(p => p.trim()).filter(p => p);
                                    console.log(`  üîß Space split ‚Üí ${parts.length} parts:`, parts);
                                }
                                
                                let testResult = '';
                                let requirement = '';
                                
                                // Skip if first part doesn't contain property name (wrong line)
                                if (parts.length > 0) {
                                    const firstPartLower = parts[0].toLowerCase();
                                    const patternNameLower = pattern.name.toLowerCase().substring(0, Math.min(8, pattern.name.length));
                                    
                                    if (!firstPartLower.includes(patternNameLower)) {
                                        console.log(`  ‚ö†Ô∏è First column "${parts[0]}" doesn't match property name, skipping`);
                                        continue;
                                    }
                                }
                                
                                // Check if values are on the same line or next line
                                let hasValuesOnSameLine = false;
                                
                                // Use detected column positions or fallback
                                if (pruefergebnisCol > -1 && requirementCol > -1 && parts.length > Math.max(pruefergebnisCol, requirementCol)) {
                                    // Use column positions from header
                                    testResult = parts[pruefergebnisCol] || '';
                                    requirement = parts[requirementCol] || '';
                                    hasValuesOnSameLine = true;
                                    console.log(`  ‚úÖ Using header columns: Pruefergebnis[${pruefergebnisCol}]="${testResult}", Requirement[${requirementCol}]="${requirement}"`);
                                } else if (parts.length >= 3) {
                                    // Fallback: col 0 = property name, col 1 = test result, col 2 = requirement
                                    testResult = parts[1] || '';
                                    requirement = parts[2] || '';
                                    hasValuesOnSameLine = true;
                                    console.log(`  ‚úÖ Using fallback: parts[1]="${testResult}", parts[2]="${requirement}"`);
                                } else if (parts.length === 2) {
                                    // Only 2 columns: col 0 = property, col 1 = either result or requirement
                                    // Assume it's the test result
                                    testResult = parts[1] || '';
                                    hasValuesOnSameLine = true;
                                    console.log(`  ‚ö†Ô∏è Only 2 parts: parts[1]="${testResult}"`);
                                }
                                
                                // If no values on same line (Azure OCR case), check next line
                                if (!hasValuesOnSameLine || (!testResult && !requirement)) {
                                    console.log(`  üîç No values on same line, checking next line...`);
                                    
                                    if (propertyLineIndex >= 0 && propertyLineIndex + 1 < lines.length) {
                                        const nextLine = lines[propertyLineIndex + 1];
                                        console.log(`  üìù Next line: "${nextLine}"`);
                                        
                                        // Try to extract value from next line
                                        // BASF format: values are often like "7,5 - 10,5 kg/m3" or "‚â• 45 N" or "B1 schwerentflammbar"
                                        const valueLine = nextLine.trim();
                                        
                                        // If the line looks like a value (has numbers, operators, or classification text)
                                        if (/[\d,\-\s]+|‚â•|‚â§|>=|<=|[A-Z]\d+|schwerentflammbar|flammability|Class/i.test(valueLine)) {
                                            testResult = valueLine;
                                            requirement = valueLine;  // Same value for both (BASF format)
                                            console.log(`  ‚úÖ Values from next line: "${valueLine}"`);
                                        }
                                    }
                                }
                                
                                if (testResult || requirement) {
                                    // Fix OCR errors and clean lambda symbol for thermal conductivity
                                    if (propertyLine.includes('W/mK') || propertyLine.includes('W/mk') || 
                                        testResult.includes('W/mK') || requirement.includes('W/mK')) {
                                        // Remove lambda symbols (Œª, Œª10, etc.) from both testResult and requirement
                                        const removeLambda = (str) => {
                                            return str
                                                .replace(/^(Œª|Œõ)(\d+)?\s*/gi, '')  // Remove lambda at start
                                                .replace(/\s+(Œª|Œõ)(\d+)?\s+/gi, ' ')  // Remove lambda in middle
                                                .replace(/\s+(Œª|Œõ)(\d+)?$/gi, '')  // Remove lambda at end
                                                .replace(/^(110|A10|l10|L10)\s*/i, '')  // Remove OCR errors
                                                .replace(/\.(\s+)/g, '.')  // Nokta sonrasƒ± bo≈üluk temizle: "0. 035" -> "0.035"
                                                .replace(/\.+/g, '.')  // Birden fazla nokta: "0.0.35" -> "0.035"
                                                .trim();
                                        };
                                        
                                        testResult = removeLambda(testResult);
                                        requirement = removeLambda(requirement);
                                        
                                        console.log(`  üîß Lambda removed - Result: "${testResult}", Req: "${requirement}"`);
                                    }
                                    
                                    console.log(`  üìä Test Result: "${testResult}"`);
                                    console.log(`  üìã Requirement: "${requirement}"`);
                                    
                                    // Check compliance
                                    const compliance = checkCompliance(testResult, requirement);
                                    console.log(`  ${compliance === 'Uygun' ? '‚úÖ' : '‚ùå'} Compliance: ${compliance}`);
                                    
                                    // Store in properties with compliance status
                                    properties[pattern.tdsProp] = {
                                        value: testResult,  // COA deƒüeri (0.035 gibi)
                                        requirement: requirement,  // Requirement (‚â§ 0.035 W/mK gibi)
                                        compliance: compliance
                                    };
                                    
                                    // Also store under aliases for TDS matching
                                    for (const alias of pattern.aliases) {
                                        properties[alias] = properties[pattern.tdsProp];
                                    }
                                }
                            }
                        }
                        
                        console.log('üìä BASF properties extracted:', properties);
                        
                        // BASF i√ßin Azure word coordinates ile parse et (daha doƒüru)
                        if (Object.keys(properties).length === 0 && words && words.length > 0) {
                            console.log('üî∑ BASF Azure word coordinates kullanƒ±lƒ±yor...');
                            console.log('üì¶ Toplam kelime sayƒ±sƒ±:', words.length);
                            
                            // "Requirement" veya "Pruefergebnis" ba≈ülƒ±ƒüƒ±nƒ±n x koordinatƒ±nƒ± bul
                            let requirementColX = null;
                            let headerY = null;
                            let leftColMaxX = 0;  // Sol s√ºtunun en saƒü noktasƒ±
                            
                            for (let i = 0; i < words.length; i++) {
                                const word = words[i];
                                if (/Requirement/i.test(word.text)) {
                                    requirementColX = word.x;
                                    headerY = word.y;
                                    console.log(`‚úÖ Requirement ba≈ülƒ±ƒüƒ± bulundu: x=${requirementColX}, y=${headerY}, text="${word.text}"`);
                                    break;
                                }
                            }
                            
                            // Alternatif: "Pruefergebnis" ba≈ülƒ±ƒüƒ±nƒ± bul
                            if (!requirementColX) {
                                for (let i = 0; i < words.length; i++) {
                                    const word = words[i];
                                    if (/Pruefergebnis/i.test(word.text)) {
                                        requirementColX = word.x;
                                        headerY = word.y;
                                        console.log(`‚úÖ Pruefergebnis ba≈ülƒ±ƒüƒ± bulundu: x=${requirementColX}, y=${headerY}, text="${word.text}"`);
                                        break;
                                    }
                                }
                            }
                            
                            // Sol s√ºtunun maksimum X deƒüerini bul (property a√ßƒ±klamalarƒ±nƒ±n bittiƒüi nokta)
                            for (let i = 0; i < words.length; i++) {
                                const word = words[i];
                                if (/Pruefmerkmale|Test criteria/i.test(word.text)) {
                                    leftColMaxX = word.x + 350;  // Property a√ßƒ±klamalarƒ± i√ßin geni≈ülik
                                    console.log(`üìè Sol s√ºtun geni≈üliƒüi: 0 - ${leftColMaxX}`);
                                    break;
                                }
                            }
                            
                            // Eƒüer leftColMaxX bulunamadƒ±ysa, requirementColX'in solundaki alan olarak hesapla
                            if (leftColMaxX === 0 && requirementColX !== null) {
                                leftColMaxX = requirementColX - 50;
                                console.log(`üìè Sol s√ºtun geni≈üliƒüi (hesaplama): 0 - ${leftColMaxX}`);
                            }
                            
                            if (requirementColX !== null && headerY !== null) {
                                console.log(`üìä Requirement s√ºtunu X ba≈ülangƒ±cƒ±: ${requirementColX}`);
                                console.log(`üìä Ba≈ülƒ±k Y: ${headerY}, data ba≈ülangƒ±cƒ±: ${headerY + 20}`);
                                
                                // BASF property patterns
                                const basfCoordPatterns = [
                                    { name: 'Materialdichte', key: 'Density' },
                                    { name: 'Stempeldruckkraft', key: 'Sertlik' },
                                    { name: 'Brandverhalten', key: 'Fire Behavior' },
                                    { name: 'W√§rmeleitf√§higkeit', key: 'Thermal Conductivity' },
                                    { name: 'Emission', key: 'VOC Emission' }
                                ];
                                
                                for (const pattern of basfCoordPatterns) {
                                    console.log(`\nüîç BASF Azure: "${pattern.name}" aranƒ±yor...`);
                                    
                                    // Find property name Y coordinate (sol s√ºtunda)
                                    let propertyY = null;
                                    let propertyX = null;
                                    
                                    for (let i = 0; i < words.length; i++) {
                                        const word = words[i];
                                        // Property name should be in left column (X < requirementColX - 100)
                                        if (word.text.toLowerCase().includes(pattern.name.toLowerCase()) && 
                                            word.x < requirementColX - 100 &&
                                            word.y > headerY + 20) {  // Below header
                                            propertyY = word.y;
                                            propertyX = word.x;
                                            console.log(`  ‚úÖ Property "${pattern.name}" bulundu: x=${propertyX}, y=${propertyY}`);
                                            break;
                                        }
                                    }
                                    
                                    if (propertyY !== null) {
                                        // BASF table: Value is on SAME line in Requirement column (right side)
                                        // NOT below, but on the RIGHT side at same Y coordinate
                                        let valueWords = [];
                                        const yTolerance = 10;  // Same line tolerance
                                        const xMin = requirementColX;  // Requirement column ba≈ülangƒ±cƒ± (tam olarak)
                                        const xMax = requirementColX + 500;  // Requirement column sonu
                                        
                                        console.log(`  üîç AYNI SATIRDA deƒüer aranƒ±yor: Y=${propertyY}¬±${yTolerance}, X=${xMin}-${xMax} (requirement s√ºtunu)`);
                                        
                                        for (let i = 0; i < words.length; i++) {
                                            const word = words[i];
                                            const yDiff = Math.abs(word.y - propertyY);
                                            const inXRange = word.x >= xMin && word.x <= xMax;
                                            
                                            if (yDiff <= yTolerance && inXRange) {
                                                valueWords.push(word);
                                                console.log(`    üìù Requirement kelimesi: "${word.text}" (x=${word.x}, y=${word.y}, yDiff=${yDiff})`);
                                            }
                                        }
                                        
                                        // Eƒüer aynƒ± satƒ±rda deƒüer yoksa, altƒ±ndaki satƒ±ra bak
                                        if (valueWords.length === 0) {
                                            console.log(`  üîç Aynƒ± satƒ±rda deƒüer yok, ALTINDAKƒ∞ satƒ±ra bakƒ±lƒ±yor...`);
                                            
                                            const yMin = propertyY + 5;
                                            const yMax = propertyY + 40;
                                            
                                            for (let i = 0; i < words.length; i++) {
                                                const word = words[i];
                                                const inYRange = word.y >= yMin && word.y <= yMax;
                                                const inXRange = word.x >= xMin && word.x <= xMax;
                                                
                                                if (inYRange && inXRange) {
                                                    valueWords.push(word);
                                                    console.log(`    üìù Alt satƒ±rdan kelime: "${word.text}" (x=${word.x}, y=${word.y})`);
                                                }
                                            }
                                        }
                                        
                                        if (valueWords.length > 0) {
                                            // Sort by Y first (line by line), then X (left to right)
                                            valueWords.sort((a, b) => {
                                                const yDiff = a.y - b.y;
                                                if (Math.abs(yDiff) < 5) {  // Same line
                                                    return a.x - b.x;
                                                }
                                                return yDiff;
                                            });
                                            
                                            // Take only words from first line (closest to property)
                                            const firstLineY = valueWords[0].y;
                                            const firstLineWords = valueWords.filter(w => Math.abs(w.y - firstLineY) < 5);
                                            
                                            let requirement = firstLineWords.map(w => w.text).join(' ');
                                            
                                            console.log(`  ‚úÖ Ham requirement (ilk satƒ±r): "${requirement}"`);
                                            
                                            // Clean lambda symbols and OCR errors for thermal conductivity
                                            if (requirement.includes('W/mK') || requirement.includes('W/mk')) {
                                                requirement = requirement
                                                    .replace(/^(Œª|Œõ|A10|l10|L10|110)\s*/gi, '')
                                                    .replace(/\s+(Œª|Œõ)\d*\s*/gi, ' ')
                                                    .replace(/Œª\d*/gi, '')
                                                    .trim();
                                                console.log(`  üßπ Lambda temizlendi: "${requirement}"`);
                                            }
                                            
                                            // Check compliance
                                            const compliance = checkCompliance(requirement, requirement);
                                            console.log(`  ${compliance === 'Uygun' ? '‚úÖ' : '‚ùå'} Uygunluk: ${compliance}`);
                                            
                                            // Store property
                                            properties[pattern.key] = {
                                                value: requirement,
                                                requirement: requirement,
                                                compliance: compliance
                                            };
                                            
                                            // Store under aliases
                                            const aliases = {
                                                'Density': ['density', 'dichte', 'dansite'],
                                                'Sertlik': ['hardness', 'sertlik', 'druckkraft'],
                                                'Fire Behavior': ['fire', 'flammability', 'yanma'],
                                                'Thermal Conductivity': ['thermal conductivity', 'ƒ±sƒ± iletkenliƒüi'],
                                                'VOC Emission': ['emission', 'voc', 'emisyon']
                                            };
                                            
                                            if (aliases[pattern.key]) {
                                                for (const alias of aliases[pattern.key]) {
                                                    properties[alias] = properties[pattern.key];
                                                }
                                            }
                                        } else {
                                            console.log(`  ‚ö†Ô∏è Requirement s√ºtununda deƒüer bulunamadƒ±`);
                                        }
                                    } else {
                                        console.log(`  ‚ö†Ô∏è Property "${pattern.name}" bulunamadƒ±`);
                                    }
                                }
                                
                                console.log('\nüìä BASF Azure parsing sonucu:', properties);
                            } else {
                                console.log('‚ö†Ô∏è Requirement s√ºtunu ba≈ülƒ±ƒüƒ± bulunamadƒ±');
                            }
                        }
                        
                        // BASF i√ßin properties dolu, diƒüer parsing'leri atla
                        if (Object.keys(properties).length > 0) {
                            console.log('‚úÖ BASF parsing ba≈üarƒ±lƒ±, diƒüer y√∂ntemler atlanƒ±yor');
                        }
                    }
                    
                    // Azure words varsa koordinatlarla parse et (EN DOƒûRU Y√ñNTEM)
                    // (Sadece BASF format deƒüilse VE properties bo≈üsa)
                    if (!isBASFFormat && Object.keys(properties).length === 0 && words && words.length > 0) {
                        console.log('üéØ Azure word koordinatlarƒ± kullanƒ±lƒ±yor...');
                        console.log('üì¶ Toplam kelime:', words.length);
                        
                        // "TEST RESULT" ba≈ülƒ±ƒüƒ±nƒ±n x koordinatƒ±nƒ± bul
                        let testResultX = null;
                        for (let i = 0; i < words.length; i++) {
                            const word = words[i];
                            if (word.text.toUpperCase().includes('RESULT') || 
                                word.text.toUpperCase().includes('SONU√á') ||
                                word.text.toUpperCase().includes('TEST')) {
                                testResultX = word.x;
                                console.log(`‚úÖ TEST RESULT s√ºtunu bulundu, x = ${testResultX}, word: "${word.text}"`);
                                break;
                            }
                        }
                        
                        if (testResultX === null) {
                            console.warn('‚ö†Ô∏è TEST RESULT ba≈ülƒ±ƒüƒ± bulunamadƒ±, fallback mode');
                        } else {
                            // Her √∂zellik i√ßin TEST RESULT s√ºtunundaki deƒüeri bul
                            const propertyPatterns = [
                                { tr: 'Dansite', en: 'DENSITY', key: 'Density' },
                                { tr: 'Sertlik', en: 'HARDNESS', key: 'Sertlik' },
                                { tr: 'Kopma Direnci', en: 'TENSILE', key: 'Kopma Direnci' },
                                { tr: 'Kopma Uzama', en: 'ELONGATION', key: 'Kopma Uzama' },
                                { tr: 'Elastikiyet', en: 'RESILIENCE', key: 'Elastikiyet' },
                                { tr: 'Deformasyon', en: 'COMPRESSION', key: 'Deformasyon' }
                            ];
                            
                            for (const pattern of propertyPatterns) {
                                // Bu √∂zelliƒüin y koordinatƒ±nƒ± bul
                                let propertyY = null;
                                for (let i = 0; i < words.length; i++) {
                                    const word = words[i];
                                    if (word.text.includes(pattern.tr) || 
                                        word.text.toUpperCase().includes(pattern.en)) {
                                        propertyY = word.y;
                                        console.log(`üéØ ${pattern.key} bulundu, y = ${propertyY}`);
                                        break;
                                    }
                                }
                                
                                if (propertyY !== null) {
                                    // Bu satƒ±rda (y¬±20 tolerance) ve TEST RESULT s√ºtununda (x¬±50) olan sayƒ±yƒ± bul
                                    for (let i = 0; i < words.length; i++) {
                                        const word = words[i];
                                        
                                        // Aynƒ± satƒ±rda mƒ±? (y koordinatƒ± yakƒ±n)
                                        if (Math.abs(word.y - propertyY) > 30) continue;
                                        
                                        // TEST RESULT s√ºtununda mƒ±? (x koordinatƒ± yakƒ±n)
                                        if (Math.abs(word.x - testResultX) > 100) continue;
                                        
                                        // Sayƒ± mƒ±?
                                        const cleaned = word.text.replace(/,/g, '.');
                                        const value = parseFloat(cleaned);
                                        
                                        if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                            console.log(`  ‚úÖ ${pattern.key} = ${cleaned} (x=${word.x}, y=${word.y})`);
                                            properties[pattern.key] = cleaned;
                                            properties[pattern.key.toLowerCase()] = cleaned;
                                            properties[pattern.tr] = cleaned;
                                            properties[pattern.tr.toLowerCase()] = cleaned;
                                            break;
                                        }
                                    }
                                }
                            }
                            
                            console.log('üìä Koordinat bazlƒ± √ßƒ±karƒ±m tamamlandƒ±:', properties);
                        }
                    }
                    
                    // Fallback: Eski parsing (koordinat bazlƒ± ba≈üarƒ±sƒ±zsa veya OCR.space kullanƒ±lƒ±yorsa)
                    if (Object.keys(properties).length === 0) {
                        console.log('‚ö†Ô∏è Fallback parsing kullanƒ±lƒ±yor...');
                        
                        // Her √∂zellik i√ßin arama patterns (√ßoklu varyasyonlarla)
                        const propertyPatterns = [
                            { 
                                tr: 'Dansite', 
                                en: ['DENSITY', 'TOTAL WEIGHT', 'WEIGHT'], 
                                key: 'Density',
                                aliases: ['dansite', 'density', 'total weight', 'weight', 'aƒüƒ±rlƒ±k']
                            },
                            { 
                                tr: 'Sertlik', 
                                en: ['HARDNESS'], 
                                key: 'Sertlik',
                                aliases: ['sertlik', 'hardness']
                            },
                            { 
                                tr: 'Kopma Direnci', 
                                en: ['TENSILE STRENGTH', 'TENSILE STRENGHT', 'TENSILE'], 
                                key: 'Kopma Direnci',
                                aliases: ['kopma direnci', 'tensile strength', 'tensile', '√ßekme mukavemeti']
                            },
                            { 
                                tr: 'Kopma Uzama', 
                                en: ['ELONGATION AT BREAK', 'ELONGATION', 'BREAK ELONGATION'], 
                                key: 'Kopma Uzama',
                                aliases: ['kopma uzama', 'elongation', 'uzama']
                            },
                            { 
                                tr: 'Elastikiyet', 
                                en: ['RESILIENCE', 'REBOUND'], 
                                key: 'Elastikiyet',
                                aliases: ['elastikiyet', 'resilience', 'rebound']
                            },
                            { 
                                tr: 'Deformasyon', 
                                en: ['COMPRESSION SET', 'COMPRESSION'], 
                                key: 'Deformasyon',
                                aliases: ['deformasyon', 'compression set', 'compression']
                            }
                        ];
                        
                        // Azure: line-based parsing (satƒ±r satƒ±r yapƒ±landƒ±rƒ±lmƒ±≈ü)
                        if (lines.length > 0) {
                            console.log('üìã Azure line-based parsing (satƒ±r satƒ±r)');
                            console.log('üìã Toplam satƒ±r:', lines.length);
                            console.log('üìã ƒ∞lk 15 satƒ±r:', lines.slice(0, 15));
                            
                            for (const pattern of propertyPatterns) {
                                // Bu √∂zelliƒüin herhangi bir varyasyonunu i√ßeren satƒ±rƒ± bul
                                let propertyLineIndex = -1;
                                
                                for (let i = 0; i < lines.length; i++) {
                                    const line = lines[i];
                                    const lineUpper = line.toUpperCase();
                                    const lineLower = line.toLowerCase();
                                    
                                    // T√ºrk√ße adƒ± kontrol et
                                    if (line.includes(pattern.tr)) {
                                        propertyLineIndex = i;
                                        console.log(`üéØ ${pattern.key} bulundu (TR, satƒ±r ${i}): "${line}"`);
                                        break;
                                    }
                                    
                                    // ƒ∞ngilizce varyasyonlarƒ± kontrol et
                                    const enVariants = Array.isArray(pattern.en) ? pattern.en : [pattern.en];
                                    for (const enVariant of enVariants) {
                                        if (lineUpper.includes(enVariant)) {
                                            propertyLineIndex = i;
                                            console.log(`üéØ ${pattern.key} bulundu (EN: "${enVariant}", satƒ±r ${i}): "${line}"`);
                                            break;
                                        }
                                    }
                                    
                                    if (propertyLineIndex !== -1) break;
                                }
                                
                                if (propertyLineIndex === -1) {
                                    console.log(`‚ö†Ô∏è ${pattern.key} bulunamadƒ±`);
                                    continue;
                                }
                                
                                // Bu satƒ±rdan SONRA, ilk SADE SAYIYI bul (¬±, >, < i√ßermeyen)
                                let testValue = null;
                                for (let i = propertyLineIndex + 1; i < Math.min(propertyLineIndex + 8, lines.length); i++) {
                                    const line = lines[i].trim();
                                    
                                    if (!line) continue;
                                    if (/ISO\s*\d+|ASTM|SO\d+/i.test(line)) {
                                        console.log(`    ‚è≠Ô∏è Standart atlandƒ±: "${line}"`);
                                        continue;
                                    }
                                    if (/[¬±‚â§‚â•><+%()]/.test(line)) {
                                        console.log(`    ‚è≠Ô∏è Standart deƒüer atlandƒ±: "${line}"`);
                                        continue;
                                    }
                                    
                                    if (/^[\d.,]+$/.test(line)) {
                                        const cleaned = line.replace(/,/g, '.');
                                        const value = parseFloat(cleaned);
                                        
                                        if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                            testValue = cleaned;
                                            console.log(`    ‚úÖ ${pattern.key} TEST RESULT bulundu: "${line}" ‚Üí ${testValue} (satƒ±r ${i})`);
                                            break;
                                        }
                                    }
                                }
                                
                                if (testValue) {
                                    properties[pattern.key] = testValue;
                                    properties[pattern.key.toLowerCase()] = testValue;
                                    properties[pattern.tr] = testValue;
                                    properties[pattern.tr.toLowerCase()] = testValue;
                                } else {
                                    console.log(`    ‚ùå ${pattern.key} i√ßin TEST RESULT bulunamadƒ±`);
                                }
                            }
                        } 
                        // OCR.space: regex-based parsing (t√ºm text tek blok)
                        else {
                            console.log('üü¢ OCR.space regex-based parsing');
                            console.log('üìù Text uzunluƒüu:', text.length, 'karakter');
                            console.log('üìù ƒ∞lk 500 karakter:', text.substring(0, 500));
                            
                            // Check for INSPECTED VALUES format FIRST (Carcano format)
                            const inspectedMatch = text.match(/(INSPECTED VALUES|AVERAGE VALUE OF THE LOT|TEST RESULTS)/i);
                            if (inspectedMatch) {
                                console.log('üéØ INSPECTED VALUES section detected in OCR.space text');
                                const inspectedIdx = inspectedMatch.index;
                                
                                // Extract text after heading (look at next 500 chars)
                                const afterHeading = text.substring(inspectedIdx + inspectedMatch[0].length);
                                console.log('üì¶ After INSPECTED VALUES (500 chars):', afterHeading.substring(0, 500));
                                
                                // Find all clean numbers (decimal numbers only)
                                const numberMatches = afterHeading.match(/\b(\d+[.,]\d+)\b/g);
                                console.log('üîç Number matches found:', numberMatches);
                                
                                if (numberMatches && numberMatches.length >= 3) {
                                    const numbers = numberMatches.map(n => n.replace(',', '.')).slice(0, 3);
                                    console.log('üî¢ INSPECTED VALUES numbers extracted:', numbers);
                                    
                                    // Map to properties (Carcano order: Total Weight, Tensile strength, Elongation)
                                    const mappings = [
                                        { value: numbers[0], patterns: ["Density", "DENSITY", "Total Weight", "TOTAL WEIGHT", "Dansite", "DANSITE"] },
                                        { value: numbers[1], patterns: ["Tensile strength", "TENSILE STRENGTH", "Kopma Direnci", "KOPMA DIRENCI"] },
                                        { value: numbers[2], patterns: ["Elongation", "ELONGATION", "Kopma Uzama", "KOPMA UZAMA"] }
                                    ];
                                    
                                    for (let mapping of mappings) {
                                        for (let name of mapping.patterns) {
                                            properties[name] = mapping.value;
                                            properties[name.toLowerCase()] = mapping.value;
                                        }
                                        console.log(`‚úÖ ${mapping.patterns[0]} (inspected) = ${mapping.value}`);
                                    }
                                } else {
                                    console.log('‚ö†Ô∏è Not enough numbers found after INSPECTED VALUES heading');
                                }
                            }
                            
                            // If INSPECTED VALUES parser didn't work, use standard table parsing
                            if (Object.keys(properties).length === 0) {
                                console.log('üìã Using standard table format parser');
                                
                                for (const pattern of propertyPatterns) {
                                console.log(`\nüîç ${pattern.key} aranƒ±yor...`);
                                
                                // T√ºm varyasyonlarƒ± i√ßeren regex olu≈ütur
                                const enVariants = Array.isArray(pattern.en) ? pattern.en : [pattern.en];
                                const allVariants = [pattern.tr, ...enVariants];
                                const searchPattern = `(${allVariants.join('|')})`;
                                const regex = new RegExp(searchPattern, 'i');
                                const match = text.match(regex);
                                
                                if (match) {
                                    const matchIndex = match.index;
                                    console.log(`  ‚úÖ "${match[0]}" bulundu (index: ${matchIndex})`);
                                    
                                    // Bu √∂zellikten sonraki 300 karakteri al
                                    const afterProperty = text.substring(matchIndex + match[0].length, matchIndex + match[0].length + 300);
                                    console.log(`  üì¶ Chunk (${afterProperty.length} karakter):`, afterProperty.substring(0, 100));
                                    
                                    // TAB veya √ßok bo≈ülukla ayrƒ±lmƒ±≈ü kolonlarƒ± parse et
                                    // Format: Dansite\tDENSITY\tkg/m3\tISO845\t18+1,5\t17,54
                                    const parts = afterProperty.split(/[\t\n]+/).map(p => p.trim()).filter(p => p);
                                    console.log(`  üîß Parse edilen par√ßalar:`, parts);
                                    
                                    // Par√ßalardan SADE SAYILARI bul (¬±, >, <, +, % i√ßermeyenler)
                                    for (const part of parts) {
                                        // ƒ∞√ßinde ¬±, >, <, +, % varsa atla (standart deƒüer)
                                        if (/[¬±‚â§‚â•><+%()]/.test(part)) {
                                            console.log(`    ‚è≠Ô∏è Standart atlandƒ±: "${part}"`);
                                            continue;
                                        }
                                        
                                        // ISO/ASTM atla
                                        if (/ISO|ASTM|STANDARD/i.test(part)) {
                                            console.log(`    ‚è≠Ô∏è ISO/ASTM atlandƒ±: "${part}"`);
                                            continue;
                                        }
                                        
                                        // Sadece sayƒ± + virg√ºl/nokta mƒ±?
                                        if (/^\d+[.,]?\d*$/.test(part)) {
                                            const cleaned = part.replace(/,/g, '.');
                                            const value = parseFloat(cleaned);
                                            
                                            if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                                console.log(`    ‚úÖ ${pattern.key} TEST RESULT = ${cleaned}`);
                                                properties[pattern.key] = cleaned;
                                                properties[pattern.key.toLowerCase()] = cleaned;
                                                properties[pattern.tr] = cleaned;
                                                properties[pattern.tr.toLowerCase()] = cleaned;
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // Eƒüer yukarƒ±daki y√∂ntem ba≈üarƒ±sƒ±zsa, fallback: regex ile sayƒ± ara
                                    if (!properties[pattern.key]) {
                                        console.log(`  üîÑ Fallback: Regex ile sayƒ± aranƒ±yor...`);
                                        const numberMatches = afterProperty.match(/\b\d+[.,]\d+\b/g);
                                        
                                        if (numberMatches && numberMatches.length > 0) {
                                            console.log(`  üìä Bulunan sayƒ±lar:`, numberMatches);
                                            
                                            // ƒ∞lk sade sayƒ±yƒ± al
                                            for (const numStr of numberMatches) {
                                                const cleaned = numStr.replace(/,/g, '.');
                                                const value = parseFloat(cleaned);
                                                
                                                if (!isNaN(value) && value >= 0.001 && value <= 500) {
                                                    console.log(`    ‚úÖ ${pattern.key} TEST RESULT (fallback) = ${cleaned}`);
                                                    properties[pattern.key] = cleaned;
                                                    properties[pattern.key.toLowerCase()] = cleaned;
                                                    properties[pattern.tr] = cleaned;
                                                    properties[pattern.tr.toLowerCase()] = cleaned;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    console.log(`  ‚ùå "${pattern.tr}" veya "${pattern.en}" bulunamadƒ±`);
                                }
                            }
                        } // End: if (Object.keys(properties).length === 0)
                        } // End: else (OCR.space parsing)
                        
                        // √ñNEMLƒ∞: "INSPECTED VALUES" parsing - T√úM OCR MOTORLARI ƒ∞√áƒ∞N
                        // Bu format: Carcano gibi firmalarƒ±n COA'larƒ±nda kullanƒ±lƒ±r
                        // Azure veya OCR.space hi√ßbir deƒüer bulamadƒ±ysa burasƒ± √ßalƒ±≈üƒ±r
                        if (Object.keys(properties).length === 0) {
                            console.log('\nüîç INSPECTED VALUES ba≈ülƒ±ƒüƒ± aranƒ±yor...');
                            
                            // "INSPECTED VALUES" veya "AVERAGE VALUE" ba≈ülƒ±ƒüƒ±nƒ± bul
                            const inspectedMatch = text.match(/(INSPECTED VALUES|AVERAGE VALUE OF THE LOT|TEST RESULTS|MEASURED VALUES)/i);
                                
                                if (inspectedMatch) {
                                    console.log(`‚úÖ "${inspectedMatch[0]}" ba≈ülƒ±ƒüƒ± bulundu (index: ${inspectedMatch.index})!`);
                                    
                                    // Bu ba≈ülƒ±ktan sonraki 500 karakteri al (√ñNCEKƒ∞ DEƒûƒ∞L!)
                                    const startIndex = inspectedMatch.index + inspectedMatch[0].length;
                                    const inspectedChunk = text.substring(startIndex, startIndex + 500);
                                    console.log('üì¶ Inspected chunk:', inspectedChunk.substring(0, 200));
                                    
                                    // Bu chunk i√ßinde TAB-separated veya satƒ±r-separated deƒüerleri parse et
                                    const inspectedLines = inspectedChunk.split(/[\n\r]+/).map(l => l.trim()).filter(l => l);
                                    console.log('üìã Inspected lines:', inspectedLines.slice(0, 10));
                                    
                                    // T√ºm sayƒ±larƒ± topla (satƒ±r satƒ±r veya TAB-separated)
                                    const allNumbers = [];
                                    for (const line of inspectedLines) {
                                        // "Average value of the lot" gibi ba≈ülƒ±k satƒ±rlarƒ± atla
                                        if (/average|value|lot|weight|tensile|strength|elongation|total/i.test(line) && !/^\d+[.,]?\d*$/.test(line)) {
                                            continue;
                                        }
                                        
                                        // Parantez i√ßindeki birimler atla: (g/m2), (N/mm2), (%)
                                        if (/^\([^)]+\)$/.test(line)) {
                                            continue;
                                        }
                                        
                                        // TAB ile ayrƒ±lmƒ±≈ü mƒ±?
                                        if (line.includes('\t')) {
                                            const parts = line.split(/[\t]+/).map(p => p.trim());
                                            for (const part of parts) {
                                                if (/^\d+[.,]?\d*$/.test(part)) {
                                                    allNumbers.push(part);
                                                }
                                            }
                                        } 
                                        // Tek ba≈üƒ±na sayƒ± mƒ±?
                                        else if (/^\d+[.,]?\d*$/.test(line)) {
                                            allNumbers.push(line);
                                        }
                                    }
                                    
                                    console.log(`üî¢ Toplanan sayƒ±lar:`, allNumbers);
                                    
                                    if (allNumbers.length >= 2) {
                                        // ƒ∞lk 3 sayƒ±yƒ± √∂zelliklere e≈üle
                                        if (allNumbers[0]) {
                                            const val0 = allNumbers[0].replace(/,/g, '.');
                                            properties['Total Weight'] = val0;
                                            properties['total weight'] = val0;
                                            properties['Density'] = val0;
                                            properties['density'] = val0;
                                            properties['Dansite'] = val0;
                                            properties['dansite'] = val0;
                                            console.log(`  ‚úÖ Total Weight (inspected) = ${val0}`);
                                        }
                                        
                                        if (allNumbers[1]) {
                                            const val1 = allNumbers[1].replace(/,/g, '.');
                                            properties['Tensile strength'] = val1;
                                            properties['tensile strength'] = val1;
                                            properties['Kopma Direnci'] = val1;
                                            properties['kopma direnci'] = val1;
                                            console.log(`  ‚úÖ Tensile strength (inspected) = ${val1}`);
                                        }
                                        
                                        if (allNumbers[2]) {
                                            const val2 = allNumbers[2].replace(/,/g, '.');
                                            properties['Elongation'] = val2;
                                            properties['elongation'] = val2;
                                            properties['Kopma Uzama'] = val2;
                                            properties['kopma uzama'] = val2;
                                            console.log(`  ‚úÖ Elongation (inspected) = ${val2}`);
                                        }
                                    }
                                } else {
                                    console.log('‚ö†Ô∏è INSPECTED VALUES ba≈ülƒ±ƒüƒ± bulunamadƒ±');
                                }
                        }
                    } // Fallback bloƒüu sonu
                    
                    console.log('üìä √áƒ±karƒ±lan √ñzellikler:', properties);
                    const propCount = Object.keys(properties).length;
                    
                    if (propCount > 0) {
                        showToast(`‚úÖ ${propCount} √∂zellik bulundu`, 'success');
                    } else {
                        showToast('‚ö†Ô∏è Hi√ßbir √∂zellik bulunamadƒ±', 'warning');
                    }
                    
                    resolve(properties);
                    
                } catch (error) {
                    console.error('OCR Hatasƒ±:', error);
                    const errorMsg = '‚ùå OCR hatasƒ±: ' + error.message;
                    showToast(errorMsg, 'error', 10000); // 10 saniye g√∂r√ºns√ºn
                    
                    // Mobil i√ßin alert de g√∂ster (daha kolay g√∂r√ºn√ºr)
                    if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                        alert('OCR HATASI:\n\n' + error.message + '\n\nAPI Key: ' + (localStorage.getItem('ocrspace_api_key') || 'K82811583888957').substring(0, 10) + '...');
                    }
                    
                    // Hata durumunda bo≈ü obje d√∂nd√ºr
                    resolve({});
                }
            });
        }
        
        // Benzerlik hesaplama (0-1 arasƒ±, 1=tam e≈üle≈üme)
        function calculateSimilarity(str1, str2) {
            str1 = str1.toLowerCase().trim();
            str2 = str2.toLowerCase().trim();
            
            // Tam e≈üle≈üme
            if (str1 === str2) return 1.0;
            
            // √ñzel durumlar - Sertlik varyasyonlarƒ±
            const hardnessVariants = ['sertlik', 'sertik', 'sertlƒ±k', 'hardness'];
            const isStr1Hardness = hardnessVariants.includes(str1);
            const isStr2Hardness = hardnessVariants.includes(str2);
            if (isStr1Hardness && isStr2Hardness) {
                console.log('  üéØ Sertlik varyasyonu tespit edildi:', str1, '‚âà', str2);
                return 0.95; // √áok y√ºksek benzerlik
            }
            
            // Levenshtein distance (daha doƒüru hesaplama)
            const matrix = [];
            const n = str1.length;
            const m = str2.length;
            
            if (n === 0) return m === 0 ? 1.0 : 0;
            if (m === 0) return 0;
            
            // Matris olu≈ütur
            for (let i = 0; i <= n; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= m; j++) {
                matrix[0][j] = j;
            }
            
            // Mesafe hesapla
            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }
            
            const distance = matrix[n][m];
            const maxLen = Math.max(n, m);
            const similarity = 1 - (distance / maxLen);
            
            return similarity;
        }
        
        // COA deƒüerini TDS limitlerine g√∂re otomatik kontrol et
        function calculateCompliance(coaValue, requirement, min, max, standardValue) {
            // coaValue bo≈üsa veya parse edilemezse bilinmiyor
            if (!coaValue || coaValue === '-' || coaValue === '') {
                return 'Bilinmiyor';
            }
            
            const coa = parseFloat(String(coaValue).replace(',', '.'));
            if (isNaN(coa)) {
                console.log(`‚ö†Ô∏è COA deƒüeri numerik deƒüil: "${coaValue}"`);
                return 'Bilinmiyor';
            }
            
            // requirement yoksa bilinmiyor
            if (!requirement) {
                return 'Bilinmiyor';
            }
            
            // Aralƒ±k kontrol√º (range)
            if (requirement === 'Aralƒ±k' || requirement === 'range') {
                const minVal = parseFloat(String(min).replace(',', '.'));
                const maxVal = parseFloat(String(max).replace(',', '.'));
                
                if (isNaN(minVal) || isNaN(maxVal)) {
                    return 'Bilinmiyor';
                }
                
                const isCompliant = (coa >= minVal && coa <= maxVal);
                return isCompliant ? 'uygun' : 'uygun deƒüil';
            }
            // Minimum kontrol√º (‚â•)
            else if (requirement === '‚â•' || requirement === 'min') {
                const minVal = parseFloat(String(min).replace(',', '.'));
                
                if (isNaN(minVal)) {
                    return 'Bilinmiyor';
                }
                
                const isCompliant = (coa >= minVal);
                return isCompliant ? 'uygun' : 'uygun deƒüil';
            }
            // Maximum kontrol√º (‚â§)
            else if (requirement === '‚â§' || requirement === 'max') {
                const maxVal = parseFloat(String(max).replace(',', '.'));
                
                if (isNaN(maxVal)) {
                    return 'Bilinmiyor';
                }
                
                const isCompliant = (coa <= maxVal);
                return isCompliant ? 'uygun' : 'uygun deƒüil';
            }
            // Uygunluk kontrol√º (text-based, manual review needed)
            else if (requirement === 'Uygunluk kontrol√º' || requirement === 'compliance') {
                return 'Kontrol Gerekli';
            }
            
            // Tanƒ±mlanmamƒ±≈ü requirement tipi
            return 'Bilinmiyor';
        }
        
        // TDS'deki √∂zellikleri COA verileriyle e≈üle≈ütir
        function matchCOAWithTDS(materialCode, coaProperties) {
            console.log('üîç matchCOAWithTDS √ßaƒürƒ±ldƒ±:', materialCode, coaProperties);
            
            if (!tdsData[materialCode]) {
                console.log('‚ö†Ô∏è Bu hammadde i√ßin TDS tanƒ±mlanmamƒ±≈ü:', materialCode);
                showToast('‚ö†Ô∏è Bu hammadde i√ßin TDS tanƒ±mlanmamƒ±≈ü', 'warning');
                return;
            }
            
            const tds = tdsData[materialCode];
            let matchedCount = 0;
            
            console.log('üìã TDS √ñzellikleri:', tds.properties);
            console.log('üìã COA √ñzellikleri:', coaProperties);
            console.log('üìã COA Keys:', Object.keys(coaProperties));
            console.log('üìã COA Values:', Object.values(coaProperties));
            
            // Check if BASF format (properties have {value, requirement, compliance} structure)
            const isBASFFormat = Object.values(coaProperties).some(v => 
                typeof v === 'object' && v !== null && 'compliance' in v
            );
            console.log('üî∑ BASF Format:', isBASFFormat);
            
            // Her TDS √∂zelliƒüi i√ßin COA'da e≈üle≈üme ara
            tds.properties.forEach((prop, propIndex) => {
                const propName = prop.name.toLowerCase().trim();
                
                // Parantez i√ßini temizle (TDS'den)
                const propNameClean = propName.replace(/\s*\([^)]*\)/g, '').trim();
                
                console.log(`\nüîé TDS √ñzelliƒüi [${propIndex}]: "${prop.name}" ‚Üí temiz: "${propNameClean}"`);
                
                let bestMatch = null;
                let bestSimilarity = 0;
                let exactMatchFound = false;
                
                // COA properties i√ßinde en iyi e≈üle≈ümeyi ara
                for (const [coaKey, coaValue] of Object.entries(coaProperties)) {
                    const coaKeyLower = coaKey.toLowerCase().trim();
                    
                    // Parantez i√ßini temizle (COA'dan)
                    const coaKeyClean = coaKeyLower.replace(/\s*\([^)]*\)/g, '').trim();
                    
                    console.log(`   üîç COA: "${coaKey}" ‚Üí clean: "${coaKeyClean}" | TDS clean: "${propNameClean}"`);
                    
                    // BASF FORMAT: Handle object values
                    let actualValue = coaValue;
                    if (isBASFFormat && typeof coaValue === 'object' && coaValue !== null) {
                        // ‚ö†Ô∏è BASF format compliance deƒüerini ARTIK KULLANMIYORUZ - TDS ile hesaplayacaƒüƒ±z
                        // if (coaValue.compliance) {
                        //     prop.coaCompliance = coaValue.compliance;
                        // }
                        if (coaValue.requirement) {
                            prop.coaRequirement = coaValue.requirement;
                            // If TDS property doesn't have requirement yet, store from COA
                            if (!prop.requirement && prop.operator === 'compliance') {
                                prop.requirement = coaValue.requirement;
                            }
                        }
                        // SADECE value'yu kullan, compliance kullanma (numerik deƒüer gerekli)
                        actualValue = coaValue.value || '';
                        
                        // Auto-set operator to compliance mode if not already set
                        if (!prop.operator || prop.operator === '=') {
                            prop.operator = 'compliance';
                            console.log(`   üîß Auto-switched to compliance mode for "${prop.name}"`);
                        }
                    }
                    
                    // √ñZEL DURUM: Sertlik/Hardness √ßapraz e≈üle≈üme
                    const hardnessVariants = ['sertlik', 'sertik', 'sertlƒ±k', 'hardness'];
                    const isTdsHardness = hardnessVariants.includes(propNameClean);
                    const isCoaHardness = hardnessVariants.includes(coaKeyClean);
                    
                    if (isTdsHardness && isCoaHardness) {
                        prop.coaValue = actualValue;
                        matchedCount++;
                        exactMatchFound = true;
                        console.log(`   ‚úÖ SERTLƒ∞K √ñZEL e≈üle≈üme: "${prop.name}" ‚Üî "${coaKey}" = ${actualValue}`);
                        break;
                    }
                    
                    // Tam e≈üle≈üme (temizlenmi≈ü versiyonlarla)
                    if (coaKeyClean === propNameClean || coaKeyLower === propName) {
                        prop.coaValue = actualValue;
                        matchedCount++;
                        exactMatchFound = true;
                        console.log(`   ‚úÖ TAM e≈üle≈üme: "${prop.name}" = ${actualValue}`);
                        break; // Tam e≈üle≈üme bulundu, d√∂ng√ºden √ßƒ±k
                    }
                    
                    // Benzerlik hesapla (temizlenmi≈ü versiyonlarla)
                    const similarity = calculateSimilarity(propNameClean, coaKeyClean);
                    console.log(`   üìä Benzerlik: ${Math.round(similarity * 100)}%`);
                    
                    // %65 ve √ºzeri benzerlik varsa kabul et (daha esnek - "Sertik" vs "Sertlik" i√ßin)
                    if (similarity >= 0.65) {
                        if (similarity > bestSimilarity) {
                            bestSimilarity = similarity;
                            bestMatch = { key: coaKey, value: actualValue };
                            console.log(`   ‚≠ê Yeni en iyi e≈üle≈üme: ${Math.round(similarity * 100)}%`);
                        }
                    }
                    
                    // Kƒ±smi e≈üle≈üme (temizlenmi≈ü versiyonlarla)
                    if (coaKeyClean.includes(propNameClean) || propNameClean.includes(coaKeyClean)) {
                        if (0.85 > bestSimilarity) {
                            bestSimilarity = 0.85;
                            bestMatch = { key: coaKey, value: actualValue };
                            console.log(`   ‚≠ê Kƒ±smi e≈üle≈üme (85%): "${propNameClean}" ‚äÜ "${coaKeyClean}"`);
                        }
                    }
                }
                
                // Tam e≈üle≈üme yoksa benzerlik e≈üle≈ümesini kullan
                if (!exactMatchFound) {
                    if (bestMatch) {
                        prop.coaValue = bestMatch.value;
                        matchedCount++;
                        console.log(`   ‚úÖ BENZERLƒ∞K e≈üle≈üme (${Math.round(bestSimilarity * 100)}%): "${prop.name}" ‚âà "${bestMatch.key}" = ${bestMatch.value}`);
                    } else {
                        console.log(`   ‚ùå E≈üle≈üme bulunamadƒ±: "${prop.name}"`);
                    }
                }
                
                // ‚úÖ OCR sonrasƒ± otomatik compliance hesaplama
                if (prop.coaValue) {
                    const autoCompliance = calculateCompliance(
                        prop.coaValue, 
                        prop.requirement, 
                        prop.min, 
                        prop.max, 
                        prop.standardValue
                    );
                    prop.coaCompliance = autoCompliance;
                    console.log(`   üîç Auto-compliance: "${prop.name}" = "${prop.coaValue}" ‚Üí [${autoCompliance}]`);
                }
            });
            
            // TDS'yi g√ºncelle
            saveTDSData();
            console.log('üíæ TDS kaydedildi, e≈üle≈üen:', matchedCount);
            
            // NOT: COA_Records'a kaydetme i≈ülemini buradan kaldƒ±rdƒ±k
            // Artƒ±k sadece saveCOA() i√ßinde, kaydet butonuna basƒ±ldƒ±ƒüƒ±nda yapƒ±lacak
            
            if (matchedCount > 0) {
                showToast(`‚úÖ ${matchedCount} √∂zellik e≈üle≈ütirildi, TDS modalƒ±nƒ± a√ßƒ±n`, 'success', 5000);
            } else {
                showToast('‚ö†Ô∏è Hi√ßbir √∂zellik e≈üle≈ütirilemedi', 'warning');
            }
            
            return matchedCount;
        }
        
        // TDS verilerini y√ºkle
        function loadTDSData() {
            const saved = localStorage.getItem('tdsData');
            if (saved) {
                try {
                    tdsData = JSON.parse(saved);
                    
                    // Eski TDS verilerini g√ºncelle: Eksik alanlarƒ± ekle
                    Object.keys(tdsData).forEach(materialCode => {
                        if (tdsData[materialCode]) {
                            let tdsRecord = tdsData[materialCode];
                            
                            // Nested yapƒ± kontrol√º: { properties: { properties: [...] } }
                            if (tdsRecord.properties && tdsRecord.properties.properties) {
                                console.log(`üîß ${materialCode} nested yapƒ± d√ºzeltiliyor (localStorage)`);
                                tdsData[materialCode] = tdsRecord.properties; // ƒ∞√ßteki yapƒ±yƒ± kullan
                                tdsRecord = tdsData[materialCode];
                            }
                            
                            if (tdsRecord.properties) {
                                // properties string ise parse et (Google Sheets'ten gelmi≈ü olabilir)
                                if (typeof tdsRecord.properties === 'string') {
                                    try {
                                        tdsRecord.properties = JSON.parse(tdsRecord.properties);
                                    } catch (e) {
                                        console.warn(`‚ö†Ô∏è ${materialCode} properties parse hatasƒ±:`, e);
                                        tdsRecord.properties = [];
                                    }
                                }
                                
                                // Array deƒüilse bo≈ü array yap
                                if (!Array.isArray(tdsRecord.properties)) {
                                    console.warn(`‚ö†Ô∏è ${materialCode} properties array deƒüil (${typeof tdsRecord.properties}), d√ºzeltiliyor`);
                                    tdsRecord.properties = [];
                                }
                                
                                tdsRecord.properties.forEach(prop => {
                                    // Operator yoksa varsayƒ±lan 'range' ekle
                                    if (!prop.operator) {
                                        prop.operator = 'range';
                                    }
                                    // standardValue yoksa ama lowerTolerance ve upperTolerance varsa hesapla
                                    if (!prop.standardValue && prop.lowerTolerance && prop.upperTolerance) {
                                        // Min ve max'tan ortayƒ± al
                                        if (prop.min && prop.max) {
                                            const minVal = parseFloat(prop.min);
                                            const maxVal = parseFloat(prop.max);
                                            prop.standardValue = ((minVal + maxVal) / 2).toFixed(2);
                                        }
                                    }
                                });
                            }
                        }
                    });
                    
                    console.log('‚úÖ TDS verileri y√ºklendi ve g√ºncellendi');
                } catch (e) {
                    console.error('TDS y√ºkleme hatasƒ±:', e);
                    tdsData = {};
                }
            }
        }
        
        // TDS verilerini kaydet
        function saveTDSData() {
            localStorage.setItem('tdsData', JSON.stringify(tdsData));
            // Google Sheets'e senkronize et (sadece deƒüi≈üen hammadde)
            if (currentTDSMaterial && tdsData[currentTDSMaterial]) {
                syncTDSToGoogleSheets(currentTDSMaterial, tdsData[currentTDSMaterial].properties);
            }
        }
        
        // Google Sheets'e TDS senkronizasyonu
        async function syncTDSToGoogleSheets(materialCode, properties) {
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil, sadece localStorage\'a kaydedildi');
                return;
            }
            
            // COA deƒüerlerini temizle (TDS Definitions'a COA deƒüerleri kaydedilmez!)
            const cleanProperties = properties.map(prop => {
                const cleaned = {...prop};
                delete cleaned.coaValue;       // COA deƒüerini √ßƒ±kar
                delete cleaned.coaCompliance;  // COA durumunu √ßƒ±kar
                delete cleaned.status;         // Eski field de varsa √ßƒ±kar
                return cleaned;
            });
            
            console.log(`üßπ ${materialCode} COA deƒüerleri temizlendi, TDS Definitions'a kaydediliyor...`);
            
            try {
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 10000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.ontimeout = () => reject(new Error('Timeout'));
                    
                    xhr.open('POST', googleScriptUrl, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    
                    const formData = new URLSearchParams();
                    formData.append('action', 'saveTDS');
                    formData.append('materialCode', materialCode);
                    formData.append('data', JSON.stringify(cleanProperties));  // ‚úÖ COA deƒüerleri temizlenmi≈ü TDS yapƒ±sƒ±
                    
                    xhr.send(formData.toString());
                });
                
                if (result && result.success) {
                    console.log('‚òÅÔ∏è TDS Google Sheets\'e kaydedildi:', materialCode);
                } else {
                    console.error('‚ùå Google Sheets kayƒ±t hatasƒ±:', result?.error);
                }
            } catch(error) {
                console.error('‚ùå Google Sheets senkronizasyon hatasƒ±:', error);
            }
        }
        
        // TDS property'lerde eksik alanlarƒ± doldur (v2)
        function ensureTDSPropertyFields(properties) {
            return properties.map(prop => {
                // Operator yoksa varsayƒ±lan
                if (!prop.operator) {
                    prop.operator = 'range';
                }
                
                // StandardValue yoksa hesapla
                if (!prop.standardValue && prop.min && prop.max) {
                    const minVal = parseFloat(prop.min);
                    const maxVal = parseFloat(prop.max);
                    if (!isNaN(minVal) && !isNaN(maxVal)) {
                        prop.standardValue = ((minVal + maxVal) / 2).toFixed(2);
                    }
                }
                
                return prop;
            });
        }
        
        // COA kayƒ±tlarƒ±nƒ± satƒ±r bazlƒ± Google Sheets'e kaydet
        async function saveCOARecordToSheets(materialCode, tdsProperties, recordData = null) {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìäüìäüìä SHEETS\'E KAYIT BA≈ûLIYOR! üìäüìäüìä');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîë Material Code:', materialCode);
            console.log('üìã TDS Properties Count:', tdsProperties.length);
            console.log('üìã TDS Properties RAW:', tdsProperties);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil');
                return;
            }
            
            try {
                // TDS property'lerde eksik alanlarƒ± doldur
                tdsProperties = ensureTDSPropertyFields(tdsProperties);
                
                // COA form verilerini al (recordData varsa ondan, yoksa form elemanlarƒ±ndan)
                const deliveryDate = recordData?.deliveryDate || document.getElementById('deliveryDate').value || new Date().toISOString().split('T')[0];
                const deliveryNo = recordData?.deliveryNo || document.getElementById('deliveryNo').value.trim() || '-';
                const lotNumber = recordData?.lotNumber || document.getElementById('lotNumber').value.trim() || '-';
                const supplier = recordData?.supplier || document.getElementById('supplierInput').value.trim() || '-';
                const location = recordData?.location || document.getElementById('location').value.trim() || '';
                
                // Properties array olu≈ütur (COA deƒüeri olan VE olmayan t√ºm √∂zellikler)
                const properties = tdsProperties
                    .filter(prop => {
                        // COA deƒüeri yoksa, √∂zelliƒüi dahil et ama tarih kontrol√º yapma
                        if (!prop.coaValue) return true;
                        
                        // COA deƒüeri varsa tarih formatlarƒ±nƒ± filtrele
                        const valueStr = String(prop.coaValue).trim();
                        
                        // ISO tarih formatƒ± kontrol√º (2026-05-04T21:00:00.000Z)
                        if (/^\d{4}-\d{2}-\d{2}T/.test(valueStr) || /^\d{4}-\d{2}-\d{2}$/.test(valueStr)) {
                            console.warn(`‚ö†Ô∏è ${prop.name}: Tarih formatƒ±nda deƒüer atlanƒ±yor: "${valueStr}"`);
                            return false;
                        }
                        
                        // DD.MM.YYYY veya DD/MM/YYYY formatƒ±
                        if (/^\d{1,2}[\.\/]\d{1,2}[\.\/]\d{4}$/.test(valueStr)) {
                            console.warn(`‚ö†Ô∏è ${prop.name}: Tarih formatƒ±nda deƒüer atlanƒ±yor: "${valueStr}"`);
                            return false;
                        }
                        
                        // Sadece 4 basamaklƒ± yƒ±l formatlarƒ±nƒ± filtrele (1900-2099 arasƒ±)
                        // Ama 1000, 1280 gibi normal deƒüerleri KORUYALIM
                        const testNum = parseFloat(valueStr.replace(/,/g, '.'));
                        if (!isNaN(testNum) && testNum >= 1900 && testNum <= 2099) {
                            console.warn(`‚ö†Ô∏è ${prop.name}: Yƒ±l deƒüeri tespit edildi, atlanƒ±yor: "${valueStr}"`);
                            return false;
                        }
                        
                        return true;
                    })
                    .map(prop => {
                        // COA deƒüerini al
                        let coaValue = String(prop.coaValue || '').trim();
                        let unit = String(prop.unit || '').trim();
                        
                        console.log(`üîç ƒ∞≈üleniyor: ${prop.name} | COA="${coaValue}" | Unit="${unit}"`);
                        console.log(`  üìã Orijinal prop:`, { coaValue: prop.coaValue, unit: prop.unit, min: prop.min, max: prop.max });
                        console.log(`  üî¢ prop.coaValue RAW type: ${typeof prop.coaValue}, RAW value:`, prop.coaValue);
                        
                        // Operat√∂r sembollerini temizle (‚â§, ‚â•, <, >, =)
                        coaValue = coaValue.replace(/^[‚â§‚â•<>=]+\s*/, '');
                        
                        // T√úM virg√ºlleri noktaya √ßevir (T√ºrk√ße ondalƒ±k ayƒ±rƒ±cƒ±sƒ±)
                        coaValue = coaValue.replace(/,/g, '.');
                        
                        // √ñZEL DURUM: Bo≈üluklu ondalƒ±k sayƒ±larƒ± d√ºzelt
                        // √ñrn: "0 035" ‚Üí "0.035", "0 35" ‚Üí "0.35", "1 234" ‚Üí "1.234"
                        if (/^\d\s+\d+$/.test(coaValue)) {
                            const parts = coaValue.split(/\s+/);
                            const firstPart = parts[0];
                            const secondPart = parts[1];
                            
                            // Eƒüer ilk rakam 0 ise ondalƒ±k sayƒ± olabilir
                            if (firstPart === '0') {
                                coaValue = '0.' + secondPart;
                                console.log(`  üîß Bo≈üluklu ondalƒ±k d√ºzeltildi: "${coaValue.replace('.', ' ')}" ‚Üí "${coaValue}"`);
                            }
                            // Diƒüer durumlarda da nokta ekle (√∂rn: "1 234" ‚Üí "1.234")
                            else {
                                coaValue = firstPart + '.' + secondPart;
                                console.log(`  üîß Bo≈üluklu sayƒ± d√ºzeltildi: "${firstPart} ${secondPart}" ‚Üí "${coaValue}"`);
                            }
                        }
                        
                        // √ñZEL DURUM: Thermal conductivity i√ßin 0 ile ba≈ülayan ondalƒ±k sayƒ±larƒ± koru
                        // √ñrn: "0.035" veya "0. 035" gibi deƒüerler
                        if (prop.name && prop.name.toLowerCase().includes('thermal') || 
                            prop.name && prop.name.toLowerCase().includes('conduct') ||
                            unit && unit.toLowerCase().includes('w/mk')) {
                            // Nokta sonrasƒ± bo≈üluk varsa temizle: "0. 035" -> "0.035"
                            coaValue = coaValue.replace(/\.(\s+)/g, '.');
                            // Birden fazla nokta varsa birle≈ütir: "0.0.35" -> "0.035"
                            coaValue = coaValue.replace(/\.+/g, '.');
                            console.log(`  üå°Ô∏è Thermal conductivity √∂zel d√ºzeltme: "${coaValue}"`);
                        }
                        
                        // √ñNCE: Range deƒüer kontrol√º (√∂rn: "100 - 110" veya "29.8-30.3")
                        // Bu deƒüerler unit olarak ALGILANMAMALI!
                        const isRangeValue = /^[\d.]+\s*-\s*[\d.]+$/.test(coaValue);
                        
                        // Eƒüer COA deƒüeri i√ßinde bo≈üluk ve birim varsa ayƒ±r (√∂rn: "14.38 kg/m3")
                        // ANCAK range deƒüer deƒüilse!
                        if (coaValue && coaValue.includes(' ') && !isRangeValue) {
                            const match = coaValue.match(/^([\d.,]+)\s+(.+)$/);
                            if (match) {
                                const extractedValue = match[1].replace(/,/g, '.');
                                const extractedUnit = match[2];
                                console.log(`  üîß COA ayrƒ±klandƒ±: "${coaValue}" ‚Üí Value=${extractedValue}, Unit=${extractedUnit}`);
                                coaValue = extractedValue;
                                if (!unit) {
                                    unit = extractedUnit;
                                }
                            }
                        } else if (isRangeValue) {
                            console.log(`  üìä Range deƒüer tespit edildi, unit parse edilmeyecek: "${coaValue}"`);
                        }
                        
                        // SADECE COA deƒüeri tamamen bo≈üsa VE unit sayƒ± ile ba≈ülƒ±yorsa ayƒ±r
                        // √ñrnek: COA bo≈ü + Unit="122 N" ‚Üí COA=122, Unit=N
                        // Ama: COA="0.09" + Unit="N/mm2" ‚Üí DOKUNMA!
                        if ((!coaValue || coaValue === '') && unit && /^[\d.,]+\s/.test(unit)) {
                            const unitMatch = unit.match(/^([\d.,]+)\s+(.*)$/);
                            if (unitMatch) {
                                coaValue = unitMatch[1].replace(/,/g, '.');
                                unit = unitMatch[2].trim();
                                console.log(`  üîß Unit'ten COA √ßƒ±karƒ±ldƒ±: "${prop.unit}" ‚Üí COA=${coaValue}, Unit=${unit}`);
                            }
                        }
                        
                        // √ñZEL DURUM: Eƒüer COA deƒüeri var ama √ßok k√º√ß√ºkse (√∂rn: 0.07)
                        // VE unit sayƒ± ile ba≈ülƒ±yorsa (√∂rn: "90 N/mm2")
                        // Bu durumda unit'teki sayƒ±yƒ± KULLANMA, sadece birimi temizle
                        if (coaValue && unit && /^[\d.,]+\s/.test(unit)) {
                            const unitMatch = unit.match(/^[\d.,]+\s+(.*)$/);
                            if (unitMatch) {
                                // Unit'teki sayƒ±yƒ± at, sadece birimi al
                                unit = unitMatch[1].trim();
                                console.log(`  ‚ö†Ô∏è Unit'teki yanlƒ±≈ü sayƒ± temizlendi: "${prop.unit}" ‚Üí Unit="${unit}"`);
                            }
                        }
                        
                        // Alt/√úst limit - √∂nce property'den kontrol et, yoksa hesapla
                        let lowerLimit = prop.min;
                        let upperLimit = prop.max;
                        
                        // Limit deƒüerlerinde virg√ºl varsa noktaya √ßevir
                        if (lowerLimit) lowerLimit = String(lowerLimit).replace(/,/g, '.');
                        if (upperLimit) upperLimit = String(upperLimit).replace(/,/g, '.');
                        
                        // √ñZEL DURUM: Bo≈üluklu ondalƒ±k sayƒ±larƒ± d√ºzelt (limitler i√ßin de)
                        // √ñrn: "0 035" ‚Üí "0.035"
                        if (lowerLimit && /^\d\s+\d+$/.test(lowerLimit)) {
                            const parts = String(lowerLimit).split(/\s+/);
                            lowerLimit = parts[0] === '0' ? '0.' + parts[1] : parts[0] + '.' + parts[1];
                            console.log(`  üîß Lower limit bo≈üluk d√ºzeltildi: "${prop.min}" ‚Üí "${lowerLimit}"`);
                        }
                        if (upperLimit && /^\d\s+\d+$/.test(upperLimit)) {
                            const parts = String(upperLimit).split(/\s+/);
                            upperLimit = parts[0] === '0' ? '0.' + parts[1] : parts[0] + '.' + parts[1];
                            console.log(`  üîß Upper limit bo≈üluk d√ºzeltildi: "${prop.max}" ‚Üí "${upperLimit}"`);
                        }
                        
                        // Eƒüer property'de yoksa hesapla
                        if (!lowerLimit || !upperLimit) {
                            const stdValueStr = String(prop.standardValue || '0').replace(/,/g, '.');
                            const stdValue = parseFloat(stdValueStr);
                            const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                            const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                            
                            // Standart deƒüerdeki ondalƒ±k basamak sayƒ±sƒ±nƒ± bul
                            let decimalPlaces = 2; // Varsayƒ±lan
                            if (stdValueStr.includes('.')) {
                                const decimalPart = stdValueStr.split('.')[1];
                                decimalPlaces = decimalPart ? decimalPart.length : 0;
                            }
                            
                            lowerLimit = (stdValue - lowerTol).toFixed(decimalPlaces);
                            upperLimit = (stdValue + upperTol).toFixed(decimalPlaces);
                        }
                        
                        // Operat√∂r ve Standart Deƒüer kontrol√º - virg√ºl/nokta d√∂n√º≈ü√ºm√º ile
                        // Eƒüer requirement dolu ise otomatik olarak compliance mode'a ge√ß
                        let operator = prop.operator || prop.operat√∂r || 'range';
                        if (prop.requirement && prop.requirement.trim() !== '') {
                            operator = 'compliance';
                            console.log(`  üîÑ ${prop.name}: Requirement dolu, compliance mode'a ge√ßildi`);
                        }
                        let standardValue = prop.standardValue || prop.standardDeger || '';
                        if (standardValue) standardValue = String(standardValue).replace(/,/g, '.');
                        
                        // Operat√∂re g√∂re limit g√∂sterimi
                        let finalMin = lowerLimit;
                        let finalMax = upperLimit;
                        
                        if (operator === '>' || operator === '>=') {
                            // B√ºy√ºkt√ºr: sadece alt limit g√∂ster
                            finalMax = '';
                        } else if (operator === '<' || operator === '<=') {
                            // K√º√ß√ºkt√ºr: sadece √ºst limit g√∂ster
                            finalMin = '';
                        }
                        // range i√ßin her ikisi de g√∂sterilir (zaten set)
                        
                        console.log(`üìä ${prop.name}: op=${operator}, stdVal=${standardValue}, min=${finalMin}, max=${finalMax} (COA: ${coaValue}, Unit: ${unit})`);
                        console.log(`  üéØ FINAL coaValue type: ${typeof coaValue}, value: "${coaValue}"`);
                        
                        // Requirement alanƒ±nƒ± olu≈ütur (compliance mode i√ßin veya operator'e g√∂re)
                        let requirement = '';
                        let finalStandardValue = standardValue;
                        let sheetRequirement = '';  // Sheets'e g√∂nderilecek requirement (numeric mode'da bo≈ü)
                        
                        if (prop.operator === 'compliance' && prop.requirement) {
                            // Compliance mode: requirement dolu, standardValue bo≈ü
                            requirement = prop.requirement;
                            sheetRequirement = prop.requirement;
                            finalStandardValue = '';
                            finalMin = '';
                            finalMax = '';
                        } else if (operator === '<' || operator === '<=') {
                            // K√º√ß√ºkt√ºr: "‚â§ 0,035 W/mK" formatƒ± (ekranda g√∂ster, Sheets'e g√∂nderme)
                            requirement = `${operator === '<' ? '<' : '‚â§'} ${finalMax}${unit ? ' ' + unit : ''}`;
                            sheetRequirement = '';  // Sheets'e bo≈ü g√∂nder
                        } else if (operator === '>' || operator === '>=') {
                            // B√ºy√ºkt√ºr: "‚â• 45 N" formatƒ± (ekranda g√∂ster, Sheets'e g√∂nderme)
                            requirement = `${operator === '>' ? '>' : '‚â•'} ${finalMin}${unit ? ' ' + unit : ''}`;
                            sheetRequirement = '';  // Sheets'e bo≈ü g√∂nder
                        } else if (operator === 'range' && finalMin && finalMax) {
                            // Aralƒ±k: "7,5 - 10,5 kg/m3" formatƒ± (ekranda g√∂ster, Sheets'e g√∂nderme)
                            requirement = `${finalMin} - ${finalMax}${unit ? ' ' + unit : ''}`;
                            sheetRequirement = '';  // Sheets'e bo≈ü g√∂nder
                        }
                        
                        // COA deƒüerini hazƒ±rla - sayƒ±sal deƒüerleri Number olarak g√∂nder
                        // (Google Sheets'in "5.5" gibi deƒüerleri tarih olarak yorumlamasƒ±nƒ± √∂nle)
                        let finalCoaValue = coaValue || '';
                        if (finalCoaValue && typeof finalCoaValue === 'string') {
                            // Range deƒüer kontrol√º (√∂rn: "100 - 110")
                            const isRangeValue = /^[\d.]+\s*-\s*[\d.]+$/.test(finalCoaValue);
                            
                            if (!isRangeValue) {
                                // Tek sayƒ±sal deƒüer - Number'a √ßevir
                                const numValue = parseFloat(finalCoaValue);
                                if (!isNaN(numValue) && isFinite(numValue)) {
                                    finalCoaValue = numValue;  // Number olarak g√∂nder
                                    console.log(`  üî¢ COA deƒüeri Number'a √ßevrildi: "${coaValue}" ‚Üí ${finalCoaValue}`);
                                }
                            }
                        }
                        
                        // √ñNEMLI: min, max, standardValue'yu da Number'a √ßevir (Sheets'te 0.035 = 35 hatasƒ±nƒ± √∂nle)
                        let finalMinNumber = '';
                        let finalMaxNumber = '';
                        let finalStdNumber = '';
                        
                        if (finalMin && finalMin !== '') {
                            const minNum = parseFloat(String(finalMin).replace(/,/g, '.'));
                            if (!isNaN(minNum) && isFinite(minNum)) {
                                finalMinNumber = minNum;  // Number olarak
                                console.log(`  üî¢ Min limit Number'a √ßevrildi: "${finalMin}" ‚Üí ${finalMinNumber}`);
                            } else {
                                finalMinNumber = finalMin;  // Parse edilemezse string olarak bƒ±rak
                            }
                        }
                        
                        if (finalMax && finalMax !== '') {
                            const maxNum = parseFloat(String(finalMax).replace(/,/g, '.'));
                            if (!isNaN(maxNum) && isFinite(maxNum)) {
                                finalMaxNumber = maxNum;  // Number olarak
                                console.log(`  üî¢ Max limit Number'a √ßevrildi: "${finalMax}" ‚Üí ${finalMaxNumber}`);
                            } else {
                                finalMaxNumber = finalMax;  // Parse edilemezse string olarak bƒ±rak
                            }
                        }
                        
                        if (finalStandardValue && finalStandardValue !== '') {
                            const stdNum = parseFloat(String(finalStandardValue).replace(/,/g, '.'));
                            if (!isNaN(stdNum) && isFinite(stdNum)) {
                                finalStdNumber = stdNum;  // Number olarak
                                console.log(`  üî¢ Standard value Number'a √ßevrildi: "${finalStandardValue}" ‚Üí ${finalStdNumber}`);
                            } else {
                                finalStdNumber = finalStandardValue;  // Parse edilemezse string olarak bƒ±rak
                            }
                        }
                        
                        return {
                            name: prop.name,
                            coaValue: finalCoaValue,
                            unit: unit,
                            standard: prop.standard || '',
                            operator: operator,
                            standardValue: finalStdNumber,
                            min: finalMinNumber,
                            max: finalMaxNumber,
                            requirement: sheetRequirement,  // Sheets'e sadece compliance mode'da g√∂nder
                            status: calculatePropertyStatus(coaValue, lowerLimit, upperLimit, operator, prop)
                        };
                    });
                
                console.log(`üìä G√∂nderilecek √∂zellik sayƒ±sƒ±: ${properties.length} (${properties.filter(p => p.coaValue).length} COA deƒüeri var)`);
                
                // En az 1 TDS √∂zelliƒüi varsa kaydet (COA deƒüeri olsa da olmasa da)
                if (properties.length === 0) {
                    console.log('‚ö†Ô∏è TDS\'de hi√ß √∂zellik yok, kayƒ±t yapƒ±lmadƒ±');
                    return;
                }
                
                const data = {
                    date: deliveryDate,
                    deliveryNo: deliveryNo,
                    lotNumber: lotNumber,
                    materialCode: materialCode,
                    supplier: supplier,
                    location: location,
                    properties: properties
                };
                
                console.log('');
                console.log('üöÄüöÄüöÄ GOOGLE SHEETS\'E G√ñNDERƒ∞Lƒ∞YOR! üöÄüöÄüöÄ');
                console.log('üì¶ G√∂nderilen DATA:', JSON.stringify(data, null, 2));
                console.log('üöÄüöÄüöÄ G√ñNDERƒ∞M BA≈ûLIYOR! üöÄüöÄüöÄ');
                console.log('');
                
                console.log('üìä COA_Records\'a g√∂nderiliyor:', data);
                
                const url = `${googleScriptUrl}?action=saveCOARecord&data=${encodeURIComponent(JSON.stringify(data))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ COA_Records\'a kaydedildi:', result.recordCount, 'satƒ±r');
                    showToast(`üìä ${result.recordCount} √∂zellik COA_Records'a kaydedildi`, 'success', 3000);
                } else {
                    console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', result.error);
                }
            } catch(error) {
                console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', error);
            }
        }
        
        // √ñzellik durumunu hesapla (‚úÖ/‚ùå)
        function calculatePropertyStatus(coaValue, min, max, operator = 'range', prop = null) {
            if (!coaValue) return '-';
            
            // Compliance mode: coaCompliance deƒüerini kullan VEYA requirement ile kar≈üƒ±la≈ütƒ±r
            if ((operator === 'compliance' || (prop && prop.requirement)) && prop) {
                if (prop.coaCompliance) {
                    return prop.coaCompliance;
                }
                // Eƒüer coaCompliance yoksa ama requirement var ise kar≈üƒ±la≈ütƒ±r
                if (prop.requirement) {
                    // Normalize ederek kar≈üƒ±la≈ütƒ±r - bo≈üluk, b√ºy√ºk/k√º√ß√ºk harf, √∂zel karakterler
                    const normalizeStr = (str) => String(str)
                        .replace(/\s+/g, '')
                        .replace(/[‚â§‚â•<>=]/g, '')
                        .toLowerCase()
                        .trim();
                    const coaNorm = normalizeStr(coaValue);
                    const reqNorm = normalizeStr(prop.requirement);
                    
                    console.log(`  üîç Compliance kar≈üƒ±la≈ütƒ±rma: COA="${coaNorm}" vs REQ="${reqNorm}"`);
                    
                    if (coaNorm === reqNorm || coaNorm.includes(reqNorm) || reqNorm.includes(coaNorm)) {
                        return 'Uygun';
                    }
                    return 'Uygun Deƒüil';
                }
                return '-';
            }
            
            // Operat√∂r sembollerini temizle
            const cleanValue = String(coaValue).replace(/^[‚â§‚â•<>=]+\s*/, '').replace(/,/g, '.');
            const val = parseFloat(cleanValue);
            if (isNaN(val)) return '-';
            
            // Operat√∂re g√∂re kontrol
            if (operator === '>' || operator === '>=') {
                // B√ºy√ºkt√ºr: sadece alt limit kontrol
                if (!min) return '-';
                const minVal = parseFloat(String(min).replace(/,/g, '.'));
                if (isNaN(minVal)) return '-';
                return (operator === '>' ? val > minVal : val >= minVal) ? 'Uygun' : 'Uygun Deƒüil';
            } 
            else if (operator === '<' || operator === '<=') {
                // K√º√ß√ºkt√ºr: sadece √ºst limit kontrol
                if (!max) return '-';
                const maxVal = parseFloat(String(max).replace(/,/g, '.'));
                if (isNaN(maxVal)) return '-';
                return (operator === '<' ? val < maxVal : val <= maxVal) ? 'Uygun' : 'Uygun Deƒüil';
            }
            else {
                // range: her ikisi de kontrol
                if (!min || !max) return '-';
                const minVal = parseFloat(String(min).replace(/,/g, '.'));
                const maxVal = parseFloat(String(max).replace(/,/g, '.'));
                if (isNaN(minVal) || isNaN(maxVal)) return '-';
                return (val >= minVal && val <= maxVal) ? 'Uygun' : 'Uygun Deƒüil';
            }
        }
        
        // Google Sheets'ten TDS verilerini y√ºkle (Sheets-only)
        async function loadTDSFromGoogleSheets() {
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL tanƒ±mlƒ± deƒüil');
                return false;
            }
            
            try {
                console.log('‚òÅÔ∏è Google Sheets\'ten TDS verileri y√ºkleniyor (JSONP)...');
                
                const result = await jsonpRequest(googleScriptUrl, { action: 'getTDS' }, 2);
                console.log('üì¶ TDS response:', result);
                
                if (result && result.success && result.data) {
                    Object.keys(result.data).forEach(materialCode => {
                        let tdsRecord = result.data[materialCode];
                        
                        // Nested yapƒ± kontrol√º: { properties: { properties: [...] } }
                        if (tdsRecord && tdsRecord.properties && tdsRecord.properties.properties) {
                            console.log(`üîß ${materialCode} nested yapƒ± d√ºzeltiliyor`);
                            tdsRecord = tdsRecord.properties; // ƒ∞√ßteki yapƒ±yƒ± kullan
                            console.log(`‚úÖ ${materialCode} d√ºzeltildi, properties:`, tdsRecord.properties.length, '√∂zellik');
                        }
                        
                        // properties string ise (JSON.stringify edilmi≈ü) parse et
                        if (tdsRecord && typeof tdsRecord.properties === 'string') {
                            try {
                                tdsRecord.properties = JSON.parse(tdsRecord.properties);
                                console.log(`üì¶ ${materialCode} properties parse edildi:`, tdsRecord.properties.length, '√∂zellik');
                            } catch (e) {
                                console.warn(`‚ö†Ô∏è ${materialCode} properties parse hatasƒ±:`, e);
                                tdsRecord.properties = [];
                            }
                        }
                        
                        // Array deƒüilse bo≈ü array yap
                        if (tdsRecord && !Array.isArray(tdsRecord.properties)) {
                            console.warn(`‚ö†Ô∏è ${materialCode} properties array deƒüil, d√ºzeltiliyor`);
                            tdsRecord.properties = [];
                        }
                        
                        // Son kontrol: ka√ß √∂zellik var?
                        if (tdsRecord && Array.isArray(tdsRecord.properties)) {
                            console.log(`üíæ ${materialCode} kaydediliyor: ${tdsRecord.properties.length} √∂zellik`);
                        }
                        
                        // Eƒüer memory'de COA deƒüerleri varsa koru (ge√ßici OCR deƒüerleri)
                        const existingData = tdsData[materialCode];
                        if (existingData && existingData.properties && Array.isArray(existingData.properties)) {
                            // Memory'deki COA deƒüerlerini Map'e al
                            const coaValuesMap = {};
                            existingData.properties.forEach(prop => {
                                if (prop.coaValue !== undefined || prop.coaCompliance !== undefined) {
                                    coaValuesMap[prop.name] = {
                                        coaValue: prop.coaValue,
                                        coaCompliance: prop.coaCompliance
                                    };
                                }
                            });
                            
                            // Sheets'ten gelen TDS yapƒ±sƒ±na COA deƒüerlerini ekle
                            if (Object.keys(coaValuesMap).length > 0 && tdsRecord.properties) {
                                tdsRecord.properties.forEach(prop => {
                                    if (coaValuesMap[prop.name]) {
                                        prop.coaValue = coaValuesMap[prop.name].coaValue;
                                        prop.coaCompliance = coaValuesMap[prop.name].coaCompliance;
                                    }
                                });
                                console.log(`üîó ${materialCode} COA deƒüerleri merge edildi:`, Object.keys(coaValuesMap).length, '√∂zellik');
                            }
                        }
                        
                        tdsData[materialCode] = tdsRecord;
                    });
                    localStorage.setItem('tdsData', JSON.stringify(tdsData));
                    const loadedCount = Object.keys(result.data).length;
                    console.log('‚úÖ Google Sheets\'ten', loadedCount, 'TDS y√ºklendi');
                    
                    // Ka√ß hammaddenin ka√ß √∂zelliƒüi olduƒüunu say
                    let totalProperties = 0;
                    Object.keys(result.data).forEach(materialCode => {
                        const tds = tdsData[materialCode];
                        if (tds && tds.properties && Array.isArray(tds.properties)) {
                            totalProperties += tds.properties.length;
                        }
                    });
                    
                    // Kullanƒ±cƒ±ya bildirim g√∂ster
                    showToast(`‚òÅÔ∏è ${loadedCount} hammadde i√ßin ${totalProperties} √∂zellik buluttan y√ºklendi`, 'success', 4000);
                    return true;
                } else {
                    console.log('‚ö†Ô∏è Sheets\'te TDS verisi yok');
                    showToast('‚ö†Ô∏è Bulutta TDS verisi bulunamadƒ±', 'warning', 3000);
                    return false;
                }
            } catch(error) {
                console.warn('‚ö†Ô∏è TDS y√ºkleme hatasƒ± (devam ediliyor):', error.message);
                return false;
            }
        }
        
        // ==================== Template Functions ====================
        
        // Load templates from Google Sheets
        async function loadTemplatesFromGoogleSheets() {
            if (!googleScriptUrl) {
                console.log('‚ö†Ô∏è Google Script URL yok');
                return;
            }
            
            try {
                console.log('‚òÅÔ∏è Google Sheets\'ten Template\'ler y√ºkleniyor (JSONP)...');
                
                const result = await jsonpRequest(googleScriptUrl, { action: 'getAllCOATemplates' }, 2);
                console.log('üì¶ Template response:', result);
                
                if (result && result.success && result.data) {
                    localStorage.setItem('coaTemplates', JSON.stringify(result.data));
                    console.log('‚úÖ Template listesi g√ºncellendi:', result.data.length);
                    updateTemplateDropdown();
                } else {
                    console.log('‚ö†Ô∏è Template listesi bo≈ü veya hata');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Template listesi y√ºklenemedi:', error.message);
            }
        }
        
        // Delete template from Google Sheets and localStorage
        async function deleteTemplate(supplierName, index) {
            if (!confirm(`"${supplierName}" template'ini silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem Google Sheets'ten ve yerel veritabanƒ±ndan kalƒ±cƒ± olarak silinecektir.`)) {
                return;
            }
            
            console.log('üóëÔ∏è Template siliniyor:', supplierName);
            showToast('‚è≥ Template siliniyor...', 'info');
            
            try {
                // Google Sheets'ten sil
                if (googleScriptUrl) {
                    const result = await jsonpRequest(googleScriptUrl, {
                        action: 'deleteCOATemplate',
                        supplier: supplierName
                    }, 2);
                    
                    if (result && result.success) {
                        console.log('‚úÖ Template Google Sheets\'ten silindi');
                    } else {
                        console.warn('‚ö†Ô∏è Google Sheets\'ten silme hatasƒ±:', result?.error);
                    }
                }
                
                // localStorage'dan sil
                const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
                templates.splice(index, 1);
                localStorage.setItem('coaTemplates', JSON.stringify(templates));
                
                // Template dropdown'unu g√ºncelle
                updateTemplateDropdown();
                
                // Modal a√ßƒ±ksa listeyi yenile
                const modal = document.getElementById('templateLoadModal');
                if (modal && modal.style.display === 'flex') {
                    // Hangi fonksiyondan a√ßƒ±ldƒ±ƒüƒ±na g√∂re yeniden y√ºkle
                    if (window.currentTemplateLoadMode === 'edit') {
                        await editExistingTemplate();
                    } else {
                        await loadTemplateWithImage();
                    }
                }
                
                showToast(`‚úÖ "${supplierName}" template'i silindi!`, 'success');
                console.log('‚úÖ Template ba≈üarƒ±yla silindi');
                
            } catch (error) {
                console.error('‚ùå Template silme hatasƒ±:', error);
                showToast('‚ùå Template silinirken hata olu≈ütu: ' + error.message, 'error');
            }
        }
        
        // Update template dropdown
        function updateTemplateDropdown() {
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const dropdown = document.getElementById('templateSelect');
            
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">-- Template Se√ß --</option>';
            
            templates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${template.supplier} (${new Date(template.createdAt).toLocaleDateString()})`;
                dropdown.appendChild(option);
            });
        }
        
        // Apply template to OCR
        function applyTemplate(templateIndex) {
            if (!templateIndex) {
                clearSelectedTemplate();
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const template = templates[templateIndex];
            
            if (!template) {
                console.error('‚ùå Template bulunamadƒ±');
                return;
            }
            
            console.log('üé® Template uygulanƒ±yor:', template.supplier);
            
            // Template yapƒ±sƒ±nƒ± d√ºzelt (Sheets'ten gelen template.template i√ßinde asƒ±l template var)
            const actualTemplate = template.template || template;
            window.currentTemplate = actualTemplate;
            
            console.log('üìã Template yapƒ±sƒ±:', actualTemplate);
            showToast(`üé® ${template.supplier} template'i y√ºklendi`, 'success');
        }
        
        // Clear selected template
        function clearSelectedTemplate() {
            window.currentTemplate = null;
            document.getElementById('templateSelect').value = '';
            console.log('üóëÔ∏è Template se√ßimi temizlendi');
            showToast('Template se√ßimi kaldƒ±rƒ±ldƒ±', 'info');
        }
        
        // COA Template OCR ba≈ülat
        async function startCOATemplateOCR() {
            if (!window.currentTemplate) {
                console.log('‚ö†Ô∏è Template se√ßilmemi≈ü');
                return;
            }
            
            if (!selectedFileData) {
                console.log('‚ö†Ô∏è Dosya y√ºklenmemi≈ü');
                return;
            }
            
            const materialCode = document.getElementById('materialCode').value.trim();
            if (!materialCode) {
                console.log('‚ö†Ô∏è Hammadde kodu bo≈ü');
                showToast('‚ö†Ô∏è √ñnce hammadde se√ßin', 'warning');
                return;
            }
            
            // Hammadde kodunu temizle (tek kod)
            const materialCodeOnly = materialCode.includes(' | ') ? materialCode.split(' | ')[0].trim() : 
                                     materialCode.includes(' - ') ? materialCode.split(' - ')[0].trim() : 
                                     materialCode;
            
            console.log('üöÄ COA Template OCR ba≈ülatƒ±lƒ±yor...');
            console.log('üìã Hammadde:', materialCodeOnly);
            console.log('üé® Template:', window.currentTemplate.supplier);
            
            // NOT: Eski COA deƒüerlerini TEMƒ∞ZLEME! 
            // Kullanƒ±cƒ± yeni sorguya ba≈ülayana kadar deƒüerler korunsun.
            // Yeni OCR sonu√ßlarƒ± otomatik olarak √ºzerine yazƒ±lacak.
            
            showToast('üé® Template ile COA okunuyor...', 'info');
            
            try {
                // Template OCR ile √∂zellikleri oku
                const extractedProperties = await extractCOAPropertiesWithTemplate(selectedFileData, window.currentTemplate);
                
                console.log('‚úÖ Template OCR tamamlandƒ±:', Object.keys(extractedProperties).length, '√∂zellik');
                console.log('üìä Okunan ham deƒüerler:', extractedProperties);
                
                // TDS ile kar≈üƒ±la≈ütƒ±r ve durum belirle (tick kontrol√º + range kontrol√º)
                const comparisonResults = await compareCOAValuesWithTDS(materialCodeOnly, extractedProperties);
                
                console.log('‚úÖ TDS kar≈üƒ±la≈ütƒ±rmasƒ± tamamlandƒ±:', comparisonResults);
                
                // TDS'e kaydet
                await saveTDSPropertiesFromOCR(materialCodeOnly, comparisonResults.properties);
                
                // Debug: Memory'deki COA deƒüerlerini kontrol et
                const savedTDS = tdsData[materialCodeOnly];
                if (savedTDS && savedTDS.properties) {
                    const coaCount = savedTDS.properties.filter(p => p.coaValue).length;
                    console.log(`üîç Memory'de ${coaCount} √∂zellikte COA deƒüeri var:`);
                    savedTDS.properties.forEach(prop => {
                        if (prop.coaValue) {
                            console.log(`  - ${prop.name}: "${prop.coaValue}" [${prop.coaCompliance}]`);
                        }
                    });
                    
                    // Flag'i sadece ba≈üarƒ±lƒ± OCR sonrasƒ± set et (en az 1 √∂zellik okunmu≈üsa)
                    if (coaCount > 0) {
                        lastOCRMaterialCode = materialCodeOnly;
                        console.log('üè¥ lastOCRMaterialCode set edildi:', lastOCRMaterialCode, `(${coaCount} √∂zellik okundu)`);
                        showToast(`‚úÖ ${coaCount} √∂zellik okundu ve TDS ile kar≈üƒ±la≈ütƒ±rƒ±ldƒ±!`, 'success', 5000);
                        
                        // NOT: Transfer butonu updateTransferButtonVisibility() tarafƒ±ndan g√∂sterilecek
                        // Modal a√ßƒ±ldƒ±ƒüƒ±nda otomatik olarak √ßaƒürƒ±lƒ±yor
                    } else {
                        console.log('‚ö†Ô∏è Hi√ßbir √∂zellik okunamadƒ±, lastOCRMaterialCode set edilmedi');
                        showToast('‚ö†Ô∏è Hi√ßbir √∂zellik okunamadƒ±! B√∂lgeler √ßok k√º√ß√ºk veya bulanƒ±k olabilir.', 'warning', 5000);
                    }
                }
                
                // TDS modalƒ±nƒ± a√ß ve sonu√ßlarƒ± g√∂ster
                openTDSModal(materialCodeOnly);
                
            } catch (error) {
                console.error('‚ùå COA Template OCR hatasƒ±:', error);
                showToast('‚ùå OCR hatasƒ±: ' + error.message, 'error', 5000);
            }
        }
        
        // COA deƒüerlerini TDS ile kar≈üƒ±la≈ütƒ±r (tick kontrol√º + range kontrol√º)
        async function compareCOAValuesWithTDS(materialCode, extractedProperties) {
            console.log('üîç TDS ile kar≈üƒ±la≈ütƒ±rma ba≈ülatƒ±lƒ±yor:', materialCode);
            
            // TDS'i y√ºkle
            if (!tdsData[materialCode]) {
                console.log('‚ö†Ô∏è Bu hammadde i√ßin TDS bulunamadƒ±');
                // TDS yoksa sadece okunan deƒüerleri d√∂nd√ºr
                return {
                    properties: extractedProperties,
                    matched: 0,
                    passed: 0,
                    failed: 0
                };
            }
            
            const tds = tdsData[materialCode];
            const tdsProperties = tds.properties || [];
            
            console.log('üìã TDS √∂zellikleri:', tdsProperties.length);
            
            const comparisonResults = {
                properties: {},
                matched: 0,
                passed: 0,
                failed: 0
            };
            
            // Her bir okunan √∂zellik i√ßin
            for (const [propertyName, coaValue] of Object.entries(extractedProperties)) {
                if (!coaValue || coaValue.trim() === '') continue;
                
                let cleanedCoaValue = coaValue.trim();
                
                // COA deƒüerinden birim ve operat√∂r sembolleri parse et
                let extractedUnit = '';
                let cleanedNumericValue = cleanedCoaValue;
                
                // √ñnce operat√∂r sembollerini √ßƒ±kar (‚â§, ‚â•, <, >, =)
                cleanedNumericValue = cleanedNumericValue.replace(/^[‚â§‚â•<>=]+\s*/, '');
                
                // Bo≈üluk varsa ve sayƒ± + unit formatƒ±ndaysa unit'i ayƒ±r
                // √ñrn: "0.035 W/mK" ‚Üí value: "0.035", unit: "W/mK"
                const unitMatch = cleanedNumericValue.match(/^([\d.,\s-]+)\s+([a-zA-Z\/¬∞%]+.*)$/);
                if (unitMatch) {
                    cleanedNumericValue = unitMatch[1].trim();
                    extractedUnit = unitMatch[2].trim();
                    console.log(`  üîß Unit parse edildi: "${cleanedCoaValue}" ‚Üí value="${cleanedNumericValue}", unit="${extractedUnit}"`);
                }
                
                // TDS'te bu √∂zelliƒüi bul - Fuzzy matching ile
                // 1. Tam e≈üle≈üme dene
                let tdsProp = tdsProperties.find(p => 
                    p.name && p.name.toLowerCase() === propertyName.toLowerCase()
                );
                
                // 2. Tam e≈üle≈üme yoksa, normalize edilmi≈ü e≈üle≈üme dene
                if (!tdsProp) {
                    const normalizeText = (text) => {
                        return text.toLowerCase()
                            .replace(/\s+/g, ' ')  // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
                            .replace(/\n/g, ' ')   // Satƒ±r sonlarƒ± ‚Üí bo≈üluk
                            .replace(/ƒü/g, 'g').replace(/ƒ±/g, 'i')  // T√ºrk√ße ‚Üí ƒ∞ngilizce
                            .replace(/≈ü/g, 's').replace(/√ß/g, 'c')
                            .replace(/√∂/g, 'o').replace(/√º/g, 'u')
                            .trim();
                    };
                    
                    const normalizedProp = normalizeText(propertyName);
                    
                    tdsProp = tdsProperties.find(p => {
                        if (!p.name) return false;
                        const normalizedTDS = normalizeText(p.name);
                        
                        // Tam normalize e≈üle≈üme
                        if (normalizedTDS === normalizedProp) return true;
                        
                        // Kelime bazlƒ± e≈üle≈üme: "TASIYICI AGIRLIK" i√ßinde "AGIRLIK" var mƒ±?
                        const tdsWords = normalizedTDS.split(' ');
                        const propWords = normalizedProp.split(' ');
                        
                        // Eƒüer prop tek kelimeyse ve TDS i√ßinde ge√ßiyorsa e≈üle≈üir
                        if (propWords.length === 1 && tdsWords.includes(propWords[0])) return true;
                        
                        // Tersi: TDS tek kelimeyse ve prop i√ßinde ge√ßiyorsa
                        if (tdsWords.length === 1 && propWords.includes(tdsWords[0])) return true;
                        
                        return false;
                    });
                    
                    if (tdsProp) {
                        console.log(`üîó Fuzzy match: "${propertyName}" ‚Üí "${tdsProp.name}"`);
                    }
                }
                
                if (!tdsProp) {
                    // TDS'te yok, yeni property olarak ekle
                    console.log(`‚ûï Yeni property: ${propertyName} = ${cleanedCoaValue}`);
                    comparisonResults.properties[propertyName] = {
                        value: cleanedCoaValue,
                        status: 'unknown',
                        isNew: true
                    };
                    continue;
                }
                
                comparisonResults.matched++;
                
                // Bo≈üluklu ondalƒ±k sayƒ±larƒ± d√ºzelt fonksiyonu
                const cleanNumericValue = (val) => {
                    if (!val) return val;
                    let cleaned = String(val).trim();
                    // "0 035" ‚Üí "0.035", "1 234" ‚Üí "1.234"
                    if (/^\d\s+\d+$/.test(cleaned)) {
                        const parts = cleaned.split(/\s+/);
                        cleaned = parts[0] === '0' ? '0.' + parts[1] : parts[0] + '.' + parts[1];
                    }
                    return cleaned;
                };
                
                // TDS bilgilerini hazƒ±rla - bo≈üluk normalization ile
                const tdsInfo = {
                    unit: tdsProp.unit || extractedUnit || '',  // TDS unit √∂ncelikli, yoksa COA'dan √ßƒ±karƒ±lan
                    standard: tdsProp.standard || '',
                    lowerLimit: cleanNumericValue(tdsProp.lowerLimit),
                    upperLimit: cleanNumericValue(tdsProp.upperLimit),
                    standardValue: cleanNumericValue(tdsProp.standardValue),
                    requirement: tdsProp.requirement
                };
                
                // TDS deƒüerini formatla
                let tdsValueDisplay = '';
                if (tdsInfo.lowerLimit && tdsInfo.upperLimit) {
                    tdsValueDisplay = `${tdsInfo.lowerLimit} - ${tdsInfo.upperLimit}`;
                } else if (tdsInfo.lowerLimit) {
                    tdsValueDisplay = `‚â• ${tdsInfo.lowerLimit}`;
                } else if (tdsInfo.upperLimit) {
                    tdsValueDisplay = `‚â§ ${tdsInfo.upperLimit}`;
                } else if (tdsInfo.standardValue) {
                    tdsValueDisplay = tdsInfo.standardValue;
                } else if (tdsInfo.requirement) {
                    tdsValueDisplay = tdsInfo.requirement;
                }
                
                // Tick i≈üareti kontrol√º (‚úì ‚úî ‚àö veya "Pass", "OK", "Uygun" gibi kelimeler)
                const hasTickMark = /[‚úì‚úî‚àö]/u.test(cleanedCoaValue) || 
                                   /\b(pass|ok|uygun|ge√ßti|ba≈üarƒ±lƒ±|conform)\b/i.test(cleanedCoaValue);
                const hasFailMark = /[‚úó‚úò√ó]/u.test(cleanedCoaValue) || 
                                    /\b(fail|not ok|uygun deƒüil|ge√ßmedi|ba≈üarƒ±sƒ±z|non-conform)\b/i.test(cleanedCoaValue);
                
                if (hasTickMark) {
                    // Tick i≈üareti var -> Uygun
                    console.log(`‚úÖ ${propertyName}: Tick i≈üareti bulundu -> UYGUN`);
                    comparisonResults.properties[propertyName] = {
                        value: cleanedCoaValue,
                        status: 'uygun',
                        reason: 'Tick mark detected',
                        tdsValue: tdsValueDisplay,
                        ...tdsInfo
                    };
                    comparisonResults.passed++;
                    continue;
                }
                
                if (hasFailMark) {
                    // Fail i≈üareti var -> Uygun Deƒüil
                    console.log(`‚ùå ${propertyName}: Fail i≈üareti bulundu -> UYGUN DEƒûƒ∞L`);
                    comparisonResults.properties[propertyName] = {
                        value: cleanedCoaValue,
                        status: 'uygun deƒüil',
                        reason: 'Fail mark detected',
                        tdsValue: tdsValueDisplay,
                        ...tdsInfo
                    };
                    comparisonResults.failed++;
                    continue;
                }
                
                // Sayƒ±sal deƒüer kontrol√º (range veya tek deƒüer)
                // cleanedNumericValue zaten operat√∂r ve unit temizlenmi≈ü durumda
                // Virg√ºl√º nokta ile deƒüi≈ütir (Avrupa formatƒ±: 29,8 ‚Üí 29.8)
                const normalizedValue = cleanedNumericValue.replace(/,/g, '.');
                const numericPattern = /([0-9]+\.?[0-9]*)\s*[-~]\s*([0-9]+\.?[0-9]*)/;
                const rangeMatch = normalizedValue.match(numericPattern);
                
                if (rangeMatch) {
                    // Range deƒüer (√∂rn: "29.8-30.3")
                    const lowerValue = parseFloat(rangeMatch[1]);
                    const upperValue = parseFloat(rangeMatch[2]);
                    
                    console.log(`üìä ${propertyName}: Range deƒüer bulundu: ${lowerValue} - ${upperValue}`);
                    
                    // TDS limitleri ile kar≈üƒ±la≈ütƒ±r - yoksa hesapla
                    let tdsLowerLimit = parseFloat(tdsProp.lowerLimit);
                    let tdsUpperLimit = parseFloat(tdsProp.upperLimit);
                    
                    // Limitler tanƒ±mlƒ± deƒüilse standardValue'dan hesapla
                    if (isNaN(tdsLowerLimit) || isNaN(tdsUpperLimit)) {
                        const stdValue = parseFloat(String(tdsProp.standardValue || '0').replace(/,/g, '.'));
                        const lowerTol = parseFloat(String(tdsProp.lowerTolerance || '0').replace(/,/g, '.'));
                        const upperTol = parseFloat(String(tdsProp.upperTolerance || '0').replace(/,/g, '.'));
                        
                        if (!isNaN(stdValue) && !isNaN(lowerTol) && !isNaN(upperTol)) {
                            tdsLowerLimit = stdValue - lowerTol;
                            tdsUpperLimit = stdValue + upperTol;
                            console.log(`üî¢ ${propertyName}: Limitler hesaplandƒ±: ${tdsLowerLimit} - ${tdsUpperLimit} (${stdValue} ¬±${lowerTol}/${upperTol})`);
                        }
                    }
                    
                    if (!isNaN(tdsLowerLimit) && !isNaN(tdsUpperLimit) && (tdsLowerLimit !== 0 || tdsUpperLimit !== 0)) {
                        // Her iki deƒüer de TDS limitleri i√ßinde mi?
                        const isLowerInRange = lowerValue >= tdsLowerLimit;
                        const isUpperInRange = upperValue <= tdsUpperLimit;
                        
                        if (isLowerInRange && isUpperInRange) {
                            console.log(`‚úÖ ${propertyName}: ${lowerValue}-${upperValue} TDS limitleri i√ßinde (${tdsLowerLimit}-${tdsUpperLimit}) -> UYGUN`);
                            comparisonResults.properties[propertyName] = {
                                value: cleanedCoaValue,
                                status: 'uygun',
                                reason: `Range ${lowerValue}-${upperValue} within TDS limits ${tdsLowerLimit}-${tdsUpperLimit}`,
                                tdsValue: tdsValueDisplay,
                                ...tdsInfo
                            };
                            comparisonResults.passed++;
                        } else {
                            console.log(`‚ùå ${propertyName}: ${lowerValue}-${upperValue} TDS limitleri dƒ±≈üƒ±nda (${tdsLowerLimit}-${tdsUpperLimit}) -> UYGUN DEƒûƒ∞L`);
                            comparisonResults.properties[propertyName] = {
                                value: cleanedCoaValue,
                                status: 'uygun deƒüil',
                                reason: `Range ${lowerValue}-${upperValue} outside TDS limits ${tdsLowerLimit}-${tdsUpperLimit}`,
                                tdsValue: tdsValueDisplay,
                                ...tdsInfo
                            };
                            comparisonResults.failed++;
                        }
                    } else {
                        // TDS limitleri tanƒ±mlƒ± deƒüil veya 0-0 - requirement ile kar≈üƒ±la≈ütƒ±r
                        if (tdsProp.requirement && tdsProp.requirement.trim() !== '') {
                            const normalizeStr = (str) => String(str)
                                .replace(/,/g, '.')  // Virg√ºl√º nokta yap
                                .replace(/\s+/g, '')
                                .replace(/[‚â§‚â•<>=]/g, '')
                                .toLowerCase()
                                .trim();
                            
                            const coaNorm = normalizeStr(cleanedCoaValue);
                            const reqNorm = normalizeStr(tdsProp.requirement);
                            
                            console.log(`  üîç Compliance kar≈üƒ±la≈ütƒ±rma (range): COA="${coaNorm}" vs REQ="${reqNorm}"`);
                            
                            if (coaNorm === reqNorm || coaNorm.includes(reqNorm) || reqNorm.includes(coaNorm)) {
                                console.log(`‚úÖ ${propertyName}: "${cleanedCoaValue}" requirement ile e≈üle≈üti -> UYGUN`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'uygun',
                                    reason: `Range matches requirement: ${tdsProp.requirement}`,
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                                comparisonResults.passed++;
                            } else {
                                console.log(`‚ùå ${propertyName}: "${cleanedCoaValue}" requirement ile e≈üle≈ümedi -> UYGUN DEƒûƒ∞L`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'uygun deƒüil',
                                    reason: `Range doesn't match requirement: ${tdsProp.requirement}`,
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                                comparisonResults.failed++;
                            }
                        } else {
                            console.log(`‚ö†Ô∏è ${propertyName}: TDS limitleri tanƒ±mlƒ± deƒüil ve requirement yok`);
                            comparisonResults.properties[propertyName] = {
                                value: cleanedCoaValue,
                                status: 'unknown',
                                reason: 'TDS limits not defined and no requirement'
                            };
                        }
                    }
                } else {
                    // Tek sayƒ±sal deƒüer kontrol√º
                    const singleNumMatch = normalizedValue.match(/([0-9]+\.?[0-9]*)/);
                    
                    if (singleNumMatch) {
                        const numValue = parseFloat(singleNumMatch[1]);
                        
                        console.log(`üìä ${propertyName}: Tek deƒüer bulundu: ${numValue}`);
                        
                        // TDS limitleri ile kar≈üƒ±la≈ütƒ±r - yoksa hesapla
                        let tdsLowerLimit = parseFloat(tdsProp.lowerLimit);
                        let tdsUpperLimit = parseFloat(tdsProp.upperLimit);
                        
                        // Limitler tanƒ±mlƒ± deƒüilse standardValue'dan hesapla
                        if (isNaN(tdsLowerLimit) || isNaN(tdsUpperLimit)) {
                            const stdValue = parseFloat(String(tdsProp.standardValue || '0').replace(/,/g, '.'));
                            const lowerTol = parseFloat(String(tdsProp.lowerTolerance || '0').replace(/,/g, '.'));
                            const upperTol = parseFloat(String(tdsProp.upperTolerance || '0').replace(/,/g, '.'));
                            
                            if (!isNaN(stdValue) && !isNaN(lowerTol) && !isNaN(upperTol)) {
                                tdsLowerLimit = stdValue - lowerTol;
                                tdsUpperLimit = stdValue + upperTol;
                                console.log(`üî¢ ${propertyName}: Limitler hesaplandƒ±: ${tdsLowerLimit} - ${tdsUpperLimit} (${stdValue} ¬±${lowerTol}/${upperTol})`);
                            }
                        }
                        
                        if (!isNaN(tdsLowerLimit) && !isNaN(tdsUpperLimit) && (tdsLowerLimit !== 0 || tdsUpperLimit !== 0)) {
                            // Operator kontrol√º yap
                            const operator = tdsProp.operator || 'range';
                            let isPass = false;
                            
                            if (operator === '‚â§' || operator === '<=') {
                                // K√º√ß√ºk e≈üit: sadece upperLimit kontrol√º
                                isPass = numValue <= tdsUpperLimit;
                                console.log(`üìä ${propertyName}: Operator ‚â§ | ${numValue} ‚â§ ${tdsUpperLimit} ? ${isPass}`);
                            } else if (operator === '‚â•' || operator === '>=') {
                                // B√ºy√ºk e≈üit: sadece lowerLimit kontrol√º
                                isPass = numValue >= tdsLowerLimit;
                                console.log(`üìä ${propertyName}: Operator ‚â• | ${numValue} ‚â• ${tdsLowerLimit} ? ${isPass}`);
                            } else {
                                // Range: her iki limit de kontrol
                                isPass = numValue >= tdsLowerLimit && numValue <= tdsUpperLimit;
                                console.log(`üìä ${propertyName}: Operator range | ${tdsLowerLimit} ‚â§ ${numValue} ‚â§ ${tdsUpperLimit} ? ${isPass}`);
                            }
                            
                            if (isPass) {
                                console.log(`‚úÖ ${propertyName}: ${numValue} TDS limitleri i√ßinde -> UYGUN`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'uygun',
                                    reason: `Value ${numValue} within TDS limits`,
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                                comparisonResults.passed++;
                            } else {
                                console.log(`‚ùå ${propertyName}: ${numValue} TDS limitleri dƒ±≈üƒ±nda -> UYGUN DEƒûƒ∞L`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'uygun deƒüil',
                                    reason: `Value ${numValue} outside TDS limits`,
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                                comparisonResults.failed++;
                            }
                        } else {
                            // TDS limitleri tanƒ±mlƒ± deƒüil veya 0-0 - requirement ile kar≈üƒ±la≈ütƒ±r
                            if (tdsProp.requirement && tdsProp.requirement.trim() !== '') {
                                const normalizeStr = (str) => String(str)
                                    .replace(/,/g, '.')  // Virg√ºl√º nokta yap
                                    .replace(/\s+/g, '')
                                    .replace(/[‚â§‚â•<>=]/g, '')
                                    .toLowerCase()
                                    .trim();
                                
                                const coaNorm = normalizeStr(cleanedCoaValue);
                                const reqNorm = normalizeStr(tdsProp.requirement);
                                
                                console.log(`  üîç Compliance kar≈üƒ±la≈ütƒ±rma (single): COA="${coaNorm}" vs REQ="${reqNorm}"`);
                                
                                if (coaNorm === reqNorm || coaNorm.includes(reqNorm) || reqNorm.includes(coaNorm)) {
                                    console.log(`‚úÖ ${propertyName}: "${cleanedCoaValue}" requirement ile e≈üle≈üti -> UYGUN`);
                                    comparisonResults.properties[propertyName] = {
                                        value: cleanedCoaValue,
                                        status: 'uygun',
                                        reason: `Value matches requirement: ${tdsProp.requirement}`,
                                        tdsValue: tdsValueDisplay,
                                        ...tdsInfo
                                    };
                                    comparisonResults.passed++;
                                } else {
                                    console.log(`‚ùå ${propertyName}: "${cleanedCoaValue}" requirement ile e≈üle≈ümedi -> UYGUN DEƒûƒ∞L`);
                                    comparisonResults.properties[propertyName] = {
                                        value: cleanedCoaValue,
                                        status: 'uygun deƒüil',
                                        reason: `Value doesn't match requirement: ${tdsProp.requirement}`,
                                        tdsValue: tdsValueDisplay,
                                        ...tdsInfo
                                    };
                                    comparisonResults.failed++;
                                }
                            } else {
                                console.log(`‚ö†Ô∏è ${propertyName}: TDS limitleri tanƒ±mlƒ± deƒüil ve requirement yok`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'unknown',
                                    reason: 'TDS limits not defined and no requirement',
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                            }
                        }
                    } else {
                        // Sayƒ±sal deƒüer deƒüil, metin - requirement ile kar≈üƒ±la≈ütƒ±r
                        console.log(`üìù ${propertyName}: Metin deƒüer: ${cleanedCoaValue}`);
                        
                        // Eƒüer requirement tanƒ±mlƒ±ysa text kar≈üƒ±la≈ütƒ±rmasƒ± yap
                        if (tdsProp.requirement && tdsProp.requirement.trim() !== '') {
                            const normalizeStr = (str) => String(str)
                                .replace(/,/g, '.')  // Virg√ºl√º nokta yap
                                .replace(/\s+/g, '')
                                .replace(/[‚â§‚â•<>=]/g, '')
                                .toLowerCase()
                                .trim();
                            
                            const coaNorm = normalizeStr(cleanedCoaValue);
                            const reqNorm = normalizeStr(tdsProp.requirement);
                            
                            console.log(`  üîç Compliance kar≈üƒ±la≈ütƒ±rma: COA="${coaNorm}" vs REQ="${reqNorm}"`);
                            
                            if (coaNorm === reqNorm || coaNorm.includes(reqNorm) || reqNorm.includes(coaNorm)) {
                                console.log(`‚úÖ ${propertyName}: "${cleanedCoaValue}" requirement ile e≈üle≈üti -> UYGUN`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'uygun',
                                    reason: `Text matches requirement: ${tdsProp.requirement}`,
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                                comparisonResults.passed++;
                            } else {
                                console.log(`‚ùå ${propertyName}: "${cleanedCoaValue}" requirement ile e≈üle≈ümedi -> UYGUN DEƒûƒ∞L`);
                                comparisonResults.properties[propertyName] = {
                                    value: cleanedCoaValue,
                                    status: 'uygun deƒüil',
                                    reason: `Text doesn't match requirement: ${tdsProp.requirement}`,
                                    tdsValue: tdsValueDisplay,
                                    ...tdsInfo
                                };
                                comparisonResults.failed++;
                            }
                        } else {
                            // Requirement yok, unknown bƒ±rak
                            comparisonResults.properties[propertyName] = {
                                value: cleanedCoaValue,
                                status: 'unknown',
                                reason: 'Text value, no requirement defined',
                                tdsValue: tdsValueDisplay,
                                ...tdsInfo
                            };
                        }
                    }
                }
            }
            
            console.log('üìä Kar≈üƒ±la≈ütƒ±rma √∂zeti:');
            console.log('  - E≈üle≈üen:', comparisonResults.matched);
            console.log('  - Uygun:', comparisonResults.passed);
            console.log('  - Uygun Deƒüil:', comparisonResults.failed);
            
            return comparisonResults;
        }
        
        // TDS modalƒ±nƒ± a√ß
        async function openTDSModal(preselectedMaterialCode = null) {
            if (materials.length === 0) {
                showToast('‚ö†Ô∏è √ñnce Excel y√ºkleyip hammadde listesini olu≈üturun', 'warning');
                return;
            }
            
            // Google Sheets'ten TDS verilerini y√ºkle (en g√ºncel verileri al)
            console.log('‚òÅÔ∏è TDS Modal a√ßƒ±lƒ±yor, Sheets\'ten veriler y√ºkleniyor...');
            await loadTDSFromGoogleSheets();
            
            // API key'leri ve OCR engine'i input'lara y√ºkle
            const apiKeyInput = document.getElementById('ocrApiKeyInput');
            if (apiKeyInput) {
                apiKeyInput.value = localStorage.getItem('ocrspace_api_key') || 'K82811583888957';
            }
            
            const azureKeyInput = document.getElementById('azureApiKeyInput');
            if (azureKeyInput) {
                azureKeyInput.value = localStorage.getItem('azure_api_key') || '';
            }
            
            const azureEndpointInput = document.getElementById('azureEndpointInput');
            if (azureEndpointInput) {
                azureEndpointInput.value = localStorage.getItem('azure_endpoint') || '';
            }
            
            const ocrEngineSelect = document.getElementById('ocrEngineSelect');
            if (ocrEngineSelect) {
                ocrEngineSelect.value = localStorage.getItem('ocr_engine') || 'ocrspace';
            }
            
            // Eƒüer parametre g√∂nderilmediyse, COA formundaki hammaddeyi kontrol et
            if (!preselectedMaterialCode) {
                const materialInput = document.getElementById('materialCode');
                console.log('üîç Material input deƒüeri:', materialInput ? materialInput.value : 'Bulunamadƒ±');
                
                if (materialInput && materialInput.value) {
                    const value = materialInput.value.trim();
                    // Format: "KOD | ƒ∞Sƒ∞M" veya "KOD - ƒ∞Sƒ∞M"
                    if (value.includes(' | ')) {
                        preselectedMaterialCode = value.split(' | ')[0].trim();
                    } else if (value.includes(' - ')) {
                        preselectedMaterialCode = value.split(' - ')[0].trim();
                    } else {
                        preselectedMaterialCode = value;
                    }
                    console.log('‚úÇÔ∏è √áƒ±karƒ±lan hammadde kodu:', preselectedMaterialCode);
                }
            }
            
            const select = document.getElementById('tdsMaterialSelect');
            select.innerHTML = '<option value="">Hammadde se√ßin...</option>';
            
            let foundMatch = false;
            materials.forEach(m => {
                const code = m.code || m.stockCode || m.stokKodu;
                const name = m.name || m.stockName || m.stokAdƒ±;
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} | ${name}`;
                
                // Eƒüer bu hammadde se√ßili olacaksa i≈üaretle
                if (preselectedMaterialCode && code === preselectedMaterialCode) {
                    console.log('‚úÖ E≈üle≈üme bulundu:', code);
                    option.selected = true;
                    foundMatch = true;
                }
                
                select.appendChild(option);
            });
            
            console.log('üìä Toplam hammadde sayƒ±sƒ±:', materials.length);
            console.log('üéØ Aranan kod:', preselectedMaterialCode);
            console.log('üîó E≈üle≈üme durumu:', foundMatch);
            
            document.getElementById('tdsModal').classList.add('active');
            
            // Template dropdown'ƒ± doldur
            populateTDSTemplateDropdown();
            
            // Template section'ƒ± g√∂ster (sadece hammadde se√ßiliyse)
            const tdsTemplateSection = document.getElementById('tdsTemplateSection');
            if (tdsTemplateSection) {
                tdsTemplateSection.style.display = preselectedMaterialCode ? 'block' : 'none';
            }
            
            // Eƒüer e≈üle≈üen hammadde varsa otomatik y√ºkle
            if (foundMatch && preselectedMaterialCode) {
                select.value = preselectedMaterialCode;
                console.log('üîÑ loadTDSForMaterial √ßaƒürƒ±lƒ±yor...');
                // Eƒüer bu hammadde i√ßin OCR yeni yapƒ±ldƒ±ysa deƒüerleri koru
                const shouldClear = (lastOCRMaterialCode !== preselectedMaterialCode);
                console.log('üßπ shouldClear:', shouldClear, '| lastOCR:', lastOCRMaterialCode, '| current:', preselectedMaterialCode);
                loadTDSForMaterial(shouldClear, true); // skipReload=true (Sheets'ten yeni y√ºklendi)
                
                // FLAG TEMƒ∞ZLEME KODU KALDIRILDI - Modal kapanƒ±nca temizlenecek
            } else {
                document.getElementById('tdsContent').style.display = 'none';
                document.getElementById('tdsEmptyState').style.display = 'block';
            }
        }
        
        // TDS modalƒ±nƒ± kapat
        function closeTDSModal() {
            document.getElementById('tdsModal').classList.remove('active');
            currentTDSMaterial = null;
            
            // NOT: lastOCRMaterialCode temizlenmiyor! 
            // COA deƒüerleri modal tekrar a√ßƒ±lƒ±nca korunsun.
            // Sadece "Yeni Sorgu" butonuna basƒ±ldƒ±ƒüƒ±nda temizlenecek (sayfa yenilenince).
            console.log('üìã Modal kapandƒ±, lastOCRMaterialCode korunuyor:', lastOCRMaterialCode);
            
            // NOT: Transfer butonu gizlenmiyor!
            // Modal tekrar a√ßƒ±lƒ±nca COA deƒüerleri varsa g√∂sterilecek.
        }
        
        // Transfer butonu g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
        function updateTransferButtonVisibility(materialCode) {
            const transferBtn = document.getElementById('transferOCRBtn');
            const ocrInfo = document.getElementById('ocrDataInfo');
            const ocrCount = document.getElementById('ocrDataCount');
            
            if (!transferBtn || !ocrInfo || !ocrCount) return;
            
            // COA deƒüeri olan √∂zellikleri say
            const tds = tdsData[materialCode];
            if (!tds || !tds.properties) {
                transferBtn.style.display = 'none';
                ocrInfo.style.display = 'none';
                return;
            }
            
            const coaPropertiesCount = tds.properties.filter(p => p.coaValue && p.coaValue.trim() !== '').length;
            
            if (coaPropertiesCount > 0) {
                transferBtn.style.display = 'block';
                ocrInfo.style.display = 'block';
                ocrCount.textContent = coaPropertiesCount;
                console.log(`‚úÖ Transfer butonu g√∂steriliyor: ${coaPropertiesCount} √∂zellik`);
            } else {
                transferBtn.style.display = 'none';
                ocrInfo.style.display = 'none';
                console.log('‚ö†Ô∏è COA deƒüeri yok, transfer butonu gizleniyor');
            }
        }
        
        // OCR verilerini COA kaydƒ± olarak direkt kaydet
        async function transferOCRDataToCOA() {
            const materialCode = document.getElementById('tdsMaterialSelect').value;
            if (!materialCode) {
                showToast('‚ö†Ô∏è Hammadde kodu se√ßili deƒüil!', 'warning');
                return;
            }
            
            // TDS verilerinden OCR'dan okunan deƒüerleri al
            const tds = tdsData[materialCode];
            if (!tds || !tds.properties) {
                showToast('‚ö†Ô∏è TDS verisi bulunamadƒ±!', 'warning');
                return;
            }
            
            // COA deƒüeri olan √∂zellikleri say
            const coaProperties = tds.properties.filter(p => p.coaValue && p.coaValue.trim() !== '');
            
            if (coaProperties.length === 0) {
                showToast('‚ö†Ô∏è Kaydedilecek COA deƒüeri bulunamadƒ±!', 'warning');
                return;
            }
            
            // Dosya kontrol√º (Template OCR sƒ±rasƒ±nda y√ºklendi mi?)
            if (!selectedFile || !selectedFileData) {
                showToast('‚ùå Dosya y√ºkl√º deƒüil! √ñnce COA dosyasƒ±nƒ± y√ºkleyin.', 'error');
                return;
            }
            
            // Ana formdaki hammadde kodunu doldur
            const materialCodeInput = document.getElementById('materialCode');
            if (materialCodeInput) {
                materialCodeInput.value = materialCode;
            }
            
            // Tedarik√ßiyi bul ve doldur (varsa)
            const materialCodeOnly = materialCode.split('|')[0].trim();
            const material = materials.find(m => 
                (m.code || m.stockCode || m.stokKodu) === materialCodeOnly
            );
            
            const supplierInput = document.getElementById('supplierInput');
            if (supplierInput) {
                if (material && material.deliveries && material.deliveries.length > 0) {
                    // ƒ∞lk delivery'den tedarik√ßiyi al
                    supplierInput.value = material.deliveries[0].supplier || '';
                } else {
                    // Manuel girilmesi i√ßin bo≈ü bƒ±rak
                    supplierInput.value = '';
                }
            }
            
            // Tarih bug√ºn√ºn tarihi (eƒüer bo≈üsa)
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (deliveryDateInput && !deliveryDateInput.value) {
                deliveryDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Global deƒüi≈ükene kaydet (saveCOA sƒ±rasƒ±nda kullanƒ±lacak)
            window.pendingOCRData = {
                materialCode: materialCode,
                properties: coaProperties,
                timestamp: Date.now()
            };
            
            console.log('‚úÖ OCR verileri COA kaydƒ± i√ßin hazƒ±rlandƒ±:', coaProperties.length, '√∂zellik');
            coaProperties.forEach(p => {
                console.log(`  - ${p.name}: ${p.coaValue} [${p.coaCompliance}]`);
            });
            
            // Modal'ƒ± kapat
            closeTDSModal();
            
            // Kaydet fonksiyonunu √ßaƒüƒ±r
            console.log('üíæ saveCOA() otomatik √ßaƒürƒ±lƒ±yor...');
            showToast('üíæ COA kaydƒ± olu≈üturuluyor...', 'info', 2000);
            
            // Kƒ±sa bir timeout ile saveCOA'yƒ± √ßaƒüƒ±r (UI'nin g√ºncellenmesi i√ßin)
            setTimeout(async () => {
                try {
                    await saveCOA();
                } catch (error) {
                    console.error('‚ùå COA kayƒ±t hatasƒ±:', error);
                    showToast('‚ùå Kayƒ±t hatasƒ±: ' + error.message, 'error');
                }
            }, 300);
        }
        
        // ==================== TDS Template OCR Functions ====================
        
        // TDS Template dropdown'ƒ± doldur
        function populateTDSTemplateDropdown() {
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const dropdown = document.getElementById('tdsTemplateSelect');
            
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">Template se√ßin...</option>';
            
            templates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${template.supplier} (v${template.version || '1.0'})`;
                dropdown.appendChild(option);
            });
            
            console.log('üé® TDS Template dropdown dolduruldu:', templates.length, 'template');
        }
        
        // Template selection deƒüi≈üince
        document.addEventListener('DOMContentLoaded', function() {
            const templateSelect = document.getElementById('tdsTemplateSelect');
            if (templateSelect) {
                templateSelect.addEventListener('change', function() {
                    const processBtn = document.getElementById('tdsProcessBtn');
                    // Template se√ßiliyse butonu aktif et
                    processBtn.disabled = !this.value;
                });
            }
        });
        
        // TDS Template OCR i≈ülemini ba≈ülat
        async function processTDSTemplateOCR() {
            const materialCode = document.getElementById('tdsMaterialSelect').value;
            const templateIndex = document.getElementById('tdsTemplateSelect').value;
            
            if (!materialCode) {
                showToast('‚ùå √ñnce hammadde se√ßin', 'error');
                return;
            }
            
            if (!templateIndex) {
                showToast('‚ùå √ñnce template se√ßin', 'error');
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const templateData = templates[templateIndex];
            
            if (!templateData) {
                showToast('‚ùå Template bulunamadƒ±', 'error');
                return;
            }
            
            // Template yapƒ±sƒ±nƒ± d√ºzelt
            const actualTemplate = templateData.template || templateData;
            
            if (!actualTemplate.regions || !Array.isArray(actualTemplate.regions)) {
                showToast('‚ùå Template yapƒ±sƒ± hatalƒ±', 'error');
                console.error('Template yapƒ±sƒ±:', actualTemplate);
                return;
            }
            
            // Template'teki T√úM √∂zellik adlarƒ±nƒ± topla (dok√ºman olsa da olmasada sadece √∂zellik adlarƒ± eklenecek)
            const propertyNames = actualTemplate.regions
                .map(r => r.propertyName)
                .filter(name => name && name.trim() !== '');
            
            if (propertyNames.length === 0) {
                showToast('‚ùå Template\'de √∂zellik adƒ± bulunamadƒ±', 'error');
                return;
            }
            
            console.log('üìã Template\'ten √∂zellik adlarƒ± ekleniyor...');
            console.log('üé® Template:', actualTemplate.supplier, '|', propertyNames.length, '√∂zellik');
            
            // TDS'e sadece √∂zellik adlarƒ±nƒ± ekle (COA deƒüerleri eklenmeyecek)
            addPropertyNamesToTDS(materialCode, propertyNames);
            
            showToast(`‚úÖ ${propertyNames.length} √∂zellik adƒ± TDS'e eklendi!`, 'success', 5000);
            
            // TDS'i yeniden y√ºkle (skipReload=true - Sheets'ten yeniden y√ºkleme!)
            loadTDSForMaterial(false, true);
        }
        
        // Template'ten sadece √∂zellik adlarƒ±nƒ± TDS'e ekle
        function addPropertyNamesToTDS(materialCode, propertyNames) {
            console.log('üìù √ñzellik adlarƒ± TDS\'e ekleniyor:', materialCode, propertyNames);
            
            // Mevcut TDS'i y√ºkle
            if (!tdsData[materialCode]) {
                tdsData[materialCode] = { properties: [] };
            }
            
            const tds = tdsData[materialCode];
            
            // Properties dizisi yoksa olu≈ütur
            if (!Array.isArray(tds.properties)) {
                tds.properties = [];
            }
            
            let addedCount = 0;
            
            // Normalize function (fuzzy matching i√ßin)
            const normalizeText = (text) => {
                return text.toLowerCase()
                    .replace(/\s+/g, ' ')  // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
                    .replace(/\n/g, ' ')   // Satƒ±r sonlarƒ± ‚Üí bo≈üluk
                    .replace(/ƒü/g, 'g').replace(/ƒ±/g, 'i')  // T√ºrk√ße ‚Üí ƒ∞ngilizce
                    .replace(/≈ü/g, 's').replace(/√ß/g, 'c')
                    .replace(/√∂/g, 'o').replace(/√º/g, 'u')
                    .trim();
            };
            
            // Her bir √∂zellik adƒ± i√ßin
            propertyNames.forEach(propertyName => {
                // 1. Tam e≈üle≈üme dene
                let exists = tds.properties.some(p => 
                    p.name && p.name.toLowerCase() === propertyName.toLowerCase()
                );
                
                // 2. Tam e≈üle≈üme yoksa fuzzy matching
                if (!exists) {
                    const normalizedProp = normalizeText(propertyName);
                    
                    exists = tds.properties.some(p => {
                        if (!p.name) return false;
                        const normalizedTDS = normalizeText(p.name);
                        
                        // Tam normalize e≈üle≈üme
                        if (normalizedTDS === normalizedProp) return true;
                        
                        // Kelime bazlƒ± e≈üle≈üme
                        const tdsWords = normalizedTDS.split(' ');
                        const propWords = normalizedProp.split(' ');
                        
                        // Tek kelime ‚Üí i√ßinde ge√ßiyor mu?
                        if (propWords.length === 1 && tdsWords.includes(propWords[0])) return true;
                        if (tdsWords.length === 1 && propWords.includes(tdsWords[0])) return true;
                        
                        return false;
                    });
                    
                    if (exists) {
                        console.log(`üîó Fuzzy match (template): "${propertyName}" zaten var (benzer e≈üle≈üme)`);
                    }
                }
                
                if (!exists) {
                    // Yoksa yeni property ekle (sadece ad, diƒüer alanlar bo≈ü)
                    tds.properties.push({
                        name: propertyName,
                        unit: '',
                        standard: '',
                        operator: '=',
                        standardValue: '',
                        lowerTolerance: '1.5',
                        upperTolerance: '1.5',
                        lowerLimit: '0.00',
                        upperLimit: '0.00',
                        coaValue: '',
                        coaCompliance: '-'
                    });
                    addedCount++;
                    console.log(`‚ûï Eklendi: ${propertyName}`);
                } else {
                    console.log(`‚è© Zaten var: ${propertyName}`);
                }
            });
            
            // TDS'i localStorage'a kaydet
            localStorage.setItem('tdsData', JSON.stringify(tdsData));
            console.log(`‚úÖ ${addedCount} yeni √∂zellik eklendi, localStorage'a kaydedildi`);
            
            return addedCount;
        }
        
        // Okunan √∂zellikleri TDS'e kaydet
        async function saveTDSPropertiesFromOCR(materialCode, properties) {
            console.log('üíæ TDS\'e kaydediliyor:', materialCode, properties);
            
            // Mevcut TDS'i y√ºkle
            if (!tdsData[materialCode]) {
                tdsData[materialCode] = { properties: [] };
            }
            
            const tds = tdsData[materialCode];
            
            // Properties dizisi yoksa olu≈ütur
            if (!Array.isArray(tds.properties)) {
                tds.properties = [];
            }
            
            // Her bir okunan √∂zellik i√ßin
            for (const [propertyName, propertyData] of Object.entries(properties)) {
                // propertyData string (eski format) veya object (yeni comparison format) olabilir
                let coaValue, status;
                
                if (typeof propertyData === 'string') {
                    // Eski format - sadece string deƒüer
                    coaValue = propertyData;
                    status = 'Uygun'; // Default
                } else if (propertyData && typeof propertyData === 'object') {
                    // Yeni comparison format - { value, status, reason }
                    coaValue = propertyData.value;
                    status = propertyData.status || 'unknown';
                    
                    // Status normalize et
                    if (status === 'unknown' || status === 'Bilinmiyor') {
                        status = '-'; // Belirsiz durumlar i√ßin dash
                    }
                } else {
                    continue; // Ge√ßersiz veri
                }
                
                if (!coaValue || coaValue.trim() === '') continue;
                
                // TDS'te bu property'yi bul - Fuzzy matching ile
                const normalizeText = (text) => {
                    return text.toLowerCase()
                        .replace(/\s+/g, ' ')  // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa √ßevir
                        .replace(/\n/g, ' ')   // Satƒ±r sonlarƒ± ‚Üí bo≈üluk
                        .replace(/ƒü/g, 'g').replace(/ƒ±/g, 'i')  // T√ºrk√ße ‚Üí ƒ∞ngilizce
                        .replace(/≈ü/g, 's').replace(/√ß/g, 'c')
                        .replace(/√∂/g, 'o').replace(/√º/g, 'u')
                        .trim();
                };
                
                // 1. Tam e≈üle≈üme dene
                let existingProp = tds.properties.find(p => 
                    p.name && p.name.toLowerCase() === propertyName.toLowerCase()
                );
                
                // 2. Tam e≈üle≈üme yoksa fuzzy matching
                if (!existingProp) {
                    const normalizedProp = normalizeText(propertyName);
                    
                    existingProp = tds.properties.find(p => {
                        if (!p.name) return false;
                        const normalizedTDS = normalizeText(p.name);
                        
                        // Tam normalize e≈üle≈üme
                        if (normalizedTDS === normalizedProp) return true;
                        
                        // Kelime bazlƒ± e≈üle≈üme
                        const tdsWords = normalizedTDS.split(' ');
                        const propWords = normalizedProp.split(' ');
                        
                        // Tek kelime ‚Üí i√ßinde ge√ßiyor mu?
                        if (propWords.length === 1 && tdsWords.includes(propWords[0])) return true;
                        if (tdsWords.length === 1 && propWords.includes(tdsWords[0])) return true;
                        
                        return false;
                    });
                    
                    if (existingProp) {
                        console.log(`üîó Fuzzy match (save): "${propertyName}" ‚Üí "${existingProp.name}"`);
                    }
                }
                
                if (existingProp) {
                    // Varsa COA deƒüerini ve durumunu g√ºncelle
                    existingProp.coaValue = coaValue.trim();
                    existingProp.coaCompliance = status;
                    console.log(`üìù G√ºncellendi: ${propertyName} = ${coaValue} [${status}]`);
                } else {
                    // Yoksa yeni property ekle
                    tds.properties.push({
                        name: propertyName,
                        unit: '',
                        standard: '',
                        operator: 'Aralƒ±k',
                        standardValue: '',
                        lowerTolerance: '',
                        upperTolerance: '',
                        lowerLimit: '',
                        upperLimit: '',
                        coaValue: coaValue.trim(),
                        coaCompliance: status
                    });
                    console.log(`‚ûï Yeni eklendi: ${propertyName} = ${coaValue} [${status}]`);
                }
            }
            
            // TDS'i sadece memory'de tut (Sheets'e kaydetme - COA deƒüerleri ge√ßici!)
            // localStorage'a bile kaydetme, √ß√ºnk√º COA deƒüerleri ge√ßici
            console.log('‚úÖ COA deƒüerleri memory\'de tutuldu (ge√ßici - Sheets\'e kaydedilmedi)');
            
            return true;
        }
        
        // ==================== End TDS Template OCR Functions ====================
        
        
        // Hammadde se√ßildiƒüinde TDS y√ºkle
        function loadTDSForMaterial(clearCOAValues = true, skipReload = false) {
            const materialCode = document.getElementById('tdsMaterialSelect').value;
            if (!materialCode) {
                document.getElementById('tdsContent').style.display = 'none';
                document.getElementById('tdsEmptyState').style.display = 'block';
                return;
            }
            
            // TDS verilerini yeniden y√ºkle (sadece gerekiyorsa - openTDSModal'dan skipReload=true gelirse y√ºkleme)
            if (!skipReload) {
                loadTDSData();
            }
            
            currentTDSMaterial = materialCode;
            document.getElementById('tdsContent').style.display = 'block';
            document.getElementById('tdsEmptyState').style.display = 'none';
            
            // Template section'ƒ± g√∂ster
            const tdsTemplateSection = document.getElementById('tdsTemplateSection');
            if (tdsTemplateSection) {
                tdsTemplateSection.style.display = 'block';
            }
            
            // Mevcut TDS varsa y√ºkle
            let tds = tdsData[materialCode];
            if (tds && tds.properties) {
                console.log(`üìã ${materialCode} TDS y√ºkleniyor, properties tipi:`, typeof tds.properties, '| Array?', Array.isArray(tds.properties));
                
                // Array kontrol√º
                if (!Array.isArray(tds.properties)) {
                    if (tds.properties.properties && Array.isArray(tds.properties.properties)) {
                        // Nested yapƒ±: { properties: { properties: [...] } }
                        console.log(`üîß ${materialCode} nested yapƒ± d√ºzeltiliyor (render) - ${tds.properties.properties.length} √∂zellik`);
                        tds.properties = tds.properties.properties;
                        // Global tdsData'yƒ± da g√ºncelle
                        tdsData[materialCode] = tds;
                        localStorage.setItem('tdsData', JSON.stringify(tdsData));
                        console.log(`üíæ ${materialCode} d√ºzeltilmi≈ü yapƒ± localStorage'a kaydedildi`);
                    } else {
                        console.warn(`‚ö†Ô∏è ${materialCode} properties array deƒüil ve nested de deƒüil, bo≈ü ba≈ülatƒ±lƒ±yor`);
                        console.warn(`   Tipi: ${typeof tds.properties}, ƒ∞√ßeriƒüi:`, tds.properties);
                        tds.properties = [];
                    }
                }
                
                console.log(`‚úÖ ${materialCode} render edilecek: ${tds.properties.length} √∂zellik`);
                
                // Normal modal a√ßƒ±lƒ±≈üta eski COA deƒüerlerini temizle, OCR sonrasƒ± koru
                if (clearCOAValues) {
                    console.log(`üßπ ${materialCode} COA deƒüerleri temizleniyor (clearCOAValues=true)`);
                    tds.properties.forEach(prop => {
                        delete prop.coaValue;
                        delete prop.coaCompliance;
                    });
                    // Temizlenmi≈ü hali sadece localStorage'a kaydet (Sheets'e kaydetme!)
                    localStorage.setItem('tdsData', JSON.stringify(tdsData));
                } else {
                    // COA deƒüerleri korunuyor
                    const coaCount = tds.properties.filter(p => p.coaValue).length;
                    console.log(`üîí ${materialCode} COA deƒüerleri korunuyor (clearCOAValues=false): ${coaCount} √∂zellikte COA deƒüeri var`);
                    
                    // ‚úÖ Mevcut COA deƒüerleri i√ßin compliance'ƒ± yeniden hesapla
                    tds.properties.forEach(prop => {
                        if (prop.coaValue) {
                            const oldCompliance = prop.coaCompliance || 'yok';
                            const newCompliance = calculateCompliance(
                                prop.coaValue,
                                prop.requirement,
                                prop.min,
                                prop.max,
                                prop.standardValue
                            );
                            prop.coaCompliance = newCompliance;
                            console.log(`  - ${prop.name}: "${prop.coaValue}" [${oldCompliance} ‚Üí ${newCompliance}]`);
                        }
                    });
                    
                    // G√ºncellenmi≈ü compliance deƒüerlerini localStorage'a kaydet
                    localStorage.setItem('tdsData', JSON.stringify(tdsData));
                }
                renderTDSProperties(tds.properties);
                
                // Transfer butonu g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle (COA deƒüerleri varsa g√∂ster)
                updateTransferButtonVisibility(materialCode);
            } else {
                // Bo≈ü ba≈ülat
                renderTDSProperties([]);
            }
        }
        
        // TDS √∂zelliklerini tablo olarak render et
        function renderTDSProperties(properties) {
            const tbody = document.getElementById('tdsPropertiesTable');
            tbody.innerHTML = '';
            
            if (properties.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="padding: 20px; text-align: center; color: #999;">√ñzellik eklenmemi≈ü. "Yeni √ñzellik Ekle" butonuna tƒ±klayƒ±n.</td></tr>';
                return;
            }
            
            properties.forEach((prop, index) => {
                // Limit hesapla - standart deƒüerdeki ondalƒ±k basamak sayƒ±sƒ±na g√∂re
                const stdValueStr = String(prop.standardValue || '0').replace(/,/g, '.');
                const stdValue = parseFloat(stdValueStr);
                const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                
                // Standart deƒüer, toleranslar ve sonu√ßlarƒ±n ondalƒ±k basamak sayƒ±sƒ±nƒ± bul
                let decimalPlaces = 2; // Varsayƒ±lan
                
                // Standard value'daki ondalƒ±k basamaklarƒ± kontrol et
                if (stdValueStr.includes('.')) {
                    const decimalPart = stdValueStr.split('.')[1];
                    decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                }
                
                // Lower tolerance'daki ondalƒ±k basamaklarƒ± kontrol et
                const lowerTolStr = String(prop.lowerTolerance || '0');
                if (lowerTolStr.includes('.')) {
                    const decimalPart = lowerTolStr.split('.')[1];
                    decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                }
                
                // Upper tolerance'daki ondalƒ±k basamaklarƒ± kontrol et
                const upperTolStr = String(prop.upperTolerance || '0');
                if (upperTolStr.includes('.')) {
                    const decimalPart = upperTolStr.split('.')[1];
                    decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                }
                
                // Hesaplanan limitlerin ondalƒ±k basamaklarƒ±nƒ± da kontrol et
                const calculatedLower = stdValue - lowerTol;
                const calculatedUpper = stdValue + upperTol;
                const calcLowerStr = calculatedLower.toString();
                const calcUpperStr = calculatedUpper.toString();
                
                if (calcLowerStr.includes('.')) {
                    const decimalPart = calcLowerStr.split('.')[1];
                    decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                }
                if (calcUpperStr.includes('.')) {
                    const decimalPart = calcUpperStr.split('.')[1];
                    decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                }
                
                // En az 3 ondalƒ±k basamak kullan (0,035 gibi deƒüerleri korumak i√ßin)
                decimalPlaces = Math.max(3, decimalPlaces);
                
                const lowerLimit = (stdValue - lowerTol).toFixed(decimalPlaces);
                const upperLimit = (stdValue + upperTol).toFixed(decimalPlaces);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${prop.name || ''}" oninput="updateTDSProperty(${index}, 'name', this.value)" 
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="√ñrn: Dansite">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${prop.unit || ''}" oninput="updateTDSProperty(${index}, 'unit', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="kg/m3">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <input type="text" value="${prop.standard || ''}" oninput="updateTDSProperty(${index}, 'standard', this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="ISO845">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <select value="${prop.operator || '='}" onchange="toggleTDSMode(${index}, this.value)"
                                style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            <option value="=" ${prop.operator === '=' ? 'selected' : ''}>=</option>
                            <option value="<" ${prop.operator === '<' ? 'selected' : ''}>&lt;</option>
                            <option value=">" ${prop.operator === '>' ? 'selected' : ''}>&gt;</option>
                            <option value="<=" ${prop.operator === '<=' ? 'selected' : ''}>‚â§</option>
                            <option value=">=" ${prop.operator === '>=' ? 'selected' : ''}>‚â•</option>
                            <option value="range" ${prop.operator === 'range' ? 'selected' : ''}>Aralƒ±k</option>
                            <option value="compliance" ${prop.operator === 'compliance' ? 'selected' : ''}>Uygunluk Kontrol√º</option>
                        </select>
                    </td>
                    ${prop.operator === 'compliance' ? `
                        <td colspan="5" style="padding: 8px; border: 1px solid #ddd; background: #f5f5f5;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600; color: #666; white-space: nowrap;">Requirement:</span>
                                <input type="text" value="${prop.requirement || ''}" oninput="updateTDSProperty(${index}, 'requirement', this.value)"
                                       style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" 
                                       placeholder="√ñrn: 7,5 - 10,5 kg/m3 veya ‚â• 45 N veya Class A">
                            </div>
                        </td>
                    ` : `
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            <input type="text" value="${prop.standardValue || ''}" oninput="updateTDSPropertyWithCalc(${index}, 'standardValue', this.value)"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center;" placeholder="15">
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            <input type="text" value="${prop.lowerTolerance || ''}" oninput="updateTDSPropertyWithCalc(${index}, 'lowerTolerance', this.value)"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center;" placeholder="1.5">
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            <input type="text" value="${prop.upperTolerance || ''}" oninput="updateTDSPropertyWithCalc(${index}, 'upperTolerance', this.value)"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center;" placeholder="1.5">
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; font-weight: 600; color: #33691e;">
                            ${isNaN(parseFloat(lowerLimit)) ? '-' : lowerLimit}
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f1f8e9; font-weight: 600; color: #33691e;">
                            ${isNaN(parseFloat(upperLimit)) ? '-' : upperLimit}
                        </td>
                    `}
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #e3f2fd;">
                        <input type="text" value="${prop.coaValue || ''}" 
                               oninput="updateTDSProperty(${index}, 'coaValue', this.value); recalculateCompliance(${index});"
                               style="width: 100%; padding: 6px; border: 1px solid #0277bd; border-radius: 4px; font-size: 13px; text-align: center; font-weight: 600; color: #1565c0; background: white;"
                               placeholder="COA deƒüeri">
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #fff3e0;">
                        <select onchange="updateTDSProperty(${index}, 'coaCompliance', this.value)"
                                style="width: 100%; padding: 6px; border: 1px solid #f57c00; border-radius: 4px; font-size: 13px; font-weight: 600; ${
                                    prop.coaCompliance === 'Uygun' ? 'background: #c8e6c9; color: #2e7d32;' :
                                    prop.coaCompliance === 'Uygun Deƒüil' ? 'background: #ffcdd2; color: #c62828;' :
                                    'background: #fff9c4; color: #f57f17;'
                                }">
                            <option value="" ${!prop.coaCompliance ? 'selected' : ''}>-</option>
                            <option value="Uygun" ${prop.coaCompliance === 'Uygun' ? 'selected' : ''}>‚úÖ Uygun</option>
                            <option value="Uygun Deƒüil" ${prop.coaCompliance === 'Uygun Deƒüil' ? 'selected' : ''}>‚ùå Uygun Deƒüil</option>
                            <option value="Bilinmiyor" ${prop.coaCompliance === 'Bilinmiyor' ? 'selected' : ''}>‚ùì Bilinmiyor</option>
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <button onclick="deleteTDSProperty(${index})" class="btn btn-sm" style="background: #f44336; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üóë</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Uygunluk kontrol√º yap - SADECE COA deƒüeri varsa
                if (prop.coaValue) {
                    if (prop.operator === 'compliance') {
                        // Compliance mode: coaCompliance zaten COA parsing'de hesaplanmƒ±≈ütƒ±r
                        const complianceSpan = document.getElementById(`compliance_${index}`);
                        if (complianceSpan) {
                            // Eƒüer coaCompliance yoksa, ≈üimdi hesapla
                            if (!prop.coaCompliance && prop.requirement) {
                                prop.coaCompliance = checkCompliance(prop.coaValue, prop.requirement);
                                console.log(`üìä ${prop.name} i√ßin compliance hesaplandƒ±: ${prop.coaCompliance}`);
                            }
                            
                            if (prop.coaCompliance) {
                                complianceSpan.textContent = prop.coaCompliance;
                                if (prop.coaCompliance === 'Uygun') {
                                    complianceSpan.style.background = '#c8e6c9';
                                    complianceSpan.style.color = '#2e7d32';
                                } else if (prop.coaCompliance === 'Uygun Deƒüil') {
                                    complianceSpan.style.background = '#ffcdd2';
                                    complianceSpan.style.color = '#c62828';
                                } else {
                                    complianceSpan.style.background = '#fff9c4';
                                    complianceSpan.style.color = '#f57f17';
                                }
                            }
                        }
                    } else {
                        // Numeric mode: Use standard calculation
                        const complianceSpan = document.getElementById(`compliance_${index}`);
                        
                        // Lƒ∞Mƒ∞T DEƒûERLERƒ∞Nƒ∞ TEKRAR HESAPLA
                        const stdValueStr = String(prop.standardValue || '0').replace(/,/g, '.');
                        const stdValue = parseFloat(stdValueStr);
                        const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                        const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                        
                        // Standart deƒüer, toleranslar ve sonu√ßlarƒ±n ondalƒ±k basamak sayƒ±sƒ±nƒ± bul
                        let decimalPlaces = 2;
                        
                        // Standard value'daki ondalƒ±k basamaklarƒ± kontrol et
                        if (stdValueStr.includes('.')) {
                            const decimalPart = stdValueStr.split('.')[1];
                            decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                        }
                        
                        // Tolerance deƒüerlerindeki ondalƒ±k basamaklarƒ± kontrol et
                        const lowerTolStr = String(prop.lowerTolerance || '0');
                        if (lowerTolStr.includes('.')) {
                            const decimalPart = lowerTolStr.split('.')[1];
                            decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                        }
                        
                        const upperTolStr = String(prop.upperTolerance || '0');
                        if (upperTolStr.includes('.')) {
                            const decimalPart = upperTolStr.split('.')[1];
                            decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                        }
                        
                        // Hesaplanan limitlerin ondalƒ±k basamaklarƒ±nƒ± kontrol et
                        const calculatedLower = stdValue - lowerTol;
                        const calculatedUpper = stdValue + upperTol;
                        const calcLowerStr = calculatedLower.toString();
                        const calcUpperStr = calculatedUpper.toString();
                        
                        if (calcLowerStr.includes('.')) {
                            const decimalPart = calcLowerStr.split('.')[1];
                            decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                        }
                        if (calcUpperStr.includes('.')) {
                            const decimalPart = calcUpperStr.split('.')[1];
                            decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                        }
                        
                        // En az 3 ondalƒ±k basamak kullan (0,035 gibi deƒüerleri korumak i√ßin)
                        decimalPlaces = Math.max(3, decimalPlaces);
                        
                        const recalcLowerLimit = (stdValue - lowerTol).toFixed(decimalPlaces);
                        const recalcUpperLimit = (stdValue + upperTol).toFixed(decimalPlaces);
                        
                        // COA deƒüerini temizle
                        let cleanValue = String(prop.coaValue).replace(/^[‚â§‚â•<>=]+\s*/, '').replace(/,/g, '.');
                        
                        // COA deƒüeri aralƒ±k formatƒ±nda mƒ± kontrol et (7.5 - 10.5 gibi)
                        const coaRangeMatch = cleanValue.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                        
                        if (coaRangeMatch && prop.operator === 'range') {
                            // COA deƒüeri aralƒ±k formatƒ±nda ve operator da range
                            const coaMin = parseFloat(coaRangeMatch[1]);
                            const coaMax = parseFloat(coaRangeMatch[2]);
                            const tdsMin = parseFloat(recalcLowerLimit);
                            const tdsMax = parseFloat(recalcUpperLimit);
                            
                            // COA aralƒ±ƒüƒ± TDS limitleri ƒ∞√áƒ∞NDE mi kontrol et
                            const isLowerInRange = coaMin >= tdsMin;
                            const isUpperInRange = coaMax <= tdsMax;
                            const isCompliant = isLowerInRange && isUpperInRange;
                            
                            console.log(`üìä Aralƒ±k kar≈üƒ±la≈ütƒ±rma: COA [${coaMin}-${coaMax}] vs TDS [${tdsMin}-${tdsMax}] ‚Üí ${isCompliant ? 'Uygun' : 'Uygun Deƒüil'} (lower:${isLowerInRange}, upper:${isUpperInRange})`);
                            
                            if (complianceSpan) {
                                complianceSpan.textContent = isCompliant ? 'Uygun' : 'Uygun Deƒüil';
                                if (isCompliant) {
                                    complianceSpan.style.background = '#c8e6c9';
                                    complianceSpan.style.color = '#2e7d32';
                                } else {
                                    complianceSpan.style.background = '#ffcdd2';
                                    complianceSpan.style.color = '#c62828';
                                }
                            }
                        } else {
                            // COA deƒüeri tek sayƒ±
                            const value = parseFloat(cleanValue);
                            
                            if (!isNaN(value)) {
                                const operator = prop.operator || 'range';
                                let isCompliant = false;
                                
                                if (operator === 'range') {
                                    const min = parseFloat(recalcLowerLimit);
                                    const max = parseFloat(recalcUpperLimit);
                                    isCompliant = value >= min && value <= max;
                                } else if (operator === '>') {
                                    const min = parseFloat(recalcLowerLimit);
                                    isCompliant = value > min;
                                } else if (operator === '<') {
                                    const max = parseFloat(recalcUpperLimit);
                                    isCompliant = value < max;
                                } else if (operator === '>=') {
                                    const min = parseFloat(recalcLowerLimit);
                                    isCompliant = value >= min;
                                } else if (operator === '<=') {
                                    const max = parseFloat(recalcUpperLimit);
                                    isCompliant = value <= max;
                                } else if (operator === '=') {
                                    const stdVal = parseFloat(String(prop.standardValue || 0).replace(/,/g, '.'));
                                    isCompliant = Math.abs(value - stdVal) < 0.01;
                                }
                                
                                if (complianceSpan) {
                                    complianceSpan.textContent = isCompliant ? '‚úÖ Uygun' : '‚ùå Uygun Deƒüil';
                                    if (isCompliant) {
                                        complianceSpan.style.background = '#c8e6c9';
                                        complianceSpan.style.color = '#2e7d32';
                                    } else {
                                        complianceSpan.style.background = '#ffcdd2';
                                        complianceSpan.style.color = '#c62828';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Yeni √∂zellik ekle
        function addTDSProperty() {
            if (!currentTDSMaterial) return;
            
            if (!tdsData[currentTDSMaterial]) {
                tdsData[currentTDSMaterial] = { properties: [] };
            }
            
            tdsData[currentTDSMaterial].properties.push({
                name: '',
                unit: '',
                standard: '',
                operator: '=',
                standardValue: '',
                lowerTolerance: '',
                upperTolerance: ''
            });
            
            renderTDSProperties(tdsData[currentTDSMaterial].properties);
        }
        
        // √ñzellik g√ºncelle (hesaplama olmadan)
        function updateTDSProperty(index, field, value) {
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            if (tdsData[currentTDSMaterial].properties[index]) {
                // Sayƒ±sal alanlarda virg√ºl/nokta d√∂n√º≈ü√ºm√º ve bo≈üluk normalization
                if (['standardValue', 'lowerTolerance', 'upperTolerance', 'min', 'max', 'lowerLimit', 'upperLimit'].includes(field)) {
                    value = String(value).replace(/,/g, '.'); // Virg√ºl ‚Üí nokta
                    // Bo≈üluklu ondalƒ±k: "0 035" ‚Üí "0.035", "1 234" ‚Üí "1.234"
                    if (/^\d\s+\d+$/.test(value)) {
                        const parts = value.split(/\s+/);
                        value = parts[0] === '0' ? '0.' + parts[1] : parts[0] + '.' + parts[1];
                    }
                }
                tdsData[currentTDSMaterial].properties[index][field] = value;
                // Render √ßaƒüƒ±rmƒ±yoruz - focus kaybƒ±nƒ± √∂nlemek i√ßin
            }
        }
        
        // COA deƒüeri deƒüi≈ütiƒüinde compliance'ƒ± yeniden hesapla (OPSIYONEL - otomatik)
        function recalculateCompliance(index) {
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            const prop = tdsData[currentTDSMaterial].properties[index];
            if (!prop || !prop.coaValue) return;
            
            // Eƒüer kullanƒ±cƒ± manuel olarak compliance ayarladƒ±ysa, otomatik hesaplama yapma
            // (Bu √∂zelliƒüi eklemek i√ßin bir "manualCompliance" flag'i ekleyebiliriz)
            
            let calculatedCompliance = null;
            
            if (prop.operator === 'compliance' && prop.requirement) {
                // Compliance mode: checkCompliance fonksiyonunu kullan
                calculatedCompliance = checkCompliance(prop.coaValue, prop.requirement);
            } else if (prop.operator !== 'compliance') {
                // Numeric mode: Limit kontrol√º
                const cleanValue = String(prop.coaValue).replace(/^[‚â§‚â•<>=]+\s*/, '').replace(/,/g, '.');
                const value = parseFloat(cleanValue);
                
                if (!isNaN(value)) {
                    const stdValueStr = String(prop.standardValue || '0').replace(/,/g, '.');
                    const stdValue = parseFloat(stdValueStr);
                    const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                    const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                    
                    // Standart deƒüer, toleranslar ve sonu√ßlarƒ±n ondalƒ±k basamak sayƒ±sƒ±nƒ± bul
                    let decimalPlaces = 2;
                    
                    // Standard value'daki ondalƒ±k basamaklarƒ± kontrol et
                    if (stdValueStr.includes('.')) {
                        const decimalPart = stdValueStr.split('.')[1];
                        decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                    }
                    
                    // Tolerance deƒüerlerindeki ondalƒ±k basamaklarƒ± kontrol et
                    const lowerTolStr = String(prop.lowerTolerance || '0');
                    if (lowerTolStr.includes('.')) {
                        const decimalPart = lowerTolStr.split('.')[1];
                        decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                    }
                    
                    const upperTolStr = String(prop.upperTolerance || '0');
                    if (upperTolStr.includes('.')) {
                        const decimalPart = upperTolStr.split('.')[1];
                        decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                    }
                    
                    // Hesaplanan limitlerin ondalƒ±k basamaklarƒ±nƒ± kontrol et
                    const calculatedLower = stdValue - lowerTol;
                    const calculatedUpper = stdValue + upperTol;
                    const calcLowerStr = calculatedLower.toString();
                    const calcUpperStr = calculatedUpper.toString();
                    
                    if (calcLowerStr.includes('.')) {
                        const decimalPart = calcLowerStr.split('.')[1];
                        decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                    }
                    if (calcUpperStr.includes('.')) {
                        const decimalPart = calcUpperStr.split('.')[1];
                        decimalPlaces = Math.max(decimalPlaces, decimalPart ? decimalPart.length : 0);
                    }
                    
                    // En az 3 ondalƒ±k basamak kullan (0,035 gibi deƒüerleri korumak i√ßin)
                    decimalPlaces = Math.max(3, decimalPlaces);
                    
                    const lowerLimit = parseFloat((stdValue - lowerTol).toFixed(decimalPlaces));
                    const upperLimit = parseFloat((stdValue + upperTol).toFixed(decimalPlaces));
                    
                    const operator = prop.operator || 'range';
                    let isCompliant = false;
                    
                    if (operator === 'range') {
                        isCompliant = value >= lowerLimit && value <= upperLimit;
                    } else if (operator === '>') {
                        isCompliant = value > lowerLimit;
                    } else if (operator === '<') {
                        isCompliant = value < upperLimit;
                    } else if (operator === '>=') {
                        isCompliant = value >= lowerLimit;
                    } else if (operator === '<=') {
                        isCompliant = value <= upperLimit;
                    } else if (operator === '=') {
                        isCompliant = Math.abs(value - stdValue) < 0.01;
                    }
                    
                    calculatedCompliance = isCompliant ? 'Uygun' : 'Uygun Deƒüil';
                }
            }
            
            // Eƒüer hesaplama yapƒ±ldƒ±ysa, select'i g√ºncelle VE tdsData'ya kaydet
            if (calculatedCompliance) {
                // ‚úÖ tdsData'daki compliance'ƒ± g√ºncelle (saveCOA i√ßin gerekli)
                prop.coaCompliance = calculatedCompliance;
                console.log(`üîÑ ${prop.name} compliance g√ºncellendi: ${calculatedCompliance}`);
                
                const rows = document.querySelectorAll('#tdsPropertiesTable tr');
                if (rows[index]) {
                    const select = rows[index].querySelector('select[onchange*="coaCompliance"]');
                    if (select && !select.dataset.manuallySet) {
                        select.value = calculatedCompliance;
                        // Renk g√ºncelle
                        if (calculatedCompliance === 'Uygun') {
                            select.style.background = '#c8e6c9';
                            select.style.color = '#2e7d32';
                        } else if (calculatedCompliance === 'Uygun Deƒüil') {
                            select.style.background = '#ffcdd2';
                            select.style.color = '#c62828';
                        } else {
                            select.style.background = '#fff9c4';
                            select.style.color = '#f57f17';
                        }
                    }
                }
            }
        }
        
        // TDS mode toggle (compliance vs numeric)
        function toggleTDSMode(index, operator) {
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            const prop = tdsData[currentTDSMaterial].properties[index];
            prop.operator = operator;
            
            // Compliance modunda numeric alanlarƒ± temizle
            if (operator === 'compliance') {
                prop.standardValue = '';
                prop.lowerTolerance = '';
                prop.upperTolerance = '';
                prop.min = '';
                prop.max = '';
            } else {
                // Numeric modunda requirement'ƒ± temizle
                prop.requirement = '';
                prop.coaCompliance = '';
            }
            
            // Tabloyu yeniden render et
            renderTDSProperties(tdsData[currentTDSMaterial].properties);
        }
        
        // √ñzellik g√ºncelle ve limitleri yeniden hesapla (render etmeden)
        function updateTDSPropertyWithCalc(index, field, value) {
            updateTDSProperty(index, field, value);
            
            // Sadece limitleri g√ºncelle, render etme (focus kaybƒ±nƒ± √∂nle)
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            const prop = tdsData[currentTDSMaterial].properties[index];
            if (prop) {
                const stdValueStr = String(prop.standardValue || '0').replace(/,/g, '.');
                const stdValue = parseFloat(stdValueStr);
                const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                
                if (!isNaN(stdValue) && !isNaN(lowerTol) && !isNaN(upperTol)) {
                    // Standart deƒüerdeki ondalƒ±k basamak sayƒ±sƒ±nƒ± bul
                    let decimalPlaces = 2; // Varsayƒ±lan
                    if (stdValueStr.includes('.')) {
                        const decimalPart = stdValueStr.split('.')[1];
                        decimalPlaces = decimalPart ? decimalPart.length : 0;
                    }
                    
                    prop.min = (stdValue - lowerTol).toFixed(decimalPlaces);
                    prop.max = (stdValue + upperTol).toFixed(decimalPlaces);
                    
                    // Sadece limit h√ºcrelerini g√ºncelle
                    const rows = document.querySelectorAll('#tdsPropertiesTable tr');
                    if (rows[index]) {
                        const cells = rows[index].querySelectorAll('td');
                        if (cells.length >= 9) {
                            cells[7].textContent = prop.min; // Alt Limit kolonu
                            cells[8].textContent = prop.max; // √úst Limit kolonu
                        }
                    }
                }
            }
        }
        
        // √ñzellik sil
        function deleteTDSProperty(index) {
            if (!currentTDSMaterial || !tdsData[currentTDSMaterial]) return;
            
            if (confirm('Bu √∂zelliƒüi silmek istediƒüinizden emin misiniz?')) {
                tdsData[currentTDSMaterial].properties.splice(index, 1);
                renderTDSProperties(tdsData[currentTDSMaterial].properties);
            }
        }
        
        // TDS kaydet
        async function saveTDS() {
            if (!currentTDSMaterial) return;
            
            // Bo≈üluk normalization helper
            const cleanNumericValue = (val) => {
                if (!val) return val;
                let cleaned = String(val).trim();
                // "0 035" ‚Üí "0.035", "1 234" ‚Üí "1.234"
                if (/^\d\s+\d+$/.test(cleaned)) {
                    const parts = cleaned.split(/\s+/);
                    cleaned = parts[0] === '0' ? '0.' + parts[1] : parts[0] + '.' + parts[1];
                }
                return cleaned;
            };
            
            // Alt/√úst limitleri hesapla ve property'lere ekle
            const tds = tdsData[currentTDSMaterial];
            if (tds && tds.properties) {
                tds.properties.forEach(prop => {
                    // √ñnce bo≈üluk normalization uygula
                    prop.standardValue = cleanNumericValue(prop.standardValue);
                    prop.lowerTolerance = cleanNumericValue(prop.lowerTolerance);
                    prop.upperTolerance = cleanNumericValue(prop.upperTolerance);
                    prop.lowerLimit = cleanNumericValue(prop.lowerLimit);
                    prop.upperLimit = cleanNumericValue(prop.upperLimit);
                    prop.min = cleanNumericValue(prop.min);
                    prop.max = cleanNumericValue(prop.max);
                    prop.coaValue = cleanNumericValue(prop.coaValue);  // COA deƒüerini de temizle
                    
                    // T√ºm sayƒ±sal deƒüerlerde virg√ºl/nokta d√∂n√º≈ü√ºm√º yap
                    const stdValue = parseFloat(String(prop.standardValue || 0).replace(/,/g, '.'));
                    const lowerTol = parseFloat(String(prop.lowerTolerance || 0).replace(/,/g, '.'));
                    const upperTol = parseFloat(String(prop.upperTolerance || 0).replace(/,/g, '.'));
                    
                    // Deƒüerleri normalize et (virg√ºls√ºz kaydet)
                    prop.standardValue = stdValue.toString();
                    prop.lowerTolerance = lowerTol.toString();
                    prop.upperTolerance = upperTol.toString();
                    
                    // Operator varsayƒ±lan deƒüeri kontrol et
                    if (!prop.operator) {
                        prop.operator = 'range';
                    }
                    
                    // Operat√∂re g√∂re limit hesapla
                    if (prop.operator === '>' || prop.operator === '>=') {
                        // B√ºy√ºkt√ºr: sadece alt limit
                        prop.min = (stdValue - lowerTol).toFixed(2);
                        prop.max = '';
                    } else if (prop.operator === '<' || prop.operator === '<=') {
                        // K√º√ß√ºkt√ºr: sadece √ºst limit
                        prop.min = '';
                        prop.max = (stdValue + upperTol).toFixed(2);
                    } else {
                        // range: her ikisi de
                        prop.min = (stdValue - lowerTol).toFixed(2);
                        prop.max = (stdValue + upperTol).toFixed(2);
                    }
                });
            }
            
            // TDS Definitions'a kaydet (COA deƒüerleri HARƒ∞√á)
            saveTDSData();
            
            // üìä COA deƒüerleri varsa COA_Records'a da kaydet
            await saveTDSCOAValuesToRecords();
            
            showToast('‚úÖ TDS ve COA deƒüerleri kaydedildi', 'success');
            closeTDSModal();
        }
        
        // TDS'teki manuel COA deƒüerlerini COA_Records'a kaydet
        async function saveTDSCOAValuesToRecords() {
            if (!currentTDSMaterial) return;
            
            const tds = tdsData[currentTDSMaterial];
            if (!tds || !tds.properties) return;
            
            // T√úM √∂zellikleri kaydet (COA deƒüeri olsun olmasƒ±n)
            const allProps = tds.properties;
            if (allProps.length === 0) {
                console.log('‚è≠Ô∏è TDS\'de √∂zellik yok');
                return;
            }
            
            // Aktif COA kaydƒ±nƒ± bul (en son d√ºzenlenen)
            let activeCOA = null;
            
            // Eƒüer bir COA d√ºzenleme modundaysa onu kullan
            if (editMode && editingId) {
                activeCOA = coaData.find(coa => coa.id === editingId);
            }
            
            // Bulunamazsa bu malzeme kodundan en son kaydƒ± bul
            if (!activeCOA) {
                const sameMaterialCOAs = coaData.filter(coa => coa.materialCode === currentTDSMaterial);
                if (sameMaterialCOAs.length > 0) {
                    // En son kaydƒ± al (id'ye g√∂re sƒ±rala)
                    activeCOA = sameMaterialCOAs.sort((a, b) => {
                        return (b.id || '').localeCompare(a.id || '');
                    })[0];
                }
            }
            
            if (!activeCOA) {
                console.log('‚ö†Ô∏è Bu malzeme i√ßin COA kaydƒ± bulunamadƒ±, TDS verileri kullanƒ±lƒ±yor');
                // COA kaydƒ± yoksa TDS'ten dummy data olu≈ütur
                activeCOA = {
                    deliveryDate: new Date().toISOString().split('T')[0],
                    deliveryNo: '',
                    lotNumber: '',
                    supplier: '',
                    location: '',
                    materialCode: currentTDSMaterial
                };
            }
            
            console.log(`üìä TDS'teki T√úM ${allProps.length} √∂zellik COA_Records'a kaydediliyor...`);
            console.log(`   Tarih: ${activeCOA.deliveryDate}, ƒ∞rsaliye: ${activeCOA.deliveryNo}, Lokasyon: ${activeCOA.location}`);
            
            try {
                const data = {
                    date: activeCOA.deliveryDate,
                    deliveryNo: activeCOA.deliveryNo || '',
                    lotNumber: activeCOA.lotNumber || '',
                    materialCode: currentTDSMaterial,
                    supplier: activeCOA.supplier,
                    location: activeCOA.location || '',  // ‚úÖ Location eklendi
                    properties: allProps.map(prop => ({
                        name: prop.name,
                        coaValue: prop.coaValue || '',  // Bo≈ü olabilir
                        unit: prop.unit || '',
                        standard: prop.standard || '',
                        operator: prop.operator || 'range',
                        standardValue: prop.standardValue || '',
                        min: prop.min || '',
                        max: prop.max || '',
                        requirement: prop.requirement || '',
                        status: prop.coaValue ? (prop.coaCompliance || 'Bilinmiyor') : ''  // COA deƒüeri varsa durum ekle
                    }))
                };
                
                console.log('üì§ COA_Records\'a g√∂nderiliyor:', data);
                
                const url = `${googleScriptUrl}?action=saveCOARecord&data=${encodeURIComponent(JSON.stringify(data))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ ${result.recordCount} √∂zellik COA_Records'a kaydedildi`);
                    showToast(`üìä ${result.recordCount} √∂zellik kaydedildi`, 'success', 2000);
                    
                    // COA_Records'ƒ± yeniden y√ºkle
                    await loadCOARecordsForAll();
                } else {
                    console.error('‚ùå COA_Records kayƒ±t hatasƒ±:', result.error);
                }
            } catch(error) {
                console.error('‚ùå TDS COA deƒüerleri kayƒ±t hatasƒ±:', error);
            }
        }
        
        // Close modal on click outside
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') closeModal();
        });

        // ==================== KAMERA TARAYICI ====================
        
        let cameraStream = null;
        
        // Kamera modalƒ±nƒ± a√ß
        // OSS-DocumentScanner uygulamasƒ±nƒ± a√ß
        function openDocumentScanner() {
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            if (isAndroid) {
                // Normal kamera kullan
                showToast('üì∑ Kamera a√ßƒ±lƒ±yor...', 'info');
                document.getElementById('cameraInput').click();
                
            } else {
                showToast('‚ö†Ô∏è Sadece mobil cihazlarda √ßalƒ±≈üƒ±r', 'warning');
                document.getElementById('cameraInput').click();
            }
        }
        
        // Mobile Detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
        }
        
        async function openCameraModal() {
            // Mobil cihazda doƒürudan native kamera inputunu kullan
            if (isMobileDevice()) {
                document.getElementById('cameraInput').click();
                return;
            }
            
            // Desktop i√ßin modal ile kamera a√ß
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraStream');
            
            try {
                // Kamera eri≈üimi iste
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Arka kamera (mobilde)
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                video.srcObject = cameraStream;
                modal.classList.add('active');
                showToast('üì∑ Kamera a√ßƒ±ldƒ±', 'success');
            } catch (error) {
                console.error('Kamera eri≈üim hatasƒ±:', error);
                showToast('‚ùå Kamera eri≈üimi reddedildi veya kamera bulunamadƒ±', 'error');
                
                // Fallback: dosya se√ßiciye y√∂nlendir
                document.getElementById('cameraInput').click();
            }
        }
        
        // Kamera modalƒ±nƒ± kapat
        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraStream');
            
            // Kamera akƒ±≈üƒ±nƒ± durdur
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.classList.remove('active');
        }
        
        // Fotoƒüraf √ßek
        function capturePhoto() {
            const video = document.getElementById('cameraStream');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // Canvas boyutunu video boyutuna ayarla
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Video frame'ini canvas'a √ßiz
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Canvas'ƒ± blob'a √ßevir
            canvas.toBlob(function(blob) {
                // Blob'u file'a √ßevir
                const fileName = 'camera_' + Date.now() + '.jpg';
                const file = new File([blob], fileName, { type: 'image/jpeg' });
                
                // FileReader ile preview olu≈ütur
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFile = file;
                    selectedFileData = e.target.result;
                    
                    const uploadArea = document.getElementById('uploadArea');
                    const preview = document.getElementById('filePreview');
                    
                    uploadArea.classList.add('has-file');
                    
                    // Dosya tipi ikonunu g√∂ster
                    const fileIconHtml = getFileIcon(fileName, 'image/jpeg', 'preview');
                    preview.innerHTML = fileIconHtml + '<p style="margin-top: 10px; color: #4CAF50; font-weight: 600;">‚úÖ Fotoƒüraf eklendi!</p>';
                    
                    showToast('‚úÖ Fotoƒüraf forma eklendi!', 'success');
                };
                reader.readAsDataURL(file);
                
                // Kamera modalƒ±nƒ± kapat
                closeCameraModal();
            }, 'image/jpeg', 0.9);
        }
        
        // Kamera ile fotoƒüraf √ßekme (basit, tarama yok) - Mobil fallback
        function handleCameraCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üì∏ Kamera ile fotoƒüraf √ßekildi:', file.name);
            
            // PC'deki handleFile fonksiyonunu kullan (aynƒ± logic)
            handleFile(file);
            
            // Input'u sƒ±fƒ±rla (aynƒ± fotoƒürafƒ± tekrar √ßekebilmek i√ßin)
            event.target.value = '';
        }
        
        // Eski tarayƒ±cƒ± fonksiyonlarƒ± (kullanƒ±lmƒ±yor artƒ±k)
        let scannerStream = null;
        let scannerCapturedData = null;
        let scannerWindow = null;
        
        function openProfessionalScanner() {
            // KAPALI - Artƒ±k kullanƒ±lmƒ±yor
            showToast('‚ùå Profesyonel tarayƒ±cƒ± devre dƒ±≈üƒ±. "Kamera ile √áek" kullanƒ±n.', 'error');
            return;
            // Yeni pencerede profesyonel tarayƒ±cƒ±yƒ± a√ß
            const width = Math.min(600, window.innerWidth - 20);
            const height = Math.min(900, window.innerHeight - 20);
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;
            
            scannerWindow = window.open(
                'profesyonel-tarayici.html',
                'Belge Tarayƒ±cƒ±',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            if (!scannerWindow) {
                showToast('‚ùå Pop-up engellendi! L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan izin verin', 'error');
            }
        }
        
        // Tarayƒ±cƒ±dan gelen mesajlarƒ± dinle
        window.addEventListener('message', async (event) => {
            if (event.data.type === 'scannedImage') {
                const dataURL = event.data.data;
                
                // Convert to File object
                const blob = await (await fetch(dataURL)).blob();
                const file = new File([blob], 'scanned_' + Date.now() + '.jpg', { type: 'image/jpeg' });
                
                // Set as selected file
                selectedFile = file;
                selectedFileData = dataURL;
                
                const uploadArea = document.getElementById('uploadArea');
                const preview = document.getElementById('filePreview');
                
                uploadArea.classList.add('has-file');
                preview.innerHTML = '<img src="' + dataURL + '" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px;"><p style="margin-top: 10px; color: #4CAF50; font-weight: 600;">‚úÖ Profesyonel tarama tamamlandƒ±!</p>';
                
                showToast('‚úÖ Taranmƒ±≈ü belge forma eklendi!', 'success');
                
                // Close scanner window
                if (scannerWindow) {
                    scannerWindow.close();
                }
            }
        });
        
        function openScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.add('active');
            startScannerCamera();
        }
        
        function closeScanner() {
            const modal = document.getElementById('scannerModal');
            modal.classList.remove('active');
            
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            document.getElementById('scannerCaptureBtn').style.display = 'block';
            document.getElementById('scannerProcessBtn').style.display = 'none';
            document.getElementById('scannerUseBtn').style.display = 'none';
        }
        
        async function startScannerCamera() {
            try {
                showScannerStatus('üîÑ Kamera ba≈ülatƒ±lƒ±yor...', 'info');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('scannerVideo');
                video.srcObject = scannerStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    showScannerStatus('‚úÖ Belgeyi √ßer√ßeveleyin ve "√áek" butonuna basƒ±n', 'success');
                };
            } catch (error) {
                console.error('Kamera hatasƒ±:', error);
                showScannerStatus('‚ùå Kamera a√ßƒ±lamadƒ±: ' + error.message, 'error');
            }
        }
        
        function captureScannerImage() {
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            scannerCapturedData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            
            document.getElementById('scannerCaptureBtn').style.display = 'none';
            document.getElementById('scannerProcessBtn').style.display = 'block';
            
            showScannerStatus('‚úÖ G√∂r√ºnt√º yakalandƒ±! "ƒ∞≈üle ve D√ºzelt" butonuna basƒ±n', 'success');
        }
        
        function processScannerImage() {
            showScannerStatus('‚öôÔ∏è G√∂r√ºnt√º i≈üleniyor ve d√ºzeltiliyor...', 'info');
            
            const canvas = document.getElementById('scannerCanvas');
            const ctx = canvas.getContext('2d');
            
            // Auto perspective correction
            const corners = detectDocumentCorners(scannerCapturedData, canvas.width, canvas.height);
            
            // Create output canvas with A4 aspect ratio
            const outputCanvas = document.createElement('canvas');
            const outputCtx = outputCanvas.getContext('2d');
            const dstWidth = 1200;
            const dstHeight = Math.round(dstWidth * 1.414); // A4
            outputCanvas.width = dstWidth;
            outputCanvas.height = dstHeight;
            
            // Perspective transform
            perspectiveTransformSimple(scannerCapturedData, corners, outputCanvas, dstWidth, dstHeight);
            
            // Enhance image
            enhanceDocument(outputCanvas);
            
            // Display result
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = outputCanvas.width;
            canvas.height = outputCanvas.height;
            ctx.drawImage(outputCanvas, 0, 0);
            
            document.getElementById('scannerProcessBtn').style.display = 'none';
            document.getElementById('scannerUseBtn').style.display = 'block';
            
            showScannerStatus('‚úÖ G√∂r√ºnt√º d√ºzeltildi! "Kullan" butonuna basƒ±n', 'success');
        }
        
        function detectDocumentCorners(imageData, width, height) {
            // Simplified corner detection - use image boundaries with margin
            const margin = Math.min(width, height) * 0.05;
            
            return [
                { x: margin, y: margin },
                { x: width - margin, y: margin },
                { x: width - margin, y: height - margin },
                { x: margin, y: height - margin }
            ];
        }
        
        function perspectiveTransformSimple(srcImageData, srcCorners, dstCanvas, dstWidth, dstHeight) {
            const src = srcImageData.data;
            const srcWidth = srcImageData.width;
            const srcHeight = srcImageData.height;
            const ctx = dstCanvas.getContext('2d');
            
            const dstImageData = ctx.createImageData(dstWidth, dstHeight);
            const dst = dstImageData.data;
            
            for (let y = 0; y < dstHeight; y++) {
                for (let x = 0; x < dstWidth; x++) {
                    const u = x / dstWidth;
                    const v = y / dstHeight;
                    
                    // Bilinear interpolation
                    const srcX = (1-u)*(1-v)*srcCorners[0].x + u*(1-v)*srcCorners[1].x +
                                u*v*srcCorners[2].x + (1-u)*v*srcCorners[3].x;
                    const srcY = (1-u)*(1-v)*srcCorners[0].y + u*(1-v)*srcCorners[1].y +
                                u*v*srcCorners[2].y + (1-u)*v*srcCorners[3].y;
                    
                    const srcXi = Math.floor(srcX);
                    const srcYi = Math.floor(srcY);
                    
                    if (srcXi >= 0 && srcXi < srcWidth && srcYi >= 0 && srcYi < srcHeight) {
                        const srcIdx = (srcYi * srcWidth + srcXi) * 4;
                        const dstIdx = (y * dstWidth + x) * 4;
                        
                        dst[dstIdx] = src[srcIdx];
                        dst[dstIdx + 1] = src[srcIdx + 1];
                        dst[dstIdx + 2] = src[srcIdx + 2];
                        dst[dstIdx + 3] = 255;
                    }
                }
            }
            
            ctx.putImageData(dstImageData, 0, 0);
        }
        
        function enhanceDocument(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Auto-contrast
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = (data[i] + data[i+1] + data[i+2]) / 3;
                min = Math.min(min, gray);
                max = Math.max(max, gray);
            }
            
            const scale = 255 / (max - min + 1);
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - min) * scale));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - min) * scale));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - min) * scale));
            }
            
            // Sharpen
            const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
            const output = new Uint8ClampedArray(data);
            const width = canvas.width;
            const height = canvas.height;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += data[idx] * kernel[(ky+1)*3 + (kx+1)];
                            }
                        }
                        const idx = (y * width + x) * 4 + c;
                        output[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = output[i];
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        async function useScannerImage() {
            const canvas = document.getElementById('scannerCanvas');
            const dataURL = canvas.toDataURL('image/jpeg', 0.92);
            
            // Convert to File object
            const blob = await (await fetch(dataURL)).blob();
            const file = new File([blob], 'scanned_' + Date.now() + '.jpg', { type: 'image/jpeg' });
            
            // Use existing handleFile function
            selectedFile = file;
            selectedFileData = dataURL;
            
            const uploadArea = document.getElementById('uploadArea');
            const preview = document.getElementById('filePreview');
            
            uploadArea.classList.add('has-file');
            preview.innerHTML = '<img src="' + dataURL + '" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px;"><p style="margin-top: 10px; color: #4CAF50; font-weight: 600;">‚úÖ Taranmƒ±≈ü belge hazƒ±r</p>';
            
            closeScanner();
            showToast('‚úÖ Taranmƒ±≈ü belge forma eklendi!', 'success');
        }
        
        function showScannerStatus(message, type) {
            const statusEl = document.getElementById('scannerStatus');
            statusEl.textContent = message;
            statusEl.className = 'scanner-status ' + type;
        }
    </script>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-container">
            <div class="scanner-header">
                <h2>üì∑ Belge Tarayƒ±cƒ±</h2>
                <button class="scanner-close" onclick="closeScanner()">√ó</button>
            </div>

            <div id="scannerStatus" class="scanner-status info">
                üîÑ Kamera ba≈ülatƒ±lƒ±yor...
            </div>

            <div class="scanner-video-container">
                <video id="scannerVideo" class="scanner-video" autoplay playsinline></video>
                <canvas id="scannerCanvas" class="scanner-canvas"></canvas>
            </div>

            <div class="scanner-controls">
                <button id="scannerCaptureBtn" class="scanner-btn scanner-btn-capture" onclick="captureScannerImage()">
                    üì∏ √áek
                </button>
                <button id="scannerProcessBtn" class="scanner-btn scanner-btn-process" onclick="processScannerImage()" style="display: none;">
                    ‚ú® ƒ∞≈üle ve D√ºzelt
                </button>
                <button id="scannerUseBtn" class="scanner-btn scanner-btn-use" onclick="useScannerImage()" style="display: none;">
                    ‚úÖ Kullan
                </button>
            </div>

            <div class="scanner-options">
                <div style="padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em; color: #856404;">
                    <strong>üí° ƒ∞pu√ßlarƒ±:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Belgeyi d√ºz zemine koyun</li>
                        <li>ƒ∞yi ƒ±≈üƒ±klandƒ±rƒ±lmƒ±≈ü ortamda √ßekin</li>
                        <li>Belgenin tamamƒ± g√∂r√ºns√ºn</li>
                        <li>G√∂lge d√º≈ü√ºrmemeye √ßalƒ±≈üƒ±n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== COA ANALYSIS ====================
        let analysisCharts = [];
        let analysisData = [];
        
        async function openCOAAnalysisModal() {
            document.getElementById('coaAnalysisModal').classList.add('active');
            
            // Eski grafikleri temizle
            analysisCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            analysisCharts = [];
            
            // Container'larƒ± temizle
            const chartsContainer = document.getElementById('analysisChartsContainer');
            if (chartsContainer) {
                chartsContainer.innerHTML = '';
                chartsContainer.style.display = 'none';
            }
            
            // Empty state'i g√∂ster
            const emptyState = document.getElementById('analysisEmptyState');
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            
            await loadAnalysisSuppliers();
        }
        
        // Merkezi ar≈üiv klas√∂r√ºn√º a√ß
        async function openCentralArchive() {
            if (!googleScriptUrl) {
                showToast('‚ùå √ñnce Google Sheets baƒülantƒ±sƒ± yapƒ±n!', 'error');
                return;
            }
            
            showToast('üìÅ Merkezi ar≈üiv klas√∂r√º a√ßƒ±lƒ±yor...', 'info');
            
            try {
                // API'den klas√∂r bilgisini al
                const result = await jsonpRequest(googleScriptUrl, { action: 'getCentralArchive' });
                
                if (result.success) {
                    // Direkt Drive klas√∂r√ºn√º a√ß
                    window.open(result.folderUrl, '_blank');
                    
                    showToast(`‚úÖ ${result.fileCount} dosya i√ßeren merkezi ar≈üiv a√ßƒ±ldƒ±`, 'success', 3000);
                } else {
                    throw new Error(result.error || 'Klas√∂r bilgisi alƒ±namadƒ±');
                }
            } catch (error) {
                console.error('Merkezi ar≈üiv a√ßma hatasƒ±:', error);
                
                // Hata durumunda arama yap
                const searchUrl = 'https://drive.google.com/drive/search?q=COA_Merkezi_Arsiv';
                window.open(searchUrl, '_blank');
                
                showToast('‚ö†Ô∏è Klas√∂r aramasƒ± a√ßƒ±ldƒ±. "COA_Merkezi_Arsiv" klas√∂r√ºn√º manuel se√ßin', 'warning', 5000);
            }
        }
        
        async function syncExistingFiles() {
            if (!googleScriptUrl) {
                showToast('‚ùå √ñnce Google Sheets baƒülantƒ±sƒ± yapƒ±n!', 'error');
                return;
            }
            
            // Onay iste
            if (!confirm('üîÑ Mevcut t√ºm COA dosyalarƒ±nƒ± ve template g√∂rsellerini merkezi ar≈üive kopyalamak istiyor musunuz?\n\n(Zaten var olan dosyalar atlanacak)')) {
                return;
            }
            
            showToast('üîÑ Dosyalar senkronize ediliyor... L√ºtfen bekleyin', 'info', 0);
            
            try {
                const result = await jsonpRequest(googleScriptUrl, { action: 'syncExistingFiles' });
                
                if (result.success) {
                    const stats = result.stats;
                    
                    let message = `‚úÖ Senkronizasyon tamamlandƒ±!\n\n`;
                    message += `üìä ${stats.totalProcessed} dosya i≈ülendi\n`;
                    message += `‚úÖ ${stats.synced} dosya kopyalandƒ±\n`;
                    message += `‚è≠Ô∏è ${stats.skipped} dosya atlandƒ± (zaten vardƒ±)\n`;
                    
                    if (stats.errors > 0) {
                        message += `‚ùå ${stats.errors} hata olu≈ütu\n`;
                    }
                    
                    alert(message);
                    
                    showToast(`‚úÖ ${stats.synced} dosya merkezi ar≈üive kopyalandƒ±`, 'success', 5000);
                    
                    // Klas√∂r√º a√ß
                    if (result.folderUrl) {
                        window.open(result.folderUrl, '_blank');
                    }
                } else {
                    throw new Error(result.error || 'Senkronizasyon hatasƒ±');
                }
            } catch (error) {
                console.error('Senkronizasyon hatasƒ±:', error);
                showToast('‚ùå Senkronizasyon hatasƒ±: ' + error.message, 'error', 5000);
            }
        }
        
        // Eksik COA Modal fonksiyonlarƒ±
        function openMissingCOAModal() {
            document.getElementById('missingCOAModal').classList.add('active');
            generateMissingCOAReport();
        }
        
        function closeMissingCOAModal() {
            document.getElementById('missingCOAModal').classList.remove('active');
        }
        
        // COA Properties Modal fonksiyonlarƒ±
        function showCOAProperties(coaId) {
            const coa = coaData.find(c => c.id === coaId);
            if (!coa) {
                showToast('‚ùå COA bulunamadƒ±!', 'error');
                return;
            }
            
            const modal = document.getElementById('coaPropertiesModal');
            const content = document.getElementById('coaPropertiesContent');
            
            if (!coa.ocrProperties || Object.keys(coa.ocrProperties).length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #999;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìä</div>
                        <h3 style="margin-bottom: 10px;">COA Deƒüerleri Bulunamadƒ±</h3>
                        <p style="color: #666;">Bu COA i√ßin OCR ile okunmu≈ü √∂zellik bulunmamaktadƒ±r.</p>
                    </div>
                `;
            } else {
                // Header bilgileri
                let headerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Tedarik√ßi</div>
                                <div style="font-weight: bold; font-size: 1.1em;">${coa.supplier}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Hammadde Kodu</div>
                                <div style="font-weight: bold; font-size: 1.1em;">${coa.materialCode}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; opacity: 0.9;">ƒ∞rsaliye Tarihi</div>
                                <div style="font-weight: bold; font-size: 1.1em;">${formatDate(coa.deliveryDate)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; opacity: 0.9;">ƒ∞rsaliye No</div>
                                <div style="font-weight: bold; font-size: 1.1em;">${coa.deliveryNo || '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // √ñzellikleri tablo olarak g√∂ster
                const properties = Object.entries(coa.ocrProperties);
                const passCount = properties.filter(([_, p]) => {
                    const statusLower = (p.status || '').toLowerCase();
                    return statusLower === 'pass' || statusLower === 'uygun';
                }).length;
                const failCount = properties.filter(([_, p]) => {
                    const statusLower = (p.status || '').toLowerCase();
                    return statusLower === 'fail' || statusLower.includes('uygun deƒüil');
                }).length;
                const unknownCount = properties.length - passCount - failCount;
                
                let statsHTML = `
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px; padding: 15px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;">${properties.length}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Toplam √ñzellik</div>
                        </div>
                        ${passCount > 0 ? `
                        <div style="flex: 1; min-width: 150px; padding: 15px; background: #28a745; color: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;">${passCount}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">‚úÖ Uygun</div>
                        </div>
                        ` : ''}
                        ${failCount > 0 ? `
                        <div style="flex: 1; min-width: 150px; padding: 15px; background: #dc3545; color: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;">${failCount}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">‚ùå Uygun Deƒüil</div>
                        </div>
                        ` : ''}
                        ${unknownCount > 0 ? `
                        <div style="flex: 1; min-width: 150px; padding: 15px; background: #6c757d; color: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2em; font-weight: bold;">${unknownCount}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Durum Belirsiz</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                let tableHTML = `
                    <div>
                        <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left; width: 35px; font-size: 0.9em;">#</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em;">√ñzellik Adƒ±</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 120px; font-size: 0.9em;">TDS Limit</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 120px; font-size: 0.9em;">Requirement</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 100px; font-size: 0.9em;">COA Deƒüeri</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 70px; font-size: 0.9em;">Birim</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 140px; font-size: 0.9em;">Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                properties.forEach(([propName, prop], index) => {
                    let statusBadge = '-';
                    let statusColor = '#6c757d';
                    
                    const statusLower = (prop.status || '').toLowerCase();
                    
                    if (statusLower === 'pass' || statusLower === 'uygun') {
                        statusBadge = '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold; font-size: 0.8em; white-space: nowrap;">‚úÖ Uygun</span>';
                    } else if (statusLower === 'fail' || statusLower === 'uygun deƒüil' || statusLower.includes('uygun deƒüil')) {
                        statusBadge = '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold; font-size: 0.8em; white-space: nowrap;">‚ùå Uygun Deƒüil</span>';
                    } else {
                        statusBadge = '<span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 12px; font-weight: bold; font-size: 0.8em; white-space: nowrap;">-</span>';
                    }
                    
                    // TDS Limit formatla (Alt - √úst) - SADECE requirement YOKSA g√∂ster
                    let tdsLimitDisplay = '-';
                    if (prop.requirement && prop.requirement.trim()) {
                        // Requirement varsa TDS Limit g√∂sterme
                        tdsLimitDisplay = '-';
                    } else if (prop.lowerLimit && prop.upperLimit) {
                        tdsLimitDisplay = `${prop.lowerLimit} - ${prop.upperLimit}`;
                    } else if (prop.lowerLimit) {
                        tdsLimitDisplay = `‚â• ${prop.lowerLimit}`;
                    } else if (prop.upperLimit) {
                        tdsLimitDisplay = `‚â§ ${prop.upperLimit}`;
                    } else if (prop.standardValue) {
                        tdsLimitDisplay = prop.standardValue;
                    }
                    
                    tableHTML += `
                        <tr style="background: ${index % 2 === 0 ? 'white' : '#f9f9f9'};">
                            <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.9em;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600; font-size: 0.9em;">${propName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #0066cc; font-size: 0.85em;">${tdsLimitDisplay}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #ff6600; font-size: 0.85em;">${prop.requirement || '-'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #667eea; font-size: 0.85em;">${prop.coaValue || '-'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.85em;">${prop.unit || '-'}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${statusBadge}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                content.innerHTML = headerHTML + statsHTML + tableHTML;
            }
            
            modal.classList.add('active');
        }
        
        function closeCoaPropertiesModal() {
            document.getElementById('coaPropertiesModal').classList.remove('active');
        }
        
        function generateMissingCOAReport() {
            const contentDiv = document.getElementById('missingCOAContent');
            contentDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><p>üìä Rapor hazƒ±rlanƒ±yor...</p></div>';
            
            try {
                // Excel y√ºkl√º m√º kontrol et
                if (!materials || materials.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: #999;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                            <h3 style="margin-bottom: 10px;">Excel'de ƒ∞rsaliye Kaydƒ± Yok</h3>
                            <p style="color: #666;">L√ºtfen √∂nce Excel y√ºkleyin.</p>
                        </div>
                    `;
                    return;
                }
                
                // Hammadde bazƒ±nda grupla
                const materialStats = {};
                
                // Tedarik√ßi bilgisini al (varsa formdan)
                const currentSupplier = document.getElementById('supplierInput')?.value?.trim() || '';
                
                materials.forEach(material => {
                    const materialCode = material.materialCode || material.code;
                    const materialName = material.materialName || material.name || materialCode;
                    
                    // Tedarik√ßi bilgisini COA kayƒ±tlarƒ±ndan al
                    let supplierName = '';
                    const coaForThisMaterial = coaData.find(coa => 
                        coa.materialCode === materialCode || coa.material === materialCode
                    );
                    if (coaForThisMaterial && coaForThisMaterial.supplier) {
                        supplierName = coaForThisMaterial.supplier;
                    } else {
                        supplierName = currentSupplier || material.supplier || material.supplierName || 'Belirtilmemi≈ü';
                    }
                    
                    if (!materialStats[materialCode]) {
                        materialStats[materialCode] = {
                            materialCode: materialCode,
                            materialName: materialName,
                            supplier: supplierName,
                            totalDeliveries: 0,
                            uploadedDeliveries: 0,
                            notUploadedDeliveries: 0,
                            deliveryDetails: []
                        };
                    }
                    
                    if (material.deliveries && Array.isArray(material.deliveries)) {
                        material.deliveries.forEach(delivery => {
                            // ƒ∞rsaliye numarasƒ±nƒ± olu≈ütur (Excel'den gelen fieldlar: serie, no, date)
                            const deliveryStr = delivery.serie && delivery.no 
                                ? `${delivery.serie} | ${delivery.no}` 
                                : (delivery.serie || delivery.no || '');
                            
                            if (!deliveryStr) return;
                            
                            // Bu irsaliye i√ßin COA var mƒ± kontrol et + Tedarik√ßi bilgisini g√ºncelle
                            const coaRecord = coaData.find(coa => {
                                const coaDeliveries = Array.isArray(coa.deliveryNo) ? coa.deliveryNo : [coa.deliveryNo];
                                return coaDeliveries.includes(deliveryStr) && 
                                       (coa.materialCode === materialCode || coa.material === materialCode);
                            });
                            
                            const hasCOA = !!coaRecord;
                            
                            // Eƒüer COA varsa ve tedarik√ßi bilgisi hen√ºz alƒ±nmamƒ±≈üsa, ≈üimdi al
                            if (coaRecord && coaRecord.supplier && materialStats[materialCode].supplier === 'Belirtilmemi≈ü') {
                                materialStats[materialCode].supplier = coaRecord.supplier;
                            }
                            
                            materialStats[materialCode].totalDeliveries++;
                            if (hasCOA) {
                                materialStats[materialCode].uploadedDeliveries++;
                            } else {
                                materialStats[materialCode].notUploadedDeliveries++;
                            }
                            
                            // Detay bilgisini kaydet (Excel'den gelen field: date)
                            materialStats[materialCode].deliveryDetails.push({
                                deliveryNo: deliveryStr,
                                deliveryDate: delivery.date || 'Tarih yok',
                                hasCOA: hasCOA,
                                fileName: coaRecord?.fileName || '',
                                fileType: coaRecord?.fileType || '',
                                coaId: coaRecord?.id || ''
                            });
                        });
                    }
                });
                
                // Array'e √ßevir ve sƒ±rala
                const materialArray = Object.values(materialStats);
                
                // Global deƒüi≈ükende sakla (detay export i√ßin gerekli)
                window.currentReportData = materialArray;
                
                if (materialArray.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: #999;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üìã</div>
                            <h3 style="margin-bottom: 10px;">Excel'de ƒ∞rsaliye Kaydƒ± Yok</h3>
                            <p style="color: #666;">L√ºtfen √∂nce Excel y√ºkleyin.</p>
                        </div>
                    `;
                    return;
                }
                
                // Genel istatistikler
                const totalMaterials = materialArray.length;
                const totalDeliveries = materialArray.reduce((sum, m) => sum + m.totalDeliveries, 0);
                const totalUploaded = materialArray.reduce((sum, m) => sum + m.uploadedDeliveries, 0);
                const totalNotUploaded = materialArray.reduce((sum, m) => sum + m.notUploadedDeliveries, 0);
                const uploadPercentage = Math.round((totalUploaded / totalDeliveries) * 100);
                
                // Benzersiz COA dosya sayƒ±sƒ±nƒ± hesapla (coaData'dan)
                const uniqueCOAFiles = coaData.length;
                
                // E≈üle≈ümeyen COA'larƒ± bul
                const unmatchedCOAs = coaData.filter(coa => {
                    // Bu COA'nƒ±n irsaliye numaralarƒ±nƒ± al
                    const coaDeliveries = Array.isArray(coa.deliveryNo) ? coa.deliveryNo : [coa.deliveryNo];
                    
                    // Excel'de bu irsaliye numaralarƒ± var mƒ± kontrol et
                    let foundInExcel = false;
                    materials.forEach(material => {
                        if (material.deliveries && Array.isArray(material.deliveries)) {
                            material.deliveries.forEach(delivery => {
                                const deliveryStr = delivery.serie && delivery.no 
                                    ? `${delivery.serie} | ${delivery.no}` 
                                    : (delivery.serie || delivery.no || '');
                                if (coaDeliveries.includes(deliveryStr)) {
                                    foundInExcel = true;
                                }
                            });
                        }
                    });
                    
                    return !foundInExcel; // Excel'de bulunmayan COA'lar
                });
                
                // Benzersiz tedarik√ßi listesi
                const uniqueSuppliers = [...new Set(materialArray.map(m => m.supplier))];
                
                // Tablo olu≈ütur
                let tableHTML = `
                    ${unmatchedCOAs.length > 0 ? `
                    <!-- E≈üle≈ümeyen COA'lar Uyarƒ±sƒ± -->
                    <div style="margin-bottom: 20px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #856404; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <span>E≈üle≈ümeyen COA Dosyalarƒ± (${unmatchedCOAs.length})</span>
                        </h3>
                        <p style="color: #856404; margin-bottom: 15px;">
                            <strong>üìå Dikkat:</strong> A≈üaƒüƒ±daki COA dosyalarƒ± sisteme y√ºklenmi≈ü ancak Excel'deki irsaliye numaralarƒ± ile e≈üle≈ümemektedir.
                            ƒ∞rsaliye numaralarƒ±nƒ± kontrol edin veya Excel'i g√ºncelleyin.
                        </p>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8d7da; color: #721c24;">
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left; width: 40px;">#</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Dosya Adƒ±</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Hammadde Kodu</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Tedarik√ßi</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ƒ∞rsaliye No (COA'da)</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 100px;">ƒ∞≈ülem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${unmatchedCOAs.map((coa, idx) => {
                                        const deliveryNos = Array.isArray(coa.deliveryNo) ? coa.deliveryNo.join(', ') : (coa.deliveryNo || 'Yok');
                                        return `
                                        <tr style="background: ${idx % 2 === 0 ? 'white' : '#fafafa'};">
                                            <td style="padding: 10px; border: 1px solid #ddd;">${idx + 1}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">
                                                ${getFileIcon(coa.fileName, coa.fileType, coa.id)}
                                                <span style="margin-left: 8px;">${coa.fileName || 'Bilinmiyor'}</span>
                                            </td>
                                            <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; font-weight: bold;">${coa.materialCode || coa.material || '-'}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${coa.supplier || '-'}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; color: #dc3545; font-weight: bold;">${deliveryNos}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                                <button onclick="viewCOAFromArchive('${coa.id}')" 
                                                        style="padding: 5px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                    üëÅÔ∏è G√∂r√ºnt√ºle
                                                </button>
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${coaData.length > 0 ? `
                    <!-- Y√ºkl√º T√ºm COA Dosyalarƒ± -->
                    <div style="margin-bottom: 20px; padding: 20px; background: #d1ecf1; border-left: 4px solid #0c5460; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #0c5460; display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleAllCoaList()">
                            <span style="font-size: 24px;">üìÑ</span>
                            <span>T√ºm Y√ºkl√º COA Dosyalarƒ± (${coaData.length})</span>
                            <span id="allCoaToggleIcon" style="margin-left: auto; font-size: 18px;">‚ñº</span>
                        </h3>
                        <div id="allCoaListContainer" style="display: none;">
                            <p style="color: #0c5460; margin-bottom: 15px;">
                                <strong>üìã Bilgi:</strong> Sistemde kayƒ±tlƒ± t√ºm COA dosyalarƒ± a≈üaƒüƒ±da listelenmi≈ütir.
                            </p>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #17a2b8; color: white;">
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left; width: 40px;">#</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Dosya Adƒ±</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Hammadde Kodu</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Tedarik√ßi</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ƒ∞rsaliye No</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 80px;">Durum</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 100px;">ƒ∞≈ülem</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${coaData.map((coa, idx) => {
                                            const deliveryNos = Array.isArray(coa.deliveryNo) ? coa.deliveryNo.join(', ') : (coa.deliveryNo || 'Yok');
                                            const isMatched = !unmatchedCOAs.find(u => u.id === coa.id);
                                            const statusBadge = isMatched 
                                                ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚úÖ E≈üle≈üti</span>'
                                                : '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">‚ùå E≈üle≈ümedi</span>';
                                            return `
                                            <tr style="background: ${idx % 2 === 0 ? 'white' : '#fafafa'};">
                                                <td style="padding: 10px; border: 1px solid #ddd;">${idx + 1}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">
                                                    ${getFileIcon(coa.fileName, coa.fileType, coa.id)}
                                                    <span style="margin-left: 8px;">${coa.fileName || 'Bilinmiyor'}</span>
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; font-weight: bold;">${coa.materialCode || coa.material || '-'}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">${coa.supplier || '-'}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">${deliveryNos}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${statusBadge}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                                    <button onclick="viewCOAFromArchive('${coa.id}')" 
                                                            style="padding: 5px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                        üëÅÔ∏è G√∂r√ºnt√ºle
                                                    </button>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Arama ve Filtreleme -->
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: end;">
                            <!-- Arama -->
                            <div style="flex: 1; min-width: 250px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; color: #666;">üîç Ara</label>
                                <input type="text" id="reportSearchInput" placeholder="Hammadde kodu, adƒ± veya irsaliye no ile ara..." 
                                       style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;"
                                       oninput="filterReportTable()">
                            </div>
                            
                            <!-- Durum Filtresi -->
                            <div style="min-width: 180px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; color: #666;">üìä Durum</label>
                                <select id="reportStatusFilter" onchange="filterReportTable()" 
                                        style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                                    <option value="all">T√ºm√º</option>
                                    <option value="uploaded">‚úÖ Y√ºklenmi≈ü</option>
                                    <option value="notUploaded">‚ùå Eksikler</option>
                                    <option value="partial">‚ö†Ô∏è Kƒ±smi Y√ºklenmi≈ü</option>
                                    <option value="complete">‚úÖ Tam Tamamlanmƒ±≈ü (%100)</option>
                                </select>
                            </div>
                            
                            <!-- Tedarik√ßi Filtresi -->
                            <div style="min-width: 180px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; color: #666;">üè¢ Tedarik√ßi</label>
                                <select id="reportSupplierFilter" onchange="filterReportTable()" 
                                        style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
                                    <option value="all">T√ºm√º</option>
                                    ${uniqueSuppliers.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Temizle Butonu -->
                            <div>
                                <button onclick="clearReportFilters()" 
                                        style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                    üîÑ Temizle
                                </button>
                            </div>
                            
                            <!-- Export Butonlarƒ± -->
                            <div style="display: flex; gap: 10px;">
                                <button onclick="exportReportToExcel()" 
                                        style="padding: 10px 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    üìä Excel
                                </button>
                                <button onclick="exportReportToPDF()" 
                                        style="padding: 10px 20px; background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                    üìÑ PDF
                                </button>
                            </div>
                        </div>
                        
                        <div id="reportFilterSummary" style="margin-top: 10px; padding: 8px 12px; background: #f0f8ff; border-left: 3px solid #2196F3; border-radius: 4px; font-size: 12px; display: none;">
                            <strong>Filtreleme aktif:</strong> <span id="reportFilterText"></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 160px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${totalMaterials}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Toplam Hammadde</div>
                        </div>
                        <div style="flex: 1; min-width: 160px; padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${totalDeliveries}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Toplam ƒ∞rsaliye</div>
                        </div>
                        <div style="flex: 1; min-width: 160px; padding: 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${uniqueCOAFiles}</div>
                            <div style="font-size: 14px; opacity: 0.9;">üìÑ Benzersiz COA</div>
                        </div>
                        <div style="flex: 1; min-width: 160px; padding: 20px; background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${totalUploaded}</div>
                            <div style="font-size: 13px; opacity: 0.9;">‚úÖ COA'lƒ± ƒ∞rsaliye</div>
                        </div>
                        <div style="flex: 1; min-width: 160px; padding: 20px; background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${totalNotUploaded}</div>
                            <div style="font-size: 13px; opacity: 0.9;">‚ùå COA Eksik ƒ∞rsaliye</div>
                        </div>
                        <div style="flex: 1; min-width: 160px; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">%${uploadPercentage}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Tamamlanma</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 13px;">
                        <strong>üí° Bilgi:</strong> ${uniqueCOAFiles} adet benzersiz COA dosyasƒ±, Excel'deki ${totalUploaded} farklƒ± irsaliye ile e≈üle≈ümi≈ütir.
                        ${uniqueCOAFiles < totalUploaded ? ' Bazƒ± COA dosyalarƒ± birden fazla irsaliye i√ßin kullanƒ±lmƒ±≈ütƒ±r.' : ''}
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="reportTable" style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left; width: 40px;">#</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Hammadde Kodu</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Hammadde Adƒ±</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Tedarik√ßi</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 120px;">Toplam ƒ∞rsaliye</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 120px;">‚úÖ Y√ºklendi</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 120px;">‚ùå Y√ºklenmedi</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 100px;">Tamamlanma</th>
                                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 60px;">Detay</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                `;
                
                materialArray.forEach((material, index) => {
                    const percentage = Math.round((material.uploadedDeliveries / material.totalDeliveries) * 100);
                    const progressColor = percentage === 100 ? '#4CAF50' : percentage >= 50 ? '#ff9800' : '#f44336';
                    const rowId = `material-row-${index}`;
                    const detailId = `material-detail-${index}`;
                    
                    // Ana satƒ±r (hammadde √∂zeti)
                    tableHTML += `
                        <tr id="${rowId}" style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'}; cursor: pointer;" 
                            onclick="toggleMaterialDetail('${detailId}', '${rowId}')">
                            <td style="padding: 10px; border: 1px solid #ddd;">${index + 1}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; font-weight: bold;">${material.materialCode}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${material.materialName}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${material.supplier}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${material.totalDeliveries}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #4CAF50; font-weight: bold;">${material.uploadedDeliveries}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #f44336; font-weight: bold;">${material.notUploadedDeliveries}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                <div style="background: ${progressColor}; color: white; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 11px;">
                                    %${percentage}
                                </div>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                <span id="icon-${detailId}" style="font-size: 14px;">‚ñ∂</span>
                            </td>
                        </tr>
                    `;
                    
                    // Detay satƒ±rlarƒ± (ba≈ülangƒ±√ßta gizli)
                    tableHTML += `
                        <tr id="${detailId}" style="display: none;">
                            <td colspan="9" style="padding: 0; border: 1px solid #ddd;">
                                <div style="background: #f5f5f5; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: #667eea;">üìã ${material.materialCode} - ƒ∞rsaliye Detaylarƒ±</h4>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="exportDeliveryDetailsToExcel('${material.materialCode}')" 
                                                    style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px;">
                                                üìä Excel
                                            </button>
                                            <button onclick="exportDeliveryDetailsToPDF('${material.materialCode}')" 
                                                    style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px;">
                                                üìÑ PDF
                                            </button>
                                        </div>
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse; background: white; font-size: 12px;">
                                        <thead>
                                            <tr style="background: #e0e7ff;">
                                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left; width: 40px;">#</th>
                                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 100px;">COA Durumu</th>
                                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center; width: 60px;">Dosya</th>
                                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ƒ∞rsaliye Tarihi</th>
                                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ƒ∞rsaliye No</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    // ƒ∞rsaliye detaylarƒ±nƒ± tarihe g√∂re sƒ±rala (en yeni √ºstte)
                    const sortedDeliveries = [...material.deliveryDetails].sort((a, b) => {
                        const dateA = a.deliveryDate.split('.').reverse().join('');
                        const dateB = b.deliveryDate.split('.').reverse().join('');
                        return dateB.localeCompare(dateA);
                    });
                    
                    sortedDeliveries.forEach((delivery, dIndex) => {
                        const statusIcon = delivery.hasCOA ? '‚úÖ' : '‚ùå';
                        const statusText = delivery.hasCOA ? 'Y√ºklendi' : 'Y√ºklenmedi';
                        const statusColor = delivery.hasCOA ? '#4CAF50' : '#f44336';
                        
                        // Dosya ikonu olu≈ütur
                        let fileIconHtml = '-';
                        if (delivery.hasCOA && delivery.fileName) {
                            fileIconHtml = getFileIcon(delivery.fileName, delivery.fileType, delivery.coaId);
                        }
                        
                        tableHTML += `
                            <tr style="background: ${dIndex % 2 === 0 ? 'white' : '#fafafa'};">
                                <td style="padding: 8px; border: 1px solid #ddd;">${dIndex + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <div style="display: inline-block; padding: 4px 10px; background: ${statusColor}; color: white; border-radius: 15px; font-weight: bold; font-size: 10px;">
                                        ${statusIcon} ${statusText}
                                    </div>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${fileIconHtml}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${delivery.deliveryDate}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-weight: bold;">${delivery.deliveryNo}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <span id="reportSummaryText"><strong>üìä √ñzet:</strong> ${totalMaterials} hammadde i√ßin ${totalDeliveries} irsaliye kaydƒ± bulunuyor. 
                        ${totalUploaded} irsaliye i√ßin COA y√ºklenmi≈ü (%${uploadPercentage} tamamlanma).</span>
                    </div>
                `;
                
                // Filtreleme i√ßin verileri sakla
                window.reportMaterialData = materialArray;
                window.reportOriginalSummary = {
                    totalMaterials: totalMaterials,
                    totalDeliveries: totalDeliveries,
                    totalUploaded: totalUploaded,
                    totalNotUploaded: totalNotUploaded,
                    uploadPercentage: uploadPercentage
                };
                
                contentDiv.innerHTML = tableHTML;
                
                // Console'a da yazdƒ±r
                console.log('üìã HAMMADDE BAZLI COA DURUM RAPORU:');
                console.table(materialArray.map(m => ({
                    'Hammadde': m.materialCode,
                    'Tedarik√ßi': m.supplier,
                    'Toplam': m.totalDeliveries,
                    'Y√ºklendi': m.uploadedDeliveries,
                    'Y√ºklenmedi': m.notUploadedDeliveries,
                    'Oran %': Math.round((m.uploadedDeliveries / m.totalDeliveries) * 100)
                })));
                
            } catch (error) {
                console.error('‚ùå Rapor olu≈üturma hatasƒ±:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                        <h3>Hata Olu≈ütu</h3>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Hammadde detayƒ±nƒ± a√ß/kapat
        function toggleMaterialDetail(detailId, rowId) {
            const detailRow = document.getElementById(detailId);
            const iconSpan = document.getElementById('icon-' + detailId);
            
            if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                iconSpan.textContent = '‚ñº';
            } else {
                detailRow.style.display = 'none';
                iconSpan.textContent = '‚ñ∂';
            }
        }
        
        // T√ºm COA listesini a√ß/kapat
        function toggleAllCoaList() {
            const container = document.getElementById('allCoaListContainer');
            const icon = document.getElementById('allCoaToggleIcon');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }
        
        // COA'yƒ± ar≈üivden g√∂r√ºnt√ºle
        function viewCOAFromArchive(coaId) {
            const coa = coaData.find(c => c.id === coaId);
            if (!coa) {
                showToast('‚ùå COA bulunamadƒ±!', 'error');
                return;
            }
            
            // viewFile fonksiyonunu √ßaƒüƒ±r
            if (typeof viewFile === 'function') {
                viewFile(coaId);
            } else {
                showToast('‚ÑπÔ∏è COA: ' + (coa.fileName || 'Bilinmiyor'), 'info');
            }
        }
        
        // Rapor tablosunu filtrele
        function filterReportTable() {
            if (!window.reportMaterialData) return;
            
            const searchValue = document.getElementById('reportSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('reportStatusFilter').value;
            const supplierFilter = document.getElementById('reportSupplierFilter').value;
            
            const tbody = document.getElementById('reportTableBody');
            const rows = tbody.querySelectorAll('tr[id^="material-row-"]');
            
            let visibleCount = 0;
            let filteredTotalDeliveries = 0;
            let filteredUploadedDeliveries = 0;
            
            rows.forEach((row, index) => {
                const material = window.reportMaterialData[index];
                if (!material) return;
                
                // Arama filtresi
                let matchesSearch = true;
                if (searchValue) {
                    const searchText = `${material.materialCode} ${material.materialName} ${material.supplier}`.toLowerCase();
                    const deliveryNos = material.deliveryDetails.map(d => d.deliveryNo.toLowerCase()).join(' ');
                    matchesSearch = searchText.includes(searchValue) || deliveryNos.includes(searchValue);
                }
                
                // Durum filtresi
                let matchesStatus = true;
                if (statusFilter !== 'all') {
                    const percentage = Math.round((material.uploadedDeliveries / material.totalDeliveries) * 100);
                    if (statusFilter === 'uploaded') {
                        matchesStatus = material.uploadedDeliveries > 0;
                    } else if (statusFilter === 'notUploaded') {
                        matchesStatus = material.notUploadedDeliveries > 0;
                    } else if (statusFilter === 'partial') {
                        matchesStatus = percentage > 0 && percentage < 100;
                    } else if (statusFilter === 'complete') {
                        matchesStatus = percentage === 100;
                    }
                }
                
                // Tedarik√ßi filtresi
                let matchesSupplier = true;
                if (supplierFilter !== 'all') {
                    matchesSupplier = material.supplier === supplierFilter;
                }
                
                // Sonu√ß g√∂ster/gizle
                const detailRow = document.getElementById(`material-detail-${index}`);
                if (matchesSearch && matchesStatus && matchesSupplier) {
                    row.style.display = '';
                    visibleCount++;
                    filteredTotalDeliveries += material.totalDeliveries;
                    filteredUploadedDeliveries += material.uploadedDeliveries;
                } else {
                    row.style.display = 'none';
                    if (detailRow) detailRow.style.display = 'none';
                }
            });
            
            // Filtre √∂zetini g√ºncelle
            updateFilterSummary(searchValue, statusFilter, supplierFilter, visibleCount, filteredTotalDeliveries, filteredUploadedDeliveries);
        }
        
        // Filtre √∂zetini g√ºncelle
        function updateFilterSummary(search, status, supplier, count, totalDel, uploadedDel) {
            const summaryDiv = document.getElementById('reportFilterSummary');
            const summaryTextSpan = document.getElementById('reportFilterText');
            const reportSummaryText = document.getElementById('reportSummaryText');
            
            // Elementler yoksa sessizce √ßƒ±k
            if (!summaryDiv || !summaryTextSpan || !reportSummaryText) {
                console.warn('‚ö†Ô∏è Rapor √∂zet elementleri bulunamadƒ±');
                return;
            }
            
            const hasFilters = search || status !== 'all' || supplier !== 'all';
            
            if (hasFilters) {
                summaryDiv.style.display = 'block';
                
                let filters = [];
                if (search) filters.push(`Arama: "${search}"`);
                if (status !== 'all') {
                    const statusTexts = {
                        'uploaded': '‚úÖ Y√ºklenmi≈ü',
                        'notUploaded': '‚ùå Eksikler',
                        'partial': '‚ö†Ô∏è Kƒ±smi',
                        'complete': '‚úÖ Tam'
                    };
                    filters.push(`Durum: ${statusTexts[status]}`);
                }
                if (supplier !== 'all') filters.push(`Tedarik√ßi: ${supplier}`);
                
                summaryTextSpan.textContent = filters.join(' | ');
                
                // √ñzet istatistiƒüini g√ºncelle
                const percentage = totalDel > 0 ? Math.round((uploadedDel / totalDel) * 100) : 0;
                reportSummaryText.innerHTML = `<strong>üìä √ñzet:</strong> ${count} hammadde i√ßin ${totalDel} irsaliye kaydƒ± bulunuyor. ${uploadedDel} irsaliye i√ßin COA y√ºklenmi≈ü (%${percentage} tamamlanma).`;
            } else {
                summaryDiv.style.display = 'none';
                // Orijinal √∂zeti geri y√ºkle
                if (window.reportOriginalSummary) {
                    const orig = window.reportOriginalSummary;
                    reportSummaryText.innerHTML = `<strong>üìä √ñzet:</strong> ${orig.totalMaterials} hammadde i√ßin ${orig.totalDeliveries} irsaliye kaydƒ± bulunuyor. ${orig.totalUploaded} irsaliye i√ßin COA y√ºklenmi≈ü (%${orig.uploadPercentage} tamamlanma).`;
                }
            }
        }
        
        // Filtreleri temizle
        function clearReportFilters() {
            document.getElementById('reportSearchInput').value = '';
            document.getElementById('reportStatusFilter').value = 'all';
            document.getElementById('reportSupplierFilter').value = 'all';
            filterReportTable();
        }
        
        // Excel Export
        function exportReportToExcel() {
            if (!window.reportMaterialData || window.reportMaterialData.length === 0) {
                showToast('‚ö†Ô∏è Rapor verisi bulunamadƒ±!', 'warning');
                return;
            }
            
            try {
                // Filtrelenmi≈ü verileri al
                const visibleRows = document.querySelectorAll('#reportTableBody tr[id^="material-row-"]:not([style*="display: none"])');
                const filteredData = [];
                visibleRows.forEach(row => {
                    const index = parseInt(row.id.replace('material-row-', ''));
                    if (window.reportMaterialData[index]) {
                        filteredData.push(window.reportMaterialData[index]);
                    }
                });
                
                if (filteredData.length === 0) {
                    showToast('‚ö†Ô∏è Export edilecek veri yok!', 'warning');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                
                // 1. √ñzet sayfa
                const summaryData = [
                    ['COA DURUM RAPORU - √ñZET'],
                    [],
                    ['Rapor Tarihi:', new Date().toLocaleString('tr-TR')],
                    [],
                    ['Toplam Hammadde:', filteredData.length],
                    ['Toplam ƒ∞rsaliye:', filteredData.reduce((sum, m) => sum + m.totalDeliveries, 0)],
                    ['Benzersiz COA Dosyasƒ±:', coaData.length],
                    ['COA\'lƒ± ƒ∞rsaliye:', filteredData.reduce((sum, m) => sum + m.uploadedDeliveries, 0)],
                    ['COA Eksik ƒ∞rsaliye:', filteredData.reduce((sum, m) => sum + m.notUploadedDeliveries, 0)],
                    ['Tamamlanma Oranƒ±:', Math.round((filteredData.reduce((sum, m) => sum + m.uploadedDeliveries, 0) / filteredData.reduce((sum, m) => sum + m.totalDeliveries, 0)) * 100) + '%'],
                ];
                const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
                ws_summary['!cols'] = [{ wch: 25 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, ws_summary, '√ñzet');
                
                // 2. Hammadde √∂zet sayfasƒ±
                const materialHeaders = [['#', 'Hammadde Kodu', 'Hammadde Adƒ±', 'Tedarik√ßi', 'Toplam ƒ∞rsaliye', 'Y√ºklendi', 'Y√ºklenmedi', 'Tamamlanma %']];
                const materialRows = filteredData.map((m, idx) => [
                    idx + 1,
                    m.materialCode,
                    m.materialName,
                    m.supplier,
                    m.totalDeliveries,
                    m.uploadedDeliveries,
                    m.notUploadedDeliveries,
                    Math.round((m.uploadedDeliveries / m.totalDeliveries) * 100)
                ]);
                const ws_materials = XLSX.utils.aoa_to_sheet([...materialHeaders, ...materialRows]);
                ws_materials['!cols'] = [
                    { wch: 5 }, { wch: 20 }, { wch: 40 }, { wch: 30 }, 
                    { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 15 }
                ];
                XLSX.utils.book_append_sheet(wb, ws_materials, 'Hammaddeler');
                
                // 3. Detaylƒ± irsaliye sayfasƒ±
                const detailHeaders = [['Hammadde Kodu', 'Hammadde Adƒ±', 'Tedarik√ßi', 'ƒ∞rsaliye No', 'ƒ∞rsaliye Tarihi', 'COA Durumu', 'Dosya Tipi']];
                const detailRows = [];
                filteredData.forEach(m => {
                    m.deliveryDetails.forEach(d => {
                        // Dosya uzantƒ±sƒ±nƒ± al
                        let fileExt = '-';
                        if (d.hasCOA && d.fileName) {
                            fileExt = d.fileName.split('.').pop().toUpperCase();
                        }
                        
                        detailRows.push([
                            m.materialCode,
                            m.materialName,
                            m.supplier,
                            d.deliveryNo,
                            d.deliveryDate,
                            d.hasCOA ? 'Y√ºklendi' : 'Y√ºklenmedi',
                            fileExt
                        ]);
                    });
                });
                const ws_details = XLSX.utils.aoa_to_sheet([...detailHeaders, ...detailRows]);
                ws_details['!cols'] = [
                    { wch: 20 }, { wch: 40 }, { wch: 30 }, 
                    { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 12 }
                ];
                XLSX.utils.book_append_sheet(wb, ws_details, 'Detaylƒ± ƒ∞rsaliye');
                
                // Excel dosyasƒ±nƒ± indir
                const fileName = `COA_Durum_Raporu_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('‚úÖ Excel raporu indirildi!', 'success');
            } catch (error) {
                console.error('Excel export hatasƒ±:', error);
                showToast('‚ùå Excel export hatasƒ±: ' + error.message, 'error');
            }
        }
        
        // PDF Export
        function exportReportToPDF() {
            if (!window.reportMaterialData || window.reportMaterialData.length === 0) {
                showToast('‚ö†Ô∏è Rapor verisi bulunamadƒ±!', 'warning');
                return;
            }
            
            try {
                // Filtrelenmi≈ü verileri al
                const visibleRows = document.querySelectorAll('#reportTableBody tr[id^="material-row-"]:not([style*="display: none"])');
                const filteredData = [];
                visibleRows.forEach(row => {
                    const index = parseInt(row.id.replace('material-row-', ''));
                    if (window.reportMaterialData[index]) {
                        filteredData.push(window.reportMaterialData[index]);
                    }
                });
                
                if (filteredData.length === 0) {
                    showToast('‚ö†Ô∏è Export edilecek veri yok!', 'warning');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape mode
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yPos = 20;
                
                // Ba≈ülƒ±k
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('COA DURUM RAPORU', pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rapor Tarihi: ${new Date().toLocaleString('tr-TR')}`, pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;
                
                // ƒ∞statistikler
                const totalDel = filteredData.reduce((sum, m) => sum + m.totalDeliveries, 0);
                const totalUpload = filteredData.reduce((sum, m) => sum + m.uploadedDeliveries, 0);
                const totalNotUpload = filteredData.reduce((sum, m) => sum + m.notUploadedDeliveries, 0);
                const percentage = Math.round((totalUpload / totalDel) * 100);
                const uniqueCOA = coaData.length;
                
                doc.setFontSize(9);
                const stats = `Hammadde: ${filteredData.length} | Irsaliye: ${totalDel} | Benzersiz COA: ${uniqueCOA} | COA'li Irsaliye: ${totalUpload} | Eksik: ${totalNotUpload} | %${percentage}`;
                doc.text(stats, pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;
                
                // Tablo ba≈ülƒ±klarƒ±
                const headers = [['#', 'Kod', 'Hammadde Adi', 'Tedarikci', 'Toplam', 'Yuklendi', 'Yuklenmedi', '%']];
                const rows = filteredData.map((m, idx) => [
                    idx + 1,
                    m.materialCode,
                    m.materialName.substring(0, 40), // Kƒ±salt
                    m.supplier.substring(0, 25), // Kƒ±salt
                    m.totalDeliveries,
                    m.uploadedDeliveries,
                    m.notUploadedDeliveries,
                    Math.round((m.uploadedDeliveries / m.totalDeliveries) * 100)
                ]);
                
                // AutoTable plugin kontrol√º
                if (typeof doc.autoTable === 'function') {
                    doc.autoTable({
                        head: headers,
                        body: rows,
                        startY: yPos,
                        theme: 'striped',
                        styles: { fontSize: 7, cellPadding: 2 },
                        headStyles: { fillColor: [102, 126, 234], textColor: 255 },
                        columnStyles: {
                            0: { cellWidth: 10 },
                            1: { cellWidth: 25 },
                            2: { cellWidth: 60 },
                            3: { cellWidth: 50 },
                            4: { cellWidth: 18 },
                            5: { cellWidth: 20 },
                            6: { cellWidth: 20 },
                            7: { cellWidth: 15 }
                        }
                    });
                } else {
                    // AutoTable yoksa basit tablo
                    doc.setFontSize(8);
                    const colWidths = [10, 25, 60, 50, 18, 20, 20, 15];
                    let xPos = 14;
                    
                    // Ba≈ülƒ±klarƒ± √ßiz
                    headers[0].forEach((h, i) => {
                        doc.text(h, xPos, yPos);
                        xPos += colWidths[i];
                    });
                    yPos += 6;
                    
                    // Satƒ±rlarƒ± √ßiz (max 30 satƒ±r)
                    rows.slice(0, 30).forEach(row => {
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        xPos = 14;
                        row.forEach((cell, i) => {
                            doc.text(String(cell), xPos, yPos);
                            xPos += colWidths[i];
                        });
                        yPos += 5;
                    });
                    
                    if (rows.length > 30) {
                        yPos += 5;
                        doc.text(`... ve ${rows.length - 30} hammadde daha`, 14, yPos);
                    }
                }
                
                // PDF'i indir
                const fileName = `COA_Durum_Raporu_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('‚úÖ PDF raporu indirildi!', 'success');
            } catch (error) {
                console.error('PDF export hatasƒ±:', error);
                showToast('‚ùå PDF export hatasƒ±: ' + error.message, 'error');
            }
        }
        
        // Detay Listesi Excel Export
        function exportDeliveryDetailsToExcel(materialCode) {
            if (!window.currentReportData) {
                showToast('‚ö†Ô∏è Rapor verisi bulunamadƒ±!', 'warning');
                return;
            }
            
            try {
                // ƒ∞lgili materyali bul
                const material = window.currentReportData.find(m => m.materialCode === materialCode);
                
                if (!material || !material.deliveryDetails) {
                    showToast('‚ö†Ô∏è Detay verisi bulunamadƒ±!', 'warning');
                    return;
                }
                
                // Excel workbook olu≈ütur
                const wb = XLSX.utils.book_new();
                
                // Sƒ±ralƒ± detay verisi
                const sortedDeliveries = [...material.deliveryDetails].sort((a, b) => {
                    const dateA = a.deliveryDate.split('.').reverse().join('');
                    const dateB = b.deliveryDate.split('.').reverse().join('');
                    return dateB.localeCompare(dateA);
                });
                
                // Veriyi hazƒ±rla
                const excelData = [
                    ['ƒ∞RSALƒ∞YE DETAYLARI'],
                    [],
                    ['Hammadde Kodu:', material.materialCode],
                    ['Hammadde Adƒ±:', material.materialName],
                    ['Tedarik√ßi:', material.supplier],
                    ['Toplam ƒ∞rsaliye:', material.totalDeliveries],
                    ['COA Y√ºkl√º:', material.uploadedDeliveries],
                    ['COA Eksik:', material.notUploadedDeliveries],
                    ['Tamamlanma:', Math.round((material.uploadedDeliveries / material.totalDeliveries) * 100) + '%'],
                    [],
                    ['#', 'COA Durumu', 'ƒ∞rsaliye Tarihi', 'ƒ∞rsaliye No', 'Dosya Adƒ±']
                ];
                
                sortedDeliveries.forEach((delivery, index) => {
                    excelData.push([
                        index + 1,
                        delivery.hasCOA ? 'Y√ºklendi' : 'Y√ºklenmedi',
                        delivery.deliveryDate,
                        delivery.deliveryNo,
                        delivery.fileName || '-'
                    ]);
                });
                
                // Sheet olu≈ütur
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Kolon geni≈ülikleri
                ws['!cols'] = [
                    { wch: 5 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 25 },
                    { wch: 40 }
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'ƒ∞rsaliye Detaylarƒ±');
                
                // ƒ∞ndir
                const fileName = `Irsaliye_Detaylari_${materialCode}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('‚úÖ Excel dosyasƒ± indirildi!', 'success');
            } catch (error) {
                console.error('Excel export hatasƒ±:', error);
                showToast('‚ùå Excel export hatasƒ±: ' + error.message, 'error');
            }
        }
        
        // Detay Listesi PDF Export
        function exportDeliveryDetailsToPDF(materialCode) {
            if (!window.currentReportData) {
                showToast('‚ö†Ô∏è Rapor verisi bulunamadƒ±!', 'warning');
                return;
            }
            
            try {
                // ƒ∞lgili materyali bul
                const material = window.currentReportData.find(m => m.materialCode === materialCode);
                
                if (!material || !material.deliveryDetails) {
                    showToast('‚ö†Ô∏è Detay verisi bulunamadƒ±!', 'warning');
                    return;
                }
                
                // PDF olu≈ütur
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // Ba≈ülƒ±k
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('ƒ∞RSALƒ∞YE DETAYLARI', pageWidth / 2, 20, { align: 'center' });
                
                // Tarih
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Rapor Tarihi: ${new Date().toLocaleString('tr-TR')}`, pageWidth / 2, 28, { align: 'center' });
                
                // Materyal bilgileri
                let yPos = 40;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Materyal Bilgileri:', 14, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Hammadde Kodu: ${material.materialCode}`, 14, yPos);
                yPos += 5;
                doc.text(`Hammadde Adƒ±: ${material.materialName}`, 14, yPos);
                yPos += 5;
                doc.text(`Tedarik√ßi: ${material.supplier}`, 14, yPos);
                yPos += 5;
                doc.text(`Toplam ƒ∞rsaliye: ${material.totalDeliveries}`, 14, yPos);
                yPos += 5;
                doc.text(`COA Y√ºkl√º: ${material.uploadedDeliveries}`, 14, yPos);
                yPos += 5;
                doc.text(`COA Eksik: ${material.notUploadedDeliveries}`, 14, yPos);
                yPos += 5;
                doc.text(`Tamamlanma: ${Math.round((material.uploadedDeliveries / material.totalDeliveries) * 100)}%`, 14, yPos);
                yPos += 12;
                
                // ƒ∞rsaliye tablosu
                const sortedDeliveries = [...material.deliveryDetails].sort((a, b) => {
                    const dateA = a.deliveryDate.split('.').reverse().join('');
                    const dateB = b.deliveryDate.split('.').reverse().join('');
                    return dateB.localeCompare(dateA);
                });
                
                const headers = [['#', 'COA Durumu', 'ƒ∞rsaliye Tarihi', 'ƒ∞rsaliye No']];
                const rows = sortedDeliveries.map((delivery, index) => [
                    index + 1,
                    delivery.hasCOA ? 'Y√ºklendi' : 'Y√ºklenmedi',
                    delivery.deliveryDate,
                    delivery.deliveryNo
                ]);
                
                // AutoTable kullanarak tablo olu≈ütur
                if (typeof doc.autoTable === 'function') {
                    doc.autoTable({
                        head: headers,
                        body: rows,
                        startY: yPos,
                        theme: 'striped',
                        styles: { fontSize: 9, cellPadding: 3 },
                        headStyles: { fillColor: [102, 126, 234], textColor: 255 },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 35 },
                            2: { cellWidth: 35 },
                            3: { cellWidth: 105 }
                        }
                    });
                } else {
                    // Basit tablo (AutoTable yoksa)
                    doc.setFontSize(9);
                    headers[0].forEach((h, i) => {
                        doc.text(h, 14 + (i * 45), yPos);
                    });
                    yPos += 7;
                    
                    rows.slice(0, 30).forEach(row => {
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        row.forEach((cell, i) => {
                            doc.text(String(cell), 14 + (i * 45), yPos);
                        });
                        yPos += 6;
                    });
                }
                
                // ƒ∞ndir
                const fileName = `Irsaliye_Detaylari_${materialCode}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('‚úÖ PDF dosyasƒ± indirildi!', 'success');
            } catch (error) {
                console.error('PDF export hatasƒ±:', error);
                showToast('‚ùå PDF export hatasƒ±: ' + error.message, 'error');
            }
        }
        
        function closeCOAAnalysisModal() {
            document.getElementById('coaAnalysisModal').classList.remove('active');
            // T√ºm grafikleri temizle
            analysisCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            analysisCharts = [];
        }
        
        async function loadAnalysisSuppliers() {
            try {
                showToast('üìä Veriler y√ºkleniyor...', 'info');
                
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = 15000;
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('JSON parse hatasƒ±'));
                            }
                        } else {
                            reject(new Error('HTTP ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.ontimeout = () => reject(new Error('Timeout'));
                    
                    xhr.open('GET', googleScriptUrl + '?action=getCOARecords', true);
                    xhr.send();
                });
                
                if (!result || !result.success) {
                    showToast('‚ùå Veri y√ºklenemedi: ' + (result?.error || 'Bilinmeyen hata'), 'error');
                    return;
                }
                
                analysisData = result.data || [];
                console.log('üìä Y√ºklenen kayƒ±t sayƒ±sƒ±:', analysisData.length);
                
                // Tedarik√ßileri √ßƒ±kar
                const suppliers = [...new Set(analysisData.map(r => r.supplier))].sort();
                const locations = [...new Set(analysisData.map(r => r.location).filter(Boolean))].sort();
                
                const supplierSelect = document.getElementById('analysisSupplierSelect');
                supplierSelect.innerHTML = '<option value="">Tedarik√ßi se√ßin...</option>';
                suppliers.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    supplierSelect.appendChild(option);
                });
                
                // Lokasyon dropdown'u doldur
                const locationSelect = document.getElementById('analysisLocationSelect');
                locationSelect.innerHTML = '<option value="">T√ºm√º</option>';
                locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                });
                
                showToast(`‚úÖ ${analysisData.length} kayƒ±t y√ºklendi`, 'success');
                
            } catch(error) {
                console.error('‚ùå Analiz veri y√ºkleme hatasƒ±:', error);
                showToast('‚ùå Veriler y√ºklenemedi', 'error');
            }
        }
        
        function loadAnalysisMaterials() {
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const materialSelect = document.getElementById('analysisMaterialSelect');
            const propertyContainer = document.getElementById('analysisPropertyContainer');
            
            materialSelect.innerHTML = '<option value="">Hammadde se√ßin...</option>';
            propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">√ñnce hammadde se√ßin...</div>';
            
            if (!supplier) {
                materialSelect.innerHTML = '<option value="">√ñnce tedarik√ßi se√ßin...</option>';
                return;
            }
            
            const materials = [...new Set(
                analysisData.filter(r => r.supplier === supplier).map(r => r.materialCode)
            )].sort();
            
            materials.forEach(m => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m;
                materialSelect.appendChild(option);
            });
        }
        
        function loadAnalysisProperties() {
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const material = document.getElementById('analysisMaterialSelect').value;
            const propertyContainer = document.getElementById('analysisPropertyContainer');
            
            propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Y√ºkleniyor...</div>';
            
            if (!supplier || !material) {
                propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">√ñnce hammadde se√ßin...</div>';
                return;
            }
            
            const properties = [...new Set(
                analysisData
                    .filter(r => r.supplier === supplier && r.materialCode === material)
                    .map(r => r.propertyName)
            )].sort();
            
            // Checkbox listesi olu≈ütur
            propertyContainer.innerHTML = '';
            if (properties.length === 0) {
                propertyContainer.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Bu hammadde i√ßin √∂zellik bulunamadƒ±</div>';
                return;
            }
            
            properties.forEach(p => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '8px';
                label.style.cursor = 'pointer';
                label.style.borderBottom = '1px solid #f0f0f0';
                label.innerHTML = `
                    <input type="checkbox" value="${p}" style="margin-right: 8px;" onchange="updatePropertySelection()">
                    <span>${p}</span>
                `;
                propertyContainer.appendChild(label);
            });
        }
        
        function updatePropertySelection() {
            // Se√ßili √∂zellik sayƒ±sƒ±nƒ± g√∂ster
            const checkboxes = document.querySelectorAll('#analysisPropertyContainer input[type="checkbox"]:checked');
            console.log('Se√ßili √∂zellik sayƒ±sƒ±:', checkboxes.length);
        }
        
                
        function loadAnalysisChart() {
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const material = document.getElementById('analysisMaterialSelect').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;
            const location = document.getElementById('analysisLocationSelect').value;
            
            // Se√ßili √∂zellikleri al
            const selectedProperties = Array.from(
                document.querySelectorAll('#analysisPropertyContainer input[type="checkbox"]:checked')
            ).map(cb => cb.value);
            
            if (!supplier || !material || selectedProperties.length === 0) {
                showToast('‚ö†Ô∏è Tedarik√ßi, hammadde ve en az bir √∂zellik se√ßmelisiniz', 'warning');
                return;
            }
            
            // Eski grafikleri temizle
            analysisCharts.forEach(chart => {
                if (chart) chart.destroy();
            });
            analysisCharts = [];
            
            // Container'ƒ± temizle
            const chartsContainer = document.getElementById('analysisChartsContainer');
            chartsContainer.innerHTML = '';
            chartsContainer.style.display = 'block';
            
            document.getElementById('analysisEmptyState').style.display = 'none';
            
            let allValues = [];
            
            // Her √∂zellik i√ßin ayrƒ± grafik olu≈ütur
            selectedProperties.forEach((property, propIndex) => {
                // Bu √∂zellik i√ßin verileri filtrele
                let propData = analysisData.filter(r => {
                    if (r.supplier !== supplier || r.materialCode !== material || r.propertyName !== property) return false;
                    
                    // Tarih filtresi
                    if (startDate || endDate) {
                        const recordDate = new Date(r.date);
                        if (startDate && recordDate < new Date(startDate)) return false;
                        if (endDate && recordDate > new Date(endDate)) return false;
                    }
                    
                    // Lokasyon filtresi
                    if (location && r.location !== location) return false;
                    
                    return true;
                }).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (propData.length === 0) return;
                
                // Grafik container olu≈ütur (flex layout ile grafik + istatistikler)
                const chartWrapper = document.createElement('div');
                chartWrapper.style.cssText = 'background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 20px;';
                
                // Sol taraf - Grafik
                const chartDiv = document.createElement('div');
                chartDiv.style.cssText = 'flex: 1; height: 450px;';
                
                const canvas = document.createElement('canvas');
                canvas.id = `analysisChart_${propIndex}`;
                canvas.style.height = '400px';
                chartDiv.appendChild(canvas);
                
                // Saƒü taraf - ƒ∞statistikler
                const statsDiv = document.createElement('div');
                statsDiv.style.cssText = 'width: 250px; background: #f8f9fa; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px;';
                statsDiv.id = `stats_${propIndex}`;
                
                chartWrapper.appendChild(chartDiv);
                chartWrapper.appendChild(statsDiv);
                chartsContainer.appendChild(chartWrapper);
                
                // Label'lar
                const labels = propData.map(r => {
                    const date = new Date(r.date).toLocaleDateString('tr-TR');
                    return `${date} - ${r.deliveryNo || 'N/A'}`;
                });
                
                // Deƒüerleri ve renkleri hazƒ±rla
                const values = [];
                const backgroundColors = [];
                const borderColors = [];
                const pointBackgroundColors = [];
                const pointBorderColors = [];
                
                const colors = [
                    { bg: 'rgba(33, 150, 243, 0.7)', border: 'rgba(33, 150, 243, 1)' },
                    { bg: 'rgba(76, 175, 80, 0.7)', border: 'rgba(76, 175, 80, 1)' },
                    { bg: 'rgba(255, 152, 0, 0.7)', border: 'rgba(255, 152, 0, 1)' },
                    { bg: 'rgba(156, 39, 176, 0.7)', border: 'rgba(156, 39, 176, 1)' },
                    { bg: 'rgba(0, 188, 212, 0.7)', border: 'rgba(0, 188, 212, 1)' }
                ];
                
                // DEBUG: T√ºm coaValue deƒüerlerini detaylƒ± logla
                console.log(`üîç ${property} i√ßin gelen CoA deƒüerleri (${propData.length} adet):`, propData.map(r => r.coaValue));
                console.log(`   üìã Detay:`, propData.map((r, idx) => ({
                    index: idx,
                    value: r.coaValue,
                    type: typeof r.coaValue,
                    deliveryNo: r.deliveryNo,
                    date: r.date
                })));
                
                propData.forEach((r, rIndex) => {
                    console.log(`   [${rIndex}] ƒ∞≈üleniyor: ${r.coaValue}`);
                    // COA deƒüerini temizle ve parse et
                    let cleanValue = String(r.coaValue || '').trim();
                    
                    // ISO tarih formatlarƒ±nƒ± filtrele (2026-05-04T21:00:00.000Z gibi)
                    if (/^\d{4}-\d{2}-\d{2}T/.test(cleanValue) || /^\d{4}-\d{2}-\d{2}/.test(cleanValue)) {
                        console.warn('‚ö†Ô∏è ISO tarih deƒüeri tespit edildi, atlanƒ±yor:', cleanValue, 'Property:', property);
                        values.push(null);
                        backgroundColors.push(colors[propIndex % colors.length].bg);
                        borderColors.push(colors[propIndex % colors.length].border);
                        pointBackgroundColors.push(colors[propIndex % colors.length].border);
                        pointBorderColors.push(colors[propIndex % colors.length].border);
                        return;
                    }
                    
                    // Tarih formatlarƒ±nƒ± filtrele (DD.MM.YYYY, DD/MM/YYYY gibi)
                    if (/^\d{1,2}[\.\/]\d{1,2}[\.\/]\d{4}$/.test(cleanValue)) {
                        console.warn('‚ö†Ô∏è Tarih deƒüeri tespit edildi (DD.MM.YYYY), atlanƒ±yor:', cleanValue, 'Property:', property);
                        values.push(null);
                        backgroundColors.push(colors[propIndex % colors.length].bg);
                        borderColors.push(colors[propIndex % colors.length].border);
                        pointBackgroundColors.push(colors[propIndex % colors.length].border);
                        pointBorderColors.push(colors[propIndex % colors.length].border);
                        return;
                    }
                    
                    // Virg√ºl√º noktaya √ßevir (T√ºrk√ße ondalƒ±k) - T√úM virg√ºlleri deƒüi≈ütir
                    cleanValue = cleanValue.replace(/,/g, '.');
                    
                    // Yƒ±l gibi b√ºy√ºk sayƒ±larƒ± filtrele (>999)
                    const tempVal = parseFloat(cleanValue);
                    if (!isNaN(tempVal) && Math.abs(tempVal) > 999) {
                        console.warn('‚ö†Ô∏è Yƒ±l/tarih deƒüeri tespit edildi (>999), atlanƒ±yor:', cleanValue, 'Property:', property);
                        values.push(null);
                        backgroundColors.push(colors[propIndex % colors.length].bg);
                        borderColors.push(colors[propIndex % colors.length].border);
                        pointBackgroundColors.push(colors[propIndex % colors.length].border);
                        pointBorderColors.push(colors[propIndex % colors.length].border);
                        return;
                    }
                    
                    // ƒ∞kili deƒüer kontrol√º (√∂rn: "5.5-6.5" veya "29.8-30.3")
                    // Not: Virg√ºller zaten noktaya √ßevrildi
                    let val, minVal, maxVal;
                    const rangeMatch = cleanValue.match(/^(\d+\.?\d*)\s*-\s*(\d+\.?\d*)$/);
                    
                    if (rangeMatch) {
                        // ƒ∞kili deƒüer tespit edildi
                        const val1 = parseFloat(rangeMatch[1]);
                        const val2 = parseFloat(rangeMatch[2]);
                        
                        if (!isNaN(val1) && !isNaN(val2) && isFinite(val1) && isFinite(val2)) {
                            // ƒ∞kili deƒüer: min ve max'ƒ± sakla, grafiƒüe ortalama ekle
                            minVal = Math.min(val1, val2);
                            maxVal = Math.max(val1, val2);
                            val = (minVal + maxVal) / 2; // Ortalama grafiƒüe gidiyor
                            
                            // Min ve max deƒüerlerini kayƒ±t nesnesine ekle
                            r._parsedMinValue = minVal;
                            r._parsedMaxValue = maxVal;
                            r._isRangeValue = true;
                            
                            console.log(`üìä ƒ∞kili deƒüer tespit edildi: "${r.coaValue}" -> Min: ${minVal}, Max: ${maxVal}, Ortalama (grafiƒüe): ${val}`);
                        } else {
                            // Parse edilemedi
                            console.warn('‚ö†Ô∏è ƒ∞kili deƒüer parse edilemedi:', cleanValue);
                            values.push(null);
                            backgroundColors.push(colors[propIndex % colors.length].bg);
                            borderColors.push(colors[propIndex % colors.length].border);
                            pointBackgroundColors.push(colors[propIndex % colors.length].border);
                            pointBorderColors.push(colors[propIndex % colors.length].border);
                            return;
                        }
                    } else {
                        // Tekli deƒüer
                        val = parseFloat(cleanValue);
                        if (isNaN(val) || !isFinite(val)) {
                            values.push(null);
                            backgroundColors.push(colors[propIndex % colors.length].bg);
                            borderColors.push(colors[propIndex % colors.length].border);
                            pointBackgroundColors.push(colors[propIndex % colors.length].border);
                            pointBorderColors.push(colors[propIndex % colors.length].border);
                            return;
                        }
                        r._isRangeValue = false;
                    }
                    
                    values.push(val);
                    allValues.push(val);
                    
                    // Tolerans kontrol√º
                    const operator = r.operator || 'range';
                    const stdValue = parseFloat(r.standardValue);
                    const minLimit = parseFloat(r.minLimit);
                    const maxLimit = parseFloat(r.maxLimit);
                    let isCompliant = false;
                    
                    if (operator === 'range') {
                        isCompliant = val >= minLimit && val <= maxLimit;
                    } else if (operator === '>') {
                        isCompliant = val > stdValue;
                    } else if (operator === '<') {
                        isCompliant = val < stdValue;
                    } else if (operator === '>=') {
                        isCompliant = val >= stdValue;
                    } else if (operator === '<=') {
                        isCompliant = val <= stdValue;
                    } else if (operator === '=') {
                        isCompliant = Math.abs(val - stdValue) < 0.01;
                    }
                    
                    // Uygunluƒüa g√∂re renk
                    if (isCompliant) {
                        backgroundColors.push(colors[propIndex % colors.length].bg);
                        borderColors.push(colors[propIndex % colors.length].border);
                        pointBackgroundColors.push(colors[propIndex % colors.length].border);
                        pointBorderColors.push(colors[propIndex % colors.length].border);
                    } else {
                        backgroundColors.push('rgba(244, 67, 54, 0.7)');
                        borderColors.push('rgba(244, 67, 54, 1)');
                        pointBackgroundColors.push('rgba(244, 67, 54, 1)');
                        pointBorderColors.push('rgba(244, 67, 54, 1)');
                    }
                });
                
                // Operat√∂r kontrol√º - range ise line, diƒüerleri bar
                const firstOperator = propData[0]?.operator || 'range';
                const chartType = firstOperator === 'range' ? 'line' : 'bar';
                
                // Datasets - Mixed chart i√ßin her dataset'in type'ƒ± belirtilmeli
                const datasets = [{
                    type: chartType,
                    label: property,
                    data: values,
                    backgroundColor: chartType === 'line' ? colors[propIndex % colors.length].bg : backgroundColors,
                    borderColor: chartType === 'line' ? colors[propIndex % colors.length].border : borderColors,
                    borderWidth: 2,
                    tension: 0.1,
                    pointBackgroundColor: chartType === 'line' ? pointBackgroundColors : undefined,
                    pointBorderColor: chartType === 'line' ? pointBorderColors : undefined,
                    pointRadius: chartType === 'line' ? 6 : undefined,
                    pointHoverRadius: chartType === 'line' ? 8 : undefined
                }];
                
                // Limit √ßizgilerini operat√∂re g√∂re ekle
                if (chartType === 'line') {
                    // Range operat√∂r - hem alt hem √ºst limit ekle
                    const minValues = propData.map(r => {
                        const val = parseFloat(r.minLimit);
                        return isNaN(val) ? null : val;
                    });
                    
                    const maxValues = propData.map(r => {
                        const val = parseFloat(r.maxLimit);
                        return isNaN(val) ? null : val;
                    });
                    
                    datasets.push({
                        label: 'Alt Limit',
                        data: minValues,
                        borderColor: 'rgba(255, 152, 0, 0.8)',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0,
                        type: 'line'
                    });
                    
                    datasets.push({
                        label: '√úst Limit',
                        data: maxValues,
                        borderColor: 'rgba(244, 67, 54, 0.8)',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0,
                        type: 'line'
                    });
                } else {
                    // Bar chart - operat√∂re g√∂re ilgili limit √ßizgisi ekle
                    const firstRecord = propData[0];
                    const operator = firstRecord?.operator;
                    
                    if (operator === '<' || operator === '<=') {
                        // √úst limit var
                        const limitValues = propData.map(r => {
                            const val = parseFloat(r.standardValue);
                            return isNaN(val) ? null : val;
                        });
                        
                        datasets.push({
                            label: '√úst Limit',
                            data: limitValues,
                            borderColor: 'rgba(244, 67, 54, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            type: 'line'
                        });
                    } else if (operator === '>' || operator === '>=') {
                        // Alt limit var
                        const limitValues = propData.map(r => {
                            const val = parseFloat(r.standardValue);
                            return isNaN(val) ? null : val;
                        });
                        
                        datasets.push({
                            label: 'Alt Limit',
                            data: limitValues,
                            borderColor: 'rgba(255, 152, 0, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            type: 'line'
                        });
                    } else if (operator === '=') {
                        // Hedef deƒüer
                        const targetValues = propData.map(r => {
                            const val = parseFloat(r.standardValue);
                            return isNaN(val) ? null : val;
                        });
                        
                        datasets.push({
                            label: 'Hedef',
                            data: targetValues,
                            borderColor: 'rgba(76, 175, 80, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            type: 'line'
                        });
                    }
                }
                
                // Y ekseni i√ßin min/max hesapla (t√ºm dataset'lerden)
                const allYValues = [];
                datasets.forEach(ds => {
                    if (ds.data) {
                        ds.data.forEach(v => {
                            if (v !== null && !isNaN(v) && isFinite(v)) {
                                allYValues.push(v);
                            }
                        });
                    }
                });
                
                let yMin = 0;
                let yMax = 100;
                if (allYValues.length > 0) {
                    const dataMin = Math.min(...allYValues);
                    const dataMax = Math.max(...allYValues);
                    const range = dataMax - dataMin;
                    
                    // Eƒüer veri aralƒ±ƒüƒ± √ßok k√º√ß√ºkse (√∂rn: 200-210), padding ekle
                    if (range < (dataMax * 0.2)) {  // %20'den k√º√ß√ºk aralƒ±k
                        yMin = dataMin - (range * 0.3);
                        yMax = dataMax + (range * 0.3);
                    } else {
                        yMin = dataMin - (range * 0.1);
                        yMax = dataMax + (range * 0.1);
                    }
                    
                    // Negatif deƒüere inmemesi i√ßin kontrol
                    if (yMin < 0 && dataMin >= 0) {
                        yMin = 0;
                    }
                }
                
                // Grafik olu≈ütur 
                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: chartType === 'line' ? 'line' : 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${supplier} - ${material} - ${property}`,
                                font: { size: 18, weight: 'bold' },
                                padding: { top: 10, bottom: 15 }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: { size: 13 },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: yMin,
                                max: yMax,
                                title: {
                                    display: true,
                                    text: propData[0]?.unit || '',
                                    font: { size: 13, weight: 'bold' }
                                },
                                ticks: {
                                    font: { size: 12 }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 13, weight: '500' }
                                }
                            }
                        }
                    }
                });
                
                analysisCharts.push(chart);
                
                // Bu grafik i√ßin istatistikleri hesapla ve g√∂ster
                const validValues = values.filter(v => v !== null && !isNaN(v) && isFinite(v));
                
                // ƒ∞kili deƒüerleri g√∂z √∂n√ºnde bulundur - zaten parse edilmi≈ü deƒüerleri kullan
                let actualMinValues = [];
                let actualMaxValues = [];
                
                propData.forEach((r, index) => {
                    // Grafikte null olan deƒüerleri atla
                    if (values[index] === null || isNaN(values[index])) {
                        return;
                    }
                    
                    if (r._isRangeValue) {
                        // ƒ∞kili deƒüer - parse edilmi≈ü min ve max'ƒ± kullan
                        if (r._parsedMinValue !== undefined) actualMinValues.push(r._parsedMinValue);
                        if (r._parsedMaxValue !== undefined) actualMaxValues.push(r._parsedMaxValue);
                    } else {
                        // Tekli deƒüer - grafik i√ßin zaten parse edilmi≈ü deƒüeri kullan
                        const val = values[index];
                        if (val !== null && !isNaN(val) && isFinite(val)) {
                            actualMinValues.push(val);
                            actualMaxValues.push(val);
                        }
                    }
                });
                
                // standardValue ve limitleri sayƒ±sal olarak parse et
                const parseValue = (val) => {
                    if (val === null || val === undefined || val === '') return '-';
                    const parsed = parseFloat(String(val).replace(/,/g, '.'));
                    return isNaN(parsed) ? '-' : parsed;
                };
                
                const propStats = {
                    count: validValues.length,
                    min: actualMinValues.length > 0 ? Math.min(...actualMinValues) : 0,
                    max: actualMaxValues.length > 0 ? Math.max(...actualMaxValues) : 0,
                    avg: validValues.length > 0 ? validValues.reduce((a, b) => a + b, 0) / validValues.length : 0,
                    target: parseValue(propData[0]?.standardValue),
                    minLimit: parseValue(propData[0]?.minLimit),
                    maxLimit: parseValue(propData[0]?.maxLimit),
                    operator: propData[0]?.operator || 'range'
                };
                
                // Tolerans dƒ±≈üƒ± sayƒ±sƒ±
                let outOfSpec = 0;
                propData.forEach((r, index) => {
                    // Zaten grafik i√ßin parse edilmi≈ü deƒüeri kullan
                    const val = values[index];
                    
                    // Grafikte null veya ge√ßersiz deƒüerleri atla
                    if (val === null || isNaN(val) || !isFinite(val)) return;
                    
                    const operator = r.operator || 'range';
                    const stdValue = parseFloat(r.standardValue);
                    const minLimit = parseFloat(r.minLimit);
                    const maxLimit = parseFloat(r.maxLimit);
                    let isCompliant = false;
                    
                    if (operator === 'range') {
                        isCompliant = val >= minLimit && val <= maxLimit;
                    } else if (operator === '>') {
                        isCompliant = val > stdValue;
                    } else if (operator === '<') {
                        isCompliant = val < stdValue;
                    } else if (operator === '>=') {
                        isCompliant = val >= stdValue;
                    } else if (operator === '<=') {
                        isCompliant = val <= stdValue;
                    } else if (operator === '=') {
                        isCompliant = Math.abs(val - stdValue) < 0.01;
                    }
                    
                    if (!isCompliant) outOfSpec++;
                });
                
                propStats.outOfSpec = outOfSpec;
                
                // ƒ∞statistikleri statsDiv'e ekle
                const statsContainer = document.getElementById(`stats_${propIndex}`);
                const formatValue = (val) => {
                    return typeof val === 'number' && !isNaN(val) ? val.toFixed(2) : val;
                };
                
                statsContainer.innerHTML = `
                    <div style="text-align: center; font-weight: bold; color: #2d5a3d; border-bottom: 2px solid #2d5a3d; padding-bottom: 8px; margin-bottom: 8px;">
                        üìä ƒ∞statistikler
                    </div>
                    ${propStats.operator === 'range' ? `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üéØ Hedef:</span>
                        <span style="font-weight: 600;">${formatValue(propStats.target)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üìâ Alt Limit:</span>
                        <span style="font-weight: 600; color: #ff9800;">${formatValue(propStats.minLimit)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üìà √úst Limit:</span>
                        <span style="font-weight: 600; color: #f44336;">${formatValue(propStats.maxLimit)}</span>
                    </div>
                    ` : `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üéØ ${propStats.operator === '>' || propStats.operator === '>=' ? 'Min' : propStats.operator === '<' || propStats.operator === '<=' ? 'Max' : 'Hedef'}:</span>
                        <span style="font-weight: 600;">${formatValue(propStats.target)}</span>
                    </div>
                    `}
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">‚¨áÔ∏è Min Deƒüer:</span>
                        <span style="font-weight: 600; color: #2196f3;">${propStats.min.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">‚¨ÜÔ∏è Max Deƒüer:</span>
                        <span style="font-weight: 600; color: #9c27b0;">${propStats.max.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üìä Ortalama:</span>
                        <span style="font-weight: 600; color: #4caf50;">${propStats.avg.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6;">
                        <span style="color: #666; font-size: 0.9em;">üî¢ Kayƒ±t Sayƒ±sƒ±:</span>
                        <span style="font-weight: 600;">${propStats.count}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; background: ${propStats.outOfSpec > 0 ? '#ffebee' : '#e8f5e9'}; margin: 8px -8px -8px -8px; padding: 10px 8px; border-radius: 0 0 8px 8px;">
                        <span style="color: #666; font-size: 0.9em; font-weight: 600;">‚ùå Hedef Dƒ±≈üƒ±:</span>
                        <span style="font-weight: 700; font-size: 1.1em; color: ${propStats.outOfSpec > 0 ? '#d32f2f' : '#2e7d32'};">${propStats.outOfSpec}</span>
                    </div>
                `;
            });
            
            // PDF butonu g√∂ster
            document.getElementById('exportAnalysisPdfBtn').style.display = 'block';
            
            showToast(`‚úÖ ${selectedProperties.length} √∂zellik i√ßin grafik olu≈üturuldu`, 'success');
        }
        
        // COA Analiz PDF Dƒ±≈üa Aktarma
        async function exportAnalysisToPDF() {
            const { jsPDF } = window.jspdf;
            
            showToast('üìÑ PDF olu≈üturuluyor...', 'info');
            
            const supplier = document.getElementById('analysisSupplierSelect').value;
            const material = document.getElementById('analysisMaterialSelect').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;
            const location = document.getElementById('analysisLocationSelect').value;
            
            const selectedProperties = Array.from(
                document.querySelectorAll('#analysisPropertyContainer input[type="checkbox"]:checked')
            ).map(cb => cb.value);
            
            // T√ºrk√ße karakter d√∂n√º≈üt√ºrme fonksiyonu
            function toAscii(text) {
                if (!text) return '';
                return text
                    .replace(/≈ü/g, 's').replace(/≈û/g, 'S')
                    .replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'I')
                    .replace(/√∂/g, 'o').replace(/√ñ/g, 'O')
                    .replace(/√º/g, 'u').replace(/√ú/g, 'U')
                    .replace(/√ß/g, 'c').replace(/√á/g, 'C')
                    .replace(/ƒü/g, 'g').replace(/ƒû/g, 'G');
            }
            
            // Birim bilgilerini al (analysisData'dan)
            function getUnitForProperty(propName) {
                const propData = analysisData.find(r => 
                    r.supplier === supplier && 
                    r.materialCode === material && 
                    r.propertyName === propName
                );
                return propData?.unit || '';
            }
            
            // PDF olu≈ütur (A4 boyut)
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let yPosition = margin;
            
            // Header - Ba≈ülƒ±k
            pdf.setFillColor(45, 90, 61);
            pdf.rect(0, 0, pageWidth, 35, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont('helvetica', 'bold');
            pdf.text('COA Analiz Raporu', pageWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Olusturulma Tarihi: ' + new Date().toLocaleDateString('tr-TR') + ' ' + new Date().toLocaleTimeString('tr-TR'), pageWidth / 2, 25, { align: 'center' });
            
            yPosition = 45;
            
            // Hammadde Bilgileri Kutusu
            pdf.setFillColor(248, 249, 250);
            pdf.roundedRect(margin, yPosition, contentWidth, 45, 3, 3, 'F');
            pdf.setDrawColor(45, 90, 61);
            pdf.setLineWidth(0.5);
            pdf.roundedRect(margin, yPosition, contentWidth, 45, 3, 3, 'S');
            
            pdf.setTextColor(45, 90, 61);
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Hammadde Bilgileri', margin + 5, yPosition + 8);
            
            pdf.setTextColor(51, 51, 51);
            pdf.setFontSize(9);
            
            const infoStartY = yPosition + 16;
            const labelWidth = 35;
            const col1X = margin + 5;
            const col2X = margin + contentWidth / 2 + 10;
            
            // Satƒ±r 1
            pdf.setFont('helvetica', 'bold');
            pdf.text('Tedarikci:', col1X, infoStartY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(toAscii(supplier) || '-', col1X + labelWidth, infoStartY);
            
            pdf.setFont('helvetica', 'bold');
            pdf.text('Hammadde Kodu:', col2X, infoStartY);
            pdf.setFont('helvetica', 'normal');
            pdf.text(material || '-', col2X + 35, infoStartY);
            
            // Satƒ±r 2
            pdf.setFont('helvetica', 'bold');
            pdf.text('Lokasyon:', col1X, infoStartY + 8);
            pdf.setFont('helvetica', 'normal');
            pdf.text(toAscii(location) || 'Tumu', col1X + labelWidth, infoStartY + 8);
            
            pdf.setFont('helvetica', 'bold');
            pdf.text('Tarih Araligi:', col2X, infoStartY + 8);
            pdf.setFont('helvetica', 'normal');
            const startDateText = startDate ? new Date(startDate).toLocaleDateString('tr-TR') : 'Baslangic';
            const endDateText = endDate ? new Date(endDate).toLocaleDateString('tr-TR') : 'Bitis';
            pdf.text(startDateText + ' - ' + endDateText, col2X + 35, infoStartY + 8);
            
            // Satƒ±r 3 - Se√ßili √ñzellikler
            pdf.setFont('helvetica', 'bold');
            pdf.text('Secili Ozellikler:', col1X, infoStartY + 16);
            pdf.setFont('helvetica', 'normal');
            const propsText = toAscii(selectedProperties.join(', '));
            const maxPropsWidth = contentWidth - 45;
            const propsLines = pdf.splitTextToSize(propsText, maxPropsWidth);
            pdf.text(propsLines[0] || '-', col1X + labelWidth, infoStartY + 16);
            if (propsLines[1]) {
                pdf.text(propsLines[1], col1X + labelWidth, infoStartY + 21);
            }
            
            yPosition = yPosition + 55;
            
            // Her grafik i√ßin
            const chartWrappers = document.querySelectorAll('#analysisChartsContainer > div');
            
            for (let i = 0; i < chartWrappers.length; i++) {
                const wrapper = chartWrappers[i];
                const canvas = wrapper.querySelector('canvas');
                const statsDiv = wrapper.querySelector('[id^="stats_"]');
                
                if (!canvas) continue;
                
                // Yeni sayfa gerekli mi kontrol et
                const itemHeight = 90;
                if (yPosition + itemHeight > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                }
                
                // √ñzellik ba≈ülƒ±ƒüƒ± ve birim
                const propName = selectedProperties[i] || 'Ozellik ' + (i + 1);
                const unit = getUnitForProperty(propName);
                const headerText = toAscii(propName) + (unit ? ' (' + toAscii(unit) + ')' : '');
                
                pdf.setFillColor(45, 90, 61);
                pdf.roundedRect(margin, yPosition, contentWidth, 10, 2, 2, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text(headerText, margin + 5, yPosition + 7);
                yPosition += 14;
                
                // Grafik ve istatistik yan yana
                const chartWidth = contentWidth * 0.65;
                const statsWidth = contentWidth * 0.32;
                const rowHeight = 68;
                
                // Grafik
                try {
                    const chartImage = canvas.toDataURL('image/png', 1.0);
                    pdf.addImage(chartImage, 'PNG', margin, yPosition, chartWidth, rowHeight);
                } catch (e) {
                    console.error('Grafik resmi alinamadi:', e);
                    pdf.setTextColor(150, 150, 150);
                    pdf.setFontSize(10);
                    pdf.text('Grafik yuklenemedi', margin + chartWidth / 2, yPosition + rowHeight / 2, { align: 'center' });
                }
                
                // ƒ∞statistikler kutusu
                const statsX = margin + chartWidth + 5;
                pdf.setFillColor(248, 249, 250);
                pdf.roundedRect(statsX, yPosition, statsWidth, rowHeight, 2, 2, 'F');
                pdf.setDrawColor(200, 200, 200);
                pdf.roundedRect(statsX, yPosition, statsWidth, rowHeight, 2, 2, 'S');
                
                // ƒ∞statistik ba≈ülƒ±ƒüƒ±
                pdf.setFillColor(45, 90, 61);
                pdf.roundedRect(statsX, yPosition, statsWidth, 8, 2, 2, 'F');
                pdf.rect(statsX, yPosition + 4, statsWidth, 4, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Istatistikler', statsX + statsWidth / 2, yPosition + 5.5, { align: 'center' });
                
                // ƒ∞statistik verilerini al
                if (statsDiv) {
                    const statLines = statsDiv.querySelectorAll('div[style*="display: flex"]');
                    let statY = yPosition + 14;
                    pdf.setFontSize(8);
                    
                    statLines.forEach((line, idx) => {
                        if (statY > yPosition + rowHeight - 5) return;
                        
                        let label = line.querySelector('span:first-child')?.textContent || '';
                        // Emoji ve √∂zel karakterleri temizle
                        label = label.replace(/[^\w\s:√∂√º√ßƒüƒ±≈ü√ñ√ú√áƒûƒ∞≈ûa-zA-Z0-9]/g, '').trim();
                        label = toAscii(label);
                        
                        const value = line.querySelector('span:last-child')?.textContent || '';
                        
                        pdf.setTextColor(80, 80, 80);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(label, statsX + 3, statY);
                        
                        // Hedef dƒ±≈üƒ± i√ßin √∂zel renk
                        if (label.toLowerCase().includes('hedef') && label.toLowerCase().includes('dis')) {
                            const numVal = parseFloat(value);
                            if (numVal > 0) {
                                pdf.setTextColor(211, 47, 47);
                            } else {
                                pdf.setTextColor(46, 125, 50);
                            }
                        } else {
                            pdf.setTextColor(51, 51, 51);
                        }
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(value, statsX + statsWidth - 5, statY, { align: 'right' });
                        
                        statY += 7;
                    });
                }
                
                yPosition += rowHeight + 8;
            }
            
            // Footer her sayfaya
            const totalPages = pdf.internal.getNumberOfPages();
            for (let p = 1; p <= totalPages; p++) {
                pdf.setPage(p);
                pdf.setFillColor(45, 90, 61);
                pdf.rect(0, pageHeight - 10, pageWidth, 10, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.text('Sayfa ' + p + ' / ' + totalPages, pageWidth / 2, pageHeight - 4, { align: 'center' });
                pdf.text('COA Analiz Sistemi', margin, pageHeight - 4);
            }
            
            // PDF kaydet
            const fileName = 'COA_Analiz_' + toAscii(supplier) + '_' + material + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            pdf.save(fileName);
            
            showToast('‚úÖ PDF ba≈üarƒ±yla olu≈üturuldu', 'success');
        }
        
        // ==============================================
        // TEMPLATE EDITOR FUNCTIONS
        // ==============================================
        

        
        async function loadTemplatePDF(file) {
            // √ñnceki render i≈ülemini iptal et
            if (currentRenderTask) {
                try {
                    await currentRenderTask.cancel();
                    console.log('‚ö†Ô∏è √ñnceki PDF render i≈ülemi iptal edildi');
                } catch (e) {
                    // Zaten tamamlanmƒ±≈ü olabilir
                }
                currentRenderTask = null;
            }
            
            try {
                // PDF.js worker kontrol√º
                if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    console.log('üîß PDF.js worker ayarlandƒ± (loadTemplatePDF)');
                }
                
                console.log('üìÑ PDF dosyasƒ± okunuyor...');
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const page = await pdf.getPage(1);
                console.log('‚úÖ PDF sayfa 1 alƒ±ndƒ±');
                
                const viewport = page.getViewport({ scale: 2.0 });
                
                // Canvas'ƒ± temizle ve yeniden boyutlandƒ±r
                templateCanvas.width = viewport.width;
                templateCanvas.height = viewport.height;
                templateCtx.clearRect(0, 0, templateCanvas.width, templateCanvas.height);
                console.log('üé® Canvas hazƒ±rlandƒ±:', viewport.width, 'x', viewport.height);
                
                const renderContext = {
                    canvasContext: templateCtx,
                    viewport: viewport
                };
                
                // Render task'ƒ± kaydet
                console.log('üîÑ PDF render ba≈ülatƒ±lƒ±yor...');
                currentRenderTask = page.render(renderContext);
                
                await currentRenderTask.promise;
                console.log('‚úÖ PDF render tamamlandƒ±');
                
                templateImageObj = new Image();
                templateImageObj.onload = function() {
                    console.log('‚úÖ Template image y√ºklendi');
                    // Canvas'ƒ± yeniden √ßiz (b√∂lgeler varsa g√∂ster)
                    redrawTemplateCanvas();
                    console.log('üñ±Ô∏è HAZIR: ≈ûimdi canvas √ºzerinde mouse ile s√ºr√ºkleyerek b√∂lgeler √ßizebilirsiniz!');
                    console.log('   üìç Yeni b√∂lge √ßizmek i√ßin: Bo≈ü bir alandan ba≈ülayƒ±p s√ºr√ºkleyin');
                    console.log('   ‚úèÔ∏è B√∂lge d√ºzenlemek i√ßin: Mevcut b√∂lgenin √ºzerine tƒ±klayƒ±n');
                    console.log('   üîß B√∂lge boyutlandƒ±rmak i√ßin: K√∂≈üe veya kenar handle\'larƒ±nƒ± s√ºr√ºkleyin');
                };
                templateImageObj.src = templateCanvas.toDataURL();
                templateScaleFactor = 1;
            } catch (error) {
                if (error.name === 'RenderingCancelledException') {
                    console.log('‚ö†Ô∏è Render i≈ülemi iptal edildi');
                    return;
                }
                console.error('‚ùå PDF y√ºkleme hatasƒ±:', error);
                showToast('‚ùå PDF y√ºklenemedi', 'error');
                throw error;
            } finally {
                currentRenderTask = null;
            }
        }
        
        async function loadTemplateExcel(file) {
            try {
                console.log('üìä Excel dosyasƒ± i≈üleniyor...');
                
                // Ensure XLSX library is loaded
                await ensureLibraryLoaded(
                    'XLSX',
                    () => typeof XLSX !== 'undefined',
                    [
                        'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                        'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
                    ]
                );
                
                // Ensure html2canvas library is loaded
                await ensureLibraryLoaded(
                    'html2canvas',
                    () => typeof html2canvas !== 'undefined',
                    [
                        'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                        'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
                    ]
                );
                
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array', cellStyles: true });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Get column widths and row heights from Excel
                const colWidths = worksheet['!cols'] || [];
                const rowHeights = worksheet['!rows'] || [];
                const merges = worksheet['!merges'] || [];
                
                console.log('üìè Excel boyutlarƒ±:', {
                    cols: colWidths.length,
                    rows: rowHeights.length,
                    merges: merges.length
                });
                
                // Convert to HTML
                const htmlString = XLSX.utils.sheet_to_html(worksheet, { header: '', footer: '' });
                
                // Create temporary div to render HTML
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '0';
                tempDiv.style.background = 'white';
                tempDiv.style.padding = '0';  // No padding for exact measurements
                tempDiv.innerHTML = htmlString;
                document.body.appendChild(tempDiv);
                
                // Style the table with exact Excel dimensions
                const table = tempDiv.querySelector('table');
                if (table) {
                    table.style.borderCollapse = 'collapse';
                    table.style.fontSize = '11px';  // Excel default
                    table.style.fontFamily = 'Calibri, Arial, sans-serif';  // Excel default font
                    table.style.border = 'none';
                    table.style.margin = '0';
                    table.style.padding = '0';
                    
                    // Apply column widths
                    const rows = table.querySelectorAll('tr');
                    if (rows.length > 0) {
                        const firstRowCells = rows[0].querySelectorAll('td, th');
                        firstRowCells.forEach((cell, index) => {
                            const colInfo = colWidths[index];
                            if (colInfo && colInfo.wpx) {
                                // Use pixel width from Excel
                                cell.style.width = colInfo.wpx + 'px';
                                cell.style.minWidth = colInfo.wpx + 'px';
                                cell.style.maxWidth = colInfo.wpx + 'px';
                            } else if (colInfo && colInfo.wch) {
                                // Convert character width to pixels (approx 7px per char)
                                const pixelWidth = Math.round(colInfo.wch * 7);
                                cell.style.width = pixelWidth + 'px';
                                cell.style.minWidth = pixelWidth + 'px';
                                cell.style.maxWidth = pixelWidth + 'px';
                            } else {
                                // Default Excel column width (64 pixels)
                                cell.style.width = '64px';
                                cell.style.minWidth = '64px';
                                cell.style.maxWidth = '64px';
                            }
                        });
                    }
                    
                    // Apply row heights and cell styles
                    rows.forEach((row, rowIndex) => {
                        const rowInfo = rowHeights[rowIndex];
                        if (rowInfo && rowInfo.hpx) {
                            // Use pixel height from Excel
                            row.style.height = rowInfo.hpx + 'px';
                        } else if (rowInfo && rowInfo.hpt) {
                            // Convert points to pixels (1pt = 1.333px)
                            const pixelHeight = Math.round(rowInfo.hpt * 1.333);
                            row.style.height = pixelHeight + 'px';
                        } else {
                            // Default Excel row height (20 pixels)
                            row.style.height = '20px';
                        }
                        
                        const cells = row.querySelectorAll('td, th');
                        cells.forEach((cell, colIndex) => {
                            cell.style.border = '1px solid #d0d0d0';  // Excel default border
                            cell.style.padding = '2px 4px';  // Excel default padding
                            cell.style.textAlign = 'left';
                            cell.style.verticalAlign = 'middle';
                            cell.style.overflow = 'hidden';
                            cell.style.whiteSpace = 'nowrap';
                            cell.style.boxSizing = 'border-box';
                            
                            // Apply column width to all cells in column
                            const colInfo = colWidths[colIndex];
                            if (colInfo && colInfo.wpx) {
                                cell.style.width = colInfo.wpx + 'px';
                                cell.style.minWidth = colInfo.wpx + 'px';
                                cell.style.maxWidth = colInfo.wpx + 'px';
                            } else if (colInfo && colInfo.wch) {
                                const pixelWidth = Math.round(colInfo.wch * 7);
                                cell.style.width = pixelWidth + 'px';
                                cell.style.minWidth = pixelWidth + 'px';
                                cell.style.maxWidth = pixelWidth + 'px';
                            }
                        });
                        
                        const headers = row.querySelectorAll('th');
                        headers.forEach(th => {
                            th.style.backgroundColor = '#f0f0f0';
                            th.style.fontWeight = 'bold';
                        });
                    });
                }
                
                // Log table dimensions before rendering
                if (table) {
                    const tableRect = table.getBoundingClientRect();
                    console.log('üìä Table boyutlarƒ± (render √∂ncesi):', {
                        width: Math.round(tableRect.width),
                        height: Math.round(tableRect.height),
                        rows: table.rows.length,
                        cols: table.rows[0]?.cells.length || 0
                    });
                }
                
                // Convert to canvas using html2canvas (scale 1 for precise positioning)
                console.log('üé® Canvas render ba≈ülatƒ±lƒ±yor...');
                const canvas = await html2canvas(tempDiv, {
                    backgroundColor: '#ffffff',
                    scale: 1,  // No scaling to preserve exact Excel coordinates
                    logging: false,
                    useCORS: true
                });
                
                console.log('‚úÖ Canvas render tamamlandƒ±:', canvas.width, 'x', canvas.height);
                
                // Remove temporary div
                document.body.removeChild(tempDiv);
                
                // Use original canvas dimensions - no scaling
                const width = canvas.width;
                const height = canvas.height;
                
                templateCanvas.width = width;
                templateCanvas.height = height;
                templateCtx.clearRect(0, 0, width, height);
                templateCtx.drawImage(canvas, 0, 0);
                
                templateScaleFactor = 1;  // No scaling applied
                
                // Store as image
                templateImageObj = new Image();
                templateImageObj.onload = function() {
                    // Canvas'ƒ± yeniden √ßiz (b√∂lgeler varsa g√∂ster)
                    redrawTemplateCanvas();
                };
                templateImageObj.src = templateCanvas.toDataURL();
                
                console.log('‚úÖ Excel template hazƒ±rlandƒ±');
                console.log('  üìê Canvas boyutu:', width, 'x', height);
                console.log('  üìè S√ºtun sayƒ±sƒ±:', colWidths.length);
                console.log('  üìè Satƒ±r sayƒ±sƒ±:', rowHeights.length);
                console.log('  ‚öñÔ∏è Scale factor:', templateScaleFactor);
                showToast('‚úÖ Excel template y√ºklendi - Ger√ßek h√ºcre boyutlarƒ± korundu', 'success');
            } catch (error) {
                console.error('‚ùå Excel y√ºkleme hatasƒ±:', error);
                showToast('‚ùå Excel dosyasƒ± y√ºklenemedi: ' + error.message, 'error');
                throw error;
            }
        }
        
        async function loadTemplateWord(file) {
            try {
                console.log('üìù Word dosyasƒ± i≈üleniyor...');
                
                // Ensure mammoth library is loaded
                await ensureLibraryLoaded(
                    'mammoth',
                    () => typeof mammoth !== 'undefined',
                    [
                        'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js',
                        'https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js'
                    ]
                );
                
                // Ensure html2canvas library is loaded
                await ensureLibraryLoaded(
                    'html2canvas',
                    () => typeof html2canvas !== 'undefined',
                    [
                        'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                        'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
                    ]
                );
                
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                
                // Create temporary div to render HTML
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '0';
                tempDiv.style.background = 'white';
                tempDiv.style.padding = '40px';
                tempDiv.style.width = '800px';
                tempDiv.style.fontFamily = 'Arial, sans-serif';
                tempDiv.style.fontSize = '12px';
                tempDiv.style.lineHeight = '1.5';
                tempDiv.innerHTML = result.value;
                document.body.appendChild(tempDiv);
                
                // Style tables if any
                const tables = tempDiv.querySelectorAll('table');
                tables.forEach(table => {
                    table.style.borderCollapse = 'collapse';
                    table.style.width = '100%';
                    table.style.marginBottom = '20px';
                    const cells = table.querySelectorAll('td, th');
                    cells.forEach(cell => {
                        cell.style.border = '1px solid #ddd';
                        cell.style.padding = '8px';
                    });
                });
                
                // Convert to canvas using html2canvas (scale 1 for precise positioning)
                const canvas = await html2canvas(tempDiv, {
                    backgroundColor: '#ffffff',
                    scale: 1  // No scaling to preserve exact Word coordinates
                });
                
                // Remove temporary div
                document.body.removeChild(tempDiv);
                
                // Use original canvas dimensions - no scaling
                const width = canvas.width;
                const height = canvas.height;
                
                templateCanvas.width = width;
                templateCanvas.height = height;
                templateCtx.clearRect(0, 0, width, height);
                templateCtx.drawImage(canvas, 0, 0);
                
                templateScaleFactor = 1;  // No scaling applied
                
                // Store as image
                templateImageObj = new Image();
                templateImageObj.onload = function() {
                    // Canvas'ƒ± yeniden √ßiz (b√∂lgeler varsa g√∂ster)
                    redrawTemplateCanvas();
                };
                templateImageObj.src = templateCanvas.toDataURL();
                
                console.log('‚úÖ Word template hazƒ±rlandƒ± (√ñl√ßekleme yok, orijinal boyut:', width, 'x', height, ')');
                showToast('‚úÖ Word dosyasƒ± template olarak y√ºklendi (Orijinal boyut)', 'success');
            } catch (error) {
                console.error('‚ùå Word y√ºkleme hatasƒ±:', error);
                showToast('‚ùå Word dosyasƒ± y√ºklenemedi: ' + error.message, 'error');
                throw error;
            }
        }
        
        function loadTemplateImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    templateImageObj = new Image();
                    templateImageObj.onload = function() {
                        // Eƒüer kaydedilmi≈ü template config varsa, onu kullan
                        if (window.savedTemplateConfig) {
                            console.log('üîÑ Kaydedilmi≈ü template boyutlarƒ± kullanƒ±lƒ±yor:', window.savedTemplateConfig);
                            templateCanvas.width = window.savedTemplateConfig.canvasWidth;
                            templateCanvas.height = window.savedTemplateConfig.canvasHeight;
                            templateScaleFactor = window.savedTemplateConfig.scaleFactor;
                            
                            // Config kullanƒ±ldƒ±, temizle
                            window.savedTemplateConfig = null;
                        } else {
                            // Yeni template - normal scale hesaplama
                            const maxWidth = 1400;
                            const maxHeight = 1000;
                            
                            let width = templateImageObj.width;
                            let height = templateImageObj.height;
                            templateScaleFactor = 1;
                            
                            if (width > maxWidth) {
                                templateScaleFactor = maxWidth / width;
                                width = maxWidth;
                                height = height * templateScaleFactor;
                            }
                            
                            if (height > maxHeight) {
                                templateScaleFactor = maxHeight / height;
                                height = maxHeight;
                                width = width * templateScaleFactor;
                            }
                            
                            templateCanvas.width = width;
                            templateCanvas.height = height;
                        }
                        
                        templateCtx.drawImage(templateImageObj, 0, 0, templateCanvas.width, templateCanvas.height);
                        
                        // Canvas'ƒ± yeniden √ßiz (b√∂lgeler varsa g√∂ster)
                        redrawTemplateCanvas();
                        resolve();
                    };
                    templateImageObj.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Mouse'un hangi b√∂lgenin i√ßinde olduƒüunu bul
        function getRegionAtPoint(x, y) {
            for (let i = templateRegions.length - 1; i >= 0; i--) {
                const r = templateRegions[i];
                if (x >= r.x && x <= r.x + r.width && y >= r.y && y <= r.y + r.height) {
                    return i;
                }
            }
            return -1;
        }
        
        // Mouse'un hangi resize handle'ƒ±nda olduƒüunu bul
        function getResizeHandle(x, y, region) {
            const handleSize = 8;
            const handles = [
                { name: 'tl', x: region.x, y: region.y },
                { name: 'tr', x: region.x + region.width, y: region.y },
                { name: 'bl', x: region.x, y: region.y + region.height },
                { name: 'br', x: region.x + region.width, y: region.y + region.height },
                { name: 'top', x: region.x + region.width / 2, y: region.y },
                { name: 'right', x: region.x + region.width, y: region.y + region.height / 2 },
                { name: 'bottom', x: region.x + region.width / 2, y: region.y + region.height },
                { name: 'left', x: region.x, y: region.y + region.height / 2 }
            ];
            
            for (const handle of handles) {
                if (Math.abs(x - handle.x) <= handleSize && Math.abs(y - handle.y) <= handleSize) {
                    return handle.name;
                }
            }
            return null;
        }
        
        function startTemplateDrawing(e) {
            console.log('üñ±Ô∏è startTemplateDrawing √ßaƒürƒ±ldƒ±');
            const rect = templateCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            console.log('üìç Mouse pozisyonu:', mouseX, mouseY);
            
            // √ñnce se√ßili b√∂lgenin resize handle'ƒ±na bakƒ±yoruz
            if (selectedTemplateRegionIndex !== null) {
                const region = templateRegions[selectedTemplateRegionIndex];
                const handle = getResizeHandle(mouseX, mouseY, region);
                
                if (handle) {
                    isResizingRegion = true;
                    resizeHandle = handle;
                    templateStartX = mouseX;
                    templateStartY = mouseY;
                    return;
                }
            }
            
            // Sonra herhangi bir b√∂lgenin i√ßine tƒ±klanmƒ±≈ü mƒ± bakƒ±yoruz
            const regionIndex = getRegionAtPoint(mouseX, mouseY);
            if (regionIndex !== -1) {
                selectedTemplateRegionIndex = regionIndex;
                isDraggingRegion = true;
                const region = templateRegions[regionIndex];
                dragOffsetX = mouseX - region.x;
                dragOffsetY = mouseY - region.y;
                redrawTemplateCanvas();
                return;
            }
            
            // Hi√ßbir b√∂lgeye tƒ±klanmadƒ±ysa, yeni b√∂lge √ßizimi ba≈ülat
            selectedTemplateRegionIndex = null;
            isTemplateDrawing = true;
            templateStartX = mouseX;
            templateStartY = mouseY;
        }
        
        function drawTemplate(e) {
            const rect = templateCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            // Cursor deƒüi≈ütir (eƒüer se√ßili b√∂lge varsa)
            if (!isTemplateDrawing && !isDraggingRegion && !isResizingRegion && selectedTemplateRegionIndex !== null) {
                const region = templateRegions[selectedTemplateRegionIndex];
                const handle = getResizeHandle(currentX, currentY, region);
                
                if (handle) {
                    // Resize cursor'larƒ±
                    const cursorMap = {
                        'tl': 'nw-resize', 'tr': 'ne-resize', 'bl': 'sw-resize', 'br': 'se-resize',
                        'top': 'n-resize', 'right': 'e-resize', 'bottom': 's-resize', 'left': 'w-resize'
                    };
                    templateCanvas.style.cursor = cursorMap[handle];
                } else if (getRegionAtPoint(currentX, currentY) === selectedTemplateRegionIndex) {
                    templateCanvas.style.cursor = 'move';
                } else {
                    templateCanvas.style.cursor = 'default';
                }
            } else if (!isTemplateDrawing && !isDraggingRegion && !isResizingRegion) {
                // Hi√ß se√ßili b√∂lge yok, sadece hover kontrol√º
                const hoverIndex = getRegionAtPoint(currentX, currentY);
                templateCanvas.style.cursor = hoverIndex !== -1 ? 'pointer' : 'crosshair';
            }
            
            // B√∂lge ta≈üƒ±ma
            if (isDraggingRegion && selectedTemplateRegionIndex !== null) {
                const region = templateRegions[selectedTemplateRegionIndex];
                region.x = currentX - dragOffsetX;
                region.y = currentY - dragOffsetY;
                redrawTemplateCanvas();
                return;
            }
            
            // B√∂lge resize
            if (isResizingRegion && selectedTemplateRegionIndex !== null) {
                const region = templateRegions[selectedTemplateRegionIndex];
                const deltaX = currentX - templateStartX;
                const deltaY = currentY - templateStartY;
                
                const originalX = region.x;
                const originalY = region.y;
                const originalWidth = region.width;
                const originalHeight = region.height;
                
                if (resizeHandle === 'tl') {
                    region.x = originalX + deltaX;
                    region.y = originalY + deltaY;
                    region.width = originalWidth - deltaX;
                    region.height = originalHeight - deltaY;
                } else if (resizeHandle === 'tr') {
                    region.y = originalY + deltaY;
                    region.width = originalWidth + deltaX;
                    region.height = originalHeight - deltaY;
                } else if (resizeHandle === 'bl') {
                    region.x = originalX + deltaX;
                    region.width = originalWidth - deltaX;
                    region.height = originalHeight + deltaY;
                } else if (resizeHandle === 'br') {
                    region.width = originalWidth + deltaX;
                    region.height = originalHeight + deltaY;
                } else if (resizeHandle === 'top') {
                    region.y = originalY + deltaY;
                    region.height = originalHeight - deltaY;
                } else if (resizeHandle === 'right') {
                    region.width = originalWidth + deltaX;
                } else if (resizeHandle === 'bottom') {
                    region.height = originalHeight + deltaY;
                } else if (resizeHandle === 'left') {
                    region.x = originalX + deltaX;
                    region.width = originalWidth - deltaX;
                }
                
                // Ba≈ülangƒ±√ß noktasƒ±nƒ± g√ºncelle (smooth resize i√ßin)
                templateStartX = currentX;
                templateStartY = currentY;
                
                redrawTemplateCanvas();
                return;
            }
            
            // Yeni b√∂lge √ßizimi
            if (!isTemplateDrawing) return;
            
            // Debug: ƒ∞lk √ßizim olup olmadƒ±ƒüƒ±nƒ± kontrol et
            if (!window._drawTemplateLogShown) {
                console.log('üñåÔ∏è drawTemplate √ßalƒ±≈üƒ±yor - Mouse hareket ediyor, b√∂lge √ßiziliyor...');
                window._drawTemplateLogShown = true;
                setTimeout(() => { window._drawTemplateLogShown = false; }, 1000); // 1 saniye throttle
            }
            
            redrawTemplateCanvas();
            
            templateCtx.strokeStyle = '#007bff';
            templateCtx.lineWidth = 2;
            templateCtx.setLineDash([5, 5]);
            templateCtx.strokeRect(templateStartX, templateStartY, currentX - templateStartX, currentY - templateStartY);
            templateCtx.setLineDash([]);
        }
        
        async function stopTemplateDrawing(e) {
            // B√∂lge ta≈üƒ±mayƒ± bitir
            if (isDraggingRegion) {
                isDraggingRegion = false;
                templateCanvas.style.cursor = 'default';
                return;
            }
            
            // B√∂lge resize'ƒ± bitir
            if (isResizingRegion) {
                isResizingRegion = false;
                resizeHandle = null;
                templateCanvas.style.cursor = 'default';
                return;
            }
            
            // Yeni b√∂lge √ßizimini bitir
            if (!isTemplateDrawing) return;
            isTemplateDrawing = false;
            
            const rect = templateCanvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;
            
            const width = endX - templateStartX;
            const height = endY - templateStartY;
            
            console.log('üìè B√∂lge boyutu:', Math.abs(width), 'x', Math.abs(height));
            
            if (Math.abs(width) > 20 && Math.abs(height) > 20) {
                console.log('‚úÖ Yeni b√∂lge √ßizildi! Modal a√ßƒ±lƒ±yor...');
                currentTemplateRegion = {
                    x: Math.min(templateStartX, endX),
                    y: Math.min(templateStartY, endY),
                    width: Math.abs(width),
                    height: Math.abs(height)
                };
                
                // Show modal first
                showTemplateRegionModal();
                
                // Then perform OCR on the selected region
                await performTemplateRegionOCR();
            } else {
                redrawTemplateCanvas();
            }
        }
        
        function redrawTemplateCanvas() {
            templateCtx.clearRect(0, 0, templateCanvas.width, templateCanvas.height);
            
            if (templateImageObj) {
                templateCtx.drawImage(templateImageObj, 0, 0, templateCanvas.width, templateCanvas.height);
            }
            
            // T√ºm b√∂lgeleri √ßiz
            templateRegions.forEach((region, index) => {
                const isSelected = index === selectedTemplateRegionIndex;
                
                // B√∂lge kutusu
                templateCtx.strokeStyle = isSelected ? '#28a745' : '#dc3545';
                templateCtx.lineWidth = isSelected ? 3 : 2;
                templateCtx.strokeRect(region.x, region.y, region.width, region.height);
                
                // √ñzellik adƒ± etiketi
                templateCtx.fillStyle = isSelected ? 'rgba(40, 167, 69, 0.9)' : 'rgba(220, 53, 69, 0.8)';
                templateCtx.fillRect(region.x, region.y - 25, 150, 25);
                templateCtx.fillStyle = 'white';
                templateCtx.font = '12px Arial';
                templateCtx.fillText(region.propertyName || 'Unnamed', region.x + 5, region.y - 8);
                
                // Se√ßili b√∂lge i√ßin resize handle'larƒ± √ßiz
                if (isSelected) {
                    drawResizeHandles(region);
                }
            });
        }
        
        // Resize handle'larƒ±nƒ± √ßiz
        function drawResizeHandles(region) {
            const handleSize = 8;
            const handles = [
                { x: region.x, y: region.y }, // top-left
                { x: region.x + region.width, y: region.y }, // top-right
                { x: region.x, y: region.y + region.height }, // bottom-left
                { x: region.x + region.width, y: region.y + region.height }, // bottom-right
                { x: region.x + region.width / 2, y: region.y }, // top
                { x: region.x + region.width, y: region.y + region.height / 2 }, // right
                { x: region.x + region.width / 2, y: region.y + region.height }, // bottom
                { x: region.x, y: region.y + region.height / 2 } // left
            ];
            
            handles.forEach(handle => {
                templateCtx.fillStyle = 'white';
                templateCtx.fillRect(handle.x - handleSize / 2, handle.y - handleSize / 2, handleSize, handleSize);
                templateCtx.strokeStyle = '#28a745';
                templateCtx.lineWidth = 2;
                templateCtx.strokeRect(handle.x - handleSize / 2, handle.y - handleSize / 2, handleSize, handleSize);
            });
        }
        
        function showTemplateRegionModal() {
            document.getElementById('templateRegionModal').classList.add('show');
            document.getElementById('templatePropertyName').value = '';
            document.getElementById('templateRegionType').value = 'value';
            
            // Hide info div
            const infoDiv = document.getElementById('templateSelectedPropertyInfo');
            if (infoDiv) infoDiv.style.display = 'none';
            
            // Reset OCR field
            const ocrInput = document.getElementById('templateOcrValue');
            if (ocrInput) {
                ocrInput.value = '';
                ocrInput.placeholder = 'OCR okuma bekleniyor...';
                ocrInput.style.background = '#f8f9fa';
            }
        }
        
        async function performTemplateRegionOCR() {
            if (!currentTemplateRegion || !templateImageObj) {
                console.log('‚ùå OCR i√ßin b√∂lge veya image yok');
                return;
            }
            
            const ocrInput = document.getElementById('templateOcrValue');
            const ocrLoading = document.getElementById('templateOcrLoading');
            
            try {
                // Show loading
                if (ocrLoading) ocrLoading.style.display = 'block';
                if (ocrInput) ocrInput.placeholder = '‚è≥ OCR ile okunuyor...';
                
                console.log('üîç Template b√∂lge OCR ba≈ülatƒ±lƒ±yor...', currentTemplateRegion);
                
                // Extract the region from canvas
                const regionCanvas = document.createElement('canvas');
                regionCanvas.width = currentTemplateRegion.width;
                regionCanvas.height = currentTemplateRegion.height;
                const regionCtx = regionCanvas.getContext('2d');
                
                // Draw the selected region
                regionCtx.drawImage(
                    templateCanvas,
                    currentTemplateRegion.x,
                    currentTemplateRegion.y,
                    currentTemplateRegion.width,
                    currentTemplateRegion.height,
                    0,
                    0,
                    currentTemplateRegion.width,
                    currentTemplateRegion.height
                );
                
                // Enhance image for better OCR
                const imageData = regionCtx.getImageData(0, 0, regionCanvas.width, regionCanvas.height);
                const data = imageData.data;
                
                // Increase contrast
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const contrast = 1.5;
                    const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                    
                    data[i] = Math.min(255, Math.max(0, factor * (avg - 128) + 128));
                    data[i + 1] = data[i];
                    data[i + 2] = data[i];
                }
                
                regionCtx.putImageData(imageData, 0, 0);
                
                // Perform OCR
                const result = await Tesseract.recognize(
                    regionCanvas.toDataURL(),
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                console.log(`üìä OCR Progress: ${Math.round(m.progress * 100)}%`);
                            }
                        }
                    }
                );
                
                const text = result.data.text.trim();
                console.log('‚úÖ OCR Sonucu:', text);
                
                // Update input
                if (ocrInput) {
                    ocrInput.value = text;
                    ocrInput.placeholder = text ? 'OCR ba≈üarƒ±lƒ±' : 'Metin okunamadƒ±, manuel girin';
                    ocrInput.style.background = text ? '#e8f5e9' : '#fff3cd';
                }
                
                // Auto-add OCR result to property list if it's a valid property name
                if (text && text.length > 2 && text.length < 100) {
                    // Clean the text (remove special chars, numbers at start)
                    const cleanText = text.replace(/^[\d\s\-_\.]+/, '').trim();
                    
                    if (cleanText.length > 2) {
                        const added = addPropertyToList(cleanText);
                        if (added) {
                            console.log('üéØ OCR sonucu otomatik listeye eklendi:', cleanText);
                        }
                    }
                }
                
                if (!text) {
                    showToast('‚ö†Ô∏è Metin okunamadƒ±, l√ºtfen manuel girin', 'warning');
                } else {
                    showToast('‚úÖ Metin OCR ile okundu', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå OCR hatasƒ±:', error);
                if (ocrInput) {
                    ocrInput.placeholder = 'OCR ba≈üarƒ±sƒ±z, manuel girin';
                    ocrInput.style.background = '#ffebee';
                }
                showToast('‚ùå OCR hatasƒ±: ' + error.message, 'error');
            } finally {
                if (ocrLoading) ocrLoading.style.display = 'none';
            }
        }
        
        function closeTemplateRegionModal() {
            document.getElementById('templateRegionModal').classList.remove('show');
            currentTemplateRegion = null;
            editingRegionIndex = null; // D√ºzenleme modunu kapat
            
            // Reset OCR field
            const ocrInput = document.getElementById('templateOcrValue');
            if (ocrInput) {
                ocrInput.value = '';
                ocrInput.placeholder = 'OCR okuma bekleniyor...';
                ocrInput.style.background = '#f8f9fa';
            }
            
            redrawTemplateCanvas();
        }
        
        function saveTemplateRegion() {
            let propertyName = document.getElementById('templatePropertyName').value;
            const ocrValue = document.getElementById('templateOcrValue')?.value || '';
            
            if (!propertyName) {
                alert('L√ºtfen √∂zellik adƒ± se√ßin veya yeni √∂zellik ekleyin!');
                return;
            }
            
            const regionType = document.getElementById('templateRegionType').value;
            
            currentTemplateRegion.propertyName = propertyName;
            currentTemplateRegion.type = regionType;
            currentTemplateRegion.ocrValue = ocrValue;  // OCR deƒüerini kaydet
            
            // D√ºzenleme modundaysa mevcut region'u g√ºncelle
            if (editingRegionIndex !== null) {
                templateRegions[editingRegionIndex] = currentTemplateRegion;
                editingRegionIndex = null;
                console.log('‚úèÔ∏è B√∂lge g√ºncellendi:', propertyName);
            } else {
                // Yeni b√∂lge ekle
                templateRegions.push(currentTemplateRegion);
                console.log('‚ûï Yeni b√∂lge eklendi:', propertyName);
            }
            
            closeTemplateRegionModal();
            updateTemplateRegionsList();
            redrawTemplateCanvas();
        }
        
        function updateTemplateRegionsList() {
            const list = document.getElementById('templateRegionsList');
            const count = document.getElementById('templateRegionCount');
            
            count.textContent = templateRegions.length;
            
            list.innerHTML = templateRegions.map((region, index) => `
                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; margin-bottom: 8px; cursor: pointer;" onclick="selectTemplateRegion(${index})">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-weight: 600; color: #2c5f2d; font-size: 13px;">${region.propertyName}</span>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="editTemplateRegion(${index}); event.stopPropagation();" style="background: #17a2b8; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px;" title="D√ºzenle">‚úèÔ∏è</button>
                            <button onclick="deleteTemplateRegion(${index}); event.stopPropagation();" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Sil">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #666;">
                        ${region.type === 'value' ? 'COA Deƒüeri' : '√ñzellik Adƒ±'}<br>
                        ${region.ocrValue ? `<span style="background: #e8f5e9; padding: 2px 4px; border-radius: 3px; display: inline-block; margin-top: 3px;">üìù ${region.ocrValue}</span><br>` : ''}
                        X:${Math.round(region.x)} Y:${Math.round(region.y)} W:${Math.round(region.width)} H:${Math.round(region.height)}
                    </div>
                </div>
            `).join('');
        }
        
        function selectTemplateRegion(index) {
            selectedTemplateRegionIndex = index;
            updateTemplateRegionsList();
            redrawTemplateCanvas();
        }
        
        function deleteTemplateRegion(index) {
            templateRegions.splice(index, 1);
            selectedTemplateRegionIndex = null;
            updateTemplateRegionsList();
            redrawTemplateCanvas();
        }
        
        function clearTemplateRegions() {
            if (confirm('T√ºm b√∂lgeleri silmek istediƒüinizden emin misiniz?')) {
                templateRegions = [];
                selectedTemplateRegionIndex = null;
                updateTemplateRegionsList();
                redrawTemplateCanvas();
            }
        }
        
        // Template'i g√∂rsel ile y√ºkle - Google Sheets'ten
        async function loadTemplateWithImage() {
            console.log('üìÇ Template y√ºkleme ba≈ülatƒ±ldƒ±...');
            
            // Mode'u i≈üaretle
            window.currentTemplateLoadMode = 'load';
            
            // Google Sheets'ten template'leri y√ºkle
            await loadTemplatesFromGoogleSheets();
            
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            
            if (templates.length === 0) {
                showToast('‚ö†Ô∏è Kayƒ±tlƒ± template bulunamadƒ±! L√ºtfen √∂nce template olu≈üturun.', 'warning');
                return;
            }
            
            // Modal a√ß ve template'leri listele
            const modal = document.getElementById('templateLoadModal');
            const list = document.getElementById('templateLoadList');
            
            list.innerHTML = templates.map((template, index) => {
                const date = new Date(template.createdAt).toLocaleDateString('tr-TR');
                const time = new Date(template.createdAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const hasImage = (template.imageUrl || template.imageData) ? '‚úÖ' : '‚ùå';
                const regionCount = template.regions?.length || template.template?.regions?.length || 0;
                
                return `
                    <div class="template-load-item" style="padding: 15px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 8px; transition: all 0.3s; background: white; position: relative;">
                        <div onclick="selectTemplateToLoad(${index})" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; padding-right: 35px;">
                                <div style="font-weight: 600; color: #2c5f2d; font-size: 1.1em;">${template.supplier}</div>
                                <div style="font-size: 0.85em; color: #666;">${date} ${time}</div>
                            </div>
                            <div style="display: flex; gap: 15px; font-size: 0.9em; color: #555;">
                                <span>${hasImage} G√∂rsel</span>
                                <span>üìç ${regionCount} B√∂lge</span>
                                <span>üìä v${template.version || '1.0'}</span>
                            </div>
                        </div>
                        <button onclick="deleteTemplate('${template.supplier}', ${index}); event.stopPropagation();" 
                                style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: background 0.3s;"
                                onmouseover="this.style.background='#c82333'" 
                                onmouseout="this.style.background='#dc3545'">
                            üóëÔ∏è Sil
                        </button>
                    </div>
                `;
            }).join('');
            
            modal.style.display = 'flex';
        }

        
        // Template se√ß ve y√ºkle
        function selectTemplateToLoad(index) {
            const templates = JSON.parse(localStorage.getItem('coaTemplates') || '[]');
            const rawTemplate = templates[index];
            
            if (!rawTemplate) {
                showToast('‚ùå Template bulunamadƒ±!', 'error');
                return;
            }
            
            console.log('üì¶ Ham template yapƒ±sƒ±:', rawTemplate);
            
            // Google Sheets'ten gelen template yapƒ±sƒ±nƒ± d√ºzelt
            // Bazen template.template i√ßinde ger√ßek template var
            const template = rawTemplate.template || rawTemplate;
            
            console.log('üîç ƒ∞≈ülenmi≈ü template:', template);
            console.log('üìç Regions var mƒ±?', template.regions);
            
            // Modal'i kapat (eƒüer varsa)
            const modal = document.getElementById('templateLoadModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Tedarik√ßi adƒ±nƒ± yaz
            document.getElementById('templateSupplierName').value = template.supplier || rawTemplate.supplier || 'Bilinmeyen';
            
            // Regions kontrol√º - g√ºvenli eri≈üim
            if (!template.regions || !Array.isArray(template.regions)) {
                showToast('‚ö†Ô∏è Template b√∂lge bilgisi i√ßermiyor!', 'warning');
                console.error('‚ùå Regions bulunamadƒ±. Template yapƒ±sƒ±:', template);
                return;
            }
            
            // G√∂rseli y√ºkle
            if (template.imageData) {
                templateImageObj = new Image();
                templateImageObj.onload = function() {
                    templateCanvas.width = template.canvasWidth || templateImageObj.width;
                    templateCanvas.height = template.canvasHeight || templateImageObj.height;
                    templateScaleFactor = template.scaleFactor || 1;
                    
                    // Regions'ƒ± y√ºkle
                    templateRegions = template.regions.map(r => ({
                        ...r,
                        x: r.x * templateScaleFactor,
                        y: r.y * templateScaleFactor,
                        width: r.width * templateScaleFactor,
                        height: r.height * templateScaleFactor
                    }));
                    
                    console.log(`‚úÖ ${templateRegions.length} b√∂lge y√ºklendi`);
                    
                    updateTemplateRegionsList();
                    redrawTemplateCanvas();
                    
                    // Template editor'ƒ± a√ß (eƒüer kapalƒ±ysa ve element varsa)
                    const checkbox = document.getElementById('templateModeCheckbox');
                    const panel = document.getElementById('templateEditorPanel');
                    
                    if (checkbox) checkbox.checked = true;
                    if (panel) panel.style.display = 'flex';
                    
                    showToast(`‚úÖ ${template.supplier} template'i y√ºklendi! G√∂rsel ve ${templateRegions.length} b√∂lge geri y√ºklendi.`, 'success');
                };
                templateImageObj.src = template.imageData;
            } else {
                // G√∂rsel yok ama regions var - mevcut canvas √ºzerine √ßiz
                templateRegions = template.regions.map(r => ({
                    ...r,
                    x: r.x * (template.scaleFactor || 1),
                    y: r.y * (template.scaleFactor || 1),
                    width: r.width * (template.scaleFactor || 1),
                    height: r.height * (template.scaleFactor || 1)
                }));
                
                console.log(`‚úÖ ${templateRegions.length} b√∂lge y√ºklendi (g√∂rsel yok)`);
                
                updateTemplateRegionsList();
                redrawTemplateCanvas(); // Canvas'ƒ± yeniden √ßiz - b√∂lgeler g√∂r√ºns√ºn!
                
                // Template editor'ƒ± a√ß (eƒüer kapalƒ±ysa ve element varsa)
                const checkbox = document.getElementById('templateModeCheckbox');
                const panel = document.getElementById('templateEditorPanel');
                
                if (checkbox) checkbox.checked = true;
                if (panel) panel.style.display = 'flex';
                
                showToast(`‚úÖ ${template.supplier} template'i y√ºklendi! ${templateRegions.length} b√∂lge mevcut canvas √ºzerine eklendi.`, 'success');
            }
        }
        
        async function openTemplateEditorWithFile(file) {
            console.log('üé® Template editor a√ßƒ±lƒ±yor...', file.name);
            
            // Eƒüer bir render i≈ülemi devam ediyorsa bekle
            if (currentRenderTask) {
                console.log('‚è≥ √ñnceki render bekleniyor...');
                try {
                    await currentRenderTask.promise;
                } catch (e) {
                    // ƒ∞ptal edilmi≈ü olabilir, √∂nemli deƒüil
                }
            }
            
            // Initialize canvas
            templateCanvas = document.getElementById('templateCanvas');
            if (!templateCanvas) {
                console.error('‚ùå Template canvas bulunamadƒ±!');
                showToast('‚ùå Template canvas bulunamadƒ±', 'error');
                return;
            }
            templateCtx = templateCanvas.getContext('2d');
            
            // Clear previous regions (ama edit modundaysa pending regions'ƒ± y√ºkle)
            if (window.pendingTemplateRegions && window.pendingTemplateRegions.length > 0) {
                console.log('üìç Pending regions y√ºkleniyor (edit mode):', window.pendingTemplateRegions.length, 'b√∂lge');
                // Regions normalized olarak kaydedilmi≈ü (original scale'de)
                // Saved scaleFactor kullanarak current scale'e d√∂n√º≈üt√ºr
                const scaleFactor = window.savedTemplateConfig?.scaleFactor || 1;
                templateRegions = window.pendingTemplateRegions.map(r => ({
                    ...r,
                    x: r.x * scaleFactor,
                    y: r.y * scaleFactor,
                    width: r.width * scaleFactor,
                    height: r.height * scaleFactor
                }));
                console.log('‚öôÔ∏è Regions current scale\'e d√∂n√º≈üt√ºr√ºld√º (scaleFactor:', scaleFactor, ')');
                window.pendingTemplateRegions = null; // Clear after loading
            } else {
                templateRegions = [];
            }
            updateTemplateRegionsList();
            
            // Setup event listeners
            templateCanvas.removeEventListener('mousedown', startTemplateDrawing);
            templateCanvas.removeEventListener('mousemove', drawTemplate);
            templateCanvas.removeEventListener('mouseup', stopTemplateDrawing);
            
            templateCanvas.addEventListener('mousedown', startTemplateDrawing);
            templateCanvas.addEventListener('mousemove', drawTemplate);
            templateCanvas.addEventListener('mouseup', stopTemplateDrawing);
            
            // Load file
            console.log('üìÑ Dosya y√ºkleniyor:', file.type);
            const isExcel = file.type.includes('spreadsheet') || file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
            const isWord = file.type.includes('word') || file.name.toLowerCase().endsWith('.docx') || file.name.toLowerCase().endsWith('.doc');
            
            if (file.type === 'application/pdf') {
                await loadTemplatePDF(file);
            } else if (isExcel) {
                await loadTemplateExcel(file);
            } else if (isWord) {
                await loadTemplateWord(file);
            } else {
                await loadTemplateImage(file);
            }
            
            // Eƒüer regions y√ºklendiyse, canvas'ƒ± yeniden √ßiz
            if (templateRegions && templateRegions.length > 0) {
                console.log('üîÑ Canvas regions ile yeniden √ßiziliyor...');
                redrawTemplateCanvas();
            }
            
            // Show modal
            console.log('üé® Modal g√∂steriliyor');
            document.getElementById('templateEditorModal').classList.add('show');
            
            // Edit modundaysa tedarik√ßi adƒ±nƒ± doldur
            if (window.currentEditingTemplate) {
                const supplierInput = document.getElementById('templateSupplierName');
                if (supplierInput) {
                    supplierInput.value = window.currentEditingTemplate.supplier || '';
                    console.log('‚úèÔ∏è Tedarik√ßi adƒ± dolduruldu (edit mode):', supplierInput.value);
                }
            }
        }
    </script>
    
    <!-- Missing COA Report Modal -->
    <div class="modal" id="missingCOAModal">
        <span class="modal-close" onclick="closeMissingCOAModal()">&times;</span>
        <div class="modal-content" style="max-width: 95%; width: 1400px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">üìä COA Durum Raporu - ƒ∞rsaliye Bazƒ±nda</h2>
            
            <div id="missingCOAContent">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>üìä Kontrol ediliyor...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- COA Properties Modal -->
    <div class="modal" id="coaPropertiesModal">
        <span class="modal-close" onclick="closeCoaPropertiesModal()">&times;</span>
        <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">üìä COA Analiz Deƒüerleri</h2>
            
            <div id="coaPropertiesContent">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>