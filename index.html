<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tedarikçi Analiz Sistemi</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <!-- Shared Config for COA Integration -->
    <script src="shared-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: auto !important;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            overflow-anchor: none;
            overflow-y: scroll;
        }
        
        /* Dropdown dışına tıklanınca kapat */
        body.dropdown-open {
            position: relative;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header h1 img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95em;
            margin-left: 82px;
        }

        .header-logos {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: nowrap;
        }

        .header-logos img {
            max-height: 55px;
            width: auto;
            object-fit: contain;
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
        }
        
        .container {
            max-width: 98%;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .upload-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 2px dashed #1e3c72;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .upload-area * {
            pointer-events: none;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #2a5298;
        }
        
        .upload-area.dragover {
            background: #d1e7ff;
            border-color: #0066cc;
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.2);
        }
        
        #fileInput, #fileInput2 {
            display: none;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        
        .controls.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        
        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: #1e3c72;
            border: 2px solid #1e3c72;
        }
        
        .btn-secondary:hover {
            background: #1e3c72;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-row {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 15px;
            align-items: stretch;
            margin-bottom: 20px;
        }

        .dashboard-row .stat-label {
            font-size: 0.78em;
            line-height: 1.2;
            white-space: normal;
        }

        .pie-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-self: end;
        }

        .pie-card canvas {
            width: 100% !important;
            height: 260px !important;
            margin-left: auto;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #1e3c72;
            min-width: 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 1.15em;
            font-weight: bold;
            color: #1e3c72;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-variant-numeric: tabular-nums;
        }
        
        .suppliers-table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-wrapper {
            overflow-x: auto !important;
            overflow-y: visible;
            width: 100%;
            max-width: 100vw;
            display: block;
            contain: layout paint;
            scroll-behavior: auto;
            -webkit-overflow-scrolling: auto;
        }
        
        .suppliers-table-container table td,
        .suppliers-table-container table th {
            height: 56px;
            vertical-align: middle;
            padding: 12px 10px;
        }
        
        .table-wrapper::-webkit-scrollbar {
            height: 16px !important;
            background: #f0f0f0;
            display: block !important;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #e8e8e8;
            border: 1px solid #ccc;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #1e3c72;
            border-radius: 8px;
            border: 2px solid #e8e8e8;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #2a5298;
        }
        
        table {
            width: 2400px !important;
            border-collapse: collapse;
            white-space: nowrap;
        }
        
        th, td {
            min-width: 80px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background: #1e3c72;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        th.sortable:hover {
            background-color: #2a5298;
        }
        
        .sort-icon {
            font-size: 0.9em;
            margin-left: 5px;
            display: inline-block;
            min-width: 12px;
            text-align: center;
            opacity: 0.9;
            transition: all 0.2s ease;
        }
        
        th.sortable:hover .sort-icon {
            opacity: 1;
            transform: scale(1.15);
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.95em;
            vertical-align: middle;
        }
        
        /* Override için özel td stilleri - max-width'i kaldır */
        tbody td {
            max-width: none;
            overflow: visible;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .supplier-name {
            font-weight: 600;
            color: #1e3c72;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-onaylı {
            background: #d4edda;
            color: #155724;
        }
        
        .status-beklemede {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-class-d {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-class-c {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-dropdown {
            outline: none;
        }
        
        .status-dropdown.status-class-d {
            background: #f8d7da !important;
            color: #721c24 !important;
        }
        
        .status-dropdown.status-class-c {
            background: #fff3cd !important;
            color: #856404 !important;
        }
        
        .status-dropdown.status-onaylı {
            background: #d4edda !important;
            color: #155724 !important;
        }
        
        .ppm-value {
            font-weight: 600;
        }
        
        .ppm-low { color: #28a745; }
        .ppm-medium { color: #ffc107; }
        .ppm-high { color: #dc3545; }
        
        #alertContainer {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            min-width: 400px;
            max-width: 600px;
            pointer-events: none;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 0;
            font-size: 0.95em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: auto;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 1.1em;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .ppm-target-input {
            width: 100px;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: right;
            transition: all 0.3s;
            vertical-align: middle;
            box-sizing: border-box;
            height: 32px;
            line-height: 1;
        }
        
        .ppm-target-input:focus {
            outline: none;
            border-color: #1e3c72;
            background: #f8f9fa;
        }
        
        .ppm-target-input:hover {
            border-color: #2a5298;
        }
        
        .supplier-class-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 1em;
            text-align: center;
            min-width: 45px;
        }
        
        .supplier-class {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 1em;
            text-align: center;
            min-width: 45px;
        }
        
        .class-a {
            background: #92D050;
            color: white;
            font-weight: bold;
        }
        
        .class-b {
            background: #FFFF00;
            color: #333;
            font-weight: bold;
        }
        
        .class-c {
            background: #FFC000;
            color: #333;
            font-weight: bold;
        }
        
        .class-d {
            background: #FF0000;
            color: white;
            font-weight: bold;
        }
        
        .supplier-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .supplier-filter-label {
            font-weight: 600;
            color: #1e3c72;
            white-space: nowrap;
        }
        
        .multiselect-container {
            position: relative;
            min-width: 250px;
        }
        
        .multiselect-selected {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            user-select: none;
        }
        
        .multiselect-selected:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }
        
        .dropdown-arrow {
            margin-left: 10px;
            color: #666;
            font-size: 0.8em;
            transition: transform 0.3s;
        }
        
        .multiselect-container.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow: hidden;
        }
        
        .multiselect-container.open .multiselect-dropdown {
            display: block;
        }
        
        .multiselect-search {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .multiselect-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .multiselect-search input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        
        .multiselect-options {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .multiselect-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        
        .multiselect-option:hover {
            background: #f0f2f5;
        }
        
        .multiselect-option input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .multiselect-option label {
            cursor: pointer;
            flex: 1;
            user-select: none;
        }
        
        .multiselect-option.select-all {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
        }
        
        .saved-filters-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .saved-filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .saved-filters-header h3 {
            margin: 0;
            color: #1e3c72;
            font-size: 1.2em;
        }
        
        .saved-filters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .saved-filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0f2f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .saved-filter-item:hover {
            background: #e3e6ea;
            border-color: #1e3c72;
        }
        
        .saved-filter-item.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        
        .saved-filter-name {
            font-weight: 600;
            user-select: none;
        }
        
        .saved-filter-delete {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .saved-filter-item.active .saved-filter-delete {
            color: white;
        }
        
        .saved-filter-delete:hover {
            transform: scale(1.2);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        .btn-primary {
            background: #1e3c72;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2a5298;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-dialog {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #1e3c72;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            color: #dc3545;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .filter-name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-name-input:focus {
            outline: none;
            border-color: #1e3c72;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .modal-dialog-large {
            max-width: 600px;
        }
        
        .edit-supplier-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .edit-supplier-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            border-radius: 5px;
        }
        
        .edit-supplier-item:hover {
            background: #f0f2f5;
        }
        
        .edit-supplier-item input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .edit-supplier-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            user-select: none;
        }
        
        .saved-filter-actions {
            display: flex;
            gap: 5px;
        }
        
        .saved-filter-edit {
            background: none;
            border: none;
            color: #1e3c72;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .saved-filter-item.active .saved-filter-edit {
            color: white;
        }
        
        .saved-filter-edit:hover {
            transform: scale(1.2);
        }

        /* 8D Report Styles */
        .tab-8d-btn {
            position: relative;
            padding: 12px 20px 12px 30px !important;
            margin-right: 8px;
            clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 50%, calc(100% - 12px) 100%, 0 100%, 12px 50%);
        }
        
        .tab-8d-btn:first-child {
            clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 50%, calc(100% - 12px) 100%, 0 100%);
            padding-left: 20px !important;
        }
        
        .tab-8d-btn:last-child {
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 12px 50%);
            margin-right: 0;
        }
        
        .tab-8d-btn.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
            color: white !important;
            z-index: 2;
        }

        .tab-8d-btn:hover {
            background: #e3f2fd !important;
            z-index: 1;
        }

        .d1-team-member, .d3-action, .d4-root-cause, .d5-action, .d6-implementation, .d7-prevention, .d8-participant {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .remove-btn-8d {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            line-height: 1;
            transition: transform 0.2s;
        }

        .remove-btn-8d:hover {
            transform: scale(1.1);
            background: #c82333;
        }

        .month-8d-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 700;
            transition: all 0.3s;
            position: relative;
            color: #666;
            margin: 0 auto;
            display: block;
        }

        .month-8d-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* 8D Status: Closed (Yeşil) */
        .month-8d-btn.status-closed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #4CAF50;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }

        /* 8D Status: In Progress (Sarı) */
        .month-8d-btn.status-inprogress {
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
            color: #333;
            border-color: #FFC107;
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
            font-weight: 800;
        }

        /* 8D Status: Open (Kırmızı) */
        .month-8d-btn.status-open {
            background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
            color: white;
            border-color: #f44336;
            box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
        }

        .month-8d-btn.has-report {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #4CAF50;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }

        .month-8d-btn.has-report::after {
            content: '✓';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FFC107;
            color: #333;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: stretch;
            }

            .header-content {
                text-align: center;
            }

            .header h1 {
                font-size: 1.3em;
                flex-direction: column;
                gap: 8px;
            }

            .header h1 img {
                width: 50px;
                height: 50px;
            }

            .header p {
                margin-left: 0;
                font-size: 0.85em;
            }

            .header-logos {
                justify-content: center;
                flex-wrap: wrap;
            }

            .header-logos img {
                max-height: 40px;
            }

            .container {
                max-width: 100%;
                padding: 0 10px;
                margin: 15px auto;
            }

            .upload-section {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            .upload-area {
                padding: 30px 15px;
            }

            .upload-icon {
                font-size: 2em;
            }

            .controls.active {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: 100%;
            }

            .btn {
                width: 100%;
                padding: 12px 20px;
            }

            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                font-size: 0.85em;
                min-width: 800px;
            }

            th, td {
                padding: 8px 6px;
            }

            .status-dropdown {
                font-size: 0.8em;
                padding: 4px 8px;
            }

            #alertContainer {
                min-width: 90%;
                max-width: 90%;
                top: 70px;
                left: 50%;
            }

            .alert {
                font-size: 0.85em;
                padding: 12px 15px;
            }

            /* Tabs Mobile */
            .tabs {
                flex-wrap: wrap;
                gap: 8px;
            }

            .tab-btn {
                font-size: 0.85em;
                padding: 10px 15px;
                flex: 1 1 calc(50% - 4px);
                min-width: auto;
            }

            /* Modal Mobile */
            .modal {
                padding: 10px;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
                margin: 5% auto;
            }

            .modal-header h2 {
                font-size: 1.2em;
            }

            .modal-body {
                padding: 15px;
            }

            /* Form Responsive */
            .form-row {
                flex-direction: column;
            }

            .form-group {
                width: 100% !important;
            }

            /* Chart Container */
            .chart-container {
                padding: 15px;
            }

            canvas {
                max-height: 250px !important;
            }

            /* Dropdown içeriği */
            .dropdown-menu {
                max-height: 60vh;
            }

            /* Stats cards */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Filter container mobile */
            .filter-container {
                flex-direction: column;
                gap: 10px;
            }

            .filter-dropdown {
                width: 100%;
            }

            /* 8D Report Mobile */
            .tab-8d-btn {
                font-size: 0.8em;
                padding: 10px 15px 10px 20px !important;
                clip-path: none !important;
            }

            .tab-8d-btn:first-child,
            .tab-8d-btn:last-child {
                clip-path: none !important;
                padding-left: 15px !important;
            }

            /* Month buttons mobile */
            .months-grid-8d {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .month-8d-btn {
                font-size: 0.85em;
                padding: 10px 8px;
            }

            /* Team members mobile */
            .d1-team-member,
            .d3-action,
            .d4-root-cause,
            .d5-action,
            .d6-implementation,
            .d7-prevention,
            .d8-participant {
                padding: 12px;
            }

            .remove-btn-8d {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }

            /* Supplier selection mobile */
            .edit-supplier-list {
                max-height: 50vh;
            }

            .saved-filters {
                flex-direction: column;
                gap: 8px;
            }

            .saved-filter-item {
                width: 100%;
            }
        }

        /* Tablet view (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 95%;
            }

            table {
                font-size: 0.9em;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .months-grid-8d {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Small mobile devices (max 480px) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.1em;
            }

            .header h1 img {
                width: 40px;
                height: 40px;
            }

            .upload-section h2 {
                font-size: 1.2em;
            }

            .btn {
                font-size: 0.9em;
                padding: 10px 15px;
            }

            table {
                font-size: 0.75em;
            }

            .modal-content {
                width: 98%;
            }

            .months-grid-8d {
                grid-template-columns: repeat(2, 1fr);
            }

            .tab-btn {
                font-size: 0.75em;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><img src="assets/supplier_icon.png" alt="Icon"> Tedarikçi Performans Analiz Sistemi</h1>
            <p>Detaylı Analiz ve Raporlama <span style="font-size: 0.7em; font-style: italic; opacity: 0.7; margin-left: 8px;">v1.0</span></p>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="coa-arsiv.html" id="coaNavBtn" style="background: linear-gradient(135deg, #2d5a3d 0%, #4a8f5c 100%); color: white; padding: 12px 20px; border-radius: 10px; text-decoration: none; font-weight: 700; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(45, 90, 61, 0.4); transition: all 0.3s; font-size: 1em; position: relative;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 61, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 61, 0.4)'">
                📋 COA Arşiv
                <span id="coaBadge" style="background: #ff6b6b; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -5px; display: none;">0</span>
            </a>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="header-logos">
                <img src="assets/logo1.png" alt="Logo 1" onerror="this.style.display='none'">
                <img src="assets/logo2.png" alt="Logo 2" onerror="this.style.display='none'">
                <img src="assets/corefix_logo.png" alt="Logo 3" onerror="this.style.display='none'">
                <img src="assets/saniteks_logo.png" alt="Logo 4" onerror="this.style.display='none'">
            </div>
        </div>
    </div>
    
    <div class="container">
        <div style="text-align: left; margin-bottom: 15px; padding-left: 20px;">
            <button id="toggleUploadBtn" onclick="toggleUploadSection()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-size: 1.3em; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; font-weight: bold;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ▼
            </button>
        </div>
        
        <div id="uploadContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; transition: all 0.3s ease; overflow: hidden;">
            <div class="upload-section" style="margin: 0;">
                <h3 style="margin-bottom: 15px; color: #1e3c72;">1️⃣ Ana Excel Dosyası (Sevkiyat, İade, Hata)</h3>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center;">
                    <div class="upload-icon">📁</div>
                    <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">Excel Dosyanızı Yükleyin</div>
                    <div style="color: #666; font-size: 0.9em;">Sürükleyip bırakın veya tıklayarak dosya seçin</div>
                    <div style="color: #999; font-size: 0.85em; margin-top: 8px;">(.xlsx, .xls)</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(event)">
                </div>
            </div>

            <div class="upload-section" id="secondUploadSection" style="display: none; margin: 0;">
                <h3 style="margin-bottom: 15px; color: #1e3c72;">2️⃣ Aylık Termin ve Tamamlanma Puanları</h3>
                <div class="upload-area" id="uploadArea2" onclick="document.getElementById('fileInput2').click()" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center;">
                    <div class="upload-icon">📅</div>
                    <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">Termin ve Tamamlanma Puanları Excel'ini Yükleyin</div>
                    <div style="color: #666; font-size: 0.9em;">Aylık puanları içeren Excel dosyasını seçin</div>
                    <div style="color: #999; font-size: 0.85em; margin-top: 8px;">(.xlsx, .xls)</div>
                    <input type="file" id="fileInput2" accept=".xlsx,.xls" onchange="handleFile2(event)">
                </div>
                <div id="monthlyDataStatus" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <div id="alertContainer"></div>
        
        <div class="controls" id="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 Tedarikçi ara..." onkeyup="filterTable()">
            </div>
            <div class="supplier-filter">
                <div class="supplier-filter-label">📋 Durum:</div>
                <div class="multiselect-container" id="durumContainer">
                    <div class="multiselect-selected" id="selectedDurumlar" onclick="toggleDurumDropdown()">
                        <span id="selectedDurumText">Tümü Seçili</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="multiselect-dropdown" id="durumOptions" style="display: none;">
                        <label class="multiselect-option">
                            <input type="checkbox" value="__TUMU__" onchange="toggleAllDurumlar(this)" checked>
                            <span>✓ Tümü</span>
                        </label>
                        <label class="multiselect-option">
                            <input type="checkbox" value="ONAYLI" onchange="updateDurumFilter()" checked>
                            <span>Onaylı</span>
                        </label>
                        <label class="multiselect-option">
                            <input type="checkbox" value="ONAYSIZ" onchange="updateDurumFilter()" checked>
                            <span>Onaysız</span>
                        </label>
                        <label class="multiselect-option">
                            <input type="checkbox" value="MÜŞTERİ" onchange="updateDurumFilter()" checked>
                            <span>Müşteri</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="supplier-filter">
                <div class="supplier-filter-label">📍 Lokasyon:</div>
                <div class="multiselect-container" id="locationContainer">
                    <div class="multiselect-selected" id="selectedLocations" onclick="toggleLocationDropdown()">
                        <span id="selectedLocationText">Tümü Seçili</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="multiselect-dropdown" id="locationDropdown">
                        <div class="multiselect-options" id="locationOptions">
                            <label class="multiselect-option">
                                <input type="checkbox" value="__TUMU__" onchange="toggleAllLocations(this)" checked>
                                <span>✓ Tümü</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Çerkezköy" onchange="updateLocationFilter()" checked>
                                <span>Çerkezköy</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Veliköy" onchange="updateLocationFilter()" checked>
                                <span>Veliköy</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Ankara" onchange="updateLocationFilter()" checked>
                                <span>Ankara</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Bursa" onchange="updateLocationFilter()" checked>
                                <span>Bursa</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Adana" onchange="updateLocationFilter()" checked>
                                <span>Adana</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Eskişehir" onchange="updateLocationFilter()" checked>
                                <span>Eskişehir</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Ultech1" onchange="updateLocationFilter()" checked>
                                <span>Ultech1</span>
                            </label>
                            <label class="multiselect-option">
                                <input type="checkbox" value="Ultech2" onchange="updateLocationFilter()" checked>
                                <span>Ultech2</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ay Filtresi -->
            <div class="supplier-filter">
                <div class="supplier-filter-label">📅 Aylar:</div>
                <div class="multiselect-container" id="monthContainer">
                    <div class="multiselect-selected" id="selectedMonthsBox" onclick="toggleMonthDropdown()">
                        <span id="selectedMonthText">Tümü Seçili</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="multiselect-dropdown" id="monthDropdown">
                        <div class="multiselect-options" id="monthOptions">
                            <label class="multiselect-option">
                                <input type="checkbox" value="__TUMU__" onchange="toggleAllMonths(this)" checked>
                                <span>✓ Tümü</span>
                            </label>
                            <label class="multiselect-option"><input type="checkbox" value="1" onchange="updateMonthFilter()" checked><span>1</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="2" onchange="updateMonthFilter()" checked><span>2</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="3" onchange="updateMonthFilter()" checked><span>3</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="4" onchange="updateMonthFilter()" checked><span>4</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="5" onchange="updateMonthFilter()" checked><span>5</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="6" onchange="updateMonthFilter()" checked><span>6</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="7" onchange="updateMonthFilter()" checked><span>7</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="8" onchange="updateMonthFilter()" checked><span>8</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="9" onchange="updateMonthFilter()" checked><span>9</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="10" onchange="updateMonthFilter()" checked><span>10</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="11" onchange="updateMonthFilter()" checked><span>11</span></label>
                            <label class="multiselect-option"><input type="checkbox" value="12" onchange="updateMonthFilter()" checked><span>12</span></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="supplier-filter">
                <div class="supplier-filter-label">✔️ Tedarikçi Seç:</div>
                <div class="multiselect-container" id="supplierContainer">
                    <div class="multiselect-selected" id="selectedSuppliers" onclick="toggleSupplierDropdown()">
                        <span id="selectedText">Tümü Seçili</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="multiselect-dropdown" id="supplierDropdown">
                        <div class="multiselect-search">
                            <input type="text" id="supplierSearchInput" placeholder="🔍 Ara..." onkeyup="filterSupplierList()">
                        </div>
                        <div class="multiselect-options" id="supplierOptions">
                            <!-- Options will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <!-- Ayarlar Butonu -->
                <button class="btn btn-primary" onclick="showSettingsDialog()" style="background: #607d8b; border-color: #607d8b; position: relative;">
                    ⚙️ Ayarlar & Veritabanı
                    <span id="dbConnectionIndicator" style="position: absolute; top: 8px; right: 8px; width: 10px; height: 10px; background: #ffc107; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></span>
                </button>
                
                <!-- JSON İşlemleri Grubu -->
                <div style="display: flex; gap: 8px; padding: 8px; background: #e8f5e9; border-radius: 8px; border: 1px solid #4caf50;">
                    <button class="btn btn-primary" onclick="exportEditsToJSON()" style="background: #4caf50; border-color: #4caf50;">📤 JSON İndir</button>
                    <button class="btn btn-primary" onclick="document.getElementById('jsonFileInput').click()" style="background: #4caf50; border-color: #4caf50;">📥 JSON Yükle</button>
                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="importEditsFromJSON(event)">
                </div>
                
                <!-- Kayıt İşlemleri Grubu -->
<div style="display: flex; gap: 8px; padding: 8px; background: #e3f2fd; border-radius: 8px; border: 1px solid #2196f3;">
                    <button class="btn btn-primary" onclick="showEditsDialog()">💾 Düzenlemeleri Kaydet</button>
                    <button class="btn btn-primary" id="editsVersionBtn" onclick="showEditsHistory()" style="background: #ff9800; border-color: #ff9800;">📊 Kaydedilen Sürümler (0)</button>
                    <button class="btn btn-primary" onclick="showSaveFilterDialog()">🔍 Filtreyi Kaydet</button>
                    <button class="btn btn-primary" id="report8DListBtn" onclick="show8DReportList()" style="background: #1e3c72; border-color: #1e3c72;">📋 8D Raporlar (<span id="report8DCount">0</span>)</button>
                    <button class="btn btn-primary" onclick="showDocumentMatrixModal()" style="background: #9c27b0; border-color: #9c27b0;">📊 Doküman Matrisi</button>
                    <button class="btn btn-primary" onclick="showQualityCertMatrixModal()" style="background: #00897b; border-color: #00897b;">📋 Kalite Belge Matrisi</button>
                </div>

                <!-- Çoklu Durum Değiştirme Grubu -->
                <div style="display: flex; gap: 8px; padding: 8px; background: #f3e5f5; border-radius: 8px; border: 1px solid #9c27b0; align-items: center;">
                    <span style="font-weight: 600; color: #9c27b0; font-size: 0.9em;">Seçili Satırları:</span>
                    <button class="btn btn-primary" style="background: #4caf50; border-color: #4caf50; padding: 6px 12px; font-size: 0.9em;" onclick="bulkUpdateStatus('ONAYLI')">✅ Onaylı Yap</button>
                    <button class="btn btn-primary" style="background: #ff9800; border-color: #ff9800; padding: 6px 12px; font-size: 0.9em;" onclick="bulkUpdateStatus('ONAYSIZ')">⚠️ Onaysız Yap</button>
                    <button class="btn btn-primary" style="background: #2196f3; border-color: #2196f3; padding: 6px 12px; font-size: 0.9em;" onclick="bulkUpdateStatus('MÜŞTERİ')">👤 Müşteri Yap</button>
                </div>

                <!-- Performans Raporları (Toplu) -->
                <div style="display: flex; gap: 8px; padding: 8px; background: #e8f5e9; border-radius: 8px; border: 1px solid #66bb6a; align-items: center; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #2e7d32; font-size: 0.9em;">📊 Performans Raporu (Seçili):</span>
                    <button class="btn btn-primary" style="background: #4caf50; border-color: #4caf50; padding: 6px 12px; font-size: 0.85em;" onclick="exportSelectedPerformanceReportsPDF(false)">📄 PDF (Grafiksiz)</button>
                    <button class="btn btn-primary" style="background: #2e7d32; border-color: #2e7d32; padding: 6px 12px; font-size: 0.85em;" onclick="exportSelectedPerformanceReportsPDF(true)">📄 PDF (Grafikli)</button>
                    <button class="btn btn-primary" style="background: #2196f3; border-color: #2196f3; padding: 6px 12px; font-size: 0.85em;" onclick="exportSelectedPerformanceReportsExcel(false)">📊 Excel (Grafiksiz)</button>
                    <button class="btn btn-primary" style="background: #1565c0; border-color: #1565c0; padding: 6px 12px; font-size: 0.85em;" onclick="exportSelectedPerformanceReportsExcel(true)">📊 Excel (Grafikli)</button>
                </div>
                
                <!-- Toplu Hedef Güncelleme -->
                <div style="display: flex; gap: 8px; padding: 8px; background: #e3f2fd; border-radius: 8px; border: 1px solid #2196f3; align-items: center; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #1565c0; font-size: 0.9em;">🎯 Toplu Hedef Güncelleme (Seçili):</span>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <label style="font-size: 0.85em; color: #333;">PPM Hedefi:</label>
                        <input type="number" id="bulkPPMTarget" placeholder="1000" min="0" step="100" 
                               style="width: 90px; padding: 4px 8px; border: 1px solid #2196f3; border-radius: 4px; font-size: 0.85em;">
                        <button class="btn btn-primary" style="background: #2196f3; border-color: #2196f3; padding: 6px 12px; font-size: 0.85em;" 
                                onclick="applyBulkPPMTarget()">✓ Uygula</button>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <label style="font-size: 0.85em; color: #333;">Hata Hedefi:</label>
                        <input type="number" id="bulkHataHedefi" placeholder="2" min="0" step="1" 
                               style="width: 90px; padding: 4px 8px; border: 1px solid #2196f3; border-radius: 4px; font-size: 0.85em;">
                        <button class="btn btn-primary" style="background: #2196f3; border-color: #2196f3; padding: 6px 12px; font-size: 0.85em;" 
                                onclick="applyBulkHataHedefi()">✓ Uygula</button>
                    </div>
                </div>
                
                <!-- Silme Grubu -->
                <div style="display: flex; gap: 8px; padding: 8px; background: #fdecea; border-radius: 8px; border: 1px solid #f44336; align-items: center;">
                    <button class="btn btn-primary" style="background: #f44336; border-color: #f44336;" onclick="deleteSelectedSuppliers()">🗑️ Seçili Satırları Sil</button>
                    <button class="btn btn-secondary" style="border-color: #f44336; color: #f44336; background: white;" onclick="undoDelete()">↩️ Undo</button>
                    <button class="btn btn-secondary" style="border-color: #f44336; color: #f44336; background: white;" onclick="redoDelete()">↪️ Redo</button>
                </div>
                
                <!-- Diğer İşlemler -->
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="showSupplierAnalysis()" style="background: #673ab7; color: white; border-color: #673ab7;">🔍 Tedarikçi Analizi</button>
                    <button class="btn" onclick="openExportDialog('excel')" style="background: #28a745; color: white; border-color: #28a745;">📥 Excel İndir</button>
                    <button class="btn" onclick="openExportDialog('pdf')" style="background: #dc3545; color: white; border-color: #dc3545;">📄 PDF İndir</button>
                    <button class="btn" onclick="openEvaluationProcedure()" style="background: #3f51b5; color: white; border-color: #3f51b5;">📘 Değerlendirme Prosedürü</button>
                    <button class="btn btn-secondary" id="fullscreenBtn" onclick="toggleFullscreen()">⛶ Tam Ekran</button>
                    <button class="btn btn-secondary" onclick="location.reload()">🔄 Yeni Analiz</button>
                </div>
            </div>
        </div>
        
        <div class="saved-filters-section" id="savedFiltersSection" style="display: none;">
            <div class="saved-filters-header">
                <h3>💾 Kaydedilmiş Filtreler</h3>
            </div>
            <div class="saved-filters-list" id="savedFiltersList">
                <!-- Saved filters will be populated here -->
            </div>
        </div>
        
        <div id="statsContainer"></div>
        
        <!-- Tabs for Onaylı/Onaysız -->
        <div style="background: white; border-radius: 10px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 10px;">
                <button class="tab-button active" id="tabOnayli" onclick="switchTab('ONAYLI')" 
                        style="flex: 1; padding: 12px; border: none; background: #1e3c72; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    ✓ Onaylı Tedarikçiler
                </button>
                <button class="tab-button" id="tabOnaysiz" onclick="switchTab('ONAYSIZ')" 
                        style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    ✗ Onaysız Tedarikçiler
                </button>
                <button class="tab-button" id="tabMusteri" onclick="switchTab('MÜŞTERİ')" 
                        style="flex: 1; padding: 12px; border: none; background: #e0e0e0; color: #666; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    👥 Müşteriler
                </button>
            </div>
        </div>
        
        <div id="tableContainer"></div>
    </div>

    <!-- Performans Grafik Modali -->
    <div id="performanceChartModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 1400px; width: 95%;">
            <div class="modal-header">
                <h3 id="perfChartTitle">📊 Tedarikçi Performans Grafikleri</h3>
                <button class="modal-close" onclick="closePerformanceCharts()">✕</button>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <div id="perfChartSupplierInfo" style="margin-bottom: 10px; font-weight: 600;"></div>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));">
                    <div class="stat-card" style="padding: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div class="stat-label">Aylık İade PPM Değişimi</div>
                            <button onclick="toggleModalTable('modalTablePPM')" style="padding: 4px 10px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">📊 Tablo</button>
                        </div>
                        <canvas id="chartReturnPPM" width="100%" height="180" style="width: 100%;"></canvas>
                        <div id="modalTablePPM" style="display: none; margin-top: 15px; overflow-x: auto; animation: fadeIn 0.3s;"></div>
                    </div>
                    <div class="stat-card" style="padding: 10px;">
                        <div class="stat-label">Aylık PPM Puanı</div>
                        <canvas id="chartPPMPuan" width="100%" height="180" style="width: 100%;"></canvas>
                        <div id="chart8DButtons_ppm" style="display: grid; grid-template-columns: repeat(12, 1fr); margin-top: 15px; padding-left: 130px; padding-right: 100px; gap: 0;"></div>
                    </div>
                    <div class="stat-card" style="padding: 10px;">
                        <div class="stat-label">Aylık Hata Sayısı</div>
                        <canvas id="chartDefect" width="100%" height="180" style="width: 100%;"></canvas>
                    </div>
                    <div class="stat-card hide-for-musteri" style="padding: 10px;">
                        <div class="stat-label">VDA Puanı</div>
                        <canvas id="chartVDA" width="100%" height="180" style="width: 100%;"></canvas>
                    </div>
                    <div class="stat-card hide-for-musteri" style="padding: 10px;">
                        <div class="stat-label">Kalite Belge Puanı</div>
                        <canvas id="chartQuality" width="100%" height="180" style="width: 100%;"></canvas>
                    </div>
                    <div class="stat-card" style="padding: 10px;">
                        <div class="stat-label">8D Dönüş Oranı</div>
                        <canvas id="chart8D" width="100%" height="180" style="width: 100%;"></canvas>
                    </div>
                    <div class="stat-card hide-for-musteri" style="padding: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div class="stat-label">Termin Puanı</div>
                            <button onclick="toggleModalTable('modalTableTermin')" style="padding: 4px 10px; background: #3949ab; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">📊 Tablo</button>
                        </div>
                        <canvas id="chartTermin" width="100%" height="180" style="width: 100%;"></canvas>
                        <div id="modalTableTermin" style="display: none; margin-top: 15px; overflow-x: auto; animation: fadeIn 0.3s;"></div>
                    </div>
                    <div class="stat-card hide-for-musteri" style="padding: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div class="stat-label">Tamamlanma Puanı</div>
                            <button onclick="toggleModalTable('modalTableTamamlanma')" style="padding: 4px 10px; background: #00796b; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">📊 Tablo</button>
                        </div>
                        <canvas id="chartCompletion" width="100%" height="180" style="width: 100%;"></canvas>
                        <div id="modalTableTamamlanma" style="display: none; margin-top: 15px; overflow-x: auto; animation: fadeIn 0.3s;"></div>
                    </div>
                    <div class="stat-card" style="padding: 10px;">
                        <div class="stat-label">Hata Puanı</div>
                        <canvas id="chartDefectScore" width="100%" height="180" style="width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePerformanceCharts()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Tedarikçi Değerlendirme Prosedürü -->
    <div id="evaluationProcedureModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 1400px; width: 95%;">
            <div class="modal-header">
                <h3>📘 Tedarikçi Değerlendirme Prosedürü</h3>
                <button class="modal-close" onclick="closeEvaluationProcedure()">✕</button>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <div id="evaluationProcedureSummary"></div>
                <div id="evaluationProcedureTable"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEvaluationProcedure()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Tedarikçi Analiz Modal -->
    <div id="supplierAnalysisModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 1600px; width: 95%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #673ab7 0%, #512da8 100%);">
                <h3>🔍 Tedarikçi Detaylı Analizi</h3>
                <button class="modal-close" onclick="closeSupplierAnalysis()">✕</button>
            </div>
            <div class="modal-body" style="max-height: 85vh; overflow-y: auto; padding: 25px;">
                <!-- Tedarikçi Seçimi -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 1.1em;">📌 Tedarikçi Seçin:</label>
                    <input type="text" id="analysisSupplierSearch" placeholder="🔍 Tedarikçi ara..." oninput="filterSupplierAnalysisOptions()" style="width: 100%; padding: 12px; border: 2px solid #673ab7; border-radius: 8px; font-size: 1em; margin-bottom: 10px;">
                    <select id="analysisSupplierSelect" onchange="loadSupplierAnalysis()" size="8" style="width: 100%; padding: 12px; border: 2px solid #673ab7; border-radius: 8px; font-size: 1em; background: white;">
                        <option value="">-- Tedarikçi Seçiniz --</option>
                    </select>
                </div>
                
                <!-- Analiz İçeriği -->
                <div id="supplierAnalysisContent" style="display: none;">
                    <!-- Genel Bilgiler -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #673ab7; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #673ab7; padding-bottom: 10px;">📊 Genel Bilgiler</h4>
                        <div id="analysisGeneralInfo"></div>
                    </div>
                    
                    <!-- Performans Verileri -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #673ab7; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #673ab7; padding-bottom: 10px;">📈 Performans Metrikleri</h4>
                        <div id="analysisPerformanceData"></div>
                    </div>
                    
                    <!-- Aylık Detaylar -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #673ab7; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #673ab7; padding-bottom: 10px;">📅 Aylık Veriler</h4>
                        <div id="analysisMonthlyData"></div>
                    </div>
                    
                    <!-- Performans Grafikleri -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #009688; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #009688; padding-bottom: 10px;">📊 Performans Grafikleri</h4>
                        <div id="analysisPerformanceCharts"></div>
                    </div>
                    
                    <!-- Dokümanlar ve Belgeler -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #673ab7; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #673ab7; padding-bottom: 10px;">📄 Dokümanlar & Belgeler</h4>
                        <div id="analysisDocuments"></div>
                    </div>
                    
                    <!-- Eksik/Tam Bilgiler -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: #673ab7; margin-bottom: 15px; font-size: 1.2em; border-bottom: 2px solid #673ab7; padding-bottom: 10px;">✅ Veri Tamamlama Durumu</h4>
                        <div id="analysisCompleteness"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="showPDFExportOptions()" style="background: #e53935;">📄 PDF İndir</button>
                <button class="btn btn-secondary" onclick="closeSupplierAnalysis()">Kapat</button>
            </div>
        </div>
    </div>
    
    <!-- PDF Export Seçenekleri Modal -->
    <div id="pdfExportOptionsModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10005;">
        <div class="modal-dialog" style="background: white; border-radius: 10px; max-width: 500px; width: 95%; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: #1e3c72; font-size: 1.3em; border-bottom: 2px solid #1e3c72; padding-bottom: 10px;">📄 PDF Rapor Seçenekleri</h3>
            
            <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">PDF raporunda görünmesini istediğiniz bölümleri seçin:</p>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f5f5f5; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                    <input type="checkbox" id="pdfOpt_performansMetrikleri" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 500; color: #333;">📈 Performans Metrikleri</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f5f5f5; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                    <input type="checkbox" id="pdfOpt_aylikPerformans" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 500; color: #333;">📅 Aylık Performans</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f5f5f5; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                    <input type="checkbox" id="pdfOpt_grafikVerileri" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 500; color: #333;">📊 Performans Grafik Verileri</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f5f5f5; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                    <input type="checkbox" id="pdfOpt_kaliteBelgeleri" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 500; color: #333;">📜 Kalite Belgeleri & Dokümanlar</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closePDFExportOptions()" style="padding: 10px 20px;">İptal</button>
                <button class="btn btn-primary" onclick="exportSupplierAnalysisPDFWithOptions()" style="padding: 10px 20px; background: #e53935;">📄 PDF Oluştur</button>
            </div>
        </div>
    </div>

    <!-- 8D Rapor Modali -->
    <div id="report8DModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10002;">
        <div class="modal-dialog" style="background: white; border-radius: 10px; max-width: 1400px; width: 95%; max-height: 95vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header" style="padding: 20px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                <h3 id="report8DTitle" style="margin: 0; font-size: 1.2em; font-weight: 600; color: #ffffff; letter-spacing: 0.5px;">📋 8D RAPOR - Problem Çözme Metodu</h3>
                <button onclick="close8DReportModal()" style="background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; padding: 0; width: 35px; height: 35px;">✕</button>
            </div>
            
            <div class="modal-body" style="padding: 0; overflow-y: auto; flex: 1;">
                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid #ddd; background: #f5f7fa; position: sticky; top: 0; z-index: 1; padding: 10px 10px 0 10px;">
                    <button class="tab-8d-btn active" onclick="switch8DTab('head')" data-tab="head" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">Head Data</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d1')" data-tab="d1" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D1</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d2')" data-tab="d2" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D2</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d3')" data-tab="d3" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D3</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d4')" data-tab="d4" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D4</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d5')" data-tab="d5" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D5</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d6')" data-tab="d6" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D6</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d7')" data-tab="d7" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D7</button>
                    <button class="tab-8d-btn" onclick="switch8DTab('d8')" data-tab="d8" style="flex: 1; border: none; background: #ccc; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;">D8</button>
                </div>

                <!-- Tab Content -->
                <div style="padding: 25px;">
                    <!-- Head Data Tab -->
                    <div class="tab-8d-content" data-tab-content="head" style="display: block;">
                        <h3 style="color: #1e3c72; border-bottom: 2px solid #1e3c72; padding-bottom: 10px; margin-bottom: 20px;">HEAD DATA</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">8D-Report Number</label>
                                <input type="text" id="f8d_reportNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Version</label>
                                <input type="text" id="f8d_version" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">8D-Title</label>
                                <input type="text" id="f8d_title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Start Date</label>
                                <input type="date" id="f8d_startDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Subject of Problem Solving</label>
                                <input type="text" id="f8d_subject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Current Date</label>
                                <input type="date" id="f8d_currentDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Problem Owner/Customer</label>
                                <input type="text" id="f8d_customer" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Status/Report Form</label>
                                <select id="f8d_status" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                    <option value="">Seçiniz</option>
                                    <option value="Open">Open</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Closed">Closed</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">E-Mail</label>
                                <input type="email" id="f8d_email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Phone</label>
                                <input type="tel" id="f8d_phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div style="grid-column: span 2;">
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Additional Information</label>
                                <textarea id="f8d_additionalInfo" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <!-- Preliminary Defect Information -->
                        <h3 style="color: #1e3c72; border-bottom: 2px solid #1e3c72; padding-bottom: 10px; margin-bottom: 20px; margin-top: 30px;">PRELIMINARY DEFECT INFORMATION</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Part Number</label>
                                <input type="text" id="f8d_partNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Part Name</label>
                                <input type="text" id="f8d_partName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div style="grid-column: span 2;">
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Defect Description</label>
                                <textarea id="f8d_defectDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; resize: vertical;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Defect Quantity (pcs)</label>
                                <input type="number" id="f8d_defectQuantity" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Total Checked Quantity (pcs)</label>
                                <input type="number" id="f8d_totalCheckedQuantity" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Defect Rate (%)</label>
                                <input type="number" id="f8d_defectRate" step="0.01" min="0" max="100" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; background: #f5f5f5;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Detection Point</label>
                                <select id="f8d_detectionPoint" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                    <option value="">Seçiniz</option>
                                    <option value="Incoming">Incoming</option>
                                    <option value="In-Process">In-Process</option>
                                    <option value="Final">Final</option>
                                    <option value="Customer">Customer</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Defect Photos Attachments -->
                        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #1e3c72;">
                            <h4 style="color: #1e3c72; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📎 DEFECT PHOTOS (ATTACHMENTS)
                                <span style="font-size: 0.8em; font-weight: normal; color: #666;">(Evidence of defect)</span>
                            </h4>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="file" id="headDefectPhotoInput" multiple accept="image/*,.pdf" style="display: none;" onchange="handleHeadDefectPhotos(event)">
                                <button onclick="document.getElementById('headDefectPhotoInput').click()" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">📁</span> Dosya Seç
                                </button>
                                <span style="margin-left: 10px; color: #4caf50; font-size: 0.9em; font-weight: 600;">✅ Maksimum 100 MB (Storj DCS)</span>
                            </div>
                            
                            <div id="headDefectPhotosList" style="display: grid; gap: 10px;">
                                <!-- Attachments will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- D1 Problem Solving Team -->
                    <div class="tab-8d-content" data-tab-content="d1" style="display: none;">
                        <h3 style="color: #2e7d32; border-bottom: 2px solid #2e7d32; padding-bottom: 10px; margin-bottom: 20px;">D1 - PROBLEM SOLVING TEAM</h3>
                        <div id="d1TeamMembers"></div>
                        <button onclick="addD1TeamMember()" style="margin-top: 15px; padding: 8px 16px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ Ekip Üyesi Ekle</button>
                    </div>

                    <!-- D2 Problem Description -->
                    <div class="tab-8d-content" data-tab-content="d2" style="display: none;">
                        <h3 style="color: #0277bd; border-bottom: 2px solid #0277bd; padding-bottom: 10px; margin-bottom: 20px;">D2 - PROBLEM DESCRIPTION</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Description - Symptom</label>
                                <textarea id="f8d_d2_symptom" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; resize: vertical;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Description - Problem (created by Problem Solving Team)</label>
                                <textarea id="f8d_d2_problem" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; resize: vertical;" placeholder="Including description of effects, extent of affected products, etc."></textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">More Information - Categorization (type of error)</label>
                                    <select id="f8d_d2_errorType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                        <option value="">Seçiniz</option>
                                        <option value="Quality">Quality</option>
                                        <option value="Delivery">Delivery</option>
                                        <option value="Cost">Cost</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">More Information - Categorization (error location)</label>
                                    <select id="f8d_d2_errorLocation" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                        <option value="">Seçiniz</option>
                                        <option value="Production">Production</option>
                                        <option value="Assembly">Assembly</option>
                                        <option value="Testing">Testing</option>
                                        <option value="Packaging">Packaging</option>
                                        <option value="Logistics">Logistics</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Risk Assessment started/updated?</label>
                                    <select id="f8d_d2_riskAssessment" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                        <option value="">Seçiniz</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Date</label>
                                    <input type="date" id="f8d_d2_riskDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- D2 Attachments Section -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #0277bd;">
                            <h4 style="color: #0277bd; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📎 APPEND ATTACHMENTS
                                <span style="font-size: 0.8em; font-weight: normal; color: #666;">(Supporting documents)</span>
                            </h4>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="file" id="d2AttachmentInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" onchange="handleD2Attachments(event)">
                                <button onclick="document.getElementById('d2AttachmentInput').click()" style="padding: 10px 20px; background: #0277bd; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">📁</span> Dosya Seç
                                </button>
                                <span style="margin-left: 10px; color: #4caf50; font-size: 0.9em; font-weight: 600;">✅ Maksimum 100 MB (Storj DCS)</span>
                            </div>
                            
                            <div id="d2AttachmentsList" style="display: grid; gap: 10px;">
                                <!-- Attachments will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- D3 Containment Actions -->
                    <div class="tab-8d-content" data-tab-content="d3" style="display: none;">
                        <h3 style="color: #f57c00; border-bottom: 2px solid #f57c00; padding-bottom: 10px; margin-bottom: 20px;">D3 - CONTAINMENT ACTIONS</h3>
                        <div id="d3ContainmentActions"></div>
                        <button onclick="addD3Action()" style="margin-top: 15px; padding: 8px 16px; background: #f57c00; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ Eylem Ekle</button>
                    </div>

                    <!-- D4 Root Cause Analysis -->
                    <div class="tab-8d-content" data-tab-content="d4" style="display: none;">
                        <h3 style="color: #c62828; border-bottom: 2px solid #c62828; padding-bottom: 10px; margin-bottom: 20px;">D4 - ROOT CAUSE ANALYSIS</h3>
                        <div id="d4RootCauses"></div>
                        <button onclick="addD4RootCause('tco')" style="margin: 15px 5px 5px 0; padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ TCO Ekle</button>
                        <button onclick="addD4RootCause('tcn')" style="margin: 15px 5px 5px 0; padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ TCN Ekle</button>
                        <button onclick="addD4RootCause('sco')" style="margin: 15px 5px 5px 0; padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ SCO Ekle</button>
                        <button onclick="addD4RootCause('scn')" style="margin: 15px 5px 5px 0; padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ SCN Ekle</button>
                    </div>

                    <!-- D5 Selection and Verification -->
                    <div class="tab-8d-content" data-tab-content="d5" style="display: none;">
                        <h3 style="color: #6a1b9a; border-bottom: 2px solid #6a1b9a; padding-bottom: 10px; margin-bottom: 20px;">D5 - SELECTION AND VERIFICATION OF CORRECTIVE ACTIONS</h3>
                        <div id="d5CorrectiveActions"></div>
                        <button onclick="addD5Action()" style="margin-top: 15px; padding: 8px 16px; background: #6a1b9a; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ Düzeltici Eylem Ekle</button>
                        
                        <!-- D5 Attachments Section -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #6a1b9a;">
                            <h4 style="color: #6a1b9a; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📎 APPEND ATTACHMENTS
                                <span style="font-size: 0.8em; font-weight: normal; color: #666;">(Verification documents)</span>
                            </h4>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="file" id="d5AttachmentInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" onchange="handleD5Attachments(event)">
                                <button onclick="document.getElementById('d5AttachmentInput').click()" style="padding: 10px 20px; background: #6a1b9a; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">📁</span> Dosya Seç
                                </button>
                                <span style="margin-left: 10px; color: #4caf50; font-size: 0.9em; font-weight: 600;">✅ Maksimum 100 MB (Storj DCS)</span>
                            </div>
                            
                            <div id="d5AttachmentsList" style="display: grid; gap: 10px;">
                                <!-- Attachments will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- D6 Implementation -->
                    <div class="tab-8d-content" data-tab-content="d6" style="display: none;">
                        <h3 style="color: #00695c; border-bottom: 2px solid #00695c; padding-bottom: 10px; margin-bottom: 20px;">D6 - IMPLEMENTATION AND VALIDATION OF CORRECTIVE ACTIONS</h3>
                        <div id="d6Implementations"></div>
                        <button onclick="addD6Implementation()" style="margin-top: 15px; padding: 8px 16px; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ Uygulama Ekle</button>
                        
                        <!-- D6 Attachments Section -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #00695c;">
                            <h4 style="color: #00695c; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📎 APPEND ATTACHMENTS
                                <span style="font-size: 0.8em; font-weight: normal; color: #666;">(Implementation evidence)</span>
                            </h4>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="file" id="d6AttachmentInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" onchange="handleD6Attachments(event)">
                                <button onclick="document.getElementById('d6AttachmentInput').click()" style="padding: 10px 20px; background: #00695c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">📁</span> Dosya Seç
                                </button>
                                <span style="margin-left: 10px; color: #4caf50; font-size: 0.9em; font-weight: 600;">✅ Maksimum 100 MB (Storj DCS)</span>
                            </div>
                            
                            <div id="d6AttachmentsList" style="display: grid; gap: 10px;">
                                <!-- Attachments will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- D7 Prevention -->
                    <div class="tab-8d-content" data-tab-content="d7" style="display: none;">
                        <h3 style="color: #01579b; border-bottom: 2px solid #01579b; padding-bottom: 10px; margin-bottom: 20px;">D7 - PREVENTION OF REOCCURRENCE</h3>
                        <div id="d7Preventions"></div>
                        <button onclick="addD7Prevention()" style="margin-top: 15px; padding: 8px 16px; background: #01579b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">+ Önleme Eylemi Ekle</button>
                        
                        <!-- D7 Attachments Section -->
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #01579b;">
                            <h4 style="color: #01579b; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📎 APPEND ATTACHMENTS
                                <span style="font-size: 0.8em; font-weight: normal; color: #666;">(Proof of applicability)</span>
                            </h4>
                            
                            <div style="margin-bottom: 15px;">
                                <input type="file" id="d7AttachmentInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" onchange="handleD7Attachments(event)">
                                <button onclick="document.getElementById('d7AttachmentInput').click()" style="padding: 10px 20px; background: #01579b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">📁</span> Dosya Seç
                                </button>
                                <span style="margin-left: 10px; color: #4caf50; font-size: 0.9em; font-weight: 600;">✅ Maksimum 100 MB (Storj DCS)</span>
                            </div>
                            
                            <div id="d7AttachmentsList" style="display: grid; gap: 10px;">
                                <!-- Attachments will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- D8 Conclusion -->
                    <div class="tab-8d-content" data-tab-content="d8" style="display: none;">
                        <h3 style="color: #558b2f; border-bottom: 2px solid #558b2f; padding-bottom: 10px; margin-bottom: 20px;">D8 - CONCLUSION AND APPRECIATION OF THE TEAM'S SUCCESS</h3>
                        <div style="display: grid; gap: 15px;">
                            <div id="d8Participants"></div>
                            <button onclick="addD8Participant()" style="margin-bottom: 15px; padding: 8px 16px; background: #558b2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: fit-content;">+ Katılımcı Ekle</button>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Result 8D Assessment</label>
                                <textarea id="f8d_d8_result" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; resize: vertical;"></textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">8D Assessment carried out by</label>
                                    <input type="text" id="f8d_d8_assessmentBy" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Date of the Final Meeting (Optional)</label>
                                    <input type="date" id="f8d_d8_finalMeetingDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">8D Assessment performed on</label>
                                <input type="date" id="f8d_d8_performedOn" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #333;">Results of the Final Discussion (Optional)</label>
                                <textarea id="f8d_d8_finalDiscussion" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95em; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 15px; border-top: 2px solid #ddd; display: flex; justify-content: space-between; gap: 10px; background: #f5f7fa;">
                <!-- Bildirim kutusu (gizli) -->
                <div id="modal8DNotification" style="display: none; position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #ff9800; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10001; font-weight: 600; font-size: 16px;">
                    🔔 Rapor güncellendi!
                </div>
                
                <!-- Senkronizasyon durumu göstergesi -->
                <div id="syncStatusIndicator" style="display: none; position: absolute; bottom: 80px; left: 20px; background: rgba(33, 150, 243, 0.95); color: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 0.85em; font-weight: 600;">
                    <span id="syncStatusIcon">🔄</span>
                    <span id="syncStatusText">Otomatik senkronizasyon aktif (5s)</span>
                    <span id="syncLastUpdate" style="display: block; font-size: 0.75em; opacity: 0.9; margin-top: 3px;"></span>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="export8DReportPDF()" style="padding: 10px 20px; background: #e53935; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95em;">📄 PDF Export</button>
                    <button onclick="send8DReportEmail()" id="sendEmail8DBtn" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95em;">📧 Mail Gönder</button>
                    <button onclick="share8DReport()" id="share8DBtn" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95em;">🔗 Paylaş</button>
                    <button onclick="manualSync8D()" id="sync8DBtn" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95em; display: block;">🔄 Senkronize</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="close8DReportModal()" style="padding: 10px 20px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: 600;">İptal</button>
                    <button onclick="save8DReport()" id="save8DBtn" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95em;">💾 Kaydet</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Doküman Yönetim Modali -->
    <div id="documentModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000;">
        <div class="modal-dialog" style="background: white; border-radius: 10px; max-width: 1200px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header" style="padding: 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                <h3 id="docModalTitle" style="margin: 0; font-size: 1.3em;">📄 Doküman Yönetimi</h3>
                <button onclick="closeDocumentModal()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px;">✕</button>
            </div>
            
            <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 20px;">
                <div style="display: flex; gap: 20px;">
                    <!-- Sol: Dokümanlar Listesi -->
                    <div style="flex: 1; min-width: 300px;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">Dokümanlar</h4>
                        <div id="documentsList" style="border: 1px solid #ddd; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                            <!-- Dinamik olarak doldurulacak -->
                        </div>
                    </div>
                    
                    <!-- Sağ: Upload Alanı -->
                    <div style="flex: 1; min-width: 300px;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">Doküman Yükle</h4>
                        <div style="border: 2px dashed #2196F3; border-radius: 8px; padding: 20px; text-align: center; background: #f0f8ff;">
                            <div id="documentUploadArea" style="cursor: pointer; padding: 20px;">
                                <div style="font-size: 2em; margin-bottom: 10px;">📁</div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Doküman Seç</div>
                                <div style="font-size: 0.85em; color: #666;">Tıklayın veya sürükleyin</div>
                                <input type="file" id="documentFileInput" style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                            </div>
                            <select id="documentTypeSelect" style="width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                <option value="">Doküman Türü Seç</option>
                                <option value="TDS">TDS</option>
                                <option value="MSDS">MSDS</option>
                                <option value="ROHS">ROHS</option>
                                <option value="REACH">REACH</option>
                                <option value="Sözleşme">Sözleşme</option>
                                <option value="COA">COA</option>
                                <option value="VDA Denetim">VDA Denetim</option>
                                <option value="Tedarikçi Bilgi ve Özdeğerlendirme">Tedarikçi Bilgi ve Özdeğerlendirme</option>
                                <option value="Tedarikçi Sorumluluk Kuralları">Tedarikçi Sorumluluk Kuralları</option>
                                <option value="PPAP Onayı">PPAP Onayı</option>
                            </select>
                            <textarea id="documentDescInput" placeholder="Doküman açıklaması (isteğe bağlı)" style="width: 100%; padding: 8px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; resize: vertical; min-height: 60px; font-family: inherit;"></textarea>
                            <button id="uploadDocBtn" style="width: 100%; margin-top: 10px; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.95em;">
                                📤 Yükle
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Alt: Diğer Tedarikçilerden Custom Türler -->
                <div id="availableCustomTypes" style="display: none;">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; gap: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button id="saveChangesBtn" onclick="saveAndShareDocumentChanges()" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px;">
                        <span>💾</span> Değişiklikleri Kaydet ve Paylaş
                    </button>
                    <button id="initialShareBtn" onclick="shareSupplierDocuments()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        <span>🔗</span> İlk Paylaşım Yap
                    </button>
                    <button id="syncDocumentsBtn" onclick="syncSupplierDocumentsFromStorj()" data-supplier="" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px;">
                        <span>🔄</span> Senkronize Et
                    </button>
                    <button id="sendDocMailBtn" onclick="sendDocumentShareEmailFromModal()" style="padding: 10px 20px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px;">
                        <span>📧</span> Mail Gönder
                    </button>
                </div>
                <button onclick="closeDocumentModal()" style="padding: 8px 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Save Filter Dialog -->
    <!-- Tedarikçi Bilgileri Modali -->
    <div id="supplierInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 1200px; width: 95%; max-height: 85vh; overflow: auto;">
            <div class="modal-header">
                <h3 id="supplierInfoTitle">🧾 Tedarikçi Bilgileri</h3>
                <button class="modal-close" onclick="closeSupplierInfoModal()">✕</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div style="grid-column: span 3;">
                        <label>Malzeme(ler)</label>
                        <input type="text" id="infoMaterial" class="filter-name-input" placeholder="Malzeme(ler)" />
                    </div>
                    <div style="grid-column: span 3;">
                        <label>Üretici/Satıcı</label>
                        <select id="infoType" class="filter-name-input">
                            <option value="">Seçiniz</option>
                            <option value="Üretici">Üretici</option>
                            <option value="Satıcı">Satıcı</option>
                            <option value="Üretici+Satıcı">Üretici + Satıcı</option>
                        </select>
                    </div>
                    <div style="grid-column: span 3;">
                        <label>Müşteri(ler)</label>
                        <input type="text" id="infoCustomers" class="filter-name-input" placeholder="Müşteri(ler)" />
                    </div>
                    <div>
                        <label>Sorumlu Kişi</label>
                        <input type="text" id="infoPrimaryName" class="filter-name-input" placeholder="Ad Soyad" />
                    </div>
                    <div>
                        <label>Ünvan</label>
                        <input type="text" id="infoTitle" class="filter-name-input" placeholder="Ünvan" />
                    </div>
                    <div>
                        <label>E-posta</label>
                        <input type="email" id="infoPrimaryEmail" class="filter-name-input" placeholder="email@firma.com" />
                    </div>
                    <div>
                        <label>GSM</label>
                        <input type="text" id="infoGsm" class="filter-name-input" placeholder="0(5xx) xxx xx xx" />
                    </div>
                    <div>
                        <label>Telefon2</label>
                        <input type="text" id="infoPhone2" class="filter-name-input" placeholder="Telefon 2" />
                    </div>
                    <div>
                        <label>Dahili</label>
                        <input type="text" id="infoExtension" class="filter-name-input" placeholder="Dahili" />
                    </div>
                    <div>
                        <label>Sorumlu Yedek Kişi</label>
                        <input type="text" id="infoBackupName" class="filter-name-input" placeholder="Ad Soyad" />
                    </div>
                    <div>
                        <label>Ünvan</label>
                        <input type="text" id="infoBackupTitle" class="filter-name-input" placeholder="Ünvan" />
                    </div>
                    <div>
                        <label>E-posta</label>
                        <input type="email" id="infoBackupEmail" class="filter-name-input" placeholder="email@firma.com" />
                    </div>
                    <div>
                        <label>GSM</label>
                        <input type="text" id="infoBackupGsm" class="filter-name-input" placeholder="0(5xx) xxx xx xx" />
                    </div>
                    <div>
                        <label>Telefon2</label>
                        <input type="text" id="infoBackupPhone2" class="filter-name-input" placeholder="Telefon 2" />
                    </div>
                    <div>
                        <label>Dahili</label>
                        <input type="text" id="infoBackupExtension" class="filter-name-input" placeholder="Dahili" />
                    </div>
                    <div style="grid-column: span 3;">
                        <label>Adres</label>
                        <textarea id="infoAddress" class="filter-name-input" rows="3" placeholder="Adres"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSupplierInfoModal()">Kapat</button>
                <button class="btn btn-primary" onclick="saveSupplierInfo()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Document Matrix Modal -->
    <div id="documentMatrixModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="width: 95%; max-width: 1600px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white;">
                <h3 style="margin: 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                    📊 Tedarikçi Doküman Matrisi
                    <span style="font-size: 0.7em; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;" id="matrixSupplierCount">0 Tedarikçi</span>
                </h3>
                <button class="modal-close" onclick="closeDocumentMatrixModal()" style="color: white;">✕</button>
            </div>
            <div class="modal-body" style="padding: 0; overflow: auto; max-height: calc(90vh - 120px);">
                <div id="documentMatrixContent" style="padding: 20px;">
                    <!-- Matrix content will be generated here -->
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="exportDocumentMatrixPDF()" style="background: #f44336; border-color: #f44336;">📄 PDF İndir</button>
                    <button class="btn btn-primary" onclick="exportDocumentMatrixExcel()" style="background: #4caf50; border-color: #4caf50;">📊 Excel İndir</button>
                </div>
                <button class="btn btn-secondary" onclick="closeDocumentMatrixModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Kalite Belge Matrisi Modal -->
    <div id="qualityCertMatrixModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="width: 95%; max-width: 1600px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #00897b 0%, #00695c 100%); color: white;">
                <h3 style="margin: 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                    📋 Kalite Belge Matrisi
                    <span style="font-size: 0.7em; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;" id="qcMatrixSupplierCount">0 Tedarikçi</span>
                </h3>
                <button class="modal-close" onclick="closeQualityCertMatrixModal()" style="color: white;">✕</button>
            </div>
            <div class="modal-body" style="padding: 0; overflow: auto; max-height: calc(90vh - 120px);">
                <div id="qualityCertMatrixContent" style="padding: 20px;">
                    <!-- Matrix content will be generated here -->
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="exportQualityCertMatrixPDF()" style="background: #f44336; border-color: #f44336;">📄 PDF İndir</button>
                    <button class="btn btn-primary" onclick="exportQualityCertMatrixExcel()" style="background: #4caf50; border-color: #4caf50;">📊 Excel İndir</button>
                </div>
                <button class="btn btn-secondary" onclick="closeQualityCertMatrixModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Settings Dialog -->
    <div id="settingsDialog" class="modal-overlay" style="display: none;">
        <div class="modal-dialog modal-dialog-large" style="max-width: 1000px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); color: white; flex-shrink: 0;">
                <h3>⚙️ Ayarlar & Veritabanı Durumu</h3>
                <button class="modal-close" onclick="closeSettingsDialog()" style="color: white;">✕</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- IndexedDB Bağlantı Durumu -->
                <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #1e3c72; border-bottom: 2px solid #1e3c72; padding-bottom: 8px;">
                        🗄️ IndexedDB Bağlantı Durumu
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #4caf50;">
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Bağlantı Durumu</div>
                            <div id="dbStatus" style="font-size: 1.2em; font-weight: bold; color: #4caf50;">
                                ⏳ Kontrol ediliyor...
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #2196f3;">
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Veritabanı Adı</div>
                            <div id="dbName" style="font-size: 1.1em; font-weight: 600; color: #1e3c72;">
                                -
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800;">
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Kayıtlı Sürüm Sayısı</div>
                            <div id="dbRecordCount" style="font-size: 1.3em; font-weight: bold; color: #ff9800;">
                                -
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #9c27b0;">
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Toplam Veri Boyutu</div>
                            <div id="dbTotalSize" style="font-size: 1.1em; font-weight: bold; color: #9c27b0;">
                                -
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test & Kontrol Butonları -->
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="testDatabaseConnection()" style="background: #4caf50; border-color: #4caf50;">
                            🔄 Bağlantıyı Test Et
                        </button>
                        <button class="btn btn-primary" onclick="refreshDatabaseStats()" style="background: #2196f3; border-color: #2196f3;">
                            📊 İstatistikleri Yenile
                        </button>
                        <button class="btn btn-secondary" onclick="clearAllEdits()" style="background: #f44336; color: white; border-color: #f44336;">
                            🗑️ Tüm Verileri Temizle
                        </button>
                    </div>
                    
                    <!-- Bağlantı Sorun Giderme Butonları (dinamik) -->
                    <div id="dbTroubleshootButtons" style="margin-top: 10px; display: none; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="reconnectDatabase()" style="background: #ff9800; border-color: #ff9800;">
                            🔌 Yeniden Bağlan
                        </button>
                        <button class="btn btn-primary" onclick="repairDatabase()" style="background: #9c27b0; color: white; border-color: #9c27b0;">
                            🔧 Veritabanını Onar
                        </button>
                    </div>
                    
                    <!-- Bağlantı Uyarısı (dinamik) -->
                    <div id="dbWarningMessage" style="margin-top: 10px; display: none; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                        <strong>⚠️ Bağlantı Sorunu:</strong> 
                        <span id="dbWarningText">Veritabanı bağlantısı kurulamadı.</span>
                        <div style="margin-top: 5px; font-size: 0.9em; color: #856404;">
                            Yukarıdaki "Yeniden Bağlan" veya "Veritabanını Onar" butonlarını kullanarak sorunu giderebilirsiniz.
                        </div>
                    </div>
                </div>
                
                <!-- Sistem Bilgileri -->
                <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #1e3c72; border-bottom: 2px solid #1e3c72; padding-bottom: 8px;">
                        💻 Sistem Bilgileri
                    </h4>
                    <div style="margin-top: 12px; font-size: 0.95em; line-height: 1.8;">
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                            <span style="color: #666;">Tarayıcı:</span>
                            <span id="browserInfo" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                            <span style="color: #666;">IndexedDB Desteği:</span>
                            <span id="indexedDBSupport" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                            <span style="color: #666;">Yüklü Tedarikçi Sayısı:</span>
                            <span id="loadedSuppliers" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                            <span style="color: #666;">Kayıtlı Durum Eşleştirmesi:</span>
                            <span id="statusMapCount" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                            <span style="color: #666;">Kayıtlı Lokasyonlar:</span>
                            <span id="locationStoreCount" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                            <span style="color: #666;">Son Lokasyon Kaydı:</span>
                            <span id="locationLastUpdate" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-top: 6px;">
                            <span style="color: #666;">Kayıtlı Dokümanlar:</span>
                            <span id="documentStoreCount" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px;">
                            <span style="color: #666;">Son Doküman Kaydı:</span>
                            <span id="documentLastUpdate" style="font-weight: 600; color: #1e3c72;">-</span>
                        </div>
                    </div>
                    
                    <!-- Durum Temizleme Butonu -->
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="clearSupplierStatusMap()" style="background: #ff9800; color: white; border-color: #ff9800; flex: 1;">
                            🔄 Durum Eşleştirmelerini Sıfırla
                        </button>
                        <button class="btn btn-secondary" onclick="showStatusChangeHistory()" style="background: #9c27b0; color: white; border-color: #9c27b0; flex: 1;">
                            📜 Değişiklik Geçmişi
                        </button>
                    </div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px; text-align: center;">
                        Tüm durum değişiklikleri saklanır (sınırsız)
                    </div>
                </div>
                
                <!-- Veri Sıfırlama Seçenekleri -->
                <div style="padding: 15px; background: #ffebee; border-radius: 8px; border: 2px solid #f44336; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #c62828; border-bottom: 2px solid #f44336; padding-bottom: 8px;">
                        🗑️ Veri Sıfırlama İşlemleri
                    </h4>
                    <div style="color: #c62828; font-size: 0.9em; margin-bottom: 12px;">
                        <strong>⚠️ UYARI:</strong> Sıfırlama işlemleri geri alınamaz! Önemli verilerinizi yedekleyin.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px;">
                        <!-- Lokasyon Verilerini Sıfırla -->
                        <div style="background: white; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 3px;">📍 Lokasyon Verilerini Sıfırla</div>
                                <div style="font-size: 0.85em; color: #666;">Tüm tedarikçilerin lokasyon bilgilerini siler</div>
                            </div>
                            <button class="btn btn-secondary" onclick="clearLocationData()" style="background: #ff9800; color: white; border-color: #ff9800; white-space: nowrap;">
                                🗑️ Sıfırla
                            </button>
                        </div>
                        
                        <!-- Doküman Verilerini Sıfırla -->
                        <div style="background: white; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 3px;">📄 Doküman Verilerini Sıfırla</div>
                                <div style="font-size: 0.85em; color: #666;">Tüm tedarikçilerin dokümanlarını siler</div>
                            </div>
                            <button class="btn btn-secondary" onclick="clearDocumentData()" style="background: #ff9800; color: white; border-color: #ff9800; white-space: nowrap;">
                                🗑️ Sıfırla
                            </button>
                        </div>
                        
                        <!-- Tedarikçi Durum Verilerini Sıfırla -->
                        <div style="background: white; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 3px;">✅ Onaylı/Onaysız/Müşteri Verilerini Sıfırla</div>
                                <div style="font-size: 0.85em; color: #666;">Tedarikçi durum eşleştirmelerini siler</div>
                            </div>
                            <button class="btn btn-secondary" onclick="clearSupplierStatusMap()" style="background: #ff9800; color: white; border-color: #ff9800; white-space: nowrap;">
                                🗑️ Sıfırla
                            </button>
                        </div>
                        
                        <!-- JSONBin API Ayarları -->
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 8px;">🔗 8D Paylaşım Ayarları (JSONBin.io)</div>
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Tedarikçilerle 8D rapor paylaşımı için API key gereklidir</div>
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85em; color: #2e7d32; border: 1px solid #4caf50;">
                                <strong>🆓 TAMAMEN ÜCRETSİZ & OPEN SOURCE ALTERNATİFLER:</strong>
                                <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                                    <li><a href="https://getpantry.cloud" target="_blank" style="color: #1976d2; font-weight: 600;">Pantry</a> - 100% ücretsiz, API key gerekmez, limitsiz! (EN İYİ)</li>
                                    <li><a href="https://gist.github.com" target="_blank" style="color: #1976d2; font-weight: 600;">GitHub Gist</a> - GitHub hesabı ile ücretsiz</li>
                                    <li><s>JSONbox.io</s> - Artık kapalı</li>
                                </ul>
                                <div style="background: #fff9c4; padding: 6px; border-radius: 3px; margin-top: 6px; font-size: 0.9em; color: #f57f17;">
                                    💡 <strong>Tavsiye:</strong> Pantry kullanın - API key yok, limit yok, CORS destekli!
                                </div>
                            </div>
                            <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85em; color: #856404; border: 1px solid #ffc107;">
                                <strong>⚠️ JSONBin.io Limiti:</strong> Ücretsiz hesap max 100kb destekler. Büyük dosyalar için yukarıdaki alternatifleri kullanın.
                            </div>
                            
                            <!-- API Key Alma Talimatları -->
                            <details style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #2196f3;">
                                <summary style="cursor: pointer; font-weight: 600; color: #1976d2;">📝 API Key Nasıl Alınır?</summary>
                                <ol style="margin: 10px 0 0 20px; line-height: 1.8; font-size: 0.9em; color: #555;">
                                    <li><a href="https://jsonbin.io" target="_blank" style="color: #2196f3; font-weight: 600;">jsonbin.io</a> adresine git</li>
                                    <li>Üst sağdan <strong>Sign Up</strong> ile ücretsiz kayıt ol</li>
                                    <li>Email doğrulama yap ve giriş yap</li>
                                    <li>Dashboard → <strong>API Keys</strong> sekmesine tıkla</li>
                                    <li><strong>Create Access Key</strong> butonuna tıkla</li>
                                    <li>Key name yaz (örn: "8D Reports") ve <strong>Create</strong></li>
                                    <li>Oluşan key'i kopyala (<strong>$2b$10$...</strong> formatında olmalı)</li>
                                    <li>Aşağıdaki kutucuğa yapıştır ve kaydet</li>
                                </ol>
                                <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.85em; color: #856404;">
                                    <strong>⚠️ DİKKAT:</strong> API Key <code style="background: #fff; padding: 2px 4px; border-radius: 2px;">$2b$10$...</code> ile başlamalıdır. Bu uzun bir string'dir (~100 karakter).
                                </div>
                            </details>
                            
                            </div>
                            
                            <!-- Servis Seçimi -->
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 8px;">📡 Paylaşım Servisi Seçin:</div>
                                <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                    <input type="radio" name="shareService" value="jsonbin" onchange="toggle8DServiceSettings()"> 
                                    <strong>JSONBin.io</strong> - API Key gerekli, 100kb limit
                                </label>
                                <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                    <input type="radio" name="shareService" value="pantry" checked onchange="toggle8DServiceSettings()"> 
                                    <strong style="color: #4caf50;">Pantry</strong> - API Key gerekmez, LİMİTSİZ! (Önerilen)
                                </label>
                                <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                    <input type="radio" name="shareService" value="gist" onchange="toggle8DServiceSettings()"> 
                                    <strong style="color: #6a1b9a;">GitHub Gists</strong> - Token gerekli, 100 MB limit
                                </label>
                                <label style="display: block; cursor: pointer;">
                                    <input type="radio" name="shareService" value="storj" onchange="toggle8DServiceSettings()"> 
                                    <strong style="color: #00a1ff;">Storj DCS</strong> - S3-compatible, 25 GB ücretsiz! 🚀
                                </label>
                            </div>
                            
                            <!-- JSONBin API Key Girişi (sadece JSONBin seçiliyse) -->
                            <div id="jsonbinSettings" style="display: block;">
                            <input type="password" id="jsonbinApiKey" placeholder="$2b$10$... ile başlayan API Key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; margin-bottom: 6px; font-size: 0.85em;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="saveJsonBinApiKey()" class="btn btn-primary" style="flex: 1; background: #4caf50; border-color: #4caf50;">💾 Kaydet</button>
                                <button onclick="testJsonBinConnection()" class="btn btn-secondary" style="flex: 1; background: #2196f3; border-color: #2196f3; color: white;">🔍 Test Et</button>
                            </div>
                            </div>
                            
                            <!-- Pantry Test (sadece Pantry seçiliyse) -->
                            <div id="pantrySettings" style="display: none;">
                                <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #4caf50;">
                                    <div style="font-size: 0.9em; color: #2e7d32; line-height: 1.6;">
                                        <strong>✅ Pantry</strong> ücretsiz ve API key gerektirmez!<br>
                                        Sadece bir Pantry ID almanız yeterli.
                                    </div>
                                </div>
                                
                                <!-- Pantry ID Alma Talimatları -->
                                <details style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #2196f3;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #1976d2;">📝 Pantry ID Nasıl Alınır? (2 dakika)</summary>
                                    <ol style="margin: 10px 0 0 20px; line-height: 1.8; font-size: 0.9em; color: #555;">
                                        <li><a href="https://getpantry.cloud" target="_blank" style="color: #2196f3; font-weight: 600;">getpantry.cloud</a> adresine git</li>
                                        <li><strong>"Get Your Pantry"</strong> butonuna tıkla</li>
                                        <li>Açılan sayfada <strong>PantryID</strong> otomatik oluşturulur</li>
                                        <li>UUID formatında ID'yi kopyala (örn: <code style="background: #fff; padding: 2px 4px;">abc123-def456-...</code>)</li>
                                        <li>Aşağıdaki kutucuğa yapıştır ve kaydet</li>
                                    </ol>
                                    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.85em; color: #856404;">
                                        <strong>⚠️ ÖNEMLİ:</strong> Pantry ID'nizi saklamayı unutmayın! Farklı bilgisayarlarda aynı ID'yi kullanabilirsiniz.
                                    </div>
                                </details>
                                
                                <input type="text" id="pantryId" placeholder="Pantry ID (UUID formatında)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; margin-bottom: 6px; font-size: 0.85em;">
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <button onclick="savePantryId()" class="btn btn-primary" style="flex: 1; background: #4caf50; border-color: #4caf50;">💾 Kaydet</button>
                                    <button onclick="testPantryConnection()" class="btn btn-secondary" style="flex: 1; background: #2196f3; border-color: #2196f3; color: white;">🔍 Test Et</button>
                                </div>
                                <div style="font-size: 0.85em; color: #666; text-align: center;">
                                    Pantry ID'niz yok mu? <a href="https://getpantry.cloud" target="_blank" style="color: #2196f3; font-weight: 600;">Buradan ücretsiz alın!</a>
                                </div>
                            </div>
                            
                            <!-- GitHub Gists Ayarları (sadece Gist seçiliyse) -->
                            <div id="gistSettings" style="display: none;">
                                <div style="background: #f3e5f5; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #9c27b0;">
                                    <div style="font-size: 0.9em; color: #6a1b9a; line-height: 1.6;">
                                        <strong>✅ GitHub Gists</strong> büyük dosyalar için idealdir!<br>
                                        100 MB/dosya limiti vardır.
                                    </div>
                                </div>
                                
                                <!-- GitHub Token Alma Talimatları -->
                                <details style="background: #e8eaf6; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #5c6bc0;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #3f51b5;">📝 GitHub Token Nasıl Alınır? (3 dakika)</summary>
                                    <ol style="margin: 10px 0 0 20px; line-height: 1.8; font-size: 0.9em; color: #555;">
                                        <li><a href="https://github.com/settings/tokens/new" target="_blank" style="color: #5c6bc0; font-weight: 600;">github.com/settings/tokens/new</a> adresine git</li>
                                        <li><strong>Note:</strong> "8D Report Sharing" gibi bir isim ver</li>
                                        <li><strong>Expiration:</strong> "No expiration" veya istediğin süre seç</li>
                                        <li><strong>Scopes:</strong> Sadece <code style="background: #fff; padding: 2px 4px;">gist</code> yetkisini işaretle</li>
                                        <li><strong>"Generate token"</strong> butonuna tıkla</li>
                                        <li>Oluşan token'ı kopyala (örn: <code style="background: #fff; padding: 2px 4px;">ghp_abc123...</code>)</li>
                                        <li>Aşağıdaki kutucuğa yapıştır ve kaydet</li>
                                    </ol>
                                    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.85em; color: #856404;">
                                        <strong>⚠️ ÖNEMLİ:</strong> Token'ı saklamayı unutmayın! Sayfayı kapatınca bir daha göremezsiniz.
                                    </div>
                                </details>
                                
                                <input type="password" id="githubToken" placeholder="GitHub Personal Access Token (ghp_ ile başlayan)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; margin-bottom: 6px; font-size: 0.85em;">
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <button onclick="saveGitHubToken()" class="btn btn-primary" style="flex: 1; background: #6a1b9a; border-color: #6a1b9a;">💾 Kaydet</button>
                                    <button onclick="testGitHubConnection()" class="btn btn-secondary" style="flex: 1; background: #5c6bc0; border-color: #5c6bc0; color: white;">🔍 Test Et</button>
                                </div>
                                <div style="font-size: 0.85em; color: #666; text-align: center;">
                                    Token'ınız yok mu? <a href="https://github.com/settings/tokens/new" target="_blank" style="color: #6a1b9a; font-weight: 600;">Buradan ücretsiz alın!</a>
                                </div>
                            </div>
                            
                            <!-- Storj DCS Ayarları (sadece Storj seçiliyse) -->
                            <div id="storjSettings" style="display: none;">
                                <div style="background: #e3f5ff; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #00a1ff;">
                                    <div style="font-size: 0.9em; color: #005f8f; line-height: 1.6;">
                                        <strong>🚀 Storj DCS</strong> dağıtık, şifreli depolama!<br>
                                        <strong>✅ 25 GB</strong> ücretsiz depolama + <strong>150 GB/ay</strong> transfer<br>
                                        <strong>✅ Kredi kartı gerektirmez</strong>
                                    </div>
                                </div>
                                
                                <!-- Storj Kurulum Talimatları -->
                                <details style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #2196f3;">
                                    <summary style="cursor: pointer; font-weight: 600; color: #1976d2;">📝 Storj DCS Kurulumu (5 dakika)</summary>
                                    <ol style="margin: 10px 0 0 20px; line-height: 1.8; font-size: 0.9em; color: #555;">
                                        <li><a href="https://www.storj.io/signup" target="_blank" style="color: #00a1ff; font-weight: 600;">storj.io/signup</a> adresine git ve ücretsiz hesap aç (sadece email)</li>
                                        <li>Email onayı yap ve giriş yap</li>
                                        <li>Dashboard'dan <strong>Browse → Buckets → New Bucket</strong> tıkla</li>
                                        <li>Bucket adı gir (örn: <code style="background: #fff; padding: 2px 4px;">8d-reports</code>) ve oluştur</li>
                                        <li><strong>Access → Create Access Grant → S3 Credentials</strong> seç</li>
                                        <li><strong>Access Key</strong> ve <strong>Secret Key</strong> oluştur ve kopyala</li>
                                        <li><strong>Endpoint:</strong> <code style="background: #fff; padding: 2px 4px;">gateway.storjshare.io</code> kullan</li>
                                        <li>Aşağıdaki bilgileri doldur ve kaydet</li>
                                    </ol>
                                    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.85em; color: #856404;">
                                        <strong>⚠️ ÖNEMLİ:</strong> Secret Key'i bir daha göremezsiniz, güvenli bir yere kaydedin!
                                    </div>
                                </details>
                                
                                <input type="text" id="storjAccessKey" placeholder="Access Key (örn: jv...)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; margin-bottom: 6px; font-size: 0.85em;">
                                <input type="password" id="storjSecretKey" placeholder="Secret Key (örn: j2...)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; margin-bottom: 6px; font-size: 0.85em;">
                                <input type="text" id="storjBucket" placeholder="Bucket adı (örn: 8d-reports)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 6px; font-size: 0.85em;">
                                <input type="text" id="storjEndpoint" value="gateway.storjshare.io" placeholder="Endpoint (varsayılan: gateway.storjshare.io)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 6px; font-size: 0.85em;">
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <button onclick="saveStorjSettings()" class="btn btn-primary" style="flex: 1; background: #00a1ff; border-color: #00a1ff;">💾 Kaydet</button>
                                    <button onclick="testStorjConnection()" class="btn btn-secondary" style="flex: 1; background: #0077cc; border-color: #0077cc; color: white;">🔍 Test Et</button>
                                </div>
                                <div style="font-size: 0.85em; color: #666; text-align: center;">
                                    Hesabınız yok mu? <a href="https://www.storj.io/signup" target="_blank" style="color: #00a1ff; font-weight: 600;">Buradan ücretsiz açın!</a> (Kredi kartı gerekmez)
                                </div>
                                
                                <!-- Veritabanı Yedekleme & Senkronizasyon -->
                                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #4CAF50;">
                                    <div style="font-weight: 700; color: #2e7d32; margin-bottom: 10px; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                                        <span>☁️</span> Veritabanı Yedekleme & Paylaşım
                                    </div>
                                    <div style="font-size: 0.85em; color: #1b5e20; line-height: 1.6; margin-bottom: 12px; background: white; padding: 10px; border-radius: 4px;">
                                        <strong>📌 Kullanım Senaryoları:</strong><br>
                                        • Başka bir bilgisayarda çalışmaya devam etme<br>
                                        • Meslektaşlarla güncel verileri paylaşma<br>
                                        • Otomatik bulut yedeği oluşturma<br>
                                        • Ekip çalışmasında senkronizasyon
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <button onclick="uploadDatabaseToStorj()" class="btn" style="flex: 1; background: #4CAF50; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                            📤 Veritabanını Storj'a Yükle
                                        </button>
                                        <button onclick="downloadDatabaseFromStorj()" class="btn" style="flex: 1; background: #2196F3; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                            📥 Storj'dan İndir ve Yükle
                                        </button>
                                    </div>
                                    <button onclick="showStorjBackupsList()" class="btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-bottom: 8px;">
                                        📋 Storj'daki Yedekleri Görüntüle & Yönet
                                    </button>
                                    <div style="font-size: 0.75em; color: #2e7d32; background: white; padding: 8px; border-radius: 4px; line-height: 1.5;">
                                        <strong>💡 Nasıl Çalışır:</strong><br>
                                        1️⃣ "Veritabanını Yükle" ile tüm verileriniz Storj'a yedeklenir<br>
                                        2️⃣ Başka PC'de aynı Storj ayarlarını girin<br>
                                        3️⃣ "Yedekleri Görüntüle" ile tüm yedeklerinizi görün<br>
                                        4️⃣ İstediğiniz yedeği seçip yükleyin veya silin<br>
                                        <strong>⚠️ Not:</strong> Her yedek için backup key oluşturulur
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 8D Raporlarını Sıfırla -->
                        <div style="background: white; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 3px;">📋 8D Raporlarını Sıfırla</div>
                                <div style="font-size: 0.85em; color: #666;">Tüm 8D raporlarını ve düzeltici faaliyetleri siler</div>
                            </div>
                            <button class="btn btn-secondary" onclick="clear8DReportData()" style="background: #ff9800; color: white; border-color: #ff9800; white-space: nowrap;">
                                🗑️ Sıfırla
                            </button>
                        </div>
                        
                        <!-- Tüm Verileri Sıfırla -->
                        <div style="background: #ffe0e0; padding: 12px; border-radius: 6px; border: 2px solid #f44336; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #c62828; margin-bottom: 3px;">💣 TÜM VERİLERİ SIFIRLA</div>
                                <div style="font-size: 0.85em; color: #c62828; font-weight: 600;">Lokasyonlar, dokümanlar, durumlar, 8D raporlar, kayıtlı sürümler - HER ŞEYİ siler!</div>
                            </div>
                            <button class="btn btn-secondary" onclick="clearAllData()" style="background: #d32f2f; color: white; border-color: #d32f2f; white-space: nowrap; font-weight: 700;">
                                💥 SIFIRLA
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #2196f3; font-size: 0.85em;">
                        <strong>💡 İpucu:</strong> Sıfırlamadan önce "📊 Kaydedilen Sürümler" bölümünden yedek alın!
                    </div>
                </div>
                
                <!-- Yardım & Bilgi -->
                <details style="margin-bottom: 10px;">
                    <summary style="padding: 12px; background: #e8f5e9; border-radius: 8px; border: 1px solid #4caf50; cursor: pointer; font-weight: 600; color: #2e7d32;">
                        ✨ Otomatik Durum Eşleştirme (Tıkla)
                    </summary>
                    <div style="padding: 15px; background: #f1f8f4; border: 1px solid #4caf50; border-top: none; border-radius: 0 0 8px 8px; color: #2e7d32; line-height: 1.8; font-size: 0.9em;">
                        <p style="margin: 5px 0;"><strong>Bir kez ayarladığınız tedarikçi durumları otomatik hatırlanır!</strong></p>
                        <ol style="margin: 10px 0; padding-left: 25px;">
                            <li>Tedarikçi durumunu değiştirin (Onaylı/Onaysız/Müşteri)</li>
                            <li>Sistem otomatik kaydeder</li>
                            <li>Yeni Excel yüklediğinizde aynı tedarikçi otomatik aynı duruma gelir</li>
                        </ol>
                        <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #4caf50; margin-top: 10px; font-size: 0.85em;">
                            <strong>Örnek:</strong> "ABC Firması"nı Müşteri yaparsanız, bir sonraki Excel'de "ABC Firması" otomatik olarak Müşteri tabında görünür!
                        </div>
                    </div>
                </details>
                
                <details style="margin-bottom: 10px;">
                    <summary style="padding: 12px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; cursor: pointer; font-weight: 600; color: #856404;">
                        ℹ️ Veritabanı Hakkında (Tıkla)
                    </summary>
                    <div style="padding: 15px; background: #fffbf0; border: 1px solid #ffc107; border-top: none; border-radius: 0 0 8px 8px;">
                        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6; color: #856404; font-size: 0.9em;">
                            <li><strong>IndexedDB</strong>: Tarayıcıda yerel veri saklama sistemi (GB'larca veri)</li>
                            <li><strong>Manuel Kayıt</strong>: "💾 Düzenlemeleri Kaydet" ile isteğe bağlı kayıt oluşturulur</li>
                            <li><strong>Maksimum Sürüm</strong>: 100 versiyon saklanır (en eski manuel silinir)</li>
                            <li><strong>Yedekleme</strong>: JSON dosyası olarak bilgisayarınıza indirebilirsiniz</li>
                        </ul>
                    </div>
                </details>
                
                <!-- Önemli Uyarı - Başka PC -->
                <details style="margin-bottom: 10px;">
                    <summary style="padding: 12px; background: #ffebee; border-radius: 8px; border: 2px solid #f44336; cursor: pointer; font-weight: 600; color: #c62828;">
                        ⚠️ ÖNEMLİ: Başka Bilgisayarda Kullanım (Tıkla)
                    </summary>
                    <div style="padding: 15px; background: #fff5f5; border: 2px solid #f44336; border-top: none; border-radius: 0 0 8px 8px; color: #c62828; line-height: 1.6; font-size: 0.9em;">
                        <p style="margin: 5px 0;"><strong>IndexedDB verileri sadece bu tarayıcıda ve bu bilgisayarda saklanır!</strong></p>
                        <p style="margin: 10px 0 5px 0; font-weight: 600;">Başka bir bilgisayarda kullanmak için:</p>
                        <ol style="margin: 5px 0; padding-left: 25px;">
                            <li>📊 Kaydedilen Sürümler → <strong>💾 İndir</strong> ile JSON yedek alın</li>
                            <li>JSON dosyasını USB/bulut ile diğer PC'ye taşıyın</li>
                            <li>Diğer PC'de <strong>📥 JSON Yükle</strong> butonu ile geri yükleyin</li>
                        </ol>
                        <p style="margin: 10px 0 0 0; padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #ff9800; font-size: 0.85em;">
                            💡 <strong>İpucu:</strong> Düzenli olarak JSON yedeklemesi yapın (güvenlik + taşınabilirlik)
                        </p>
                    </div>
                </details>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettingsDialog()">Kapat</button>
            </div>
        </div>
    </div>
    
    <!-- 8D Raporlar Listesi Modal -->
    <div id="report8DListModal" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 1200px; width: 95%; max-height: 85vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">
                <h3>📋 Kaydedilen 8D Raporlar</h3>
                <button class="modal-close" onclick="close8DReportListModal()" style="color: white;">✕</button>
            </div>
            <div class="modal-body" style="max-height: calc(85vh - 140px); overflow-y: auto;">
                <div id="report8DListContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="close8DReportListModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Edits Save Dialog -->
    <div id="editsDialog" class="modal-overlay" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>💾 Düzenlemeleri Kaydet</h3>
                <button class="modal-close" onclick="closeEditsDialog()">✕</button>
            </div>
            <div class="modal-body">
                <label for="editsName">Kayıt Adı:</label>
                <input type="text" id="editsName" class="filter-name-input" placeholder="Örn: Mayıs Ayı Kontrol">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditsDialog()">İptal</button>
                <button class="btn btn-primary" onclick="saveCurrentEdits()">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="saveFilterDialog" class="modal-overlay" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>💾 Filtreyi Kaydet</h3>
                <button class="modal-close" onclick="closeSaveFilterDialog()">✕</button>
            </div>
            <div class="modal-body">
                <label for="filterName">Filtre Adı:</label>
                <input type="text" id="filterName" class="filter-name-input" placeholder="Örn: A Sınıfı Tedarikçiler">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSaveFilterDialog()">İptal</button>
                <button class="btn btn-primary" onclick="saveCurrentFilter()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Edit Filter Dialog -->
    <div id="editFilterDialog" class="modal-overlay" style="display: none;">
        <div class="modal-dialog modal-dialog-large">
            <div class="modal-header">
                <h3>✏️ Filtreyi Düzenle</h3>
                <button class="modal-close" onclick="closeEditFilterDialog()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label for="editFilterName">Filtre Adı:</label>
                    <input type="text" id="editFilterName" class="filter-name-input" placeholder="Filtre adı">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Tedarikçiler:</label>
                    <div style="margin-top: 10px;">
                        <input type="text" id="editSupplierSearch" class="filter-name-input" placeholder="🔍 Tedarikçi ara..." onkeyup="filterEditSupplierList()">
                    </div>
                </div>
                <div class="edit-supplier-list" id="editSupplierList">
                    <!-- Supplier checkboxes will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditFilterDialog()">İptal</button>
                <button class="btn btn-primary" onclick="updateFilter()">Güncelle</button>
            </div>
        </div>
    </div>

    <!-- Performance Dialog -->
    <div id="performanceDialog" class="modal-overlay" style="display: none;">
        <div class="modal-dialog modal-dialog-large" style="max-width: 750px;">
            <div class="modal-header">
                <h3>📊 Tedarikçi Hedefi - <span id="perfSupplierName"></span></h3>
                <button class="modal-close" onclick="closePerformanceDialog()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label for="perfYear">Yıl:</label>
                    <input type="number" id="perfYear" class="filter-name-input" style="margin-top: 8px; width: 150px;" placeholder="2024" onchange="calculateNextTargets()">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- PPM -->
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1e3c72; margin-top: 0;">📦 PPM (Parça Per Million)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.9em; color: #666;">Hedefi:</label>
                            <input type="number" id="perfPPMTarget" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="9800" onchange="calculateNextTargets()">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.9em; color: #666;">PPM:</label>
                            <input type="number" id="perfPPMActual" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Gerçekleşme" onchange="calculateNextTargets()">
                        </div>
                        <div style="background: #f0f2f5; padding: 10px; border-radius: 4px;">
                            <label style="font-size: 0.9em; color: #666;">Bir Sonraki Hedefi:</label>
                            <input type="number" id="perfPPMNextTarget" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; background: #e8f5e9; font-weight: bold;">
                        </div>
                    </div>
                    
                    <!-- Hata Tekrarı -->
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1e3c72; margin-top: 0;">⚠️ Hata Tekrarı</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.9em; color: #666;">Hedefi:</label>
                            <input type="number" id="perfDefectTarget" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="2" onchange="calculateNextTargets()">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 0.9em; color: #666;">Toplam Hata:</label>
                            <input type="number" id="perfDefectActual" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Gerçekleşme" onchange="calculateNextTargets()">
                        </div>
                        <div style="background: #f0f2f5; padding: 10px; border-radius: 4px;">
                            <label style="font-size: 0.9em; color: #666;">Bir Sonraki Hedefi:</label>
                            <input type="number" id="perfDefectNextTarget" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; background: #e8f5e9; font-weight: bold;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h4 style="margin: 0 0 10px 0; color: #1565c0;">📋 Hedef Hesaplama Kuralı</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 0.9em;">
                        <li><strong>Gerçekleşme &lt; Hedef:</strong> Sonraki hedef = Hedef × 0.9 (10% daha düşük)</li>
                        <li><strong>Hedef ≤ Gerçekleşme ≤ Hedef × 1.2:</strong> Sonraki hedef = Aynı hedef</li>
                        <li><strong>Gerçekleşme &gt; Hedef × 1.2:</strong> Sonraki hedef = Gerçekleşme × 0.9</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer" style="flex-wrap: wrap;">
                <div style="flex: 1; min-width: 100%; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                    <label style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="includeChartData" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.95em; color: #1e3c72; font-weight: 500;">📈 Grafik verilerini ekle</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.95em; color: #1e3c72; font-weight: 500; white-space: nowrap;">📅 Gözden geçirme tarihi:</label>
                        <input type="date" id="reviewDate" class="filter-name-input" style="width: 180px; padding: 6px 10px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; width: 100%; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closePerformanceDialog()">Kapat</button>
                    <button class="btn" onclick="exportTargetAgreementPDF()" style="background: #dc3545; color: white; border-color: #dc3545;">PDF'e Kaydet</button>
                    <button class="btn btn-primary" onclick="exportTargetAgreementExcel()">Excel'e Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ana Liste Export Modal -->
    <div id="exportDialog" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-header">
                <h3>📋 Rapor Bilgileri</h3>
                <button class="modal-close" onclick="closeExportDialog()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label for="exportYear" style="display: block; margin-bottom: 5px; font-weight: 600; color: #1e3c72;">Dönem (Yıl):</label>
                    <input type="number" id="exportYear" class="filter-name-input" placeholder="2026" style="width: 100%;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="exportReviewDate" style="display: block; margin-bottom: 5px; font-weight: 600; color: #1e3c72;">Gözden Geçirme Tarihi:</label>
                    <input type="date" id="exportReviewDate" class="filter-name-input" style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExportDialog()">İptal</button>
                <button class="btn" id="exportConfirmBtn" style="background: #28a745; color: white; border-color: #28a745;">Devam Et</button>
            </div>
        </div>
    </div>

    <script>
        // Sıralama değişkenleri
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        // Tedarikçi adını normalize et - eşleştirme için
        function normalizeName(name) {
            return String(name || '')
                .trim()
                .toLowerCase()
                .replace(/\s+/g, ' ') // Birden fazla boşlukları tek boşluk yap
                .replace(/[.,;:()&\-\/\t'"]+/g, '') // Özel karakterleri sil
                .replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ü/g, 'u')
                .replace(/ş/g, 's').replace(/ö/g, 'o').replace(/ç/g, 'c')
                .trim() // Başındaki/sonundaki boşlukları sil
                .replace(/\s+/g, ' '); // Yeniden normalize et
        }

        let workbook = null;
        let workbook2 = null; // İkinci Excel dosyası için
        let monthlyScoresData = new Map(); // Tedarikçi adına göre aylık puanlar
        let allResults = [];
        let selectedSuppliers = new Set(); // Seçili tedarikçileri tutacak
        let selectedRows = new Set(); // Tablo satır seçimleri (silme için)
        let savedEditsHistory = []; // Tüm düzenleme geçmişini tutacak
        let currentFilterId = null; // Aktif filtre ID'si
        let currentTab = 'ONAYLI'; // Aktif sekme
        let selectedMonths = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
        let selectedMonthMax = 12; // Seçilen ayların en büyüğü (kümülatif hesap)
        let lastFilteredResults = []; // Dashboard için son filtrelenmiş liste
        let undoStack = []; // Silinen satır grupları için geri alma
        let redoStack = []; // Yeniden silme işlemleri için ileri alma
        let selectedClassFilter = null; // A/B/C/D sınıf filtresi
        let supplierInfoMap = new Map();
        let currentSupplierInfoName = null;
        
        // ======== Performans Ayarları ========
        const ROW_RENDER_CHUNK_SIZE = 75;
        let activeRenderToken = 0;
        const DEBUG_FILTER_LOGS = false;
        const DEBUG_VERBOSE_LOGS = false;
        
        // ======== Tedarikçi Durum Eşleştirme Sistemi ========
        // Tedarikçi adı -> Durum (ONAYLI, ONAYSIZ, MÜŞTERI) eşleştirmesi
        let supplierStatusMap = new Map();
        
        // Durum haritasını localStorage'dan yükle
        function loadSupplierStatusMap() {
            try {
                const saved = localStorage.getItem('supplierStatusMap');
                if (saved) {
                    const obj = JSON.parse(saved);
                    supplierStatusMap = new Map(Object.entries(obj));
                    console.log('Tedarikçi durum haritası yüklendi:', supplierStatusMap.size, 'kayıt');
                }
            } catch (e) {
                console.error('Durum haritası yükleme hatası:', e);
            }
        }

        function loadSupplierInfoMap() {
            try {
                const saved = localStorage.getItem('supplierInfoMap');
                if (saved) {
                    const obj = JSON.parse(saved);
                    supplierInfoMap = new Map(Object.entries(obj));
                    console.log('Tedarikçi bilgi haritası yüklendi:', supplierInfoMap.size, 'kayıt');
                }
            } catch (e) {
                console.error('Tedarikçi bilgi haritası yükleme hatası:', e);
            }
        }

        function saveSupplierInfoMap() {
            try {
                const obj = Object.fromEntries(supplierInfoMap.entries());
                localStorage.setItem('supplierInfoMap', JSON.stringify(obj));
            } catch (e) {
                console.error('Tedarikçi bilgi haritası kaydetme hatası:', e);
            }
        }

        function getSupplierInfo(name) {
            const key = normalizeName(name);
            return supplierInfoMap.get(key) || null;
        }

        function setSupplierInfo(name, info) {
            const key = normalizeName(name);
            if (!info || Object.values(info).every(v => !String(v || '').trim())) {
                supplierInfoMap.delete(key);
            } else {
                supplierInfoMap.set(key, info);
            }
            saveSupplierInfoMap();
        }

        function hasSupplierInfo(name) {
            const info = getSupplierInfo(name);
            if (!info) return false;
            return Object.values(info).some(v => String(v || '').trim());
        }
        
        // Tedarikçi listesini localStorage'a kaydet (COA sayfası için)
        function saveSupplierListForCOA() {
            try {
                // allResults'tan direk alıyoruz (Excel yüklendiğinde dolu olur)
                const supplierNames = allResults
                    .map(r => r.name)
                    .filter(n => n && !n.startsWith('[Tedarikçi Adı Yok')) // Boş adları çıkar
                    .sort();
                
                localStorage.setItem('supplierListForCOA', JSON.stringify(supplierNames));
                console.log('✅ Tedarikçi listesi COA için kaydedildi:', supplierNames.length, 'tedarikçi');
                
                if (supplierNames.length > 0) {
                    console.log('İlk 5 tedarikçi:', supplierNames.slice(0, 5));
                    console.log('Son 5 tedarikçi:', supplierNames.slice(-5));
                }
            } catch (e) {
                console.error('❌ Tedarikçi listesi kaydetme hatası:', e);
            }
        }
        
        // Tedarikçi listesini JSON dosyası olarak indir
        function downloadSupplierListJSON() {
            try {
                const supplierNames = allResults
                    .map(r => r.name)
                    .filter(n => n && !n.startsWith('[Tedarikçi Adı Yok'))
                    .sort();
                
                if (supplierNames.length === 0) {
                    showAlert('⚠️ Kaydedilecek tedarikçi yok', 'warning');
                    return;
                }
                
                const jsonData = {
                    version: '1.0',
                    createdAt: new Date().toISOString(),
                    count: supplierNames.length,
                    suppliers: supplierNames
                };
                
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tedarikciler_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('✅ Tedarikçi listesi JSON olarak indirildi:', supplierNames.length, 'tedarikçi');
                showAlert(`✅ ${supplierNames.length} tedarikçi listesi indirildi!`, 'success');
            } catch (e) {
                console.error('❌ JSON indirme hatası:', e);
                showAlert('❌ İndirme hatası: ' + e.message, 'error');
            }
        }
        
        // Mobil için COA arşiv linki oluştur
        function createMobileCOALink() {
            // LocalStorage farklı cihazlarda paylaşılamaz
            // En iyi çözüm: JSON dosyasını indirip mobilde yüklemek
            showAlert('📱 Mobil için en pratik yöntem:\n\n1. ✅ "Tedarikçi listesini indir" checkbox\'ı işaretli (zaten işaretli)\n2. 📥 Excel yüklendiğinde JSON otomatik indirilir\n3. 📱 JSON dosyasını WhatsApp\'tan kendinize gönderin\n4. 📂 Mobilde COA arşivde "JSON Yükle" butonuna tıklayın\n5. ✅ 561 tedarikçi mobilde hazır!', 'info');
        }
        
        // Tedarikçi listesini Google Sheets'e kaydet (tüm cihazlarda senkron)
        async function saveSupplierListToSheets() {
            try {
                const supplierNames = allResults
                    .map(r => r.name)
                    .filter(n => n && !n.startsWith('[Tedarikçi Adı Yok'))
                    .sort();
                
                if (supplierNames.length === 0) {
                    console.log('Kaydedilecek tedarikçi yok');
                    return;
                }
                
                console.log('📤 Tedarikçi listesi Google Sheets\'e kaydediliyor...', supplierNames.length, 'tedarikçi');
                
                // JSONP ile gönder
                const url = `https://script.google.com/macros/s/AKfycbxKHsJ9pOyn2lq1KdmOgMlnOxyM0ga5ms8SrYcScGT70xCVNYxf8PWdId1jlrR8UqhvAw/exec?action=saveSupplierList&data=${encodeURIComponent(JSON.stringify(supplierNames))}`;
                
                const result = await jsonp(url);
                
                if (result && result.success) {
                    console.log('✅ Tedarikçi listesi Sheets\'e kaydedildi:', supplierNames.length, 'tedarikçi');
                    showAlert('✅ Tedarikçi listesi tüm cihazlar için kaydedildi!', 'success');
                } else {
                    console.error('❌ Sheets kaydetme hatası:', result?.error);
                    showAlert('⚠️ Tedarikçi listesi kaydedilemedi: ' + (result?.error || 'Bilinmeyen hata'), 'warning');
                }
            } catch (e) {
                console.error('❌ saveSupplierListToSheets hatası:', e);
                showAlert('❌ Bağlantı hatası: ' + e.message, 'error');
            }
        }
        
        // JSONP helper function (eğer yoksa)
        function jsonp(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                document.body.appendChild(script);
            });
        }
        
        // Durum haritasını localStorage'a kaydet
        function saveSupplierStatusMap() {
            try {
                const obj = Object.fromEntries(supplierStatusMap);
                localStorage.setItem('supplierStatusMap', JSON.stringify(obj));
                console.log('Tedarikçi durum haritası kaydedildi:', supplierStatusMap.size, 'kayıt');
            } catch (e) {
                console.error('Durum haritası kaydetme hatası:', e);
            }
        }
        
        // Tedarikçi durumunu güncelle ve kaydet
        function updateSupplierStatus(supplierName, newStatus) {
            const normalizedName = normalizeName(supplierName);
            supplierStatusMap.set(normalizedName, newStatus);
            saveSupplierStatusMap();
        }
        
        // Tedarikçi durumunu al (yoksa varsayılan: ONAYLI)
        function getSupplierStatus(supplierName) {
            const normalizedName = normalizeName(supplierName);
            return supplierStatusMap.get(normalizedName) || 'ONAYLI';
        }
        
        // Kaydedilmiş lokasyonları al (IndexedDB'den)
        function getSavedLocation(supplierName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve([]); // DB hazır değilse boş array döndür
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    const transaction = db.transaction([LOCATION_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(LOCATION_STORE_NAME);
                    const request = store.get(normalizedName);
                    
                    request.onsuccess = () => {
                        if (request.result && request.result.locations) {
                            console.log(`📍 ${supplierName} için kaydedilmiş lokasyon: ${request.result.locations.join(', ')}`);
                            resolve(request.result.locations);
                        } else {
                            resolve([]);
                        }
                    };
                    
                    request.onerror = () => {
                        console.error('Lokasyon okuma hatası:', request.error);
                        resolve([]);
                    };
                } catch (e) {
                    console.error('Lokasyon okuma hatası:', e);
                    resolve([]);
                }
            });
        }
        
        // Lokasyonu IndexedDB'ye kaydet
        function saveLokasyonToStorage(supplierName, locations, skipLog = false) {
            if (!db) {
                console.warn('IndexedDB hazır değil, lokasyon kaydedilemedi');
                return;
            }
            
            try {
                const normalizedName = normalizeName(supplierName);
                const transaction = db.transaction([LOCATION_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(LOCATION_STORE_NAME);
                const getRequest = store.get(normalizedName);
                
                getRequest.onsuccess = () => {
                    const oldRecord = getRequest.result;
                    const oldLocations = oldRecord ? oldRecord.locations : [];
                    
                    const data = {
                        normalizedName: normalizedName,
                        supplierName: supplierName,
                        locations: locations,
                        timestamp: new Date().toISOString()
                    };
                    
                    const putRequest = store.put(data);
                    
                    putRequest.onsuccess = () => {
                        console.log(`💾 ${supplierName} lokasyonu IndexedDB'ye kaydedildi: ${locations.join(', ')}`);
                        if (!skipLog) {
                            logActivity('location-change', {
                                supplierName,
                                locations: locations.join(', '),
                                oldLocations: oldLocations.join(', '),
                                timestamp: new Date().toISOString()
                            });
                        }
                    };
                    
                    putRequest.onerror = () => {
                        console.error('Lokasyon kaydetme hatası:', putRequest.error);
                    };
                };
                
                getRequest.onerror = () => {
                    console.error('Lokasyon okuma hatası:', getRequest.error);
                };
            } catch (e) {
                console.error('Lokasyon kaydetme hatası:', e);
            }
        }

        // PPM Hedefini localStorage'a kaydet
        function savePPMTargetToStorage(supplierName, target) {
            try {
                const key = `ppmTarget_${normalizeName(supplierName)}`;
                localStorage.setItem(key, target.toString());
            } catch (e) {
                console.error('PPM hedefi kaydetme hatası:', e);
            }
        }

        // Hata Hedefini localStorage'a kaydet
        function saveHataHedefiToStorage(supplierName, target) {
            try {
                const key = `hataHedefi_${normalizeName(supplierName)}`;
                localStorage.setItem(key, target.toString());
            } catch (e) {
                console.error('Hata hedefi kaydetme hatası:', e);
            }
        }
        // ======== IndexedDB Sistemi (Büyük Veri İçin) ========
        let db = null;
        const DB_NAME = 'SupplierDataDB';
        const DB_VERSION = 7; // V7: 8D sayıları için yeni store eklendi
        const STORE_NAME = 'supplierHistory';
        const LOCATION_STORE_NAME = 'supplierLocations';
        const DOC_STORE_NAME = 'supplierDocuments';
        const SUPPLIER_8D_COUNTS_STORE = 'supplier8DCounts'; // Tedarikçi bazında 8D sayıları
        
        // Doküman türleri listesi
        // Doküman türlerini localStorage'dan yükle veya varsayılan değerleri kullan
        function getDocumentTypes() {
            const saved = localStorage.getItem('documentTypes');
            if (saved) {
                return JSON.parse(saved);
            }
            // Varsayılan değerler
            return [
                'TDS', 'MSDS', 'ROHS', 'REACH', 'Sözleşme', 'COA', 
                'VDA Denetim', 'Tedarikçi Bilgi ve Özdeğerlendirme', 
                'Tedarikçi Sorumluluk Kuralları', 'PPAP Onayı'
            ];
        }

        function saveDocumentTypes(types) {
            localStorage.setItem('documentTypes', JSON.stringify(types));
        }

        function addDocumentType(newType) {
            const types = getDocumentTypes();
            if (!types.includes(newType) && newType.trim()) {
                types.push(newType.trim());
                saveDocumentTypes(types);
                return true;
            }
            return false;
        }

        function removeDocumentType(typeToRemove) {
            const types = getDocumentTypes();
            const filtered = types.filter(t => t !== typeToRemove);
            saveDocumentTypes(filtered);
            return filtered.length < types.length;
        }
        
        function moveDocumentTypeUp(typeToMove) {
            const types = getDocumentTypes();
            const index = types.indexOf(typeToMove);
            if (index > 0) {
                // Swap with previous
                [types[index - 1], types[index]] = [types[index], types[index - 1]];
                saveDocumentTypes(types);
                return true;
            }
            return false;
        }
        
        function moveDocumentTypeDown(typeToMove) {
            const types = getDocumentTypes();
            const index = types.indexOf(typeToMove);
            if (index >= 0 && index < types.length - 1) {
                // Swap with next
                [types[index], types[index + 1]] = [types[index + 1], types[index]];
                saveDocumentTypes(types);
                return true;
            }
            return false;
        }

        let DOCUMENT_TYPES = getDocumentTypes();
        
        // IndexedDB'yi başlat
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB açılamadı:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB başarıyla açıldı - Versiyon:', db.version);
                    console.log('Mevcut object stores:', Array.from(db.objectStoreNames));
                    
                    // 8D Counts store'unun varlığını kontrol et
                    if (!db.objectStoreNames.contains(SUPPLIER_8D_COUNTS_STORE)) {
                        console.error('⚠️ SUPPLIER_8D_COUNTS_STORE bulunamadı! DB upgrade gerekli.');
                        console.log('DB\'yi kapatıp versiyonu artırarak yeniden açıyorum...');
                        db.close();
                        
                        // Versiyonu artır ve yeniden aç
                        const newVersion = db.version + 1;
                        const upgradeRequest = indexedDB.open(DB_NAME, newVersion);
                        
                        upgradeRequest.onupgradeneeded = (event) => {
                            const upgradeDb = event.target.result;
                            if (!upgradeDb.objectStoreNames.contains(SUPPLIER_8D_COUNTS_STORE)) {
                                const counts8DStore = upgradeDb.createObjectStore(SUPPLIER_8D_COUNTS_STORE, { keyPath: 'normalizedName' });
                                counts8DStore.createIndex('supplierName', 'supplierName', { unique: false });
                                console.log('✅ IndexedDB supplier8DCounts store oluşturuldu (manuel upgrade)');
                            }
                        };
                        
                        upgradeRequest.onsuccess = () => {
                            db = upgradeRequest.result;
                            console.log('✅ DB upgrade tamamlandı, yeni versiyon:', db.version);
                            resolve(db);
                        };
                        
                        upgradeRequest.onerror = () => {
                            console.error('DB upgrade hatası:', upgradeRequest.error);
                            reject(upgradeRequest.error);
                        };
                    } else {
                        console.log('✅ Tüm store\'lar mevcut');
                        resolve(db);
                    }
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    const transaction = event.target.transaction;
                    
                    // Versiyonlar için store
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                        objectStore.createIndex('name', 'name', { unique: false });
                        console.log('IndexedDB supplierHistory store oluşturuldu');
                    }
                    
                    // Lokasyonlar için store
                    if (!db.objectStoreNames.contains(LOCATION_STORE_NAME)) {
                        const locationStore = db.createObjectStore(LOCATION_STORE_NAME, { keyPath: 'normalizedName' });
                        locationStore.createIndex('supplierName', 'supplierName', { unique: false });
                        console.log('IndexedDB supplierLocations store oluşturuldu');
                    }
                    
                    // Dokümanlar için store
                    if (!db.objectStoreNames.contains(DOC_STORE_NAME)) {
                        const docStore = db.createObjectStore(DOC_STORE_NAME, { keyPath: 'normalizedName' });
                        docStore.createIndex('supplierName', 'supplierName', { unique: false });
                        console.log('IndexedDB supplierDocuments store oluşturuldu');
                    }
                    
                    // 8D Raporlar için store - V6'da yeniden oluştur
                    if (db.objectStoreNames.contains(REPORT_8D_STORE_NAME)) {
                        // Eski verileri kaydet
                        const oldStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                        const oldData = [];
                        const getAllRequest = oldStore.getAll();
                        
                        getAllRequest.onsuccess = () => {
                            oldData.push(...getAllRequest.result);
                            console.log('Eski 8D raporları yedeklendi:', oldData.length);
                        };
                        
                        // Store'u sil ve yeniden oluştur
                        db.deleteObjectStore(REPORT_8D_STORE_NAME);
                        console.log('Eski report8D store silindi');
                    }
                    
                    // Yeni 8D store oluştur (supplierMonth indexi YOK)
                    const report8DStore = db.createObjectStore(REPORT_8D_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    report8DStore.createIndex('supplierName', 'supplierName', { unique: false });
                    report8DStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('IndexedDB report8D store yeniden oluşturuldu (supplierMonth index kaldırıldı)');
                    
                    // 8D Sayıları için store
                    if (!db.objectStoreNames.contains(SUPPLIER_8D_COUNTS_STORE)) {
                        const counts8DStore = db.createObjectStore(SUPPLIER_8D_COUNTS_STORE, { keyPath: 'normalizedName' });
                        counts8DStore.createIndex('supplierName', 'supplierName', { unique: false });
                        console.log('IndexedDB supplier8DCounts store oluşturuldu');
                    }
                };
            });
        }

        // ======== 8D SAYILARI YÖNETİM FONKSİYONLARI ========
        
        // Tedarikçinin 8D sayılarını kaydet
        function save8DCounts(supplierName, talepEdilen8D, cevaplanan8D, donusOrani8D) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.warn('IndexedDB hazır değil');
                    reject('Database not ready');
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    const transaction = db.transaction([SUPPLIER_8D_COUNTS_STORE], 'readwrite');
                    const store = transaction.objectStore(SUPPLIER_8D_COUNTS_STORE);
                    
                    const data = {
                        normalizedName: normalizedName,
                        supplierName: supplierName,
                        talepEdilen8D: talepEdilen8D || 0,
                        cevaplanan8D: cevaplanan8D || 0,
                        donusOrani8D: donusOrani8D || 0,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    const putRequest = store.put(data);
                    
                    putRequest.onsuccess = () => {
                        console.log(`✅ 8D sayıları kaydedildi: ${supplierName} - Talep: ${talepEdilen8D}, Cevap: ${cevaplanan8D}`);
                        resolve(data);
                    };
                    
                    putRequest.onerror = () => {
                        console.error('8D sayıları kaydetme hatası:', putRequest.error);
                        reject(putRequest.error);
                    };
                } catch (e) {
                    console.error('8D sayıları kaydetme hatası:', e);
                    reject(e);
                }
            });
        }
        
        // Tedarikçinin 8D sayılarını yükle
        function load8DCounts(supplierName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.warn('IndexedDB hazır değil');
                    resolve(null);
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    const transaction = db.transaction([SUPPLIER_8D_COUNTS_STORE], 'readonly');
                    const store = transaction.objectStore(SUPPLIER_8D_COUNTS_STORE);
                    const getRequest = store.get(normalizedName);
                    
                    getRequest.onsuccess = () => {
                        const result = getRequest.result;
                        if (result) {
                            console.log(`✅ 8D sayıları yüklendi: ${supplierName} - Talep: ${result.talepEdilen8D}, Cevap: ${result.cevaplanan8D}`);
                        }
                        resolve(result || null);
                    };
                    
                    getRequest.onerror = () => {
                        console.error('8D sayıları yükleme hatası:', getRequest.error);
                        resolve(null);
                    };
                } catch (e) {
                    console.error('8D sayıları yükleme hatası:', e);
                    resolve(null);
                }
            });
        }
        
        // Tüm tedarikçilerin 8D sayılarını yükle
        function loadAll8DCounts() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.warn('IndexedDB hazır değil');
                    resolve(new Map());
                    return;
                }
                
                try {
                    const transaction = db.transaction([SUPPLIER_8D_COUNTS_STORE], 'readonly');
                    const store = transaction.objectStore(SUPPLIER_8D_COUNTS_STORE);
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const results = getAllRequest.result || [];
                        const countsMap = new Map();
                        
                        results.forEach(item => {
                            const talep = item.talepEdilen8D || 0;
                            const cevap = item.cevaplanan8D || 0;
                            // talepEdilen8D = 0 ise dönüş oranı %100 olmalı (hiç 8D talebi yok = tam başarı)
                            const donus = talep === 0 ? 100 : (item.donusOrani8D || 0);
                            countsMap.set(item.normalizedName, {
                                talepEdilen8D: talep,
                                cevaplanan8D: cevap,
                                donusOrani8D: donus
                            });
                        });
                        
                        console.log(`✅ ${countsMap.size} tedarikçinin 8D sayıları yüklendi`);
                        resolve(countsMap);
                    };
                    
                    getAllRequest.onerror = () => {
                        console.error('8D sayıları toplu yükleme hatası:', getAllRequest.error);
                        resolve(new Map());
                    };
                } catch (e) {
                    console.error('8D sayıları toplu yükleme hatası:', e);
                    resolve(new Map());
                }
            });
        }

        // ======== DOKÜMAN YÖNETİM FONKSİYONLARI ========
        
        // Genel değişiklik geçmişine log kaydı
        function logActivity(type, payload) {
            try {
                const list = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                list.push({ type, ...payload });
                localStorage.setItem('activityHistory', JSON.stringify(list));
            } catch (err) {
                console.error('Aktivite kaydı hatası:', err);
            }
        }

        // Doküman kaydet (birden fazla dosya destekler)
        function saveSupplierDocument(supplierName, docType, file, description = '') {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.warn('IndexedDB hazır değil');
                    reject('Database not ready');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const normalizedName = normalizeName(supplierName);
                        const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(DOC_STORE_NAME);
                        const getRequest = store.get(normalizedName);
                        
                        getRequest.onsuccess = () => {
                            let record = getRequest.result || {
                                normalizedName: normalizedName,
                                supplierName: supplierName,
                                documents: {},
                                exemptDocTypes: [],
                                lastUpdated: new Date().toISOString()
                            };
                            
                            // Doküman türü için array oluştur (yoksa)
                            if (!record.documents[docType]) {
                                record.documents[docType] = [];
                            }
                            
                            // Base64 data URL'den Blob oluştur
                            const base64Data = e.target.result;
                            const blob = base64ToBlob(base64Data);
                            
                            // Yeni dosyayı ekle
                            const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            record.documents[docType].push({
                                id: fileId,
                                name: file.name,
                                type: file.type, // MIME type'ı kaydet
                                data: base64Data, // Base64 string olarak kaydet
                                blob: blob, // Blob objesi olarak da kaydet (okunurken yeniden oluşturulacak)
                                timestamp: new Date().toISOString(),
                                size: file.size,
                                description: description,
                                status: 'pending', // pending, approved, rejected
                                reviewComment: '',
                                reviewedAt: null,
                                uploadedBySupplier: false
                            });
                            
                            record.lastUpdated = new Date().toISOString();
                            
                            const putRequest = store.put(record);
                            putRequest.onsuccess = () => {
                                console.log(`💾 ${supplierName} - ${docType} - ${file.name} dokümanı kaydedildi (base64 + blob)`);
                                logActivity('document-add', {
                                    supplierName,
                                    docType,
                                    fileName: file.name,
                                    timestamp: new Date().toISOString()
                                });
                                resolve(record);
                            };
                            putRequest.onerror = () => reject(putRequest.error);
                        };
                        getRequest.onerror = () => reject(getRequest.error);
                    } catch (err) {
                        console.error('Doküman kaydetme hatası:', err);
                        reject(err);
                    }
                };
                reader.onerror = () => reject('File read error');
                reader.readAsDataURL(file); // Base64 data URL olarak oku
            });
        }
        
        // Dokümanları al
        function getSupplierDocuments(supplierName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(null);
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    const transaction = db.transaction([DOC_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(DOC_STORE_NAME);
                    const request = store.get(normalizedName);
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            const record = request.result;
                            console.log(`📄 ${supplierName} dokümanları yüklendi`);
                            
                            // IndexedDB'den gelen blob'ları kontrol et ve düzelt
                            if (record.documents) {
                                for (const docType in record.documents) {
                                    for (const file of record.documents[docType]) {
                                        // Eğer blob bir düz obje ise (IndexedDB serialize etmiş), data'dan yeniden oluştur
                                        if (file.data && typeof file.data === 'string' && (!file.blob || !(file.blob instanceof Blob))) {
                                            try {
                                                const blob = base64ToBlob(file.data);
                                                if (blob) {
                                                    file.blob = blob;
                                                    console.log(`🔧 ${file.name}: Blob yeniden oluşturuldu (${blob.size} bytes)`);
                                                }
                                            } catch (err) {
                                                console.error(`❌ ${file.name}: Blob oluşturma hatası:`, err);
                                            }
                                        }
                                    }
                                }
                            }
                            
                            resolve(record);
                        } else {
                            resolve(null);
                        }
                    };
                    request.onerror = () => reject(request.error);
                } catch (err) {
                    console.error('Doküman okuma hatası:', err);
                    resolve(null);
                }
            });
        }
        
        // Tedarikçi dokümanlarını kaydet
        async function saveSupplierDocuments(supplierName, docRecord) {
            return new Promise(async (resolve, reject) => {
                if (!db) {
                    reject('Database not ready');
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    
                    // normalizedName ve supplierName eklediğimizden emin ol
                    docRecord.normalizedName = normalizedName;
                    docRecord.supplierName = supplierName;
                    docRecord.lastUpdated = new Date().toISOString();
                    
                    // Blob'ları base64'e çevir (IndexedDB Blob'ları düz obje olarak kaydediyor)
                    if (docRecord.documents) {
                        for (const docType in docRecord.documents) {
                            for (const file of docRecord.documents[docType]) {
                                // Eğer blob varsa ve data yoksa, blob'u base64'e çevir
                                if (file.blob && file.blob instanceof Blob && (!file.data || file.data === '')) {
                                    try {
                                        const base64 = await blobToBase64(file.blob);
                                        file.data = base64;
                                        console.log(`💾 ${file.name}: Blob → base64 çevrildi (kaydediliyor)`);
                                    } catch (err) {
                                        console.error(`❌ ${file.name}: Blob → base64 hatası:`, err);
                                    }
                                }
                            }
                        }
                    }
                    
                    const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(DOC_STORE_NAME);
                    const putRequest = store.put(docRecord);
                    
                    putRequest.onsuccess = () => {
                        console.log(`💾 ${supplierName} dokümanları kaydedildi`);
                        resolve(docRecord);
                    };
                    putRequest.onerror = () => {
                        console.error('Doküman kaydetme hatası:', putRequest.error);
                        reject(putRequest.error);
                    };
                } catch (err) {
                    console.error('Doküman kaydetme hatası:', err);
                    reject(err);
                }
            });
        }
        
        // Zorunlu olmayan doküman türü ekle/çıkar (toggle)
        async function toggleExemptDocType(supplierName, docType) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not ready');
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(DOC_STORE_NAME);
                    const getRequest = store.get(normalizedName);
                    
                    getRequest.onsuccess = () => {
                        let record = getRequest.result || {
                            normalizedName: normalizedName,
                            supplierName: supplierName,
                            documents: {},
                            exemptDocTypes: [],
                            lastUpdated: new Date().toISOString()
                        };
                        
                        // exemptDocTypes array'i yoksa oluştur
                        if (!record.exemptDocTypes) {
                            record.exemptDocTypes = [];
                        }
                        
                        // Toggle: Varsa çıkar, yoksa ekle
                        const index = record.exemptDocTypes.indexOf(docType);
                        const isNowExempt = index === -1;
                        
                        if (isNowExempt) {
                            record.exemptDocTypes.push(docType);
                        } else {
                            record.exemptDocTypes.splice(index, 1);
                        }
                        
                        record.lastUpdated = new Date().toISOString();
                        
                        const putRequest = store.put(record);
                        putRequest.onsuccess = () => {
                            console.log(`🔄 ${supplierName} - ${docType} zorunlu olmayan durum: ${isNowExempt}`);
                            logActivity('document-exempt-toggle', {
                                supplierName,
                                docType,
                                isExempt: isNowExempt,
                                timestamp: new Date().toISOString()
                            });
                            resolve({ isExempt: isNowExempt, record });
                        };
                        putRequest.onerror = () => reject(putRequest.error);
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                } catch (err) {
                    console.error('Zorunlu olmayan durum değiştirme hatası:', err);
                    reject(err);
                }
            });
        }

        // Doküman sil (belirli dosya ID'si ile)
        function deleteSupplierDocument(supplierName, docType, fileId, skipLog = false) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not ready');
                    return;
                }
                
                try {
                    const normalizedName = normalizeName(supplierName);
                    const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(DOC_STORE_NAME);
                    const getRequest = store.get(normalizedName);
                    
                    getRequest.onsuccess = () => {
                        let record = getRequest.result;
                        if (record && record.documents[docType]) {
                            const existingList = record.documents[docType];
                            const deletedFile = existingList.find(doc => doc.id === fileId);
                            // Belirli dosyayı array'den sil
                            record.documents[docType] = existingList.filter(doc => doc.id !== fileId);
                            
                            // Eğer array boşsa, türü tamamen sil
                            if (record.documents[docType].length === 0) {
                                delete record.documents[docType];
                            }
                            
                            record.lastUpdated = new Date().toISOString();
                            
                            const putRequest = store.put(record);
                            putRequest.onsuccess = () => {
                                console.log(`🗑️ ${supplierName} - ${docType} dokümanı silindi`);
                                if (!skipLog) {
                                    logActivity('document-delete', {
                                        supplierName,
                                        docType,
                                        fileName: deletedFile ? deletedFile.name : '',
                                        fileId: fileId,
                                        fileData: deletedFile ? {
                                            name: deletedFile.name,
                                            blob: deletedFile.blob,
                                            size: deletedFile.size
                                        } : null,
                                        timestamp: new Date().toISOString()
                                    });
                                }
                                resolve(record);
                            };
                            putRequest.onerror = () => reject(putRequest.error);
                        } else {
                            resolve(record);
                        }
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                } catch (err) {
                    console.error('Doküman silme hatası:', err);
                    reject(err);
                }
            });
        }
        
        // Doküman indir (dosya ID'si ile)
        function downloadDocument(supplierName, docType, fileId, fileName) {
            getSupplierDocuments(supplierName).then(record => {
                if (record && record.documents && record.documents[docType]) {
                    const file = record.documents[docType].find(doc => doc.id === fileId);
                    if (file) {
                        console.log(`📥 İndirme başlıyor: ${fileName}`);
                        console.log('  file.blob:', file.blob);
                        console.log('  file.data:', file.data ? `${file.data.substring(0, 50)}...` : 'yok');
                        
                        // file.blob zaten Blob objesi
                        const blob = file.blob;
                        
                        if (!blob) {
                            console.error('❌ Blob bulunamadı!');
                            showAlert('❌ Dosya verisi eksik! Lütfen sayfayı yenileyin.', 'error');
                            return;
                        }
                        
                        console.log(`  Blob: ${blob.size} bytes, type: ${blob.type}`);
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.click();
                        URL.revokeObjectURL(url);
                        console.log(`⬇️ ${supplierName} - ${docType} - ${fileName} indirildi`);
                    } else {
                        showAlert(`❌ Doküman bulunamadı`, 'error');
                    }
                } else {
                    showAlert(`❌ ${docType} dokümanı bulunamadı`, 'error');
                }
            }).catch(err => {
                console.error('İndir hatası:', err);
                showAlert('❌ Doküman indirilemedi', 'error');
            });
        }

        // Doküman önizleme (dosya ID'si ile)
        function previewDocument(supplierName, docType, fileId, fileName) {
            getSupplierDocuments(supplierName).then(record => {
                if (record && record.documents && record.documents[docType]) {
                    const file = record.documents[docType].find(doc => doc.id === fileId);
                    if (file) {
                        // Dosya uzantısını al
                        const ext = fileName.split('.').pop().toLowerCase();
                        
                        // PDF, resim ve text dosyaları için doğrudan önizleme
                        const previewableTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'txt'];
                        
                        if (!previewableTypes.includes(ext)) {
                            // Office dosyaları için bilgi göster
                            const officeExtensions = {
                                'xlsx': 'Excel',
                                'xls': 'Excel',
                                'docx': 'Word',
                                'doc': 'Word',
                                'pptx': 'PowerPoint',
                                'ppt': 'PowerPoint'
                            };
                            
                            const fileType = officeExtensions[ext] || 'Office';
                            
                            // Bilgilendirme mesajı göster
                            const message = `📄 ${fileType} Dosyası\n\n"${fileName}"\n\n⚠️ ${fileType} dosyaları tarayıcıda önizlenemez.\n\nDosyayı bilgisayarınıza indirip açmanız gerekmektedir.\n\n━━━━━━━━━━━━━━━━━━━━━━━━\n\n✅ İndirmek için "Tamam" butonuna basın\n❌ İptal etmek için "İptal" butonuna basın`;
                            
                            if (confirm(message)) {
                                downloadDocument(supplierName, docType, fileId, fileName);
                            } else {
                                console.log(`ℹ️ ${fileName} indirme iptal edildi`);
                            }
                            return;
                        }
                        
                        // MIME type belirle (dosyadan veya uzantıdan)
                        const mimeTypes = {
                            'pdf': 'application/pdf',
                            'jpg': 'image/jpeg',
                            'jpeg': 'image/jpeg',
                            'png': 'image/png',
                            'gif': 'image/gif',
                            'bmp': 'image/bmp',
                            'webp': 'image/webp',
                            'svg': 'image/svg+xml',
                            'txt': 'text/plain'
                        };
                        
                        const mimeType = file.type || mimeTypes[ext] || 'application/octet-stream';
                        
                        console.log(`👁️ Önizleme başlıyor: ${fileName}`);
                        console.log('  file.blob:', file.blob);
                        console.log('  file.data:', file.data ? `${file.data.substring(0, 50)}...` : 'yok');
                        
                        // file.blob zaten Blob objesi
                        const blob = file.blob;
                        
                        if (!blob) {
                            console.error('❌ Blob bulunamadı!');
                            showAlert('❌ Dosya verisi eksik! Lütfen sayfayı yenileyin.', 'error');
                            return;
                        }
                        
                        console.log(`  Blob: ${blob.size} bytes, type: ${blob.type}`);
                        const url = URL.createObjectURL(blob);
                        
                        // Yeni pencerede aç
                        const previewWindow = window.open(url, '_blank');
                        if (previewWindow) {
                            previewWindow.document.title = fileName;
                            console.log(`👁️ ${supplierName} - ${docType} - ${fileName} önizleniyor (${mimeType})`);
                            
                            // 1 dakika sonra URL'i temizle
                            setTimeout(() => URL.revokeObjectURL(url), 60000);
                        } else {
                            showAlert('⚠️ Pop-up engellendi! Lütfen tarayıcı ayarlarından izin verin.', 'info');
                            URL.revokeObjectURL(url);
                        }
                    } else {
                        showAlert(`❌ Doküman bulunamadı`, 'error');
                    }
                } else {
                    showAlert(`❌ ${docType} dokümanı bulunamadı`, 'error');
                }
            }).catch(err => {
                console.error('Önizleme hatası:', err);
                showAlert('❌ Doküman önizlenemedi', 'error');
            });
        }

        // ======== Doküman Modal Fonksiyonları ========
        async function openDocumentModal(supplierName) {
            const modal = document.getElementById('documentModal');
            if (!modal) {
                showAlert('❌ Modal öğesi bulunamadı', 'error');
                return;
            }

            // Başlığı güncelle
            const modalTitle = document.getElementById('docModalTitle');
            modalTitle.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <span>📄 ${supplierName} - Dokümanlar</span>
                    <button onclick="openDocTypeManager('${supplierName.replace(/'/g, "\\'")}')" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-left: 10px;" title="Doküman Türlerini Yönet">
                        ⚙️ Türleri Yönet
                    </button>
                </div>
            `;
            
            // Dokümanlar listesini yükle
            const record = await getSupplierDocuments(supplierName);
            const exemptDocs = record && record.exemptDocTypes ? record.exemptDocTypes : [];
            const documentsList = document.getElementById('documentsList');
            
            // Doküman türlerini güncelle (global + custom)
            let allTypes = [...getDocumentTypes()];
            if (record && record.customTypes && record.customTypes.length > 0) {
                // Custom türleri ekle (zaten yoksa)
                record.customTypes.forEach(ct => {
                    if (!allTypes.includes(ct)) {
                        allTypes.push(ct);
                    }
                });
            }
            
            DOCUMENT_TYPES = allTypes;
            
            // Dropdown'ı güncelle
            const typeSelect = document.getElementById('documentTypeSelect');
            if (typeSelect) {
                typeSelect.innerHTML = '<option value="">Doküman Türü Seç</option>';
                DOCUMENT_TYPES.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
            }
            
            let html = '';
            DOCUMENT_TYPES.forEach(docType => {
                const docs = record && record.documents && record.documents[docType];
                const hasDoc = docs && docs.length > 0;
                const isExempt = exemptDocs.includes(docType);
                
                // Arka plan rengi: var (yeşil), yok (beyaz), zorunlu değil (sarı)
                let bgColor = '#fff';
                if (hasDoc) {
                    bgColor = '#e8f5e9';
                } else if (isExempt) {
                    bgColor = '#fffde7';
                }
                
                const docTypeDisplay = docType;
                const exemptBtnText = isExempt ? '✓ Zorunlu Değil' : 'Zorunlu Değil Olarak İşaretle';
                const exemptBtnColor = isExempt ? '#ff9800' : '#ddd';
                const exemptBtnTextColor = isExempt ? 'white' : '#666';
                
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; background: ${bgColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: ${hasDoc ? '8px' : '0'};">
                            <div style="font-weight: 600; color: #333;">${docTypeDisplay}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: ${hasDoc ? '#4CAF50' : '#999'}; font-size: 1em;">${hasDoc ? `✓ (${docs.length})` : (isExempt ? '− Zorunlu Değil' : 'Yok')}</span>
                                ${!hasDoc ? `<button onclick="toggleExemptFromModal('${supplierName.replace(/'/g, "\\'")}', '${docType.replace(/'/g, "\\'")}')" style="padding: 4px 8px; background: ${exemptBtnColor}; color: ${exemptBtnTextColor}; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75em;" title="${isExempt ? 'Tekrar zorunlu yap' : 'Zorunlu değil olarak işaretle'}">${exemptBtnText}</button>` : ''}
                            </div>
                        </div>
                        ${hasDoc ? `
                            <div style="margin-left: 10px;">
                                ${docs.map((file, idx) => {
                                    // Timestamp sisteminden durumu al
                                    const docKey = `${docType}_${idx}`;
                                    const docTimestamp = record.timestamps ? record.timestamps[docKey] : null;
                                    
                                    let statusColor = '#999';
                                    let statusText = 'İncelenmedi';
                                    let statusBg = '#f5f5f5';
                                    let selectedStatus = '';
                                    
                                    if (docTimestamp) {
                                        if (docTimestamp.approved === true) {
                                            statusColor = '#4caf50';
                                            statusText = '✓ Kabul';
                                            statusBg = '#e8f5e9';
                                            selectedStatus = 'approved';
                                        } else if (docTimestamp.approved === false) {
                                            statusColor = '#f44336';
                                            statusText = '✗ Ret';
                                            statusBg = '#ffebee';
                                            selectedStatus = 'rejected';
                                        } else {
                                            statusColor = '#ff9800';
                                            statusText = '◐ İnceleniyor';
                                            statusBg = '#fff3e0';
                                            selectedStatus = 'reviewing';
                                        }
                                    }
                                    
                                    return `
                                    <div style="padding: 8px; background: white; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ${statusColor};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 0.85em; color: #333; font-weight: 500;">📄 ${file.name}</div>
                                                <div style="font-size: 0.75em; color: #666; margin-top: 2px;">
                                                    ${new Date(file.timestamp).toLocaleDateString('tr-TR')} • ${(file.size / 1024).toFixed(1)} KB ${file.uploadedBySupplier ? '• 📤 Tedarikçi' : '• 💼 Ana PC'}
                                                </div>
                                                ${file.description ? `<div style="font-size: 0.75em; color: #666; margin-top: 4px; padding: 4px 6px; background: ${file.uploadedBySupplier ? '#e8f5e9' : '#e3f2fd'}; border-radius: 3px; border-left: 3px solid ${file.uploadedBySupplier ? '#4CAF50' : '#2196f3'};">💬 ${file.uploadedBySupplier ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.9em; font-weight: 600; margin-right: 4px;">TEDARİKÇİ</span>' : '<span style="background: #2196f3; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.9em; font-weight: 600; margin-right: 4px;">ANA PC</span>'} ${file.description}</div>` : ''}
                                            </div>
                                            <div style="display: flex; gap: 5px;">
                                                <button onclick="previewDocument('${supplierName.replace(/'/g, "\\'")}', '${docType.replace(/'/g, "\\'")}', '${file.id}', '${file.name.replace(/'/g, "\\'")}');" style="padding: 4px 8px; background: #2196f3; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;" title="Önizle">👁️</button>
                                                <button onclick="downloadDocument('${supplierName.replace(/'/g, "\\'")}', '${docType.replace(/'/g, "\\'")}', '${file.id}', '${file.name.replace(/'/g, "\\'")}');" style="padding: 4px 8px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;" title="İndir">⬇️</button>
                                                <button onclick="deleteDocumentFromModal('${supplierName.replace(/'/g, "\\'")}', '${docType.replace(/'/g, "\\'")}', '${file.id}', '${file.name.replace(/'/g, "\\'")}')" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;" title="Sil">🗑️</button>
                                            </div>
                                        </div>
                                        ${file.description ? `
                                        <div style="margin-top: 8px; padding: 8px 10px; background: #e8f5e9; border: 1px solid #4CAF50; border-radius: 4px;">
                                            <div style="font-size: 0.75em; color: #2e7d32; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">
                                                <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.85em;">TEDARİKÇİ</span>
                                                Açıklama:
                                            </div>
                                            <textarea placeholder="Tedarikçi açıklaması yok" readonly style="width: 100%; min-height: 40px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8em; color: #1b5e20; line-height: 1.4; background: white; resize: vertical;">${file.description || ''}</textarea>
                                        </div>
                                        ` : ''}
                                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                                            <div style="padding: 4px 12px; background: ${statusBg}; color: ${statusColor}; border-radius: 4px; font-size: 0.85em; font-weight: 600; white-space: nowrap;">
                                                ${statusText}
                                            </div>
                                            <input type="date" id="docDate_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em;" title="Tarih seçin (boş bırakırsanız bugün)" />
                                            <select onchange="updateDocumentStatus('${supplierName.replace(/'/g, "\\'")}', '${docType.replace(/'/g, "\\'")}', ${idx}, this.value, document.getElementById('docDate_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}').value); setTimeout(() => openDocumentModal('${supplierName.replace(/'/g, "\\'")}'), 300);" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; cursor: pointer; flex: 1;">
                                                <option value="">Durum Seç</option>
                                                <option value="approved" ${selectedStatus === 'approved' ? 'selected' : ''}>✓ Kabul</option>
                                                <option value="reviewing" ${selectedStatus === 'reviewing' ? 'selected' : ''}>◐ İnceleniyor</option>
                                                <option value="rejected" ${selectedStatus === 'rejected' ? 'selected' : ''}>✗ Ret</option>
                                            </select>
                                        </div>
                                        <div style="margin-top: 8px; padding: 8px; background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 6px;">
                                            <label style="display: block; font-size: 0.75em; color: #6a1b9a; margin-bottom: 3px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                                💬 Müşteri Yorumu (Tedarikçi bu yorumu görecek)
                                                <span style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.85em;">☁️ STORJ</span>
                                            </label>
                                            <textarea id="reviewComment_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}" placeholder="Tedarikçiye yorum yazın... (Kaydedildiğinde Storj üzerinden tedarikçiye ulaşır)" onchange="updateDocumentReviewComment('${supplierName.replace(/'/g, "\\'")}', '${docType.replace(/'/g, "\\'")}', ${idx}, this.value)" style="width: 100%; min-height: 50px; padding: 6px 8px; border: 1px solid #9c27b0; border-radius: 4px; font-size: 0.8em; resize: vertical; box-sizing: border-box;">${file.reviewComment || ''}</textarea>
                                            <div style="font-size: 0.7em; color: #6a1b9a; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                                ℹ️ Bu yorum "Kaydet ve Paylaş" veya "Senkronize Et" butonuna bastığınızda Storj üzerinden tedarikçiye iletilir.
                                            </div>
                                        </div>
                                        ${file.supplierComment ? `
                                        <div style="margin-top: 8px; padding: 8px; background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 6px;">
                                            <label style="display: block; font-size: 0.75em; color: #2e7d32; margin-bottom: 3px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                                💭 Tedarikçi Yorumu
                                                <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.85em;">☁️ STORJ</span>
                                                ${file.supplierCommentDate ? `<span style="font-size: 0.9em; color: #666;">📅 ${new Date(file.supplierCommentDate).toLocaleDateString('tr-TR')}</span>` : ''}
                                            </label>
                                            <div style="padding: 6px 8px; background: white; border: 1px solid #4CAF50; border-radius: 4px; font-size: 0.8em; line-height: 1.4; color: #1b5e20; min-height: 40px;">${file.supplierComment}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            documentsList.innerHTML = html;
            
            // Diğer tedarikçilerde var olan ama bu tedarikçide olmayan custom türleri göster
            await showAvailableCustomTypes(supplierName);
            
            // Upload alan event listenerları ayarla
            setupDocumentUploadHandlers(supplierName);
            
            // Buton görünürlüğünü sharedStorjKey'e göre ayarla
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            const initialShareBtn = document.getElementById('initialShareBtn');
            const syncBtn = document.getElementById('syncDocumentsBtn');
            const sendMailBtn = document.getElementById('sendDocMailBtn');
            
            if (record && record.sharedStorjKey) {
                // Zaten paylaşılmış - kaydet, senkronize ve mail butonlarını göster
                if (saveChangesBtn) saveChangesBtn.style.display = 'inline-flex';
                if (initialShareBtn) initialShareBtn.style.display = 'none';
                if (syncBtn) {
                    syncBtn.style.display = 'inline-flex';
                    syncBtn.setAttribute('data-supplier', supplierName);
                }
                if (sendMailBtn) {
                    sendMailBtn.style.display = 'inline-flex';
                    sendMailBtn.setAttribute('data-supplier', supplierName);
                    sendMailBtn.setAttribute('data-storj-key', record.sharedStorjKey);
                }
                console.log('🔄 Kaydet, Senkronize ve Mail butonları gösterildi (shared key: ' + record.sharedStorjKey + ')');
            } else {
                // Henüz paylaşılmamış - sadece ilk paylaşım butonunu göster
                if (saveChangesBtn) saveChangesBtn.style.display = 'none';
                if (initialShareBtn) initialShareBtn.style.display = 'inline-flex';
                if (syncBtn) syncBtn.style.display = 'none';
                if (sendMailBtn) sendMailBtn.style.display = 'none';
                console.log('📤 İlk Paylaşım butonu gösterildi (shared key yok)');
            }
            
            // Modali aç
            modal.style.display = 'flex';
            console.log(`📄 ${supplierName} için doküman modali açıldı`);
        }

        // Diğer tedarikçilerde var olan custom türleri göster
        async function showAvailableCustomTypes(currentSupplierName) {
            const container = document.getElementById('availableCustomTypes');
            if (!container) return;

            // Tüm tedarikçilerdeki custom türleri topla
            const allCustomTypes = new Set();
            const standardTypes = getDocumentTypes();
            
            // Tüm tedarikçileri tara
            const suppliers = allResults || [];
            for (const supplier of suppliers) {
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                try {
                    const docs = await getSupplierDocuments(supplierName);
                    if (docs && docs.customTypes) {
                        docs.customTypes.forEach(ct => {
                            if (!standardTypes.includes(ct)) {
                                allCustomTypes.add(ct);
                            }
                        });
                    }
                    if (docs && docs.documents) {
                        Object.keys(docs.documents).forEach(dt => {
                            if (!standardTypes.includes(dt) && docs.documents[dt].length > 0) {
                                allCustomTypes.add(dt);
                            }
                        });
                    }
                } catch (e) {
                    // Hata olursa devam et
                }
            }

            // Şu anki tedarikçinin custom türlerini al
            const currentDocs = await getSupplierDocuments(currentSupplierName);
            const currentCustomTypes = currentDocs && currentDocs.customTypes ? currentDocs.customTypes : [];
            
            // Şu anki tedarikçide olmayan custom türleri filtrele
            const availableTypes = Array.from(allCustomTypes).filter(ct => !currentCustomTypes.includes(ct));

            if (availableTypes.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            // Mevcut türleri butonlar olarak göster
            let html = `
                <div style="padding: 15px; background: #f0f8ff; border-top: 2px solid #2196f3; margin-top: 10px;">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 10px; font-size: 0.9em;">
                        📋 Diğer Tedarikçilerde Kullanılan Doküman Türleri:
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${availableTypes.map(ct => `
                            <button onclick="addCustomTypeToSupplier('${currentSupplierName.replace(/'/g, "\\'")}', '${ct.replace(/'/g, "\\'")}')" 
                                    style="padding: 6px 12px; background: white; color: #1976d2; border: 2px solid #2196f3; border-radius: 20px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;"
                                    onmouseover="this.style.background='#2196f3'; this.style.color='white';"
                                    onmouseout="this.style.background='white'; this.style.color='#1976d2';"
                                    title="Tıklayarak bu tedarikçiye ekle">
                                ➕ ${ct}
                            </button>
                        `).join('')}
                    </div>
                    <div style="margin-top: 8px; font-size: 0.75em; color: #666; font-style: italic;">
                        💡 İpucu: Butona tıklayarak bu doküman türünü bu tedarikçiye ekleyebilirsiniz.
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            container.style.display = 'block';
        }

        // Custom türü tedarikçiye ekle
        async function addCustomTypeToSupplier(supplierName, docType) {
            try {
                const normalizedName = normalizeName(supplierName);
                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(DOC_STORE_NAME);
                const getRequest = store.get(normalizedName);
                
                getRequest.onsuccess = async () => {
                    let record = getRequest.result || {
                        normalizedName: normalizedName,
                        supplierName: supplierName,
                        documents: {},
                        customTypes: [],
                        exemptDocTypes: [],
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // customTypes array'i yoksa oluştur
                    if (!record.customTypes) {
                        record.customTypes = [];
                    }
                    
                    // Zaten yoksa ekle
                    if (!record.customTypes.includes(docType)) {
                        record.customTypes.push(docType);
                        record.lastUpdated = new Date().toISOString();
                        
                        const putRequest = store.put(record);
                        putRequest.onsuccess = async () => {
                            console.log(`✅ ${docType} türü ${supplierName}'e eklendi`);
                            showAlert(`✅ ${docType} başarıyla eklendi`, 'success');
                            
                            // Modalı yeniden yükle
                            await openDocumentModal(supplierName);
                            
                            // Eğer matris açıksa onu da güncelle
                            const matrixModal = document.getElementById('documentMatrixModal');
                            if (matrixModal && matrixModal.style.display === 'flex') {
                                await showDocumentMatrixModal();
                            }
                        };
                        putRequest.onerror = () => {
                            showAlert('❌ Ekleme hatası', 'error');
                        };
                    } else {
                        showAlert('⚠️ Bu doküman türü zaten ekli', 'warning');
                    }
                };
                
                getRequest.onerror = () => {
                    showAlert('❌ Veritabanı hatası', 'error');
                };
            } catch (err) {
                console.error('Custom tür ekleme hatası:', err);
                showAlert('❌ Ekleme başarısız', 'error');
            }
        }

        // Tedarikçi dokümanlarını Storj DCS ile paylaş
        let currentDocShareSupplier = null;

        // Değişiklikleri kaydet ve Storj'a güncelle
        async function saveAndShareDocumentChanges() {
            // Modal başlığından tedarikçi adını al
            const titleElement = document.getElementById('docModalTitle');
            if (!titleElement) {
                showAlert('❌ Tedarikçi adı bulunamadı!', 'error');
                return;
            }

            const titleText = titleElement.textContent || '';
            const match = titleText.match(/📄\s+(.+?)\s+-\s+Dokümanlar/);
            if (!match) {
                showAlert('❌ Tedarikçi adı okunamadı!', 'error');
                return;
            }

            const supplierName = match[1].trim();
            console.log('💾 Doküman değişiklikleri kaydediliyor:', supplierName);

            try {
                // Mevcut doküman kaydını al
                let docRecord = await getSupplierDocuments(supplierName);
                if (!docRecord) {
                    showAlert('❌ Önce doküman paylaşımı yapmalısınız!', 'error');
                    return;
                }

                // Storj key'i var mı kontrol et
                if (!docRecord.sharedStorjKey) {
                    showAlert('❌ Önce "İlk Paylaşım Yap" ile paylaşım yapmalısınız!', 'error');
                    return;
                }

                const settings = getStorjSettings();
                if (!settings) {
                    showAlert('⚠️ Storj ayarları bulunamadı!', 'error');
                    return;
                }

                // Güncel konfigürasyonu hazırla - Blob'ları data URL'e çevir
                const convertedDocuments = {};
                for (const [docType, files] of Object.entries(docRecord.documents || {})) {
                    convertedDocuments[docType] = await Promise.all(
                        files.map(async (file) => {
                            if (file.blob instanceof Blob) {
                                const dataUrl = await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => resolve(reader.result);
                                    reader.readAsDataURL(file.blob);
                                });
                                return {
                                    id: file.id,
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                    data: dataUrl,
                                    timestamp: file.timestamp,
                                    description: file.description || '',
                                    status: file.status || 'pending',
                                    reviewComment: file.reviewComment || '',
                                    reviewedAt: file.reviewedAt || null,
                                    uploadedBySupplier: file.uploadedBySupplier || false
                                };
                            }
                            return file;
                        })
                    );
                }
                
                const shareData = {
                    supplierName: supplierName,
                    documents: convertedDocuments,
                    exemptDocTypes: docRecord.exemptDocTypes || [],
                    customTypes: docRecord.customTypes || [],
                    sharedAt: new Date().toISOString(),
                    mode: 'supplier-upload'
                };

                console.log('📤 Güncel konfigürasyon Storj\'a yükleniyor...');
                console.log('📊 Zorunlu değil türler:', shareData.exemptDocTypes);
                console.log('📊 Özel türler:', shareData.customTypes);

                // Storj'a güncelle (aynı key ile)
                const result = await uploadToStorj(
                    docRecord.sharedStorjKey, 
                    JSON.stringify(shareData, null, 2), 
                    settings
                );

                // Yerel kayıt güncelle
                docRecord.timestamp = new Date().toISOString();
                await saveSupplierDocuments(supplierName, docRecord);

                console.log('✅ Değişiklikler Storj\'a kaydedildi!');
                showAlert('✅ Değişiklikler Kaydedildi!\n\n📤 Konfigürasyon Storj\'a yüklendi.\n🔄 Tedarikçi artık senkronize butonuna basarak yeni ayarları görebilir.', 'success');

            } catch (error) {
                console.error('❌ Kayıt hatası:', error);
                showAlert('❌ Kayıt Hatası!\n\n' + error.message, 'error');
            }
        }

        async function shareSupplierDocuments() {
            // Modal başlığından tedarikçi adını al
            const titleElement = document.getElementById('docModalTitle');
            if (!titleElement) {
                showAlert('❌ Tedarikçi adı bulunamadı!', 'error');
                return;
            }

            const titleText = titleElement.textContent || '';
            const match = titleText.match(/📄\s+(.+?)\s+-\s+Dokümanlar/);
            if (!match) {
                showAlert('❌ Tedarikçi adı okunamadı!', 'error');
                return;
            }

            const supplierName = match[1].trim();
            currentDocShareSupplier = supplierName;

            console.log('🚀 Doküman paylaşımı başlıyor:', supplierName);

            const settings = getStorjSettings();
            if (!settings) {
                showAlert('⚠️ Storj ayarları yapılmamış!\n\nAyarlar menüsünden Storj DCS ayarlarını yapın.\n\n📝 Kurulum:\n1. storj.io\'dan ücretsiz hesap açın\n2. Bucket oluşturun\n3. S3 credentials alın\n4. Ayarları kaydedin', 'error');
                return;
            }

            try {
                // Dokümanları al veya boş record oluştur
                let docRecord = await getSupplierDocuments(supplierName);
                if (!docRecord) {
                    docRecord = {
                        supplierName: supplierName,
                        documents: {},
                        exemptDocTypes: [],
                        customTypes: [],
                        timestamp: new Date().toISOString()
                    };
                }

                // Paylaşım verisi oluştur (boş bile olsa paylaş)
                // Blob'ları data URL'e çevir
                const convertedDocuments = {};
                for (const [docType, files] of Object.entries(docRecord.documents || {})) {
                    convertedDocuments[docType] = await Promise.all(
                        files.map(async (file) => {
                            if (file.blob instanceof Blob) {
                                const dataUrl = await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => resolve(reader.result);
                                    reader.readAsDataURL(file.blob);
                                });
                                return {
                                    id: file.id,
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                    data: dataUrl,
                                    timestamp: file.timestamp,
                                    description: file.description || '',
                                    status: file.status || 'pending',
                                    reviewComment: file.reviewComment || '',
                                    reviewedAt: file.reviewedAt || null,
                                    uploadedBySupplier: file.uploadedBySupplier || false
                                };
                            }
                            return file;
                        })
                    );
                }
                
                const shareData = {
                    supplierName: supplierName,
                    documents: convertedDocuments,
                    exemptDocTypes: docRecord.exemptDocTypes || [],
                    customTypes: docRecord.customTypes || [],
                    sharedAt: new Date().toISOString(),
                    mode: 'supplier-upload'
                };

                // Unique key oluştur
                const storjKey = `DOCS_${supplierName}_${Date.now()}.json`.replace(/[^a-zA-Z0-9._-]/g, '_');

                console.log('📤 Dokümanlar Storj\'a yükleniyor...');
                console.log('🔑 Key:', storjKey);
                console.log('📊 Veri boyutu:', JSON.stringify(shareData).length, 'byte');

                // Storj'a yükle
                const result = await uploadToStorj(storjKey, JSON.stringify(shareData, null, 2), settings);

                console.log('✅ Storj\'a yüklendi!');
                console.log('🔗 URL:', result.url);

                // Storj key'i sakla
                docRecord.sharedStorjKey = storjKey;
                await saveSupplierDocuments(supplierName, docRecord);

                // Tedarikçi URL'i oluştur (credentials'ı encode ederek)
                const encodedCreds = btoa(JSON.stringify({ 
                    accessKey: settings.accessKey, 
                    secretKey: settings.secretKey, 
                    bucket: settings.bucket, 
                    endpoint: settings.endpoint, 
                    key: storjKey 
                }));
                const shareUrl = `${window.location.origin}${window.location.pathname}?mode=documents&storj=${encodedCreds}`;

                // Linki kopyala
                await navigator.clipboard.writeText(shareUrl);

                // Link göster
                showShareLinkDialog(shareUrl, 'Storj DCS - Dokümanlar');
                
                // Butonları güncelle: İlk paylaşım gizle, kaydet ve senkronize göster
                const saveChangesBtn = document.getElementById('saveChangesBtn');
                const initialShareBtn = document.getElementById('initialShareBtn');
                const syncBtn = document.getElementById('syncDocumentsBtn');
                
                if (initialShareBtn) initialShareBtn.style.display = 'none';
                if (saveChangesBtn) saveChangesBtn.style.display = 'inline-flex';
                if (syncBtn) {
                    syncBtn.style.display = 'inline-flex';
                    syncBtn.setAttribute('data-supplier', supplierName);
                }
                
                console.log('✅ Butonlar güncellendi: İlk Paylaşım gizlendi, Kaydet ve Senkronize gösterildi');

            } catch (error) {
                console.error('❌ Doküman paylaşım hatası:', error);
                showAlert('❌ Paylaşım Hatası!\n\n' + error.message + '\n\n🔍 Kontrol edin:\n1. Storj ayarları doğru mu?\n2. Bucket var mı?\n3. Access Key/Secret Key geçerli mi?', 'error');
            }
        }

        // Storj'dan doküman senkronizasyonu
        async function syncSupplierDocumentsFromStorj() {
            console.log('🔄 Storj\'dan doküman senkronizasyonu başlıyor...');
            
            // Supplier name'i sync butonundan al
            const syncBtn = document.getElementById('syncDocumentsBtn');
            const supplierName = syncBtn ? syncBtn.getAttribute('data-supplier') : currentDocShareSupplier;
            
            if (!supplierName) {
                showAlert('❌ Tedarikçi adı bulunamadı!', 'error');
                console.error('❌ currentDocShareSupplier:', currentDocShareSupplier);
                console.error('❌ syncBtn data-supplier:', syncBtn ? syncBtn.getAttribute('data-supplier') : 'button not found');
                return;
            }
            
            console.log('📝 Tedarikçi:', supplierName);
            
            try {
                // Mevcut doküman kaydını al
                const docRecord = await getSupplierDocuments(supplierName);
                if (!docRecord || !docRecord.sharedStorjKey) {
                    showAlert('⚠️ Paylaşılmış Storj key bulunamadı!', 'info');
                    return;
                }
                
                const settings = getStorjSettings();
                if (!settings) {
                    showAlert('❌ Storj ayarları bulunamadı!', 'error');
                    return;
                }
                
                console.log('📥 Storj\'dan güncelleme çekiliyor...');
                console.log('🔑 Key:', docRecord.sharedStorjKey);
                
                // Storj'dan indir
                const remoteData = await downloadFromStorj(docRecord.sharedStorjKey, settings);
                
                console.log('✅ Remote data alındı');
                console.log('📊 Remote doküman sayısı:', Object.keys(remoteData.documents || {}).length);
                
                // Tedarikçi tarafından güncelleme yapılmışsa mutlaka senkronize et
                const hasSupplierUpdate = remoteData.lastUpdatedBySupplier !== undefined;
                
                // Remote ve local timestamp'leri karşılaştır
                const remoteTimestamp = new Date(remoteData.lastUpdatedBySupplier || remoteData.sharedAt);
                const localTimestamp = new Date(docRecord.lastSyncedAt || docRecord.timestamp || 0);
                
                console.log('📅 Remote timestamp:', remoteTimestamp.toLocaleString('tr-TR'));
                console.log('📅 Local timestamp:', localTimestamp.toLocaleString('tr-TR'));
                console.log('🔄 Tedarikçi güncellemesi var mı:', hasSupplierUpdate);
                
                // Eğer tedarikçi güncellemesi varsa veya remote daha yeniyse senkronize et
                if (hasSupplierUpdate || remoteTimestamp > localTimestamp) {
                    console.log('🆕 Remote daha yeni, güncelleme yapılıyor...');
                    
                    // Remote'dan gelen dokümanları dönüştür (data -> blob)
                    const convertedDocuments = {};
                    for (const [docType, files] of Object.entries(remoteData.documents || {})) {
                        if (!Array.isArray(files)) {
                            console.warn(`⚠️ ${docType} için geçersiz dosya formatı`);
                            continue;
                        }
                        
                        convertedDocuments[docType] = files.map(file => {
                            // Eğer data varsa ve blob yoksa, data'yı blob'a çevir
                            if (file.data && !file.blob) {
                                try {
                                    // Base64 data URL'den blob oluştur
                                    const base64Data = file.data.split(',')[1] || file.data;
                                    const mimeType = file.type || 'application/octet-stream';
                                    const byteCharacters = atob(base64Data);
                                    const byteNumbers = new Array(byteCharacters.length);
                                    for (let i = 0; i < byteCharacters.length; i++) {
                                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                                    }
                                    const byteArray = new Uint8Array(byteNumbers);
                                    const blob = new Blob([byteArray], { type: mimeType });
                                    
                                    // ID oluştur
                                    const fileId = file.id || `${docRecord.supplierName}_${file.name}_${file.timestamp || Date.now()}`;
                                    
                                    console.log(`✅ Blob oluşturuldu: ${file.name} (${blob.size} bytes)`);
                                    console.log(`📝 Açıklama: "${file.description || '(yok)'}", uploadedBySupplier: ${file.uploadedBySupplier}`);
                                    
                                    return {
                                        id: fileId,
                                        name: file.name,
                                        type: mimeType,
                                        size: blob.size,
                                        blob: blob,
                                        timestamp: file.timestamp || Date.now(),
                                        description: file.description || '',
                                        status: file.status || 'pending',
                                        reviewComment: file.reviewComment || '',
                                        reviewedAt: file.reviewedAt || null,
                                        uploadedBySupplier: file.uploadedBySupplier || false
                                    };
                                } catch (e) {
                                    console.error('Blob dönüştürme hatası:', e, file.name);
                                    return file;
                                }
                            }
                            return file;
                        });
                    }
                    
                    console.log(`📦 ${Object.keys(convertedDocuments).length} doküman türü dönüştürüldü`);
                    
                    docRecord.documents = convertedDocuments;
                    docRecord.lastSyncedAt = new Date().toISOString();
                    
                    await saveSupplierDocuments(supplierName, docRecord);
                    
                    // Eğer tedarikçi güncellemesi varsa, remote'daki flag'i temizle
                    if (hasSupplierUpdate) {
                        console.log('🧹 Remote lastUpdatedBySupplier temizleniyor...');
                        try {
                            // Remote data'yı güncelle (lastUpdatedBySupplier'ı kaldır)
                            delete remoteData.lastUpdatedBySupplier;
                            await uploadToStorj(docRecord.sharedStorjKey, JSON.stringify(remoteData, null, 2), settings);
                            console.log('✅ Remote güncelleme flag\'i temizlendi');
                        } catch (err) {
                            console.warn('⚠️ Remote flag temizlenemedi:', err.message);
                        }
                    }
                    
                    // Modali yeniden yükle
                    await openDocumentModal(supplierName);
                    
                    showAlert('✅ Dokümanlar güncellendi!\n\nTedarikçiden gelen yeni dokümanlar yüklendi.', 'success');
                } else {
                    console.log('ℹ️ Local güncel, güncelleme gerek yok');
                    showAlert('ℹ️ Zaten güncel!\n\nTedarikçiden yeni güncelleme yok.', 'info');
                }
                
            } catch (error) {
                console.error('❌ Senkronizasyon hatası:', error);
                showAlert('❌ Senkronizasyon Hatası!\n\n' + error.message, 'error');
            }
        }

        // Doküman durumunu güncelle
        async function updateDocumentStatus(supplierName, docType, fileId, newStatus) {
            try {
                const record = await getSupplierDocuments(supplierName);
                if (!record || !record.documents[docType]) return;
                
                const doc = record.documents[docType].find(d => d.id === fileId);
                if (doc) {
                    doc.status = newStatus;
                    doc.reviewedAt = new Date().toISOString();
                    await saveSupplierDocuments(supplierName, record);
                    console.log(`✅ ${fileId} durumu güncellendi: ${newStatus}`);
                }
            } catch (error) {
                console.error('Durum güncelleme hatası:', error);
            }
        }

        // Doküman yorumunu güncelle
        async function updateDocumentReview(supplierName, docType, fileId, reviewComment) {
            try {
                const record = await getSupplierDocuments(supplierName);
                if (!record || !record.documents[docType]) return;
                
                const doc = record.documents[docType].find(d => d.id === fileId);
                if (doc) {
                    doc.reviewComment = reviewComment;
                    doc.reviewedAt = new Date().toISOString();
                    await saveSupplierDocuments(supplierName, record);
                    console.log(`✅ ${fileId} yorumu güncellendi`);
                }
            } catch (error) {
                console.error('Yorum güncelleme hatası:', error);
            }
        }

        function closeDocumentModal() {
            const modal = document.getElementById('documentModal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('documentFileInput').value = '';
                document.getElementById('documentTypeSelect').value = '';
                console.log('📄 Doküman modali kapatıldı');
            }
        }

        // ======== Tedarikçi Bilgileri Modal Fonksiyonları ========
        function openSupplierInfoModal(supplierName) {
            const modal = document.getElementById('supplierInfoModal');
            if (!modal) {
                showAlert('❌ Tedarikçi bilgileri modali bulunamadı', 'error');
                return;
            }

            currentSupplierInfoName = supplierName;
            const title = document.getElementById('supplierInfoTitle');
            if (title) {
                title.textContent = `🧾 ${supplierName} - Tedarikçi Bilgileri`;
            }

            const info = getSupplierInfo(supplierName) || {};
            document.getElementById('infoMaterial').value = info.material || '';
            document.getElementById('infoType').value = info.type || '';
            document.getElementById('infoCustomers').value = info.customers || '';
            document.getElementById('infoPrimaryName').value = info.primaryName || '';
            document.getElementById('infoTitle').value = info.title || '';
            document.getElementById('infoPrimaryEmail').value = info.primaryEmail || '';
            document.getElementById('infoGsm').value = info.gsm || '';
            document.getElementById('infoPhone2').value = info.phone2 || '';
            document.getElementById('infoExtension').value = info.extension || '';
            document.getElementById('infoBackupName').value = info.backupName || '';
            document.getElementById('infoBackupTitle').value = info.backupTitle || '';
            document.getElementById('infoBackupEmail').value = info.backupEmail || '';
            document.getElementById('infoBackupGsm').value = info.backupGsm || '';
            document.getElementById('infoBackupPhone2').value = info.backupPhone2 || '';
            document.getElementById('infoBackupExtension').value = info.backupExtension || '';
            document.getElementById('infoAddress').value = info.address || '';

            modal.style.display = 'flex';
        }

        function closeSupplierInfoModal() {
            const modal = document.getElementById('supplierInfoModal');
            if (modal) {
                modal.style.display = 'none';
            }
            currentSupplierInfoName = null;
        }

        // ======== Doküman Matrisi Fonksiyonları ========
        let matrixCurrentSuppliers = [];
        let matrixDocTypes = [];
        
        async function showDocumentMatrixModal() {
            const modal = document.getElementById('documentMatrixModal');
            if (!modal) {
                showAlert('❌ Modal bulunamadı', 'error');
                return;
            }

            // Filtrelenmiş sonuçları kullan
            const suppliers = lastFilteredResults && lastFilteredResults.length > 0 ? lastFilteredResults : allResults;
            
            // Standart doküman türleri
            const standardDocTypes = getDocumentTypes();
            
            // Tüm doküman türlerini topla
            const allDocTypes = new Set(standardDocTypes);
            const customDocTypesMap = new Map(); // Her custom türün hangi tedarikçilerde olduğunu takip et
            
            // Her tedarikçinin özel türlerini de ekle
            if (suppliers && suppliers.length > 0) {
                for (const supplier of suppliers) {
                    const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                    try {
                        const docs = await getSupplierDocuments(supplierName);
                        if (docs && docs.customTypes) {
                            docs.customTypes.forEach(ct => {
                                if (!standardDocTypes.includes(ct)) {
                                    allDocTypes.add(ct);
                                    if (!customDocTypesMap.has(ct)) {
                                        customDocTypesMap.set(ct, new Set());
                                    }
                                    customDocTypesMap.get(ct).add(supplierName);
                                }
                            });
                        }
                        if (docs && docs.documents) {
                            Object.keys(docs.documents).forEach(dt => {
                                const hasDoc = docs.documents[dt] && docs.documents[dt].length > 0;
                                const isStandard = standardDocTypes.includes(dt);
                                const isInCustomList = docs.customTypes && docs.customTypes.includes(dt);

                                // Custom tür: en az bir dosyası varsa veya customTypes içinde tanımlıysa ekle
                                if (!isStandard) {
                                    if (hasDoc || isInCustomList) {
                                        allDocTypes.add(dt);
                                        if (!customDocTypesMap.has(dt)) {
                                            customDocTypesMap.set(dt, new Set());
                                        }
                                        customDocTypesMap.get(dt).add(supplierName);
                                    }
                                    return;
                                }

                                // Standart tür: her durumda ekle
                                allDocTypes.add(dt);
                            });
                        }
                    } catch (e) {
                        console.error(`${supplierName} dokümanları yüklenemedi:`, e);
                    }
                }
            }

            // Custom türlerden hiçbiri hiçbir tedarikçide yoksa onları çıkar
            const filteredDocTypes = Array.from(allDocTypes).filter(dt => {
                if (standardDocTypes.includes(dt)) return true;
                // Custom ise, en az bir tedarikçide doküman veya customTypes içinde olmalı
                return customDocTypesMap.has(dt) && customDocTypesMap.get(dt).size > 0;
            }).sort();
            matrixDocTypes = filteredDocTypes;
            matrixCurrentSuppliers = suppliers;
            window.matrixCustomDocTypesMap = customDocTypesMap; // Global değişkene kaydet

            // Matris oluştur
            await generateDocumentMatrix(matrixDocTypes, matrixCurrentSuppliers);

            // Tedarikçi sayısını güncelle
            const supplierCount = document.getElementById('matrixSupplierCount');
            if (supplierCount) {
                supplierCount.textContent = `${suppliers.length} Tedarikçi`;
            }

            modal.style.display = 'flex';
            console.log('📊 Doküman matrisi açıldı');
        }

        function closeDocumentMatrixModal() {
            const modal = document.getElementById('documentMatrixModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function generateDocumentMatrix(docTypes, suppliers) {
            const content = document.getElementById('documentMatrixContent');
            if (!content) return;

            if (!suppliers || suppliers.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Tedarikçi verisi yok</div>';
                return;
            }

            const colWidth = 70; // Sabit sütun genişliği
            const rowHeight = 50; // Sabit satır yüksekliği
            const totalDocWidth = docTypes.length * colWidth; // Toplam doküman genişliği

            // Arama kutusu ekle
            let html = `
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <input type="text" 
                           id="matrixSearchInput" 
                           placeholder="🔍 Tedarikçi ara..." 
                           onkeyup="filterDocumentMatrix()"
                           style="flex: 1; padding: 10px 15px; border: 2px solid #9c27b0; border-radius: 6px; font-size: 0.95em; outline: none;">
                    <button onclick="document.getElementById('matrixSearchInput').value=''; filterDocumentMatrix();" 
                            style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ✕ Temizle
                    </button>
                </div>
                
                <!-- Scrollable Matrix Container -->
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="display: flex;">
                        <!-- Sticky Left Column (Supplier Names) -->
                        <div style="min-width: 280px; max-width: 280px; border-right: 3px solid #9c27b0; background: white; display: flex; flex-direction: column;">
                            <!-- Header -->
                            <div style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 12px 15px; font-weight: 600; font-size: 0.95em; height: ${rowHeight}px; display: flex; align-items: center; border-bottom: 2px solid #7b1fa2;">
                                Tedarikçi Adı
                            </div>
                            <!-- Scrollable Names -->
                            <div id="matrixSupplierNames" style="overflow-y: scroll; overflow-x: hidden; max-height: 600px;">
                                <!-- Supplier names will be here -->
                            </div>
                        </div>
                        
                        <!-- Scrollable Right Section (Documents) -->
                        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <!-- Scrollable Headers -->
                            <div style="overflow-x: auto; overflow-y: hidden;">
                                <div id="matrixHeaderRow" style="display: flex; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; height: ${rowHeight}px; border-bottom: 2px solid #7b1fa2; min-width: ${totalDocWidth}px;">
            `;

            // Doküman türü başlıkları - SABİT GENİŞLİK
            docTypes.forEach(docType => {
                html += `
                    <div style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 12px 10px; text-align: center; border-left: 1px solid rgba(255,255,255,0.3); font-size: 0.85em; font-weight: 600; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0;">
                        ${docType}
                    </div>
                `;
            });

            html += `
                                </div>
                            </div>
                            
                            <!-- Scrollable Document Data -->
                            <div id="matrixDocumentData" style="overflow: auto; max-height: 600px;">
                                <!-- Document cells will be here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- İstatistik Özeti -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;" id="matrixStats">
                    <!-- Stats will be here -->
                </div>
            `;

            content.innerHTML = html;

            // Supplier names ve document data ekle
            await renderMatrixRows(suppliers, docTypes, colWidth, rowHeight);
            
            // Scroll senkronizasyonu kur
            setupMatrixScrollSync();
            
            // İstatistikleri oluştur
            await renderMatrixStats(suppliers, docTypes);
        }

        function setupMatrixScrollSync() {
            const namesContainer = document.getElementById('matrixSupplierNames');
            const dataContainer = document.getElementById('matrixDocumentData');
            const headerContainer = document.querySelector('#matrixHeaderRow').parentElement;
            
            if (!namesContainer || !dataContainer || !headerContainer) return;

            // Dikey scroll senkronizasyonu - Names ve Data arasında
            let isNamesScrolling = false;
            let isDataScrolling = false;

            namesContainer.addEventListener('scroll', () => {
                if (isDataScrolling) return;
                isNamesScrolling = true;
                dataContainer.scrollTop = namesContainer.scrollTop;
                setTimeout(() => { isNamesScrolling = false; }, 10);
            });
            
            dataContainer.addEventListener('scroll', (e) => {
                if (isNamesScrolling) return;
                isDataScrolling = true;
                
                // Dikey scroll - names ile senkronize
                namesContainer.scrollTop = dataContainer.scrollTop;
                
                // Yatay scroll - header ile senkronize
                headerContainer.scrollLeft = dataContainer.scrollLeft;
                
                setTimeout(() => { isDataScrolling = false; }, 10);
            });

            // Yatay scroll - header ile data arasında
            headerContainer.addEventListener('scroll', () => {
                dataContainer.scrollLeft = headerContainer.scrollLeft;
            });
        }

        async function renderMatrixRows(suppliers, docTypes, colWidth, rowHeight) {
            const namesContainer = document.getElementById('matrixSupplierNames');
            const dataContainer = document.getElementById('matrixDocumentData');
            
            if (!namesContainer || !dataContainer) return;

            const totalDocWidth = docTypes.length * colWidth; // Toplam genişlik
            
            let namesHtml = '';
            let dataHtml = '';

            // Her tedarikçi için satır
            for (let i = 0; i < suppliers.length; i++) {
                const supplier = suppliers[i];
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                const bgColor = i % 2 === 0 ? '#f9f9f9' : 'white';
                const rowId = `matrix-row-${i}`;
                
                // Sol sütun - Tedarikçi adı
                namesHtml += `
                    <div id="name-${rowId}" class="matrix-row-name" data-supplier="${supplierName.toLowerCase()}" 
                         style="padding: 10px 15px; border-bottom: 1px solid #e0e0e0; background: ${bgColor}; min-height: ${rowHeight}px; height: ${rowHeight}px; display: flex; align-items: center; box-sizing: border-box;"
                         onmouseover="highlightMatrixRow(${i}, '#e8f5e9')" onmouseout="highlightMatrixRow(${i}, '${bgColor}')">
                        <div style="display: flex; flex-direction: column; gap: 4px; width: 100%;">
                            <span style="font-weight: 600; font-size: 0.85em; line-height: 1.2;">${supplierName}</span>
                            <button onclick="openDocumentModal('${supplierName.replace(/'/g, "\\'")}');" 
                                    style="padding: 3px 8px; background: #9c27b0; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7em; width: fit-content;" 
                                    title="Dokümanları Yönet">📄 Yönet</button>
                        </div>
                    </div>
                `;

                // Sağ taraf - Doküman hücreleri
                const docs = await getSupplierDocuments(supplierName);
                const exemptDocs = docs && docs.exemptDocTypes ? docs.exemptDocTypes : [];
                dataHtml += `<div id="data-${rowId}" class="matrix-row-data" data-row-index="${i}" style="display: flex; border-bottom: 1px solid #e0e0e0; min-height: ${rowHeight}px; height: ${rowHeight}px; background: ${bgColor}; min-width: ${totalDocWidth}px;">`;
                
                for (const docType of docTypes) {
                    const hasDoc = docs && docs.documents && docs.documents[docType] && docs.documents[docType].length > 0;
                    const docCount = hasDoc ? docs.documents[docType].length : 0;
                    const isExempt = exemptDocs.includes(docType);
                    
                    // Custom doküman türü mü kontrol et
                    const isCustomType = window.matrixCustomDocTypesMap && window.matrixCustomDocTypesMap.has(docType);
                    
                    // Eğer custom ise ve bu tedarikçide tanımlı değilse -> deaktif hücre
                    if (isCustomType && !window.matrixCustomDocTypesMap.get(docType).has(supplierName)) {
                        dataHtml += `
                            <div style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 10px; text-align: center; border-left: 1px solid #e0e0e0; background: #f5f5f5; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0; cursor: not-allowed; opacity: 0.5;" title="Bu tedarikçi için geçerli değil">
                                <span style="color: #999; font-size: 1em;">—</span>
                            </div>
                        `;
                        continue;
                    }
                    
                    // 3 durum: var (yeşil ✓), yok (kırmızı ✗), zorunlu değil (sarı -)
                    let cellBg, icon, iconColor, clickable;
                    
                    if (hasDoc) {
                        // Doküman var
                        cellBg = '#e8f5e9';
                        icon = '✓';
                        iconColor = '#4caf50';
                        clickable = false;
                    } else if (isExempt) {
                        // Zorunlu değil
                        cellBg = '#fffde7';
                        icon = '−';
                        iconColor = '#ff9800';
                        clickable = true;
                    } else {
                        // Doküman yok (zorunlu)
                        cellBg = '#ffebee';
                        icon = '✗';
                        iconColor = '#f44336';
                        clickable = true;
                    }
                    
                    const cursorStyle = clickable ? 'pointer' : 'default';
                    const titleText = hasDoc ? 'Doküman mevcut' : isExempt ? 'Zorunlu değil - Tıkla: Zorunlu yap' : 'Eksik - Tıkla: Zorunlu değil yap';
                    const onclickHandler = clickable ? `onclick="handleMatrixCellClick('${supplierName.replace(/'/g, "\\'")}', '${docType}', ${i})"` : '';
                    
                    if (hasDoc) {
                        dataHtml += `
                            <div style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 10px; text-align: center; border-left: 1px solid #e0e0e0; background: ${cellBg}; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0; cursor: ${cursorStyle};" title="${titleText}">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="color: ${iconColor}; font-size: 1.2em; font-weight: bold;">${icon}</span>
                                    ${docCount > 1 ? `<span style="background: #4caf50; color: white; padding: 2px 5px; border-radius: 8px; font-size: 0.7em; font-weight: bold;">${docCount}</span>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        dataHtml += `
                            <div ${onclickHandler} style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 10px; text-align: center; border-left: 1px solid #e0e0e0; background: ${cellBg}; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0; cursor: ${cursorStyle}; transition: all 0.2s;" title="${titleText}" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                                <span style="color: ${iconColor}; font-size: 1.2em; font-weight: bold;">${icon}</span>
                            </div>
                        `;
                    }
                }

                dataHtml += `</div>`;
            }

            namesContainer.innerHTML = namesHtml;
            dataContainer.innerHTML = dataHtml;
        }

        function highlightMatrixRow(index, color) {
            const nameRow = document.getElementById(`name-matrix-row-${index}`);
            const dataRow = document.querySelector(`.matrix-row-data[data-row-index="${index}"]`);
            
            if (nameRow) nameRow.style.background = color;
            if (dataRow) dataRow.style.background = color;
        }

        // Matris hücresine tıklandığında zorunlu/zorunlu değil durumunu değiştir
        async function handleMatrixCellClick(supplierName, docType, rowIndex) {
            try {
                const result = await toggleExemptDocType(supplierName, docType);
                
                // Başarılı olduğunda matrisi yeniden yükle
                if (result) {
                    showAlert(`${docType} ${result.isExempt ? 'zorunlu değil olarak işaretlendi' : 'zorunlu olarak işaretlendi'}`, 'success');
                    // Sadece etkilenen satırı yeniden çiz
                    await refreshMatrixRow(rowIndex);
                }
            } catch (err) {
                console.error('Hücre tıklama hatası:', err);
                showAlert('❌ Durum değiştirilemedi', 'error');
            }
        }

        // Matrisin tek bir satırını yeniden yükle
        async function refreshMatrixRow(rowIndex) {
            if (!matrixCurrentSuppliers || !matrixDocTypes) return;
            
            const supplier = matrixCurrentSuppliers[rowIndex];
            if (!supplier) return;
            
            const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
            const bgColor = rowIndex % 2 === 0 ? '#f9f9f9' : 'white';
            const rowHeight = 50;
            const colWidth = 70;
            
            // Doküman verilerini al
            const docs = await getSupplierDocuments(supplierName);
            const exemptDocs = docs && docs.exemptDocTypes ? docs.exemptDocTypes : [];
            
            // Sadece data satırını güncelle (sağ taraf)
            const dataRow = document.querySelector(`.matrix-row-data[data-row-index="${rowIndex}"]`);
            if (!dataRow) return;
            
            let cellsHtml = '';
            for (const docType of matrixDocTypes) {
                const hasDoc = docs && docs.documents && docs.documents[docType] && docs.documents[docType].length > 0;
                const docCount = hasDoc ? docs.documents[docType].length : 0;
                const isExempt = exemptDocs.includes(docType);
                
                // Custom doküman türü mü kontrol et
                const isCustomType = window.matrixCustomDocTypesMap && window.matrixCustomDocTypesMap.has(docType);
                
                // Eğer custom ise ve bu tedarikçide tanımlı değilse -> deaktif hücre
                if (isCustomType && !window.matrixCustomDocTypesMap.get(docType).has(supplierName)) {
                    cellsHtml += `
                        <div style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 10px; text-align: center; border-left: 1px solid #e0e0e0; background: #f5f5f5; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0; cursor: not-allowed; opacity: 0.5;" title="Bu tedarikçi için geçerli değil">
                            <span style="color: #999; font-size: 1em;">—</span>
                        </div>
                    `;
                    continue;
                }
                
                let cellBg, icon, iconColor, clickable;
                
                if (hasDoc) {
                    cellBg = '#e8f5e9';
                    icon = '✓';
                    iconColor = '#4caf50';
                    clickable = false;
                } else if (isExempt) {
                    cellBg = '#fffde7';
                    icon = '−';
                    iconColor = '#ff9800';
                    clickable = true;
                } else {
                    cellBg = '#ffebee';
                    icon = '✗';
                    iconColor = '#f44336';
                    clickable = true;
                }
                
                const cursorStyle = clickable ? 'pointer' : 'default';
                const titleText = hasDoc ? 'Doküman mevcut' : isExempt ? 'Zorunlu değil - Tıkla: Zorunlu yap' : 'Eksik - Tıkla: Zorunlu değil yap';
                const onclickHandler = clickable ? `onclick="handleMatrixCellClick('${supplierName.replace(/'/g, "\\'")}', '${docType}', ${rowIndex})"` : '';
                
                if (hasDoc) {
                    cellsHtml += `
                        <div style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 10px; text-align: center; border-left: 1px solid #e0e0e0; background: ${cellBg}; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0; cursor: ${cursorStyle};" title="${titleText}">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: ${iconColor}; font-size: 1.2em; font-weight: bold;">${icon}</span>
                                ${docCount > 1 ? `<span style="background: #4caf50; color: white; padding: 2px 5px; border-radius: 8px; font-size: 0.7em; font-weight: bold;">${docCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    cellsHtml += `
                        <div ${onclickHandler} style="min-width: ${colWidth}px; max-width: ${colWidth}px; width: ${colWidth}px; padding: 10px; text-align: center; border-left: 1px solid #e0e0e0; background: ${cellBg}; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0; cursor: ${cursorStyle}; transition: all 0.2s;" title="${titleText}" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                            <span style="color: ${iconColor}; font-size: 1.2em; font-weight: bold;">${icon}</span>
                        </div>
                    `;
                }
            }
            
            dataRow.innerHTML = cellsHtml;
        }

        async function renderMatrixStats(suppliers, docTypes) {
            const statsContainer = document.getElementById('matrixStats');
            if (!statsContainer) return;

            let html = '';

            // Her doküman türü için istatistik
            for (const docType of docTypes) {
                let hasCount = 0;
                let applicableCount = 0; // Zorunlu olan tedarikçi sayısı (zorunlu değil olanlar hariç)
                
                for (const supplier of suppliers) {
                    const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                    const docs = await getSupplierDocuments(supplierName);
                    const exemptDocs = docs && docs.exemptDocTypes ? docs.exemptDocTypes : [];
                    
                    // Eğer bu doküman "zorunlu değil" ise sayma
                    if (exemptDocs.includes(docType)) {
                        continue;
                    }
                    
                    // Zorunlu olan tedarikçileri say
                    applicableCount++;
                    
                    // Dokümanı olan tedarikçileri say
                    if (docs && docs.documents && docs.documents[docType] && docs.documents[docType].length > 0) {
                        hasCount++;
                    }
                }
                
                const percentage = applicableCount > 0 ? ((hasCount / applicableCount) * 100).toFixed(1) : 0;
                const barColor = percentage >= 80 ? '#4caf50' : percentage >= 50 ? '#ff9800' : '#f44336';
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid ${barColor};">
                        <div style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 0.9em;">${docType}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 0.85em;">Tamamlama:</span>
                            <span style="font-weight: bold; color: ${barColor}; font-size: 1.1em;">${percentage}%</span>
                        </div>
                        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                        </div>
                        <div style="margin-top: 6px; font-size: 0.8em; color: #666; text-align: center;">
                            ${hasCount} / ${applicableCount} tedarikçi
                        </div>
                    </div>
                `;
            }

            statsContainer.innerHTML = html;
        }

        function filterDocumentMatrix() {
            const searchInput = document.getElementById('matrixSearchInput');
            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase().trim();
            const nameRows = document.querySelectorAll('.matrix-row-name');
            const dataRows = document.querySelectorAll('.matrix-row-data');

            nameRows.forEach((nameRow, index) => {
                const supplierName = nameRow.getAttribute('data-supplier');
                const shouldShow = !searchTerm || supplierName.includes(searchTerm);
                
                nameRow.style.display = shouldShow ? 'flex' : 'none';
                if (dataRows[index]) {
                    dataRows[index].style.display = shouldShow ? 'flex' : 'none';
                }
            });
        }

        async function exportDocumentMatrixPDF() {
            if (!matrixCurrentSuppliers || matrixCurrentSuppliers.length === 0) {
                showAlert('❌ Matris verisi bulunamadı', 'error');
                return;
            }

            // jsPDF kontrolü
            if (!window.jspdf && !window.jsPDF) {
                showAlert('⚠️ PDF kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }

            const jsPDF = window.jspdf?.jsPDF || window.jsPDF;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

            // Türkçe karakter desteği için font ayarla
            doc.setFont('helvetica');
            doc.setLanguage("tr-TR");

            // Başlık
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(63, 81, 181);
            doc.text('Doküman Matrisi', 148.5, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            const tarih = new Date().toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            doc.text(`Olusturulma: ${tarih}`, 148.5, 22, { align: 'center' });

            // Tablo başlıkları - Türkçe karakterleri dönüştür
            const headers = ['Tedarikci Adi', ...matrixDocTypes.map(dt => {
                return dt.replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                         .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                         .replace(/ş/g, 's').replace(/Ş/g, 'S')
                         .replace(/ı/g, 'i').replace(/İ/g, 'I')
                         .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                         .replace(/ç/g, 'c').replace(/Ç/g, 'C');
            })];

            // Tablo verilerini hazırla
            const tableData = [];
            for (const supplier of matrixCurrentSuppliers) {
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                // Türkçe karakterleri dönüştür
                const cleanName = supplierName.replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                         .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                         .replace(/ş/g, 's').replace(/Ş/g, 'S')
                         .replace(/ı/g, 'i').replace(/İ/g, 'I')
                         .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                         .replace(/ç/g, 'c').replace(/Ç/g, 'C');
                
                const docs = await getSupplierDocuments(supplierName);
                const exemptDocs = docs && docs.exemptDocTypes ? docs.exemptDocTypes : [];
                
                const row = [cleanName];
                
                for (const docType of matrixDocTypes) {
                    const hasDoc = docs && docs.documents && docs.documents[docType] && docs.documents[docType].length > 0;
                    const isExempt = exemptDocs.includes(docType);
                    
                    // Custom doküman türü kontrolü
                    const isCustomType = window.matrixCustomDocTypesMap && window.matrixCustomDocTypesMap.has(docType);
                    const isRelevant = !isCustomType || (isCustomType && window.matrixCustomDocTypesMap.get(docType).has(supplierName));
                    
                    if (!isRelevant) {
                        row.push('—'); // Deaktif
                    } else if (hasDoc) {
                        row.push('VAR'); // Var
                    } else if (isExempt) {
                        row.push('Z.DEG'); // Zorunlu değil
                    } else {
                        row.push('YOK'); // Yok
                    }
                }
                
                tableData.push(row);
            }

            // AutoTable ile tablo oluştur
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 28,
                styles: {
                    fontSize: 7,
                    cellPadding: 3,
                    halign: 'center',
                    valign: 'middle',
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [63, 81, 181],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 8,
                    halign: 'center',
                    cellPadding: 4
                },
                columnStyles: {
                    0: { 
                        halign: 'left', 
                        cellWidth: 45,
                        fontStyle: 'bold',
                        fontSize: 7
                    }
                },
                didParseCell: function(data) {
                    // Renklendirme
                    if (data.section === 'body' && data.column.index > 0) {
                        const cellValue = data.cell.text[0];
                        
                        if (cellValue === 'VAR') {
                            data.cell.styles.textColor = [27, 94, 32]; // Koyu yeşil
                            data.cell.styles.fillColor = [200, 230, 201]; // Açık yeşil
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 8;
                        } else if (cellValue === 'Z.DEG') {
                            data.cell.styles.textColor = [230, 81, 0]; // Koyu turuncu
                            data.cell.styles.fillColor = [255, 243, 224]; // Açık turuncu
                            data.cell.styles.fontStyle = 'normal';
                            data.cell.styles.fontSize = 7;
                        } else if (cellValue === 'YOK') {
                            data.cell.styles.textColor = [183, 28, 28]; // Koyu kırmızı
                            data.cell.styles.fillColor = [255, 205, 210]; // Açık kırmızı
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = 8;
                        } else if (cellValue === '—') {
                            data.cell.styles.textColor = [158, 158, 158]; // Gri
                            data.cell.styles.fillColor = [245, 245, 245]; // Açık gri
                            data.cell.styles.fontStyle = 'normal';
                            data.cell.styles.fontSize = 10;
                        }
                    }
                },
                margin: { top: 28, left: 10, right: 10 },
                theme: 'grid'
            });

            // Açıklama ekle - Türkçe karaktersiz
            const finalY = doc.lastAutoTable.finalY + 8;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(60, 60, 60);
            
            // Renkli kutu açıklamaları
            const legendY = finalY;
            const boxSize = 4;
            const spacing = 60;
            
            // VAR
            doc.setFillColor(200, 230, 201);
            doc.rect(10, legendY - 3, boxSize, boxSize, 'F');
            doc.setTextColor(27, 94, 32);
            doc.text('VAR = Dokuman mevcut', 16, legendY);
            
            // YOK
            doc.setFillColor(255, 205, 210);
            doc.rect(10 + spacing, legendY - 3, boxSize, boxSize, 'F');
            doc.setTextColor(183, 28, 28);
            doc.text('YOK = Eksik dokuman', 16 + spacing, legendY);
            
            // Z.DEG
            doc.setFillColor(255, 243, 224);
            doc.rect(10 + spacing * 2, legendY - 3, boxSize, boxSize, 'F');
            doc.setTextColor(230, 81, 0);
            doc.text('Z.DEG = Zorunlu degil', 16 + spacing * 2, legendY);
            
            // Deaktif
            doc.setFillColor(245, 245, 245);
            doc.rect(10 + spacing * 3, legendY - 3, boxSize, boxSize, 'F');
            doc.setTextColor(158, 158, 158);
            doc.text('— = Gecerli degil', 16 + spacing * 3, legendY);

            // PDF'i indir
            const fileName = `Dokuman_Matrisi_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            
            showAlert('✅ PDF başarıyla oluşturuldu', 'success');
        }

        async function exportDocumentMatrixExcel() {
            if (!matrixCurrentSuppliers || matrixCurrentSuppliers.length === 0) {
                showAlert('❌ Matris verisi bulunamadı', 'error');
                return;
            }

            if (!window.XLSX) {
                showAlert('⚠️ Excel kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }

            // Excel verilerini hazırla - Array of Arrays formatında
            const excelData = [];
            
            // Başlık satırı
            const headers = ['Tedarikçi Adı', ...matrixDocTypes];
            excelData.push(headers);

            // Veri satırları
            for (const supplier of matrixCurrentSuppliers) {
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                const docs = await getSupplierDocuments(supplierName);
                const exemptDocs = docs && docs.exemptDocTypes ? docs.exemptDocTypes : [];
                
                const row = [supplierName];
                
                for (const docType of matrixDocTypes) {
                    const hasDoc = docs && docs.documents && docs.documents[docType] && docs.documents[docType].length > 0;
                    const isExempt = exemptDocs.includes(docType);
                    
                    // Custom doküman türü kontrolü
                    const isCustomType = window.matrixCustomDocTypesMap && window.matrixCustomDocTypesMap.has(docType);
                    const isRelevant = !isCustomType || (isCustomType && window.matrixCustomDocTypesMap.get(docType).has(supplierName));
                    
                    if (!isRelevant) {
                        row.push('—'); // Deaktif (tire)
                    } else if (hasDoc) {
                        row.push('VAR');
                    } else if (isExempt) {
                        row.push('Z.DEĞ');
                    } else {
                        row.push('YOK');
                    }
                }
                
                excelData.push(row);
            }

            // Boş satır
            excelData.push([]);
            
            // Açıklama başlığı
            excelData.push(['AÇIKLAMA:']);
            
            // Açıklama satırları - Her biri ayrı satırda
            excelData.push(['', 'VAR', '=', 'Doküman mevcut (Yeşil)']);
            excelData.push(['', 'YOK', '=', 'Eksik doküman (Kırmızı)']);
            excelData.push(['', 'Z.DEĞ', '=', 'Zorunlu değil (Turuncu)']);
            excelData.push(['', '—', '=', 'Bu tedarikçi için geçerli değil (Gri)']);

            // Worksheet oluştur
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // Sütun genişliklerini ayarla
            const colWidths = [{ wch: 40 }]; // Tedarikçi adı
            matrixDocTypes.forEach(() => colWidths.push({ wch: 14 }));
            ws['!cols'] = colWidths;

            // Satır yüksekliklerini ayarla
            ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 30 }; // Başlık satırı

            // Workbook oluştur
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Doküman Matrisi');

            // Excel dosyasını indir
            const fileName = `Dokuman_Matrisi_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showAlert('✅ Excel oluşturuldu. Not: Renklendirme için Excel\'de Koşullu Biçimlendirme kullanabilirsiniz.', 'success');
        }

        // ======== Kalite Belge Matrisi Fonksiyonları ========
        let qcMatrixCurrentSuppliers = [];
        let qualityCertTypes = [
            { key: 'iso9001', label: 'ISO 9001', custom: false },
            { key: 'iso14001', label: 'ISO 14001', custom: false },
            { key: 'iso45001', label: 'ISO 45001', custom: false },
            { key: 'iatf', label: 'IATF 16949', custom: false }
        ];
        
        // LocalStorage'dan özel belge türlerini yükle
        function loadCustomQualityCertTypes() {
            try {
                const saved = localStorage.getItem('customQualityCertTypes');
                if (saved) {
                    const customTypes = JSON.parse(saved);
                    // Varsayılan türlerle birleştir
                    qualityCertTypes = [
                        { key: 'iso9001', label: 'ISO 9001', custom: false },
                        { key: 'iso14001', label: 'ISO 14001', custom: false },
                        { key: 'iso45001', label: 'ISO 45001', custom: false },
                        { key: 'iatf', label: 'IATF 16949', custom: false },
                        ...customTypes
                    ];
                }
            } catch (e) {
                console.error('Özel belge türleri yüklenemedi:', e);
            }
        }
        
        // Özel belge türlerini kaydet
        function saveCustomQualityCertTypes() {
            try {
                const customTypes = qualityCertTypes.filter(t => t.custom);
                localStorage.setItem('customQualityCertTypes', JSON.stringify(customTypes));
            } catch (e) {
                console.error('Özel belge türleri kaydedilemedi:', e);
            }
        }
        
        // Yeni belge türü ekleme
        async function addNewQualityCertType() {
            const label = prompt('Yeni Belge Türü Adı (örn: ISO 50001):');
            if (!label || label.trim() === '') return;
            
            const key = label.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            
            // Aynı key var mı kontrol et
            if (qualityCertTypes.find(t => t.key === key)) {
                showAlert('❌ Bu belge türü zaten mevcut!', 'error');
                return;
            }
            
            // Yeni türü ekle
            qualityCertTypes.push({
                key: key,
                label: label.trim(),
                custom: true
            });
            
            // Kaydet
            saveCustomQualityCertTypes();
            
            // Matrisi yenile
            await generateQualityCertMatrix(qcMatrixCurrentSuppliers);
            
            // Ana tabloyu yenile
            renderTable(allResults);
            
            showAlert(`✅ "${label}" belge türü eklendi!`, 'success');
        }
        
        // Belge türünü silme
        async function removeQualityCertType(index) {
            const cert = qualityCertTypes[index];
            if (!cert.custom) {
                showAlert('❌ Varsayılan belge türleri silinemez!', 'error');
                return;
            }
            
            if (!confirm(`"${cert.label}" belge türünü silmek istediğinize emin misiniz?\n\nTüm tedarikçilerdeki bu belge verileri silinecektir!`)) {
                return;
            }
            
            // Tüm tedarikçilerden bu belge türünü sil
            allResults.forEach(supplier => {
                if (supplier[cert.key]) {
                    delete supplier[cert.key];
                }
                if (supplier.certExpiryDates && supplier.certExpiryDates[cert.key]) {
                    delete supplier.certExpiryDates[cert.key];
                }
            });
            
            // Türü listeden çıkar
            qualityCertTypes.splice(index, 1);
            
            // Kaydet
            saveCustomQualityCertTypes();
            saveSupplierCertData();
            
            // Matrisi yenile
            await generateQualityCertMatrix(qcMatrixCurrentSuppliers);
            
            // Ana tabloyu yenile
            renderTable(allResults);
            
            showAlert(`✅ "${cert.label}" belge türü silindi!`, 'success');
        }

        async function showQualityCertMatrixModal() {
            const modal = document.getElementById('qualityCertMatrixModal');
            if (!modal) {
                showAlert('❌ Modal bulunamadı', 'error');
                return;
            }
            
            // Özel belge türlerini yükle
            loadCustomQualityCertTypes();

            // Filtrelenmiş sonuçları kullan
            const suppliers = lastFilteredResults && lastFilteredResults.length > 0 ? lastFilteredResults : allResults;
            qcMatrixCurrentSuppliers = suppliers;

            // Matris oluştur
            await generateQualityCertMatrix(qcMatrixCurrentSuppliers);

            // Tedarikçi sayısını güncelle
            const supplierCount = document.getElementById('qcMatrixSupplierCount');
            if (supplierCount) {
                supplierCount.textContent = `${suppliers.length} Tedarikçi`;
            }

            modal.style.display = 'flex';
            console.log('📋 Kalite belge matrisi açıldı');
        }

        function closeQualityCertMatrixModal() {
            const modal = document.getElementById('qualityCertMatrixModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function getExpiryStatus(expiryDate) {
            if (!expiryDate) return { status: 'none', text: '-', color: '#fff' };
            
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return { status: 'expired', text: new Date(expiryDate).toLocaleDateString('tr-TR'), color: '#ffcdd2', textColor: '#c62828' }; // Kırmızı
            } else if (diffDays <= 7) {
                return { status: 'warning', text: new Date(expiryDate).toLocaleDateString('tr-TR'), color: '#fff9c4', textColor: '#f57f17' }; // Sarı
            } else {
                return { status: 'valid', text: new Date(expiryDate).toLocaleDateString('tr-TR'), color: '#c8e6c9', textColor: '#2e7d32' }; // Yeşil
            }
        }

        async function generateQualityCertMatrix(suppliers) {
            const content = document.getElementById('qualityCertMatrixContent');
            if (!content) return;

            if (!suppliers || suppliers.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Tedarikçi verisi yok</div>';
                return;
            }

            const colWidth = 25;

            // Arama kutusu ekle
            let html = `
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <input type="text" 
                           id="qcMatrixSearchInput" 
                           placeholder="🔍 Tedarikçi ara..." 
                           onkeyup="filterQualityCertMatrix()"
                           style="flex: 1; padding: 10px 15px; border: 2px solid #00897b; border-radius: 6px; font-size: 0.95em; outline: none;">
                    <button onclick="document.getElementById('qcMatrixSearchInput').value=''; filterQualityCertMatrix();" 
                            style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ✕ Temizle
                    </button>
                </div>
                
                <!-- Legend -->
                <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #00897b;">Renk Açıklaması:</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: #c8e6c9; border: 1px solid #2e7d32; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">Geçerli</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: #fff9c4; border: 1px solid #f57f17; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">Yakında dolacak (≤7 gün)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 20px; background: #ffcdd2; border: 1px solid #c62828; border-radius: 3px;"></div>
                        <span style="font-size: 0.9em;">Süresi dolmuş / ISO 9001 yok</span>
                    </div>
                </div>
                
                <!-- Single Scrollable Table Container -->
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: auto; max-height: 650px;">
                    <table style="border-collapse: collapse; width: max-content; min-width: 100%;">
                        <thead>
                            <tr>
                                <th style="position: sticky; left: 0; top: 0; z-index: 3; min-width: 50px; max-width: 50px;
                                           background: linear-gradient(135deg, #00897b 0%, #00695c 100%); color: white; 
                                           padding: 8px 10px; font-weight: 600; font-size: 0.82em; text-align: left;
                                           border-right: 3px solid #00695c; border-bottom: 2px solid #00695c;">
                                    Tedarikçi Adı
                                </th>`;

            // Belge türü başlıkları
            qualityCertTypes.forEach((cert, index) => {
                const isCustom = cert.custom || false;
                const deleteBtn = isCustom ? `<span onclick="removeQualityCertType(${index})" style="cursor: pointer; margin-left: 4px; color: #f44336; font-size: 0.9em;" title="Sil">✕</span>` : '';
                html += `
                                <th style="position: sticky; top: 0; z-index: 2; min-width: ${colWidth}px; max-width: ${colWidth}px;
                                           background: linear-gradient(135deg, ${isCustom ? '#673ab7' : '#00897b'} 0%, ${isCustom ? '#512da8' : '#00695c'} 100%); color: white;
                                           padding: 8px; font-weight: 600; font-size: 0.85em; text-align: center;
                                           border-right: 1px solid rgba(255,255,255,0.3); border-bottom: 2px solid ${isCustom ? '#512da8' : '#00695c'};">
                                    ${cert.label}${deleteBtn}
                                </th>`;
            });
            
            // Yeni belge türü ekleme butonu
            html += `
                                <th style="position: sticky; top: 0; z-index: 2; min-width: 50px;
                                           background: linear-gradient(135deg, #673ab7 0%, #512da8 100%); color: white;
                                           padding: 8px; font-weight: 600; font-size: 0.85em; text-align: center;
                                           border-right: 1px solid rgba(255,255,255,0.3); border-bottom: 2px solid #512da8; cursor: pointer;"
                                     onclick="addNewQualityCertType()" title="Yeni Belge Türü Ekle">
                                    ➕
                                </th>`;

            html += `
                            </tr>
                        </thead>
                        <tbody>`;

            // Satırları ekle
            for (let i = 0; i < suppliers.length; i++) {
                const supplier = suppliers[i];
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                const rowBg = i % 2 === 0 ? '#fff' : '#fafafa';

                html += `
                            <tr class="qcMatrixRow" data-supplier="${supplierName.toLowerCase()}">
                                <td style="position: sticky; left: 0; z-index: 1; min-width: 50px; max-width: 50px;
                                           padding: 8px 10px; border-bottom: 1px solid #e0e0e0; border-right: 3px solid #00897b;
                                           background: ${rowBg}; font-size: 0.82em; color: #333; font-weight: 500;
                                           white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${supplierName}
                                </td>`;

                for (const cert of qualityCertTypes) {
                    const hasCert = supplier[cert.key];
                    const expiryDate = supplier.certExpiryDates?.[cert.key];
                    
                    let cellContent = '-';
                    let bgColor = rowBg;
                    let textColor = '#999';
                    
                    // ISO 9001 yoksa kırmızı
                    if (cert.key === 'iso9001' && !hasCert) {
                        bgColor = '#ffcdd2';
                        textColor = '#c62828';
                        cellContent = 'YOK';
                    } else if (hasCert) {
                        if (expiryDate) {
                            const status = getExpiryStatus(expiryDate);
                            bgColor = status.color;
                            textColor = status.textColor;
                            cellContent = status.text;
                        } else {
                            // Var ama tarih yok
                            bgColor = '#e0e0e0';
                            textColor = '#666';
                            cellContent = 'Var';
                        }
                    }

                    html += `
                                <td style="min-width: ${colWidth}px; max-width: ${colWidth}px; padding: 8px;
                                           border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0;
                                           background: ${bgColor}; color: ${textColor}; font-size: 0.8em; 
                                           text-align: center; font-weight: 500;">
                                    ${cellContent}
                                </td>`;
                }
                
                // Boş hücre (yeni türler için)
                html += `
                                <td style="min-width: 50px; padding: 8px;
                                           border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0;
                                           background: ${rowBg}; text-align: center;">
                                </td>`;

                html += `
                            </tr>`;
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html;
        }

        function filterQualityCertMatrix() {
            const searchTerm = document.getElementById('qcMatrixSearchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('.qcMatrixRow');
            
            rows.forEach(row => {
                const supplierName = row.getAttribute('data-supplier');
                if (!searchTerm || supplierName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function exportQualityCertMatrixPDF() {
            showAlert('📄 PDF oluşturuluyor...', 'info');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            // Üst Başlık (Kalite Belge Matrisi)
            doc.setFillColor(0, 137, 123);
            doc.rect(0, 0, 297, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Kalite Belge Matrisi', 148.5, 12, { align: 'center' });

            // Tarih
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(255, 255, 255);
            doc.text(`Oluşturma: ${new Date().toLocaleString('tr-TR')}`, 15, 17);

            // Tablo başlıkları
            const headers = [['Tedarikçi', ...qualityCertTypes.map(cert => cert.label)]];
            
            // Tablo verileri
            const tableData = [];
            
            for (const supplier of qcMatrixCurrentSuppliers) {
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                const row = [supplierName];

                for (const cert of qualityCertTypes) {
                    const hasCert = supplier[cert.key];
                    const expiryDate = supplier.certExpiryDates?.[cert.key];
                    
                    let cellText = '-';
                    
                    if (cert.key === 'iso9001' && !hasCert) {
                        cellText = 'YOK';
                    } else if (hasCert) {
                        if (expiryDate) {
                            const status = getExpiryStatus(expiryDate);
                            cellText = status.text;
                        } else {
                            cellText = 'Var';
                        }
                    }

                    row.push(cellText);
                }

                tableData.push(row);
            }

            // autoTable ile tablo oluştur
            doc.autoTable({
                startY: 25,
                head: headers,
                body: tableData,
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 137, 123],
                    textColor: [255, 255, 255],
                    fontSize: 9,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                columnStyles: {
                    0: { cellWidth: 60, halign: 'left' }
                },
                styles: {
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1
                },
                didParseCell: function(data) {
                    // Renklendirme
                    if (data.section === 'body' && data.column.index > 0) {
                        const cellValue = data.cell.raw;
                        const supplier = qcMatrixCurrentSuppliers[data.row.index];
                        const cert = qualityCertTypes[data.column.index - 1];
                        const hasCert = supplier[cert.key];
                        const expiryDate = supplier.certExpiryDates?.[cert.key];
                        
                        if (cert.key === 'iso9001' && !hasCert) {
                            data.cell.styles.fillColor = [255, 205, 210]; // Kırmızı
                        } else if (hasCert && expiryDate) {
                            const status = getExpiryStatus(expiryDate);
                            if (status.status === 'expired') {
                                data.cell.styles.fillColor = [255, 205, 210]; // Kırmızı
                            } else if (status.status === 'warning') {
                                data.cell.styles.fillColor = [255, 249, 196]; // Sarı
                            } else {
                                data.cell.styles.fillColor = [200, 230, 201]; // Yeşil
                            }
                        } else if (cellValue === '-') {
                            data.cell.styles.fillColor = [245, 245, 245]; // Gri
                        } else if (cellValue === 'Var') {
                            data.cell.styles.fillColor = [224, 224, 224]; // Açık gri
                        }
                        
                        data.cell.styles.halign = 'center';
                    }
                }
            });

            // PDF'i indir
            const fileName = `Kalite_Belge_Matrisi_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
            
            showAlert('✅ PDF başarıyla oluşturuldu!', 'success');
        }

        async function exportQualityCertMatrixExcel() {
            showAlert('📊 Excel oluşturuluyor...', 'info');

            // Excel verilerini hazırla
            const excelData = [];
            
            // Başlık satırı
            const headerRow = ['Tedarikçi Adı'];
            qualityCertTypes.forEach(cert => headerRow.push(cert.label));
            excelData.push(headerRow);

            // Veri satırları
            for (const supplier of qcMatrixCurrentSuppliers) {
                const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                const row = [supplierName];

                for (const cert of qualityCertTypes) {
                    const hasCert = supplier[cert.key];
                    const expiryDate = supplier.certExpiryDates?.[cert.key];
                    
                    let cellText = '-';
                    
                    if (cert.key === 'iso9001' && !hasCert) {
                        cellText = 'YOK';
                    } else if (hasCert) {
                        if (expiryDate) {
                            const status = getExpiryStatus(expiryDate);
                            cellText = status.text;
                        } else {
                            cellText = 'Var';
                        }
                    }

                    row.push(cellText);
                }

                excelData.push(row);
            }

            // Worksheet oluştur
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // Sütun genişliklerini ayarla
            const colWidths = [{ wch: 40 }];
            qualityCertTypes.forEach(() => colWidths.push({ wch: 16 }));
            ws['!cols'] = colWidths;

            // Workbook oluştur
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Kalite Belge Matrisi');

            // Excel dosyasını indir
            const fileName = `Kalite_Belge_Matrisi_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showAlert('✅ Excel oluşturuldu!', 'success');
        }

        function saveSupplierInfo() {
            if (!currentSupplierInfoName) {
                showAlert('❌ Tedarikçi seçilemedi', 'error');
                return;
            }

            const info = {
                material: document.getElementById('infoMaterial').value || '',
                type: document.getElementById('infoType').value || '',
                customers: document.getElementById('infoCustomers').value || '',
                primaryName: document.getElementById('infoPrimaryName').value || '',
                title: document.getElementById('infoTitle').value || '',
                primaryEmail: document.getElementById('infoPrimaryEmail').value || '',
                gsm: document.getElementById('infoGsm').value || '',
                phone2: document.getElementById('infoPhone2').value || '',
                extension: document.getElementById('infoExtension').value || '',
                backupName: document.getElementById('infoBackupName').value || '',
                backupTitle: document.getElementById('infoBackupTitle').value || '',
                backupEmail: document.getElementById('infoBackupEmail').value || '',
                backupGsm: document.getElementById('infoBackupGsm').value || '',
                backupPhone2: document.getElementById('infoBackupPhone2').value || '',
                backupExtension: document.getElementById('infoBackupExtension').value || '',
                address: document.getElementById('infoAddress').value || ''
            };

            setSupplierInfo(currentSupplierInfoName, info);
            closeSupplierInfoModal();

            if (lastFilteredResults && lastFilteredResults.length > 0) {
                renderTable(lastFilteredResults);
            } else {
                renderTable(allResults);
            }
        }

        // Doküman türü yöneticisi modalını aç
        async function openDocTypeManager(currentSupplier = null) {
            const globalTypes = getDocumentTypes();
            let customTypes = [];
            
            // Eğer tedarikçi belirtilmişse, özel türlerini al
            if (currentSupplier) {
                try {
                    const normalizedName = normalizeName(currentSupplier);
                    const transaction = db.transaction([DOC_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(DOC_STORE_NAME);
                    const getRequest = store.get(normalizedName);
                    
                    await new Promise((resolve, reject) => {
                        getRequest.onsuccess = () => {
                            const record = getRequest.result;
                            if (record && record.customTypes) {
                                customTypes = record.customTypes.filter(ct => !globalTypes.includes(ct));
                            }
                            resolve();
                        };
                        getRequest.onerror = reject;
                    });
                } catch (err) {
                    console.error('Özel türler yüklenemedi:', err);
                }
            }
            
            const types = getDocumentTypes();
            
            let html = `
                <div id="docTypeManagerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10001;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1e3c72;">⚙️ Doküman Türlerini Yönet</h3>
                            <button onclick="closeDocTypeManager()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">✕</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div style="font-weight: 600; margin-bottom: 5px;">💡 Yeni Doküman Türü Ekle</div>
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                ${currentSupplier ? `Şu anda: <strong>${currentSupplier}</strong>` : 'Tüm tedarikçiler için'}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newDocTypeName" placeholder="Örn: ISO 9001, Kalite Belgesi..." style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.95em;">
                                <button onclick="addNewDocType('${currentSupplier ? currentSupplier.replace(/'/g, "\\'") : ''}')" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">➕ Ekle</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px; font-weight: 600; color: #666;">📋 Mevcut Türler (${types.length + customTypes.length})</div>
                        <div id="docTypesList" style="max-height: 400px; overflow-y: auto;">
            `;
            
            types.forEach((type, idx) => {
                html += `
                    <div draggable="true" 
                         data-type="${type}" 
                         data-index="${idx}"
                         ondragstart="handleDragStart(event)" 
                         ondragover="handleDragOver(event)" 
                         ondrop="handleDrop(event, '${currentSupplier ? currentSupplier.replace(/'/g, "\\'") : ''}')" 
                         ondragend="handleDragEnd(event)"
                         style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: ${idx % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 6px; border: 1px solid #e0e0e0; border-left: 3px solid #2196f3; cursor: move; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <div style="cursor: grab; color: #999; font-size: 1.2em; user-select: none;" title="Sürükle">☰</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #333;">${type}</div>
                                <div style="font-size: 0.75em; color: #666; margin-top: 2px;">🌍 Global (Tüm tedarikçiler)</div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteDocType('${type.replace(/'/g, "\\'")}', '${currentSupplier ? currentSupplier.replace(/'/g, "\\'") : ''}')" 
                            style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">🗑️</button>
                    </div>
                `;
            });
            
            customTypes.forEach((type, idx) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: ${idx % 2 === 0 ? '#fff3e0' : '#fffaf0'}; border-radius: 6px; border: 1px solid #e0e0e0; border-left: 3px solid #ff9800;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #333;">${type}</div>
                            <div style="font-size: 0.75em; color: #666; margin-top: 2px;">👤 Özel (Sadece ${currentSupplier})</div>
                        </div>
                        <button onclick="deleteDocType('${type.replace(/'/g, "\\'")}', '${currentSupplier ? currentSupplier.replace(/'/g, "\\'") : ''}')" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">🗑️ Sil</button>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        
                        <div style="margin-top: 20px; padding: 12px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3; font-size: 0.9em;">
                            <strong>☰ Sürükle & Bırak:</strong> Türleri sürükleyerek istediğiniz sıraya koyabilirsiniz. Sol taraftaki ☰ simgesinden tutup taşıyın. Sıralama tüm tedarikçilerde aynı olacaktır.
                        </div>
                        
                        <div style="margin-top: 10px; padding: 12px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #4caf50; font-size: 0.9em;">
                            <strong>ℹ️ Bilgi:</strong> Yeni türler tüm tedarikçiler için kullanılabilir olacaktır.
                        </div>
                        
                        <div style="margin-top: 10px; padding: 12px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107; font-size: 0.9em;">
                            <strong>⚠️ Uyarı:</strong> Bir türü sildiğinizde, o türdeki dokümanlar için işlem seçmeniz gerekecektir.
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeDocTypeManager() {
            const modal = document.getElementById('docTypeManagerModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Drag & Drop için global değişkenler
        let draggedElement = null;
        let draggedType = null;
        
        function handleDragStart(event) {
            draggedElement = event.target;
            draggedType = event.target.getAttribute('data-type');
            event.target.style.opacity = '0.4';
            event.target.style.cursor = 'grabbing';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        }
        
        function handleDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            
            const targetElement = event.currentTarget;
            if (targetElement !== draggedElement && targetElement.hasAttribute('draggable')) {
                // Görsel geri bildirim
                targetElement.style.borderTop = '3px solid #2196f3';
            }
            
            return false;
        }
        
        function handleDrop(event, currentSupplier) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            
            const targetElement = event.currentTarget;
            targetElement.style.borderTop = '';
            
            if (draggedElement !== targetElement && targetElement.hasAttribute('draggable')) {
                const targetType = targetElement.getAttribute('data-type');
                
                // Sıralamayı güncelle
                const types = getDocumentTypes();
                const draggedIndex = types.indexOf(draggedType);
                const targetIndex = types.indexOf(targetType);
                
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    // Array'den çıkar
                    types.splice(draggedIndex, 1);
                    // Yeni pozisyona ekle
                    types.splice(targetIndex, 0, draggedType);
                    
                    // Kaydet
                    saveDocumentTypes(types);
                    DOCUMENT_TYPES = types;
                    
                    // Modal'ı yenile
                    closeDocTypeManager();
                    setTimeout(() => openDocTypeManager(currentSupplier), 50);
                    
                    // Doküman modalını da yenile
                    refreshDocModalIfOpen();
                    
                    showAlert(`✅ "${draggedType}" sıralaması güncellendi`, 'success');
                }
            }
            
            return false;
        }
        
        function handleDragEnd(event) {
            event.target.style.opacity = '1';
            event.target.style.cursor = 'move';
            
            // Tüm border'ları temizle
            document.querySelectorAll('[draggable="true"]').forEach(el => {
                el.style.borderTop = '';
            });
        }
        
        // Eski buton fonksiyonlarını kaldır - artık drag & drop kullanıyoruz
        function moveTypeUp(type, currentSupplier = '') {
            // Bu fonksiyon artık kullanılmıyor - drag & drop ile değiştirildi
        }
        
        function moveTypeDown(type, currentSupplier = '') {
            // Bu fonksiyon artık kullanılmıyor - drag & drop ile değiştirildi
        }

        async function addNewDocType(currentSupplier = '') {
            const input = document.getElementById('newDocTypeName');
            const newType = input.value.trim();
            
            if (!newType) {
                showAlert('⚠️ Lütfen doküman türü adı girin', 'error');
                return;
            }
            
            // Scope sorusu
            if (currentSupplier) {
                // Modal ile scope seçimi göster
                showAddScopeModal(newType, currentSupplier);
            } else {
                // Tedarikçi bağlamında değilse, direkt global ekle
                if (addDocumentType(newType)) {
                    showAlert(`✅ "${newType}" türü tüm tedarikçiler için eklendi!`, 'success');
                    input.value = '';
                    closeDocTypeManager();
                    refreshDocModalIfOpen();
                } else {
                    showAlert(`⚠️ "${newType}" türü zaten mevcut!`, 'error');
                }
            }
        }
        
        // Doküman türü ekleme scope seçimi modalı
        function showAddScopeModal(newType, currentSupplier) {
            let html = `
                <div id="addScopeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10003;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 550px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 3em; margin-bottom: 10px;">➕</div>
                            <h3 style="margin: 0; color: #1e3c72; font-size: 1.3em;">"${newType}" Türü Nereye Eklensin?</h3>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 5px; color: #333;">Şu anda:</div>
                            <div style="font-size: 0.95em; color: #666;">
                                📍 Tedarikçi: <strong>${currentSupplier}</strong>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                            <button onclick="addDocTypeGlobal('${newType.replace(/'/g, "\\'")}'); closeAddScopeModal();" 
                                style="padding: 14px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76,175,80,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.4em;">🌍</span>
                                <div style="text-align: left; flex: 1;">
                                    <div>Tüm Tedarikçilere Ekle</div>
                                    <div style="font-size: 0.75em; font-weight: normal; opacity: 0.9;">Tüm tedarikçiler bu türü kullanabilir</div>
                                </div>
                            </button>
                            
                            <button onclick="addDocTypeLocal('${newType.replace(/'/g, "\\'")}', '${currentSupplier.replace(/'/g, "\\'")}'); closeAddScopeModal();" 
                                style="padding: 14px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(33,150,243,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.4em;">👤</span>
                                <div style="text-align: left; flex: 1;">
                                    <div>Sadece "${currentSupplier}" Tedarikçisine Ekle</div>
                                    <div style="font-size: 0.75em; font-weight: normal; opacity: 0.9;">Sadece bu tedarikçi için özel tür</div>
                                </div>
                            </button>
                            
                            <button onclick="closeAddScopeModal()" 
                                style="padding: 12px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.3s;" 
                                onmouseover="this.style.background='#616161';" 
                                onmouseout="this.style.background='#757575';">
                                <span style="font-size: 1.2em;">❌</span>
                                <span>İptal</span>
                            </button>
                        </div>
                        
                        <div style="padding: 12px; background: #fff3cd; border-radius: 6px; font-size: 0.85em; color: #856404; text-align: center;">
                            <strong>💡 İpucu:</strong> Global türler tüm tedarikçilerde görünür, özel türler sadece seçili tedarikçide
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeAddScopeModal() {
            const modal = document.getElementById('addScopeModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Global ekleme işlemi
        function addDocTypeGlobal(newType) {
            const input = document.getElementById('newDocTypeName');
            
            if (addDocumentType(newType)) {
                showAlert(`✅ "${newType}" türü tüm tedarikçiler için eklendi!`, 'success');
                if (input) input.value = '';
                closeDocTypeManager();
                refreshDocModalIfOpen();
            } else {
                showAlert(`⚠️ "${newType}" türü zaten mevcut!`, 'error');
            }
        }
        
        // Local ekleme işlemi
        async function addDocTypeLocal(newType, currentSupplier) {
            const input = document.getElementById('newDocTypeName');
            
            try {
                const normalizedName = normalizeName(currentSupplier);
                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(DOC_STORE_NAME);
                const getRequest = store.get(normalizedName);
                
                getRequest.onsuccess = () => {
                    let record = getRequest.result;
                    
                    if (!record) {
                        record = {
                            normalizedName: normalizedName,
                            supplierName: currentSupplier,
                            documents: {},
                            customTypes: [],
                            lastUpdated: new Date().toISOString()
                        };
                    }
                    
                    if (!record.customTypes) {
                        record.customTypes = [];
                    }
                    
                    // Global türlerde veya custom türlerde var mı kontrol et
                    const globalTypes = getDocumentTypes();
                    if (globalTypes.includes(newType) || record.customTypes.includes(newType)) {
                        showAlert(`⚠️ "${newType}" türü zaten mevcut!`, 'error');
                        return;
                    }
                    
                    record.customTypes.push(newType);
                    record.documents[newType] = [];
                    record.lastUpdated = new Date().toISOString();
                    
                    const putRequest = store.put(record);
                    putRequest.onsuccess = () => {
                        showAlert(`✅ "${newType}" türü "${currentSupplier}" için eklendi!`, 'success');
                        if (input) input.value = '';
                        closeDocTypeManager();
                        setTimeout(() => openDocumentModal(currentSupplier), 100);
                    };
                    
                    putRequest.onerror = () => {
                        showAlert('❌ Tür eklenemedi!', 'error');
                    };
                };
                
                getRequest.onerror = () => {
                    showAlert('❌ Tedarikçi bilgisi alınamadı!', 'error');
                };
            } catch (err) {
                console.error('Tür ekleme hatası:', err);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }

        // Doküman türü silme scope seçimi modalı
        function showDeleteScopeModal(typeToDelete, currentSupplier) {
            let html = `
                <div id="deleteScopeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10003;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 550px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 3em; margin-bottom: 10px;">🗑️</div>
                            <h3 style="margin: 0; color: #d32f2f; font-size: 1.3em;">"${typeToDelete}" Türü Nereden Silinsin?</h3>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 5px; color: #333;">Şu anda:</div>
                            <div style="font-size: 0.95em; color: #666;">
                                📍 Tedarikçi: <strong>${currentSupplier}</strong>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                            <button onclick="deleteDocTypeGlobal('${typeToDelete.replace(/'/g, "\\'")}'); closeDeleteScopeModal();" 
                                style="padding: 14px; background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(244,67,54,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.4em;">🌍</span>
                                <div style="text-align: left; flex: 1;">
                                    <div>Tüm Tedarikçilerden Sil</div>
                                    <div style="font-size: 0.75em; font-weight: normal; opacity: 0.9;">Tüm tedarikçilerdeki bu tür silinir</div>
                                </div>
                            </button>
                            
                            <button onclick="deleteDocTypeLocal('${typeToDelete.replace(/'/g, "\\'")}', '${currentSupplier.replace(/'/g, "\\'")}'); closeDeleteScopeModal();" 
                                style="padding: 14px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,152,0,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.4em;">👤</span>
                                <div style="text-align: left; flex: 1;">
                                    <div>Sadece "${currentSupplier}" Tedarikçisinden Sil</div>
                                    <div style="font-size: 0.75em; font-weight: normal; opacity: 0.9;">Sadece bu tedarikçideki tür silinir</div>
                                </div>
                            </button>
                            
                            <button onclick="closeDeleteScopeModal()" 
                                style="padding: 12px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.3s;" 
                                onmouseover="this.style.background='#616161';" 
                                onmouseout="this.style.background='#757575';">
                                <span style="font-size: 1.2em;">❌</span>
                                <span>İptal</span>
                            </button>
                        </div>
                        
                        <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; font-size: 0.85em; color: #1565c0; text-align: center;">
                            <strong>💡 İpucu:</strong> Tümünden silerseniz, dokümanlar varsa ne yapılacağını sonra seçebilirsiniz
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDeleteScopeModal() {
            const modal = document.getElementById('deleteScopeModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Global silme işlemini başlat
        async function deleteDocTypeGlobal(typeToDelete) {
            // Tüm tedarikçilerde bu türde doküman var mı kontrol et
            let totalDocs = 0;
            const affectedSuppliers = [];
            
            try {
                const transaction = db.transaction([DOC_STORE_NAME], 'readonly');
                const store = transaction.objectStore(DOC_STORE_NAME);
                const allDocsRequest = store.getAll();
                
                allDocsRequest.onsuccess = async () => {
                    const allRecords = allDocsRequest.result;
                    
                    // Bu türde dokümanı olan tedarikçileri bul
                    allRecords.forEach(record => {
                        if (record.documents && record.documents[typeToDelete] && record.documents[typeToDelete].length > 0) {
                            totalDocs += record.documents[typeToDelete].length;
                            affectedSuppliers.push({
                                name: record.supplierName,
                                docs: record.documents[typeToDelete]
                            });
                        }
                    });
                    
                    if (totalDocs === 0) {
                        // Doküman yok, direkt sil
                        if (confirm(`⚠️ "${typeToDelete}" türünü silmek istediğinize emin misiniz?\n\nBu türde doküman bulunmuyor.`)) {
                            if (removeDocumentType(typeToDelete)) {
                                showAlert(`✅ "${typeToDelete}" türü silindi!`, 'success');
                                closeDocTypeManager();
                                refreshDocModalIfOpen();
                            } else {
                                showAlert('❌ Tür silinemedi!', 'error');
                            }
                        }
                        return;
                    }
                    
                    // Doküman var, kullanıcıya seçenek sun
                    showDocumentActionDialog(typeToDelete, affectedSuppliers, totalDocs);
                };
                
                allDocsRequest.onerror = () => {
                    showAlert('❌ Dokümanlar kontrol edilemedi!', 'error');
                };
            } catch (err) {
                console.error('Doküman kontrol hatası:', err);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }

        async function deleteDocType(typeToDelete, currentSupplier = '') {
            // Önce bu türün global mi custom mi olduğunu kontrol et
            const globalTypes = getDocumentTypes();
            const isGlobalType = globalTypes.includes(typeToDelete);
            
            // Scope sorusu (sadece tedarikçi bağlamında açıldıysa ve global türse)
            if (currentSupplier && isGlobalType) {
                // Modal ile scope seçimi göster
                showDeleteScopeModal(typeToDelete, currentSupplier);
                return;
            } else if (!isGlobalType && currentSupplier) {
                // Custom tür ise direkt local sil
                await deleteDocTypeLocal(typeToDelete, currentSupplier);
                return;
            }
            
            // Global silme - tüm tedarikçilerden
            // Tüm tedarikçilerde bu türde doküman var mı kontrol et
            let totalDocs = 0;
            const affectedSuppliers = [];
            
            try {
                const transaction = db.transaction([DOC_STORE_NAME], 'readonly');
                const store = transaction.objectStore(DOC_STORE_NAME);
                const allDocsRequest = store.getAll();
                
                allDocsRequest.onsuccess = async () => {
                    const allRecords = allDocsRequest.result;
                    
                    // Bu türde dokümanı olan tedarikçileri bul
                    allRecords.forEach(record => {
                        if (record.documents && record.documents[typeToDelete] && record.documents[typeToDelete].length > 0) {
                            totalDocs += record.documents[typeToDelete].length;
                            affectedSuppliers.push({
                                name: record.supplierName,
                                docs: record.documents[typeToDelete]
                            });
                        }
                    });
                    
                    if (totalDocs === 0) {
                        // Doküman yok, direkt sil
                        if (confirm(`⚠️ "${typeToDelete}" türünü silmek istediğinize emin misiniz?\n\nBu türde doküman bulunmuyor.`)) {
                            if (removeDocumentType(typeToDelete)) {
                                showAlert(`✅ "${typeToDelete}" türü silindi!`, 'success');
                                closeDocTypeManager();
                                refreshDocModalIfOpen();
                            } else {
                                showAlert('❌ Tür silinemedi!', 'error');
                            }
                        }
                        return;
                    }
                    
                    // Doküman var, kullanıcıya seçenek sun
                    showDocumentActionDialog(typeToDelete, affectedSuppliers, totalDocs);
                };
                
                allDocsRequest.onerror = () => {
                    showAlert('❌ Dokümanlar kontrol edilemedi!', 'error');
                };
            } catch (err) {
                console.error('Doküman kontrol hatası:', err);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }
        
        // Global değişken - taşıma işlemi için
        let pendingMoveOperation = null;
        let pendingDeleteOperation = null;
        
        // Doküman içeren tür silinirken seçenek sun
        function showDocumentActionDialog(typeToDelete, affectedSuppliers, totalDocs) {
            // Global değişkene kaydet
            pendingDeleteOperation = {
                typeToDelete: typeToDelete,
                affectedSuppliers: affectedSuppliers,
                totalDocs: totalDocs
            };
            
            // Tedarikçi listesini oluştur
            const supplierList = affectedSuppliers.slice(0, 5).map(s => `• ${s.name} (${s.docs.length} doküman)`).join('<br>');
            const extraSuppliersText = affectedSuppliers.length > 5 ? `<br>• ...ve ${affectedSuppliers.length - 5} tedarikçi daha` : '';
            
            let html = `
                <div id="docActionModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 3em; margin-bottom: 10px;">⚠️</div>
                            <h3 style="margin: 0; color: #d32f2f; font-size: 1.3em;">Doküman Türü Silme İşlemi</h3>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #333;">📊 Silinecek Tür:</div>
                            <div style="font-size: 1.1em; color: #d32f2f; font-weight: 600; margin-bottom: 12px;">"${typeToDelete}"</div>
                            <div style="font-size: 0.95em; color: #666;">
                                • <strong style="color: #d32f2f;">${totalDocs} doküman</strong> bulundu<br>
                                • <strong>${affectedSuppliers.length} tedarikçi</strong> etkilenecek
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 12px; background: #f5f5f5; border-radius: 6px; font-size: 0.85em;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Etkilenen Tedarikçiler:</div>
                            <div style="color: #666;">${supplierList}${extraSuppliersText}</div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #333;">Ne yapmak istersiniz?</div>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                            <button onclick="handleMoveDocuments()" 
                                style="padding: 14px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76,175,80,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.4em;">📦</span>
                                <div style="text-align: left; flex: 1;">
                                    <div>Başka Türe Taşı (Tüm Tedarikçiler)</div>
                                    <div style="font-size: 0.75em; font-weight: normal; opacity: 0.9;">Dokümanlar kaybolmaz, başka türe aktarılır</div>
                                </div>
                            </button>
                            
                            <button onclick="handleDeleteAllDocuments()" 
                                style="padding: 14px; background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(244,67,54,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.4em;">🗑️</span>
                                <div style="text-align: left; flex: 1;">
                                    <div>Tüm Tedarikçilerden Sil</div>
                                    <div style="font-size: 0.75em; font-weight: normal; opacity: 0.9;">Tüm dokümanlar kalıcı olarak silinir</div>
                                </div>
                            </button>
                            
                            <button onclick="closeDocActionModal()" 
                                style="padding: 14px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.background='#616161';" 
                                onmouseout="this.style.background='#757575';">
                                <span style="font-size: 1.2em;">❌</span>
                                <span>İptal</span>
                            </button>
                        </div>
                        
                        <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; font-size: 0.85em; color: #1565c0; text-align: center;">
                            <strong>💡 İpucu:</strong> Dokümanları taşımak daha güvenlidir
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDocActionModal() {
            const modal = document.getElementById('docActionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function handleMoveDocuments() {
            if (!pendingDeleteOperation) return;
            const { typeToDelete, affectedSuppliers, totalDocs } = pendingDeleteOperation;
            pendingDeleteOperation = null;
            closeDocActionModal();
            showMoveDocumentsDialog(typeToDelete, affectedSuppliers, totalDocs);
        }
        
        function handleDeleteAllDocuments() {
            if (!pendingDeleteOperation) return;
            const { typeToDelete, affectedSuppliers, totalDocs } = pendingDeleteOperation;
            pendingDeleteOperation = null;
            closeDocActionModal();
            confirmDeleteAllDocuments(typeToDelete, affectedSuppliers, totalDocs);
        }
        
        function showMoveDialog(fromType, affectedSuppliersJSON, totalDocs) {
            const affectedSuppliers = typeof affectedSuppliersJSON === 'string' ? JSON.parse(affectedSuppliersJSON) : affectedSuppliersJSON;
            showMoveDocumentsDialog(fromType, affectedSuppliers, totalDocs);
        }
        
        async function confirmDeleteAllDocuments(typeToDelete, affectedSuppliers, totalDocs) {
            if (typeof affectedSuppliers === 'string') {
                affectedSuppliers = JSON.parse(affectedSuppliers);
            }
            
            // İkinci onay modalı göster
            const supplierList = affectedSuppliers.slice(0, 5).map(s => `• ${s.name} (${s.docs.length} doküman)`).join('<br>');
            const extraSuppliersText = affectedSuppliers.length > 5 ? `<br>• ...ve ${affectedSuppliers.length - 5} tedarikçi daha` : '';
            
            let html = `
                <div id="deleteConfirmModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 10003;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 650px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 4em; margin-bottom: 10px; animation: shake 0.5s;">⚠️</div>
                            <h3 style="margin: 0; color: #d32f2f; font-size: 1.4em;">KALICI SİLME ONAYI</h3>
                        </div>
                        
                        <div style="background: #ffebee; padding: 20px; border-radius: 8px; border: 2px solid #f44336; margin-bottom: 20px;">
                            <div style="font-weight: 700; margin-bottom: 12px; color: #c62828; font-size: 1.1em; text-align: center;">
                                ${totalDocs} DOKÜMAN SİLİNECEK!
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Silinecek Tür:</div>
                                <div style="font-size: 1.05em; color: #d32f2f; font-weight: 600;">"${typeToDelete}"</div>
                            </div>
                            <div style="font-size: 0.9em; color: #c62828; font-weight: 600; text-align: center;">
                                ⛔ BU İŞLEM GERİ ALINAMAZ!
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Etkilenen Tedarikçiler (${affectedSuppliers.length}):</div>
                            <div style="font-size: 0.85em; color: #666;">${supplierList}${extraSuppliersText}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; font-size: 0.9em;">
                            <strong>⚠️ ÖNEMLİ:</strong> Bu işlem TÜM TEDARİKÇİLERDEKİ "${typeToDelete}" türündeki dokümanları kalıcı olarak silecektir. Bu işlem geri alınamaz!
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="executeDeleteAllDocuments('${typeToDelete}', ${JSON.stringify(affectedSuppliers).replace(/"/g, '&quot;')}, ${totalDocs})" 
                                style="padding: 14px 20px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1em; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(244,67,54,0.5)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.3em;">🗑️</span>
                                <span>Evet, Tümünden Sil (${totalDocs} Doküman)</span>
                            </button>
                            
                            <button onclick="closeDeleteConfirmModal()" 
                                style="padding: 12px 20px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s;" 
                                onmouseover="this.style.background='#616161';" 
                                onmouseout="this.style.background='#757575';">
                                ❌ Hayır, İptal Et
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 0.8em; color: #666; text-align: center;">
                            💡 İptal ederseniz, dokümanları başka türe taşıma seçeneği ile geri dönebilirsiniz
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-10px); }
                        75% { transform: translateX(10px); }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function executeDeleteAllDocuments(typeToDelete, affectedSuppliers, totalDocs) {
            if (typeof affectedSuppliers === 'string') {
                affectedSuppliers = JSON.parse(affectedSuppliers);
            }
            
            closeDeleteConfirmModal();
            
            try {
                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(DOC_STORE_NAME);
                
                for (const supplier of affectedSuppliers) {
                    const normalizedName = normalizeName(supplier.name);
                    const getRequest = store.get(normalizedName);
                    
                    await new Promise((resolve, reject) => {
                        getRequest.onsuccess = () => {
                            const record = getRequest.result;
                            if (record && record.documents[typeToDelete]) {
                                // Dokümanları sil
                                delete record.documents[typeToDelete];
                                record.lastUpdated = new Date().toISOString();
                                
                                const putRequest = store.put(record);
                                putRequest.onsuccess = resolve;
                                putRequest.onerror = reject;
                            } else {
                                resolve();
                            }
                        };
                        getRequest.onerror = reject;
                    });
                }
                
                // Türü sil
                removeDocumentType(typeToDelete);
                
                showAlert(`✅ "${typeToDelete}" türü ve ${totalDocs} doküman başarıyla silindi.`, 'success');
                closeDocTypeManager();
                refreshDocModalIfOpen();
                
            } catch (err) {
                console.error('Silme hatası:', err);
                showAlert('❌ Dokümanlar silinirken hata oluştu!', 'error');
            }
        }
        
        function showMoveDocumentsDialog(fromType, affectedSuppliers, totalDocs) {
            const types = getDocumentTypes().filter(t => t !== fromType);
            
            if (types.length === 0) {
                showAlert('❌ Başka doküman türü yok! Önce yeni tür ekleyin.', 'error');
                return;
            }
            
            // Global değişkene kaydet
            pendingMoveOperation = {
                fromType: fromType,
                affectedSuppliers: affectedSuppliers,
                totalDocs: totalDocs
            };
            
            // Tedarikçi listesini oluştur
            const supplierList = affectedSuppliers.slice(0, 5).map(s => `• ${s.name} (${s.docs.length} doküman)`).join('<br>');
            const extraSuppliersText = affectedSuppliers.length > 5 ? `<br>• ...ve ${affectedSuppliers.length - 5} tedarikçi daha` : '';
            
            let html = `
                <div id="moveDocsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002;">
                    <div style="background: white; border-radius: 10px; padding: 30px; max-width: 650px; width: 90%; max-height: 85vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 2.5em; margin-bottom: 10px;">📦</div>
                            <h3 style="margin: 0; color: #1e3c72;">Dokümanları Taşı</h3>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #333;">📊 Taşınacak Dokümanlar:</div>
                            <div style="font-size: 1.05em; color: #d32f2f; font-weight: 600; margin-bottom: 10px;">"${fromType}"</div>
                            <div style="font-size: 0.9em; color: #666;">
                                • <strong>${totalDocs} doküman</strong> taşınacak<br>
                                • <strong>${affectedSuppliers.length} tedarikçi</strong> etkilenecek
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 12px; background: #f5f5f5; border-radius: 6px; font-size: 0.85em;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Etkilenen Tedarikçiler:</div>
                            <div style="color: #666;">${supplierList}${extraSuppliersText}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">🎯 Hedef Doküman Türü Seçin:</label>
                            <select id="targetDocType" style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; background: white; cursor: pointer; transition: border-color 0.3s;" onfocus="this.style.borderColor='#2196f3';" onblur="this.style.borderColor='#ddd';">
                                <option value="">-- Hedef Tür Seçin --</option>
            `;
            
            types.forEach(type => {
                html += `<option value="${type}">${type}</option>`;
            });
            
            html += `
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 14px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; font-size: 0.9em;">
                            <strong>ℹ️ Bilgi:</strong> "${fromType}" türündeki tüm dokümanlar seçtiğiniz türe taşınacak ve orijinal tür silinecektir. Bu işlem tüm tedarikçiler için geçerlidir.
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="executeMoveDocuments()" 
                                style="padding: 14px 20px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;" 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76,175,80,0.4)';" 
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                <span style="font-size: 1.3em;">✅</span>
                                <span>Tümüne Taşı ve Türü Sil</span>
                            </button>
                            
                            <button onclick="closeMoveDocsModal()" 
                                style="padding: 12px 20px; background: #757575; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s;" 
                                onmouseover="this.style.background='#616161';" 
                                onmouseout="this.style.background='#757575';">
                                ❌ İptal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeMoveDocsModal() {
            const modal = document.getElementById('moveDocsModal');
            if (modal) {
                modal.remove();
            }
            pendingMoveOperation = null;
        }
        
        async function executeMoveDocuments() {
            if (!pendingMoveOperation) {
                showAlert('❌ İşlem bilgisi bulunamadı!', 'error');
                return;
            }
            
            const targetType = document.getElementById('targetDocType').value;
            
            if (!targetType) {
                showAlert('⚠️ Lütfen hedef doküman türü seçin!', 'error');
                return;
            }
            
            const { fromType, affectedSuppliers, totalDocs } = pendingMoveOperation;
            
            closeMoveDocsModal();
            
            try {
                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(DOC_STORE_NAME);
                let processed = 0;
                
                for (const supplier of affectedSuppliers) {
                    const normalizedName = normalizeName(supplier.name);
                    const getRequest = store.get(normalizedName);
                    
                    await new Promise((resolve, reject) => {
                        getRequest.onsuccess = () => {
                            const record = getRequest.result;
                            if (record && record.documents[fromType]) {
                                // Hedef türe ekle
                                if (!record.documents[targetType]) {
                                    record.documents[targetType] = [];
                                }
                                record.documents[targetType].push(...record.documents[fromType]);
                                
                                // Eski türü sil
                                delete record.documents[fromType];
                                record.lastUpdated = new Date().toISOString();
                                
                                const putRequest = store.put(record);
                                putRequest.onsuccess = () => {
                                    processed++;
                                    resolve();
                                };
                                putRequest.onerror = reject;
                            } else {
                                resolve();
                            }
                        };
                        getRequest.onerror = reject;
                    });
                }
                
                // Türü sil
                removeDocumentType(fromType);
                
                showAlert(`✅ ${totalDocs} doküman "${targetType}" türüne başarıyla taşındı!\n"${fromType}" türü silindi.`, 'success');
                closeDocTypeManager();
                refreshDocModalIfOpen();
                
            } catch (err) {
                console.error('Taşıma hatası:', err);
                showAlert('❌ Dokümanlar taşınırken hata oluştu!', 'error');
            }
        }
        
        function refreshDocModalIfOpen() {
            const docModal = document.getElementById('documentModal');
            if (docModal && docModal.style.display !== 'none') {
                const titleText = document.getElementById('docModalTitle').textContent || '';
                const supplierName = titleText.split(' - ')[0].replace('📄 ', '').trim();
                if (supplierName) {
                    setTimeout(() => openDocumentModal(supplierName), 100);
                }
            }
        }
        
        // Local tür silme - sadece belirli bir tedarikçiden
        async function deleteDocTypeLocal(typeToDelete, supplierName) {
            try {
                const normalizedName = normalizeName(supplierName);
                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(DOC_STORE_NAME);
                const getRequest = store.get(normalizedName);
                
                getRequest.onsuccess = () => {
                    const record = getRequest.result;
                    
                    if (!record) {
                        showAlert('❌ Tedarikçi bulunamadı!', 'error');
                        return;
                    }
                    
                    // Doküman var mı kontrol et
                    const hasDocs = record.documents && record.documents[typeToDelete] && record.documents[typeToDelete].length > 0;
                    
                    if (hasDocs) {
                        const docCount = record.documents[typeToDelete].length;
                        const message = `⚠️ DİKKAT!\n\n"${typeToDelete}" türünde ${docCount} doküman var!\n\n━━━━━━━━━━━━━━━━━━━━━━━━\n\nBu dokümanlar ne olsun?\n\n✅ TAMAM = Dokümanları sil\n❌ İPTAL = İşlemi iptal et`;
                        
                        if (!confirm(message)) {
                            return;
                        }
                        
                        // Dokümanları sil
                        delete record.documents[typeToDelete];
                    }
                    
                    // customTypes'dan kaldır
                    if (record.customTypes) {
                        const index = record.customTypes.indexOf(typeToDelete);
                        if (index > -1) {
                            record.customTypes.splice(index, 1);
                        }
                    }
                    
                    record.lastUpdated = new Date().toISOString();
                    
                    const putRequest = store.put(record);
                    putRequest.onsuccess = () => {
                        showAlert(`✅ "${typeToDelete}" türü "${supplierName}" için silindi!`, 'success');
                        closeDocTypeManager();
                        setTimeout(() => openDocumentModal(supplierName), 100);
                    };
                    
                    putRequest.onerror = () => {
                        showAlert('❌ Tür silinemedi!', 'error');
                    };
                };
                
                getRequest.onerror = () => {
                    showAlert('❌ Tedarikçi bilgisi alınamadı!', 'error');
                };
            } catch (err) {
                console.error('Tür silme hatası:', err);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }
        
        function setupDocumentUploadHandlers(supplierName) {
            const uploadArea = document.getElementById('documentUploadArea');
            const fileInput = document.getElementById('documentFileInput');
            const uploadBtn = document.getElementById('uploadDocBtn');
            const typeSelect = document.getElementById('documentTypeSelect');
            
            // Upload alanı tıklama
            uploadArea.onclick = () => fileInput.click();
            
            // Drag and drop
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.style.background = '#e3f2fd';
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.style.background = '#f0f8ff';
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.style.background = '#fff9c4';
                if (e.dataTransfer.files[0]) {
                    fileInput.files = e.dataTransfer.files;
                    const fileName = e.dataTransfer.files[0].name;
                    uploadArea.querySelector('div:nth-child(3)').textContent = `📎 ${fileName}`;
                }
            };
            
            // Dosya seçildi
            fileInput.onchange = (e) => {
                if (e.target.files[0]) {
                    uploadArea.style.background = '#fff9c4';
                    const fileName = e.target.files[0].name;
                    uploadArea.querySelector('div:nth-child(3)').textContent = `📎 ${fileName}`;
                }
            };
            
            // Upload butonuna tıklama
            uploadBtn.onclick = async () => {
                const file = fileInput.files[0];
                const docType = typeSelect.value;
                const descInput = document.getElementById('documentDescInput');
                const description = descInput ? descInput.value.trim() : '';
                
                if (!file) {
                    showAlert('❌ Lütfen bir dosya seçin', 'error');
                    return;
                }
                
                if (!docType) {
                    showAlert('❌ Lütfen doküman türü seçin', 'error');
                    return;
                }
                
                // Upload göster
                uploadBtn.disabled = true;
                uploadBtn.textContent = '⏳ Yükleniyor...';
                
                try {
                    const result = await saveSupplierDocument(supplierName, docType, file, description);
                    showAlert(`✅ ${file.name} başarıyla yüklendi`, 'success');
                    
                    // Modali yenile
                    fileInput.value = '';
                    typeSelect.value = '';
                    if (descInput) descInput.value = '';
                    uploadArea.style.background = '#f0f8ff';
                    uploadArea.querySelector('div:nth-child(3)').textContent = 'Tıklayın veya sürükleyin';
                    await openDocumentModal(supplierName);
                    
                    // Eğer matris açıksa onu da güncelle
                    const matrixModal = document.getElementById('documentMatrixModal');
                    if (matrixModal && matrixModal.style.display === 'flex') {
                        await showDocumentMatrixModal();
                    }
                    
                } catch (error) {
                    showAlert(`❌ Yükleme hatası: ${error.message}`, 'error');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = '📤 Yükle';
                }
            };
        }

        async function deleteDocumentFromModal(supplierName, docType, fileId, fileName) {
            if (confirm(`${fileName} dokümanını silmek istediğinizden emin misiniz?`)) {
                try {
                    await deleteSupplierDocument(supplierName, docType, fileId);
                    showAlert(`✅ ${fileName} başarıyla silindi`, 'success');
                    
                    // Modalı yeniden yükle
                    await openDocumentModal(supplierName);
                    
                    // Eğer matris açıksa onu da güncelle
                    const matrixModal = document.getElementById('documentMatrixModal');
                    if (matrixModal && matrixModal.style.display === 'flex') {
                        // Silinen doküman türünün başka tedarikçilerde de olmadığını kontrol et
                        await showDocumentMatrixModal();
                    }
                } catch (error) {
                    showAlert(`❌ Silme hatası: ${error.message || error}`, 'error');
                }
            }
        }

        // Modaldan zorunlu olmayan durumu değiştir
        async function toggleExemptFromModal(supplierName, docType) {
            try {
                const result = await toggleExemptDocType(supplierName, docType);
                
                if (result) {
                    showAlert(`${docType} ${result.isExempt ? 'zorunlu değil olarak işaretlendi' : 'zorunlu olarak işaretlendi'}`, 'success');
                    
                    // Modalı yeniden yükle
                    await openDocumentModal(supplierName);
                    
                    // Eğer matris açıksa onu da güncelle
                    const matrixModal = document.getElementById('documentMatrixModal');
                    if (matrixModal && matrixModal.style.display === 'flex' && matrixCurrentSuppliers) {
                        // Bu tedarikçinin satır index'ini bul
                        const rowIndex = matrixCurrentSuppliers.findIndex(s => {
                            const sName = s['Tedarikçi Adı'] || s.name;
                            return sName === supplierName;
                        });
                        
                        if (rowIndex !== -1) {
                            await refreshMatrixRow(rowIndex);
                        }
                    }
                }
            } catch (err) {
                console.error('Zorunlu olmayan durum değiştirme hatası:', err);
                showAlert('❌ Durum değiştirilemedi', 'error');
            }
        }

        // Seçili tedarikçilerde sadece geçerli anahtarlar kalsın
        function normalizeSelectedSuppliers() {
            const validKeys = new Set(allResults.map(r => r.mapKey || r.name));
            let changed = false;
            selectedSuppliers.forEach(key => {
                if (!validKeys.has(key)) {
                    selectedSuppliers.delete(key);
                    changed = true;
                }
            });
            return changed;
        }

        function normalizeSelectedRows() {
            const validKeys = new Set(allResults.map(r => r.mapKey || r.name));
            selectedRows.forEach(key => {
                if (!validKeys.has(key)) {
                    selectedRows.delete(key);
                }
            });
        }

        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            // Sadece uploadArea'dan çıkıldığında kaldır (child elementlerden değil)
            if (e.target === uploadArea) {
                uploadArea.classList.remove('dragover');
            }
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                console.log('📂 Dosya sürüklendi:', file.name);
                processFile(file);
            }
        });

        // İkinci yükleme alanı için drag & drop
        const uploadArea2 = document.getElementById('uploadArea2');
        
        uploadArea2.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.add('dragover');
        });
        
        uploadArea2.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.add('dragover');
        });
        
        uploadArea2.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            // Sadece uploadArea2'den çıkıldığında kaldır (child elementlerden değil)
            if (e.target === uploadArea2) {
                uploadArea2.classList.remove('dragover');
            }
        });
        
        uploadArea2.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                console.log('📅 Aylık dosya sürüklendi:', file.name);
                processFile2(file);
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            // Tüm bildirimler için otomatik kapanma
            let timeout = 3000; // Varsayılan 3 saniye
            if (type === 'error') {
                timeout = 5000; // Hatalar 5 saniye
            } else if (type === 'info' || type === 'warning') {
                timeout = 4000; // Bilgi ve uyarılar 4 saniye
            }
            
            setTimeout(() => container.innerHTML = '', timeout);
        }

        function toggleUploadSection() {
            const container = document.getElementById('uploadContainer');
            const btn = document.getElementById('toggleUploadBtn');
            
            if (container.style.display === 'none') {
                // Açılıyor - aşağı ok göster
                container.style.display = 'grid';
                btn.textContent = '▼';
            } else {
                // Kapanıyor - yukarı ok göster
                container.style.display = 'none';
                btn.textContent = '▲';
            }
        }

        function processFile(file) {
            showAlert('📂 Dosya okunuyor...', 'info');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    showAlert('✅ Dosya başarıyla yüklendi! Analiz ediliyor...', 'success');
                    analyzeData(worksheet);
                } catch (error) {
                    showAlert('❌ Hata: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // İkinci Excel dosyası için handler
        function handleFile2(event) {
            const file = event.target.files[0];
            if (file) processFile2(file);
        }

        function processFile2(file) {
            const statusDiv = document.getElementById('monthlyDataStatus');
            statusDiv.innerHTML = '<div class="alert alert-info">📂 Aylık puan dosyası okunuyor...</div>';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook2 = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook2.Sheets[workbook2.SheetNames[0]];
                    
                    statusDiv.innerHTML = '<div class="alert alert-success">✅ Aylık puan dosyası başarıyla yüklendi!</div>';
                    processMonthlyScores(worksheet);
                } catch (error) {
                    statusDiv.innerHTML = '<div class="alert alert-error">❌ Hata: ' + error.message + '</div>';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processMonthlyScores(worksheet) {
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length < 2) {
                document.getElementById('monthlyDataStatus').innerHTML = 
                    '<div class="alert alert-error">❌ Excel dosyasında yeterli veri bulunamadı!</div>';
                return;
            }

            const headers = jsonData[0];
            const rows = jsonData.slice(1);

            console.log('=== AYLIK PUAN DOSYASI ANALİZİ ===');
            console.log('Toplam Sütun Sayısı:', headers.length);
            console.log('Sütun Başlıkları:', headers);
            console.log('İlk 3 Satır:', rows.slice(0, 3));

            // Tedarikçi sütununu bul
            let supplierColIndex = -1;
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).toLowerCase().trim();
                if (header.includes('tedarik') || header.includes('firma') || header.includes('supplier') || header.includes('company')) {
                    supplierColIndex = i;
                    console.log('Tedarikçi sütunu bulundu:', headers[i], 'Index:', i);
                    break;
                }
            }

            if (supplierColIndex === -1) {
                document.getElementById('monthlyDataStatus').innerHTML = 
                    '<div class="alert alert-error">❌ "Tedarikçi" sütunu bulunamadı! Sütunlar: ' + headers.join(', ') + '</div>';
                return;
            }

            // Tüm sütunları analiz et - daha esnek yaklaşım
            const allColumns = [];
            for (let i = 0; i < headers.length; i++) {
                if (i === supplierColIndex) continue;
                
                const header = String(headers[i] || '').trim();
                const headerLower = header.toLowerCase();
                
                // Sütun tipi belirleme
                let isTermin = false;
                let isTamamlanma = false;
                let isKalite = false;
                let isVda = false;
                let isPpmPuan = false;
                let isTerminDays = false; // Gecikme günü olarak mı saklanıyor?
                
                if (headerLower.includes('tamamlan')) {
                    isTamamlanma = true;
                } else if (headerLower.includes('kalite') || headerLower.includes('quality')) {
                    isKalite = true;
                } else if (headerLower.includes('vda') || headerLower.includes('denetim')) {
                    isVda = true;
                } else if (headerLower.includes('ppm puan') || headerLower.includes('ppm puanı')) {
                    isPpmPuan = true;
                } else if (headerLower.includes('gecik') && (headerLower.includes('gün') || headerLower.includes('gun'))) {
                    // "Gecikme Gün" gibi başlıklar - doğrudan GÜN değeri
                    isTermin = true;
                    isTerminDays = true;
                    console.log(`✅ GECİKME GÜN SÜTUNU BULUNDU: "${header}" → isTerminDays=true`);
                } else if (headerLower.includes('termin')) {
                    isTermin = true;
                    // Eğer "gün" veya "gecik" kelimesi varsa değer GÜN olarak gelmiş demektir
                    if (headerLower.includes('gün') || headerLower.includes('gun') || headerLower.includes('gecik')) {
                        isTerminDays = true;
                        console.log(`✅ TERMİN GÜN SÜTUNU BULUNDU: "${header}" → isTerminDays=true`);
                    } else {
                        console.log(`ℹ️ Termin sütunu (puan): "${header}"`);
                    }
                } else if (headerLower.includes('puan')) {
                    // Sadece "Puan" yazıyorsa, Termin olarak kabul et
                    isTermin = true;
                }
                    
                    allColumns.push({
                        index: i,
                        name: header,
                        nameLower: headerLower,
                        isTermin: isTermin,
                        isTerminDays: isTerminDays,
                        isTamamlanma: isTamamlanma,
                        isKalite: isKalite,
                        isVda: isVda,
                        isPpmPuan: isPpmPuan,
                        monthNumber: extractMonthNumber(header)
                    });
                }

            console.log('Analiz edilen sütunlar:', allColumns);

            // Aylara göre grupla
            const monthlyColumns = new Map();
            
            allColumns.forEach(col => {
                if (col.monthNumber !== null) {
                    if (!monthlyColumns.has(col.monthNumber)) {
                        monthlyColumns.set(col.monthNumber, { termin: [], terminDays: [], tamamlanma: [], kalite: [], vda: [], ppmPuan: [] });
                    }
                    
                    if (col.isTermin) {
                        if (col.isTerminDays) {
                            monthlyColumns.get(col.monthNumber).terminDays.push(col.index);
                        } else {
                            monthlyColumns.get(col.monthNumber).termin.push(col.index);
                        }
                    }
                    if (col.isTamamlanma) {
                        monthlyColumns.get(col.monthNumber).tamamlanma.push(col.index);
                    }
                    if (col.isKalite) {
                        monthlyColumns.get(col.monthNumber).kalite.push(col.index);
                    }
                    if (col.isVda) {
                        monthlyColumns.get(col.monthNumber).vda.push(col.index);
                    }
                    if (col.isPpmPuan) {
                        monthlyColumns.get(col.monthNumber).ppmPuan.push(col.index);
                    }
                }
            });

            console.log('Aylara göre gruplandırılan sütunlar:', Array.from(monthlyColumns.entries()));

            // Eğer ay numarası tespit edilemezse, sıralı olarak tara
            if (monthlyColumns.size === 0) {
                console.log('Ay numarası bulunamadı, tüm sütunları sırayla işleniyor...');
                
                let terminColumns = [];
                let terminDaysColumns = [];
                let tamamlanmaColumns = [];
                
                allColumns.forEach(col => {
                    if (col.isTermin) {
                        if (col.isTerminDays) {
                            terminDaysColumns.push(col.index);
                        } else {
                            terminColumns.push(col.index);
                        }
                    }
                    if (col.isTamamlanma) tamamlanmaColumns.push(col.index);
                });
                
                console.log('Termin sütunları:', terminColumns.map(i => headers[i]));
                console.log('Termin GÜN sütunları:', terminDaysColumns.map(i => headers[i]));
                console.log('Tamamlanma sütunları:', tamamlanmaColumns.map(i => headers[i]));
                
                // Ay olmadan sütunları gruplayıp işle
                terminColumns.forEach((colIndex, idx) => {
                    monthlyColumns.set(idx + 1, { termin: [colIndex], terminDays: [], tamamlanma: [], kalite: [], vda: [], ppmPuan: [] });
                });
                
                terminDaysColumns.forEach((colIndex, idx) => {
                    if (!monthlyColumns.has(idx + 1)) {
                        monthlyColumns.set(idx + 1, { termin: [], terminDays: [colIndex], tamamlanma: [], kalite: [], vda: [], ppmPuan: [] });
                    } else {
                        monthlyColumns.get(idx + 1).terminDays.push(colIndex);
                    }
                });
                
                tamamlanmaColumns.forEach((colIndex, idx) => {
                    if (!monthlyColumns.has(idx + 1)) {
                        monthlyColumns.set(idx + 1, { termin: [], terminDays: [], tamamlanma: [colIndex], kalite: [], vda: [], ppmPuan: [] });
                    } else {
                        monthlyColumns.get(idx + 1).tamamlanma.push(colIndex);
                    }
                });
                
                console.log('Fallback Ay grupları:', Array.from(monthlyColumns.entries()));
            }

            // Tedarikçilere göre aylık puanları topla
            monthlyScoresData.clear();

            rows.forEach((row, rowIndex) => {
                const supplier = String(row[supplierColIndex] || '').trim();
                if (!supplier || supplier === '') return;

                const normalizedSupplier = normalizeName(supplier);
                if (!monthlyScoresData.has(normalizedSupplier)) {
                    monthlyScoresData.set(normalizedSupplier, {
                        terminByMonth: new Map(),
                        terminGunByMonth: new Map(), // Gerçek gecikme gün değerleri için
                        tamamlanmaByMonth: new Map(),
                        kaliteByMonth: new Map(),
                        vdaByMonth: new Map(),
                        ppmPuanByMonth: new Map()
                    });
                }

                const supplierData = monthlyScoresData.get(normalizedSupplier);

                // Aylara göre gruplandırılmış sütunları işle
                if (monthlyColumns.size > 0) {
                    monthlyColumns.forEach((cols, month) => {
                        // Termin puanlarını al
                        cols.termin.forEach(colIndex => {
                            const value = parseFloat(row[colIndex]);
                            if (!isNaN(value)) {
                                // NEGATİF DEĞER = GÜN (erken teslimat)
                                if (value < 0) {
                                    // Gün olarak sakla
                                    if (!supplierData.terminGunByMonth.has(month)) supplierData.terminGunByMonth.set(month, []);
                                    supplierData.terminGunByMonth.get(month).push(value);
                                    // Puan her zaman 100% (erken teslimat)
                                    if (!supplierData.terminByMonth.has(month)) supplierData.terminByMonth.set(month, []);
                                    supplierData.terminByMonth.get(month).push(100);
                                    console.log(`📅 Excel (NEGATİF): ${normalizedSupplier} Ay ${month} → Gün: ${Math.round(value)}, Puan: 100%`);
                                } else {
                                    // POZİTİF DEĞER = PUAN 
                                    if (!supplierData.terminByMonth.has(month)) supplierData.terminByMonth.set(month, []);
                                    supplierData.terminByMonth.get(month).push(value);
                                }
                            }
                        });
                        
                        // Termin GÜN değerlerini al ve PUAN'a çevir + GÜN değerini de sakla
                        (cols.terminDays || []).forEach(colIndex => {
                            const gecikmeGun = parseFloat(row[colIndex]);
                            if (!isNaN(gecikmeGun)) {
                                const puan = gecikmeGunToTerminPuan(gecikmeGun);
                                if (!supplierData.terminByMonth.has(month)) supplierData.terminByMonth.set(month, []);
                                supplierData.terminByMonth.get(month).push(puan);
                                
                                // Gerçek gün değerini de sakla (tabloda göstermek için)
                                if (!supplierData.terminGunByMonth.has(month)) supplierData.terminGunByMonth.set(month, []);
                                supplierData.terminGunByMonth.get(month).push(gecikmeGun);
                                console.log(`📅 Excel: ${normalizedSupplier} Ay ${month} → Gün: ${Math.round(gecikmeGun)}, Puan: ${puan.toFixed(1)}%`);
                            }
                        });
                        
                        // Tamamlanma puanlarını al (negatif değerlere de izin ver)
                        cols.tamamlanma.forEach(colIndex => {
                            const value = parseFloat(row[colIndex]);
                            if (!isNaN(value)) {
                                if (!supplierData.tamamlanmaByMonth.has(month)) supplierData.tamamlanmaByMonth.set(month, []);
                                supplierData.tamamlanmaByMonth.get(month).push(value);
                            }
                        });
                        
                        // Kalite puanlarını al
                        (cols.kalite || []).forEach(colIndex => {
                            const value = parseFloat(row[colIndex]);
                            if (!isNaN(value) && value >= 0) {
                                if (!supplierData.kaliteByMonth.has(month)) supplierData.kaliteByMonth.set(month, []);
                                supplierData.kaliteByMonth.get(month).push(value);
                            }
                        });
                        
                        // VDA puanlarını al
                        (cols.vda || []).forEach(colIndex => {
                            const value = parseFloat(row[colIndex]);
                            if (!isNaN(value) && value >= 0) {
                                if (!supplierData.vdaByMonth.has(month)) supplierData.vdaByMonth.set(month, []);
                                supplierData.vdaByMonth.get(month).push(value);
                            }
                        });
                        
                        // PPM Puanlarını al
                        (cols.ppmPuan || []).forEach(colIndex => {
                            const value = parseFloat(row[colIndex]);
                            if (!isNaN(value) && value >= 0) {
                                if (!supplierData.ppmPuanByMonth.has(month)) supplierData.ppmPuanByMonth.set(month, []);
                                supplierData.ppmPuanByMonth.get(month).push(value);
                            }
                        });
                    });
                } else {
                    // Ay gruplaması yoksa, filtre aylarına etkisi olmayacak şekilde tek bir grup olarak kaydet
                    allColumns.forEach(col => {
                        const value = parseFloat(row[col.index]);
                        if (!isNaN(value)) {
                            if (col.isTermin) {
                                if (!supplierData.terminByMonth.has(0)) supplierData.terminByMonth.set(0, []);
                                supplierData.terminByMonth.get(0).push(value);
                            }
                            if (col.isTamamlanma) {
                                if (!supplierData.tamamlanmaByMonth.has(0)) supplierData.tamamlanmaByMonth.set(0, []);
                                supplierData.tamamlanmaByMonth.get(0).push(value);
                            }
                        }
                    });
                }
            });

            console.log('İşlenen tedarikçi sayısı:', monthlyScoresData.size);
            
            // İlk birkaç tedarikçinin verilerini göster (ay bazlı)
            let count = 0;
            monthlyScoresData.forEach((data, name) => {
                if (count < 3) {
                    const sampleMonths = Array.from({length:12}, (_,i)=>i+1).filter(m => data.terminByMonth.has(m) || data.tamamlanmaByMonth.has(m));
                    const termVals = sampleMonths.flatMap(m => (data.terminByMonth.get(m) || []));
                    const tamamVals = sampleMonths.flatMap(m => (data.tamamlanmaByMonth.get(m) || []));
                    const termAvg = termVals.length>0 ? (termVals.reduce((a,b)=>a+b,0)/termVals.length).toFixed(2) : 0;
                    const tamamAvg = tamamVals.length>0 ? (tamamVals.reduce((a,b)=>a+b,0)/tamamVals.length).toFixed(2) : 0;
                    console.log(`${name}:`, { aylar: sampleMonths, terminOrtalama: termAvg, tamamlanmaOrtalama: tamamAvg });
                    count++;
                }
            });

            // Kaç tedarikçi eşleşti göster
            let matchedCount = 0;
            let matchedNames = [];
            let unmatchedSamples = [];
            let unmatchedNormalizedNames = [];
            
            monthlyScoresData.forEach((data, normalizedSupplierName) => {
                const matched = allResults.find(r => normalizeName(r.name) === normalizedSupplierName);
                if (matched) {
                    matchedCount++;
                    if (matchedNames.length < 5) {
                        matchedNames.push(normalizedSupplierName);
                    }
                } else {
                    if (unmatchedSamples.length < 10) {
                        unmatchedSamples.push(normalizedSupplierName);
                    }
                    if (unmatchedNormalizedNames.length < 10) {
                        unmatchedNormalizedNames.push(normalizedSupplierName);
                    }
                }
            });

            console.log('Ana verilerle eşleşen tedarikçiler (örnekler):', matchedNames);
            console.log('Eşleşmeyen tedarikçiler (normalize edilmiş adlar):', unmatchedNormalizedNames);
            console.log('Toplam eşleşme:', matchedCount, '/', monthlyScoresData.size);
            
            // Ana verilerdeki tedarikçiler arasından eşleşmeyenleri bul
            let mainUnmatchedSamples = [];
            allResults.slice(0, 10).forEach(r => {
                const normalizedMainName = normalizeName(r.name);
                if (!monthlyScoresData.has(normalizedMainName)) {
                    if (mainUnmatchedSamples.length < 10) {
                        mainUnmatchedSamples.push({
                            original: r.name,
                            normalized: normalizedMainName
                        });
                    }
                }
            });
            console.log('Ana verilerde eşleşmeyen ilk 10 tedarikçi:', mainUnmatchedSamples);
            console.log('Aylık puanlardan toplam tedarikçi:', monthlyScoresData.size);

            const unmatchedCount = allResults.length - matchedCount;
            let statusMessage = `✅ ${monthlyScoresData.size} tedarikçi için aylık puanlar yüklendi. ${matchedCount} tedarikçi ana verilerle eşleştirildi.`;
            if (unmatchedCount > 0 && allResults.length > 0) {
                statusMessage += `<br><small>${unmatchedCount} eşleşmeyen tedarikçi için termin ve tamamlanma puanları 100 olarak atandı.</small>`;
            }
            statusMessage += '<br><small>Detaylar için tarayıcı konsoluna (F12) bakın.</small>';

            document.getElementById('monthlyDataStatus').innerHTML = 
                `<div class="alert alert-success">${statusMessage}</div>`;

            // Eğer ana veriler zaten yüklüyse tabloyu güncelle
            if (allResults.length > 0) {
                updateResultsWithMonthlyScores();
                displayResults();
            }
        }

        // Sütun başlığından ay numarasını çıkar
        function extractMonthNumber(header) {
            const str = String(header).trim();
            
            // Sadece sayı mı (1, 2, 3... 12)?
            if (/^\d+$/.test(str)) {
                const num = parseInt(str);
                if (num >= 1 && num <= 12) return num;
            }
            
            // "Ay 1", "1. Ay", "Month 1" gibi
            const match = str.match(/(\d+)/);
            if (match) {
                const num = parseInt(match[1]);
                if (num >= 1 && num <= 12) return num;
            }
            
            // Ay isimleri (Ocak, Şubat, vb.)
            const monthNames = {
                'ocak': 1, 'january': 1, 'jan': 1,
                'şubat': 2, 'subat': 2, 'february': 2, 'feb': 2,
                'mart': 3, 'march': 3, 'mar': 3,
                'nisan': 4, 'april': 4, 'apr': 4,
                'mayıs': 5, 'mayis': 5, 'may': 5,
                'haziran': 6, 'june': 6, 'jun': 6,
                'temmuz': 7, 'july': 7, 'jul': 7,
                'ağustos': 8, 'agustos': 8, 'august': 8, 'aug': 8,
                'eylül': 9, 'eylul': 9, 'september': 9, 'sep': 9,
                'ekim': 10, 'october': 10, 'oct': 10,
                'kasım': 11, 'kasim': 11, 'november': 11, 'nov': 11,
                'aralık': 12, 'aralik': 12, 'december': 12, 'dec': 12
            };
            
            const lowerStr = str.toLowerCase();
            for (const [name, num] of Object.entries(monthNames)) {
                if (lowerStr.includes(name)) return num;
            }
            
            return null;
        }

        // Manuel düzenlenen aylık değerleri sakla (Excel yüklendiğinde korunması için)
        let manualMonthlyEdits = {}; // { 'supplierName': { termin: [month1, month2], tamamlanma: [month3] } }
        
        function updateResultsWithMonthlyScores() {
            console.log('updateResultsWithMonthlyScores çağrıldı');
            console.log('monthlyScoresData size:', monthlyScoresData.size);
            console.log('selectedMonths:', Array.from(selectedMonths));
            
            // İlk tedarikçinin verilerini göster (debug)
            let debugCount = 0;
            monthlyScoresData.forEach((md, name) => {
                if (debugCount === 0) {
                    console.log(`DEBUG: ${name} için terminByMonth:`, md.terminByMonth);
                    console.log(`DEBUG: ${name} için tamamlanmaByMonth:`, md.tamamlanmaByMonth);
                    debugCount++;
                }
            });
            
            allResults.forEach(result => {
                // monthlyTerminGecikmeGun array'ini tüm tedarikçilerde başlat
                if (!result.monthlyTerminGecikmeGun) {
                    result.monthlyTerminGecikmeGun = new Array(12).fill(null);
                }
                
                const normalizedSupplierName = normalizeName(result.name);
                if (monthlyScoresData.has(normalizedSupplierName)) {
                    const md = monthlyScoresData.get(normalizedSupplierName);
                    const months = Array.from(selectedMonths);
                    
                    // Seçilen aylar içinde TÜM kayıtlı değerleri topla
                    let allTermValues = [];
                    let allTamamValues = [];
                    let allKaliteValues = [];
                    let allVdaValues = [];
                    let allPpmPuanValues = [];
                    
                    months.forEach(m => {
                        // Gerçek gün değeri varsa, ondan puan hesapla (Excel'deki puan yerine)
                        if (md.terminGunByMonth.has(m)) {
                            const gunArr = md.terminGunByMonth.get(m);
                            gunArr.forEach(gun => {
                                allTermValues.push(gecikmeGunToTerminPuan(gun));
                            });
                        } else if (md.terminByMonth.has(m)) {
                            const arr = md.terminByMonth.get(m);
                            allTermValues.push(...arr);
                        }
                        if (md.tamamlanmaByMonth.has(m)) {
                            const arr2 = md.tamamlanmaByMonth.get(m);
                            allTamamValues.push(...arr2);
                        }
                        if (md.kaliteByMonth.has(m)) {
                            const arr3 = md.kaliteByMonth.get(m);
                            allKaliteValues.push(...arr3);
                        }
                        if (md.vdaByMonth.has(m)) {
                            const arr4 = md.vdaByMonth.get(m);
                            allVdaValues.push(...arr4);
                        }
                        if (md.ppmPuanByMonth.has(m)) {
                            const arr5 = md.ppmPuanByMonth.get(m);
                            allPpmPuanValues.push(...arr5);
                        }
                    });
                    
                    // Ortalama hesapla - eğer 0-1 aralığındaysa *100 yap
                    let termAvg = 100;
                    let tamamAvg = 100;
                    let kaliteAvg = result.kalitePuan || 0;
                    let vdaAvg = result.vdaPuan || 0;
                    let ppmPuanAvg = result.ppmPuan || 0;
                    
                    if (allTermValues.length > 0) {
                        termAvg = allTermValues.reduce((a,b)=>a+b,0) / allTermValues.length;
                        if (termAvg <= 1) termAvg *= 100;
                        result.terminPuan = termAvg;
                    } else {
                        result.terminPuan = 100;
                    }
                    
                    if (allTamamValues.length > 0) {
                        tamamAvg = allTamamValues.reduce((a,b)=>a+b,0) / allTamamValues.length;
                        if (tamamAvg <= 1) tamamAvg *= 100;
                        result.tamamlanmaPuan = tamamAvg;
                    } else {
                        result.tamamlanmaPuan = 100;
                    }
                    
                    if (allKaliteValues.length > 0) {
                        kaliteAvg = allKaliteValues.reduce((a,b)=>a+b,0) / allKaliteValues.length;
                        if (kaliteAvg <= 1) kaliteAvg *= 100;
                        result.kalitePuan = kaliteAvg;
                    }
                    
                    if (allVdaValues.length > 0) {
                        vdaAvg = allVdaValues.reduce((a,b)=>a+b,0) / allVdaValues.length;
                        if (vdaAvg <= 1) vdaAvg *= 100;
                        result.vdaPuan = vdaAvg;
                    }
                    
                    if (allPpmPuanValues.length > 0) {
                        ppmPuanAvg = allPpmPuanValues.reduce((a,b)=>a+b,0) / allPpmPuanValues.length;
                        if (ppmPuanAvg <= 1) ppmPuanAvg *= 100;
                        result.ppmPuan = ppmPuanAvg;
                    }
                    
                    // Aylık değerleri de depola - MANUEL DÜZENLEMELER KORUNUR!
                    const supplierEdits = manualMonthlyEdits[result.name] || { termin: [], tamamlanma: [] };
                    
                    for (let m = 1; m <= 12; m++) {
                        let mKalite = result.kalitePuan;
                        let mVda = result.vdaPuan;
                        let mPpmPuan = result.ppmPuan;
                        let mTermin = result.terminPuan;
                        let mTamamlanma = result.tamamlanmaPuan;
                        
                        // Termin: Eğer bu ay MANUEL DÜZENLENMEMİŞSE Excel'den al
                        if (md.terminByMonth.has(m) && !supplierEdits.termin.includes(m)) {
                            // ÖNCELİK: Gün değeri varsa ("Gecikme Gün" sütunu) onu kullan
                            if (md.terminGunByMonth.has(m)) {
                                const gunVals = md.terminGunByMonth.get(m);
                                const avgGun = gunVals.reduce((a,b)=>a+b,0) / gunVals.length;
                                // Günden puan hesapla (Excel'deki Puan sütununu görmezden gel)
                                mTermin = gecikmeGunToTerminPuan(avgGun);
                                result.monthlyTerminGecikmeGun[m-1] = avgGun;
                                console.log(`🔵 ${result.name} Ay ${m}: Gün = ${Math.round(avgGun)}, Puan = ${mTermin.toFixed(1)}%`);
                            } else {
                                // Gün değeri yoksa doğrudan puan kullan
                                const vals = md.terminByMonth.get(m);
                                mTermin = vals.reduce((a,b)=>a+b,0) / vals.length;
                                if (mTermin <= 1) mTermin *= 100;
                            }
                        } else if (supplierEdits.termin.includes(m)) {
                            // Manuel düzenlenmişse mevcut değeri koru
                            mTermin = result.monthlyTerminPuan[m-1] || result.terminPuan;
                            console.log(`🔒 ${result.name} Ay ${m} TERMİN değeri KORUNDU (manuel düzenleme): ${mTermin.toFixed(1)}`);
                        }
                        
                        // Tamamlanma: Eğer bu ay MANUEL DÜZENLENMEMİŞSE Excel'den al
                        if (md.tamamlanmaByMonth.has(m) && !supplierEdits.tamamlanma.includes(m)) {
                            const vals = md.tamamlanmaByMonth.get(m);
                            mTamamlanma = vals.reduce((a,b)=>a+b,0) / vals.length;
                            if (mTamamlanma <= 1) mTamamlanma *= 100;
                        } else if (supplierEdits.tamamlanma.includes(m)) {
                            // Manuel düzenlenmişse mevcut değeri koru
                            mTamamlanma = result.monthlyTamamlanmaPuan[m-1] || result.tamamlanmaPuan;
                            console.log(`🔒 ${result.name} Ay ${m} TAMAMLANMA değeri KORUNDU (manuel düzenleme): ${mTamamlanma.toFixed(1)}`);
                        }
                        if (md.kaliteByMonth.has(m)) {
                            const vals = md.kaliteByMonth.get(m);
                            mKalite = vals.reduce((a,b)=>a+b,0) / vals.length;
                            if (mKalite <= 1) mKalite *= 100;
                        }
                        if (md.vdaByMonth.has(m)) {
                            const vals = md.vdaByMonth.get(m);
                            mVda = vals.reduce((a,b)=>a+b,0) / vals.length;
                            if (mVda <= 1) mVda *= 100;
                        }
                        if (md.ppmPuanByMonth.has(m)) {
                            const vals = md.ppmPuanByMonth.get(m);
                            mPpmPuan = vals.reduce((a,b)=>a+b,0) / vals.length;
                            if (mPpmPuan <= 1) mPpmPuan *= 100;
                        }
                        
                        result.monthlyTerminPuan[m-1] = mTermin;
                        result.monthlyTamamlanmaPuan[m-1] = mTamamlanma;
                        result.monthlyKalitePuan[m-1] = mKalite;
                        result.monthlyVdaPuan[m-1] = mVda;
                        result.monthlyPpmPuan[m-1] = mPpmPuan;
                    }
                    
                    console.log(`${result.name}: terminPuan=${result.terminPuan.toFixed(2)}, tamamlanmaPuan=${result.tamamlanmaPuan.toFixed(2)}, ppmPuan=${result.ppmPuan.toFixed(2)}`);
                    recalculateSupplierScore(result);
                } else {
                    result.terminPuan = 100;
                    result.tamamlanmaPuan = 100;
                    for (let m = 0; m < 12; m++) {
                        result.monthlyTerminPuan[m] = 100;
                        result.monthlyTamamlanmaPuan[m] = 100;
                        result.monthlyKalitePuan[m] = result.kalitePuan;
                        result.monthlyVdaPuan[m] = result.vdaPuan;
                        result.monthlyPpmPuan[m] = result.ppmPuan;
                    }
                    console.log(`${result.name}: monthlyScoresData bulunamadı, 100 atandı`);
                    recalculateSupplierScore(result);
                }
            });
        }
        
        // Termin Puanından Gecikme Gününü Hesaplayan Fonksiyon (Lineer İnterpolasyon ile)
        function terminPuanToGecikmeGun(puan) {
            // 100% üzeri veya erken teslimat (-) durumu için eksi gün olabilir
            // Ama biz sadece puandan güne gidiyoruz, 100% = 0 gün
            if (puan >= 100) return 0;
            
            // 80-100% arası: 0-1 gün lineer
            if (puan >= 80) {
                return ((100 - puan) / 20) * 1; // 20 puan farkı = 1 gün
            }
            
            // 60-80% arası: 1-2 gün lineer
            if (puan >= 60) {
                return 1 + ((80 - puan) / 20) * 1;
            }
            
            // 40-60% arası: 2-3 gün lineer
            if (puan >= 40) {
                return 2 + ((60 - puan) / 20) * 1;
            }
            
            // 30-40% arası: 3-4 gün lineer
            if (puan >= 30) {
                return 3 + ((40 - puan) / 10) * 1;
            }
            
            // 20-30% arası: 4-5 gün lineer
            if (puan >= 20) {
                return 4 + ((30 - puan) / 10) * 1;
            }
            
            // 0-20% arası: 5-6 gün lineer
            if (puan > 0) {
                return 5 + ((20 - puan) / 20) * 1;
            }
            
            return 6; // 0% = 6 gün
        }
        
        // Gecikme Gününden Termin Puanını Hesaplayan Fonksiyon (Eksi günler dahil)
        function gecikmeGunToTerminPuan(gun) {
            // Eksi günler (erken teslimat) = 100%
            if (gun <= 0) return 100;
            
            // 0-1 gün arası: 100-80% lineer
            if (gun <= 1) {
                return 100 - (gun * 20);
            }
            
            // 1-2 gün arası: 80-60% lineer
            if (gun <= 2) {
                return 80 - ((gun - 1) * 20);
            }
            
            // 2-3 gün arası: 60-40% lineer
            if (gun <= 3) {
                return 60 - ((gun - 2) * 20);
            }
            
            // 3-4 gün arası: 40-30% lineer
            if (gun <= 4) {
                return 40 - ((gun - 3) * 10);
            }
            
            // 4-5 gün arası: 30-20% lineer
            if (gun <= 5) {
                return 30 - ((gun - 4) * 10);
            }
            
            // 5-6 gün arası: 20-0% lineer
            if (gun <= 6) {
                return 20 - ((gun - 5) * 20);
            }
            
            return 0; // 6+ gün = 0%
        }

        function recalculateSupplierScore(result) {
            // Normalizasyon: 0-100 aralığındaki değerleri 0-1 aralığına çevir
            const kalitePuanNormalized = result.kalitePuan / 100;
            const vdaPuanNormalized = result.vdaPuan / 100;
            const donusOrani8DNormalized = result.donusOrani8D / 100;
            const terminPuanNormalized = result.terminPuan / 100;
            const tamamlanmaPuanNormalized = result.tamamlanmaPuan / 100;
            
            if (result.vdaPuan > 0) {
                // VDA puanı olan tedarikçiler
                result.tedarikcipuani = (vdaPuanNormalized * 0.20 + 
                                 kalitePuanNormalized * 0.05 + 
                                 result.ppmPuan * 0.30 + 
                                 donusOrani8DNormalized * 0.05 + 
                                 terminPuanNormalized * 0.20 + 
                                 tamamlanmaPuanNormalized * 0.10 + 
                                 result.hataPuan * 0.10);
            } else {
                // VDA denetimi olmayan tedarikçiler
                result.tedarikcipuani = (kalitePuanNormalized * 0.05 + 
                                 result.ppmPuan * 0.40 + 
                                 donusOrani8DNormalized * 0.10 + 
                                 terminPuanNormalized * 0.20 + 
                                 tamamlanmaPuanNormalized * 0.10 + 
                                 result.hataPuan * 0.15);
            }
            
            // Tedarikçi sınıfı hesaplama
            if (result.tedarikcipuani >= 0.9) {
                result.tedarikcisınıfı = 'A';
            } else if (result.tedarikcipuani >= 0.8) {
                result.tedarikcisınıfı = 'B';
            } else if (result.tedarikcipuani >= 0.6) {
                result.tedarikcisınıfı = 'C';
            } else {
                result.tedarikcisınıfı = 'D';
            }
        }

        function analyzeData(worksheet) {
            console.log('=== analyzeData başladı ===');
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length < 2) {
                showAlert('❌ Excel dosyasında yeterli veri bulunamadı!', 'error');
                return;
            }

            // İlk olarak tüm 8D sayılarını IndexedDB'den yükle
            loadAll8DCounts().then(counts8DMap => {
                console.log('🔵 8D sayıları yüklendi:', counts8DMap.size, 'tedarikçi');
                if (counts8DMap.size > 0) {
                    console.log('🔵 İlk 3 8D kaydı:', Array.from(counts8DMap.entries()).slice(0, 3));
                }
                processExcelData(jsonData, counts8DMap);
            }).catch(err => {
                console.error('8D sayıları yükleme hatası:', err);
                // Hata olsa bile devam et, boş Map ile
                processExcelData(jsonData, new Map());
            });
        }
        
        function processExcelData(jsonData, counts8DMap) {
            
            if (jsonData.length < 2) {
                showAlert('❌ Excel dosyasında yeterli veri bulunamadı!', 'error');
                return;
            }

            const headers = jsonData[0];
            const rows = jsonData.slice(1);

            console.log('=== DOSYA ANALİZİ BAŞLADI ===');
            console.log('✅ Toplam Satır:', rows.length);
            console.log('✅ Toplam Sütun:', headers.length);
            console.log('✅ Sütun Başlıkları:', headers);

            // Tedarikçi sütununu bul
            let supplierColIndex = -1;
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).toLowerCase();
                if (header.includes('tedarik') || header.includes('firma') || header.includes('supplier') || header.includes('company')) {
                    supplierColIndex = i;
                    break;
                }
            }

            if (supplierColIndex === -1) {
                showAlert('❌ "Tedarikçi" sütunu bulunamadı!', 'error');
                return;
            }

            // Durum sütununu bul
            let statusColIndex = -1;
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).toLowerCase();
                if (header.includes('durum') || header.includes('status')) {
                    statusColIndex = i;
                    break;
                }
            }

            // Sevk, İade, Hata sütunlarını bul (ay numarası ile)
            const sevkColumns = [];
            const iadeColumns = [];
            const hataColumns = [];

            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).trim();
                const headerLower = header.toLowerCase();
                
                if (headerLower.includes('ppm')) {
                    continue;
                }
                const mNum = extractMonthNumber(header);
                if (headerLower.includes('sevk') || headerLower.includes('sevkiyat') || headerLower.includes('shipment')) {
                    sevkColumns.push({ index: i, monthNumber: mNum });
                    console.log(`✅ Sevk sütunu bulundu: "${header}" (Ay: ${mNum})`);
                }
                if (headerLower.includes('iade') || header.includes('İade') || header.includes('iade') || 
                    headerLower.includes('return')) {
                    iadeColumns.push({ index: i, monthNumber: mNum });
                    console.log(`✅ İade sütunu bulundu: "${header}" (Ay: ${mNum})`);
                }
                if (headerLower.includes('hata') || headerLower.includes('error') || headerLower.includes('defect')) {
                    hataColumns.push({ index: i, monthNumber: mNum });
                    console.log(`✅ Hata sütunu bulundu: "${header}" (Ay: ${mNum})`);
                }
            }

            console.log('Sevk sütunları:', sevkColumns.length);
            console.log('İade sütunları:', iadeColumns.length);
            console.log('Hata sütunları:', hataColumns.length);
            console.log('Tüm sütunlar:', headers);

            // Ay bilgisi bulunan sütun var mı?
            const hasKnownSevkMonths = sevkColumns.some(c => c.monthNumber && c.monthNumber >= 1 && c.monthNumber <= 12);
            const hasKnownIadeMonths = iadeColumns.some(c => c.monthNumber && c.monthNumber >= 1 && c.monthNumber <= 12);
            const hasKnownHataMonths = hataColumns.some(c => c.monthNumber && c.monthNumber >= 1 && c.monthNumber <= 12);

            // Ay numarası yoksa, sırayla ay 1, 2, 3... ata
            if (!hasKnownSevkMonths && sevkColumns.length > 0) {
                console.log('⚠️ Sevk sütunlarında ay numarası yok, sırayla atanıyor...');
                sevkColumns.forEach((col, idx) => {
                    col.monthNumber = Math.min(idx + 1, 12);
                });
            }
            if (!hasKnownIadeMonths && iadeColumns.length > 0) {
                console.log('⚠️ İade sütunlarında ay numarası yok, sırayla atanıyor...');
                iadeColumns.forEach((col, idx) => {
                    col.monthNumber = Math.min(idx + 1, 12);
                });
            }
            if (!hasKnownHataMonths && hataColumns.length > 0) {
                console.log('⚠️ Hata sütunlarında ay numarası yok, sırayla atanıyor...');
                hataColumns.forEach((col, idx) => {
                    col.monthNumber = Math.min(idx + 1, 12);
                });
            }

            // Eğer hiçbir sevk/iade/hata sütunu bulunamadıysa uyarı ver
            if (sevkColumns.length === 0 && iadeColumns.length === 0 && hataColumns.length === 0) {
                const errorMsg = `Dosyada "Sevk", "İade" veya "Hata" sütunları bulunamadı.\n\nMevcut sütunlar:\n${headers.join('\n')}\n\nLütfen debug.html dosyasını açarak dosya yapınızı kontrol edin.`;
                showAlert('❌ ' + errorMsg, 'error');
                console.error('Sütun başlıkları:', headers);
                document.getElementById('statsContainer').innerHTML = `
                    <div style="padding: 20px; background: #f8d7da; border-radius: 8px; color: #721c24; border-left: 4px solid #dc3545;">
                        <strong>❌ Hata: Gerekli Sütunlar Bulunamadı</strong><br><br>
                        Dosyada "Sevk", "İade" veya "Hata" sütunları bulunamadı.<br><br>
                        <strong>Mevcut sütunlar:</strong><br>
                        ${headers.map((h, i) => `${i + 1}. "${h}"`).join('<br>')}<br><br>
                        <strong>Çözüm:</strong> Dosya sütunlarını kontrol edin veya <a href="debug.html" style="color: #0c5460; text-decoration: underline;">debug.html</a> aracını kullanın.
                    </div>
                `;
                return;
            }

            // Tedarikçileri grupla
            const supplierMap = new Map();
            const duplicateNameCounts = new Map();
            let emptyRowsSkipped = 0;
            let missingNameAssigned = 0;

            rows.forEach((row, rowIdx) => {
                let supplier = row[supplierColIndex];
                const hasName = supplier && String(supplier).trim() !== '';

                // Satırda hiçbir sevk/iade/hata verisi yoksa tamamen atla
                const hasNumericData = [...sevkColumns, ...iadeColumns, ...hataColumns].some(col => {
                    const v = row[col.index];
                    if (v === undefined || v === null) return false;
                    const vs = String(v).trim();
                    if (vs === '') return false;
                    const num = parseFloat(vs.replace(',', '.'));
                    return !Number.isNaN(num) && num !== 0;
                });
                if (!hasName && !hasNumericData) {
                    emptyRowsSkipped += 1;
                    return; // boş satır
                }

                if (!hasName) {
                    // İsim yoksa (totaller vs.) satırı atla, sayacı artır
                    missingNameAssigned += 1;
                    return;
                }

                let normalizedSupplier = normalizeName(supplier);
                if (!hasName) {
                    // normalizeName('') => '' olmasın, benzersiz anahtar ver
                    normalizedSupplier = `missing_supplier_${rowIdx + 1}`;
                }
                // Aynı normalize isim geldiyse satırı kaybetmemek için benzersiz key üret
                let mapKey = normalizedSupplier;
                if (supplierMap.has(mapKey)) {
                    const dupCount = duplicateNameCounts.get(normalizedSupplier) || 1;
                    mapKey = `${normalizedSupplier}__dup${dupCount}`;
                    duplicateNameCounts.set(normalizedSupplier, dupCount + 1);
                }

                if (!supplierMap.has(mapKey)) {
                    // Tedarikçi adı boş ise generic ad ver
                    const displayName = supplier || `[Tedarikçi Adı Yok #${Array.from(supplierMap.values()).filter(s => s.name && s.name.startsWith('[Tedarikçi')).length + 1}]`;
                    
                    // Durum: Önce Excel'den, yoksa kaydedilmiş durum haritasından, yoksa varsayılan ONAYLI
                    let supplierStatus = 'ONAYLI';
                    if (statusColIndex >= 0 && row[statusColIndex]) {
                        supplierStatus = row[statusColIndex];
                    } else {
                        supplierStatus = getSupplierStatus(displayName);
                    }
                    
                    // Lokasyon: Sonrasında async olarak yüklenecek
                    
                    supplierMap.set(mapKey, {
                        name: displayName,
                        normalizedName: normalizedSupplier,
                        mapKey: mapKey,
                        status: supplierStatus,
                        lokasyon: [], // Başlangıç boş, async olarak yüklenecek
                        monthlySevk: Array(12).fill(0),
                        monthlyIade: Array(12).fill(0),
                        monthlyHata: Array(12).fill(0),
                        unknownSevk: 0,
                        unknownIade: 0,
                        unknownHata: 0
                    });
                }

                const supplierData = supplierMap.get(mapKey);

                sevkColumns.forEach(col => {
                    const rawValue = row[col.index];
                    const value = parseFloat(rawValue) || 0;
                    if (col.monthNumber && col.monthNumber>=1 && col.monthNumber<=12) {
                        supplierData.monthlySevk[col.monthNumber-1] += value;
                        if (rowIdx < 3 && value > 0) {
                            console.log(`Sevk bulundu - Tedarikçi: ${supplier}, Ay: ${col.monthNumber}, Sütun: "${headers[col.index]}", Değer: ${value}`);
                        }
                    } else {
                        // Ay bilgisi yoksa, bilinmeyen toplamda biriktir
                        supplierData.unknownSevk += value;
                        if (rowIdx < 3 && value > 0) {
                            console.log(`Sevk (ay bilinmiyor) - Tedarikçi: ${supplier}, Sütun: "${headers[col.index]}", Değer: ${value}`);
                        }
                    }
                });

                iadeColumns.forEach(col => {
                    const rawValue = row[col.index];
                    const value = parseFloat(rawValue) || 0;
                    if (col.monthNumber && col.monthNumber>=1 && col.monthNumber<=12) {
                        supplierData.monthlyIade[col.monthNumber-1] += value;
                        if (rowIdx < 3 && value > 0) {
                            console.log(`İade bulundu - Tedarikçi: ${supplier}, Ay: ${col.monthNumber}, Sütun: "${headers[col.index]}", Değer: ${value}`);
                        }
                    } else {
                        supplierData.unknownIade += value;
                        if (rowIdx < 3 && value > 0) {
                            console.log(`İade (ay bilinmiyor) - Tedarikçi: ${supplier}, Sütun: "${headers[col.index]}", Değer: ${value}`);
                        }
                    }
                });

                hataColumns.forEach(col => {
                    const rawValue = row[col.index];
                    const value = parseFloat(rawValue) || 0;
                    if (col.monthNumber && col.monthNumber>=1 && col.monthNumber<=12) {
                        supplierData.monthlyHata[col.monthNumber-1] += value;
                        if (rowIdx < 3 && value > 0) {
                            console.log(`Hata bulundu - Tedarikçi: ${supplier}, Ay: ${col.monthNumber}, Sütun: "${headers[col.index]}", Değer: ${value}`);
                        }
                    } else {
                        supplierData.unknownHata += value;
                        if (rowIdx < 3 && value > 0) {
                            console.log(`Hata (ay bilinmiyor) - Tedarikçi: ${supplier}, Sütun: "${headers[col.index]}", Değer: ${value}`);
                        }
                    }
                });
            });

            console.log('Tedarikçi sayısı:', supplierMap.size);
            console.log('Toplam işlenen satır:', rows.length, 'Benzersiz tedarikçi:', supplierMap.size);
            console.log('Boş satır atlandı:', emptyRowsSkipped, 'Eksik isimli tedarikçi sayısı:', missingNameAssigned);
            const missingNameSuppliers = Array.from(supplierMap.values()).filter(s => s.name.startsWith('[Eksik Tedarikçi'));
            if (missingNameSuppliers.length > 0) {
                console.log('Eksik isimli tedarikçi sayısı:', missingNameSuppliers.length);
            }
            console.log('İlk tedarikçinin Sevk verileri:', Array.from(supplierMap.values())[0]?.monthlySevk);
            console.log('İlk tedarikçinin İade verileri:', Array.from(supplierMap.values())[0]?.monthlyIade);

            // Sonuçları hesapla (seçilen ayların toplamı - sadece seçilen aylar)
                        // Boş adlı tedarikçileri kontrol et
                        const emptyNamedSuppliers = Array.from(supplierMap.values()).filter(s => !s.name || s.name.trim() === '');
                        if (emptyNamedSuppliers.length > 0) {
                            console.log('⚠️ Tedarikçi adı boş olan satırlar:', emptyNamedSuppliers.length);
                            emptyNamedSuppliers.forEach((s, idx) => {
                                console.log(`  - Satır ${idx + 1}: Sevk=${s.monthlySevk.reduce((a,b)=>a+b)}, İade=${s.monthlyIade.reduce((a,b)=>a+b)}, Hata=${s.monthlyHata.reduce((a,b)=>a+b)}`);
                            });
                        }
            const sumSelected = (arr) => Array.from(selectedMonths).reduce((s,m)=> s + (arr[m-1]||0), 0);
            allResults = Array.from(supplierMap.values()).map(supplier => {
                // Mevcut tedarikçinin değerlerini koru (PPM hedefi, Hata hedefi vb.)
                const existingSupplier = allResults.find(r => r.name === supplier.name || r.normalizedName === supplier.normalizedName);
                
                let ppm = 0;
                const totalSevk = sumSelected(supplier.monthlySevk) + (hasKnownSevkMonths ? 0 : (supplier.unknownSevk || 0));
                const totalIade = sumSelected(supplier.monthlyIade) + (hasKnownIadeMonths ? 0 : (supplier.unknownIade || 0));
                const totalHata = sumSelected(supplier.monthlyHata) + (hasKnownHataMonths ? 0 : (supplier.unknownHata || 0));
                
                if (DEBUG_VERBOSE_LOGS) {
                    console.log(`${supplier.name}: Sevk=${totalSevk}, İade=${totalIade}, Hata=${totalHata}`);
                }
                
                if (totalSevk > 0) {
                    ppm = (totalIade / totalSevk) * 1000000;
                }
                
                // Hata puanı hesaplama: Excel formülü
                // =EĞER(Hata_Sayısı_Gerçekleşen=0;1;EĞER(Hata_Sayısı_Hedef/Hata_Sayısı_Gerçekleşen>1;1;Hata_Sayısı_Hedef/Hata_Sayısı_Gerçekleşen))
                
                // Mevcut tedarikçinin Hata Hedefini koru, yoksa varsayılan 2
                const hataHedefi = existingSupplier ? existingSupplier.hataHedefi : 2;
                
                let hataPuan;
                if (hataHedefi === 0) {
                    // Hata hedefi sıfır ise
                    hataPuan = totalHata === 0 ? 1 : 0; // Hata da sıfırsa %100, değilse %0
                } else if (totalHata === 0) {
                    hataPuan = 1; // %100
                } else if ((hataHedefi / totalHata) > 1) {
                    hataPuan = 1; // %100
                } else {
                    hataPuan = hataHedefi / totalHata;
                }
                
                // PPM Puanı hesaplama
                // =EĞER([@[PPM ortalama]]=0;1;
                // EĞER([@[PPM ortalama]]<=0,2*[@[PPM Hedef]];0,95;
                // EĞER([@[PPM ortalama]]<=0,4*[@[PPM Hedef]];0,9;
                // EĞER([@[PPM ortalama]]<=0,6*[@[PPM Hedef]];0,85;
                // EĞER([@[PPM ortalama]]<=0,8*[@[PPM Hedef]];0,8;
                // EĞER([@[PPM ortalama]]<1,2*[@[PPM Hedef]];0,6;0))))))
                
                // Mevcut tedarikçinin PPM hedefini koru, yoksa varsayılan 1000
                const ppmTarget = existingSupplier ? existingSupplier.ppmTarget : 1000;
                
                let ppmPuan = 0;
                if (ppm === 0) {
                    ppmPuan = 1;
                } else if (ppm <= 0.2 * ppmTarget) {
                    ppmPuan = 0.95;
                } else if (ppm <= 0.4 * ppmTarget) {
                    ppmPuan = 0.9;
                } else if (ppm <= 0.6 * ppmTarget) {
                    ppmPuan = 0.85;
                } else if (ppm <= 0.8 * ppmTarget) {
                    ppmPuan = 0.8;
                } else if (ppm < 1.2 * ppmTarget) {
                    ppmPuan = 0.6;
                } else {
                    ppmPuan = 0;
                }
                
                // Tedarikçi Puanı hesaplama (başlangıçta VDA=0, diğer değerler default)
                const vdaPuan = 0;
                const kalitePuan = 0;
                const donusOrani8D = 100;
                const terminPuan = 0;
                const tamamlanmaPuan = 0;
                
                // Normalizasyon: 0-100 aralığındaki değerleri 0-1 aralığına çevir
                const kalitePuanNormalized = kalitePuan / 100;
                const vdaPuanNormalized = vdaPuan / 100;
                const donusOrani8DNormalized = donusOrani8D / 100;
                const terminPuanNormalized = terminPuan / 100;
                const tamamlanmaPuanNormalized = tamamlanmaPuan / 100;
                
                let tedarikcipuani = 0;
                if (vdaPuan > 0) {
                    // VDA puanı olan tedarikçiler
                    tedarikcipuani = (vdaPuanNormalized * 0.20 + 
                                     kalitePuanNormalized * 0.05 + 
                                     ppmPuan * 0.30 + 
                                     donusOrani8DNormalized * 0.05 + 
                                     terminPuanNormalized * 0.20 + 
                                     tamamlanmaPuanNormalized * 0.10 + 
                                     hataPuan * 0.10);
                } else {
                    // VDA denetimi olmayan tedarikçiler
                    tedarikcipuani = (kalitePuanNormalized * 0.05 + 
                                     ppmPuan * 0.40 + 
                                     donusOrani8DNormalized * 0.10 + 
                                     terminPuanNormalized * 0.20 + 
                                     tamamlanmaPuanNormalized * 0.10 + 
                                     hataPuan * 0.15);
                }
                
                // Tedarikçi sınıfı hesaplama
                let tedarikcisınıfı = 'D';
                if (tedarikcipuani >= 0.9) {
                    tedarikcisınıfı = 'A';
                } else if (tedarikcipuani >= 0.8) {
                    tedarikcisınıfı = 'B';
                } else if (tedarikcipuani >= 0.6) {
                    tedarikcisınıfı = 'C';
                }
                
                return {
                    status: supplier.status,
                    name: supplier.name,
                    'Tedarikçi Adı': supplier.name, // Excel ile uyumlu alan adı
                    mapKey: supplier.mapKey,
                    normalizedName: supplier.normalizedName,
                    totalSevk: totalSevk,
                    totalIade: totalIade,
                    ppmTarget: ppmTarget,
                    ppm: ppm,
                    currentPPM: ppm, // currentPPM da ata
                    ppmPuan: ppmPuan,
                    hataHedefi: hataHedefi,
                    totalHata: totalHata,
                    hataPuan: hataPuan,
                    monthlySevk: supplier.monthlySevk,
                    monthlyIade: supplier.monthlyIade,
                    monthlyHata: supplier.monthlyHata,
                    unknownSevk: supplier.unknownSevk,
                    unknownIade: supplier.unknownIade,
                    unknownHata: supplier.unknownHata,
                    hasKnownSevkMonths: hasKnownSevkMonths,
                    hasKnownIadeMonths: hasKnownIadeMonths,
                    hasKnownHataMonths: hasKnownHataMonths,
                    iso9001: false,
                    iatf: false,
                    iso14001: false,
                    iso45001: false,
                    certExpiryDates: {},
                    kalitePuan: kalitePuan,
                    vdaPuan: vdaPuan,
                    talepEdilen8D: existingSupplier?.talepEdilen8D || counts8DMap.get(supplier.normalizedName)?.talepEdilen8D || 0,
                    cevaplanan8D: existingSupplier?.cevaplanan8D || counts8DMap.get(supplier.normalizedName)?.cevaplanan8D || 0,
                    donusOrani8D: (() => {
                        const talep = existingSupplier?.talepEdilen8D || counts8DMap.get(supplier.normalizedName)?.talepEdilen8D || 0;
                        if (talep === 0) return 100; // Hiç 8D talebi yoksa %100
                        return existingSupplier?.donusOrani8D || counts8DMap.get(supplier.normalizedName)?.donusOrani8D || donusOrani8D;
                    })(),
                    terminPuan: terminPuan,
                    tamamlanmaPuan: tamamlanmaPuan,
                    monthlyTerminPuan: Array.from({length: 12}, () => 100),
                    monthlyTamamlanmaPuan: Array.from({length: 12}, () => 100),
                    monthlyKalitePuan: new Array(12).fill(0),
                    monthlyVdaPuan: new Array(12).fill(0),
                    monthlyPpmPuan: supplier.monthlySevk.map((sevk, idx) => {
                        const iade = supplier.monthlyIade[idx] || 0;
                        const monthlyPpm = sevk > 0 ? (iade / sevk) * 1000000 : 0;
                        const targetPpm = ppmTarget; // Yukarıda hesaplanan ppmTarget değerini kullan
                        
                        // PPM Puanı hesaplama formülü
                        let ppmPuan = 0;
                        if (monthlyPpm === 0) {
                            ppmPuan = 1; // %100
                        } else if (monthlyPpm <= 0.2 * targetPpm) {
                            ppmPuan = 0.95;
                        } else if (monthlyPpm <= 0.4 * targetPpm) {
                            ppmPuan = 0.9;
                        } else if (monthlyPpm <= 0.6 * targetPpm) {
                            ppmPuan = 0.85;
                        } else if (monthlyPpm <= 0.8 * targetPpm) {
                            ppmPuan = 0.8;
                        } else if (monthlyPpm < 1.2 * targetPpm) {
                            ppmPuan = 0.6;
                        } else {
                            ppmPuan = 0;
                        }
                        return ppmPuan;
                    }),
                    monthlyPPM: supplier.monthlySevk.map((sevk, idx) => {
                        const iade = supplier.monthlyIade[idx] || 0;
                        return sevk > 0 ? (iade / sevk) * 1000000 : 0;
                    }),
                    originalMonthlyPPM: supplier.monthlySevk.map((sevk, idx) => {
                        const iade = supplier.monthlyIade[idx] || 0;
                        return sevk > 0 ? (iade / sevk) * 1000000 : 0;
                    }),
                    tedarikcipuani: tedarikcipuani,
                    tedarikcisınıfı: tedarikcisınıfı,
                    lokasyon: []
                };
            });

            // Sıralama - PPM'e göre yüksekten düşüğe
            allResults.sort((a, b) => b.ppm - a.ppm);

            // Lokasyonları IndexedDB'den async olarak yükle
            Promise.all(allResults.map(async (supplier) => {
                try {
                    const savedLocation = await getSavedLocation(supplier.name);
                    supplier.lokasyon = savedLocation || [];
                } catch (e) {
                    console.error(`${supplier.name} lokasyonu yüklenemedi:`, e);
                    supplier.lokasyon = [];
                }
            })).then(() => {
                // Dokümanları IndexedDB'den async olarak yükle
                return Promise.all(allResults.map(async (supplier) => {
                    try {
                        const savedDocuments = await getSupplierDocuments(supplier.name);
                        supplier.documents = savedDocuments || { documents: {}, timestamps: {} };
                    } catch (e) {
                        console.error(`${supplier.name} dokümanları yüklenemedi:`, e);
                        supplier.documents = { documents: {}, timestamps: {} };
                    }
                }));
            }).then(() => {
                console.log('✅ Tüm lokasyonlar ve dokümanlar IndexedDB\'den yüklendi');
                // 8D sayılarını veritabanından yükle
                return load8DCountsFromDB();
            }).then(() => {
                console.log('✅ 8D sayıları veritabanından yüklendi');
                // Tabloyu yeniden render et
                filterTable();
            }).catch(err => {
                console.error('Lokasyon/Doküman/8D yükleme hatası:', err);
            });

            // Durum eşleştirme istatistiklerini hesapla
            const statusStats = {
                total: allResults.length,
                known: 0,
                onayli: 0,
                onaysiz: 0,
                musteri: 0
            };
            
            allResults.forEach(supplier => {
                const normalizedName = normalizeName(supplier.name);
                if (supplierStatusMap.has(normalizedName)) {
                    statusStats.known++;
                    const status = supplierStatusMap.get(normalizedName).toUpperCase();
                    if (status === 'ONAYLI') statusStats.onayli++;
                    else if (status === 'ONAYSIZ') statusStats.onaysiz++;
                    else if (status === 'MÜŞTERİ') statusStats.musteri++;
                }
            });
            
            // Bildirim mesajı oluştur
            let notificationMsg = `✅ ${statusStats.total} tedarikçi yüklendi ve analiz edildi.`;
            if (statusStats.known > 0) {
                notificationMsg += `\n\n🔖 Daha önce tanımlı: ${statusStats.known} tedarikçi`;
                const details = [];
                if (statusStats.onayli > 0) details.push(`Onaylı: ${statusStats.onayli}`);
                if (statusStats.onaysiz > 0) details.push(`Onaysız: ${statusStats.onaysiz}`);
                if (statusStats.musteri > 0) details.push(`Müşteri: ${statusStats.musteri}`);
                if (details.length > 0) {
                    notificationMsg += ` (${details.join(', ')})`;
                }
            }
            
            // Yeni tedarikçiler
            const newSuppliers = statusStats.total - statusStats.known;
            if (newSuppliers > 0) {
                notificationMsg += `\n📝 Yeni tedarikçi: ${newSuppliers} (varsayılan: Onaylı)`;
            }
            
            console.log('Durum İstatistikleri:', statusStats);
            showAlert(notificationMsg, 'success');

            // Eğer ikinci Excel dosyası zaten yüklenmişse, aylık puanları güncelle
            if (monthlyScoresData.size > 0) {
                updateResultsWithMonthlyScores();
            }

            // Tedarikçi listesini doldur
            populateSupplierFilter();

            // İkinci dosya yükleme bölümünü göster
            document.getElementById('secondUploadSection').style.display = 'block';

            displayResults();
            
            // Kaydedilmiş filtreleri yükle
            loadSavedFilters();
            
            // Excel yüklendikten sonra bekleyen JSON verilerini uygula
            applyPendingSupplierData();
            
            // Kaydedilmiş sertifika verilerini geri yükle
            loadSupplierCertData();
        }
        
        // Bekleyen tedarikçi verilerini uygula
        function applyPendingSupplierData() {
            const pendingData = localStorage.getItem('pendingSupplierData');
            if (!pendingData) return;
            
            try {
                const suppliers = JSON.parse(pendingData);
                console.log('📥 Bekleyen tedarikçi verileri uygulanıyor...', suppliers.length, 'tedarikçi');
                
                let appliedCount = 0;
                allResults.forEach(supplier => {
                    const savedSupplier = suppliers.find(s => 
                        s.name === supplier.name || 
                        s.normalizedName === (supplier.normalizedName || normalizeName(supplier.name))
                    );
                    
                    if (savedSupplier) {
                        supplier.iatf = savedSupplier.iatf || false;
                        supplier.iso9001 = savedSupplier.iso9001 || false;
                        supplier.iso14001 = savedSupplier.iso14001 || false;
                        supplier.iso45001 = savedSupplier.iso45001 || false;
                        supplier.certExpiryDates = savedSupplier.certExpiryDates || {};
                        supplier.talepEdilen8D = savedSupplier.talepEdilen8D || 0;
                        supplier.cevaplanan8D = savedSupplier.cevaplanan8D || 0;
                        supplier.vdaPuan = savedSupplier.vdaPuan || 0;
                        supplier.terminPuan = savedSupplier.terminPuan || 100;
                        supplier.tamamlanmaPuan = savedSupplier.tamamlanmaPuan || 100;
                        supplier.lokasyon = savedSupplier.lokasyon || [];
                        supplier.ppmTarget = savedSupplier.ppmTarget || null;
                        supplier.hataHedefi = savedSupplier.hataHedefi || null;
                        
                        recalculateSupplierScore(supplier);
                        appliedCount++;
                    }
                });
                
                // Verileri uygulad ktan sonra bekleyen veriyi temizle
                localStorage.removeItem('pendingSupplierData');
                
                // Tabloyu yenile
                filterTable();
                
                showAlert(`✅ ${appliedCount} tedarikçinin kaydedilmiş verileri yüklendi!`, 'success');
                console.log(`✅ ${appliedCount} tedarikçinin verileri başarıyla uygulandı`);
            } catch (err) {
                console.error('Bekleyen veri uygulama hatası:', err);
                localStorage.removeItem('pendingSupplierData');
            }
        }

        // ======== Sertifika Verileri Otomatik Kaydetme/Yükleme ========
        // Sertifika verilerini localStorage'a kaydet
        function saveSupplierCertData() {
            try {
                const certData = {};
                allResults.forEach(supplier => {
                    const name = supplier.name;
                    const hasCerts = supplier.iatf || supplier.iso9001 || supplier.iso14001 || supplier.iso45001;
                    const hasExpiry = supplier.certExpiryDates && Object.keys(supplier.certExpiryDates).length > 0;
                    const hasCustom = supplier.customCertificates && supplier.customCertificates.length > 0;
                    if (hasCerts || hasExpiry || hasCustom) {
                        certData[name] = {
                            iatf: supplier.iatf || false,
                            iso9001: supplier.iso9001 || false,
                            iso14001: supplier.iso14001 || false,
                            iso45001: supplier.iso45001 || false,
                            certExpiryDates: supplier.certExpiryDates || {},
                            customCertificates: supplier.customCertificates || [],
                            kalitePuan: supplier.kalitePuan || 0
                        };
                    }
                });
                if (Object.keys(certData).length > 0) {
                    localStorage.setItem('supplierCertData', JSON.stringify(certData));
                    console.log(`💾 ${Object.keys(certData).length} tedarikçinin sertifika verisi kaydedildi`);
                }
            } catch (e) {
                console.error('Sertifika verisi kaydetme hatası:', e);
            }
        }

        // Sertifika verilerini localStorage'dan yükle
        function loadSupplierCertData() {
            try {
                const saved = localStorage.getItem('supplierCertData');
                if (!saved) return;
                
                const certData = JSON.parse(saved);
                let appliedCount = 0;
                
                allResults.forEach(supplier => {
                    const data = certData[supplier.name];
                    if (data) {
                        supplier.iatf = data.iatf || false;
                        supplier.iso9001 = data.iso9001 || false;
                        supplier.iso14001 = data.iso14001 || false;
                        supplier.iso45001 = data.iso45001 || false;
                        supplier.certExpiryDates = data.certExpiryDates || {};
                        supplier.customCertificates = data.customCertificates || [];
                        supplier.kalitePuan = data.kalitePuan || 0;
                        // Aylık kalite puanlarını da güncelle
                        if (supplier.monthlyKalitePuan) {
                            for (let m = 0; m < 12; m++) {
                                supplier.monthlyKalitePuan[m] = supplier.kalitePuan;
                            }
                        }
                        recalculateSupplierScore(supplier);
                        appliedCount++;
                    }
                });
                
                if (appliedCount > 0) {
                    console.log(`📋 ${appliedCount} tedarikçinin sertifika verileri geri yüklendi`);
                }
            } catch (e) {
                console.error('Sertifika verisi yükleme hatası:', e);
            }
        }

        // Ay seçimi değiştiğinde tüm metrikleri yeniden hesapla
        function recomputeAllWithSelectedMonths() {
            console.log('recomputeAllWithSelectedMonths çağrıldı, selectedMonths:', Array.from(selectedMonths));
            // Seçilen ayların toplamı (sadece seçilen aylar, kümülatif değil)
            const sumSelected = (arr) => Array.from(selectedMonths).reduce((s,m)=> s + (arr[m-1]||0), 0);
            
            if (allResults.length > 0) {
                console.log('İlk tedarikçinin monthlySevk:', allResults[0].monthlySevk);
                console.log('İlk tedarikçinin unknownSevk:', allResults[0].unknownSevk);
                console.log('İlk tedarikçinin hasKnownSevkMonths:', allResults[0].hasKnownSevkMonths);
            }
            
            allResults.forEach(r => {
                if (r.monthlySevk) {
                    if (!r.manualTotalSevk) {
                        r.totalSevk = sumSelected(r.monthlySevk) + (r.hasKnownSevkMonths ? 0 : (r.unknownSevk || 0));
                    }
                    r.totalIade = sumSelected(r.monthlyIade) + (r.hasKnownIadeMonths ? 0 : (r.unknownIade || 0));
                    r.totalHata = sumSelected(r.monthlyHata) + (r.hasKnownHataMonths ? 0 : (r.unknownHata || 0));
                    r.ppm = r.totalSevk > 0 ? (r.totalIade / r.totalSevk) * 1000000 : 0;
                    
                    // PPM Puanı hesaplama
                    const ppmTarget = r.ppmTarget || 1000;
                    if (r.ppm === 0) {
                        r.ppmPuan = 1;
                    } else if (r.ppm <= 0.2 * ppmTarget) {
                        r.ppmPuan = 0.95;
                    } else if (r.ppm <= 0.4 * ppmTarget) {
                        r.ppmPuan = 0.9;
                    } else if (r.ppm <= 0.6 * ppmTarget) {
                        r.ppmPuan = 0.85;
                    } else if (r.ppm <= 0.8 * ppmTarget) {
                        r.ppmPuan = 0.8;
                    } else if (r.ppm < 1.2 * ppmTarget) {
                        r.ppmPuan = 0.6;
                    } else {
                        r.ppmPuan = 0;
                    }
                    
                    const hataHedefi = r.hataHedefi || 2;
                    // Excel formülü: =EĞER(Hata=0;1;EĞER(Hedef/Hata>1;1;Hedef/Hata))
                    if (hataHedefi === 0) {
                        r.hataPuan = r.totalHata === 0 ? 1 : 0;
                    } else if (r.totalHata === 0) {
                        r.hataPuan = 1;
                    } else if ((hataHedefi / r.totalHata) > 1) {
                        r.hataPuan = 1;
                    } else {
                        r.hataPuan = hataHedefi / r.totalHata;
                    }
                    recalculateSupplierScore(r);
                }
            });
            updateResultsWithMonthlyScores();
            // Dashboard ve tablo güncelleme
            updateDashboard(allResults);
            filterTable();

            console.log('recomputeAllWithSelectedMonths tamamlandı, yeni Sevk:', allResults[0]?.totalSevk);
        }

        function populateSupplierFilter() {
            const supplierOptions = document.getElementById('supplierOptions');
            
            // Tüm tedarikçileri seçili yap (başlangıçta)
            selectedSuppliers.clear();
            allResults.forEach(r => selectedSuppliers.add(r.mapKey || r.name));
            
            let html = `
                <div class="multiselect-option select-all">
                    <input type="checkbox" id="selectAll" checked onchange="toggleSelectAll(this)">
                    <label for="selectAll">Tümünü Seç / Kaldır</label>
                </div>
            `;
            
            allResults.forEach((result, index) => {
                html += `
                    <div class="multiselect-option" data-supplier="${result.name}" data-supplier-key="${result.mapKey || result.name}">
                        <input type="checkbox" 
                               id="supplier_${index}" 
                               checked
                               onchange="toggleSupplier('${(result.mapKey || result.name).replace(/'/g, "\\'")}')">
                        <label for="supplier_${index}">${result.name}</label>
                    </div>
                `;
            });
            
            supplierOptions.innerHTML = html;
            updateSelectedText();
        }

        function toggleSupplierDropdown() {
            const container = document.getElementById('supplierContainer');
            container.classList.toggle('open');
            // Diğer dropdownları kapat
            const locationContainer = document.getElementById('locationContainer');
            if (locationContainer) locationContainer.classList.remove('open');
            const monthContainer = document.getElementById('monthContainer');
            if (monthContainer) monthContainer.classList.remove('open');
        }
        
        function toggleLocationDropdown() {
            const container = document.getElementById('locationContainer');
            container.classList.toggle('open');
            // Tedarikçi dropdownunu kapat
            const supplierContainer = document.getElementById('supplierContainer');
            if (supplierContainer) supplierContainer.classList.remove('open');
            const monthContainer = document.getElementById('monthContainer');
            if (monthContainer) monthContainer.classList.remove('open');
        }

        // Dropdown dışına tıklanınca kapat
        document.addEventListener('click', (e) => {
            const supplierContainer = document.getElementById('supplierContainer');
            const locationContainer = document.getElementById('locationContainer');
            const monthContainer = document.getElementById('monthContainer');
            
            if (supplierContainer && !supplierContainer.contains(e.target)) {
                supplierContainer.classList.remove('open');
            }
            if (locationContainer && !locationContainer.contains(e.target)) {
                locationContainer.classList.remove('open');
            }
            if (monthContainer && !monthContainer.contains(e.target)) {
                monthContainer.classList.remove('open');
            }
            
            // Tablo içindeki dropdown'ları kapat
            if (!e.target.closest('[id^="lokasyonDropdown_"]') && !e.target.closest('[onclick*="toggleLokasyonDropdown"]')) {
                const hadVisibleDropdown = Array.from(document.querySelectorAll('[id^="lokasyonDropdown_"]')).some(d => d.style.display === 'block');
                document.querySelectorAll('[id^="lokasyonDropdown_"]').forEach(d => d.style.display = 'none');
                // Dropdown kapatıldığında tabloyu güncelle
                if (hadVisibleDropdown) {
                    filterTable();
                }
            }
            if (!e.target.closest('[id^="kaliteBelgeDropdown_"]') && !e.target.closest('[onclick*="toggleKaliteBelgeDropdown"]')) {
                document.querySelectorAll('[id^="kaliteBelgeDropdown_"]').forEach(d => d.style.display = 'none');
            }
        });

        function toggleMonthDropdown() {
            const container = document.getElementById('monthContainer');
            container.classList.toggle('open');
            const supplierContainer = document.getElementById('supplierContainer');
            if (supplierContainer) supplierContainer.classList.remove('open');
            const locationContainer = document.getElementById('locationContainer');
            if (locationContainer) locationContainer.classList.remove('open');
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.multiselect-option:not(.select-all) input[type="checkbox"]');
            // Set'i temizle ve seçime göre tekrar doldur ki sayı sapmaları oluşmasın
            selectedSuppliers.clear();
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const supplierKey = cb.parentElement.getAttribute('data-supplier-key') || cb.parentElement.getAttribute('data-supplier');
                if (checkbox.checked) {
                    selectedSuppliers.add(supplierKey);
                } else {
                    // boş: set zaten temizlendi
                }
            });
            updateSelectedText();
            filterTable();
        }

        function toggleSupplier(supplierKey) {
            if (selectedSuppliers.has(supplierKey)) {
                selectedSuppliers.delete(supplierKey);
            } else {
                selectedSuppliers.add(supplierKey);
            }
            
            // "Tümünü Seç" checkbox'ını güncelle
            const selectAllCheckbox = document.getElementById('selectAll');
            const totalSuppliers = allResults.length;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedSuppliers.size === totalSuppliers;
            }
            
            updateSelectedText();
            filterTable();
        }

        function updateSelectedText() {
            normalizeSelectedSuppliers();
            const selectedText = document.getElementById('selectedText');
            const count = selectedSuppliers.size;
            const total = allResults.length;
            
            if (count === 0) {
                selectedText.textContent = 'Hiçbiri Seçili Değil';
            } else if (count === total) {
                selectedText.textContent = 'Tümü Seçili';
            } else {
                selectedText.textContent = `${count} / ${total} Tedarikçi Seçili`;
            }
        }

        function toggleRowSelection(rowKey, checked) {
            if (checked) {
                selectedRows.add(rowKey);
            } else {
                selectedRows.delete(rowKey);
            }
            updateRowSelectAllCheckbox();
        }

        function toggleSelectAllRows(checkbox) {
            const rowCheckboxes = document.querySelectorAll('.row-select');
            selectedRows.clear();
            rowCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const key = cb.getAttribute('data-row-key');
                if (checkbox.checked && key) {
                    selectedRows.add(key);
                }
            });
            updateRowSelectAllCheckbox();
        }

        function updateRowSelectAllCheckbox() {
            normalizeSelectedRows();
            const master = document.getElementById('rowSelectAll');
            if (!master) return;
            const rows = Array.from(document.querySelectorAll('.row-select'));
            if (rows.length === 0) {
                master.checked = false;
                return;
            }
            const checkedCount = rows.filter(cb => cb.checked).length;
            master.checked = checkedCount === rows.length;
        }

        function deleteSelectedSuppliers() {
            normalizeSelectedRows();
            if (selectedRows.size === 0) {
                showAlert('⚠️ Silmek için satır seçin.', 'error');
                return;
            }
            if (!confirm(`${selectedRows.size} satır silinecek, emin misiniz?`)) {
                return;
            }
            const deleteKeys = new Set(selectedRows);
            const deletedItems = allResults.filter(r => deleteKeys.has(r.mapKey || r.name));
            if (deletedItems.length === 0) {
                showAlert('⚠️ Silinecek kayıt bulunamadı.', 'error');
                return;
            }

            // Undo yığınına ekle, redo temizle
            undoStack.push(deletedItems);
            redoStack = [];

            allResults = allResults.filter(r => !deleteKeys.has(r.mapKey || r.name));
            selectedRows.clear();
            filterTable();
            showAlert(`✅ ${deletedItems.length} satır silindi.`, 'success');
        }

        function applyBulkPPMTarget() {
            normalizeSelectedRows();
            if (selectedRows.size === 0) {
                showAlert('⚠️ Lütfen önce satır seçin.', 'error');
                return;
            }
            const input = document.getElementById('bulkPPMTarget');
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                showAlert('⚠️ Geçerli bir PPM hedefi girin.', 'error');
                return;
            }

            let updatedCount = 0;
            selectedRows.forEach(key => {
                const supplier = allResults.find(r => (r.mapKey || r.name) === key);
                if (supplier) {
                    supplier.ppmTarget = value;
                    
                    // PPM Puanını yeniden hesapla
                    const ppm = supplier.ppm;
                    let ppmPuan = 0;
                    if (ppm === 0) {
                        ppmPuan = 1;
                    } else if (ppm <= 0.2 * value) {
                        ppmPuan = 0.95;
                    } else if (ppm <= 0.4 * value) {
                        ppmPuan = 0.9;
                    } else if (ppm <= 0.6 * value) {
                        ppmPuan = 0.85;
                    } else if (ppm <= 0.8 * value) {
                        ppmPuan = 0.8;
                    } else if (ppm < 1.2 * value) {
                        ppmPuan = 0.6;
                    } else {
                        ppmPuan = 0;
                    }
                    supplier.ppmPuan = ppmPuan;
                    
                    // Tedarikçi puanını yeniden hesapla
                    supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                    supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                    
                    savePPMTargetToStorage(supplier.name, value);
                    updatedCount++;
                }
            });

            filterTable();
            input.value = '';
            showAlert(`✅ ${updatedCount} tedarikçinin PPM hedefi ${value} olarak güncellendi.`, 'success');
        }

        function applyBulkHataHedefi() {
            normalizeSelectedRows();
            if (selectedRows.size === 0) {
                showAlert('⚠️ Lütfen önce satır seçin.', 'error');
                return;
            }
            const input = document.getElementById('bulkHataHedefi');
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                showAlert('⚠️ Geçerli bir hata hedefi girin.', 'error');
                return;
            }

            let updatedCount = 0;
            selectedRows.forEach(key => {
                const supplier = allResults.find(r => (r.mapKey || r.name) === key);
                if (supplier) {
                    supplier.hataHedefi = value;
                    
                    // Hata puanını yeniden hesapla
                    if (value === 0) {
                        supplier.hataPuan = supplier.totalHata === 0 ? 1 : 0;
                    } else if (supplier.totalHata === 0) {
                        supplier.hataPuan = 1;
                    } else if ((value / supplier.totalHata) > 1) {
                        supplier.hataPuan = 1;
                    } else {
                        supplier.hataPuan = value / supplier.totalHata;
                    }
                    
                    // Tedarikçi puanını yeniden hesapla
                    supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                    supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                    
                    saveHataHedefiToStorage(supplier.name, value);
                    updatedCount++;
                }
            });

            filterTable();
            input.value = '';
            showAlert(`✅ ${updatedCount} tedarikçinin hata hedefi ${value} olarak güncellendi.`, 'success');
        }

        function undoDelete() {
            if (undoStack.length === 0) {
                showAlert('⚠️ Geri alınacak bir silme yok.', 'error');
                return;
            }
            const restored = undoStack.pop();
            if (!restored || restored.length === 0) {
                return;
            }
            // Redo için sakla
            redoStack.push(restored);

            // Geri ekle ve yeniden sırala (PPM'e göre yüksekten düşüğe)
            allResults = allResults.concat(restored).sort((a, b) => b.ppm - a.ppm);
            lastFilteredResults = lastFilteredResults.concat(restored).sort((a, b) => b.ppm - a.ppm);
            normalizeSelectedSuppliers();
            normalizeSelectedRows();
            updateSelectedText();
            updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
            filterTable();
            showAlert(`↩️ ${restored.length} satır geri yüklendi.`, 'success');
        }

        function redoDelete() {
            if (redoStack.length === 0) {
                showAlert('⚠️ Yeniden uygulanacak silme yok.', 'error');
                return;
            }
            const toDelete = redoStack.pop();
            if (!toDelete || toDelete.length === 0) return;
            const deleteKeys = new Set(toDelete.map(r => r.mapKey || r.name));
            // Undo yığınına yeniden ekle ki tekrar undo yapılabilsin
            undoStack.push(toDelete);
            allResults = allResults.filter(r => !deleteKeys.has(r.mapKey || r.name));
            lastFilteredResults = lastFilteredResults.filter(r => !deleteKeys.has(r.mapKey || r.name));
            selectedSuppliers = new Set(Array.from(selectedSuppliers).filter(k => !deleteKeys.has(k)));
            normalizeSelectedRows();
            updateSelectedText();
            updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
            filterTable();
            showAlert(`↪️ ${toDelete.length} satır yeniden silindi.`, 'success');
        }
        
        function toggleAllLocations(checkbox) {
            const checkboxes = document.querySelectorAll('#locationOptions input[type="checkbox"]:not([value="__TUMU__"])');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateLocationFilter();
        }
        
        function updateLocationFilter() {
            const checkboxes = document.querySelectorAll('#locationOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const selectedLocations = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            const totalLocations = checkboxes.length;
            const selectedCount = selectedLocations.length;
            
            // "Tümü" checkbox'ını güncelle
            const selectAllCheckbox = document.querySelector('#locationOptions input[value="__TUMU__"]');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCount === totalLocations;
            }
            
            // Seçili lokasyon metnini güncelle
            const selectedText = document.getElementById('selectedLocationText');
            if (selectedCount === 0) {
                selectedText.textContent = 'Hiçbiri Seçili Değil';
            } else if (selectedCount === totalLocations) {
                selectedText.textContent = 'Tümü Seçili';
            } else {
                selectedText.textContent = `${selectedCount} / ${totalLocations} Lokasyon`;
            }
            
            filterTable();
        }
        
        function toggleAllDurumlar(checkbox) {
            const checkboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]:not([value="__TUMU__"])');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDurumFilter();
        }
        
        // Debounce timer
        let durumFilterTimeout = null;
        
        function updateDurumFilter(immediate = false) {
            const checkboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const selectedDurumlar = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            const totalDurumlar = checkboxes.length;
            const selectedCount = selectedDurumlar.length;
            
            // "Tümü" checkbox'ını güncelle
            const selectAllCheckbox = document.querySelector('#durumOptions input[value="__TUMU__"]');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCount === totalDurumlar;
            }
            
            // Seçili durum metnini güncelle
            const selectedText = document.getElementById('selectedDurumText');
            if (selectedCount === 0) {
                selectedText.textContent = 'Hiçbiri Seçili Değil';
            } else if (selectedCount === totalDurumlar) {
                selectedText.textContent = 'Tümü Seçili';
            } else {
                selectedText.textContent = `${selectedCount} / ${totalDurumlar} Durum`;
            }
            
            // Debounce ile filtreleme - dropdown kapanana kadar bekle
            if (immediate) {
                if (durumFilterTimeout) clearTimeout(durumFilterTimeout);
                filterTable();
            } else {
                if (durumFilterTimeout) clearTimeout(durumFilterTimeout);
                durumFilterTimeout = setTimeout(() => {
                    filterTable();
                }, 300);
            }
        }
        
        function toggleDurumDropdown() {
            const dropdown = document.getElementById('durumOptions');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        // Ay filtresi yardımcıları
        function toggleAllMonths(checkbox) {
            const checkboxes = document.querySelectorAll('#monthOptions input[type="checkbox"]:not([value="__TUMU__"])');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateMonthFilter();
        }
        
        function updateMonthFilter() {
            const checkboxes = document.querySelectorAll('#monthOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const months = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));
            selectedMonths = new Set(months);
            selectedMonthMax = months.length > 0 ? Math.max(...months) : 0;
            const selectAllCheckbox = document.querySelector('#monthOptions input[value="__TUMU__"]');
            if (selectAllCheckbox) selectAllCheckbox.checked = months.length === 12;
            const textEl = document.getElementById('selectedMonthText');
            if (textEl) textEl.textContent = months.length === 12 ? 'Tümü Seçili' : (months.length === 0 ? 'Hiçbiri' : `${months.length} Ay`);
            recomputeAllWithSelectedMonths();
        }

        function filterSupplierList() {
            const searchTerm = document.getElementById('supplierSearchInput').value.toLowerCase().trim();
            const options = document.querySelectorAll('.multiselect-option:not(.select-all)');
            
            options.forEach(option => {
                const label = option.querySelector('label');
                let text = '';
                if (label) {
                    text = label.textContent.toLowerCase().trim();
                } else {
                    // Eğer label yoksa data-supplier'dan al
                    text = (option.getAttribute('data-supplier') || '').toLowerCase().trim();
                }
                
                if (text.includes(searchTerm) || searchTerm === '') {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function displayResults() {
            document.getElementById('controls').classList.add('active');
            lastFilteredResults = allResults;
            
            // selectedSuppliers Set'ini güncelle (FİLTRE İÇİN ÖNEMLİ!)
            selectedSuppliers.clear();
            allResults.forEach(supplier => {
                const supplierKey = supplier.mapKey || supplier.name;
                selectedSuppliers.add(supplierKey);
            });
            console.log(`✅ ${selectedSuppliers.size} tedarikçi selectedSuppliers'a eklendi (displayResults)`);
            
            updateDashboard(lastFilteredResults);
            renderTable(allResults);
        }

        function updateDashboard(results) {
            // İstatistikler
            const totalSuppliers = results.length;
            const totalSevk = results.reduce((sum, r) => sum + r.totalSevk, 0);
            const totalIade = results.reduce((sum, r) => sum + r.totalIade, 0);
            const avgPPM = totalSevk > 0 ? (totalIade / totalSevk) * 1000000 : 0;
            const totalHata = results.reduce((sum, r) => sum + r.totalHata, 0);
            const totalScore = results.reduce((sum, r) => sum + (Number.isFinite(r.tedarikcipuani) ? r.tedarikcipuani : 0), 0);
            const avgSupplierScore = totalSuppliers > 0 ? (totalScore / totalSuppliers) * 100 : 0;

            document.getElementById('statsContainer').innerHTML = `
                <div class="dashboard-row">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Toplam Tedarikçi</div>
                            <div class="stat-value">${totalSuppliers}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Toplam Sevkiyat</div>
                            <div class="stat-value">${totalSevk.toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Toplam İade</div>
                            <div class="stat-value">${totalIade.toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Genel PPM</div>
                            <div class="stat-value">${avgPPM.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Toplam Hata</div>
                            <div class="stat-value">${totalHata.toLocaleString('tr-TR')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Ortalama Tedarikçi Puanı</div>
                            <div class="stat-value">${avgSupplierScore.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="pie-card">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px;">
                            <div class="stat-label">Tedarikçi Sınıf Dağılımı (A/B/C/D)</div>
                            <div id="classFilterBadge" style="display: ${selectedClassFilter ? 'inline-flex' : 'none'}; align-items: center; gap: 6px; padding: 4px 8px; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 999px; font-size: 0.8em; color: #1e3c72;">
                                <span>Filtre: ${selectedClassFilter || ''}</span>
                                <button class="btn btn-secondary" style="padding: 2px 6px; font-size: 0.75em;" onclick="clearClassFilter()">Kaldır</button>
                            </div>
                        </div>
                        <canvas id="classPieChart"></canvas>
                    </div>
                </div>
            `;

            renderClassPieChart(results);
        }

        function renderTableRowsChunked(results, tbody, startIndex, token, onComplete) {
            if (token !== activeRenderToken) return;

            const end = Math.min(startIndex + ROW_RENDER_CHUNK_SIZE, results.length);
            let html = '';

            for (let i = startIndex; i < end; i++) {
                html += generateTableRow(results[i], i);
            }

            if (html) {
                tbody.insertAdjacentHTML('beforeend', html);
            }

            if (end < results.length) {
                requestAnimationFrame(() => renderTableRowsChunked(results, tbody, end, token, onComplete));
            } else if (typeof onComplete === 'function') {
                onComplete();
            }
        }

        function renderCombinedRowsChunked(items, tbody, startIndex, token, onComplete) {
            if (token !== activeRenderToken) return;

            const end = Math.min(startIndex + ROW_RENDER_CHUNK_SIZE, items.length);
            let html = '';

            for (let i = startIndex; i < end; i++) {
                const item = items[i];
                if (item.type === 'row') {
                    html += generateTableRow(item.row, item.index);
                } else if (item.type === 'separator') {
                    html += item.html;
                }
            }

            if (html) {
                tbody.insertAdjacentHTML('beforeend', html);
            }

            if (end < items.length) {
                requestAnimationFrame(() => renderCombinedRowsChunked(items, tbody, end, token, onComplete));
            } else if (typeof onComplete === 'function') {
                onComplete();
            }
        }

        function renderTableWithSeparator(onaylilar, onaysizlar, musteriler = []) {
            if (onaylilar.length === 0 && onaysizlar.length === 0 && musteriler.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="suppliers-table-container">
                        <div class="no-data">Arama kriterine uygun tedarikçi bulunamadı</div>
                    </div>
                `;
                return;
            }

            const container = document.getElementById('tableContainer');
            const scrollBeforeRender = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;

            container.innerHTML = `
                <div class="suppliers-table-container">
                    <div class="table-wrapper" style="overflow-x: auto !important; width: 100%; display: block;">
                        <table id="suppliersTable" style="width: 3200px; display: table;">
                            <thead>
                                <tr>
                                    <th class="text-center"><input type="checkbox" id="rowSelectAll" onchange="toggleSelectAllRows(this)"></th>
                                    <th>#</th>
                                    <th class="sortable" onclick="sortTable('status')">Durum <span class="sort-icon"></span></th>
                                    <th class="sortable" onclick="sortTable('name')">Tedarikçi <span class="sort-icon"></span></th>
                                    <th class="text-center sortable" onclick="sortTable('lokasyon')">Lokasyon <span class="sort-icon"></span></th>
                                    <th class="text-center">Dokümanlar</th>
                                    <th class="text-center">Tedarikçi Bilgileri</th>
                                    <th class="text-right sortable" onclick="sortTable('totalSevk')">Toplam Sevkiyat <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('totalIade')">Toplam İade <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppmTarget')">PPM Hedefi <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppm')">PPM <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppmPuan')">PPM Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('hataHedefi')">Hata Hedefi <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('totalHata')">Toplam Hata <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('hataPuan')">Hata Puanı <span class="sort-icon"></span></th>
                                    <th class="text-center">Kalite Belgeleri</th>
                                    <th class="text-right sortable" onclick="sortTable('kalitePuan')">Kalite Belge Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('vdaPuan')">VDA/Denetim Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('talepEdilen8D')">Talep Edilen 8D <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('cevaplanan8D')">Cevaplanan 8D <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('donusOrani8D')">8D Dönüş Oranı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('terminPuan')">Termin Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('tamamlanmaPuan')">Tamamlanma Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('tedarikcipuani')">Tedarikçi Puanı <span class="sort-icon"></span></th>
                                    <th class="text-center sortable" onclick="sortTable('tedarikcisınıfı')">Tedarikçi Sınıfı <span class="sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            `;

            const tbody = container.querySelector('#suppliersTable tbody');
            const token = ++activeRenderToken;
            const items = [];
            let globalIndex = 0;

            onaylilar.forEach((result) => {
                items.push({ type: 'row', row: result, index: globalIndex++ });
            });

            if (onaylilar.length > 0 && onaysizlar.length > 0) {
                items.push({
                    type: 'separator',
                    html: `
                        <tr class="separator-row">
                            <td colspan="25" style="background: linear-gradient(to right, #ff6b6b, #feca57); height: 3px; padding: 15px; text-align: center; font-weight: bold; color: white; font-size: 1.1em; letter-spacing: 2px;">
                                ⬇ ONAYSIZ TEDARİKÇİLER ⬇
                            </td>
                        </tr>
                    `
                });
            }

            onaysizlar.forEach((result) => {
                items.push({ type: 'row', row: result, index: globalIndex++ });
            });

            if ((onaylilar.length > 0 || onaysizlar.length > 0) && musteriler.length > 0) {
                items.push({
                    type: 'separator',
                    html: `
                        <tr class="separator-row">
                            <td colspan="25" style="background: linear-gradient(to right, #2196F3, #64B5F6); height: 3px; padding: 15px; text-align: center; font-weight: bold; color: white; font-size: 1.1em; letter-spacing: 2px;">
                                ⬇ MÜŞTERİ TEDARİKÇİLER ⬇
                            </td>
                        </tr>
                    `
                });
            }

            musteriler.forEach((result) => {
                items.push({ type: 'row', row: result, index: globalIndex++ });
            });

            renderCombinedRowsChunked(items, tbody, 0, token, () => {
                updateRowSelectAllCheckbox();
                // Sıralama ikonlarını güncelle
                if (currentSortColumn) {
                    updateSortIcons(currentSortColumn);
                }
                requestAnimationFrame(() => {
                    window.scrollTo(0, scrollBeforeRender);
                    const newTableWrapper = document.querySelector('.table-wrapper');
                    if (newTableWrapper) {
                        newTableWrapper.scrollLeft = horizontalScrollLeft;
                    }
                    setupNoJumpScrollGuard();
                    setupScrollStabilityGuard();
                });
            });
        }
        
        function getElementSelector(element) {
            if (element.id) return '#' + element.id;
            if (element.dataset.supplier) return `[data-supplier="${element.dataset.supplier}"]`;
            return null;
        }

        function generateTableRow(result, index) {
            // Müşteri durum kontrolü
            const isMusteri = result.status && result.status.toUpperCase() === 'MÜŞTERİ';
            
            // PPM hedefine göre renklendirme
            let ppmClass = 'ppm-low';
            if (result.ppm > result.ppmTarget * 2) ppmClass = 'ppm-high';
            else if (result.ppm > result.ppmTarget) ppmClass = 'ppm-medium';

            const statusClass = result.status && result.status.toLowerCase().includes('onay') ? 'status-onaylı' : 'status-beklemede';

            // Kalite belgelerini topla
            const belgeler = [];
            if (result.iatf) belgeler.push('IATF16949' + (result.certExpiryDates?.iatf ? ` (${new Date(result.certExpiryDates.iatf).toLocaleDateString('tr-TR')})` : ''));
            if (result.iso9001) belgeler.push('ISO 9001' + (result.certExpiryDates?.iso9001 ? ` (${new Date(result.certExpiryDates.iso9001).toLocaleDateString('tr-TR')})` : ''));
            if (result.iso14001) belgeler.push('ISO 14001' + (result.certExpiryDates?.iso14001 ? ` (${new Date(result.certExpiryDates.iso14001).toLocaleDateString('tr-TR')})` : ''));
            if (result.iso45001) belgeler.push('ISO 45001' + (result.certExpiryDates?.iso45001 ? ` (${new Date(result.certExpiryDates.iso45001).toLocaleDateString('tr-TR')})` : ''));
            const belgeText = belgeler.length > 0 ? belgeler.join(', ') : '-';
            
            // Tedarikçi sınıfına göre durum rengi
            let statusBadgeClass = statusClass;
            if (result.tedarikcisınıfı === 'D') {
                statusBadgeClass = 'status-class-d'; // Kırmızı
            } else if (result.tedarikcisınıfı === 'C') {
                statusBadgeClass = 'status-class-c'; // Sarı
            }

            const infoExists = hasSupplierInfo(result.name);

            const rowKey = result.mapKey || result.name;
            const safeRowKey = String(rowKey || '').replace(/'/g, "\\'");

            return `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" 
                               class="row-select" 
                               data-row-key="${rowKey}"
                               ${selectedRows.has(rowKey) ? 'checked' : ''}
                               onchange="toggleRowSelection('${safeRowKey}', this.checked)">
                    </td>
                    <td class="text-center">${index + 1}</td>
                    <td>
                        <select style="padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 0.85em; cursor: pointer; border: none;" 
                                class="status-dropdown ${statusBadgeClass}"
                                data-supplier="${result.name}"
                                onchange="updateDurum(this.dataset.supplier, this.value)">
                            <option value="ONAYLI" ${(result.status || 'ONAYLI').toUpperCase().includes('ONAY') && !(result.status || '').toUpperCase().includes('MÜŞTERİ') ? 'selected' : ''}>ONAYLI</option>
                            <option value="ONAYSIZ" ${(result.status || '').toUpperCase().includes('ONAYSIZ') || (result.status || '').toUpperCase().includes('BEKLEM') ? 'selected' : ''}>ONAYSIZ</option>
                            <option value="MÜŞTERİ" ${(result.status || '').toUpperCase().includes('MÜŞTERİ') ? 'selected' : ''}>MÜŞTERİ</option>
                        </select>
                    </td>
                    <td class="supplier-name" style="cursor: pointer; text-decoration: underline; color: #1e3c72; font-weight: 500;" 
                        onclick="openPerformanceDialog('${result.name.replace(/'/g, "\\'")}')"
                        title="Performans verisini görmek için tıklayın">${result.name}
                        <button style="margin-left: 6px; padding: 2px 6px; font-size: 0.75em; cursor: pointer; border: 1px solid #1e3c72; border-radius: 4px; background: white; color: #1e3c72;" 
                                onclick="event.stopPropagation(); openPerformanceCharts('${safeRowKey.replace(/"/g, '&quot;')}')" 
                                title="Aylık grafikler">📊</button>
                    </td>
                    <td class="text-center" style="${isMusteri ? 'opacity: 0.3; background: #f5f5f5;' : ''}">
                        <div style="position: relative; width: 180px;">
                            <button type="button" 
                                    id="lokasyonBtn_${index}"
                                    onclick="${isMusteri ? '' : `toggleLokasyonDropdown(${index})`}"
                                    style="width: 100%; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: ${isMusteri ? 'not-allowed' : 'pointer'}; font-size: 0.8em; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: normal; min-height: 28px; line-height: 1.3;"
                                    ${isMusteri ? 'disabled' : ''}>
                                ${Array.isArray(result.lokasyon) && result.lokasyon.length > 0 ? result.lokasyon.join(', ') : '📍 Lokasyon'}
                            </button>
                            <div id="lokasyonDropdown_${index}" 
                                 style="display: none; position: absolute; top: 100%; left: 0; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 8px; width: 180px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); ${isMusteri ? 'pointer-events: none; opacity: 0.5;' : ''}">
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="__TUMU__" onchange="handleLokasyonCheckbox('${result.name}', ${index}, '__TUMU__', this.checked)" ${isMusteri ? 'disabled' : ''}> <strong>✓ Tümü</strong>
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="__HICBIRI__" onchange="handleLokasyonCheckbox('${result.name}', ${index}, '__HICBIRI__', this.checked)" ${isMusteri ? 'disabled' : ''}> <strong>✗ Hiçbiri</strong>
                                </label>
                                <hr style="margin: 5px 0; border: none; border-top: 1px solid #ddd;">
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Çerkezköy" ${(result.lokasyon || []).includes('Çerkezköy') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Çerkezköy', this.checked)" ${isMusteri ? 'disabled' : ''}> Çerkezköy
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Veliköy" ${(result.lokasyon || []).includes('Veliköy') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Veliköy', this.checked)" ${isMusteri ? 'disabled' : ''}> Veliköy
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Ankara" ${(result.lokasyon || []).includes('Ankara') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Ankara', this.checked)" ${isMusteri ? 'disabled' : ''}> Ankara
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Bursa" ${(result.lokasyon || []).includes('Bursa') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Bursa', this.checked)" ${isMusteri ? 'disabled' : ''}> Bursa
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Adana" ${(result.lokasyon || []).includes('Adana') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Adana', this.checked)" ${isMusteri ? 'disabled' : ''}> Adana
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Eskişehir" ${(result.lokasyon || []).includes('Eskişehir') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Eskişehir', this.checked)" ${isMusteri ? 'disabled' : ''}> Eskişehir
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Ultech1" ${(result.lokasyon || []).includes('Ultech1') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Ultech1', this.checked)" ${isMusteri ? 'disabled' : ''}> Ultech1
                                </label>
                                <label style="display: block; margin: 4px 0; cursor: pointer; font-size: 0.85em; text-align: left;">
                                    <input type="checkbox" value="Ultech2" ${(result.lokasyon || []).includes('Ultech2') ? 'checked' : ''} onchange="handleLokasyonCheckbox('${result.name}', ${index}, 'Ultech2', this.checked)" ${isMusteri ? 'disabled' : ''}> Ultech2
                                </label>
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <button style="padding: 5px 10px; font-size: 0.75em; cursor: pointer; border: 1px solid #2196F3; border-radius: 4px; background: white; color: #2196F3;" 
                                onclick="openDocumentModal('${result.name.replace(/'/g, "\\'")}')" 
                                title="Dokümanları yönet">📄 Doküman</button>
                    </td>
                    <td class="text-center">
                        <button style="padding: 5px 10px; font-size: 0.75em; cursor: pointer; border: 1px solid ${infoExists ? '#4CAF50' : '#9e9e9e'}; border-radius: 4px; background: ${infoExists ? '#e8f5e9' : 'white'}; color: ${infoExists ? '#2e7d32' : '#616161'};" 
                                onclick="openSupplierInfoModal('${result.name.replace(/'/g, "\\'")}')" 
                                title="Tedarikçi bilgilerini düzenle">🧾 Bilgi</button>
                    </td>
                    <td class="text-right">
                        <span contenteditable="true" 
                              style="outline: none; cursor: text;" 
                              data-supplier="${result.name}"
                              data-original="${result.totalSevk}"
                              onkeydown="if(event.key==='Enter'){event.preventDefault();const v=this.textContent.replace(/\\./g,'').replace(/,/g,'');if(v!=this.dataset.original){updateTotalSevk(this.dataset.supplier,this.textContent);this.dataset.original=v;}this.blur();return false;}"
                              onfocus="this.style.background='#fffde7';this.dataset.original=this.textContent.replace(/\\./g,'').replace(/,/g,'');"
                              onblur="this.style.background='';const v=this.textContent.replace(/\\./g,'').replace(/,/g,'');if(v!=this.dataset.original&&v!==''){updateTotalSevk(this.dataset.supplier,this.textContent);this.dataset.original=v;}">${result.totalSevk.toLocaleString('tr-TR')}</span>
                    </td>
                    <td class="text-right">${result.totalIade.toLocaleString('tr-TR')}</td>
                    <td class="text-right">
                        <input type="number" 
                               class="ppm-target-input" 
                               value="${result.ppmTarget || 1000}" 
                               tabindex="1000"
                               onchange="updatePPMTarget('${result.name}', this.value)"
                               onfocus="this.style.background='#e3f2fd';"
                               onblur="this.style.background='';"
                               style="width: 80px; padding: 5px; text-align: right; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td class="text-right ${ppmClass}">${result.ppm.toFixed(2).toLocaleString('tr-TR')}</td>
                    <td class="text-right">${(result.ppmPuan * 100).toFixed(0)}%</td>
                    <td class="text-right">
                        <input type="number" 
                               class="hata-hedef-input" 
                               value="${result.hataHedefi || 2}" 
                               onchange="updateHataHedefi('${result.name}', this.value)"
                               style="width: 80px; padding: 5px; text-align: right; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td class="text-right">
                        <span contenteditable="true" 
                              style="outline: none; cursor: text;" 
                              data-supplier="${result.name}"
                              data-original="${result.totalHata}"
                              onkeydown="if(event.key==='Enter'){event.preventDefault();const v=this.textContent.replace(/\\./g,'').replace(/,/g,'');if(v!=this.dataset.original){updateTotalHata(this.dataset.supplier,this.textContent);this.dataset.original=v;}this.blur();return false;}"
                              onfocus="this.style.background='#fffde7';this.dataset.original=this.textContent.replace(/\\./g,'').replace(/,/g,'');"
                              onblur="this.style.background=''">${result.totalHata.toLocaleString('tr-TR')}</span>
                    </td>
                    <td class="text-right">
                        <div style="display: inline-flex; align-items: center; gap: 2px;">
                            <input type="number" 
                                   value="${(result.hataPuan * 100).toFixed(0)}" 
                                   min="0" max="100" step="1"
                                   onchange="updateDefectScorePuan('${result.name}', this.value)"
                                   style="width: 50px; padding: 5px; text-align: right; border: none; border-radius: 4px; background: transparent; font-size: 0.95em;">
                            <span style="font-size: 0.95em;">%</span>
                        </div>
                    </td>
                    <td class="text-center" style="position: relative; ${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">
                        <div style="position: relative; display: inline-block; min-width: 120px;">
                            <div onclick="${isMusteri ? '' : `toggleKaliteBelgeDropdown(${index})`}" 
                                 style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; cursor: ${isMusteri ? 'not-allowed' : 'pointer'}; background: white; text-align: left; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center;">
                                <span id="kaliteBelgeDisplay_${index}">${(() => {
                                    const belgeler = [];
                                    qualityCertTypes.forEach(cert => {
                                        if (result[cert.key]) {
                                            const shortLabel = cert.label.replace(/\s/g, '');
                                            const dateStr = result.certExpiryDates?.[cert.key] ? ` (${new Date(result.certExpiryDates[cert.key]).toLocaleDateString('tr-TR')})` : '';
                                            belgeler.push(shortLabel + dateStr);
                                        }
                                    });
                                    return belgeler.length > 0 ? belgeler.join(', ') : 'Seçiniz';
                                })()}</span>
                                <span style="margin-left: 8px;">▼</span>
                            </div>
                            <div id="kaliteBelgeDropdown_${index}" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px; margin-top: 4px;">
                                <div style="padding: 8px;">
                                    ${qualityCertTypes.map(cert => `
                                        <label style="display: flex; align-items: center; padding: 6px; cursor: pointer; white-space: nowrap;" onclick="event.stopPropagation();">
                                            <input type="checkbox" ${result[cert.key] ? 'checked' : ''}
                                                   onchange="handleKaliteBelgeCheckbox('${result.name}', ${index}, '${cert.key}', this.checked)"
                                                   style="margin-right: 8px;">
                                            <span style="flex: 1; ${cert.custom ? 'color: #673ab7; font-weight: 600;' : ''}">${cert.label}</span>
                                            ${result.certExpiryDates?.[cert.key] ? `<span style="font-size: 0.75em; color: #666; margin-left: 5px;">${new Date(result.certExpiryDates[cert.key]).toLocaleDateString('tr-TR')}</span>` : ''}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-right" style="${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">
                        <div style="display: inline-flex; align-items: center; gap: 2px;">
                            <span style="font-weight: 600; color: #1e3c72; min-width: 50px; text-align: right;">${(result.kalitePuan || 0).toFixed(0)}</span>
                            <span>%</span>
                        </div>
                    </td>
                    <td class="text-right" style="${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">
                        <div style="display: inline-flex; align-items: center; gap: 2px;">
                            <input type="number" 
                                   value="${(result.vdaPuan || 0).toFixed(0)}" 
                                   min="0" max="100" step="1"
                                   onchange="updateVDAPuan('${result.name}', this.value)"
                                   style="width: 50px; padding: 5px; text-align: right; border: 1px solid #ddd; border-radius: 4px;"
                                   ${isMusteri ? 'disabled' : ''}>
                            <span>%</span>
                        </div>
                    </td>
                    <td class="text-right">
                        <input type="number" 
                               value="${result.talepEdilen8D}" 
                               onchange="update8D('${result.name}', 'talep', this.value)"
                               style="width: 60px; padding: 5px; text-align: right; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td class="text-right">
                        <input type="number" 
                               value="${result.cevaplanan8D}" 
                               onchange="update8D('${result.name}', 'cevap', this.value)"
                               style="width: 60px; padding: 5px; text-align: right; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td class="text-right">${(result.talepEdilen8D === 0 ? 100 : result.donusOrani8D).toFixed(0)}%</td>
                    <td class="text-right" style="${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">
                        <div style="display: inline-flex; align-items: center; gap: 2px;">
                            <input type="number" 
                                   value="${(result.terminPuan || 100).toFixed(0)}" 
                                   min="0" max="100" step="1"
                                   onchange="updateTerminPuan('${result.name}', this.value)"
                                   style="width: 50px; padding: 5px; text-align: right; border: none; border-radius: 4px; background: transparent; font-size: 0.95em;"
                                   ${isMusteri ? 'disabled' : ''}>
                            <span style="font-size: 0.95em;">%</span>
                        </div>
                    </td>
                    <td class="text-right" style="${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">
                        <div style="display: inline-flex; align-items: center; gap: 2px;">
                            <input type="number" 
                                   value="${(result.tamamlanmaPuan || 100).toFixed(0)}" 
                                   min="0" max="100" step="1"
                                   onchange="updateTamamlanmaPuan('${result.name}', this.value)"
                                   style="width: 50px; padding: 5px; text-align: right; border: none; border-radius: 4px; background: transparent; font-size: 0.95em;"
                                   ${isMusteri ? 'disabled' : ''}>
                            <span style="font-size: 0.95em;">%</span>
                        </div>
                    </td>
                    <td class="text-right" style="font-weight: bold; ${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">${(result.tedarikcipuani * 100).toFixed(0)}%</td>
                    <td class="text-center" style="${isMusteri ? 'opacity: 0.3; pointer-events: none; background: #f5f5f5;' : ''}">
                        <span class="supplier-class class-${result.tedarikcisınıfı.toLowerCase()}">${result.tedarikcisınıfı}</span>
                    </td>
                </tr>
            `;
        }

        function sortTable(column) {
            // Scroll pozisyonunu ve yatay kaydırmayı kaydet
            const scrollBeforeRender = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            // Eğer aynı kolona tıklanmışsa yönü değiştir, değilse artan sıralama yap
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Şu anki veriyi sırala
            const dataToSort = lastFilteredResults.length > 0 ? lastFilteredResults : allResults;
            
            dataToSort.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Özel alanlar için değer çıkarma
                if (column === 'status') {
                    aVal = a.onaylı ? 'onaylı' : 'onaysız';
                    bVal = b.onaylı ? 'onaylı' : 'onaysız';
                } else if (column === 'name') {
                    aVal = a.name || '';
                    bVal = b.name || '';
                } else if (column === 'totalSevk') {
                    aVal = parseFloat(a.totalSevk) || 0;
                    bVal = parseFloat(b.totalSevk) || 0;
                } else if (column === 'totalIade') {
                    aVal = parseFloat(a.totalIade) || 0;
                    bVal = parseFloat(b.totalIade) || 0;
                } else if (column === 'ppmTarget') {
                    aVal = parseFloat(a.ppmTarget) || 0;
                    bVal = parseFloat(b.ppmTarget) || 0;
                } else if (column === 'ppm') {
                    aVal = parseFloat(a.ppm) || 0;
                    bVal = parseFloat(b.ppm) || 0;
                } else if (column === 'ppmPuan') {
                    aVal = parseFloat(a.ppmPuan) || 0;
                    bVal = parseFloat(b.ppmPuan) || 0;
                } else if (column === 'hataHedefi') {
                    aVal = parseFloat(a.hataHedefi) || 0;
                    bVal = parseFloat(b.hataHedefi) || 0;
                } else if (column === 'totalHata') {
                    aVal = parseFloat(a.totalHata) || 0;
                    bVal = parseFloat(b.totalHata) || 0;
                } else if (column === 'hataPuan') {
                    aVal = parseFloat(a.hataPuan) || 0;
                    bVal = parseFloat(b.hataPuan) || 0;
                } else if (column === 'kalitePuan') {
                    aVal = parseFloat(a.kalitePuan) || 0;
                    bVal = parseFloat(b.kalitePuan) || 0;
                } else if (column === 'vdaPuan') {
                    aVal = parseFloat(a.vdaPuan) || 0;
                    bVal = parseFloat(b.vdaPuan) || 0;
                } else if (column === 'talepEdilen8D') {
                    aVal = parseFloat(a.talepEdilen8D) || 0;
                    bVal = parseFloat(b.talepEdilen8D) || 0;
                } else if (column === 'cevaplanan8D') {
                    aVal = parseFloat(a.cevaplanan8D) || 0;
                    bVal = parseFloat(b.cevaplanan8D) || 0;
                } else if (column === 'donusOrani8D') {
                    aVal = parseFloat(a.donusOrani8D) || 0;
                    bVal = parseFloat(b.donusOrani8D) || 0;
                } else if (column === 'terminPuan') {
                    aVal = parseFloat(a.terminPuan) || 100;
                    bVal = parseFloat(b.terminPuan) || 100;
                } else if (column === 'tamamlanmaPuan') {
                    aVal = parseFloat(a.tamamlanmaPuan) || 100;
                    bVal = parseFloat(b.tamamlanmaPuan) || 100;
                } else if (column === 'tedarikcipuani') {
                    aVal = parseFloat(a.tedarikcipuani) || 0;
                    bVal = parseFloat(b.tedarikcipuani) || 0;
                } else if (column === 'tedarikcisınıfı') {
                    aVal = a.tedarikcisınıfı || '';
                    bVal = b.tedarikcisınıfı || '';
                } else if (column === 'lokasyon') {
                    aVal = a.lokasyon || '';
                    bVal = b.lokasyon || '';
                }

                // String karşılaştırması
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    const comparison = aVal.localeCompare(bVal, 'tr', { sensitivity: 'base' });
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                }

                // Sayısal karşılaştırma
                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });

            // Tabloyu yeniden render et
            if (lastFilteredResults.length > 0) {
                const onaylilar = lastFilteredResults.filter(r => r.onaylı);
                const onaysizlar = lastFilteredResults.filter(r => !r.onaylı && !r.musteri);
                const musteriler = lastFilteredResults.filter(r => r.musteri);
                renderTableWithSeparator(onaylilar, onaysizlar, musteriler);
            } else {
                const onaylilar = allResults.filter(r => r.onaylı);
                const onaysizlar = allResults.filter(r => !r.onaylı && !r.musteri);
                const musteriler = allResults.filter(r => r.musteri);
                renderTableWithSeparator(onaylilar, onaysizlar, musteriler);
            }

            // Scroll pozisyonunu ANINDA geri yükle
            window.scrollTo(0, scrollBeforeRender);
            const newTableWrapper = document.querySelector('.table-wrapper');
            if (newTableWrapper) {
                newTableWrapper.scrollLeft = horizontalScrollLeft;
            }
        }

        function updateSortIcons(activeColumn) {
            // Tüm sıralama ikonlarını varsayılan hale getir
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = ' ⬍';
                icon.style.opacity = '0.3';
            });

            // Aktif kolona ikon ekle
            const headers = document.querySelectorAll('th.sortable');
            headers.forEach(th => {
                const onclick = th.getAttribute('onclick');
                if (onclick && onclick.includes(`'${activeColumn}'`)) {
                    const icon = th.querySelector('.sort-icon');
                    if (icon) {
                        icon.textContent = currentSortDirection === 'asc' ? ' ▲' : ' ▼';
                        icon.style.opacity = '1';
                    }
                }
            });
        }

        function renderTable(results) {
            if (results.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="suppliers-table-container">
                        <div class="no-data">Arama kriterine uygun tedarikçi bulunamadı</div>
                    </div>
                `;
                return;
            }

            const container = document.getElementById('tableContainer');
            const scrollBeforeRender = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;

            container.innerHTML = `
                <div class="suppliers-table-container">
                    <div class="table-wrapper" style="overflow-x: auto !important; width: 100%; display: block;">
                        <table id="suppliersTable" style="width: 3200px; display: table;">
                            <thead>
                                <tr>
                                    <th class="text-center"><input type="checkbox" id="rowSelectAll" onchange="toggleSelectAllRows(this)"></th>
                                    <th>#</th>
                                    <th class="sortable" onclick="sortTable('status')">Durum <span class="sort-icon"></span></th>
                                    <th class="sortable" onclick="sortTable('name')">Tedarikçi <span class="sort-icon"></span></th>
                                    <th class="text-center sortable" onclick="sortTable('lokasyon')">Lokasyon <span class="sort-icon"></span></th>
                                    <th class="text-center">Dokümanlar</th>
                                    <th class="text-center">Tedarikçi Bilgileri</th>
                                    <th class="text-right sortable" onclick="sortTable('totalSevk')">Toplam Sevkiyat <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('totalIade')">Toplam İade <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppmTarget')">PPM Hedefi <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppm')">PPM <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppmPuan')">PPM Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('hataHedefi')">Hata Hedefi <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('totalHata')">Toplam Hata <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('hataPuan')">Hata Puanı <span class="sort-icon"></span></th>
                                    <th class="text-center">Kalite Belgeleri</th>
                                    <th class="text-right sortable" onclick="sortTable('kalitePuan')">Kalite Belge Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('vdaPuan')">VDA/Denetim Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('talepEdilen8D')">Talep Edilen 8D <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('cevaplanan8D')">Cevaplanan 8D <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('donusOrani8D')">8D Dönüş Oranı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('terminPuan')">Termin Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('tamamlanmaPuan')">Tamamlanma Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('tedarikcipuani')">Tedarikçi Puanı <span class="sort-icon"></span></th>
                                    <th class="text-center sortable" onclick="sortTable('tedarikcisınıfı')">Tedarikçi Sınıfı <span class="sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            `;

            const tbody = container.querySelector('#suppliersTable tbody');
            const token = ++activeRenderToken;

            renderTableRowsChunked(results, tbody, 0, token, () => {
                updateRowSelectAllCheckbox();
                // Sıralama ikonlarını güncelle
                if (currentSortColumn) {
                    updateSortIcons(currentSortColumn);
                }
                requestAnimationFrame(() => {
                    window.scrollTo(0, scrollBeforeRender);
                    const newTableWrapper = document.querySelector('.table-wrapper');
                    if (newTableWrapper) {
                        newTableWrapper.scrollLeft = horizontalScrollLeft;
                    }
                    setupNoJumpScrollGuard();
                    setupScrollStabilityGuard();
                });
            });
        }

        function renderTable_OLD(results) {
            if (results.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="suppliers-table-container">
                        <div class="no-data">Arama kriterine uygun tedarikçi bulunamadı</div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="suppliers-table-container">
                    <div class="table-wrapper">
                        <table id="suppliersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th class="sortable" onclick="sortTable('status')">Durum <span class="sort-icon"></span></th>
                                    <th class="sortable" onclick="sortTable('name')">Tedarikçi <span class="sort-icon"></span></th>
                                    <th class="text-center sortable" onclick="sortTable('lokasyon')">Lokasyon <span class="sort-icon"></span></th>
                                    <th class="text-center">Dokümanlar</th>
                                    <th class="text-center">Tedarikçi Bilgileri</th>
                                    <th class="text-right sortable" onclick="sortTable('totalSevk')">Toplam Sevkiyat <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('totalIade')">Toplam İade <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppmTarget')">PPM Hedefi <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppm')">PPM <span class="sort-icon"></span></th>
                                    <th class="text-right sortable" onclick="sortTable('ppmPuan')">PPM Puanı <span class="sort-icon"></span></th>
                                    <th class="text-right">Hata Hedefi</th>
                                    <th class="text-right">Toplam Hata</th>
                                    <th class="text-right">Hata Puanı</th>
                                    <th class="text-center">Kalite Belgeleri</th>
                                    <th class="text-right">Kalite Belge Puanı</th>
                                    <th class="text-right">VDA/Denetim Puanı</th>
                                    <th class="text-right">Talep Edilen 8D</th>
                                    <th class="text-right">Cevaplanan 8D</th>
                                    <th class="text-right">8D Dönüş Oranı</th>
                                    <th class="text-right">Termin Puanı</th>
                                    <th class="text-right">Tamamlanma Puanı</th>
                                    <th class="text-right">Tedarikçi Puanı</th>
                                    <th class="text-center">Tedarikçi Sınıfı</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            results.forEach((result, index) => {
                // PPM hedefine göre renklendirme
                let ppmClass = 'ppm-low';
                if (result.ppm > result.ppmTarget * 2) ppmClass = 'ppm-high';
                else if (result.ppm > result.ppmTarget) ppmClass = 'ppm-medium';

                const statusClass = result.status && result.status.toLowerCase().includes('onay') ? 'status-onaylı' : 'status-beklemede';

                // Kalite belgelerini topla
                const belgeler = [];
            if (result.iatf) belgeler.push('IATF16949' + (result.certExpiryDates?.iatf ? ` (${new Date(result.certExpiryDates.iatf).toLocaleDateString('tr-TR')})` : ''));
            if (result.iso9001) belgeler.push('ISO 9001' + (result.certExpiryDates?.iso9001 ? ` (${new Date(result.certExpiryDates.iso9001).toLocaleDateString('tr-TR')})` : ''));
            if (result.iso14001) belgeler.push('ISO 14001' + (result.certExpiryDates?.iso14001 ? ` (${new Date(result.certExpiryDates.iso14001).toLocaleDateString('tr-TR')})` : ''));
            if (result.iso45001) belgeler.push('ISO 45001' + (result.certExpiryDates?.iso45001 ? ` (${new Date(result.certExpiryDates.iso45001).toLocaleDateString('tr-TR')})` : ''));
                // Tedarikçi sınıfına göre durum rengi
                let statusBadgeClass = statusClass;
                if (result.tedarikcisınıfı === 'D') {
                    statusBadgeClass = 'status-class-d'; // Kırmızı
                } else if (result.tedarikcisınıfı === 'C') {
                    statusBadgeClass = 'status-class-c'; // Sarı
                }

                html += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>
                            <select style="padding: 5px 10px; border-radius: 15px; font-weight: 600; font-size: 0.85em; cursor: pointer; border: none;" 
                                    class="status-dropdown ${statusBadgeClass}"
                                    data-supplier="${result.name}"
                                    onchange="updateDurum(this.dataset.supplier, this.value)">
                                <option value="ONAYLI" ${(result.status || 'ONAYLI').toUpperCase().includes('ONAY') ? 'selected' : ''}>ONAYLI</option>
                                <option value="ONAYSIZ" ${(result.status || '').toUpperCase().includes('ONAYSIZ') || (result.status || '').toUpperCase().includes('BEKLEM') ? 'selected' : ''}>ONAYSIZ</option>
                            </select>
                        </td>
                        <td class="supplier-name" style="cursor: pointer; text-decoration: underline; color: #1e3c72; font-weight: 500;" 
                            onclick="openPerformanceDialog('${result.name}')" 
                            title="Performans verisini görmek için tıklayın">${result.name}</td>
                        <td class="text-center">
                            <select multiple 
                                    id="lokasyon_${index}"
                                    style="width: 150px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85em;"
                                    data-supplier="${result.name}"
                                    onchange="handleLokasyonChange(this.dataset.supplier, this, ${index})">
                                <option value="__TUMU__" style="font-weight: bold; background: #e3f2fd;">✓ Tümü</option>
                                <option value="__HICBIRI__" style="font-weight: bold; background: #ffebee;">✗ Hiçbiri</option>
                                <option disabled>──────────</option>
                                <option value="Çerkezköy" ${(result.lokasyon || []).includes('Çerkezköy') ? 'selected' : ''}>Çerkezköy</option>
                                <option value="Veliköy" ${(result.lokasyon || []).includes('Veliköy') ? 'selected' : ''}>Veliköy</option>
                                <option value="Ankara" ${(result.lokasyon || []).includes('Ankara') ? 'selected' : ''}>Ankara</option>
                                <option value="Bursa" ${(result.lokasyon || []).includes('Bursa') ? 'selected' : ''}>Bursa</option>
                                <option value="Adana" ${(result.lokasyon || []).includes('Adana') ? 'selected' : ''}>Adana</option>
                                <option value="Eskişehir" ${(result.lokasyon || []).includes('Eskişehir') ? 'selected' : ''}>Eskişehir</option>
                                <option value="Ultech1" ${(result.lokasyon || []).includes('Ultech1') ? 'selected' : ''}>Ultech1</option>
                                <option value="Ultech2" ${(result.lokasyon || []).includes('Ultech2') ? 'selected' : ''}>Ultech2</option>
                                <option value="Müşteri" ${(result.lokasyon || []).includes('Müşteri') ? 'selected' : ''}>Müşteri</option>
                            </select>
                        </td>
                        <td class="text-right">
                            <span contenteditable="true" 
                                  style="outline: none; cursor: text;" 
                                  onblur="updateTotalSevk('${result.name}', this.textContent)"
                                  onkeypress="if(event.key==='Enter'){this.blur();return false;}">${result.totalSevk.toLocaleString('tr-TR')}</span>
                        </td>
                        <td class="text-right">${result.totalIade.toLocaleString('tr-TR')}</td>
                        <td class="text-right">
                            <input type="number" 
                                   class="ppm-target-input" 
                                   value="${result.ppmTarget}" 
                                   onchange="updatePPMTarget('${result.name}', this.value)"
                                   min="0"
                                   step="100">
                        </td>
                        <td class="text-right"><span class="ppm-value ${ppmClass}">${result.ppm.toFixed(2)}</span></td>
                        <td class="text-right"><span style="font-weight: 600; color: #1e3c72;">${(result.ppmPuan * 100).toFixed(2)}%</span></td>
                        <td class="text-right">
                            <input type="number" 
                                   class="ppm-target-input" 
                                   value="${result.hataHedefi}" 
                                   onchange="updateHataHedefi('${result.name}', this.value)"
                                   min="0"
                                   step="1">
                        </td>
                        <td class="text-right">
                            <span contenteditable="true" 
                                  style="outline: none; cursor: text;" 
                                  onblur="updateTotalHata('${result.name}', this.textContent)"
                                  onkeypress="if(event.key==='Enter'){this.blur();return false;}">${result.totalHata.toLocaleString('tr-TR')}</span>
                        </td>
                        <td class="text-right"><span style="font-weight: 600;">${(result.hataPuan * 100).toFixed(2)}</span></td>
                        <td class="text-center">
                            <div style="display: flex; flex-direction: column; gap: 4px; justify-content: flex-start; align-items: flex-start; padding-left: 8px;">
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 0.85em;">
                                    <input type="checkbox" ${result.iso9001 ? 'checked' : ''} 
                                           onchange="updateKaliteBelge('${result.name}', 'iso9001', this.checked)">
                                    ISO 9001
                                </label>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 0.85em;">
                                    <input type="checkbox" ${result.iatf ? 'checked' : ''} 
                                           onchange="updateKaliteBelge('${result.name}', 'iatf', this.checked)">
                                    IATF16949
                                </label>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 0.85em;">
                                    <input type="checkbox" ${result.iso14001 ? 'checked' : ''} 
                                           onchange="updateKaliteBelge('${result.name}', 'iso14001', this.checked)">
                                    ISO 14001
                                </label>
                                <label style="display: flex; align-items: center; gap: 3px; font-size: 0.85em;">
                                    <input type="checkbox" ${result.iso45001 ? 'checked' : ''} 
                                           onchange="updateKaliteBelge('${result.name}', 'iso45001', this.checked)">
                                    ISO 45001
                                </label>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.9em; color: #1e3c72; font-weight: 600;">
                                ${belgeText}
                            </div>
                        </td>
                        <td class="text-right"><span style="font-weight: 600; color: #1e3c72;">${result.kalitePuan.toFixed(0)}%</span></td>
                        <td class="text-right">
                            <div style="display: inline-flex; align-items: center; gap: 3px; vertical-align: middle;">
                                <input type="number" 
                                       class="ppm-target-input" 
                                       value="${result.vdaPuan}" 
                                       onchange="updateVDAPuan('${result.name}', this.value)"
                                       min="0"
                                       max="100"
                                       step="1">
                                <span style="font-size: 0.85em; color: #666;">%</span>
                            </div>
                        </td>
                        <td class="text-right">
                            <input type="number" 
                                   class="ppm-target-input" 
                                   style="width: 80px;"
                                   value="${result.talepEdilen8D}" 
                                   onchange="update8D('${result.name}', 'talep', this.value)"
                                   min="0"
                                   step="1">
                        </td>
                        <td class="text-right">
                            <input type="number" 
                                   class="ppm-target-input" 
                                   style="width: 80px;"
                                   value="${result.cevaplanan8D}" 
                                   onchange="update8D('${result.name}', 'cevap', this.value)"
                                   min="0"
                                   step="1">
                        </td>
                        <td class="text-right"><span style="font-weight: 600; color: #1e3c72;">${(result.talepEdilen8D === 0 ? 100 : result.donusOrani8D).toFixed(0)}%</span></td>
                        <td class="text-right">
                            <div style="display: inline-flex; align-items: center; gap: 3px; vertical-align: middle;">
                                <input type="number" 
                                       class="ppm-target-input" 
                                       style="width: 80px;"
                                       value="${result.terminPuan}" 
                                       onchange="updateTerminPuan('${result.name}', this.value)"
                                       min="0"
                                       max="100"
                                       step="1">
                                <span style="font-size: 0.85em; color: #666;">%</span>
                            </div>
                        </td>
                        <td class="text-right">
                            <div style="display: inline-flex; align-items: center; gap: 3px; vertical-align: middle;">
                                <input type="number" 
                                       class="ppm-target-input" 
                                       style="width: 80px;"
                                       value="${result.tamamlanmaPuan}" 
                                       onchange="updateTamamlanmaPuan('${result.name}', this.value)"
                                       min="0"
                                       max="100"
                                       step="1">
                                <span style="font-size: 0.85em; color: #666;">%</span>
                            </div>
                        </td>
                        <td class="text-right">
                            <span style="font-weight: 700; color: #1e3c72; font-size: 1.1em;">
                                ${(result.tedarikcipuani * 100).toFixed(2)}%
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="supplier-class-badge class-${result.tedarikcisınıfı.toLowerCase()}">
                                ${result.tedarikcisınıfı}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const scrollBeforeRender = window.pageYOffset || document.documentElement.scrollTop;
            document.getElementById('tableContainer').innerHTML = html;
            updateRowSelectAllCheckbox();

            window.scrollTo(0, scrollBeforeRender);
            document.documentElement.scrollTop = scrollBeforeRender;
            document.body.scrollTop = scrollBeforeRender;
            
            requestAnimationFrame(() => {
                window.scrollTo(0, scrollBeforeRender);
                document.documentElement.scrollTop = scrollBeforeRender;
            });
            setTimeout(() => {
                window.scrollTo(0, scrollBeforeRender);
                document.documentElement.scrollTop = scrollBeforeRender;
            }, 50);

            // Tablo oluşturulduktan sonra korumaları kur
            setupNoJumpScrollGuard();
            setupScrollStabilityGuard();
        }

        // Scroll pozisyonunu koruyarak filtre uygula
        function saveScrollAndFilter() {
            filterTable();
        }

        // Tedarikçi Puanını hesaplayan yardımcı fonksiyon
        function calculateTedarikcipuani(supplier) {
            let tedarikcipuani = 0;
            
            // Kalite puanı 0-100 aralığında, 0-1 aralığına çevir
            const kalitePuanNormalized = supplier.kalitePuan / 100;
            // VDA puanı 0-100 aralığında, 0-1 aralığına çevir
            const vdaPuanNormalized = supplier.vdaPuan / 100;
            // 8D dönüş oranı 0-100 aralığında, 0-1 aralığına çevir
            const donusOrani8DNormalized = supplier.donusOrani8D / 100;
            // Termin puanı 0-100 aralığında, 0-1 aralığına çevir
            const terminPuanNormalized = supplier.terminPuan / 100;
            // Tamamlanma puanı 0-100 aralığında, 0-1 aralığına çevir
            const tamamlanmaPuanNormalized = supplier.tamamlanmaPuan / 100;
            
            if (supplier.vdaPuan > 0) {
                // VDA puanı olan tedarikçiler
                tedarikcipuani = (vdaPuanNormalized * 0.20 + 
                                 kalitePuanNormalized * 0.05 + 
                                 supplier.ppmPuan * 0.30 + 
                                 donusOrani8DNormalized * 0.05 + 
                                 terminPuanNormalized * 0.20 + 
                                 tamamlanmaPuanNormalized * 0.10 + 
                                 supplier.hataPuan * 0.10);
            } else {
                // VDA denetimi olmayan tedarikçiler
                tedarikcipuani = (kalitePuanNormalized * 0.05 + 
                                 supplier.ppmPuan * 0.40 + 
                                 donusOrani8DNormalized * 0.10 + 
                                 terminPuanNormalized * 0.20 + 
                                 tamamlanmaPuanNormalized * 0.10 + 
                                 supplier.hataPuan * 0.15);
            }
            
            return tedarikcipuani;
        }

        // Tedarikçi sınıfını hesaplayan fonksiyon
        function calculateTedarikcisınıfı(tedarikcipuani) {
            if (tedarikcipuani >= 0.9) return 'A';
            if (tedarikcipuani >= 0.8) return 'B';
            if (tedarikcipuani >= 0.6) return 'C';
            return 'D';
        }

        let classPieChartInstance = null;

        function renderClassPieChart(results) {
            const canvas = document.getElementById('classPieChart');
            if (!canvas || !window.Chart) return;

            const counts = { A: 0, B: 0, C: 0, D: 0 };
            results.forEach(r => {
                const cls = (r.tedarikcisınıfı || calculateTedarikcisınıfı(r.tedarikcipuani || 0) || 'D').toUpperCase();
                if (counts[cls] !== undefined) counts[cls] += 1;
            });

            const data = [counts.A, counts.B, counts.C, counts.D];
            const labels = ['A', 'B', 'C', 'D'];

            if (classPieChartInstance) {
                classPieChartInstance.destroy();
            }

            classPieChartInstance = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#4caf50', '#ffc107', '#ff9800', '#f44336'],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: 2,
                    onClick: (evt, elements) => {
                        if (!elements || elements.length === 0) return;
                        const index = elements[0].index;
                        const clickedClass = labels[index];
                        if (!clickedClass) return;
                        toggleClassFilter(clickedClass);
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const total = data.reduce((s, v) => s + v, 0) || 1;
                                    const value = ctx.parsed || 0;
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return `${ctx.label}: ${value} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function toggleClassFilter(classLetter) {
            if (!classLetter) return;
            const newValue = classLetter.toUpperCase();
            selectedClassFilter = (selectedClassFilter === newValue) ? null : newValue;
            filterTable();
        }

        function clearClassFilter() {
            selectedClassFilter = null;
            filterTable();
        }

        function handleDurumChange() {
            // Artık kullanılmıyor - çoklu seçim için updateDurumFilter kullanılıyor
            filterTable();
        }
        
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            // Seçili lokasyonları al
            const locationCheckboxes = document.querySelectorAll('#locationOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const selectedLocations = Array.from(locationCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            const selectedLocationsSet = new Set(selectedLocations);
            const allLocationsSelected = selectedLocations.length === 0 || selectedLocations.length === locationCheckboxes.length;

            // Seçili durumları al
            const durumCheckboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const selectedDurumlar = Array.from(durumCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            const allDurumSelected = selectedDurumlar.length === 0 || selectedDurumlar.length === durumCheckboxes.length;

            if (DEBUG_FILTER_LOGS) {
                console.log('Seçili lokasyonlar:', selectedLocations);
                console.log('Seçili durumlar:', selectedDurumlar);
            }

            const filtered = allResults.filter(r => {
                // İsim filtresi
                const nameMatch = r.name.toLowerCase().includes(searchTerm);
                // Tedarikçi seçim filtresi (mapKey ile uyuşan seçili değer)
                const supplierKey = r.mapKey || r.name;
                const supplierMatch = selectedSuppliers.has(supplierKey);

                // Lokasyon filtresi
                let locationMatch = true;
                if (!allLocationsSelected) {
                    const supplierLocations = r.lokasyon || [];
                    const locArray = Array.isArray(supplierLocations) ? supplierLocations :
                                     (supplierLocations ? [supplierLocations] : []);
                    locationMatch = locArray.length > 0 && locArray.some(loc => selectedLocationsSet.has(loc));
                }

                // Durum filtresi - çoklu seçime göre
                let statusMatch = true;
                const status = (r.status || 'ONAYLI').toUpperCase();

                if (!allDurumSelected) {
                    statusMatch = selectedDurumlar.some(durum => {
                        if (durum === 'ONAYLI') {
                            return status === 'ONAYLI' || (status.includes('ONAY') && !status.includes('ONAYSIZ') && status !== 'MÜŞTERİ');
                        } else if (durum === 'ONAYSIZ') {
                            return status === 'ONAYSIZ' || status.includes('BEKLEM');
                        } else if (durum === 'MÜŞTERİ') {
                            return status === 'MÜŞTERİ';
                        }
                        return false;
                    });
                }

                // Tab filtresi - sadece 1 durum seçiliyse tab filtresini uygula
                // 2 veya daha fazla durum seçiliyse tab filtresi devre dışı (separatörlü liste gösteriliyor)
                if (selectedDurumlar.length === 1 && statusMatch) {
                    if (currentTab === 'ONAYLI') {
                        statusMatch = status === 'ONAYLI' || (status.includes('ONAY') && !status.includes('ONAYSIZ') && status !== 'MÜŞTERİ');
                    } else if (currentTab === 'ONAYSIZ') {
                        statusMatch = status === 'ONAYSIZ' || status.includes('BEKLEM');
                    } else if (currentTab === 'MÜŞTERİ') {
                        statusMatch = status === 'MÜŞTERİ';
                    }
                }
                
                return nameMatch && supplierMatch && locationMatch && statusMatch;
            });

            // Sınıf filtresi (A/B/C/D)
            const classFiltered = selectedClassFilter
                ? filtered.filter(r => {
                    const cls = (r.tedarikcisınıfı || calculateTedarikcisınıfı(r.tedarikcipuani || 0) || 'D').toUpperCase();
                    return cls === selectedClassFilter;
                })
                : filtered;

            // Birden fazla durum seçiliyse separatörlerle göster
            
            // 2 veya daha fazla durum seçiliyse separatörlerle göster
            if (selectedDurumlar.length >= 2) {
                const onaylilar = classFiltered.filter(r => {
                    const status = (r.status || 'ONAYLI').toUpperCase();
                    return status === 'ONAYLI' || (status.includes('ONAY') && !status.includes('ONAYSIZ') && status !== 'MÜŞTERİ');
                });
                const onaysizlar = classFiltered.filter(r => {
                    const status = (r.status || 'ONAYLI').toUpperCase();
                    return status === 'ONAYSIZ' || status.includes('BEKLEM');
                });
                const musteriler = classFiltered.filter(r => {
                    const status = (r.status || 'ONAYLI').toUpperCase();
                    return status === 'MÜŞTERİ';
                });

                lastFilteredResults = classFiltered;
                // Dashboard'ı tüm filtrelenmiş sonuçlara göre güncelle
                updateDashboard(classFiltered);
                // Render'a separator bilgisiyle gönder
                renderTableWithSeparator(onaylilar, onaysizlar, musteriler);
                
                // Seçili durumlara göre tabları aktif göster
                updateTabVisuals(selectedDurumlar);
            } else {
                // Tek durum seçiliyse veya hiçbiri seçili değilse normal göster
                lastFilteredResults = classFiltered;
                updateDashboard(classFiltered);
                renderTable(classFiltered);
                
                // Tek durum için tab görünümü güncelle
                updateTabVisuals(selectedDurumlar);
            }
        }
        
        function updateTabVisuals(selectedDurumlar) {
            const tabOnayli = document.getElementById('tabOnayli');
            const tabOnaysiz = document.getElementById('tabOnaysiz');
            const tabMusteri = document.getElementById('tabMusteri');
            
            // Önce tüm tabları pasif yap
            tabOnayli.style.background = '#e0e0e0';
            tabOnayli.style.color = '#666';
            tabOnaysiz.style.background = '#e0e0e0';
            tabOnaysiz.style.color = '#666';
            tabMusteri.style.background = '#e0e0e0';
            tabMusteri.style.color = '#666';
            
            // Seçili durumlara göre tabları aktif yap
            if (selectedDurumlar.includes('ONAYLI')) {
                tabOnayli.style.background = '#1e3c72';
                tabOnayli.style.color = 'white';
            }
            if (selectedDurumlar.includes('ONAYSIZ')) {
                tabOnaysiz.style.background = '#dc3545';
                tabOnaysiz.style.color = 'white';
            }
            if (selectedDurumlar.includes('MÜŞTERİ')) {
                tabMusteri.style.background = '#2196F3';
                tabMusteri.style.color = 'white';
            }
        }

        function updatePPMTarget(supplierName, newTarget) {
            // Scroll pozisyonunu kaydet
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            const target = parseFloat(newTarget) || 1000;
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier.ppmTarget = target;
                
                // PPM Puanını yeniden hesapla
                const ppm = supplier.ppm;
                let ppmPuan = 0;
                if (ppm === 0) {
                    ppmPuan = 1;
                } else if (ppm <= 0.2 * target) {
                    ppmPuan = 0.95;
                } else if (ppm <= 0.4 * target) {
                    ppmPuan = 0.9;
                } else if (ppm <= 0.6 * target) {
                    ppmPuan = 0.85;
                } else if (ppm <= 0.8 * target) {
                    ppmPuan = 0.8;
                } else if (ppm < 1.2 * target) {
                    ppmPuan = 0.6;
                } else {
                    ppmPuan = 0;
                }
                supplier.ppmPuan = ppmPuan;
                
                // Tedarikçi puanını yeniden hesapla
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                // Tabloyu yeniden render et
                renderTable(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                showAlert(`✅ ${supplierName} için PPM hedefi ${target} olarak güncellendi`, 'success');
                // Dashboard ve görünüm güncelle
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                // Scroll'u geri yükle
                requestAnimationFrame(() => {
                    window.scrollTo(0, scrollY);
                    const newTableWrapper = document.querySelector('.table-wrapper');
                    if (newTableWrapper) {
                        newTableWrapper.scrollLeft = horizontalScrollLeft;
                    }
                });
            }
        }

        function adjustMonthlyPPMs(supplier, targetTotalPPM, options = {}) {
            const skipTotalsUpdate = !!options.skipTotalsUpdate;
            // Aylık PPM dizisi yoksa oluştur
            if (!supplier.monthlyPPM || !Array.isArray(supplier.monthlyPPM)) {
                supplier.monthlyPPM = supplier.monthlySevk.map((sevk, idx) => {
                    const iade = supplier.monthlyIade[idx] || 0;
                    return sevk > 0 ? (iade / sevk) * 1000000 : 0;
                });
            }
            
            // Orijinal aylık PPM değerlerini kaydet (ilk kez için)
            if (!supplier.originalMonthlyPPM || !Array.isArray(supplier.originalMonthlyPPM)) {
                supplier.originalMonthlyPPM = [...supplier.monthlyPPM];
            }
            
            // Seçili aylardan sadece PPM > 0 olanları al (sevkiyat ve iade olan aylar)
            const selectedMonthIndices = Array.from(selectedMonths).map(m => m - 1);
            const activePPMPairs = selectedMonthIndices
                .map(idx => ({
                    index: idx,
                    ppm: supplier.monthlyPPM[idx] || 0,
                    sevk: supplier.monthlySevk[idx] || 0,
                    iade: supplier.monthlyIade[idx] || 0
                }))
                .filter(pair => pair.sevk > 0 && pair.iade > 0); // Sadece sevk ve iade olan aylar
            
            if (activePPMPairs.length === 0) {
                // Hiç PPM değeri olan ay yok, işlem yapma
                return;
            }
            
            // Aktif ayların mevcut ortalama PPM'ini hesapla
            const currentAvgPPM = activePPMPairs.reduce((sum, pair) => {
                const ppm = pair.sevk > 0 ? (pair.iade / pair.sevk) * 1000000 : 0;
                return sum + ppm;
            }, 0) / activePPMPairs.length;
            
            // PPM farkını hesapla
            const ppmDifference = targetTotalPPM - currentAvgPPM;
            
            if (Math.abs(ppmDifference) < 0.1) {
                // Değişiklik çok küçükse hiçbir şey yapma
                return;
            }
            
            // Toplam sevkiyat değişimini hesapla
            const totalCurrentSevk = supplier.totalSevk;
            const totalIade = supplier.totalIade;
            
            if (ppmDifference < 0) {
                // PPM DÜŞÜRME: Sevkiyat arttırmalı
                // targetTotalPPM = (totalIade / newTotalSevk) * 1000000
                // newTotalSevk = (totalIade / targetTotalPPM) * 1000000
                const newTotalSevk = totalIade > 0 ? (totalIade / targetTotalPPM) * 1000000 : totalCurrentSevk;
                const sevkIncrease = newTotalSevk - totalCurrentSevk;
                
                if (sevkIncrease <= 0) return;
                
                // Sevkiyat artışını aylar arasında orantılı dağıt
                const totalActiveSevk = activePPMPairs.reduce((sum, pair) => sum + pair.sevk, 0);
                
                for (let pair of activePPMPairs) {
                    const ratio = pair.sevk / totalActiveSevk;
                    const increase = sevkIncrease * ratio;
                    const newSevk = pair.sevk + increase;
                    
                    supplier.monthlySevk[pair.index] = Math.round(newSevk);
                    
                    // PPM'i yeniden hesapla
                    supplier.monthlyPPM[pair.index] = (pair.iade / newSevk) * 1000000;
                }
                
            } else {
                // PPM ARTIRMA: Sevkiyat azaltmalı
                // Her ayın sevkini azalt, ama minimum iade miktarına kadar (max PPM = 1,000,000)
                const newTotalSevk = totalIade > 0 ? (totalIade / targetTotalPPM) * 1000000 : totalCurrentSevk;
                const sevkDecrease = totalCurrentSevk - newTotalSevk;
                
                if (sevkDecrease <= 0) return;
                
                // Sevkiyat azaltışını aylar arasında orantılı dağıt
                const totalActiveSevk = activePPMPairs.reduce((sum, pair) => sum + pair.sevk, 0);
                
                for (let pair of activePPMPairs) {
                    const ratio = pair.sevk / totalActiveSevk;
                    const decrease = sevkDecrease * ratio;
                    let newSevk = pair.sevk - decrease;
                    
                    // Minimum sevk = iade (max PPM = 1,000,000)
                    const minSevk = pair.iade;
                    newSevk = Math.max(newSevk, minSevk);
                    
                    supplier.monthlySevk[pair.index] = Math.round(newSevk);
                    
                    // PPM'i yeniden hesapla
                    const newPPM = newSevk > 0 ? (pair.iade / newSevk) * 1000000 : 0;
                    supplier.monthlyPPM[pair.index] = Math.min(newPPM, 1000000); // Max 1,000,000 PPM
                }
            }
            
            if (!skipTotalsUpdate) {
                // Toplam sevkiyatı güncelle (tüm aylardan)
                const sumSelected = (arr) => Array.from(selectedMonths).reduce((s,m)=> s + (arr[m-1]||0), 0);
                supplier.totalSevk = sumSelected(supplier.monthlySevk) + (supplier.hasKnownSevkMonths ? 0 : (supplier.unknownSevk || 0));
                supplier.totalIade = sumSelected(supplier.monthlyIade) + (supplier.hasKnownIadeMonths ? 0 : (supplier.unknownIade || 0));
            }
        }

        function updateTotalSevk(supplierName, newValue) {
            // Scroll pozisyonunu kaydet
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            const cleaned = newValue.replace(/\./g, '').replace(/,/g, '');
            const value = parseFloat(cleaned);
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier && !Number.isNaN(value)) {
                // Eski toplam sevkiyatı al
                const oldTotalSevk = supplier.totalSevk || 0;
                
                // Yeni toplam sevkiyatı ata
                supplier.totalSevk = value;
                supplier.manualTotalSevk = true;
                
                // Eğer aylık sevk verileri varsa, orantılı olarak güncelle
                if (supplier.monthlySevk && supplier.monthlySevk.length > 0 && oldTotalSevk > 0) {
                    const ratio = value / oldTotalSevk;
                    
                    // Her ayın sevkiyatını aynı oranda güncelle
                    supplier.monthlySevk = supplier.monthlySevk.map(sevk => {
                        return sevk > 0 ? Math.round(sevk * ratio) : 0;
                    });
                    
                    // Aylık PPM değerlerini yeniden hesapla (sevk değişti, iade aynı kaldı)
                    supplier.monthlyPPM = supplier.monthlySevk.map((sevk, idx) => {
                        const iade = supplier.monthlyIade[idx] || 0;
                        return sevk > 0 ? (iade / sevk) * 1000000 : 0;
                    });
                    
                    console.log(`📊 Sevkiyat güncellendi: ${oldTotalSevk.toLocaleString()} → ${value.toLocaleString()} (Oran: ${ratio.toFixed(4)})`);
                }
                
                // Toplam PPM'i yeniden hesapla
                supplier.ppm = supplier.totalSevk > 0 ? (supplier.totalIade / supplier.totalSevk) * 1000000 : 0;
                supplier.currentPPM = supplier.ppm;
                
                console.log(`📊 Yeni PPM: ${supplier.ppm.toFixed(2)} (Sevk: ${supplier.totalSevk.toLocaleString()}, İade: ${supplier.totalIade.toLocaleString()})`);
                
                // PPM Puanını yeniden hesapla
                const ppm = supplier.ppm;
                const target = supplier.ppmTarget || 1000;
                let ppmPuan = 0;
                if (ppm === 0) {
                    ppmPuan = 1;
                } else if (ppm <= 0.2 * target) {
                    ppmPuan = 0.95;
                } else if (ppm <= 0.4 * target) {
                    ppmPuan = 0.9;
                } else if (ppm <= 0.6 * target) {
                    ppmPuan = 0.85;
                } else if (ppm <= 0.8 * target) {
                    ppmPuan = 0.8;
                } else if (ppm < 1.2 * target) {
                    ppmPuan = 0.6;
                } else {
                    ppmPuan = 0;
                }
                supplier.ppmPuan = ppmPuan;
                
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                // Hemen güncelle - setTimeout kaldırıldı
                updateSupplierCells(supplierName);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                // Scroll'u geri yükle
                requestAnimationFrame(() => {
                    window.scrollTo(0, scrollY);
                    const newTableWrapper = document.querySelector('.table-wrapper');
                    if (newTableWrapper) {
                        newTableWrapper.scrollLeft = horizontalScrollLeft;
                    }
                });
                
                // Eğer grafik modal'ı açıksa, PPM grafiklerini yeniden çiz
                const chartModal = document.getElementById('performanceChartModal');
                if (chartModal && chartModal.style.display !== 'none') {
                    const modalSupplierName = chartModal.getAttribute('data-supplier-name');
                    if (modalSupplierName === supplierName) {
                        // PPM grafiklerini yeniden çiz
                        const months = Array.from(selectedMonths).sort((a, b) => a - b);
                        const monthLabels = months.map(m => `${m}.Ay`);
                        const ppmSeries = months.map(m => supplier.monthlyPPM[m-1] || 0);
                        const ppmTarget = supplier.ppmTarget || 1000;
                        
                        // Aylık İade PPM grafiğini güncelle
                        drawBarChart('chartReturnPPM', monthLabels, ppmSeries, '#fb8c00', 'İade PPM', ppmTarget);
                        
                        // Aylık PPM Puanı grafiğini güncelle
                        const ppmPuanSeries = months.map(m => {
                            const monthlyPPM = supplier.monthlyPPM[m-1] || 0;
                            let ppmPuan = 0;
                            if (monthlyPPM === 0) {
                                ppmPuan = 100;
                            } else if (monthlyPPM <= ppmTarget / 4) {
                                ppmPuan = 100;
                            } else if (monthlyPPM <= ppmTarget / 2) {
                                ppmPuan = 90;
                            } else if (monthlyPPM <= ppmTarget) {
                                ppmPuan = 70;
                            } else if (monthlyPPM <= ppmTarget * 1.5) {
                                ppmPuan = 50;
                            } else if (monthlyPPM <= ppmTarget * 2) {
                                ppmPuan = 30;
                            } else {
                                ppmPuan = 0;
                            }
                            return ppmPuan;
                        });
                        drawBarChart('chartPPMPuan', monthLabels, ppmPuanSeries, '#42a5f5', 'PPM Puanı');
                    }
                }
            }
        }

        function updateTotalHata(supplierName, newValue) {
            // Scroll pozisyonunu kaydet
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            let value = parseFloat(newValue.replace(/\./g, '').replace(/,/g, '')) || 0;
            // Tam sayıya yuvarla
            value = Math.round(value);
            
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                const oldTotal = supplier.totalHata || 0;
                const difference = value - oldTotal;
                
                supplier.totalHata = value;
                
                // monthlyHata dizisini güncelle - seçili ayları bul
                const selectedMonthsArray = Array.from(selectedMonths).sort((a, b) => a - b);
                const monthsWithHata = selectedMonthsArray.filter(m => supplier.monthlyHata[m - 1] > 0);
                
                console.log(`📊 Toplam hata değişti: ${oldTotal} → ${value} (Fark: ${difference})`);
                
                if (difference < 0) {
                    // AZALTMA: Yüksek hatalı aylardan düşmeye başla
                    let remainingReduction = Math.abs(difference);
                    
                    // Ayları hata sayısına göre büyükten küçüğe sırala
                    const sortedMonths = selectedMonthsArray
                        .map(m => ({ month: m, value: supplier.monthlyHata[m - 1] || 0 }))
                        .filter(item => item.value > 0)
                        .sort((a, b) => b.value - a.value);
                    
                    console.log(`🔽 Azaltma stratejisi: ${remainingReduction} hata düşülecek`);
                    console.log(`Sıralı aylar:`, sortedMonths.map(m => `Ay ${m.month}=${m.value}`).join(', '));
                    
                    // En yüksekten başlayarak azalt
                    for (const item of sortedMonths) {
                        if (remainingReduction <= 0) break;
                        
                        const monthIndex = item.month - 1;
                        const currentValue = supplier.monthlyHata[monthIndex];
                        const reduction = Math.min(currentValue, remainingReduction);
                        
                        supplier.monthlyHata[monthIndex] = Math.max(0, Math.round(currentValue - reduction));
                        remainingReduction -= reduction;
                        
                        console.log(`  Ay ${item.month}: ${currentValue} → ${supplier.monthlyHata[monthIndex]} (-${reduction})`);
                    }
                } else if (difference > 0) {
                    // YÜKSELTME: Sadece hata olan aylara ekle
                    if (monthsWithHata.length > 0) {
                        // Hata olan ayların toplam hatası
                        const oldMonthlyTotal = monthsWithHata.reduce((sum, m) => sum + supplier.monthlyHata[m - 1], 0);
                        
                        console.log(`🔼 Yükseltme stratejisi: ${difference} hata sadece hatalı aylara ekleniyor`);
                        console.log(`Hatalı aylar:`, monthsWithHata.map(m => `Ay ${m}=${supplier.monthlyHata[m-1]}`).join(', '));
                        
                        if (oldMonthlyTotal > 0) {
                            // Her ayın oranını koru ve artır
                            monthsWithHata.forEach(monthNum => {
                                const monthIndex = monthNum - 1;
                                const ratio = supplier.monthlyHata[monthIndex] / oldMonthlyTotal;
                                const increase = difference * ratio;
                                const oldValue = supplier.monthlyHata[monthIndex];
                                supplier.monthlyHata[monthIndex] = Math.round(oldValue + increase);
                                console.log(`  Ay ${monthNum}: ${oldValue} → ${supplier.monthlyHata[monthIndex]} (+${increase.toFixed(2)})`);
                            });
                            
                            // Doğrula ve düzelt
                            const newMonthlyTotal = monthsWithHata.reduce((sum, m) => sum + supplier.monthlyHata[m - 1], 0);
                            if (Math.abs(newMonthlyTotal - value) > 0.5) {
                                // Yuvarlama hatası varsa son aya ekle/çıkar
                                const correction = Math.round(value - newMonthlyTotal);
                                if (correction !== 0 && monthsWithHata.length > 0) {
                                    const lastMonth = monthsWithHata[monthsWithHata.length - 1];
                                    supplier.monthlyHata[lastMonth - 1] += correction;
                                    console.log(`  ⚠️ Düzeltme: Ay ${lastMonth} += ${correction}`);
                                }
                            }
                        } else {
                            // Eşit dağıt
                            const perMonth = Math.round(difference / monthsWithHata.length);
                            monthsWithHata.forEach(monthNum => {
                                supplier.monthlyHata[monthNum - 1] = Math.round((supplier.monthlyHata[monthNum - 1] || 0) + perMonth);
                            });
                        }
                    } else if (selectedMonthsArray.length > 0) {
                        // Hiç hata yoksa tüm seçili aylara eşit dağıt
                        const perMonth = Math.round(difference / selectedMonthsArray.length);
                        console.log(`🔼 Hiç hata yok, tüm seçili aylara eşit dağıtılıyor: ${perMonth}/ay`);
                        selectedMonthsArray.forEach(monthNum => {
                            supplier.monthlyHata[monthNum - 1] = perMonth;
                        });
                    }
                }
                
                // Hata puanını yeniden hesapla - Excel formülü
                const hataHedefi = supplier.hataHedefi;
                let hataPuan;
                if (hataHedefi === 0) {
                    hataPuan = value === 0 ? 1 : 0;
                } else if (value === 0) {
                    hataPuan = 1;
                } else if ((hataHedefi / value) > 1) {
                    hataPuan = 1;
                } else {
                    hataPuan = hataHedefi / value;
                }
                supplier.hataPuan = hataPuan;
                
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                // Scroll pozisyonunu kaydet
                const savedScrollY = scrollY;
                const savedHorizontalScroll = horizontalScrollLeft;
                
                // Hemen güncelle
                updateSupplierCells(supplierName);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                // Scroll'u anında geri yükle
                window.scrollTo(0, savedScrollY);
                const newTableWrapper = document.querySelector('.table-wrapper');
                if (newTableWrapper) {
                    newTableWrapper.scrollLeft = savedHorizontalScroll;
                }
            }
        }

        function updateHataHedefi(supplierName, newTarget) {
            // Scroll pozisyonunu kaydet
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            const target = newTarget === '' || newTarget === null || newTarget === undefined ? 2 : parseFloat(newTarget);
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier.hataHedefi = target;
                // Hata puanını yeniden hesapla - Excel formülü
                if (target === 0) {
                    supplier.hataPuan = supplier.totalHata === 0 ? 1 : 0;
                } else if (supplier.totalHata === 0) {
                    supplier.hataPuan = 1;
                } else if ((target / supplier.totalHata) > 1) {
                    supplier.hataPuan = 1;
                } else {
                    supplier.hataPuan = target / supplier.totalHata;
                }
                
                // Tedarikçi puanını yeniden hesapla
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                updateSupplierCells(supplierName);
                showAlert(`✅ ${supplierName} için Hata hedefi ${target} olarak güncellendi`, 'success');
                // Dashboard ve görünüm güncelle
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                // Scroll'u geri yükle
                requestAnimationFrame(() => {
                    window.scrollTo(0, scrollY);
                    const newTableWrapper = document.querySelector('.table-wrapper');
                    if (newTableWrapper) {
                        newTableWrapper.scrollLeft = horizontalScrollLeft;
                    }
                });
            }
        }

        function updateLokasyon(supplierName, selectedLocations) {
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier.lokasyon = selectedLocations;
                saveLokasyonToStorage(supplierName, selectedLocations);
                console.log(`${supplierName} lokasyonları:`, selectedLocations);
            }
        }
        
        function toggleLokasyonDropdown(index) {
            const dropdown = document.getElementById(`lokasyonDropdown_${index}`);
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                // Tüm dropdown'ları kapat
                document.querySelectorAll('[id^="lokasyonDropdown_"]').forEach(d => d.style.display = 'none');
                document.querySelectorAll('[id^="kaliteBelgeDropdown_"]').forEach(d => d.style.display = 'none');
                // Bu dropdown'ı aç/kapat
                dropdown.style.display = isVisible ? 'none' : 'block';
            }
        }
        
        function toggleKaliteBelgeDropdown(index) {
            const dropdown = document.getElementById(`kaliteBelgeDropdown_${index}`);
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                // Tüm dropdown'ları kapat
                document.querySelectorAll('[id^="lokasyonDropdown_"]').forEach(d => d.style.display = 'none');
                document.querySelectorAll('[id^="kaliteBelgeDropdown_"]').forEach(d => d.style.display = 'none');
                // Bu dropdown'ı aç/kapat
                dropdown.style.display = isVisible ? 'none' : 'block';
            }
        }
        
        function handleKaliteBelgeCheckbox(supplierName, index, belge, checked) {
            // Scroll pozisyonunu kaydet
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            const supplier = allResults.find(r => r.name === supplierName);
            if (!supplier) return;
            
            // certExpiryDates objesini başlat (yoksa)
            if (!supplier.certExpiryDates) {
                supplier.certExpiryDates = {};
            }
            
            // Checkbox işaretleniyorsa geçerlilik tarihi iste
            if (checked) {
                showCertExpiryDateModal(supplierName, index, belge, () => {
                    // Callback: tarih girildikten sonra devam et
                    finalizeCertificateUpdate(supplier, supplierName, index, belge, checked, scrollY, horizontalScrollLeft);
                });
            } else {
                // Belge kaldırılıyor - tarihi de sil
                delete supplier.certExpiryDates[belge];
                supplier[belge] = checked;
                saveSupplierCertData();
                finalizeCertificateUpdate(supplier, supplierName, index, belge, checked, scrollY, horizontalScrollLeft);
            }
        }
        
        // Sertifika geçerlilik tarihi modal göster
        function showCertExpiryDateModal(supplierName, index, belge, callback) {
            // Belge adını qualityCertTypes'tan al
            const certType = qualityCertTypes.find(c => c.key === belge);
            const belgeName = certType ? certType.label : belge;
            
            const supplier = allResults.find(r => r.name === supplierName);
            const existingDate = supplier?.certExpiryDates?.[belge] || '';
            
            // Modal HTML oluştur
            const modalHTML = `
                <div id="certExpiryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10010;">
                    <div style="background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 20px 0; color: #1e3c72; font-size: 1.2em; border-bottom: 2px solid #1e3c72; padding-bottom: 10px;">
                            📅 Belge Geçerlilik Tarihi
                        </h3>
                        <p style="color: #666; margin-bottom: 15px;">
                            <strong>${belgeName}</strong> belgesi için geçerlilik bitiş tarihini girin:
                        </p>
                        <div style="margin-bottom: 20px;">
                            <input type="date" id="certExpiryDateInput" value="${existingDate}" 
                                   style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box;">
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="cancelCertExpiryModal('${supplierName}', ${index}, '${belge}')" 
                                    style="padding: 10px 20px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 6px; cursor: pointer;">
                                İptal
                            </button>
                            <button onclick="saveCertExpiryDate('${supplierName}', ${index}, '${belge}')" 
                                    style="padding: 10px 20px; border: none; background: #4caf50; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ✓ Kaydet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal'ı DOM'a ekle
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Callback'i sakla
            window.certExpiryCallback = callback;
        }
        
        // Sertifika tarih modal iptal
        function cancelCertExpiryModal(supplierName, index, belge) {
            // Checkbox'ı geri al
            const checkbox = document.querySelector(`#kaliteBelgeDropdown_${index} input[onchange*="${belge}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            // Modal'ı kapat
            const modal = document.getElementById('certExpiryModal');
            if (modal) modal.remove();
            
            window.certExpiryCallback = null;
        }
        
        // Sertifika tarih kaydet
        function saveCertExpiryDate(supplierName, index, belge) {
            const dateInput = document.getElementById('certExpiryDateInput');
            const expiryDate = dateInput.value;
            
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                if (!supplier.certExpiryDates) {
                    supplier.certExpiryDates = {};
                }
                supplier.certExpiryDates[belge] = expiryDate;
                supplier[belge] = true;
            }
            
            // Sertifika verilerini otomatik kaydet
            saveSupplierCertData();
            
            // Modal'ı kapat
            const modal = document.getElementById('certExpiryModal');
            if (modal) modal.remove();
            
            // Callback'i çağır
            if (window.certExpiryCallback) {
                window.certExpiryCallback();
                window.certExpiryCallback = null;
            }
        }
        
        // Sertifika güncelleme işlemini tamamla
        function finalizeCertificateUpdate(supplier, supplierName, index, belge, checked, scrollY, horizontalScrollLeft) {
            // Belgeyi güncelle
            supplier[belge] = checked;
            
            // Kalite puanını hesapla
            let puan = 0;
            
            if (supplier.iatf) {
                puan = 100;
            } else if (supplier.iso9001) {
                // ISO 9001 taban: 70%
                puan = 70;
                
                // ISO 9001 + ISO 14001: 75%
                if (supplier.iso14001 && !supplier.iso45001) {
                    puan = 75;
                }
                // ISO 9001 + ISO 45001: 75%
                else if (supplier.iso45001 && !supplier.iso14001) {
                    puan = 75;
                }
                // ISO 9001 + ISO 14001 + ISO 45001: 80%
                else if (supplier.iso14001 && supplier.iso45001) {
                    puan = 80;
                }
            }
            
            supplier.kalitePuan = puan;
            
            // Aylık verileri de güncelle
            for (let m = 0; m < 12; m++) {
                supplier.monthlyKalitePuan[m] = puan;
            }
            
            // Tedarikçi puanını yeniden hesapla
            supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
            supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
            
            // Display'i güncelle
            const belgeler = [];
            qualityCertTypes.forEach(cert => {
                if (supplier[cert.key]) {
                    const shortLabel = cert.label.replace(/\s/g, '');
                    const dateStr = supplier.certExpiryDates?.[cert.key] ? ` (${new Date(supplier.certExpiryDates[cert.key]).toLocaleDateString('tr-TR')})` : '';
                    belgeler.push(shortLabel + dateStr);
                }
            });
            const displayText = belgeler.length > 0 ? belgeler.join(', ') : 'Seçiniz';
            const displayElement = document.getElementById(`kaliteBelgeDisplay_${index}`);
            if (displayElement) {
                displayElement.textContent = displayText;
            }
            
            // DOM'u doğrudan güncelle
            updateSupplierCells(supplierName);
            
            // Dashboard güncelle
            updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
            
            // Sertifika verilerini otomatik kaydet
            saveSupplierCertData();
            
            // Scroll'u geri yükle
            requestAnimationFrame(() => {
                window.scrollTo(0, scrollY);
                const newTableWrapper = document.querySelector('.table-wrapper');
                if (newTableWrapper) {
                    newTableWrapper.scrollLeft = horizontalScrollLeft;
                }
            });
        }
        
        function handleLokasyonCheckbox(supplierName, index, location, checked) {
            const supplier = allResults.find(r => r.name === supplierName);
            if (!supplier) return;
            
            let currentLokasyon = Array.isArray(supplier.lokasyon) ? [...supplier.lokasyon] : [];
            
            // Tümü seçildi
            if (location === '__TUMU__' && checked) {
                currentLokasyon = ['Çerkezköy', 'Veliköy', 'Ankara', 'Bursa', 'Adana', 'Eskişehir', 'Ultech1', 'Ultech2'];
                // Tüm checkbox'ları işaretle
                const dropdown = document.getElementById(`lokasyonDropdown_${index}`);
                dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb.value !== '__TUMU__' && cb.value !== '__HICBIRI__') {
                        cb.checked = true;
                    }
                });
            }
            // Hiçbiri seçildi
            else if (location === '__HICBIRI__' && checked) {
                currentLokasyon = [];
                // Tüm checkbox'ları temizle
                const dropdown = document.getElementById(`lokasyonDropdown_${index}`);
                dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            }
            // Normal lokasyon seçimi
            else if (location !== '__TUMU__' && location !== '__HICBIRI__') {
                if (checked) {
                    if (!currentLokasyon.includes(location)) {
                        currentLokasyon.push(location);
                    }
                } else {
                    currentLokasyon = currentLokasyon.filter(l => l !== location);
                }
            }
            
            supplier.lokasyon = currentLokasyon;
            saveLokasyonToStorage(supplierName, currentLokasyon);
            
            // Butonu güncelle
            const btn = document.getElementById(`lokasyonBtn_${index}`);
            if (btn) {
                btn.textContent = currentLokasyon.length > 0 ? currentLokasyon.join(', ') : '📍 Lokasyon';
            }
            
            console.log(`${supplierName} lokasyonları güncellendi:`, currentLokasyon);
            
            // NOT: Tabloyu yeniden render etme - dropdown açık kalacak
            // filterTable() sadece dropdown kapatıldığında çağrılacak
        }

        function handleLokasyonChange(supplierName, selectElement, index) {
            const selectedValues = Array.from(selectElement.selectedOptions).map(o => o.value);
            
            // Tümü seçildi mi?
            if (selectedValues.includes('__TUMU__')) {
                // Tüm gerçek lokasyonları seç
                const allOptions = selectElement.querySelectorAll('option');
                allOptions.forEach(option => {
                    if (option.value !== '__TUMU__' && option.value !== '__HICBIRI__' && !option.disabled) {
                        option.selected = true;
                    } else {
                        option.selected = false;
                    }
                });
                
                const realLocations = Array.from(selectElement.selectedOptions).map(o => o.value);
                updateLokasyon(supplierName, realLocations);
                return;
            }
            
            // Hiçbiri seçildi mi?
            if (selectedValues.includes('__HICBIRI__')) {
                // Tüm seçimleri kaldır
                const allOptions = selectElement.querySelectorAll('option');
                allOptions.forEach(option => {
                    option.selected = false;
                });
                updateLokasyon(supplierName, []);
                return;
            }
            
            // Normal seçim - Tümü ve Hiçbiri'yi kaldır
            const filtered = selectedValues.filter(v => v !== '__TUMU__' && v !== '__HICBIRI__');
            updateLokasyon(supplierName, filtered);
        }

        // Çoklu durum güncelleme
        function bulkUpdateStatus(newStatus) {
            if (selectedRows.size === 0) {
                showAlert('⚠️ Lütfen önce satır seçin!\n\nDurum değiştirmek için tablodaki checkboxları işaretleyin.', 'warning');
                return;
            }
            
            const statusEmoji = {
                'ONAYLI': '✅',
                'ONAYSIZ': '⚠️',
                'MÜŞTERİ': '👤'
            };
            
            const emoji = statusEmoji[newStatus] || '📌';
            const count = selectedRows.size;
            
            if (!confirm(`${emoji} ${count} tedarikçiyi "${newStatus}" olarak işaretlemek istediğinize emin misiniz?`)) {
                return;
            }
            
            let updated = 0;
            const updatedSuppliers = [];
            
            // Seçili satırları güncelle
            selectedRows.forEach(rowKey => {
                const supplier = allResults.find(r => (r.mapKey || r.name) === rowKey);
                if (supplier) {
                    const oldStatus = (supplier.status || 'ONAYLI').toUpperCase();
                    
                    // updateDurum fonksiyonunu çağır (geçmiş kaydı için)
                    updateDurum(supplier.name, newStatus);
                    updated++;
                    updatedSuppliers.push(supplier.name);
                }
            });
            
            // Tabloyu yeniden oluştur
            renderTable(currentFilteredResults);
            
            // Seçimleri temizle
            selectedRows.clear();
            
            // Bilgilendirme
            console.log('═══════════════════════════════════════════════');
            console.log('📋 ÇOKLU DURUM DEĞİŞİKLİĞİ');
            console.log('───────────────────────────────────────────────');
            console.log(`${emoji} Yeni Durum: ${newStatus}`);
            console.log(`✅ Güncellenen: ${updated} tedarikçi`);
            console.log(`📋 Tedarikçiler: ${updatedSuppliers.join(', ')}`);
            console.log('═══════════════════════════════════════════════');
            
            showAlert(`${emoji} ${updated} tedarikçi "${newStatus}" olarak güncellendi!`, 'success');
        }
        
        function updateDurum(supplierName, newStatus) {
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                const oldStatus = (supplier.status || 'ONAYLI').toUpperCase();
                const newStatusUpper = newStatus.toUpperCase();
                
                // Durum değişiklik kaydı
                const timestamp = new Date().toLocaleString('tr-TR');
                const changeLog = {
                    tedarikcı: supplierName,
                    eskiDurum: oldStatus,
                    yeniDurum: newStatusUpper,
                    tarih: timestamp
                };
                
                supplier.status = newStatus;
                
                // Durum haritasını güncelle ve kaydet
                updateSupplierStatus(supplierName, newStatus);
                
                // Detaylı konsol log
                console.log('═══════════════════════════════════════════════');
                console.log('📋 DURUM DEĞİŞİKLİĞİ KAYDI');
                console.log('───────────────────────────────────────────────');
                console.log(`🏢 Tedarikçi: ${supplierName}`);
                console.log(`📌 Eski Durum: ${oldStatus}`);
                console.log(`✨ Yeni Durum: ${newStatusUpper}`);
                console.log(`🕐 Tarih/Saat: ${timestamp}`);
                console.log('═══════════════════════════════════════════════');
                
                // localStorage'a durum değişiklik geçmişi kaydet (sınırsız)
                try {
                    let statusHistory = JSON.parse(localStorage.getItem('supplierStatusHistory') || '[]');
                    statusHistory.push(changeLog);
                    localStorage.setItem('supplierStatusHistory', JSON.stringify(statusHistory));
                } catch (e) {
                    console.error('Durum geçmişi kaydetme hatası:', e);
                }

                // Genel değişiklik geçmişine ekle (manuel silinebilir)
                logActivity('status-change', {
                    supplierName,
                    oldStatus,
                    newStatus: newStatusUpper,
                    timestamp: new Date().toISOString()
                });
                
                // Kullanıcıya bildirim
                if (oldStatus !== newStatusUpper) {
                    const emoji = newStatusUpper === 'ONAYLI' ? '✅' : newStatusUpper === 'ONAYSIZ' ? '⚠️' : '👤';
                    showAlert(`${emoji} "${supplierName}"\n${oldStatus} → ${newStatusUpper}`, 'info');
                }
                
                console.log(`${supplierName} durumu: ${oldStatus} -> ${newStatus} (kaydedildi)`);
                
                // Yeni durumun checkbox'ının seçili olduğundan emin ol
                const durumCheckboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]');
                durumCheckboxes.forEach(cb => {
                    if (cb.value === newStatus) {
                        cb.checked = true;
                    }
                });
                
                // Durum değişikliği türüne göre işlem yap
                const needsTabSwitch = oldStatus !== newStatusUpper;
                
                if (needsTabSwitch) {
                    // İlk olarak filtreyi hemen güncelle
                    updateDurumFilter(true);
                    
                    showAlert(`⏳ ${supplierName} ${newStatusUpper.toLowerCase()} listesine taşınıyor...`, 'info');
                    
                    // 2 saniye sonra ilgili sekmeye geç
                    setTimeout(() => {
                        switchTab(newStatusUpper);
                        showAlert(`✅ ${supplierName} ${newStatusUpper.toLowerCase()} listesine taşındı`, 'success');
                    }, 2000);
                } else {
                    // Aynı durum içinde güncelleme (sadece filtrele)
                    updateDurumFilter(true);
                }
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Tab butonlarını güncelle
            const tabOnayli = document.getElementById('tabOnayli');
            const tabOnaysiz = document.getElementById('tabOnaysiz');
            const tabMusteri = document.getElementById('tabMusteri');
            
            // Tüm tab'ları pasif yap
            tabOnayli.style.background = '#e0e0e0';
            tabOnayli.style.color = '#666';
            tabOnaysiz.style.background = '#e0e0e0';
            tabOnaysiz.style.color = '#666';
            tabMusteri.style.background = '#e0e0e0';
            tabMusteri.style.color = '#666';
            
            // Seçili tab'ı aktif yap
            if (tab === 'ONAYLI') {
                tabOnayli.style.background = '#1e3c72';
                tabOnayli.style.color = 'white';
            } else if (tab === 'ONAYSIZ') {
                tabOnaysiz.style.background = '#dc3545';
                tabOnaysiz.style.color = 'white';
            } else if (tab === 'MÜŞTERİ') {
                tabMusteri.style.background = '#2196F3';
                tabMusteri.style.color = 'white';
            }
            
            // Sadece ilgili durumun checkbox'ını seçili yap, diğerlerini kaldır
            const allDurumCheckboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]:not([value="__TUMU__"])');
            allDurumCheckboxes.forEach(cb => {
                cb.checked = (cb.value === tab);
            });
            
            // "Tümü" checkbox'ını kaldır
            const tumuCheckbox = document.querySelector('#durumOptions input[value="__TUMU__"]');
            if (tumuCheckbox) {
                tumuCheckbox.checked = false;
            }
            
            // Filtreyi hemen güncelle (immediate flag)
            updateDurumFilter(true);
        }

        function updateKaliteBelge(supplierName, belge, checked) {
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier[belge] = checked;
                
                // Kalite puanını hesapla
                let puan = 0;
                
                if (supplier.iatf) {
                    puan = 100;
                } else if (supplier.iso9001) {
                    // ISO 9001 taban: 70%
                    puan = 70;
                    
                    // ISO 9001 + ISO 14001: 75%
                    if (supplier.iso14001 && !supplier.iso45001) {
                        puan = 75;
                    }
                    // ISO 9001 + ISO 45001: 75%
                    else if (supplier.iso45001 && !supplier.iso14001) {
                        puan = 75;
                    }
                    // ISO 9001 + ISO 14001 + ISO 45001: 80%
                    else if (supplier.iso14001 && supplier.iso45001) {
                        puan = 80;
                    }
                }
                
                supplier.kalitePuan = puan;
                
                // Aylık verileri de güncelle
                for (let m = 0; m < 12; m++) {
                    supplier.monthlyKalitePuan[m] = puan;
                }
                
                // Tedarikçi puanını yeniden hesapla
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                // DOM'u doğrudan güncelle (sayfa yeniden render edilmez, scroll korunur)
                updateSupplierCells(supplierName);
                
                // Sertifika verilerini otomatik kaydet
                saveSupplierCertData();
            }
        }

        function updateVDAPuan(supplierName, newPuan) {
            let puan = parseFloat(newPuan) || 0;
            if (puan < 0) puan = 0;
            if (puan > 100) puan = 100;
            
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier.vdaPuan = puan;
                // Tüm aylara da uygula (eğer aylık veri yoksa)
                for (let m = 0; m < 12; m++) {
                    if (!supplier.monthlyVdaPuan[m]) {
                        supplier.monthlyVdaPuan[m] = puan;
                    }
                }
                
                // Tedarikçi puanını yeniden hesapla (VDA değiştiğinde formül değişebilir)
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                updateSupplierCells(supplierName);
                // Dashboard ve görünüm güncelle
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
            }
        }

        function update8D(supplierName, type, newValue) {
            const value = parseInt(newValue) || 0;
            const supplier = allResults.find(r => r.name === supplierName);
            
            if (supplier) {
                if (type === 'talep') {
                    supplier.talepEdilen8D = value;
                } else if (type === 'cevap') {
                    supplier.cevaplanan8D = value;
                }
                
                // 8D Dönüş Oranını hesapla
                if (supplier.talepEdilen8D === 0) {
                    supplier.donusOrani8D = 100;
                } else {
                    supplier.donusOrani8D = (supplier.cevaplanan8D / supplier.talepEdilen8D) * 100;
                    if (supplier.donusOrani8D > 100) supplier.donusOrani8D = 100;
                }
                
                // 8D sayılarını IndexedDB'ye kaydet
                save8DCounts(supplierName, supplier.talepEdilen8D, supplier.cevaplanan8D, supplier.donusOrani8D)
                    .then(() => {
                        console.log('💾 8D sayıları manuel girişten IndexedDB\'ye kaydedildi');
                    })
                    .catch(err => {
                        console.error('8D sayıları manuel kaydetme hatası:', err);
                    });
                
                // Tedarikçi puanını yeniden hesapla
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                updateSupplierCells(supplierName);
            }
        }

        // Aylık puanları hedef ortalamaya yaklaştır (minimum ay değiştirme mantığı)
        // Delta'yı birkaç ayda toplayarak tüm grafiğin aynı puana çekilmesini önler
        function adjustMonthlyScoresToTarget(currentMonthlyArray, targetScore) {
            const snapshot = currentMonthlyArray.slice(0, 12);
            const sum = snapshot.reduce((a, b) => a + b, 0);
            const targetSum = targetScore * 12;
            let delta = targetSum - sum; // pozitifse artır, negatifse düşür

            // Delta çok küçükse dokunma
            if (Math.abs(delta) < 0.01) return snapshot;

            // Değer + oranda değişecek ayları belirlemek için sıralama
            const indexed = snapshot.map((val, idx) => ({ val, idx }));

            if (delta > 0) {
                // Hedef daha yüksek: en düşüklerden başlayarak yükselt
                indexed.sort((a, b) => a.val - b.val); // düşükten yüksek
                for (let i = 0; i < indexed.length && delta > 0; i++) {
                    const { val, idx } = indexed[i];
                    const maxIncrease = 100 - val;
                    const applied = Math.min(delta, maxIncrease);
                    snapshot[idx] = val + applied;
                    delta -= applied;
                }
            } else {
                // Hedef daha düşük: en yükseklerden başlayarak düşür
                delta = -delta; // pozitif ihtiyaca çevir
                indexed.sort((a, b) => b.val - a.val); // yüksekten düşük
                for (let i = 0; i < indexed.length && delta > 0; i++) {
                    const { val, idx } = indexed[i];
                    const maxDecrease = val; // 0'a kadar inebilir
                    const applied = Math.min(delta, maxDecrease);
                    snapshot[idx] = val - applied;
                    delta -= applied;
                }
            }

            return snapshot;
        }

        function updateTerminPuan(supplierName, newPuan) {
            // Programmatik güncelleme ise (updateSupplierCells'ten geliyorsa) işlem yapma
            if (window.isUpdatingCells) {
                console.log('🚫 Programmatik güncelleme, updateTerminPuan atlandı');
                return;
            }
            
            let puan = parseFloat(newPuan) || 0;
            if (puan < 0) puan = 0;
            if (puan > 100) puan = 100;
            
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                const oldPuan = supplier.terminPuan;
                supplier.terminPuan = puan;
                
                // Genel puan değiştirildi - TÜM AYLAR değişeceği için Manuel düzenleme işaretlerini TEMİZLE
                if (manualMonthlyEdits[supplierName] && manualMonthlyEdits[supplierName].termin) {
                    manualMonthlyEdits[supplierName].termin = [];
                    console.log(`🧽 Genel termin puanı değiştirildi - ${supplierName} için manuel düzenleme işaretleri temizlendi`);
                }
                
                // Aylık puanları AKILLI DAĞILIMLA ayarla
                if (supplier.monthlyTerminPuan && Array.isArray(supplier.monthlyTerminPuan)) {
                    const oldMonthlyArray = supplier.monthlyTerminPuan.slice(0, 12);
                    const oldAvg = oldMonthlyArray.reduce((a, b) => a + b, 0) / 12;
                    
                    // Akıllı dağılım: En düşükleri yükselt veya en yüksekleri düşür
                    const newMonthlyArray = adjustMonthlyScoresToTarget(oldMonthlyArray, puan);
                    supplier.monthlyTerminPuan = newMonthlyArray;
                    
                    const newAvg = newMonthlyArray.reduce((a, b) => a + b, 0) / 12;
                    console.log(`📊 Termin: ${oldPuan.toFixed(0)} (ort:${oldAvg.toFixed(1)}) → ${puan.toFixed(0)} (ort:${newAvg.toFixed(1)})`);
                    console.log(`  Aylık değerler: [${newMonthlyArray.map(v => v.toFixed(0)).join(', ')}]`);
                }
                
                // Tedarikçi puanını yeniden hesapla
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                updateSupplierCells(supplierName);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                // Düzenlemeleri kaydet
                saveEditsToLocalStorage();
                
                // Eğer performans modalı açıksa ve bu tedarikçinin grafiği gösteriliyorsa, grafikleri güncelle
                const modal = document.getElementById('performanceChartModal');
                if (modal && modal.style.display === 'flex' && window.currentSupplierForCallbacks) {
                    // Modalda görüntülenen tedarikçi bu mu?
                    if (window.currentSupplierForCallbacks.name === supplierName) {
                        const chartTermin = document.getElementById('chartTermin');
                        if (chartTermin && window.currentTerminCallback) {
                            // Grafik var, yeniden çiz
                            const months = Array.from(selectedMonths).sort((a,b)=>a-b);
                            const monthLabels = months.map(m => `${m}.Ay`);
                            const terminSeries = months.map(m => supplier.monthlyTerminPuan?.[m-1] || 100);
                            
                            drawBarChart('chartTermin', monthLabels, terminSeries, '#3949ab', 'Termin', null, window.currentTerminCallback, months);
                            console.log('🔄 Termin grafiği listeden güncellendi');
                        }
                    }
                }
            }
        }

        function updateTamamlanmaPuan(supplierName, newPuan) {
            // Programmatik güncelleme ise (updateSupplierCells'ten geliyorsa) işlem yapma
            if (window.isUpdatingCells) {
                console.log('🚫 Programmatik güncelleme, updateTamamlanmaPuan atlandı');
                return;
            }
            
            let puan = parseFloat(newPuan) || 0;
            if (puan < 0) puan = 0;
            if (puan > 100) puan = 100;
            
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                const oldPuan = supplier.tamamlanmaPuan;
                supplier.tamamlanmaPuan = puan;
                
                // Genel puan değiştirildi - TÜM AYLAR değişeceği için Manuel düzenleme işaretlerini TEMİZLE
                if (manualMonthlyEdits[supplierName] && manualMonthlyEdits[supplierName].tamamlanma) {
                    manualMonthlyEdits[supplierName].tamamlanma = [];
                    console.log(`🧽 Genel tamamlanma puanı değiştirildi - ${supplierName} için manuel düzenleme işaretleri temizlendi`);
                }
                
                // Aylık puanları AKILLI DAĞILIMLA ayarla
                if (supplier.monthlyTamamlanmaPuan && Array.isArray(supplier.monthlyTamamlanmaPuan)) {
                    const oldMonthlyArray = supplier.monthlyTamamlanmaPuan.slice(0, 12);
                    const oldAvg = oldMonthlyArray.reduce((a, b) => a + b, 0) / 12;
                    
                    // Akıllı dağılım: En düşükleri yükselt veya en yüksekleri düşür
                    const newMonthlyArray = adjustMonthlyScoresToTarget(oldMonthlyArray, puan);
                    supplier.monthlyTamamlanmaPuan = newMonthlyArray;
                    
                    const newAvg = newMonthlyArray.reduce((a, b) => a + b, 0) / 12;
                    console.log(`📊 Tamamlanma: ${oldPuan.toFixed(0)} (ort:${oldAvg.toFixed(1)}) → ${puan.toFixed(0)} (ort:${newAvg.toFixed(1)})`);
                    console.log(`  Aylık değerler: [${newMonthlyArray.map(v => v.toFixed(0)).join(', ')}]`);
                }
                
                // Tedarikçi puanını yeniden hesapla
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                
                updateSupplierCells(supplierName);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                
                // Düzenlemeleri kaydet
                saveEditsToLocalStorage();
                
                // Eğer performans modalı açıksa ve bu tedarikçinin grafiği gösteriliyorsa, grafikleri güncelle
                const modal = document.getElementById('performanceChartModal');
                if (modal && modal.style.display === 'flex' && window.currentSupplierForCallbacks) {
                    // Modalda görüntülenen tedarikçi bu mu?
                    if (window.currentSupplierForCallbacks.name === supplierName) {
                        const chartCompletion = document.getElementById('chartCompletion');
                        if (chartCompletion && window.currentCompletionCallback) {
                            // Grafik var, yeniden çiz
                            const months = Array.from(selectedMonths).sort((a,b)=>a-b);
                            const monthLabels = months.map(m => `${m}.Ay`);
                            const completionSeries = months.map(m => supplier.monthlyTamamlanmaPuan?.[m-1] || 100);
                            
                            drawBarChart('chartCompletion', monthLabels, completionSeries, '#00796b', 'Tamamlanma', null, window.currentCompletionCallback, months);
                            console.log('🔄 Tamamlanma grafiği listeden güncellendi');
                        }
                    }
                }
            }
        }
        
        // Yardımcı fonksiyon: Bir tedarikçinin satırındaki hücreleri DOM'da güncelle (tablo yeniden render edilmez)
        function updateSupplierCells(supplierName) {
            const supplier = allResults.find(r => r.name === supplierName);
            if (!supplier) return;

            const table = document.getElementById('suppliersTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr:not(.separator-row)');
            const escapedName = (window.CSS && CSS.escape) ? CSS.escape(supplierName) : supplierName.replace(/"/g, '\\"');
            
            for (let i = 0; i < rows.length; i++) {
                const rowMatch = rows[i].querySelector(`select[data-supplier="${escapedName}"]`);
                if (rowMatch) {
                    const cells = rows[i].querySelectorAll('td');
                    
                    // PPM hücresinin rengini güncelle
                    let ppmClass = 'ppm-low';
                    if (supplier.ppm > supplier.ppmTarget * 2) ppmClass = 'ppm-high';
                    else if (supplier.ppm > supplier.ppmTarget) ppmClass = 'ppm-medium';
                    
                    // İlgili hücreleri güncelle (indeksler generateTableRow fonksiyonuna göre):
                    // 0: Checkbox
                    // 1: #
                    // 2: Durum
                    // 3: Tedarikçi
                    // 4: Lokasyon
                    // 5: Dokümanlar
                    // 6: Tedarikçi Bilgileri
                    // 7: Toplam Sevkiyat
                    // 8: Toplam İade
                    // 9: PPM Hedefi
                    // 10: PPM
                    // 11: PPM Puanı
                    // 12: Hata Hedefi
                    // 13: Toplam Hata
                    // 14: Hata Puanı
                    // 15: Kalite Belgeleri
                    // 16: Kalite Belge Puanı
                    // 17: VDA/Denetim Puanı
                    // 18: Talep Edilen 8D
                    // 19: Cevaplanan 8D
                    // 20: 8D Dönüş Oranı
                    // 21: Termin Puanı
                    // 22: Tamamlanma Puanı
                    // 23: Tedarikçi Puanı
                    // 24: Tedarikçi Sınıfı
                    
                    // Toplam Sevkiyat güncelle
                    if (cells[7]) {
                        const sevkSpan = cells[7].querySelector('span[contenteditable]');
                        if (sevkSpan && !document.activeElement.contains(sevkSpan)) {
                            sevkSpan.textContent = supplier.totalSevk.toLocaleString('tr-TR');
                            sevkSpan.dataset.original = supplier.totalSevk;
                        }
                    }
                    
                    if (cells[10]) {
                        cells[10].textContent = supplier.ppm.toFixed(2).toLocaleString('tr-TR');
                        // Renk sınıflarını güncelle
                        cells[10].className = 'text-right ' + ppmClass;
                    }
                    if (cells[11]) cells[11].textContent = (supplier.ppmPuan * 100).toFixed(0) + '%';
                    
                    // Toplam Hata güncelle
                    if (cells[13]) {
                        const hataSpan = cells[13].querySelector('span[contenteditable]');
                        if (hataSpan && !document.activeElement.contains(hataSpan)) {
                            hataSpan.textContent = supplier.totalHata.toLocaleString('tr-TR');
                            hataSpan.dataset.original = supplier.totalHata;
                        }
                    }
                    
                    // Hata Puanı güncelle (input içinde)
                    if (cells[14]) {
                        const hataInput = cells[14].querySelector('input[type="number"]');
                        if (hataInput) {
                            hataInput.value = (supplier.hataPuan * 100).toFixed(0);
                        }
                    }
                    
                    // Kalite Belge Puanı güncelle
                    if (cells[16]) cells[16].textContent = supplier.kalitePuan.toFixed(0) + '%';
                    
                    if (cells[20]) cells[20].textContent = (supplier.talepEdilen8D === 0 ? 100 : supplier.donusOrani8D).toFixed(0) + '%';
                    
                    // Termin Puanı güncelle (input içinde - index 21)
                    if (cells[21]) {
                        const terminInput = cells[21].querySelector('input[type="number"]');
                        if (terminInput) {
                            terminInput.value = (supplier.terminPuan || 100).toFixed(0);
                        }
                    }
                    
                    // Tamamlanma Puanı güncelle (input içinde - index 22)
                    if (cells[22]) {
                        const tamamlanmaInput = cells[22].querySelector('input[type="number"]');
                        if (tamamlanmaInput) {
                            tamamlanmaInput.value = (supplier.tamamlanmaPuan || 100).toFixed(0);
                        }
                    }
                    
                    if (cells[23]) cells[23].textContent = (supplier.tedarikcipuani * 100).toFixed(0) + '%';
                    if (cells[24]) {
                        const sinifSpan = cells[24].querySelector('.supplier-class');
                        if (sinifSpan) {
                            sinifSpan.textContent = supplier.tedarikcisınıfı;
                            sinifSpan.className = `supplier-class class-${supplier.tedarikcisınıfı.toLowerCase()}`;
                        }
                    }
                    break;
                }
            }
        }

        function getExportResultsByCurrentStatusFilter() {
            const baseResults = (lastFilteredResults && lastFilteredResults.length) ? lastFilteredResults : allResults;

            const durumCheckboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const selectedDurumlar = Array.from(durumCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (selectedDurumlar.length >= 2) {
                const isOnayli = (status) => status === 'ONAYLI' || (status.includes('ONAY') && !status.includes('ONAYSIZ') && status !== 'MÜŞTERİ');
                const isOnaysiz = (status) => status === 'ONAYSIZ' || status.includes('BEKLEM');
                const isMusteri = (status) => status === 'MÜŞTERİ';

                const onaylilar = baseResults.filter(r => isOnayli((r.status || 'ONAYLI').toUpperCase()));
                const onaysizlar = baseResults.filter(r => isOnaysiz((r.status || 'ONAYLI').toUpperCase()));
                const musteriler = baseResults.filter(r => isMusteri((r.status || 'ONAYLI').toUpperCase()));

                return [...onaylilar, ...onaysizlar, ...musteriler];
            }

            return baseResults;
        }

        function exportToPDF(yearParam, reviewDateParam) {
            if (allResults.length === 0) return;
            
            // jsPDF kontrolü
            if (!window.jspdf && !window.jsPDF) {
                showAlert('⚠️ PDF kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }
            
            const jsPDF = window.jspdf?.jsPDF || window.jsPDF;
            const doc = new jsPDF('l', 'mm', 'a4'); // landscape, millimeters, A4
            
            // Türkçe karakter desteği için font ayarla
            doc.setFont('helvetica');
            
            // Dönem ve Gözden Geçirme Tarihi
            const exportYear = yearParam || new Date().getFullYear();
            let exportReviewDate = '';
            if (reviewDateParam) {
                const parts = reviewDateParam.split('-');
                if (parts.length === 3) {
                    exportReviewDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                } else {
                    exportReviewDate = new Date().toLocaleDateString('tr-TR');
                }
            } else {
                exportReviewDate = new Date().toLocaleDateString('tr-TR');
            }
            
            // Durum filtresine göre verileri filtrele (seçili checkbox'lara göre)
            let dataToExport = getExportResultsByCurrentStatusFilter();
            
            // ÜST BAŞLIK - Excel formatına tam uyumlu, tablo genişliğinde
            const pageWidth = doc.internal.pageSize.width;
            const margin = 10;
            const tableWidth = pageWidth - (2 * margin); // 277mm toplam (297-20)
            
            // Sol üst: SANIFOAM logosu (yaklaşık %18 - 50mm)
            const logoWidth = 50;
            doc.setFillColor(230, 242, 255); // Açık mavi arka plan
            doc.rect(margin, 5, logoWidth, 15, 'F');
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.rect(margin, 5, logoWidth, 15, 'S');
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 51, 102);
            doc.text('SANIFOAM', margin + logoWidth/2, 14.5, { align: 'center' });
            
            // Orta: Başlık (yaklaşık %58 - 160mm)
            const titleWidth = 160;
            const titleX = margin + logoWidth;
            doc.setFillColor(204, 229, 255); // Daha koyu mavi arka plan
            doc.rect(titleX, 5, titleWidth, 15, 'F');
            doc.rect(titleX, 5, titleWidth, 15, 'S');
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 51, 102);
            doc.text('ONAYLI TEDARIKCI LISTESI', titleX + titleWidth/2, 14.5, { align: 'center' });
            
            // Sağ üst: Doküman bilgileri (kalan %24 - 67mm)
            const docInfoWidth = tableWidth - logoWidth - titleWidth;
            const docInfoX = titleX + titleWidth;
            const labelWidth = docInfoWidth * 0.52; // %52 label
            const valueWidth = docInfoWidth * 0.48; // %48 value
            
            // Tüm doküman bilgileri alanı için beyaz arka plan
            doc.setFillColor(255, 255, 255);
            doc.rect(docInfoX, 5, docInfoWidth, 15, 'F');
            
            // Çerçeveler ve içerikler
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // DOK.NO satırı
            doc.rect(docInfoX, 5, labelWidth, 5, 'S');
            doc.rect(docInfoX + labelWidth, 5, valueWidth, 5, 'S');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('DOK.NO:', docInfoX + labelWidth - 2, 8.5, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            doc.text('PL11', docInfoX + labelWidth + 2, 8.5);
            
            // Y.TRH satırı
            doc.rect(docInfoX, 10, labelWidth, 5, 'S');
            doc.rect(docInfoX + labelWidth, 10, valueWidth, 5, 'S');
            doc.setFont('helvetica', 'bold');
            doc.text('Y.TRH:', docInfoX + labelWidth - 2, 13.5, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            doc.text('13.02.2013', docInfoX + labelWidth + 2, 13.5);
            
            // REV.NO/TARIH satırı
            doc.rect(docInfoX, 15, labelWidth, 5, 'S');
            doc.rect(docInfoX + labelWidth, 15, valueWidth, 5, 'S');
            doc.setFont('helvetica', 'bold');
            doc.text('REV.NO/TARIH:', docInfoX + labelWidth - 2, 18.5, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            doc.text('03/29.08.2025', docInfoX + labelWidth + 2, 18.5);
            
            // Dashboard istatistikleri hesapla
            const totalSuppliers = dataToExport.length;
            const totalSevk = dataToExport.reduce((sum, r) => sum + r.totalSevk, 0);
            const totalIade = dataToExport.reduce((sum, r) => sum + r.totalIade, 0);
            const avgPPM = totalSevk > 0 ? (totalIade / totalSevk) * 1000000 : 0;
            const totalHata = dataToExport.reduce((sum, r) => sum + r.totalHata, 0);
            const totalScore = dataToExport.reduce((sum, r) => sum + (Number.isFinite(r.tedarikcipuani) ? r.tedarikcipuani : 0), 0);
            const avgSupplierScore = totalSuppliers > 0 ? (totalScore / totalSuppliers) * 100 : 0;
            
            // Dönem ve Gözden Geçirme Tarihi bilgileri
            const infoStartY = 22;
            doc.setFillColor(255, 250, 220);
            doc.rect(margin, infoStartY, tableWidth/2 - 2, 6, 'F');
            doc.rect(margin, infoStartY, tableWidth/2 - 2, 6, 'S');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 51, 102);
            doc.text(`Donem (Yil): ${exportYear}`, margin + 2, infoStartY + 4);
            
            doc.setFillColor(255, 250, 220);
            doc.rect(margin + tableWidth/2 + 2, infoStartY, tableWidth/2 - 2, 6, 'F');
            doc.rect(margin + tableWidth/2 + 2, infoStartY, tableWidth/2 - 2, 6, 'S');
            doc.text(`Gozden Gecirme Tarihi: ${exportReviewDate}`, margin + tableWidth/2 + 4, infoStartY + 4);
            
            // Dashboard özet verileri - tek satır
            const dashY = infoStartY + 8;
            const colWidth = tableWidth / 6;
            doc.setFillColor(230, 242, 255);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 51, 102);
            doc.setLineWidth(0.3);
            doc.setDrawColor(0, 0, 0);
            
            // Toplam Tedarikçi
            doc.setFillColor(230, 242, 255);
            doc.rect(margin, dashY, colWidth, 6, 'F');
            doc.rect(margin, dashY, colWidth, 6, 'S');
            doc.text('TOPLAM TEDARIKCI', margin + colWidth/2, dashY + 2, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(totalSuppliers.toString(), margin + colWidth/2, dashY + 5, { align: 'center' });
            
            // Toplam Sevkiyat
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(230, 242, 255);
            doc.rect(margin + colWidth, dashY, colWidth, 6, 'F');
            doc.rect(margin + colWidth, dashY, colWidth, 6, 'S');
            doc.text('TOPLAM SEVKIYAT', margin + colWidth + colWidth/2, dashY + 2, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(totalSevk.toLocaleString('tr-TR'), margin + colWidth + colWidth/2, dashY + 5, { align: 'center' });
            
            // Toplam İade
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(230, 242, 255);
            doc.rect(margin + 2*colWidth, dashY, colWidth, 6, 'F');
            doc.rect(margin + 2*colWidth, dashY, colWidth, 6, 'S');
            doc.text('TOPLAM IADE', margin + 2*colWidth + colWidth/2, dashY + 2, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(totalIade.toLocaleString('tr-TR'), margin + 2*colWidth + colWidth/2, dashY + 5, { align: 'center' });
            
            // Genel PPM
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(230, 242, 255);
            doc.rect(margin + 3*colWidth, dashY, colWidth, 6, 'F');
            doc.rect(margin + 3*colWidth, dashY, colWidth, 6, 'S');
            doc.text('GENEL PPM', margin + 3*colWidth + colWidth/2, dashY + 2, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(avgPPM.toFixed(2), margin + 3*colWidth + colWidth/2, dashY + 5, { align: 'center' });
            
            // Toplam Hata
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(230, 242, 255);
            doc.rect(margin + 4*colWidth, dashY, colWidth, 6, 'F');
            doc.rect(margin + 4*colWidth, dashY, colWidth, 6, 'S');
            doc.text('TOPLAM HATA', margin + 4*colWidth + colWidth/2, dashY + 2, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(totalHata.toString(), margin + 4*colWidth + colWidth/2, dashY + 5, { align: 'center' });
            
            // Ortalama Tedarikçi Puanı
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(230, 242, 255);
            doc.rect(margin + 5*colWidth, dashY, colWidth, 6, 'F');
            doc.rect(margin + 5*colWidth, dashY, colWidth, 6, 'S');
            doc.text('ORTALAMA TEDARIKCI PUANI', margin + 5*colWidth + colWidth/2, dashY + 2, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.text(avgSupplierScore.toFixed(2), margin + 5*colWidth + colWidth/2, dashY + 5, { align: 'center' });
            
            // Tablo verileri - Excel ile aynı sütunlar
            const tableData = dataToExport.map((r, i) => {
                // Türkçe karakter düzeltmesi için normalize
                const normalizeTurkish = (str) => {
                    if (!str) return '';
                    return String(str)
                        .replace(/İ/g, 'I')
                        .replace(/ı/g, 'i')
                        .replace(/Ş/g, 'S')
                        .replace(/ş/g, 's')
                        .replace(/Ğ/g, 'G')
                        .replace(/ğ/g, 'g')
                        .replace(/Ü/g, 'U')
                        .replace(/ü/g, 'u')
                        .replace(/Ö/g, 'O')
                        .replace(/ö/g, 'o')
                        .replace(/Ç/g, 'C')
                        .replace(/ç/g, 'c');
                };
                
                // Lokasyon formatla
                const lokasyon = Array.isArray(r.lokasyon) && r.lokasyon.length > 0 
                    ? normalizeTurkish(r.lokasyon.join(', '))
                    : '-';
                
                // Doküman sayısını hesapla
                let docCount = 0;
                if (r.documents && r.documents.documents) {
                    Object.values(r.documents.documents).forEach(docArray => {
                        if (Array.isArray(docArray)) {
                            docCount += docArray.length;
                        }
                    });
                }
                const docText = docCount > 0 ? docCount + ' dosya' : '-';
                
                // Kalite belgeleri
                const belgeler = [];
                const formatExpiry = (date) => {
                    if (!date) return '';
                    const d = new Date(date);
                    return `(${d.toLocaleDateString('tr-TR')})`;
                };
                if (r.iatf) belgeler.push('IATF16949' + formatExpiry(r.certExpiryDates?.iatf));
                if (r.iso9001) belgeler.push('ISO 9001' + formatExpiry(r.certExpiryDates?.iso9001));
                if (r.iso14001) belgeler.push('ISO 14001' + formatExpiry(r.certExpiryDates?.iso14001));
                if (r.iso45001) belgeler.push('ISO 45001' + formatExpiry(r.certExpiryDates?.iso45001));
                const belgeText = belgeler.length > 0 ? belgeler.join(', ') : '-';
                
                return [
                    i + 1,                                          // Sira
                    normalizeTurkish(r.status || 'ONAYLI'),        // Durum
                    normalizeTurkish(r.name),                      // Tedarikci
                    lokasyon,                                      // Lokasyon
                    docText,                                       // Dokumanlar
                    r.totalSevk.toLocaleString('tr-TR'),          // Toplam Sevkiyat
                    r.totalIade.toLocaleString('tr-TR'),          // Toplam Iade
                    r.ppmTarget,                                   // PPM Hedefi
                    r.ppm.toFixed(2),                              // PPM
                    (r.ppmPuan * 100).toFixed(0) + '%',           // PPM Puani
                    r.hataHedefi || 2,                             // Hata Hedefi
                    r.totalHata,                                   // Toplam Hata
                    (r.hataPuan * 100).toFixed(0) + '%',          // Hata Puani
                    belgeText,                                     // Kalite Belgeleri
                    r.kalitePuan.toFixed(0) + '%',                // Kalite Belge Puani
                    r.vdaPuan.toFixed(0) + '%',                   // VDA/Denetim Puani
                    r.talepEdilen8D || 0,                          // Talep Edilen 8D
                    r.cevaplanan8D || 0,                           // Cevaplanan 8D
                    r.donusOrani8D.toFixed(0) + '%',              // 8D Donus Orani
                    r.terminPuan.toFixed(0) + '%',                // Termin Puani
                    r.tamamlanmaPuan.toFixed(0) + '%',            // Tamamlanma Puani
                    (r.tedarikcipuani * 100).toFixed(0) + '%',    // Tedarikci Puani
                    r.tedarikcisınıfı || '-'                      // Tedarikci Sinifi
                ];
            });
            
            // Tablo oluştur - Excel ile aynı sütunlar
            doc.autoTable({
                startY: 38,
                head: [[
                    '#', 'Durum', 'Tedarikci', 'Lokasyon', 'Dokumanlar',
                    'Toplam Sevkiyat', 'Toplam Iade', 'PPM Hedefi', 'PPM', 'PPM Puani',
                    'Hata Hedefi', 'Toplam Hata', 'Hata Puani', 'Kalite Belgeleri',
                    'Kalite Belge Puani', 'VDA/Denetim Puani', 'Talep Edilen 8D',
                    'Cevaplanan 8D', '8D Donus Orani', 'Termin Puani',
                    'Tamamlanma Puani', 'Tedarikci Puani', 'Tedarikci Sinifi'
                ]],
                body: tableData,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontStyle: 'normal'
                },
                headStyles: {
                    fillColor: [68, 114, 196],
                    textColor: [255, 255, 255],
                    fontSize: 7,
                    fontStyle: 'bold',
                    halign: 'center',
                    font: 'helvetica'
                },
                bodyStyles: {
                    fontSize: 5.5,
                    cellPadding: 1,
                    font: 'helvetica'
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 6 },      // #
                    1: { halign: 'center', cellWidth: 12 },     // Durum
                    2: { halign: 'left', cellWidth: 28 },       // Tedarikci
                    3: { halign: 'center', cellWidth: 15 },     // Lokasyon
                    4: { halign: 'center', cellWidth: 12 },     // Dokumanlar
                    5: { halign: 'right', cellWidth: 14 },      // Toplam Sevkiyat
                    6: { halign: 'right', cellWidth: 12 },      // Toplam Iade
                    7: { halign: 'right', cellWidth: 10 },      // PPM Hedefi
                    8: { halign: 'right', cellWidth: 12 },      // PPM
                    9: { halign: 'center', cellWidth: 10 },     // PPM Puani
                    10: { halign: 'right', cellWidth: 10 },     // Hata Hedefi
                    11: { halign: 'right', cellWidth: 11 },     // Toplam Hata
                    12: { halign: 'center', cellWidth: 10 },    // Hata Puani
                    13: { halign: 'left', cellWidth: 20 },      // Kalite Belgeleri
                    14: { halign: 'center', cellWidth: 12 },    // Kalite Belge Puani
                    15: { halign: 'center', cellWidth: 12 },    // VDA/Denetim Puani
                    16: { halign: 'center', cellWidth: 10 },    // Talep Edilen 8D
                    17: { halign: 'center', cellWidth: 10 },    // Cevaplanan 8D
                    18: { halign: 'center', cellWidth: 10 },    // 8D Donus Orani
                    19: { halign: 'center', cellWidth: 10 },    // Termin Puani
                    20: { halign: 'center', cellWidth: 12 },    // Tamamlanma Puani
                    21: { halign: 'center', cellWidth: 10 },    // Tedarikci Puani
                    22: { halign: 'center', cellWidth: 8 }      // Tedarikci Sinifi
                },
                didParseCell: function(data) {
                    // PPM sütunu renklendirme (index 8)
                    if (data.column.index === 8 && data.section === 'body') {
                        const rowIndex = data.row.index;
                        const supplier = dataToExport[rowIndex];
                        if (supplier) {
                            const ppm = supplier.ppm;
                            const ppmTarget = supplier.ppmTarget;
                            
                            // Renk belirleme mantığı (HTML'deki ile aynı)
                            if (ppm > ppmTarget * 2) {
                                // ppm-high: Kırmızı
                                data.cell.styles.fillColor = [220, 53, 69];
                                data.cell.styles.textColor = [255, 255, 255];
                                data.cell.styles.fontStyle = 'bold';
                            } else if (ppm > ppmTarget) {
                                // ppm-medium: Sarı
                                data.cell.styles.fillColor = [255, 193, 7];
                                data.cell.styles.textColor = [0, 0, 0];
                                data.cell.styles.fontStyle = 'bold';
                            } else {
                                // ppm-low: Yeşil
                                data.cell.styles.fillColor = [40, 167, 69];
                                data.cell.styles.textColor = [255, 255, 255];
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    }
                    
                    // Sınıf sütunu renklendirme (index 22)
                    if (data.column.index === 22 && data.section === 'body') {
                        const sinif = data.cell.raw;
                        if (sinif === 'A') {
                            data.cell.styles.fillColor = [146, 208, 80];
                            data.cell.styles.textColor = [0, 0, 0];
                        } else if (sinif === 'B') {
                            data.cell.styles.fillColor = [255, 255, 0];
                            data.cell.styles.textColor = [0, 0, 0];
                        } else if (sinif === 'C') {
                            data.cell.styles.fillColor = [255, 192, 0];
                            data.cell.styles.textColor = [0, 0, 0];
                        } else if (sinif === 'D') {
                            data.cell.styles.fillColor = [255, 0, 0];
                            data.cell.styles.textColor = [255, 255, 255];
                        }
                    }
                },
                margin: { left: 10, right: 10 }
            });
            
            // Tarihi ekle
            const today = new Date().toLocaleDateString('tr-TR');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100);
            doc.text('Olusturulma Tarihi: ' + today, 10, doc.internal.pageSize.height - 5);
            
            // PDF'i kaydet
            doc.save('Tedarikci_Listesi_' + new Date().toISOString().split('T')[0] + '.pdf');
            showAlert('✅ PDF basariyla indirildi!', 'success');
        }

        // Global odaklanma koruması: tabloda bir input/checkbox/select odaklanınca scroll'u sabit tut
        function setupNoJumpScrollGuard() {
            // Devre dışı: otomatik scroll geri alma bu sürümde kapatıldı
            return;
        }

        // Geniş koruma: input/change/keydown gibi etkileşimlerde wrapper scroll'unu sabit tut
        let scrollStabilityGuardAttached = false;
        function setupScrollStabilityGuard() {
            // Devre dışı: scroll kilidi bu sürümde kapatıldı
            return;
        }

        function exportToExcel(yearParam, reviewDateParam) {
            if (allResults.length === 0) return;

            // ExcelJS workbook oluştur
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Onaylı Tedarikçi Listesi');
            
            // Logo hücresi (A1:C3 birleştirilmiş)
            worksheet.mergeCells('A1:C3');
            const logoCell = worksheet.getCell('A1');
            logoCell.value = 'SANIFOAM';
            logoCell.font = { bold: true, size: 24, color: { argb: 'FF003366' } };
            logoCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            logoCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE6F2FF' }
            };
            logoCell.border = {
                top: { style: 'medium', color: { argb: 'FF000000' } },
                left: { style: 'medium', color: { argb: 'FF000000' } },
                bottom: { style: 'medium', color: { argb: 'FF000000' } },
                right: { style: 'medium', color: { argb: 'FF000000' } }
            };
            
            // Başlık hücresi (D1:Q3 birleştirilmiş) - 23 sütunla uyumlu genişlik
            worksheet.mergeCells('D1:Q3');
            const titleCell = worksheet.getCell('D1');
            titleCell.value = 'ONAYLI TEDARİKÇİ LİSTESİ';
            titleCell.font = { bold: true, size: 26, color: { argb: 'FF003366' } };
            titleCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            titleCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFCCE5FF' }
            };
            titleCell.border = {
                top: { style: 'medium', color: { argb: 'FF000000' } },
                left: { style: 'medium', color: { argb: 'FF000000' } },
                bottom: { style: 'medium', color: { argb: 'FF000000' } },
                right: { style: 'medium', color: { argb: 'FF000000' } }
            };
            
            // Doküman bilgileri - DÖK.NO (R1:S1)
            worksheet.mergeCells('R1:S1');
            const dokNoLabel = worksheet.getCell('R1');
            dokNoLabel.value = 'DÖK.NO:';
            dokNoLabel.font = { bold: true, size: 11 };
            dokNoLabel.alignment = { horizontal: 'right', vertical: 'middle' };
            dokNoLabel.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
            dokNoLabel.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            worksheet.mergeCells('T1:W1');
            const dokNoValue = worksheet.getCell('T1');
            dokNoValue.value = 'PL11';
            dokNoValue.font = { size: 11 };
            dokNoValue.alignment = { horizontal: 'left', vertical: 'middle' };
            dokNoValue.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
            dokNoValue.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            // Doküman bilgileri - Y.TRH (R2:S2)
            worksheet.mergeCells('R2:S2');
            const ytrhLabel = worksheet.getCell('R2');
            ytrhLabel.value = 'Y.TRH:';
            ytrhLabel.font = { bold: true, size: 11 };
            ytrhLabel.alignment = { horizontal: 'right', vertical: 'middle' };
            ytrhLabel.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
            ytrhLabel.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            worksheet.mergeCells('T2:W2');
            const ytrhValue = worksheet.getCell('T2');
            ytrhValue.value = '13.02.2013';
            ytrhValue.font = { size: 11 };
            ytrhValue.alignment = { horizontal: 'left', vertical: 'middle' };
            ytrhValue.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
            ytrhValue.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            // Doküman bilgileri - REV.NO/TARİH (R3:S3)
            worksheet.mergeCells('R3:S3');
            const revLabel = worksheet.getCell('R3');
            revLabel.value = 'REV.NO/TARİH:';
            revLabel.font = { bold: true, size: 11 };
            revLabel.alignment = { horizontal: 'right', vertical: 'middle' };
            revLabel.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
            revLabel.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            worksheet.mergeCells('T3:W3');
            const revValue = worksheet.getCell('T3');
            revValue.value = '03/29.08.2025';
            revValue.font = { size: 11 };
            revValue.alignment = { horizontal: 'left', vertical: 'middle' };
            revValue.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
            revValue.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            // Satır yüksekliklerini ayarla
            worksheet.getRow(1).height = 30;
            worksheet.getRow(2).height = 30;
            worksheet.getRow(3).height = 30;
            worksheet.getRow(4).height = 5;
            
            // Dönem ve Gözden Geçirme Tarihi (4. satırdan sonra ekle)
            const exportYear = yearParam || new Date().getFullYear();
            let exportReviewDate = '';
            if (reviewDateParam) {
                const parts = reviewDateParam.split('-');
                if (parts.length === 3) {
                    exportReviewDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                } else {
                    exportReviewDate = new Date().toLocaleDateString('tr-TR');
                }
            } else {
                exportReviewDate = new Date().toLocaleDateString('tr-TR');
            }
            
            worksheet.mergeCells('A5:L5');
            const donemCell = worksheet.getCell('A5');
            donemCell.value = `Dönem (Yıl): ${exportYear}`;
            donemCell.font = { bold: true, size: 12 };
            donemCell.alignment = { horizontal: 'left', vertical: 'middle' };
            donemCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFADC' } };
            donemCell.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            worksheet.mergeCells('M5:W5');
            const reviewCell = worksheet.getCell('M5');
            reviewCell.value = `Gözden Geçirme Tarihi: ${exportReviewDate}`;
            reviewCell.font = { bold: true, size: 12 };
            reviewCell.alignment = { horizontal: 'left', vertical: 'middle' };
            reviewCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFADC' } };
            reviewCell.border = {
                top: { style: 'thin' }, left: { style: 'thin' },
                bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            
            worksheet.getRow(5).height = 20;
            worksheet.getRow(6).height = 5;
            
            // Durum filtresine göre verileri filtrele (seçili checkbox'lara göre)
            let dataToExport = getExportResultsByCurrentStatusFilter();
            
            // Dashboard özet verileri hesapla
            const totalSuppliers = dataToExport.length;
            const totalSevk = dataToExport.reduce((sum, r) => sum + r.totalSevk, 0);
            const totalIade = dataToExport.reduce((sum, r) => sum + r.totalIade, 0);
            const avgPPM = totalSevk > 0 ? (totalIade / totalSevk) * 1000000 : 0;
            const totalHata = dataToExport.reduce((sum, r) => sum + r.totalHata, 0);
            const totalScore = dataToExport.reduce((sum, r) => sum + (Number.isFinite(r.tedarikcipuani) ? r.tedarikcipuani : 0), 0);
            const avgSupplierScore = totalSuppliers > 0 ? (totalScore / totalSuppliers) * 100 : 0;
            
            // Dashboard satırı (7. satır) - 6 sütun
            const dashRow = worksheet.getRow(7);
            dashRow.height = 35;
            
            // Toplam Tedarikçi (A-D)
            worksheet.mergeCells('A7:D7');
            const col1 = worksheet.getCell('A7');
            col1.value = `TOPLAM TEDARİKÇİ\n${totalSuppliers}`;
            col1.font = { bold: true, size: 10 };
            col1.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            col1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F2FF' } };
            col1.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            
            // Toplam Sevkiyat (E-G)
            worksheet.mergeCells('E7:G7');
            const col2 = worksheet.getCell('E7');
            col2.value = `TOPLAM SEVKİYAT\n${totalSevk.toLocaleString('tr-TR')}`;
            col2.font = { bold: true, size: 10 };
            col2.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            col2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F2FF' } };
            col2.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            
            // Toplam İade (H-J)
            worksheet.mergeCells('H7:J7');
            const col3 = worksheet.getCell('H7');
            col3.value = `TOPLAM İADE\n${totalIade.toLocaleString('tr-TR')}`;
            col3.font = { bold: true, size: 10 };
            col3.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            col3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F2FF' } };
            col3.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            
            // Genel PPM (K-M)
            worksheet.mergeCells('K7:M7');
            const col4 = worksheet.getCell('K7');
            col4.value = `GENEL PPM\n${avgPPM.toFixed(2)}`;
            col4.font = { bold: true, size: 10 };
            col4.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            col4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F2FF' } };
            col4.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            
            // Toplam Hata (N-P)
            worksheet.mergeCells('N7:P7');
            const col5 = worksheet.getCell('N7');
            col5.value = `TOPLAM HATA\n${totalHata}`;
            col5.font = { bold: true, size: 10 };
            col5.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            col5.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F2FF' } };
            col5.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            
            // Ortalama Tedarikçi Puanı (Q-W) - 23 sütunla uyumlu
            worksheet.mergeCells('Q7:W7');
            const col6 = worksheet.getCell('Q7');
            col6.value = `ORTALAMA TEDARİKÇİ PUANI\n${avgSupplierScore.toFixed(2)}`;
            col6.font = { bold: true, size: 10 };
            col6.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            col6.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6F2FF' } };
            col6.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            
            worksheet.getRow(8).height = 5;
            worksheet.getRow(9).height = 20;
            
            // Tablo başlıkları (9. satır)
            const headers = [
                'Sıra', 'Durum', 'Tedarikçi', 'Lokasyon', 'Dokümanlar', 'Toplam Sevkiyat', 'Toplam İade', 
                'PPM Hedefi', 'PPM', 'PPM Puanı', 'Hata Hedefi', 'Toplam Hata Sayısı', 
                'Hata Puanı', 'Kalite Belgeleri', 'Kalite Belge Puanı', 'VDA/Denetim Puanı', 
                'Talep Edilen 8D', 'Cevaplanan 8D', '8D Dönüş Oranı', 'Termin Puanı', 
                'Tamamlanma Puanı', 'Tedarikçi Puanı', 'Tedarikçi Sınıfı'
            ];
            
            const headerRow = worksheet.getRow(9);
            headerRow.values = headers;
            headerRow.height = 25;
            
            // Her başlık hücresini ayrı ayrı formatla
            headers.forEach((header, index) => {
                const cell = headerRow.getCell(index + 1);
                cell.value = header;
                cell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
                cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FF4472C4' }
                };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                };
            });
            
            // Veri satırlarını ekle
            dataToExport.forEach((r, i) => {
                const belgeler = [];
                if (r.iatf) belgeler.push('IATF16949' + (r.certExpiryDates?.iatf ? ` (${new Date(r.certExpiryDates.iatf).toLocaleDateString('tr-TR')})` : ''));
                if (r.iso9001) belgeler.push('ISO 9001' + (r.certExpiryDates?.iso9001 ? ` (${new Date(r.certExpiryDates.iso9001).toLocaleDateString('tr-TR')})` : ''));
                if (r.iso14001) belgeler.push('ISO 14001' + (r.certExpiryDates?.iso14001 ? ` (${new Date(r.certExpiryDates.iso14001).toLocaleDateString('tr-TR')})` : ''));
                if (r.iso45001) belgeler.push('ISO 45001' + (r.certExpiryDates?.iso45001 ? ` (${new Date(r.certExpiryDates.iso45001).toLocaleDateString('tr-TR')})` : ''));
                const belgeText = belgeler.length > 0 ? belgeler.join(', ') : '-';
                
                // Doküman sayısını hesapla
                let docCount = 0;
                if (r.documents && r.documents.documents) {
                    Object.values(r.documents.documents).forEach(docArray => {
                        if (Array.isArray(docArray)) {
                            docCount += docArray.length;
                        }
                    });
                }
                const docText = docCount > 0 ? `${docCount} dosya` : '-';
                
                const rowData = [
                    i + 1,
                    r.status,
                    r.name,
                    r.lokasyon || '-',
                    docText,
                    r.totalSevk,
                    r.totalIade,
                    r.ppmTarget,
                    parseFloat(r.ppm.toFixed(2)),
                    (r.ppmPuan * 100).toFixed(0) + '%',
                    r.hataHedefi,
                    r.totalHata,
                    (r.hataPuan * 100).toFixed(0) + '%',
                    belgeText,
                    r.kalitePuan.toFixed(0) + '%',
                    r.vdaPuan.toFixed(0) + '%',
                    r.talepEdilen8D,
                    r.cevaplanan8D,
                    r.donusOrani8D.toFixed(0) + '%',
                    r.terminPuan.toFixed(0) + '%',
                    r.tamamlanmaPuan.toFixed(0) + '%',
                    (r.tedarikcipuani * 100).toFixed(0) + '%',
                    r.tedarikcisınıfı
                ];
                
                const dataRow = worksheet.addRow(rowData);
                
                // Tedarikçi sınıfına göre renk belirleme (sadece son sütun için)
                let sınıfColor = 'FFFFFFFF'; // Varsayılan beyaz
                if (r.tedarikcisınıfı === 'A') {
                    sınıfColor = 'FF92D050'; // Yeşil
                } else if (r.tedarikcisınıfı === 'B') {
                    sınıfColor = 'FFFFFF00'; // Sarı
                } else if (r.tedarikcisınıfı === 'C') {
                    sınıfColor = 'FFFFC000'; // Turuncu
                } else if (r.tedarikcisınıfı === 'D') {
                    sınıfColor = 'FFFF0000'; // Kırmızı
                }
                
                // PPM renklendirme
                let ppmColor = 'FFFFFFFF'; // Varsayılan beyaz
                if (r.ppm > r.ppmTarget * 2) {
                    ppmColor = 'FFDC3545'; // Kırmızı (ppm-high)
                } else if (r.ppm > r.ppmTarget) {
                    ppmColor = 'FFFFC107'; // Sarı (ppm-medium)
                } else {
                    ppmColor = 'FF28A745'; // Yeşil (ppm-low)
                }
                
                // Durum renklendirme
                let durumColor = 'FFFFFFFF'; // Varsayılan beyaz
                if (r.tedarikcisınıfı === 'D') {
                    durumColor = 'FFF8D7DA'; // Açık kırmızı (status-class-d)
                } else if (r.tedarikcisınıfı === 'C') {
                    durumColor = 'FFFFF3CD'; // Açık sarı (status-class-c)
                } else if (r.status && r.status.toLowerCase().includes('onay')) {
                    durumColor = 'FFD4EDDA'; // Açık yeşil (status-onaylı)
                } else {
                    durumColor = 'FFFFF3CD'; // Açık sarı (status-beklemede)
                }
                
                dataRow.eachCell((cell, colNumber) => {
                    cell.font = { size: 10 };
                    cell.alignment = { 
                        horizontal: (colNumber === 3 || colNumber === 13) ? 'left' : 'center', 
                        vertical: 'middle' 
                    };
                    // Durum sütunu (2. sütun)
                    if (colNumber === 2) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: durumColor }
                        };
                    }
                    // PPM sütunu (9. sütun)
                    else if (colNumber === 9) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: ppmColor }
                        };
                    }
                    // Tedarikçi Sınıfı sütunu (23. sütun - PPM Puanı eklendi)
                    else if (colNumber === 23) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: sınıfColor }
                        };
                    } else {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFFFFFFF' }
                        };
                    }
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                });
            });
            
            // Sütun genişliklerini ayarla
            worksheet.columns = [
                { width: 6 },   // Sıra
                { width: 12 },  // Durum
                { width: 25 },  // Tedarikçi
                { width: 15 },  // Lokasyon
                { width: 12 },  // Dokümanlar
                { width: 15 },  // Toplam Sevkiyat
                { width: 12 },  // Toplam İade
                { width: 12 },  // PPM Hedefi
                { width: 10 },  // PPM
                { width: 12 },  // PPM Puanı
                { width: 12 },  // Hata Hedefi
                { width: 17 },  // Toplam Hata Sayısı
                { width: 12 },  // Hata Puanı
                { width: 35 },  // Kalite Belgeleri
                { width: 17 },  // Kalite Belge Puanı
                { width: 17 },  // VDA/Denetim Puanı
                { width: 15 },  // Talep Edilen 8D
                { width: 15 },  // Cevaplanan 8D
                { width: 15 },  // 8D Dönüş Oranı
                { width: 13 },  // Termin Puanı
                { width: 18 },  // Tamamlanma Puanı
                { width: 16 },  // Tedarikçi Puanı
                { width: 16 }   // Tedarikçi Sınıfı
            ];
            
            // Excel dosyasını oluştur ve indir
            const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
            workbook.xlsx.writeBuffer().then((buffer) => {
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                saveAs(blob, `Onayli_Tedarikciler_${date}.xlsx`);
                showAlert('✅ Excel dosyası profesyonel başlık ve renklendirme ile indirildi!', 'success');
            });
        }

        // ======== Filtre Kaydetme/Yükleme Fonksiyonları ========

        function showSaveFilterDialog() {
            document.getElementById('saveFilterDialog').style.display = 'flex';
            document.getElementById('filterName').value = '';
            document.getElementById('filterName').focus();
        }

        function closeSaveFilterDialog() {
            document.getElementById('saveFilterDialog').style.display = 'none';
        }
        
        // ======== Düzenleme Kaydetme Fonksiyonları ========
        
        function showEditsDialog() {
            document.getElementById('editsDialog').style.display = 'flex';
            document.getElementById('editsName').value = '';
            document.getElementById('editsName').focus();
        }
        
        function closeEditsDialog() {
            document.getElementById('editsDialog').style.display = 'none';
        }
        
        function saveCurrentEdits() {
            const editsName = document.getElementById('editsName').value.trim();
            
            if (!editsName) {
                showAlert('⚠️ Lütfen bir kayıt adı girin!', 'error');
                return;
            }
            
            // IndexedDB'ye kaydet
            saveEditsToIndexedDB(editsName);
        }


        function saveCurrentFilter() {
            const filterName = document.getElementById('filterName').value.trim();
            
            if (!filterName) {
                showAlert('⚠️ Lütfen bir filtre adı girin!', 'error');
                return;
            }

            // Seçili lokasyonları al
            const locationCheckboxes = document.querySelectorAll('#locationOptions input[type="checkbox"]:not([value="__TUMU__"])');
            const selectedLocations = Array.from(locationCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Mevcut filtreyi oluştur
            const filter = {
                id: Date.now(),
                name: filterName,
                searchTerm: document.getElementById('searchInput').value,
                selectedSuppliers: Array.from(selectedSuppliers),
                selectedLocations: selectedLocations,
                timestamp: new Date().toISOString()
            };

            // LocalStorage'dan mevcut filtreleri al
            let savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
            
            // Yeni filtreyi ekle
            savedFilters.push(filter);
            
            // LocalStorage'a kaydet
            localStorage.setItem('supplierFilters', JSON.stringify(savedFilters));
            
            // Dialog'u kapat
            closeSaveFilterDialog();
            
            // Kaydedilmiş filtreleri yeniden yükle
            loadSavedFilters();
            
            showAlert(`✅ "${filterName}" filtresi kaydedildi!`, 'success');
        }

        function loadSavedFilters() {
            const savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
            const filtersList = document.getElementById('savedFiltersList');
            const filtersSection = document.getElementById('savedFiltersSection');
            
            if (savedFilters.length === 0) {
                filtersSection.style.display = 'none';
                return;
            }
            
            filtersSection.style.display = 'block';
            
            let html = '';
            savedFilters.forEach(filter => {
                const isActive = currentFilterId === filter.id ? 'active' : '';
                const date = new Date(filter.timestamp).toLocaleDateString('tr-TR');
                html += `
                    <div class="saved-filter-item ${isActive}" onclick="applyFilter(${filter.id})">
                        <span class="saved-filter-name">${filter.name}</span>
                        <span style="font-size: 0.85em; color: #666;">(${filter.selectedSuppliers.length} tedarikçi)</span>
                        <div class="saved-filter-actions">
                            <button class="saved-filter-edit" onclick="event.stopPropagation(); showEditFilterDialog(${filter.id})" title="Düzenle">
                                ✏️
                            </button>
                            <button class="saved-filter-delete" onclick="event.stopPropagation(); deleteFilter(${filter.id})" title="Sil">
                                ✕
                            </button>
                        </div>
                    </div>
                `;
            });
            
            filtersList.innerHTML = html;
        }

        function applyFilter(filterId) {
            const savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
            const filter = savedFilters.find(f => f.id === filterId);
            
            if (!filter) return;
            
            currentFilterId = filterId;
            
            // Arama terimini uygula
            document.getElementById('searchInput').value = filter.searchTerm || '';

            // Kaydedilmiş tedarikçiler için Set oluştur (hem mapKey hem eski isim uyumu)
            const savedSelections = new Set(filter.selectedSuppliers || []);

            // Tedarikçi seçimlerini temizle ve filtredeki değerleri ekle
            selectedSuppliers.clear();
            
            // Önce filtredeki tüm tedarikçileri ekle (checkbox'lar bulunamasa bile)
            savedSelections.forEach(key => selectedSuppliers.add(key));
            console.log(`📋 Filtreden ${selectedSuppliers.size} tedarikçi yüklendi`);

            // Tedarikçi checkbox'larını güncelle
            const checkboxes = document.querySelectorAll('.multiselect-option:not(.select-all) input[type="checkbox"]');
            console.log(`🔍 applyFilter: ${checkboxes.length} checkbox bulundu`);
            checkboxes.forEach(cb => {
                const supplierName = cb.parentElement.getAttribute('data-supplier');
                const supplierKey = cb.parentElement.getAttribute('data-supplier-key') || supplierName;
                const isChecked = savedSelections.has(supplierKey) || savedSelections.has(supplierName);
                cb.checked = isChecked;
            });
            
            console.log(`✅ applyFilter: ${selectedSuppliers.size} tedarikçi seçildi`);

            // Seçimleri normalize et (geçerlileri tut, geçersizleri sil)
            const beforeNormalize = selectedSuppliers.size;
            normalizeSelectedSuppliers();
            const afterNormalize = selectedSuppliers.size;
            console.log(`🔄 normalizeSelectedSuppliers: ${beforeNormalize} → ${afterNormalize} (${beforeNormalize - afterNormalize} silindi)`);
            
            // Eğer normalize sonrası hiç tedarikçi kalmadıysa, isme göre eşleştirmeyi dene
            if (selectedSuppliers.size === 0 && savedSelections.size > 0) {
                console.log('⚠️ Normalize sonrası boş kaldı, isme göre eşleştiriliyor...');
                
                // allResults içinde filtredeki isimleri ara
                allResults.forEach(supplier => {
                    const supplierKey = supplier.mapKey || supplier.name;
                    const supplierName = supplier.name;
                    
                    // Hem key hem name ile kontrol et
                    if (savedSelections.has(supplierKey) || savedSelections.has(supplierName)) {
                        selectedSuppliers.add(supplierKey);
                    }
                });
                
                console.log(`✅ İsme göre eşleştirme: ${selectedSuppliers.size} tedarikçi bulundu`);
            }
            
            // Lokasyon seçimlerini uygula
            if (filter.selectedLocations) {
                const locationCheckboxes = document.querySelectorAll('#locationOptions input[type="checkbox"]:not([value="__TUMU__"])');
                locationCheckboxes.forEach(cb => {
                    cb.checked = filter.selectedLocations.includes(cb.value);
                });
                
                // "Tümü" checkbox'ını güncelle
                const selectAllLocationCheckbox = document.querySelector('#locationOptions input[value="__TUMU__"]');
                if (selectAllLocationCheckbox) {
                    selectAllLocationCheckbox.checked = filter.selectedLocations.length === locationCheckboxes.length;
                }
                
                // Lokasyon metnini güncelle
                updateLocationFilter();
            }
            
            // "Tümünü Seç" checkbox'ını güncelle
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedSuppliers.size === allResults.length;
            }
            
            // Seçim metnini güncelle
            updateSelectedText();
            
            // Kaydedilmiş filtreleri yeniden render et (aktif durumu göstermek için)
            loadSavedFilters();
            
            // Tabloyu filtrele
            filterTable();
            
            showAlert(`✅ "${filter.name}" filtresi uygulandı!`, 'success');
        }

        function deleteFilter(filterId) {
            if (!confirm('Bu filtreyi silmek istediğinizden emin misiniz?')) {
                return;
            }
            
            let savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
            const filterName = savedFilters.find(f => f.id === filterId)?.name;
            
            // Filtreyi listeden çıkar
            savedFilters = savedFilters.filter(f => f.id !== filterId);
            
            // LocalStorage'ı güncelle
            localStorage.setItem('supplierFilters', JSON.stringify(savedFilters));
            
            // Silinen filtre aktifse, aktif durumu kaldır
            if (currentFilterId === filterId) {
                currentFilterId = null;
            }
            
            // Kaydedilmiş filtreleri yeniden yükle
            loadSavedFilters();
            
            showAlert(`🗑️ "${filterName}" filtresi silindi!`, 'success');
        }

        // ======== Filtre Düzenleme Fonksiyonları ========

        let editingFilterId = null;

        function showEditFilterDialog(filterId) {
            editingFilterId = filterId;
            const savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
            const filter = savedFilters.find(f => f.id === filterId);
            
            if (!filter) return;
            
            // Filtre adını doldur
            document.getElementById('editFilterName').value = filter.name;
            
            // Tedarikçi listesini doldur
            populateEditSupplierList(filter.selectedSuppliers || []);
            normalizeSelectedSuppliers();
            
            // Dialog'u aç
            document.getElementById('editFilterDialog').style.display = 'flex';
            document.getElementById('editFilterName').focus();
        }

        function populateEditSupplierList(selectedSupplierNames) {
            const editSupplierList = document.getElementById('editSupplierList');
            
            let html = `
                <div class="edit-supplier-item" style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0; font-weight: 600;">
                    <input type="checkbox" id="editSelectAll" onchange="toggleEditSelectAll(this)">
                    <label for="editSelectAll">Tümünü Seç / Kaldır</label>
                </div>
            `;
            
            allResults.forEach((result, index) => {
                const supplierKey = result.mapKey || result.name;
                const isChecked = selectedSupplierNames.includes(supplierKey) ? 'checked' : '';
                html += `
                    <div class="edit-supplier-item" data-supplier="${result.name}" data-supplier-key="${supplierKey}">
                        <input type="checkbox" 
                               id="editSupplier_${index}" 
                               ${isChecked}
                               data-supplier="${result.name}" 
                               data-supplier-key="${supplierKey}">
                        <label for="editSupplier_${index}">${result.name}</label>
                    </div>
                `;
            });
            
            editSupplierList.innerHTML = html;
            updateEditSelectAll();
        }

        function toggleEditSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.edit-supplier-item:not(:first-child) input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function updateEditSelectAll() {
            const checkboxes = document.querySelectorAll('.edit-supplier-item:not(:first-child) input[type="checkbox"]');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const selectAllCheckbox = document.getElementById('editSelectAll');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = checkedCount === checkboxes.length;
            }
        }

        function filterEditSupplierList() {
            const searchTerm = document.getElementById('editSupplierSearch').value.toLowerCase();
            const items = document.querySelectorAll('.edit-supplier-item:not(:first-child)');
            
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateFilter() {
            const filterName = document.getElementById('editFilterName').value.trim();
            
            if (!filterName) {
                showAlert('⚠️ Lütfen bir filtre adı girin!', 'error');
                return;
            }

            // Seçili tedarikçileri topla
            const checkboxes = document.querySelectorAll('.edit-supplier-item:not(:first-child) input[type="checkbox"]:checked');
            const selectedSupplierNames = Array.from(checkboxes).map(cb => cb.getAttribute('data-supplier-key') || cb.getAttribute('data-supplier'));

            if (selectedSupplierNames.length === 0) {
                showAlert('⚠️ En az bir tedarikçi seçmelisiniz!', 'error');
                return;
            }

            // Filtreleri güncelle
            let savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
            const filterIndex = savedFilters.findIndex(f => f.id === editingFilterId);
            
            if (filterIndex !== -1) {
                savedFilters[filterIndex].name = filterName;
                savedFilters[filterIndex].selectedSuppliers = selectedSupplierNames;
                savedFilters[filterIndex].timestamp = new Date().toISOString();
                
                // LocalStorage'a kaydet
                localStorage.setItem('supplierFilters', JSON.stringify(savedFilters));
                
                // Dialog'u kapat
                closeEditFilterDialog();
                
                // Kaydedilmiş filtreleri yeniden yükle
                loadSavedFilters();
                
                showAlert(`✅ "${filterName}" filtresi güncellendi!`, 'success');
            }
        }

        function closeEditFilterDialog() {
            document.getElementById('editFilterDialog').style.display = 'none';
            editingFilterId = null;
        }

        // ======== Tam Ekran ========
        function updateFullscreenButton() {
            const btn = document.getElementById('fullscreenBtn');
            if (!btn) return;
            const isFullscreen = !!document.fullscreenElement;
            btn.textContent = isFullscreen ? '🡼 Tam Ekrandan Çık' : '⛶ Tam Ekran';
            btn.setAttribute('aria-pressed', isFullscreen ? 'true' : 'false');
        }

        function toggleFullscreen() {
            const root = document.documentElement;
            if (!document.fullscreenElement) {
                if (root.requestFullscreen) {
                    root.requestFullscreen().catch(() => {
                        showAlert('❌ Tam ekrana geçilemedi!', 'error');
                    });
                } else {
                    showAlert('❌ Tarayıcı tam ekranı desteklemiyor!', 'error');
                }
            } else if (document.exitFullscreen) {
                document.exitFullscreen().catch(() => {
                    showAlert('❌ Tam ekrandan çıkılamadı!', 'error');
                });
            }
        }

        document.addEventListener('fullscreenchange', updateFullscreenButton);

        // ======== Event Listeners ========

        // Enter tuşu ile filtre kaydetme
        document.addEventListener('DOMContentLoaded', async () => {
            updateFullscreenButton();
            
            // Özel belge türlerini yükle
            loadCustomQualityCertTypes();
            
            // Kaydedilmiş filtreleri hemen göster (localStorage'dan)
            loadSavedFilters();
            
            // ARTIK localStorage'dan otomatik yükleme yapmıyoruz
            // Kullanıcı modal üzerinden seçim yapacak
            console.log('📋 Sayfa boş ekranla açıldı, modal açılacak...');
            
            // IndexedDB'yi başlat
            try {
                await initIndexedDB();
                console.log('IndexedDB hazır');
                // Ayarlar butonunda yeşil nokta göster (bağlı)
                updateConnectionIndicator(true);
                
                // Kaydedilmiş sürüm sayısını güncelle
                updateEditsVersionButton();
                
                // 8D rapor sayısını güncelle
                update8DReportCount();
                
                // Modal kontrolü - Storj yüklemesi dışında HER ZAMAN aç
                setTimeout(async () => {
                    // Storj'dan yeni yüklendiyse modal açma (flag kontrol et)
                    const skipFlag = localStorage.getItem('skipAutoModal');
                    if (skipFlag === 'true') {
                        localStorage.removeItem('skipAutoModal');
                        console.log('📊 Storj yüklemesi tamamlandı, modal atlandı');
                        console.log('📊 Tabloda', allResults ? allResults.length : 0, 'tedarikçi yüklü');
                        
                        // 8D sayılarını güncelle
                        if (allResults && allResults.length > 0) {
                            await load8DCountsFromDB();
                        }
                        return;
                    }
                    
                    // İLK YÜKLEME - Modal HER ZAMAN açılsın
                    console.log('📊 İlk yükleme, modal açılıyor...');
                    
                    // Kaydedilmiş sürüm var mı kontrol et
                    const hasVersions = await checkIfVersionsExist();
                    if (hasVersions) {
                        console.log('📊 Kaydedilmiş sürümler bulundu, modal açılıyor...');
                        showEditsHistory();
                    } else {
                        console.log('📊 Hiç kayıt yok, yine de modal açılıyor (Storj/Google Sheets için)...');
                        // Kayıt olmasa da modal aç - kullanıcı Storj veya Google Sheets'ten yükleyebilir
                        showEditsHistory();
                    }
                }, 500);
                
                // Eğer Excel yüklüyse (allResults doluysa), 8D sayılarını güncelle
                setTimeout(async () => {
                    if (allResults && allResults.length > 0) {
                        console.log('📊 Excel yüklü, 8D sayıları güncelleniyor...');
                        await load8DCountsFromDB();
                    }
                }, 1000); // 1 saniye sonra - Excel yüklenme ihtimaline karşı
                
                // Otomatik kayıtları temizle (sadece manuel kayıtlar kalsın)
                await removeAutoSaveRecords();
                
                // URL'de paylaşılan 8D kontrolü
                await checkShared8DInUrl();
            } catch (e) {
                console.error('IndexedDB başlatılamadı:', e);
                showAlert('⚠️ Veri tabanı başlatılamadı, veriler kaydedilemeyebilir!', 'warning');
                // Ayarlar butonunda kırmızı nokta göster (bağlı değil)
                updateConnectionIndicator(false);
            }
            
            // İlk yüklemede tüm durum checkbox'larını seç
            const durumCheckboxes = document.querySelectorAll('#durumOptions input[type="checkbox"]');
            durumCheckboxes.forEach(cb => cb.checked = true);
            updateDurumFilter(true);
            
            const filterNameInput = document.getElementById('filterName');
            if (filterNameInput) {
                filterNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveCurrentFilter();
                    }
                });
            }
            
            // Lokasyon dropdown'ları dışına tıklanınca kapat
            document.addEventListener('click', (e) => {
                if (!e.target.closest('[id^="lokasyonDropdown_"]') && !e.target.closest('button[onclick^="toggleLokasyonDropdown"]')) {
                    document.querySelectorAll('[id^="lokasyonDropdown_"]').forEach(d => d.style.display = 'none');
                }
                
                // Durum dropdown'ını dışına tıklanınca kapat
                if (!e.target.closest('#durumContainer') && !e.target.closest('#selectedDurumlar')) {
                    const durumOptions = document.getElementById('durumOptions');
                    if (durumOptions) durumOptions.style.display = 'none';
                }
            });
            
            // Enter tuşu ile filtre güncelleme
            const editFilterNameInput = document.getElementById('editFilterName');
            if (editFilterNameInput) {
                editFilterNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        updateFilter();
                    }
                });
            }
            
            // Enter tuşu ile düzenlemeleri kaydetme
            const editsNameInput = document.getElementById('editsName');
            if (editsNameInput) {
                editsNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveCurrentEdits();
                    }
                });
            }
            
            // Enter tuşu ile JSON kaydetme
            const jsonSaveNameInput = document.getElementById('jsonSaveName');
            if (jsonSaveNameInput) {
                jsonSaveNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveEditsAsJSON();
                    }
                });
            }
            
            // Sayfa yüklendiğinde sürüm sayısını göster
            updateEditsVersionButton();
            
            // Tedarikçi durum haritasını yükle
            loadSupplierStatusMap();

            // Tedarikçi bilgi haritasını yükle
            loadSupplierInfoMap();
            
            // Kaydedilmiş filtreleri yükle
            loadSavedFilters();
            
            // Kaydedilmiş 8D paylaşım servisini yükle
            const savedService = get8DShareService();
            if (savedService) {
                const serviceRadio = document.querySelector(`input[name="shareService"][value="${savedService}"]`);
                if (serviceRadio) {
                    serviceRadio.checked = true;
                    console.log('✅ Kaydedilmiş 8D servisi yüklendi:', savedService);
                }
            }
            
            // Storj ayarlarını yükle (eğer storj seçiliyse)
            if (savedService === 'storj') {
                setTimeout(() => {
                    toggle8DServiceSettings();
                }, 100);
            }
            
            // Edit checkbox'larda değişiklik olunca selectAll'ı güncelle
            document.addEventListener('change', (e) => {
                if (e.target.matches('.edit-supplier-item:not(:first-child) input[type="checkbox"]')) {
                    updateEditSelectAll();
                }
            });
        });

        // ======== Kayıt Fonksiyonları (IndexedDB) ========

        // Yardımcı fonksiyon: Dizinin tam 12 elemanlı olmasını garanti et
        function ensureArray12(arr, defaultValue = 0) {
            if (!arr || !Array.isArray(arr)) {
                return new Array(12).fill(defaultValue);
            }
            const result = [...arr];
            while (result.length < 12) {
                result.push(defaultValue);
            }
            return result.slice(0, 12);
        }

        // IndexedDB'ye kaydet (sınırsız boyut)
        async function saveEditsToIndexedDB(saveName) {
            if (!saveName || saveName.trim() === '') {
                showAlert('⚠️ Lütfen kaydetme için bir ad girin!', 'error');
                return;
            }
            
            if (!db) {
                showAlert('❌ Veri tabanı hazır değil!', 'error');
                return;
            }

            // TÜM verileri detaylı kaydet
            const allSuppliersData = allResults.map(r => {
                // PPM değerini toplam sevk ve iade'den hesapla (aylık ortalama değil!)
                let ppmValue = 0;
                const totalSevk = r.totalSevk || 0;
                const totalIade = r.totalIade || 0;
                
                if (totalSevk > 0) {
                    ppmValue = (totalIade / totalSevk) * 1000000;
                } else if (r.currentPPM || r.ppm) {
                    // Toplam sevkiyat yoksa mevcut PPM değerini kullan
                    ppmValue = r.currentPPM || r.ppm || 0;
                }
                
                return {
                    name: r.name,
                    mapKey: r.mapKey,
                    status: r.status,
                    iatf: r.iatf ? 1 : 0,
                    iso9001: r.iso9001 ? 1 : 0,
                    iso14001: r.iso14001 ? 1 : 0,
                    iso45001: r.iso45001 ? 1 : 0,
                    td8D: r.talepEdilen8D || 0,
                    cv8D: r.cevaplanan8D || 0,
                    vda: r.vdaPuan || 0,
                    trm: r.terminPuan || 100,
                    tmm: r.tamamlanmaPuan || 100,
                    klt: r.kalitePuan || 0,
                    lok: r.lokasyon ? r.lokasyon.join(',') : '',
                    svk: r.totalSevk || 0,
                    iad: r.totalIade || 0,
                    hta: r.totalHata || 0,
                    ppm: ppmValue, // Hesaplanan PPM değerini kaydet
                    ppmP: r.ppmPuan || 0,
                    htaP: r.hataPuan || 0,
                    d8D: r.donusOrani8D || 0,
                    tpr: r.tedarikcipuani || 0,
                    snf: r.tedarikcisınıfı || '',
                    // Hedefler ve diğer özel veriler - null değerleri koru
                    ppmTarget: r.ppmTarget !== undefined && r.ppmTarget !== null ? r.ppmTarget : null,
                    hataHedefi: r.hataHedefi !== undefined && r.hataHedefi !== null ? r.hataHedefi : null,
                    unknownHata: r.unknownHata || 0,
                    hasKnownHataMonths: r.hasKnownHataMonths || false,
                    // Aylık veriler
                    monthlyPPM: r.monthlyPPM || [],
                    monthlySevk: r.monthlySevk || [],
                    monthlyIade: r.monthlyIade || [],
                    monthlyHata: r.monthlyHata || [],
                    monthlyTermin: r.monthlyTermin || [],
                    monthlyCompletion: r.monthlyCompletion || [],
                    monthlyTerminPuan: ensureArray12(r.monthlyTerminPuan, 100),
                    monthlyTamamlanmaPuan: ensureArray12(r.monthlyTamamlanmaPuan, 100),
                    monthlyKalitePuan: r.monthlyKalitePuan || [],
                    monthlyVdaPuan: r.monthlyVdaPuan || [],
                    monthlyPpmPuan: r.monthlyPpmPuan || []
                };
            });

            // Dokümanları da snapshot'a ekle
            const documentsData = {};
            
            // IndexedDB'den tüm dokümanları al
            const docTransaction = db.transaction([DOC_STORE_NAME], 'readonly');
            const docStore = docTransaction.objectStore(DOC_STORE_NAME);
            const getAllDocsRequest = docStore.getAll();
            
            getAllDocsRequest.onsuccess = () => {
                const allDocs = getAllDocsRequest.result || [];
                
                // Tedarikçi bazında dokümanları grupla
                allDocs.forEach(doc => {
                    if (!documentsData[doc.supplierName]) {
                        documentsData[doc.supplierName] = [];
                    }
                    documentsData[doc.supplierName].push({
                        id: doc.id, // ID'yi de kaydet
                        fileName: doc.fileName,
                        fileType: doc.fileType,
                        docType: doc.docType,
                        fileData: doc.fileData,
                        timestamp: doc.timestamp
                    });
                });
                
                // Kaydedilmiş filtreleri de ekle
                const savedFilters = JSON.parse(localStorage.getItem('supplierFilters') || '[]');
                
                const editsSnapshot = {
                    timestamp: new Date().toISOString(),
                    name: saveName.trim(),
                    data: allSuppliersData,
                    documents: documentsData,
                    savedFilters: savedFilters
                };

                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    
                    // Önce tüm kayıtları al
                    const getAllRequest = objectStore.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const allRecords = getAllRequest.result;
                        
                        // Maksimum 100 kayıt tut
                        if (allRecords.length >= 100) {
                            // En eski kayıtları sil
                            allRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                            const toDelete = allRecords.slice(0, allRecords.length - 99);
                            toDelete.forEach(record => objectStore.delete(record.id));
                        }
                        
                        // Yeni kaydı ekle
                        const addRequest = objectStore.add(editsSnapshot);
                        
                        addRequest.onsuccess = () => {
                            console.log('IndexedDB\'ye kaydedildi, ID:', addRequest.result);
                            
                            // Doküman sayısını logla
                            const docCount = Object.keys(documentsData).length;
                            const totalDocs = Object.values(documentsData).reduce((sum, docs) => sum + docs.length, 0);
                            console.log(`📄 ${docCount} tedarikçi için ${totalDocs} doküman kaydedildi`);
                            
                            updateEditsVersionButton();
                            showAlert(`✅ "${saveName}" IndexedDB'ye kaydedildi! (${allSuppliersData.length} tedarikçi, ${totalDocs} doküman)`, 'success');
                            closeEditsDialog();
                        };
                        
                        addRequest.onerror = () => {
                            console.error('IndexedDB kayıt hatası:', addRequest.error);
                            showAlert('❌ Kaydetme başarısız!', 'error');
                        };
                    };
                    
                    getAllRequest.onerror = () => {
                        console.error('IndexedDB okuma hatası:', getAllRequest.error);
                        showAlert('❌ Veri okunamadı!', 'error');
                    };
                } catch (e) {
                    console.error('IndexedDB error:', e);
                    showAlert('❌ Kaydetme başarısız!', 'error');
                }
            };
            
            getAllDocsRequest.onerror = () => {
                console.error('Doküman okuma hatası:', getAllDocsRequest.error);
                showAlert('❌ Dokümanlar okunamadı!', 'error');
            };
        }

        // Otomatik kayıtları temizle (varsa)
        async function removeAutoSaveRecords() {
            if (!db) return;

            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const getAllRequest = objectStore.getAll();

                await new Promise((resolve, reject) => {
                    getAllRequest.onsuccess = () => {
                        const records = getAllRequest.result || [];
                        const autoRecords = records.filter(r => (r.name || '').toLowerCase().startsWith('otomatik kayıt'));

                        if (autoRecords.length === 0) {
                            resolve();
                            return;
                        }

                        autoRecords.forEach(record => objectStore.delete(record.id));
                        resolve();
                    };

                    getAllRequest.onerror = () => reject(getAllRequest.error);
                });

                updateEditsVersionButton();
            } catch (e) {
                console.error('Otomatik kayıt temizleme hatası:', e);
            }
        }

        function saveEditsToLocalStorage(saveName) {
            // Sadece manuel kayıtlar için kullanılır
            if (!saveName || saveName.trim() === '') {
                return;
            }
            
            // TÜM verileri detaylı kaydet (aylık veriler dahil)
            const allSuppliersData = allResults.map(r => {
                // PPM değerini toplam sevk ve iade'den hesapla (aylık ortalama değil!)
                let ppmValue = 0;
                const totalSevk = r.totalSevk || 0;
                const totalIade = r.totalIade || 0;
                
                if (totalSevk > 0) {
                    ppmValue = (totalIade / totalSevk) * 1000000;
                } else if (r.currentPPM || r.ppm) {
                    // Toplam sevkiyat yoksa mevcut PPM değerini kullan
                    ppmValue = r.currentPPM || r.ppm || 0;
                }
                
                return {
                    name: r.name,
                    mapKey: r.mapKey,
                    status: r.status,
                    // Kalite belgeleri
                    iatf: r.iatf ? 1 : 0,
                    iso9001: r.iso9001 ? 1 : 0,
                    iso14001: r.iso14001 ? 1 : 0,
                    iso45001: r.iso45001 ? 1 : 0,
                    certExpiryDates: r.certExpiryDates || {},
                    // 8D verileri
                    td8D: r.talepEdilen8D || 0,
                    cv8D: r.cevaplanan8D || 0,
                    // Puanlar
                    vda: r.vdaPuan || 0,
                    trm: r.terminPuan || 100,
                    tmm: r.tamamlanmaPuan || 100,
                    klt: r.kalitePuan || 0,
                    // Lokasyon
                    lok: r.lokasyon ? r.lokasyon.join(',') : '',
                    // Excel'den gelen ana metrikler
                    svk: r.totalSevk || 0,
                    iad: r.totalIade || 0,
                    hta: r.totalHata || 0,
                    ppm: ppmValue, // Hesaplanan PPM değerini kaydet
                    ppmP: r.ppmPuan || 0,
                    htaP: r.hataPuan || 0,
                    d8D: r.donusOrani8D || 0,
                    tpr: r.tedarikcipuani || 0,
                    snf: r.tedarikcisınıfı || '',
                    // Aylık veriler - TÜM AYLIK VERİLERİ KAYDET
                    monthlyPPM: r.monthlyPPM || [],
                    monthlySevk: r.monthlySevk || [],
                    monthlyIade: r.monthlyIade || [],
                    monthlyHata: r.monthlyHata || [],
                    monthlyTermin: r.monthlyTermin || [],
                    monthlyCompletion: r.monthlyCompletion || [],
                    monthlyTerminPuan: ensureArray12(r.monthlyTerminPuan, 100),
                    monthlyTamamlanmaPuan: ensureArray12(r.monthlyTamamlanmaPuan, 100),
                    monthlyKalitePuan: r.monthlyKalitePuan || [],
                    monthlyVdaPuan: r.monthlyVdaPuan || [],
                    monthlyPpmPuan: r.monthlyPpmPuan || []
                };
            });

            const editsSnapshot = {
                timestamp: new Date().toISOString(),
                name: saveName.trim(),
                data: allSuppliersData,
                manualMonthlyEdits: manualMonthlyEdits // Manuel düzenlemeleri de kaydet
            };

            // saveName varsa, tam versiyonlama yap
            try {
                // Geçmişi yükle
                let history = JSON.parse(localStorage.getItem('supplierEditsHistory') || '[]');
                
                // Maksimum 5 versiyon tutma (localStorage limitine takılmamak için)
                while (history.length >= 5) {
                    history.shift();
                }
                
                // Yeni versiyonu ekle
                history.push(editsSnapshot);
                
                const historyStr = JSON.stringify(history);
                console.log('Saving history, size:', historyStr.length, 'bytes');
                
                // Ana localStorage'a kaydet
                localStorage.setItem('supplierEditsHistory', historyStr);
                
                updateEditsVersionButton();
                showAlert(`✅ "${saveName}" olarak kaydedildi! (${allSuppliersData.length} tedarikçi)`, 'success');
                
                // Diyaloğu kapat
                closeEditsDialog();
            } catch (e) {
                console.error('LocalStorage error:', e);
                if (e.name === 'QuotaExceededError') {
                    // Eski versiyonları sil ve sadece bu versiyonu kaydet
                    try {
                        localStorage.removeItem('supplierEditsHistory');
                        const singleVersion = JSON.stringify([editsSnapshot]);
                        localStorage.setItem('supplierEditsHistory', singleVersion);
                        updateEditsVersionButton();
                        showAlert(`⚠️ "${saveName}" kaydedildi ancak eski versiyonlar silindi (hafıza doldu)`, 'warning');
                        closeEditsDialog();
                    } catch (e2) {
                        showAlert('❌ Kaydetme başarısız: Veri çok büyük!', 'error');
                    }
                } else {
                    showAlert('❌ Kaydetme başarısız!', 'error');
                }
            }
        }

        function loadSavedEdits(editsSnapshot) {
            if (!editsSnapshot) return;

            try {
                // MANUEL DÜZENLEME İŞARETLERİNİ GERİ YÜKLE
                if (editsSnapshot.manualMonthlyEdits) {
                    manualMonthlyEdits = editsSnapshot.manualMonthlyEdits;
                    console.log('🔄 Manuel düzenleme işaretleri geri yüklendi:', Object.keys(manualMonthlyEdits).length, 'tedarikçi');
                } else {
                    manualMonthlyEdits = {}; // Boş başlat
                }
                
                // KAYDEDİLEN TÜM TEDARİKÇİLERİ YENİDEN YÜKLE
                allResults = editsSnapshot.data.map(savedSupplier => ({
                    // Temel bilgiler
                    name: savedSupplier.name,
                    mapKey: savedSupplier.mapKey || savedSupplier.name,
                    status: savedSupplier.status || 'Onaylı',
                    
                    // Kalite belgeleri
                    iatf: savedSupplier.iatf === 1,
                    iso9001: savedSupplier.iso9001 === 1,
                    iso14001: savedSupplier.iso14001 === 1,
                    iso45001: savedSupplier.iso45001 === 1,
                    certExpiryDates: savedSupplier.certExpiryDates || {},
                    
                    // 8D verileri (kısaltılmış veya tam alan adı)
                    talepEdilen8D: savedSupplier.td8D || savedSupplier.talepEdilen8D || 0,
                    cevaplanan8D: savedSupplier.cv8D || savedSupplier.cevaplanan8D || 0,
                    
                    // Puanlar
                    vdaPuan: savedSupplier.vda || savedSupplier.vdaPuan || 0,
                    terminPuan: savedSupplier.trm || savedSupplier.terminPuan || 100,
                    tamamlanmaPuan: savedSupplier.tmm || savedSupplier.tamamlanmaPuan || 100,
                    kalitePuan: savedSupplier.klt || savedSupplier.kalitePuan || 0,
                    
                    // Lokasyon
                    lokasyon: (savedSupplier.lok || savedSupplier.lokasyon || '').split(',').filter(l => l),
                    
                    // Excel'den gelen veriler
                    totalSevk: savedSupplier.svk || savedSupplier.totalSevk || 0,
                    totalIade: savedSupplier.iad || savedSupplier.totalIade || 0,
                    totalHata: savedSupplier.hta || savedSupplier.totalHata || 0,
                    currentPPM: savedSupplier.ppm || savedSupplier.currentPPM || 0,
                    ppm: savedSupplier.ppm || savedSupplier.currentPPM || 0,
                    ppmPuan: savedSupplier.ppmP || savedSupplier.ppmPuan || 0,
                    hataPuan: savedSupplier.htaP || savedSupplier.hataPuan || 0,
                    donusOrani8D: savedSupplier.d8D || savedSupplier.donusOrani8D || 0,
                    tedarikcipuani: savedSupplier.tpr || savedSupplier.tedarikcipuani || 0,
                    tedarikcisınıfı: savedSupplier.snf || savedSupplier.tedarikcisınıfı || '',
                    
                    // Aylık veriler - kaydedilen tüm aylık verileri yükle (DEEP COPY)
                    monthlySevk: savedSupplier.monthlySevk ? [...savedSupplier.monthlySevk] : [],
                    monthlyIade: savedSupplier.monthlyIade ? [...savedSupplier.monthlyIade] : [],
                    monthlyPPM: savedSupplier.monthlyPPM ? [...savedSupplier.monthlyPPM] : [],
                    monthlyHata: savedSupplier.monthlyHata ? [...savedSupplier.monthlyHata] : [],
                    monthlyTermin: savedSupplier.monthlyTermin ? [...savedSupplier.monthlyTermin] : [],
                    monthlyCompletion: savedSupplier.monthlyCompletion ? [...savedSupplier.monthlyCompletion] : [],
                    
                    // Aylık puanları yükle - ÖNEMLİ! HER TEDARİKÇİ İÇİN YENİ ARRAY OLUŞTUR
                    monthlyTerminPuan: savedSupplier.monthlyTerminPuan ? 
                        [...savedSupplier.monthlyTerminPuan] : 
                        Array.from({length: 12}, () => 100),
                    monthlyTamamlanmaPuan: savedSupplier.monthlyTamamlanmaPuan ? 
                        [...savedSupplier.monthlyTamamlanmaPuan] : 
                        Array.from({length: 12}, () => 100),
                    
                    // Diğer gerekli alanlar - kaydedilen değerleri kullan, null değerleri koru
                    ppmTarget: savedSupplier.ppmTarget !== undefined && savedSupplier.ppmTarget !== null ? savedSupplier.ppmTarget : null,
                    hataHedefi: savedSupplier.hataHedefi !== undefined && savedSupplier.hataHedefi !== null ? savedSupplier.hataHedefi : null,
                    unknownHata: savedSupplier.unknownHata || savedSupplier.unkH || 0,
                    hasKnownHataMonths: savedSupplier.hasKnownHataMonths || savedSupplier.hKHM || false,
                    
                    // Aylık puan array'lerini başlat (eksikse)
                    monthlyKalitePuan: savedSupplier.monthlyKalitePuan ? [...savedSupplier.monthlyKalitePuan] : new Array(12).fill(savedSupplier.klt || savedSupplier.kalitePuan || 0),
                    monthlyVdaPuan: savedSupplier.monthlyVdaPuan ? [...savedSupplier.monthlyVdaPuan] : new Array(12).fill(savedSupplier.vda || savedSupplier.vdaPuan || 0),
                    monthlyPpmPuan: savedSupplier.monthlyPpmPuan ? [...savedSupplier.monthlyPpmPuan] : new Array(12).fill(savedSupplier.ppmP || savedSupplier.ppmPuan || 0),
                    monthlyTerminGecikmeGun: savedSupplier.monthlyTerminGecikmeGun ? [...savedSupplier.monthlyTerminGecikmeGun] : new Array(12).fill(null)
                }));

                console.log(`✅ ${allResults.length} tedarikçi geri yüklendi!`);

                // PPM hedefi ve Hata hedefini localStorage'a da kaydet
                allResults.forEach(supplier => {
                    if (supplier.ppmTarget) {
                        savePPMTargetToStorage(supplier.name, supplier.ppmTarget);
                    }
                    if (supplier.hataHedefi !== undefined) {
                        saveHataHedefiToStorage(supplier.name, supplier.hataHedefi);
                    }
                    
                    // PPM değerini toplam sevkiyat ve toplam iade'den yeniden hesapla
                    // NOT: PPM = (Toplam İade / Toplam Sevkiyat) * 1,000,000
                    const totalSevk = supplier.totalSevk || 0;
                    const totalIade = supplier.totalIade || 0;
                    
                    if (totalSevk > 0) {
                        const calculatedPpm = (totalIade / totalSevk) * 1000000;
                        supplier.currentPPM = calculatedPpm;
                        supplier.ppm = calculatedPpm;
                        console.log(`📊 ${supplier.name}: PPM yeniden hesaplandı: ${calculatedPpm.toFixed(2)} (Sevk: ${totalSevk.toLocaleString()}, İade: ${totalIade.toLocaleString()})`);
                    } else {
                        // Eğer toplam sevkiyat yoksa ama monthlyPPM varsa, ortalama al
                        if (supplier.monthlyPPM && supplier.monthlyPPM.length > 0) {
                            const validMonthlyPPMs = supplier.monthlyPPM.filter(ppm => ppm > 0);
                            if (validMonthlyPPMs.length > 0) {
                                const avgPpm = validMonthlyPPMs.reduce((sum, ppm) => sum + ppm, 0) / validMonthlyPPMs.length;
                                supplier.currentPPM = avgPpm;
                                supplier.ppm = avgPpm;
                                console.log(`⚠️ ${supplier.name}: Toplam sevkiyat yok, aylık ortalamaları kullanıldı: ${avgPpm.toFixed(2)}`);
                            } else {
                                supplier.currentPPM = 0;
                                supplier.ppm = 0;
                            }
                        } else {
                            supplier.currentPPM = 0;
                            supplier.ppm = 0;
                        }
                    }
                    
                    // PPM puanını yeniden hesapla
                    const targetPpm = supplier.ppmTarget || 1000;
                    const monthlyPpm = supplier.ppm;
                    
                    // PPM Puanı hesaplama formülü
                    let ppmPuan = 0;
                    if (monthlyPpm === 0) {
                        ppmPuan = 1; // %100
                    } else if (monthlyPpm <= 0.2 * targetPpm) {
                        ppmPuan = 0.95;
                    } else if (monthlyPpm <= 0.4 * targetPpm) {
                        ppmPuan = 0.9;
                    } else if (monthlyPpm <= 0.6 * targetPpm) {
                        ppmPuan = 0.85;
                    } else if (monthlyPpm <= 0.8 * targetPpm) {
                        ppmPuan = 0.8;
                    } else if (monthlyPpm < 1.2 * targetPpm) {
                        ppmPuan = 0.6;
                    } else {
                        ppmPuan = 0;
                    }
                    supplier.ppmPuan = ppmPuan;
                    
                    // Tedarikçi puanı ve sınıfını yeniden hesapla
                    recalculateSupplierScore(supplier);
                });
                console.log('📊 PPM ve Hata hedefleri localStorage\'a kaydedildi');
                console.log('🔢 PPM değerleri monthlyPPM\'den yeniden hesaplandı');
                console.log('🔢 PPM puanları yeniden hesaplandı');
                console.log('🔢 Tedarikçi puanları ve sınıfları yeniden hesaplandı');

                // DOKÜMANLAR varsa geri yükle
                if (editsSnapshot.documents && db) {
                    try {
                        const docTransaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                        const docStore = docTransaction.objectStore(DOC_STORE_NAME);
                        
                        let docCount = 0;
                        Object.entries(editsSnapshot.documents).forEach(([supplierName, docs]) => {
                            // Eski format kontrolü: Eğer docs doğrudan array değilse, docType bazlı object
                            if (!Array.isArray(docs)) {
                                // Yeni format: { docType: [files] }
                                console.log(`📦 Yeni format tespit edildi: ${supplierName}`);
                                // Bu durumda dokümanlar zaten saveSupplierDocuments ile kaydedilmeli
                                // Burada bir şey yapmaya gerek yok
                                return;
                            }
                            
                            // Eski format: Doğrudan array
                            docs.forEach((doc, index) => {
                                // Gerekli alanları kontrol et
                                if (!doc.fileName || !doc.docType) {
                                    console.warn(`⚠️ Eksik doküman verisi atlanıyor:`, doc);
                                    return;
                                }
                                
                                const docData = {
                                    id: doc.id || `${supplierName}_${doc.fileName}_${doc.timestamp || Date.now()}_${index}`,
                                    supplierName: supplierName,
                                    fileName: doc.fileName,
                                    fileType: doc.fileType || 'application/octet-stream',
                                    docType: doc.docType,
                                    fileData: doc.fileData,
                                    timestamp: doc.timestamp || Date.now()
                                };
                                
                                try {
                                    docStore.put(docData);
                                    docCount++;
                                } catch (err) {
                                    console.error('Doküman ekleme hatası:', err, docData);
                                }
                            });
                        });
                        
                        docTransaction.oncomplete = () => {
                            console.log(`📄 ${docCount} doküman geri yüklendi!`);
                        };
                        
                        docTransaction.onerror = (e) => {
                            console.error('Doküman transaction hatası:', e);
                        };
                    } catch (err) {
                        console.error('Doküman yükleme hatası:', err);
                    }
                }

                // FİLTRELERİ TEMİZLE - Tüm tedarikçileri göster
                lastFilteredResults = allResults;
                
                // SEÇİLİ TEDARİKÇİLERİ GÜNCELLE - Yeni yüklenen tüm tedarikçileri ekle
                selectedSuppliers.clear();
                allResults.forEach(r => selectedSuppliers.add(r.mapKey || r.name));
                console.log(`📋 ${selectedSuppliers.size} tedarikçi seçili`);
                
                // Tedarikçi filtresini yeniden doldur
                populateSupplierFilter();
                
                // KAYDEDİLMİŞ FİLTRELERİ GERİ YÜKLE (snapshot'tan)
                if (editsSnapshot.savedFilters && Array.isArray(editsSnapshot.savedFilters)) {
                    localStorage.setItem('supplierFilters', JSON.stringify(editsSnapshot.savedFilters));
                    console.log(`💾 ${editsSnapshot.savedFilters.length} filtre geri yüklendi!`);
                }
                
                // Kaydedilmiş filtreleri yükle
                loadSavedFilters();
                
                // Arama kutusunu temizle
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.value = '';
                
                // Tabloyu ve dashboard'u yeniden render et (FİLTRESİZ)
                renderTable(allResults);
                updateDashboard(allResults);
                
                // Kontrol butonlarını göster
                const controls = document.getElementById('controls');
                if (controls) {
                    controls.classList.add('active');
                }
                
                // İkinci upload bölümünü göster (termin/tamamlanma butonu için)
                const secondUpload = document.getElementById('secondUploadSection');
                if (secondUpload) {
                    secondUpload.style.display = 'block';
                }
                
                // Doküman sayısını mesajda göster
                const docCount = editsSnapshot.documents ? 
                    Object.values(editsSnapshot.documents).reduce((sum, docs) => sum + docs.length, 0) : 0;
                
                // Başarı mesajı göster
                if (docCount > 0) {
                    showAlert(`✅ "${editsSnapshot.name}" başarıyla yüklendi! (${allResults.length} tedarikçi, ${docCount} doküman)`, 'success');
                } else {
                    showAlert(`✅ "${editsSnapshot.name}" başarıyla yüklendi! (${allResults.length} tedarikçi)`, 'success');
                }
                
                // En güncel sertifika verilerini localStorage'dan yükle (merge)
                loadSupplierCertData();
                
            } catch (e) {
                console.error('Saved edits load error:', e);
                showAlert('❌ Veri yükleme hatası!', 'error');
            }
        }

        function updateEditsVersionButton() {
            if (!db) {
                const btn = document.getElementById('editsVersionBtn');
                if (btn) btn.innerHTML = `📊 Kaydedilen Sürümler (0)`;
                return;
            }
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const getAllRequest = objectStore.getAll();
            
            getAllRequest.onsuccess = () => {
                const records = getAllRequest.result || [];
                const manualCount = records.filter(r => !(r.name || '').toLowerCase().startsWith('otomatik kayıt')).length;
                const btn = document.getElementById('editsVersionBtn');
                if (btn) {
                    btn.innerHTML = `📊 Kaydedilen Sürümler (${manualCount})`;
                }
            };
        }
        
        // İlk açılışta en son kaydedilmiş sürümü otomatik yükle
        async function loadLatestVersionOnStartup() {
            if (!db) return;
            
            // Eğer zaten Excel yüklenmişse, otomatik yükleme yapma
            if (allResults && allResults.length > 0) {
                console.log('ℹ️ Excel zaten yüklü, otomatik yükleme atlanıyor');
                return;
            }
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const getAllRequest = objectStore.getAll();
                
                getAllRequest.onsuccess = () => {
                    const history = getAllRequest.result || [];
                    const manualHistory = history.filter(h => !(h.name || '').toLowerCase().startsWith('otomatik kayıt'));
                    
                    if (manualHistory.length === 0) {
                        console.log('ℹ️ Kaydedilmiş sürüm yok');
                        return;
                    }
                    
                    // En son kaydedileni bul
                    manualHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latest = manualHistory[0];
                    
                    console.log('📥 En son sürüm otomatik yükleniyor:', latest.name);
                    loadSavedEdits(latest);
                    
                    // Bilgilendirme mesajı
                    const date = new Date(latest.timestamp);
                    setTimeout(() => {
                        showAlert(`✅ "${latest.name}" otomatik yüklendi!\n\n📅 Kayıt tarihi: ${date.toLocaleString('tr-TR')}\n📊 ${latest.data.length} tedarikçi`, 'success');
                    }, 500);
                };
                
                getAllRequest.onerror = () => {
                    console.error('❌ Otomatik yükleme hatası:', getAllRequest.error);
                };
            } catch (e) {
                console.error('❌ Otomatik yükleme hatası:', e);
            }
        }
        
        // Kaydedilmiş sürüm var mı kontrol et
        async function checkIfVersionsExist() {
            if (!db) return false;
            
            return new Promise((resolve) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const getAllRequest = objectStore.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const history = getAllRequest.result || [];
                        const manualHistory = history.filter(h => !(h.name || '').toLowerCase().startsWith('otomatik kayıt'));
                        resolve(manualHistory.length > 0);
                    };
                    
                    getAllRequest.onerror = () => {
                        resolve(false);
                    };
                } catch (e) {
                    resolve(false);
                }
            });
        }
        
        async function showEditsHistory() {
            if (!db) {
                showAlert('⚠️ Veri tabanı hazır değil', 'error');
                return;
            }
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const getAllRequest = objectStore.getAll();
            
            getAllRequest.onsuccess = async () => {
                const history = getAllRequest.result || [];
                const manualHistory = history.filter(h => !(h.name || '').toLowerCase().startsWith('otomatik kayıt'));
                
                let html = `<div style="max-width: 900px; max-height: 600px; overflow-y: auto;">`;
                
                // IndexedDB Bölümü
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">💾</span>
                            <div>
                                <div style="font-weight: 700; font-size: 1.2em;">Lokal Kayıtlar (IndexedDB)</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Bu tarayıcıda kayıtlı sürümler</div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (manualHistory.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 30px 20px; color: #666; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                            <div style="font-size: 1em; margin-bottom: 5px;">Lokal kayıt yok</div>
                            <div style="font-size: 0.85em; color: #999;">Manuel kayıt için "💾 Düzenlemeleri Kaydet" butonunu kullanın</div>
                        </div>
                    `;
                } else {
                    // Tarihe göre sırala (en yeni en üstte)
                    manualHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    html += `<div style="margin-bottom: 20px;">`;

                    manualHistory.forEach((snapshot, index) => {
                        const date = new Date(snapshot.timestamp);
                        const timeStr = date.toLocaleString('tr-TR');
                        const saveName = snapshot.name || `Sürüm ${index + 1}`;
                        const dataSize = JSON.stringify(snapshot.data).length;
                        const sizeMB = (dataSize / 1024 / 1024).toFixed(2);

                        html += `
                            <div style="padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e3c72; font-size: 1.05em;">${saveName}</div>
                                        <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${timeStr}</div>
                                        <div style="font-size: 0.8em; color: #999; margin-top: 2px;">Boyut: ${sizeMB} MB | ${snapshot.data.length} tedarikçi</div>
                                    </div>
                                    <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9em; background: #2196f3;" onclick="restoreEditsVersionFromIndexedDB(${snapshot.id})">
                                            ↺ Yükle
                                        </button>
                                        <button class="btn" style="padding: 6px 12px; font-size: 0.9em; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="downloadSnapshotAsJSON(${snapshot.id})">
                                            💾 İndir
                                        </button>
                                        <button class="btn" style="padding: 6px 12px; font-size: 0.9em; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="deleteEditsVersionFromIndexedDB(${snapshot.id})">
                                            🗑 Sil
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                }
                
                // Storj Yedekleri Kontrol ve Bölüm Oluştur
                const settings = getStorjSettings();
                
                // Storj Yedekleri Bölümü Başlığı - HER ZAMAN GÖSTER
                html += `
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0; margin-top: 30px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">☁️</span>
                            <div>
                                <div style="font-weight: 700; font-size: 1.2em;">Bulut Yedekleri (Storj DCS)</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Tüm cihazlarınızdan erişilebilir</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // STORJ AYARLARI YOK - MODAL İÇİNDE AYAR BUTONU GÖSTER
                if (!settings) {
                    html += `
                        <div id="storjBackupsSection" style="padding: 20px; background: #e8f5e9; border-radius: 0 0 8px 8px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 25px; background: white; border-radius: 8px; border: 2px dashed #4caf50;">
                                <div style="font-size: 2em; margin-bottom: 15px;">⚙️</div>
                                <div style="font-weight: 600; color: #2e7d32; margin-bottom: 10px; font-size: 1.2em;">Bulut Yedekleme Yapılandır</div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 20px; line-height: 1.6;">
                                    Tüm cihazlarınızdan erişebileceğiniz bulut yedekleme için<br>
                                    <strong>Storj DCS</strong> ayarlarını yapılandırın
                                </div>
                                <button class="btn btn-primary" onclick="document.getElementById('customAlertModal').remove(); showSettingsDialog();" 
                                        style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%); color: white; padding: 12px 30px; font-size: 1em; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);">
                                    ⚙️ Ayarlar > Veritabanı > Storj DCS
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Bilgi notları
                    html += `
                        <div style="margin-top: 20px; padding: 12px; background: #d1ecf1; border-radius: 5px; border: 1px solid #17a2b8;">
                            <strong>ℹ️ Bilgi:</strong> Lokal kayıtlar sadece bu tarayıcıda saklanır. Storj yedekleri tüm cihazlarınızdan erişilebilir.
                        </div>
                    `;
                    
                    html += `</div>`;

                    // Modal'ı göster
                    showCustomAlert(html, 'Kaydedilmiş Sürümler');
                    
                    return; // Fonksiyonu burada sonlandır
                }
                
                // STORJ AYARLARI VAR - YEDEKLERİ YÜKLE
                html += `<div id="storjBackupsSection" style="padding: 15px; background: #e8f5e9; border-radius: 0 0 8px 8px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 20px; color: #2e7d32;">
                        <div style="font-size: 1.2em; margin-bottom: 10px;">🔄 Storj yedekleri yükleniyor...</div>
                    </div>
                </div>`;
            
                // Bilgi notları
                html += `
                    <div style="margin-top: 20px; padding: 12px; background: #d1ecf1; border-radius: 5px; border: 1px solid #17a2b8;">
                        <strong>ℹ️ Bilgi:</strong> Lokal kayıtlar sadece bu tarayıcıda saklanır. Storj yedekleri tüm cihazlarınızdan erişilebilir.
                    </div>
                `;
                
                html += `</div>`;

                // Modal'ı göster
                showCustomAlert(html, 'Kaydedilmiş Sürümler');
                
                // ASYNC STORJ YÜKLEME - Storj ayarları varsa arka planda yedekleri yükle
                (async () => {
                        try {
                            console.log('🔄 Storj yedekleri yükleniyor...');
                            const backups = await listStorjBackups(settings);
                            console.log('✅ Storj yedekleri yüklendi:', backups.length);
                            
                            let storjHTML = '';
                            if (backups.length === 0) {
                                storjHTML = `
                                    <div style="text-align: center; padding: 30px 20px; color: #666; background: white; border-radius: 8px;">
                                        <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                                        <div style="font-size: 1em; margin-bottom: 5px; color: #2e7d32;">Storj'da yedek yok</div>
                                        <div style="font-size: 0.85em; color: #666;">Ayarlar > Storj DCS > "Veritabanını Yükle" ile yedek oluşturun</div>
                                    </div>
                                `;
                            } else {
                                backups.forEach((backup, index) => {
                                    const rowStyle = index % 2 === 0 ? 'background: white;' : 'background: #f1f8f4;';
                                    storjHTML += `
                                        <div style="padding: 12px; margin: 8px 0; ${rowStyle} border-radius: 8px; border: 1px solid #c8e6c9;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: #2e7d32; font-size: 1.05em;">☁️ ${backup.lastModifiedText}</div>
                                                    <div style="font-size: 0.85em; color: #666; margin-top: 4px;">Boyut: ${backup.sizeText}</div>
                                                    <div style="font-size: 0.75em; color: #999; margin-top: 2px; word-break: break-all;">
                                                        <code style="background: #e8f5e9; padding: 2px 6px; border-radius: 3px;">${backup.key}</code>
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                                    <button class="btn" style="padding: 6px 12px; font-size: 0.9em; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="loadBackupFromList('${backup.key}')">
                                                        📥 Yükle
                                                    </button>
                                                    <button class="btn" style="padding: 6px 12px; font-size: 0.9em; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="deleteBackupFromList('${backup.key}')">
                                                        🗑️ Sil
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                            }
                            
                            // Storj bölümünü güncelle
                            const storjSection = document.getElementById('storjBackupsSection');
                            if (storjSection) {
                                storjSection.innerHTML = storjHTML;
                            }
                            
                        } catch (error) {
                            console.error('❌ Storj yedekleri yüklenemedi:', error);
                            const storjSection = document.getElementById('storjBackupsSection');
                            if (storjSection) {
                                storjSection.innerHTML = `
                                    <div style="text-align: center; padding: 20px; color: #c62828; background: #ffebee; border-radius: 8px;">
                                        <div style="font-size: 1em; margin-bottom: 5px;">❌ Storj bağlantı hatası</div>
                                        <div style="font-size: 0.85em;">${error.message}</div>
                                    </div>
                                `;
                            }
                        }
                    })(); // Async IIFE sonu
            };
            
            getAllRequest.onerror = () => {
                console.error('IndexedDB okuma hatası:', getAllRequest.error);
                showAlert('❌ Veri okunamadı!', 'error');
            };
        }

        function restoreEditsVersionFromIndexedDB(id) {
            if (!db) return;
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const getRequest = objectStore.get(id);
            
            getRequest.onsuccess = () => {
                const snapshot = getRequest.result;
                if (!snapshot) {
                    showAlert('❌ Veri bulunamadı!', 'error');
                    return;
                }
                
                loadSavedEdits(snapshot);
                
                const date = new Date(snapshot.timestamp);
                const saveName = snapshot.name || 'Sürüm';
                showAlert(`✅ "${saveName}" geri yüklendi!`, 'success');
            };
            
            getRequest.onerror = () => {
                console.error('IndexedDB okuma hatası:', getRequest.error);
                showAlert('❌ Veri yüklenemedi!', 'error');
            };
        }
        
        function deleteEditsVersionFromIndexedDB(id) {
            if (!db) return;
            
            if (!confirm('⚠️ Bu sürümü silmek istediğinize emin misiniz?')) {
                return;
            }
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const deleteRequest = objectStore.delete(id);
            
            deleteRequest.onsuccess = () => {
                updateEditsVersionButton();
                showAlert('✅ Sürüm silindi!', 'success');
                
                // Önce mevcut modalı kapat
                const existingModals = document.querySelectorAll('div[style*="z-index: 10000"]');
                existingModals.forEach(modal => modal.remove());
                
                // Kalan sürümleri kontrol et
                const checkTransaction = db.transaction([STORE_NAME], 'readonly');
                const checkStore = checkTransaction.objectStore(STORE_NAME);
                const countRequest = checkStore.count();
                
                countRequest.onsuccess = () => {
                    if (countRequest.result === 0) {
                        // Sürüm kalmadıysa modalı açma
                    } else {
                        // Sürüm varsa listeyi yeniden göster
                        showEditsHistory();
                    }
                };
            };
            
            deleteRequest.onerror = () => {
                console.error('IndexedDB silme hatası:', deleteRequest.error);
                showAlert('❌ Silme başarısız!', 'error');
            };
        }
        
        // JSON olarak indir (yedekleme için)
        function downloadSnapshotAsJSON(id) {
            if (!db) return;
            
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const getRequest = objectStore.get(id);
            
            getRequest.onsuccess = () => {
                const snapshot = getRequest.result;
                if (!snapshot) {
                    showAlert('❌ Veri bulunamadı!', 'error');
                    return;
                }
                
                const dataStr = JSON.stringify(snapshot, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const safeName = (snapshot.name || 'Yedek').replace(/[^a-zA-Z0-9_\- ]/g, '_');
                const dateStr = new Date(snapshot.timestamp).toISOString().split('T')[0];
                a.download = `Tedarikciler_${safeName}_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('✅ JSON dosyası indirildi!', 'success');
            };
            
            getRequest.onerror = () => {
                console.error('IndexedDB okuma hatası:', getRequest.error);
                showAlert('❌ Veri okunamadı!', 'error');
            };
        }
        
        // ======== Ayarlar Dialog Fonksiyonları ========
        
        function updateConnectionIndicator(isConnected) {
            const indicator = document.getElementById('dbConnectionIndicator');
            if (!indicator) return;
            
            if (isConnected) {
                indicator.style.background = '#4caf50'; // Yeşil - Bağlı
                indicator.title = 'IndexedDB Bağlı';
            } else {
                indicator.style.background = '#f44336'; // Kırmızı - Bağlı Değil
                indicator.title = 'IndexedDB Bağlı Değil';
            }
        }
        
        function showSettingsDialog() {
            document.getElementById('settingsDialog').style.display = 'flex';
            refreshDatabaseStats();
            updateSystemInfo();
            
            // JSONBin API Key'i yükle
            const savedApiKey = getJsonBinApiKey();
            const apiKeyInput = document.getElementById('jsonbinApiKey');
            if (apiKeyInput && savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
            
            // Pantry ID'yi yükle
            const savedPantryId = getPantryId();
            const pantryIdInput = document.getElementById('pantryId');
            if (pantryIdInput && savedPantryId) {
                pantryIdInput.value = savedPantryId;
            }
            
            // GitHub Token'ı yükle
            const savedToken = getGitHubToken();
            const tokenInput = document.getElementById('githubToken');
            if (tokenInput && savedToken) {
                tokenInput.value = savedToken;
            }
            
            // Servis seçimini restore et
            const savedService = get8DShareService();
            const serviceRadios = document.querySelectorAll('input[name="shareService"]');
            serviceRadios.forEach(radio => {
                if (radio.value === savedService) {
                    radio.checked = true;
                }
            });
            
            // Varsayılan olarak Pantry seçili olsun (eğer hiç seçim yapılmamışsa)
            if (!savedService) {
                const pantryRadio = document.querySelector('input[name="shareService"][value="pantry"]');
                if (pantryRadio) {
                    pantryRadio.checked = true;
                }
            }
            
            toggle8DServiceSettings();
        }

        // ======== Tedarikçi Değerlendirme Prosedürü ========
        function openEvaluationProcedure() {
            const summaryEl = document.getElementById('evaluationProcedureSummary');
            const tableEl = document.getElementById('evaluationProcedureTable');

            summaryEl.innerHTML = `
                <div class="alert alert-info" style="margin-bottom: 15px;">
                    <div style="font-weight: 700; margin-bottom: 6px;">📌 Tedarikçi Değerlendirme Prosedürü (Ayrıntılı)</div>
                    <div style="font-size: 0.92em; line-height: 1.7;">
                        <div style="margin-bottom: 10px;"><strong>1) Hata Puanı (Hata Hedefi ile)</strong></div>
                        <ul style="margin: 0 0 12px 18px;">
                            <li>Hedef = 0 ise: Hata=0 → 1, Hata>0 → 0</li>
                            <li>Hedef > 0 ise:</li>
                            <li>Hata=0 → 1</li>
                            <li>Hedef/Hata > 1 → 1</li>
                            <li>Aksi halde → Hedef/Hata</li>
                        </ul>

                        <div style="margin-bottom: 10px;"><strong>2) PPM Puanı (PPM Hedefi ile)</strong></div>
                        <ul style="margin: 0 0 12px 18px;">
                            <li>PPM=0 → 1</li>
                            <li>PPM ≤ 0.2×Hedef → 0.95</li>
                            <li>PPM ≤ 0.4×Hedef → 0.90</li>
                            <li>PPM ≤ 0.6×Hedef → 0.85</li>
                            <li>PPM ≤ 0.8×Hedef → 0.80</li>
                            <li>PPM < 1.2×Hedef → 0.60</li>
                            <li>PPM ≥ 1.2×Hedef → 0</li>
                        </ul>

                        <div style="margin-bottom: 10px;"><strong>3) Tedarikçi Puanı Formülü</strong></div>
                        <ul style="margin: 0 0 12px 18px;">
                            <li><strong>VDA > 0 ise:</strong><br>
                                0.20×VDA + 0.05×Kalite + 0.30×PPM + 0.05×8D + 0.20×Termin + 0.10×Tamamlanma + 0.10×Hata
                            </li>
                            <li><strong>VDA = 0 ise:</strong><br>
                                0.05×Kalite + 0.40×PPM + 0.10×8D + 0.20×Termin + 0.10×Tamamlanma + 0.15×Hata
                            </li>
                        </ul>

                        <div style="margin-bottom: 10px;"><strong>4) Sınıflandırma</strong></div>
                        <ul style="margin: 0 0 0 18px;">
                            <li>Skor ≥ 0.90 → <strong>A</strong></li>
                            <li>Skor ≥ 0.80 → <strong>B</strong></li>
                            <li>Skor ≥ 0.60 → <strong>C</strong></li>
                            <li>Skor &lt; 0.60 → <strong>D</strong></li>
                        </ul>
                    </div>
                </div>
            `;

            tableEl.innerHTML = '';

            document.getElementById('evaluationProcedureModal').style.display = 'flex';
        }

        function closeEvaluationProcedure() {
            const modal = document.getElementById('evaluationProcedureModal');
            if (modal) modal.style.display = 'none';
        }
        
        // ======== Tedarikçi Analiz Fonksiyonları ========
        
        function showSupplierAnalysis() {
            const modal = document.getElementById('supplierAnalysisModal');
            const select = document.getElementById('analysisSupplierSelect');
            
            // Seçenekleri temizle ve yeniden doldur
            select.innerHTML = '<option value="">-- Tedarikçi Seçiniz --</option>';
            
            // Tüm tedarikçileri listeye ekle
            allResults.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.name;
                option.textContent = `${supplier.name} (${supplier.status || 'ONAYLI'})`;
                select.appendChild(option);
            });
            
            modal.style.display = 'flex';
        }
        
        function closeSupplierAnalysis() {
            const modal = document.getElementById('supplierAnalysisModal');
            if (modal) modal.style.display = 'none';
            document.getElementById('supplierAnalysisContent').style.display = 'none';
        }
        
        function filterSupplierAnalysisOptions() {
            const searchInput = document.getElementById('analysisSupplierSearch');
            const select = document.getElementById('analysisSupplierSelect');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Seçenekleri temizle
            select.innerHTML = '<option value="">-- Tedarikçi Seçiniz --</option>';
            
            // Filtrelenmiş tedarikçileri ekle
            const filteredSuppliers = allResults.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm)
            );
            
            filteredSuppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.name;
                option.textContent = `${supplier.name} (${supplier.status || 'ONAYLI'})`;
                select.appendChild(option);
            });
            
            // Sonuç sayısını göster
            if (searchTerm && filteredSuppliers.length === 0) {
                const option = document.createElement('option');
                option.textContent = '❌ Sonuç bulunamadı';
                option.disabled = true;
                select.appendChild(option);
            }
        }
        
        // PDF Export Seçenekleri Modal Fonksiyonları
        function showPDFExportOptions() {
            const selectedName = document.getElementById('analysisSupplierSelect').value;
            if (!selectedName) {
                showAlert('⚠️ Lütfen önce bir tedarikçi seçin!', 'error');
                return;
            }
            document.getElementById('pdfExportOptionsModal').style.display = 'flex';
        }
        
        function closePDFExportOptions() {
            document.getElementById('pdfExportOptionsModal').style.display = 'none';
        }
        
        async function exportSupplierAnalysisPDFWithOptions() {
            // Seçenekleri al
            const options = {
                performansMetrikleri: document.getElementById('pdfOpt_performansMetrikleri').checked,
                aylikPerformans: document.getElementById('pdfOpt_aylikPerformans').checked,
                grafikVerileri: document.getElementById('pdfOpt_grafikVerileri').checked,
                kaliteBelgeleri: document.getElementById('pdfOpt_kaliteBelgeleri').checked
            };
            
            // Modal'ı kapat
            closePDFExportOptions();
            
            // PDF'i seçeneklerle oluştur
            await generateDetailedSupplierPDF(options);
        }
        
        async function exportSupplierAnalysisPDF(pdfOptions = null) {
            // Varsayılan seçenekler
            const options = pdfOptions || {
                performansMetrikleri: true,
                aylikPerformans: true,
                grafikVerileri: true,
                kaliteBelgeleri: true
            };
            
            const selectedName = document.getElementById('analysisSupplierSelect').value;
            if (!selectedName) {
                showAlert('⚠️ Lütfen önce bir tedarikçi seçin!', 'error');
                return;
            }
            
            // allResults'tan tedarikçiyi bul
            let supplier = allResults.find(s => s.name === selectedName);
            if (!supplier) {
                showAlert('⚠️ Tedarikçi bulunamadı!', 'error');
                return;
            }
            
            // Güncel dokümanları IndexedDB'den yükle
            try {
                const savedDocuments = await getSupplierDocuments(supplier.name);
                supplier.documents = savedDocuments || { documents: {}, timestamps: {} };
                
                console.log(`📄 PDF için ${supplier.name} dokümanları yüklendi:`, {
                    documentCount: Object.keys(supplier.documents?.documents || {}).length,
                    documents: supplier.documents
                });
            } catch (e) {
                console.error('Dokümanlar yüklenirken hata:', e);
            }
            
            // jsPDF kontrolü
            if (!window.jspdf && !window.jsPDF) {
                showAlert('⚠️ PDF kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }
            
            const jsPDF = window.jspdf?.jsPDF || window.jsPDF;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const margin = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const usableWidth = pageWidth - (2 * margin);
            let yPos = 15;
            
            // Başlık
            doc.setFillColor(103, 58, 183);
            doc.rect(margin, yPos, usableWidth, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('TEDARIKCI DETAYLI ANALIZ RAPORU', pageWidth / 2, yPos + 8, { align: 'center' });
            
            yPos += 15;
            
            // Tedarikçi Adı
            doc.setFillColor(230, 230, 250);
            doc.rect(margin, yPos, usableWidth, 10, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Tedarikci: ${supplier.name}`, margin + 5, yPos + 6.5);
            
            yPos += 13;
            
            // Genel Bilgiler
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(103, 58, 183);
            doc.text('GENEL BILGILER', margin, yPos);
            yPos += 7;
            
            const supplierInfo = getSupplierInfo(supplier.name);
            const generalData = [
                ['Durum', supplier.status || 'ONAYLI'],
                ['Lokasyon', supplier.lokasyon && supplier.lokasyon.length > 0 ? supplier.lokasyon.join(', ') : 'Belirtilmemis'],
                ['Tedarikci Sinifi', supplier.tedarikcisınıfı || '-']
            ];
            
            doc.autoTable({
                startY: yPos,
                body: generalData,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 50, fontStyle: 'bold', fillColor: [240, 240, 240] },
                    1: { cellWidth: 'auto' }
                },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 5;
            
            // Hızlı İletişim Bilgileri (eğer veri varsa)
            if (supplierInfo && (supplierInfo.primaryName || supplierInfo.primaryEmail || supplierInfo.gsm || supplierInfo.type)) {
                doc.setFillColor(240, 249, 255);
                doc.rect(margin, yPos, usableWidth, 25, 'F');
                doc.setDrawColor(66, 165, 245);
                doc.setLineWidth(0.3);
                doc.rect(margin, yPos, usableWidth, 25);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(33, 150, 243);
                doc.text('HIZLI ILETISIM BILGILERI', margin + 3, yPos + 5);
                
                let contactY = yPos + 10;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                if (supplierInfo.primaryName) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Sorumlu:', margin + 3, contactY);
                    doc.setFont('helvetica', 'normal');
                    doc.text(supplierInfo.primaryName, margin + 25, contactY);
                    contactY += 5;
                }
                
                if (supplierInfo.primaryEmail) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('E-posta:', margin + 3, contactY);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(33, 150, 243);
                    doc.text(supplierInfo.primaryEmail, margin + 25, contactY);
                    doc.setTextColor(0, 0, 0);
                    contactY += 5;
                }
                
                if (supplierInfo.gsm) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('GSM:', margin + 3, contactY);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(33, 150, 243);
                    doc.text(supplierInfo.gsm, margin + 25, contactY);
                    doc.setTextColor(0, 0, 0);
                    contactY += 5;
                }
                
                if (supplierInfo.type) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Tip:', margin + 3, contactY);
                    doc.setFont('helvetica', 'normal');
                    doc.text(supplierInfo.type, margin + 25, contactY);
                }
                
                yPos += 28;
            } else {
                yPos += 3;
            }
            
            // Performans Metrikleri
            if (yPos > pageHeight - 60) {
                doc.addPage();
                yPos = 15;
            }
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(103, 58, 183);
            doc.text('PERFORMANS METRIKLERI', margin, yPos);
            yPos += 7;
            
            const performanceData = [
                ['Toplam Sevkiyat', supplier.totalSevk.toLocaleString('tr-TR')],
                ['Toplam Iade', supplier.totalIade.toLocaleString('tr-TR')],
                ['PPM Hedefi', supplier.ppmTarget.toString()],
                ['Mevcut PPM', supplier.ppm.toFixed(2)],
                ['PPM Puani', (supplier.ppmPuan * 100).toFixed(0) + '%'],
                ['Toplam Hata', supplier.totalHata.toString()],
                ['Hata Puani', (supplier.hataPuan * 100).toFixed(0) + '%'],
                ['Tedarikci Puani', ((supplier.tedarikcipuani || 0) * 100).toFixed(0) + '%'],
                ['Kalite Belge Puani', supplier.kalitePuan.toFixed(0) + '%'],
                ['VDA/Denetim Puani', supplier.vdaPuan.toFixed(0) + '%'],
                ['Termin Puani', supplier.terminPuan.toFixed(0) + '%'],
                ['Tamamlanma Puani', supplier.tamamlanmaPuan.toFixed(0) + '%'],
                ['Talep Edilen 8D', (supplier.talepEdilen8D || 0).toString()],
                ['Cevaplanan 8D', (supplier.cevaplanan8D || 0).toString()],
                ['8D Donus Orani', supplier.donusOrani8D.toFixed(0) + '%']
            ];
            
            doc.autoTable({
                startY: yPos,
                body: performanceData,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 50, fontStyle: 'bold', fillColor: [240, 240, 240] },
                    1: { cellWidth: 'auto', halign: 'right' }
                },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 8;
            
            // Aylık Detaylar
            if (yPos > pageHeight - 80) {
                doc.addPage();
                yPos = 15;
            }
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(103, 58, 183);
            doc.text('AYLIK DETAYLAR', margin, yPos);
            yPos += 7;
            
            const months = ['Ocak', 'Subat', 'Mart', 'Nisan', 'Mayis', 'Haziran', 
                          'Temmuz', 'Agustos', 'Eylul', 'Ekim', 'Kasim', 'Aralik'];
            const monthlyData = [];
            
            for (let i = 0; i < 12; i++) {
                const sevk = supplier.monthlySevk[i] || 0;
                const iade = supplier.monthlyIade[i] || 0;
                const hata = supplier.monthlyHata[i] || 0;
                const ppm = supplier.monthlyPPM[i] || 0;
                const ppmTarget = supplier.ppmTarget || 1000;
                
                // PPM puanını hesapla
                let ppmPuan = 0;
                if (ppm === 0) {
                    ppmPuan = 1;
                } else if (ppm <= 0.2 * ppmTarget) {
                    ppmPuan = 0.95;
                } else if (ppm <= 0.4 * ppmTarget) {
                    ppmPuan = 0.9;
                } else if (ppm <= 0.6 * ppmTarget) {
                    ppmPuan = 0.85;
                } else if (ppm <= 0.8 * ppmTarget) {
                    ppmPuan = 0.8;
                } else if (ppm < 1.2 * ppmTarget) {
                    ppmPuan = 0.6;
                } else {
                    ppmPuan = 0;
                }
                
                monthlyData.push([
                    months[i],
                    sevk.toLocaleString('tr-TR'),
                    iade.toLocaleString('tr-TR'),
                    hata.toString(),
                    ppm.toFixed(2),
                    (ppmPuan * 100).toFixed(0) + '%'
                ]);
            }
            
            doc.autoTable({
                startY: yPos,
                head: [['Ay', 'Sevkiyat', 'Iade', 'Hata', 'PPM', 'PPM Puani']],
                body: monthlyData,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [103, 58, 183], textColor: [255, 255, 255], fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 'auto', halign: 'right' },
                    2: { cellWidth: 'auto', halign: 'right' },
                    3: { cellWidth: 'auto', halign: 'right' },
                    4: { cellWidth: 'auto', halign: 'right' },
                    5: { cellWidth: 'auto', halign: 'right' }
                },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 8;
            
            // Kalite Belgeleri
            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(103, 58, 183);
            doc.text('KALITE BELGELERI', margin, yPos);
            yPos += 7;
            
            const belgeler = [];
            qualityCertTypes.forEach(cert => {
                if (supplier[cert.key]) {
                    belgeler.push([cert.label, 'Var']);
                }
            });
            
            if (belgeler.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    body: belgeler,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 50, fontStyle: 'bold' },
                        1: { cellWidth: 'auto', fillColor: [232, 245, 233], textColor: [46, 125, 50] }
                    },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 8;
            } else {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(150, 150, 150);
                doc.text('Kalite belgesi bulunmamaktadir', margin, yPos);
                yPos += 8;
            }
            
            // Yüklenen Dokümanlar
            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(103, 58, 183);
            doc.text('YUKLENEN DOKUMANLAR', margin, yPos);
            yPos += 7;
            
            if (supplier.documents && supplier.documents.documents) {
                const docs = supplier.documents.documents;
                
                // TÜM kategorileri al (dinamik) - TDS, MSDS, ROHS, etc.
                const allCategories = Object.keys(docs).filter(key => Array.isArray(docs[key]) && docs[key].length > 0);
                
                const docList = [];
                let totalDocCount = 0;
                
                allCategories.forEach(catKey => {
                    const docArray = docs[catKey];
                    if (docArray && docArray.length > 0) {
                        totalDocCount += docArray.length;
                        docArray.forEach(docFile => {
                            const sizeKB = (docFile.size / 1024).toFixed(2);
                            const sizeDisplay = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(2)} MB` : `${sizeKB} KB`;
                            docList.push([catKey, docFile.name, sizeDisplay]);
                        });
                    }
                });
                
                if (docList.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['Kategori', 'Dosya Adi', 'Boyut']],
                        body: docList,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [103, 58, 183], textColor: [255, 255, 255], fontStyle: 'bold' },
                        columnStyles: {
                            0: { cellWidth: 40 },
                            1: { cellWidth: 'auto' },
                            2: { cellWidth: 25, halign: 'right' }
                        },
                        margin: { left: margin, right: margin }
                    });
                    yPos = doc.lastAutoTable.finalY + 8;
                } else {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(150, 150, 150);
                    doc.text('Hic dokuman yuklenmemis', margin, yPos);
                    yPos += 8;
                }
            } else {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(150, 150, 150);
                doc.text('Hic dokuman yuklenmemis', margin, yPos);
                yPos += 8;
            }
            
            // Footer
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Sayfa ${i}/${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text(`Olusturulma: ${new Date().toLocaleDateString('tr-TR')}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
            }
            
            // Kaydet
            const fileName = `Tedarikci_Analiz_${supplier.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            showAlert('✅ PDF başarıyla oluşturuldu!', 'success');
        }
        
        async function loadSupplierAnalysis() {
            const selectedName = document.getElementById('analysisSupplierSelect').value;
            if (!selectedName) {
                document.getElementById('supplierAnalysisContent').style.display = 'none';
                return;
            }
            
            // allResults'tan tedarikçiyi bul
            let supplier = allResults.find(s => s.name === selectedName);
            if (!supplier) {
                showAlert('⚠️ Tedarikçi bulunamadı!', 'error');
                return;
            }
            
            // Güncel verileri IndexedDB'den çek ve PPM puanını yeniden hesapla
            try {
                // Dokümanları yeniden yükle
                const savedDocuments = await getSupplierDocuments(supplier.name);
                supplier.documents = savedDocuments || { documents: {}, timestamps: {} };
                
                // Lokasyonu yeniden yükle
                const savedLocation = await getSavedLocation(supplier.name);
                supplier.lokasyon = savedLocation || [];
                
                // İletişim bilgilerini yeniden yükle
                const supplierInfo = getSupplierInfo(supplier.name);
                
                // PPM puanını yeniden hesapla
                const totalSevk = supplier.totalSevk || 0;
                const totalIade = supplier.totalIade || 0;
                const ppm = totalSevk > 0 ? (totalIade / totalSevk) * 1000000 : 0;
                const ppmTarget = supplier.ppmTarget || 1000;
                
                // PPM puanı formülü
                let ppmPuan = 0;
                if (ppm === 0) {
                    ppmPuan = 1;
                } else if (ppm <= 0.2 * ppmTarget) {
                    ppmPuan = 0.95;
                } else if (ppm <= 0.4 * ppmTarget) {
                    ppmPuan = 0.9;
                } else if (ppm <= 0.6 * ppmTarget) {
                    ppmPuan = 0.85;
                } else if (ppm <= 0.8 * ppmTarget) {
                    ppmPuan = 0.8;
                } else if (ppm < 1.2 * ppmTarget) {
                    ppmPuan = 0.6;
                } else {
                    ppmPuan = 0;
                }
                
                // Güncellenmiş değerleri supplier objesine ata
                supplier.ppm = ppm;
                supplier.ppmPuan = ppmPuan;
                
                console.log(`📊 ${supplier.name} için güncel veriler yüklendi:`, {
                    documents: supplier.documents,
                    documentCount: Object.keys(supplier.documents?.documents || {}).length,
                    lokasyon: supplier.lokasyon,
                    totalSevk: supplier.totalSevk,
                    totalIade: supplier.totalIade,
                    ppm: ppm.toFixed(2),
                    ppmTarget: ppmTarget,
                    ppmPuan: (ppmPuan * 100).toFixed(0) + '%',
                    supplierInfo: supplierInfo ? '✅' : '❌'
                });
            } catch (e) {
                console.error('Tedarikçi verileri yüklenirken hata:', e);
            }
            
            document.getElementById('supplierAnalysisContent').style.display = 'block';
            
            // 1. Genel Bilgiler
            displayGeneralInfo(supplier);
            
            // 2. Performans Metrikleri
            displayPerformanceData(supplier);
            
            // 3. Aylık Detaylar
            displayMonthlyData(supplier);
            
            // 4. Performans Grafikleri
            displayPerformanceCharts(supplier);
            
            // 5. Dokümanlar
            displayDocuments(supplier);
            
            // 6. Eksik/Tam Bilgiler
            displayCompleteness(supplier);
        }
        
        function displayGeneralInfo(supplier) {
            const container = document.getElementById('analysisGeneralInfo');
            const status = (supplier.status || 'ONAYLI').toUpperCase();
            const statusColor = status === 'ONAYLI' ? '#4caf50' : status === 'MÜŞTERİ' ? '#2196f3' : '#ff9800';
            const statusIcon = status === 'ONAYLI' ? '✅' : status === 'MÜŞTERİ' ? '👤' : '⚠️';
            
            // Tedarikçi bilgilerini al
            const supplierInfo = getSupplierInfo(supplier.name);
            const hasInfo = supplierInfo && Object.values(supplierInfo).some(v => String(v || '').trim());
            
            // Sadece ✅ (true) değerleri göster
            const infoItems = [];
            
            // Tedarikçi Adı - her zaman göster
            infoItems.push(`
                <div style="padding: 15px; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Tedarikçi Adı</div>
                    <div style="font-size: 1.1em; font-weight: 600; color: #333;">${supplier.name}</div>
                </div>
            `);
            
            // Durum - her zaman göster
            infoItems.push(`
                <div style="padding: 15px; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Durum</div>
                    <div style="font-size: 1.1em; font-weight: 600; color: ${statusColor};">${statusIcon} ${status}</div>
                </div>
            `);
            
            // Lokasyon - sadece varsa
            if (supplier.lokasyon && supplier.lokasyon.length > 0) {
                infoItems.push(`
                    <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Lokasyon</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: #2e7d32;">${supplier.lokasyon.join(', ')}</div>
                    </div>
                `);
            }
            
            // Tedarikçi Sınıfı - sadece varsa
            if (supplier.tedarikcisınıfı) {
                infoItems.push(`
                    <div style="padding: 15px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: 8px; border-left: 4px solid #9c27b0; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Tedarikçi Sınıfı</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: #9c27b0;">${supplier.tedarikcisınıfı}</div>
                    </div>
                `);
            }
            
            // İletişim Bilgileri - sadece varsa
            if (hasInfo) {
                infoItems.push(`
                    <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">İletişim Bilgileri</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: #2e7d32;">✅ Girilmiş</div>
                    </div>
                `);
            }
            
            // Toplam Veri Girişi - sadece varsa
            if (supplier.totalSevk > 0) {
                infoItems.push(`
                    <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Toplam Veri Girişi</div>
                        <div style="font-size: 1.1em; font-weight: 600; color: #2e7d32;">✅ Var</div>
                    </div>
                `);
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${infoItems.join('')}
                </div>
                
                ${supplierInfo && hasInfo ? `
                    <div style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 10px; border-left: 4px solid #2196f3; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h5 style="margin: 0 0 15px 0; color: #1976d2; font-size: 1.05em;">📞 Hızlı İletişim Bilgileri</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.95em;">
                            ${supplierInfo.primaryName ? `<div><strong>Sorumlu:</strong> ${supplierInfo.primaryName}</div>` : ''}
                            ${supplierInfo.primaryEmail ? `<div><strong>E-posta:</strong> <a href="mailto:${supplierInfo.primaryEmail}" style="color: #1976d2;">${supplierInfo.primaryEmail}</a></div>` : ''}
                            ${supplierInfo.gsm ? `<div><strong>GSM:</strong> <a href="tel:${supplierInfo.gsm}" style="color: #1976d2;">${supplierInfo.gsm}</a></div>` : ''}
                            ${supplierInfo.type ? `<div><strong>Tip:</strong> ${supplierInfo.type}</div>` : ''}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function displayPerformanceData(supplier) {
            const container = document.getElementById('analysisPerformanceData');
            
            const ppmColor = supplier.ppm > supplier.ppmTarget * 2 ? '#f44336' : 
                            supplier.ppm > supplier.ppmTarget ? '#ff9800' : '#4caf50';
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #1976d2; margin-bottom: 5px;">Toplam Sevkiyat</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #1565c0;">${supplier.totalSevk.toLocaleString('tr-TR')}</div>
                    </div>
                    <div style="padding: 15px; background: #ffebee; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #d32f2f; margin-bottom: 5px;">Toplam İade</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #c62828;">${supplier.totalIade.toLocaleString('tr-TR')}</div>
                    </div>
                    <div style="padding: 15px; background: #fff3e0; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #e65100; margin-bottom: 5px;">PPM Hedefi</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #ef6c00;">${supplier.ppmTarget}</div>
                    </div>
                    <div style="padding: 15px; background: ${ppmColor}20; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: ${ppmColor}; margin-bottom: 5px;">PPM</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: ${ppmColor};">${supplier.ppm.toFixed(2)}</div>
                    </div>
                    <div style="padding: 15px; background: #f3e5f5; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #7b1fa2; margin-bottom: 5px;">PPM Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #6a1b9a;">${(supplier.ppmPuan * 100).toFixed(0)}%</div>
                    </div>
                    <div style="padding: 15px; background: #ffebee; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #d32f2f; margin-bottom: 5px;">Toplam Hata</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #c62828;">${supplier.totalHata}</div>
                    </div>
                    <div style="padding: 15px; background: #e8f5e9; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #388e3c; margin-bottom: 5px;">Hata Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #2e7d32;">${(supplier.hataPuan * 100).toFixed(0)}%</div>
                    </div>
                    <div style="padding: 15px; background: #e1f5fe; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #0277bd; margin-bottom: 5px;">Tedarikçi Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #01579b;">${(supplier.tedarikcipuani * 100).toFixed(0)}%</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #fce4ec; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #c2185b; margin-bottom: 5px;">Kalite Belge Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #ad1457;">${supplier.kalitePuan.toFixed(0)}%</div>
                    </div>
                    <div style="padding: 15px; background: #f3e5f5; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #7b1fa2; margin-bottom: 5px;">VDA/Denetim Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #6a1b9a;">${supplier.vdaPuan.toFixed(0)}%</div>
                    </div>
                    <div style="padding: 15px; background: #e0f2f1; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #00796b; margin-bottom: 5px;">Termin Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #00695c;">${supplier.terminPuan.toFixed(0)}%</div>
                    </div>
                    <div style="padding: 15px; background: #e8f5e9; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #388e3c; margin-bottom: 5px;">Tamamlanma Puanı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #2e7d32;">${supplier.tamamlanmaPuan.toFixed(0)}%</div>
                    </div>
                    <div style="padding: 15px; background: #fff3e0; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #e65100; margin-bottom: 5px;">Talep Edilen 8D</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #ef6c00;">${supplier.talepEdilen8D || 0}</div>
                    </div>
                    <div style="padding: 15px; background: #e8f5e9; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #388e3c; margin-bottom: 5px;">Cevaplanan 8D</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #2e7d32;">${supplier.cevaplanan8D || 0}</div>
                    </div>
                    <div style="padding: 15px; background: #f3e5f5; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #7b1fa2; margin-bottom: 5px;">8D Dönüş Oranı</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #6a1b9a;">${supplier.donusOrani8D.toFixed(0)}%</div>
                    </div>
                </div>
                
                <!-- Kalite Belgeleri ve Geçerlilik Tarihleri -->
                <div style="margin-top: 20px; background: #fff; border: 2px solid #673ab7; border-radius: 10px; padding: 15px;">
                    <h5 style="margin: 0 0 15px 0; color: #673ab7; font-size: 1em; display: flex; align-items: center; gap: 8px;">
                        <span>📜 Kalite Belgeleri ve Geçerlilik Tarihleri</span>
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        ${qualityCertTypes.map(cert => generateCertificateCard(supplier, cert.key, cert.label, cert.custom ? '#673ab7' : (cert.key === 'iatf' ? '#9c27b0' : cert.key === 'iso9001' ? '#2196f3' : cert.key === 'iso14001' ? '#4caf50' : '#ff9800'))).join('')}
                    </div>
                </div>
            `;
        }
        
        // Sertifika kartı oluşturma fonksiyonu
        function generateCertificateCard(supplier, certKey, certName, color) {
            const hasCert = supplier[certKey];
            const expiryDate = supplier.certExpiryDates?.[certKey];
            const today = new Date();
            let isExpired = false;
            let isExpiringSoon = false;
            let daysLeft = null;
            
            if (expiryDate) {
                const expDate = new Date(expiryDate);
                const diffTime = expDate - today;
                daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                isExpired = daysLeft < 0;
                isExpiringSoon = daysLeft >= 0 && daysLeft <= 30;
            }
            
            const statusColor = !hasCert ? '#9e9e9e' : isExpired ? '#f44336' : isExpiringSoon ? '#ff9800' : '#4caf50';
            const statusIcon = !hasCert ? '✗' : isExpired ? '⚠️' : isExpiringSoon ? '⏰' : '✓';
            const statusText = !hasCert ? 'Yok' : isExpired ? 'SÜRESİ DOLDU' : isExpiringSoon ? `${daysLeft} gün kaldı` : 'Geçerli';
            
            const formattedDate = expiryDate ? new Date(expiryDate).toLocaleDateString('tr-TR') : '-';
            
            return `
                <div style="padding: 12px; background: ${hasCert ? color + '15' : '#f5f5f5'}; border-radius: 8px; border-left: 4px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: ${hasCert ? color : '#999'}; font-size: 0.95em;">${certName}</span>
                        <span style="font-size: 1.2em;">${statusIcon}</span>
                    </div>
                    <div style="font-size: 0.85em; color: #666;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>Durum:</span>
                            <span style="font-weight: 600; color: ${statusColor};">${statusText}</span>
                        </div>
                        ${hasCert ? `
                        <div style="display: flex; justify-content: space-between;">
                            <span>Geçerlilik:</span>
                            <span style="font-weight: 500; color: ${isExpired ? '#f44336' : '#333'};">${formattedDate}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function displayMonthlyData(supplier) {
            const container = document.getElementById('analysisMonthlyData');
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                          'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #673ab7; color: white;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Ay</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Sevkiyat</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">İade</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Hata</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">PPM</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">PPM Puanı</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let i = 0; i < 12; i++) {
                const sevk = supplier.monthlySevk[i] || 0;
                const iade = supplier.monthlyIade[i] || 0;
                const hata = supplier.monthlyHata[i] || 0;
                const ppm = supplier.monthlyPPM[i] || 0;
                const ppmTarget = supplier.ppmTarget || 1000;
                
                // PPM puanını yeniden hesapla
                let ppmPuan = 0;
                if (ppm === 0) {
                    ppmPuan = 1;
                } else if (ppm <= 0.2 * ppmTarget) {
                    ppmPuan = 0.95;
                } else if (ppm <= 0.4 * ppmTarget) {
                    ppmPuan = 0.9;
                } else if (ppm <= 0.6 * ppmTarget) {
                    ppmPuan = 0.85;
                } else if (ppm <= 0.8 * ppmTarget) {
                    ppmPuan = 0.8;
                } else if (ppm < 1.2 * ppmTarget) {
                    ppmPuan = 0.6;
                } else {
                    ppmPuan = 0;
                }
                
                const rowBg = i % 2 === 0 ? '#f9f9f9' : 'white';
                
                tableHTML += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">${months[i]}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${sevk.toLocaleString('tr-TR')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${iade.toLocaleString('tr-TR')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${hata}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${ppm.toFixed(2)}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${(ppmPuan * 100).toFixed(0)}%</td>
                    </tr>
                `;
            }
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        function displayPerformanceCharts(supplier) {
            const container = document.getElementById('analysisPerformanceCharts');
            const months = ['1.Ay', '2.Ay', '3.Ay', '4.Ay', '5.Ay', '6.Ay', '7.Ay', '8.Ay', '9.Ay', '10.Ay', '11.Ay', '12.Ay'];
            const ppmTarget = supplier.ppmTarget || 10000;
            const hataHedefi = supplier.hataHedefi || 2;
            
            // Aylık PPM Puanı hesaplama
            const monthlyPPMScores = Array(12).fill(0).map((_, i) => {
                const ppm = supplier.monthlyPPM?.[i] || 0;
                if (ppm === 0) return 100;
                if (ppm <= ppmTarget / 4) return 100;
                if (ppm <= ppmTarget / 2) return 90;
                if (ppm <= ppmTarget) return 70;
                if (ppm <= ppmTarget * 1.5) return 50;
                if (ppm <= ppmTarget * 2) return 30;
                return 0;
            });
            
            // Aylık Hata Puanı hesaplama
            const monthlyHataScores = Array(12).fill(0).map((_, i) => {
                const hata = supplier.monthlyHata?.[i] || 0;
                if (hata === 0) return 100;
                if (hata <= hataHedefi / 2) return 100;
                if (hata <= hataHedefi) return 80;
                if (hata <= hataHedefi * 2) return 50;
                return 20;
            });
            
            // Aylık Tamamlanma Puanı
            const monthlyTamamlanma = Array(12).fill(0).map((_, i) => supplier.monthlyTamamlanmaPuan?.[i] || 100);
            
            // Aylık Termin Puanı
            const monthlyTermin = Array(12).fill(0).map((_, i) => supplier.monthlyTerminPuan?.[i] || 100);
            
            // Chart verilerini oluştur
            const chartData = [
                { 
                    title: 'AYLIK İADE PPM DEĞİŞİMİ', 
                    data: supplier.monthlyPPM || Array(12).fill(0), 
                    color: '#ff9800', 
                    maxVal: Math.max(...(supplier.monthlyPPM || [0]), ppmTarget) * 1.2, 
                    showTarget: true, 
                    target: ppmTarget,
                    showTable: true,
                    tableId: 'ppmTable',
                    tableData: {
                        sevk: supplier.monthlySevk || Array(12).fill(0),
                        iade: supplier.monthlyIade || Array(12).fill(0)
                    }
                },
                { title: 'AYLIK PPM PUANI', data: monthlyPPMScores, color: '#2196f3', maxVal: 100 },
                { title: 'AYLIK HATA SAYISI', data: supplier.monthlyHata || Array(12).fill(0), color: '#e53935', maxVal: Math.max(...(supplier.monthlyHata || [0]), hataHedefi) + 1 },
                { title: 'HATA PUANI', data: monthlyHataScores, color: '#f4511e', maxVal: 100 },
                { 
                    title: 'TERMİN PUANI', 
                    data: monthlyTermin, 
                    color: '#3949ab', 
                    maxVal: 100,
                    showTable: true,
                    tableId: 'terminTable',
                    tableData: {
                        gun: monthlyTermin.map((puan, idx) => {
                            // Önce gerçek gün değerine bak, yoksa puandan hesapla
                            if (supplier.monthlyTerminGecikmeGun && supplier.monthlyTerminGecikmeGun[idx] !== null && supplier.monthlyTerminGecikmeGun[idx] !== undefined) {
                                return supplier.monthlyTerminGecikmeGun[idx]; // Gerçek değer (eksi günler dahil!)
                            } else {
                                return terminPuanToGecikmeGun(puan); // Puandan hesapla
                            }
                        }),
                        puan: monthlyTermin
                    }
                },
                { 
                    title: 'TAMAMLANMA PUANI', 
                    data: monthlyTamamlanma, 
                    color: '#00796b', 
                    maxVal: 100,
                    showTable: true,
                    tableId: 'tamamlanmaTable',
                    tableData: {
                        puan: monthlyTamamlanma
                    }
                }
            ];
            
            // Sabit değerler
            const staticData = [
                { title: 'VDA PUANI', value: supplier.vdaPuan || 0, color: '#8e24aa' },
                { title: 'KALİTE BELGE PUANI', value: supplier.kalitePuan || 0, color: '#43a047' },
                { title: '8D DÖNÜŞ ORANI', value: supplier.donusOrani8D || 0, color: '#0288d1' }
            ];
            
            let html = `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">`;
            
            // Aylık grafikler (6 adet)
            chartData.forEach((chart, chartIdx) => {
                const maxVal = chart.maxVal || Math.max(...chart.data, 1);
                const hasTable = chart.showTable && chart.tableData;
                
                html += `
                    <div style="background: #fff; border: 2px solid ${chart.color}20; border-radius: 10px; padding: 15px; border-left: 4px solid ${chart.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: ${chart.color}; font-size: 0.95em;">${chart.title}</div>
                            ${hasTable ? `<button onclick="toggleChartTable('${chart.tableId}')" style="padding: 4px 10px; background: ${chart.color}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">📊 Tablo</button>` : ''}
                        </div>
                        <div style="display: flex; align-items: flex-end; height: 100px; gap: 3px; padding: 5px 0; background: #fafafa; border-radius: 5px;">
                            ${chart.data.map((val, idx) => {
                                const height = Math.min(val / maxVal * 100, 100);
                                const displayVal = val >= 1000 ? (val/1000).toFixed(0) + 'k' : val.toFixed(0);
                                return `
                                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                        <div style="font-size: 0.6em; color: #666; margin-bottom: 2px;">${displayVal}</div>
                                        <div style="flex: 1; display: flex; align-items: flex-end; width: 100%;">
                                            <div style="width: 100%; height: ${height}%; background: ${chart.color}; border-radius: 2px 2px 0 0; min-height: 2px;"></div>
                                        </div>
                                        <div style="font-size: 0.55em; color: #999; margin-top: 2px;">${idx+1}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${chart.showTarget ? `<div style="font-size: 0.75em; color: #f44336; margin-top: 5px; text-align: right;">Hedef: ${chart.target.toLocaleString('tr-TR')}</div>` : ''}
                        
                        ${hasTable ? `
                            <div id="${chart.tableId}" style="display: none; margin-top: 15px; overflow-x: auto; animation: fadeIn 0.3s;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.7em;">
                                    <thead>
                                        <tr style="background: ${chart.color}; color: white;">
                                            <th style="padding: 6px; border: 1px solid ${chart.color}; text-align: left; width: 70px;">Veri</th>
                                            ${Array(12).fill(0).map((_, idx) => `<th style="padding: 6px; border: 1px solid ${chart.color}; text-align: center;">${idx + 1}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${chart.tableData.sevk !== undefined ? `
                                            <tr style="background: #fff;">
                                                <td style="padding: 5px; border: 1px solid #ddd; font-weight: 600; background: ${chart.color}20;">Sevk</td>
                                                ${Array(12).fill(0).map((_, idx) => `<td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${(chart.tableData.sevk[idx] || 0).toLocaleString('tr-TR', {maximumFractionDigits: 0})}</td>`).join('')}
                                            </tr>
                                            <tr style="background: #f9f9f9;">
                                                <td style="padding: 5px; border: 1px solid #ddd; font-weight: 600; background: ${chart.color}20;">İade</td>
                                                ${Array(12).fill(0).map((_, idx) => `<td style="padding: 5px; border: 1px solid #ddd; text-align: right;">${(chart.tableData.iade[idx] || 0).toLocaleString('tr-TR', {maximumFractionDigits: 0})}</td>`).join('')}
                                            </tr>
                                        ` : ''}
                                        ${chart.tableData.gun !== undefined ? `
                                            <tr style="background: #fff;">
                                                <td style="padding: 5px; border: 1px solid #ddd; font-weight: 600; background: ${chart.color}20;">Gecikme (gün)</td>
                                                ${Array(12).fill(0).map((_, idx) => {
                                                    const gun = chart.tableData.gun[idx] || 0;
                                                    const gunText = gun > 0 ? `+${Math.round(gun)}` : gun < 0 ? Math.round(gun) : '0';
                                                    const color = gun > 0 ? '#d32f2f' : gun < 0 ? '#388e3c' : '#666';
                                                    return `<td style="padding: 5px; border: 1px solid #ddd; text-align: right; color: ${color}; font-weight: 600;">${gunText}</td>`;
                                                }).join('')}
                                            </tr>
                                        ` : ''}
                                        <tr style="background: ${chart.tableData.gun !== undefined || chart.tableData.sevk !== undefined ? '#f9f9f9' : '#fff'};">
                                            <td style="padding: 5px; border: 1px solid #ddd; font-weight: 600; background: ${chart.color}20;">Puan (%)</td>
                                            ${Array(12).fill(0).map((_, idx) => `<td style="padding: 5px; border: 1px solid #ddd; text-align: right; font-weight: 600;">${(chart.tableData.puan[idx] || 0).toFixed(1)}%</td>`).join('')}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Sabit değerler (3 adet - progress bar)
            html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">`;
            
            staticData.forEach(item => {
                const percentage = Math.min(Math.max(item.value, 0), 100);
                html += `
                    <div style="background: #fff; border: 2px solid ${item.color}20; border-radius: 10px; padding: 15px; border-left: 4px solid ${item.color};">
                        <div style="font-weight: 600; color: ${item.color}; margin-bottom: 10px; font-size: 0.9em;">${item.title}</div>
                        <div style="background: #f0f0f0; border-radius: 10px; height: 25px; overflow: hidden; position: relative;">
                            <div style="background: ${item.color}; height: 100%; width: ${percentage}%; transition: width 0.5s; border-radius: 10px;"></div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; font-size: 0.9em; color: ${percentage > 50 ? '#fff' : '#333'};">${item.value.toFixed(0)}%</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }
        
        // Grafik tablolarını göster/gizle
        function toggleChartTable(tableId) {
            const table = document.getElementById(tableId);
            if (table) {
                if (table.style.display === 'none') {
                    table.style.display = 'block';
                } else {
                    table.style.display = 'none';
                }
            }
        }
        
        function displayDocuments(supplier) {
            const container = document.getElementById('analysisDocuments');
            
            // Tedarikçi Bilgileri
            const supplierInfo = getSupplierInfo(supplier.name);
            let infoHTML = '<h5 style="margin-bottom: 15px; color: #673ab7; border-bottom: 2px solid #673ab7; padding-bottom: 8px;">🧾 Tedarikçi İletişim Bilgileri</h5>';
            
            if (supplierInfo && Object.values(supplierInfo).some(v => String(v || '').trim())) {
                const infoFields = [
                    { label: 'Malzeme(ler)', value: supplierInfo.material },
                    { label: 'Üretici/Satıcı', value: supplierInfo.type },
                    { label: 'Müşteri(ler)', value: supplierInfo.customers },
                    { label: 'Sorumlu Kişi', value: supplierInfo.primaryName },
                    { label: 'Ünvan', value: supplierInfo.title },
                    { label: 'E-posta', value: supplierInfo.primaryEmail },
                    { label: 'GSM', value: supplierInfo.gsm },
                    { label: 'Telefon 2', value: supplierInfo.phone2 },
                    { label: 'Dahili', value: supplierInfo.extension },
                    { label: 'Yedek Kişi', value: supplierInfo.backupName },
                    { label: 'Yedek Ünvan', value: supplierInfo.backupTitle },
                    { label: 'Yedek E-posta', value: supplierInfo.backupEmail },
                    { label: 'Yedek GSM', value: supplierInfo.backupGsm },
                    { label: 'Yedek Telefon 2', value: supplierInfo.backupPhone2 },
                    { label: 'Yedek Dahili', value: supplierInfo.backupExtension },
                    { label: 'Adres', value: supplierInfo.address }
                ];
                
                infoHTML += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">';
                infoFields.forEach(field => {
                    if (field.value && String(field.value).trim()) {
                        const isComplete = true;
                        const icon = isComplete ? '✅' : '❌';
                        infoHTML += `
                            <div style="padding: 10px; background: #f0f9ff; border-left: 3px solid #2196f3; border-radius: 4px;">
                                <div style="font-size: 0.85em; color: #666; margin-bottom: 3px;">${icon} ${field.label}</div>
                                <div style="font-size: 0.95em; font-weight: 500; color: #333; word-break: break-word;">${field.value}</div>
                            </div>
                        `;
                    }
                });
                infoHTML += '</div>';
            } else {
                infoHTML += '<p style="color: #f44336; font-style: italic; padding: 10px; background: #ffebee; border-radius: 4px; border-left: 3px solid #f44336;">❌ Tedarikçi bilgileri girilmemiş</p>';
            }
            
            // Kalite Belgeleri
            const belgeler = [];
            qualityCertTypes.forEach(cert => {
                if (supplier[cert.key]) {
                    const dateStr = supplier.certExpiryDates?.[cert.key] ? ` (${new Date(supplier.certExpiryDates[cert.key]).toLocaleDateString('tr-TR')})` : '';
                    belgeler.push(cert.label + dateStr);
                }
            });
            
            let belgeHTML = '<h5 style="margin-top: 20px; margin-bottom: 15px; color: #673ab7; border-bottom: 2px solid #673ab7; padding-bottom: 8px;">📜 Kalite Belgeleri</h5>';
            
            if (belgeler.length > 0) {
                belgeHTML += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';
                belgeler.forEach(belge => {
                    belgeHTML += `
                        <div style="padding: 10px; background: #e8f5e9; border-left: 3px solid #4caf50; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">✅</span>
                            <span style="font-weight: 500;">${belge}</span>
                        </div>
                    `;
                });
                belgeHTML += '</div>';
            } else {
                belgeHTML += '<p style="color: #f44336; font-style: italic; padding: 10px; background: #ffebee; border-radius: 4px; border-left: 3px solid #f44336;">❌ Kalite belgesi bulunmuyor</p>';
            }
            
            // Yüklenen Dokümanlar ve Gerekli Dokümanlar
            let docHTML = '<h5 style="margin-top: 20px; margin-bottom: 15px; color: #673ab7; border-bottom: 2px solid #673ab7; padding-bottom: 8px;">📁 Doküman Durumu</h5>';
            
            // Tüm gerekli doküman türlerini al
            const requiredDocTypes = getDocumentTypes();
            const exemptDocs = supplier.documents?.exemptDocTypes || [];
            const uploadedDocs = supplier.documents?.documents || {};
            const timestamps = supplier.documents?.timestamps || {};
            
            let docCount = 0;
            let uploadedCount = 0;
            let missingCount = 0;
            let exemptCount = 0;
            let docDetails = '';
            
            console.log('📁 Doküman yapısı kontrol:', supplier.documents);
            
            // Her gerekli doküman türü için kontrol et
            requiredDocTypes.forEach(docType => {
                const docArray = uploadedDocs[docType];
                const hasDoc = docArray && Array.isArray(docArray) && docArray.length > 0;
                const isExempt = exemptDocs.includes(docType);
                
                if (isExempt) {
                    exemptCount++;
                    // Muaf doküman - sarı
                    docDetails += `
                        <div style="margin-bottom: 10px; padding: 10px; background: #fffde7; border-radius: 6px; border-left: 3px solid #ffc107;">
                            <div style="font-weight: 600; color: #f57c00; display: flex; align-items: center; gap: 8px;">
                                <span>⚪</span>
                                <span>${docType}</span>
                                <span style="font-size: 0.8em; font-weight: normal; color: #999; margin-left: auto;">Zorunlu Değil</span>
                            </div>
                        </div>
                    `;
                } else if (hasDoc) {
                    uploadedCount++;
                    docCount += docArray.length;
                    // Yüklü doküman - yeşil
                    docDetails += `
                        <div style="margin-bottom: 10px; padding: 12px; background: #e8f5e9; border-radius: 6px; border-left: 3px solid #4caf50;">
                            <div style="font-weight: 600; color: #2e7d32; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <span>✅</span>
                                <span>${docType}: ${docArray.length} dosya</span>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;
                    docArray.forEach((doc, idx) => {
                        const sizeKB = (doc.size / 1024).toFixed(2);
                        const sizeDisplay = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(2)} MB` : `${sizeKB} KB`;
                        
                        // Doküman durumunu al
                        const docKey = `${docType}_${idx}`;
                        const docTimestamp = timestamps[docKey];
                        let statusColor = '#999';
                        let statusText = 'İncelenmedi';
                        let statusBg = '#f5f5f5';
                        
                        if (docTimestamp) {
                            if (docTimestamp.approved === true) {
                                statusColor = '#4caf50';
                                statusText = '✓ Kabul';
                                statusBg = '#e8f5e9';
                            } else if (docTimestamp.approved === false) {
                                statusColor = '#f44336';
                                statusText = '✗ Ret';
                                statusBg = '#ffebee';
                            } else {
                                statusColor = '#ff9800';
                                statusText = '◐ İnceleniyor';
                                statusBg = '#fff3e0';
                            }
                        }
                        
                        docDetails += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #333;">${doc.name}</div>
                                    <div style="font-size: 0.85em; color: #999; margin-top: 2px;">${sizeDisplay}</div>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center; margin-left: 15px; flex-wrap: wrap;">
                                    <div style="padding: 4px 12px; background: ${statusBg}; color: ${statusColor}; border-radius: 4px; font-size: 0.85em; font-weight: 600; white-space: nowrap;">
                                        ${statusText}
                                    </div>
                                    <input type="date" id="analysisDocDate_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}" style="padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em;" title="Tarih seçin (boş bırakırsanız bugün)" />
                                    <select onchange="updateDocumentStatus('${supplier.name}', '${docType}', ${idx}, this.value, document.getElementById('analysisDocDate_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}').value)" 
                                            style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; cursor: pointer;">
                                        <option value="">Durum Seç</option>
                                        <option value="approved" ${docTimestamp && docTimestamp.approved === true ? 'selected' : ''}>✓ Kabul</option>
                                        <option value="reviewing" ${docTimestamp && docTimestamp.approved === undefined ? 'selected' : ''}>◐ İnceleniyor</option>
                                        <option value="rejected" ${docTimestamp && docTimestamp.approved === false ? 'selected' : ''}>✗ Ret</option>
                                    </select>
                                </div>
                            </div>
                        `;
                    });
                    docDetails += `</div></div>`;
                } else {
                    missingCount++;
                    // Eksik doküman - kırmızı
                    docDetails += `
                        <div style="margin-bottom: 10px; padding: 10px; background: #ffebee; border-radius: 6px; border-left: 3px solid #f44336;">
                            <div style="font-weight: 600; color: #c62828; display: flex; align-items: center; gap: 8px;">
                                <span>❌</span>
                                <span>${docType}</span>
                                <span style="font-size: 0.8em; font-weight: normal; color: #e57373; margin-left: auto;">Yüklenmemiş</span>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Özet bilgi
            const totalRequired = requiredDocTypes.length - exemptCount;
            const completionRate = totalRequired > 0 ? Math.round((uploadedCount / totalRequired) * 100) : 100;
            const completionColor = completionRate >= 80 ? '#4caf50' : completionRate >= 50 ? '#ff9800' : '#f44336';
            
            docHTML += `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="padding: 12px; background: #e8f5e9; border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;">${uploadedCount}</div>
                        <div style="font-size: 0.8em; color: #666;">Yüklendi</div>
                    </div>
                    <div style="padding: 12px; background: #ffebee; border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #f44336;">${missingCount}</div>
                        <div style="font-size: 0.8em; color: #666;">Eksik</div>
                    </div>
                    <div style="padding: 12px; background: #fffde7; border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #ffc107;">${exemptCount}</div>
                        <div style="font-size: 0.8em; color: #666;">Muaf</div>
                    </div>
                    <div style="padding: 12px; background: linear-gradient(135deg, ${completionColor}22, ${completionColor}11); border-radius: 6px; text-align: center; border: 2px solid ${completionColor};">
                        <div style="font-size: 1.5em; font-weight: bold; color: ${completionColor};">%${completionRate}</div>
                        <div style="font-size: 0.8em; color: #666;">Tamamlanma</div>
                    </div>
                </div>
            `;
            
            docHTML += docDetails;
            
            container.innerHTML = infoHTML + belgeHTML + docHTML;
        }
        
        // Doküman durumunu güncelle
        async function updateDocumentStatus(supplierName, category, docIndex, status, customDate) {
            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                return;
            }
            
            try {
                // Mevcut dokümanları al
                const currentDocs = await getSupplierDocuments(supplierName);
                
                if (!currentDocs || !currentDocs.documents) {
                    showAlert('⚠️ Doküman bulunamadı!', 'error');
                    return;
                }
                
                // Timestamp yapısını oluştur veya güncelle
                if (!currentDocs.timestamps) {
                    currentDocs.timestamps = {};
                }
                
                const docKey = `${category}_${docIndex}`;
                // Tarih girilmişse kullan, yoksa bugünün tarihini kullan
                const selectedDate = customDate ? new Date(customDate + 'T12:00:00').toISOString() : new Date().toISOString();
                
                // Durum güncelle
                if (status === 'approved') {
                    currentDocs.timestamps[docKey] = {
                        approved: true,
                        date: selectedDate,
                        by: 'Müşteri PC' // Gerçek kullanıcı bilgisi eklenebilir
                    };
                } else if (status === 'rejected') {
                    currentDocs.timestamps[docKey] = {
                        approved: false,
                        date: selectedDate,
                        by: 'Müşteri PC'
                    };
                } else if (status === 'reviewing') {
                    currentDocs.timestamps[docKey] = {
                        approved: undefined,
                        date: selectedDate,
                        by: 'Müşteri PC'
                    };
                } else {
                    // Durum temizle
                    delete currentDocs.timestamps[docKey];
                }
                
                // Dosyanın status alanını da güncelle (tedarikçi görünümü için)
                if (currentDocs.documents[category] && currentDocs.documents[category][docIndex]) {
                    currentDocs.documents[category][docIndex].status = status;
                    currentDocs.documents[category][docIndex].reviewedAt = selectedDate;
                }
                
                // Veritabanına kaydet
                await saveSupplierDocuments(supplierName, currentDocs);
                
                // Ekranı yenile
                const selectedName = document.getElementById('analysisSupplierSelect').value;
                if (selectedName === supplierName) {
                    await loadSupplierAnalysis();
                }
                
                // Başarı mesajı
                const statusNames = {
                    'approved': 'Kabul edildi',
                    'rejected': 'Ret edildi',
                    'reviewing': 'İnceleniyor olarak işaretlendi',
                    '': 'Durumu temizlendi'
                };
                showAlert(`✅ Doküman ${statusNames[status] || 'güncellendi'}`, 'success');
                
            } catch (error) {
                console.error('Durum güncelleme hatası:', error);
                showAlert('❌ Durum güncellenemedi: ' + error.message, 'error');
            }
        }
        
        // Doküman için müşteri yorumu güncelle
        async function updateDocumentReviewComment(supplierName, docType, fileIndex, comment) {
            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                return;
            }
            
            try {
                // Mevcut dokümanları al
                const currentDocs = await getSupplierDocuments(supplierName);
                
                if (!currentDocs || !currentDocs.documents || !currentDocs.documents[docType]) {
                    showAlert('⚠️ Doküman bulunamadı!', 'error');
                    return;
                }
                
                const files = currentDocs.documents[docType];
                if (!files[fileIndex]) {
                    showAlert('⚠️ Dosya bulunamadı!', 'error');
                    return;
                }
                
                // Yorumu güncelle
                files[fileIndex].reviewComment = comment;
                files[fileIndex].reviewedAt = new Date().toISOString();
                
                // Veritabanına kaydet
                await saveSupplierDocuments(supplierName, currentDocs);
                
                console.log(`✅ Müşteri yorumu kaydedildi: "${comment}"`);
                
            } catch (error) {
                console.error('Yorum güncelleme hatası:', error);
                showAlert('❌ Yorum kaydedilemedi: ' + error.message, 'error');
            }
        }
        
        function displayCompleteness(supplier) {
            const container = document.getElementById('analysisCompleteness');
            
            // Tedarikçi bilgilerini kontrol et
            const supplierInfo = getSupplierInfo(supplier.name);
            const hasBasicInfo = supplierInfo && Object.values(supplierInfo).some(v => String(v || '').trim());
            const hasContactInfo = supplierInfo && (supplierInfo.primaryEmail || supplierInfo.gsm || supplierInfo.phone2);
            const hasBackupContact = supplierInfo && (supplierInfo.backupName || supplierInfo.backupEmail || supplierInfo.backupGsm);
            
            // Doküman kontrolü
            let hasDocuments = false;
            let docsByCertificate = {
                iso9001: false,
                iatf16949: false,
                iso14001: false,
                iso45001: false,
                other: false
            };
            
            if (supplier.documents && supplier.documents.documents) {
                const docs = supplier.documents.documents;
                hasDocuments = Object.values(docs).some(arr => arr && arr.length > 0);
                docsByCertificate.iso9001 = docs.iso9001 && docs.iso9001.length > 0;
                docsByCertificate.iatf16949 = docs.iatf16949 && docs.iatf16949.length > 0;
                docsByCertificate.iso14001 = docs.iso14001 && docs.iso14001.length > 0;
                docsByCertificate.iso45001 = docs.iso45001 && docs.iso45001.length > 0;
                docsByCertificate.other = docs.diger && docs.diger.length > 0;
            }
            
            const checks = [
                // Temel Bilgiler
                { category: 'Temel Bilgiler', label: 'Lokasyon Bilgisi', value: supplier.lokasyon && supplier.lokasyon.length > 0, detail: supplier.lokasyon ? supplier.lokasyon.join(', ') : 'Belirtilmemiş' },
                { category: 'Temel Bilgiler', label: 'Tedarikçi İletişim Bilgileri', value: hasBasicInfo, detail: hasBasicInfo ? 'Girilmiş' : 'Girilmemiş' },
                { category: 'Temel Bilgiler', label: 'İletişim (Email/Tel)', value: hasContactInfo, detail: hasContactInfo ? 'Var' : 'Yok' },
                { category: 'Temel Bilgiler', label: 'Yedek İletişim', value: hasBackupContact, detail: hasBackupContact ? 'Var' : 'Yok' },
                
                // Hedefler
                { category: 'Hedefler', label: 'PPM Hedefi Tanımlı', value: supplier.ppmTarget > 0, detail: supplier.ppmTarget > 0 ? supplier.ppmTarget : 'Tanımlanmamış' },
                { category: 'Hedefler', label: 'Hata Hedefi Tanımlı', value: supplier.hataHedefi > 0, detail: supplier.hataHedefi > 0 ? supplier.hataHedefi : 'Tanımlanmamış' },
                
                // Veriler
                { category: 'Performans Verileri', label: 'Sevkiyat Verisi', value: supplier.totalSevk > 0, detail: supplier.totalSevk > 0 ? supplier.totalSevk.toLocaleString('tr-TR') : '0' },
                { category: 'Performans Verileri', label: 'İade Verisi', value: supplier.totalIade > 0, detail: supplier.totalIade.toLocaleString('tr-TR') },
                { category: 'Performans Verileri', label: 'Hata Verisi', value: supplier.totalHata > 0, detail: supplier.totalHata.toString() },
                { category: 'Performans Verileri', label: '8D Rapor Verisi', value: true, detail: `${supplier.cevaplanan8D || 0}/${supplier.talepEdilen8D || 0}` },
                
                // Belgeler
                { category: 'Belgeler', label: 'Kalite Belgesi', value: supplier.iso9001 || supplier.iatf || supplier.iso14001 || supplier.iso45001, detail: [supplier.iso9001 && 'ISO 9001', supplier.iatf && 'IATF', supplier.iso14001 && 'ISO 14001', supplier.iso45001 && 'ISO 45001'].filter(Boolean).join(', ') || 'Yok' },
                { category: 'Belgeler', label: 'ISO 9001 Dokümanı', value: docsByCertificate.iso9001, detail: docsByCertificate.iso9001 ? 'Yüklenmiş' : 'Yüklenmemiş' },
                { category: 'Belgeler', label: 'IATF 16949 Dokümanı', value: docsByCertificate.iatf16949, detail: docsByCertificate.iatf16949 ? 'Yüklenmiş' : 'Yüklenmemiş' },
                { category: 'Belgeler', label: 'ISO 14001 Dokümanı', value: docsByCertificate.iso14001, detail: docsByCertificate.iso14001 ? 'Yüklenmiş' : 'Yüklenmemiş' },
                { category: 'Belgeler', label: 'ISO 45001 Dokümanı', value: docsByCertificate.iso45001, detail: docsByCertificate.iso45001 ? 'Yüklenmiş' : 'Yüklenmemiş' },
                { category: 'Belgeler', label: 'Diğer Dokümanlar', value: docsByCertificate.other, detail: docsByCertificate.other ? 'Var' : 'Yok' },
                
                // Puanlar
                { category: 'Puanlama', label: 'VDA/Denetim Puanı', value: supplier.vdaPuan > 0, detail: supplier.vdaPuan > 0 ? `${supplier.vdaPuan.toFixed(0)}%` : 'Girilmemiş' },
                { category: 'Puanlama', label: 'Termin Puanı', value: supplier.terminPuan >= 0, detail: `${supplier.terminPuan.toFixed(0)}%` },
                { category: 'Puanlama', label: 'Tamamlanma Puanı', value: supplier.tamamlanmaPuan >= 0, detail: `${supplier.tamamlanmaPuan.toFixed(0)}%` }
            ];
            
            let html = ``;
            
            // Kategorilere göre grupla
            const categories = ['Temel Bilgiler', 'Hedefler', 'Performans Verileri', 'Belgeler', 'Puanlama'];
            
            categories.forEach(category => {
                let categoryChecks = checks.filter(c => c.category === category);
                
                // Belgeler kategorisinde sadece TRUE olanları göster
                if (category === 'Belgeler') {
                    categoryChecks = categoryChecks.filter(c => c.value);
                }
                
                // Eğer kategori boşsa gösterme
                if (categoryChecks.length === 0) return;
                
                const categoryCompleted = categoryChecks.filter(c => c.value).length;
                const categoryTotal = categoryChecks.length;
                const categoryPercentage = (categoryCompleted / categoryTotal * 100).toFixed(0);
                
                html += `
                    <div style="margin-bottom: 25px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5 style="margin: 0; color: #673ab7; font-size: 1.1em;">${category}</h5>
                            <span style="font-weight: 600; color: #673ab7; font-size: 1.05em;">${categoryCompleted}/${categoryTotal} (${categoryPercentage}%)</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                `;
                
                categoryChecks.forEach(check => {
                    const icon = check.value ? '✅' : '❌';
                    const color = check.value ? '#4caf50' : '#f44336';
                    const bgColor = check.value ? '#e8f5e9' : '#ffebee';
                    
                    html += `
                        <div style="padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${color}; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <span style="font-size: 1.2em;">${icon}</span>
                                <span style="font-weight: 500; color: #333;">${check.label}</span>
                            </div>
                            <span style="color: #666; font-size: 0.9em; font-style: italic; text-align: right; max-width: 40%;">${check.detail}</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // Bu fonksiyon showPDFExportOptions ile çağrılacak (ana PDF export fonksiyonu)
        // İlk fonksiyon basit rapor için, bu fonksiyon detaylı rapor için kullanılıyor
        // exportSupplierAnalysisPDFWithOptions() bu fonksiyonu çağırır
        
        // Asıl detaylı PDF export (tedarikçi analiz modalından)
        async function generateDetailedSupplierPDF(pdfOptions = null) {
            // Varsayılan seçenekler
            const options = pdfOptions || {
                performansMetrikleri: true,
                aylikPerformans: true,
                grafikVerileri: true,
                kaliteBelgeleri: true
            };
            
            const selectedName = document.getElementById('analysisSupplierSelect').value;
            if (!selectedName) {
                showAlert('⚠️ Lütfen bir tedarikçi seçin!', 'error');
                return;
            }
            
            let supplier = allResults.find(s => s.name === selectedName);
            if (!supplier) return;
            
            // Dönem ve tarih bilgilerini kullanıcıdan al
            const currentYear = new Date().getFullYear();
            const periodYear = prompt('Dönem (Yıl):', currentYear.toString());
            if (!periodYear) {
                showAlert('⚠️ Dönem yılı girilmedi, işlem iptal edildi.', 'error');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            const reportDateInput = prompt('Rapor Tarihi (GG.AA.YYYY):', new Date().toLocaleDateString('tr-TR'));
            if (!reportDateInput) {
                showAlert('⚠️ Rapor tarihi girilmedi, işlem iptal edildi.', 'error');
                return;
            }
            
            // jsPDF kontrolü
            if (!window.jspdf && !window.jsPDF) {
                showAlert('⚠️ PDF kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }
            
            // Güncel verileri yükle
            try {
                const savedDocuments = await getSupplierDocuments(supplier.name);
                supplier.documents = savedDocuments || { documents: {}, timestamps: {} };
                
                const savedLocation = await getSavedLocation(supplier.name);
                supplier.lokasyon = savedLocation || [];
            } catch (e) {
                console.error('Veri yükleme hatası:', e);
            }
            
            const jsPDF = window.jspdf?.jsPDF || window.jsPDF;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 12;
            const contentWidth = pageWidth - (2 * margin);
            
            // Türkçe karakter çevrimi için yardımcı fonksiyon
            const turkishToAscii = (text) => {
                if (!text) return '';
                return String(text)
                    .replace(/İ/g, 'I')
                    .replace(/ı/g, 'i')
                    .replace(/Ş/g, 'S')
                    .replace(/ş/g, 's')
                    .replace(/Ğ/g, 'G')
                    .replace(/ğ/g, 'g')
                    .replace(/Ü/g, 'U')
                    .replace(/ü/g, 'u')
                    .replace(/Ö/g, 'O')
                    .replace(/ö/g, 'o')
                    .replace(/Ç/g, 'C')
                    .replace(/ç/g, 'c');
            };
            
            // Font ayarları
            doc.setFont('helvetica');
            
            // ===== KAPAK SAYFASI - MODERN TASARIM =====
            // Gradient benzeri arka plan (mavi tonları)
            doc.setFillColor(25, 118, 210);
            doc.rect(0, 0, pageWidth, pageHeight * 0.65, 'F');
            doc.setFillColor(21, 101, 192);
            doc.rect(0, pageHeight * 0.65, pageWidth, pageHeight * 0.35, 'F');
            
            // Logo yükleme fonksiyonu
            const loadLogoAsBase64 = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = function() {
                        reject(new Error('Logo yüklenemedi: ' + src));
                    };
                    img.src = src;
                });
            };
            
            // 4 Firma Logosunu assets klasöründen yükle ve ekle
            const companyLogos = ['logo1.png', 'corefix_logo.png', 'logo2.png', 'saniteks_logo.png'];
            const logoSize = 18;
            const logoSpacingX = 5;
            const totalLogosWidth = (companyLogos.length * logoSize) + ((companyLogos.length - 1) * logoSpacingX);
            const logosStartX = (pageWidth - totalLogosWidth) / 2;
            const logosY = 35;
            
            // Beyaz arka plan kutusu logolar için
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(logosStartX - 4, logosY - 3, totalLogosWidth + 8, logoSize + 6, 3, 3, 'F');
            
            // Her logo için ayrı ayrı yükleme ve ekleme
            for (let i = 0; i < companyLogos.length; i++) {
                const logoX = logosStartX + (i * (logoSize + logoSpacingX));
                try {
                    const logoImg = await loadLogoAsBase64('assets/' + companyLogos[i]);
                    doc.addImage(logoImg, 'PNG', logoX, logosY, logoSize, logoSize);
                } catch (e) {
                    // Logo yüklenemezse placeholder
                    doc.setFillColor(200, 200, 200);
                    doc.rect(logoX, logosY, logoSize, logoSize, 'F');
                }
            }
            
            // Ana başlık
            doc.setFontSize(28);
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('TEDARIKCI PERFORMANS'), pageWidth / 2, 105, { align: 'center' });
            doc.text(turkishToAscii('ANALIZ RAPORU'), pageWidth / 2, 118, { align: 'center' });
            
            // Dekoratif çizgi
            doc.setDrawColor(76, 175, 80);
            doc.setLineWidth(2);
            doc.line(50, 128, pageWidth - 50, 128);
            
            // Tedarikçi adı kutusu
            doc.setFillColor(255, 255, 255, 0.15);
            doc.roundedRect(25, 140, pageWidth - 50, 35, 5, 5, 'F');
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            const supplierNameLines = doc.splitTextToSize(turkishToAscii(supplier.name), contentWidth - 20);
            let nameY = 155;
            supplierNameLines.forEach((line, idx) => {
                if (idx < 2) { // Max 2 satır
                    doc.text(line, pageWidth / 2, nameY + (idx * 10), { align: 'center' });
                }
            });
            
            // Durum ve tarih bilgisi
            const status = (supplier.status || 'ONAYLI').toUpperCase();
            let statusText = status === 'ONAYLI' ? turkishToAscii('ONAYLI TEDARIKCI') : turkishToAscii(status);
            
            // Durum badge
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(pageWidth / 2 - 35, 185, 70, 12, 3, 3, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(statusText, pageWidth / 2, 193, { align: 'center' });
            
            // Dönem bilgisi
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('Donem: ' + periodYear), pageWidth / 2, 210, { align: 'center' });
            
            // Tarih
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(turkishToAscii('Rapor Tarihi: ' + reportDateInput), pageWidth / 2, 225, { align: 'center' });
            
            
            // Alt bilgi kutusu
            doc.setFillColor(255, 255, 255, 0.1);
            doc.roundedRect(20, pageHeight - 35, pageWidth - 40, 22, 4, 4, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text(turkishToAscii('Tedarikci Performans Yonetim Sistemi'), pageWidth / 2, pageHeight - 26, { align: 'center' });
            doc.setFontSize(8);
            doc.text(turkishToAscii(periodYear + ' - Bu rapor otomatik olusturulmustur'), pageWidth / 2, pageHeight - 18, { align: 'center' });
            
            // ===== SAYFA 2: TÜM VERİLER KOMPAKT =====
            doc.addPage();
            doc.setTextColor(0, 0, 0);
            let y = 15;
            
            // ---- GENEL BİLGİLER VE İLETİŞİM (yan yana) ----
            doc.setFillColor(25, 118, 210);
            doc.rect(margin, y, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('GENEL BILGILER & ILETISIM'), margin + 3, y + 5.5);
            y += 12;
            doc.setTextColor(0, 0, 0);
            
            // Sol: Genel bilgiler, Sağ: İletişim
            const leftColWidth = contentWidth / 2 - 2;
            const rightColX = margin + leftColWidth + 4;
            
            // Genel bilgiler (sol)
            const generalData = [];
            generalData.push([turkishToAscii('Tedarikci'), turkishToAscii(supplier.name.substring(0, 30))]);
            generalData.push(['Durum', statusText]);
            if (supplier.tedarikcisınıfı) generalData.push([turkishToAscii('Sinif'), turkishToAscii(supplier.tedarikcisınıfı)]);
            if (supplier.lokasyon && supplier.lokasyon.length > 0) generalData.push(['Lokasyon', turkishToAscii(supplier.lokasyon.join(', ').substring(0, 25))]);
            
            doc.autoTable({
                startY: y,
                body: generalData,
                theme: 'plain',
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 25 }, 1: { cellWidth: leftColWidth - 27 } },
                margin: { left: margin, right: rightColX },
                tableWidth: leftColWidth
            });
            
            // İletişim bilgileri (sağ)
            const supplierInfo = getSupplierInfo(supplier.name);
            const contactData = [];
            if (supplierInfo) {
                if (supplierInfo.primaryName) contactData.push([turkishToAscii('Kisi'), turkishToAscii(supplierInfo.primaryName.substring(0, 20))]);
                if (supplierInfo.primaryEmail) contactData.push(['E-posta', supplierInfo.primaryEmail.substring(0, 25)]);
                if (supplierInfo.gsm) contactData.push(['GSM', supplierInfo.gsm]);
                if (supplierInfo.material) contactData.push([turkishToAscii('Malzeme'), turkishToAscii(supplierInfo.material.substring(0, 20))]);
            }
            
            if (contactData.length > 0) {
                doc.autoTable({
                    startY: y,
                    body: contactData,
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: { 0: { fontStyle: 'bold', cellWidth: 22 }, 1: { cellWidth: leftColWidth - 24 } },
                    margin: { left: rightColX },
                    tableWidth: leftColWidth
                });
            }
            
            y = Math.max(doc.lastAutoTable?.finalY || y, y) + 8;
            
            // ---- PERFORMANS METRİKLERİ (kompakt grid) ----
            if (options.performansMetrikleri) {
            doc.setFillColor(76, 175, 80);
            doc.rect(margin, y, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('PERFORMANS METRIKLERI (' + periodYear + ')'), margin + 3, y + 5.5);
            y += 12;
            doc.setTextColor(0, 0, 0);
            
            // Metrikler 3 sütunlu grid
            const metrics = [
                ['Sevkiyat', supplier.totalSevk.toLocaleString('tr-TR')],
                [turkishToAscii('Iade'), supplier.totalIade.toLocaleString('tr-TR')],
                ['Hata', supplier.totalHata.toString()],
                ['PPM', supplier.ppm.toFixed(2)],
                ['PPM Hedef', supplier.ppmTarget.toString()],
                ['PPM Puan', (supplier.ppmPuan * 100).toFixed(0) + '%'],
                ['Hata Puan', (supplier.hataPuan * 100).toFixed(0) + '%'],
                [turkishToAscii('Ted. Puani'), (supplier.tedarikcipuani * 100).toFixed(0) + '%'],
                ['Kalite Puan', supplier.kalitePuan.toFixed(0) + '%'],
                ['VDA Puan', supplier.vdaPuan.toFixed(0) + '%'],
                ['Termin Puan', supplier.terminPuan.toFixed(0) + '%'],
                ['8D Oran', supplier.donusOrani8D.toFixed(0) + '%']
            ];
            
            const colWidth = contentWidth / 3;
            const rowHeight = 14;
            let col = 0, row = 0;
            
            metrics.forEach((m, idx) => {
                const x = margin + (col * colWidth);
                const boxY = y + (row * rowHeight);
                
                // Kutu arka planı
                const bgColors = [[232, 245, 233], [255, 243, 224], [232, 234, 246]];
                const bg = bgColors[col % 3];
                doc.setFillColor(bg[0], bg[1], bg[2]);
                doc.roundedRect(x, boxY, colWidth - 2, rowHeight - 2, 2, 2, 'F');
                
                // Etiket
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(m[0], x + 3, boxY + 5);
                
                // Değer
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(m[1], x + 3, boxY + 11);
                
                col++;
                if (col >= 3) { col = 0; row++; }
            });
            
            y += Math.ceil(metrics.length / 3) * rowHeight + 8;
            } // PERFORMANS METRİKLERİ sonu
            
            // ---- AYLIK VERİLER (kompakt tablo) ----
            if (options.aylikPerformans) {
            doc.setFillColor(103, 58, 183);
            doc.rect(margin, y, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10)
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('AYLIK PERFORMANS (' + periodYear + ')'), margin + 3, y + 5.5);
            y += 10;
            
            const months = ['Oca', 'Sub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Agu', 'Eyl', 'Eki', 'Kas', 'Ara'];
            const monthlyData = months.map((month, i) => [
                month,
                (supplier.monthlySevk[i] || 0).toLocaleString('tr-TR'),
                (supplier.monthlyIade[i] || 0).toString(),
                (supplier.monthlyHata[i] || 0).toString(),
                (supplier.monthlyPPM[i] || 0).toFixed(1)
            ]);
            
            doc.autoTable({
                startY: y,
                head: [['Ay', 'Sevk', turkishToAscii('Iade'), 'Hata', 'PPM']],
                body: monthlyData,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1.5, halign: 'center' },
                headStyles: { fillColor: [103, 58, 183], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 7 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 12 } },
                margin: { left: margin, right: margin }
            });
            
            y = doc.lastAutoTable.finalY + 8;
            } // AYLIK VERİLER sonu
            
            // ---- GRAFİK VERİLERİ ----
            if (options.grafikVerileri) {
            // Sayfa kontrolü
            if (y > pageHeight - 120) {
                doc.addPage();
                y = 15;
            }
            
            // Seçili ayları al
            const selectedMonthsArray = Array.from(selectedMonths).sort((a, b) => a - b);
            const selectedMonthsText = selectedMonthsArray.length === 12 ? 'Tum Aylar' : 
                selectedMonthsArray.map(m => m.toString()).join(', ');
            
            doc.setFillColor(0, 150, 136);
            doc.rect(margin, y, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('PERFORMANS GRAFIK VERILERI (' + periodYear + ')'), margin + 3, y + 5.5);
            // Seçili ayları sağda göster
            doc.setFontSize(7);
            doc.text(turkishToAscii('Secili Aylar: ' + selectedMonthsText), margin + contentWidth - 3, y + 5.5, { align: 'right' });
            y += 12;
            doc.setTextColor(0, 0, 0);
            
            // Grafik verilerini hesapla
            const ppmTarget = supplier.ppmTarget || 10000;
            const hataHedefi = supplier.hataHedefi || 2;
            const months = ['Oca', 'Sub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Agu', 'Eyl', 'Eki', 'Kas', 'Ara'];
            
            // Aylık PPM Puanı hesaplama
            const monthlyPPMScores = months.map((_, i) => {
                const ppm = supplier.monthlyPPM[i] || 0;
                if (ppm === 0) return 100;
                if (ppm <= ppmTarget / 4) return 100;
                if (ppm <= ppmTarget / 2) return 90;
                if (ppm <= ppmTarget) return 70;
                if (ppm <= ppmTarget * 1.5) return 50;
                if (ppm <= ppmTarget * 2) return 30;
                return 0;
            });
            
            // Aylık Hata Puanı hesaplama
            const monthlyHataScores = months.map((_, i) => {
                const hata = supplier.monthlyHata[i] || 0;
                if (hata === 0) return 100;
                if (hata <= hataHedefi / 2) return 100;
                if (hata <= hataHedefi) return 80;
                if (hata <= hataHedefi * 2) return 50;
                return 20;
            });
            
            // Aylık Tamamlanma Puanı (varsa kullan, yoksa 100)
            const monthlyTamamlanma = months.map((_, i) => supplier.monthlyTamamlanmaPuan?.[i] || 100);
            
            // Mini bar chart çizim fonksiyonu (geliştirilmiş)
            const drawMiniBarChart = (chartX, chartY, chartWidth, chartHeight, data, title, color, maxVal, showTarget, targetVal) => {
                // Başlık kutusu
                doc.setFillColor(color[0], color[1], color[2]);
                doc.roundedRect(chartX, chartY, chartWidth, 8, 1, 1, 'F');
                doc.setFontSize(6);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(turkishToAscii(title), chartX + 2, chartY + 5);
                
                // Hedef değeri başlık sağında göster
                if (showTarget && targetVal) {
                    const targetText = 'Hedef: ' + (targetVal >= 1000 ? (targetVal/1000).toFixed(1) + 'k' : targetVal.toString());
                    doc.setFontSize(5);
                    doc.text(turkishToAscii(targetText), chartX + chartWidth - 2, chartY + 5, { align: 'right' });
                }
                
                const graphY = chartY + 10;
                const graphH = chartHeight - 12;
                
                // Grafik arka planı
                doc.setFillColor(255, 255, 255);
                doc.rect(chartX, graphY, chartWidth, graphH, 'F');
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.rect(chartX, graphY, chartWidth, graphH, 'S');
                
                // Y ekseni çizgileri (yatay grid)
                doc.setDrawColor(240, 240, 240);
                for (let i = 1; i <= 4; i++) {
                    const lineY = graphY + (graphH / 5) * i;
                    doc.line(chartX, lineY, chartX + chartWidth, lineY);
                }
                
                // Barları çiz
                const barPadding = 2;
                const barWidth = (chartWidth - barPadding * 2) / data.length - 1;
                const maxValue = maxVal || Math.max(...data, 1);
                
                data.forEach((val, idx) => {
                    const monthNum = idx + 1; // 1-12 arası ay numarası
                    const isSelected = selectedMonths.has(monthNum);
                    
                    // Bar yüksekliğini sınırla (grafik içinde kalmalı)
                    const normalizedVal = Math.min(val, maxValue);
                    const barHeight = Math.max(1, (normalizedVal / maxValue) * (graphH - 4));
                    const barX = chartX + barPadding + idx * (barWidth + 1);
                    const barY = graphY + graphH - 2 - barHeight;
                    
                    // Seçili aylar normal renk, seçili olmayanlar soluk
                    if (isSelected) {
                        doc.setFillColor(color[0], color[1], color[2]);
                    } else {
                        // Soluk gri renk
                        doc.setFillColor(200, 200, 200);
                    }
                    doc.rect(barX, barY, barWidth, barHeight, 'F');
                    
                    // Değer etiketi (bar üstünde) - sadece seçili aylar için koyu renk
                    if (barWidth > 4) {
                        doc.setFontSize(4);
                        doc.setTextColor(isSelected ? 60 : 180, isSelected ? 60 : 180, isSelected ? 60 : 180);
                        const valText = val >= 1000 ? (val/1000).toFixed(0) + 'k' : val.toFixed(0);
                        doc.text(valText, barX + barWidth/2, barY - 1, { align: 'center' });
                    }
                });
                
                // Hedef çizgisi (opsiyonel) - grafik sınırları içinde tut
                if (showTarget && targetVal) {
                    // Hedef değeri maxValue'dan büyükse, çizgiyi grafik üst sınırına çiz
                    const clampedTarget = Math.min(targetVal, maxValue * 0.95);
                    const targetY = graphY + graphH - 2 - ((clampedTarget / maxValue) * (graphH - 4));
                    // Çizginin grafik içinde kalmasını sağla
                    const safeTargetY = Math.max(graphY + 2, Math.min(targetY, graphY + graphH - 4));
                    
                    doc.setDrawColor(220, 50, 50);
                    doc.setLineWidth(0.4);
                    doc.setLineDashPattern([1.5, 1], 0);
                    doc.line(chartX + 2, safeTargetY, chartX + chartWidth - 2, safeTargetY);
                    doc.setLineDashPattern([], 0);
                }
                
                // Ay numaraları (grafik altında)
                doc.setFontSize(3.5);
                doc.setTextColor(100, 100, 100);
                data.forEach((val, idx) => {
                    const barX = chartX + barPadding + idx * (barWidth + 1);
                    doc.text((idx + 1).toString(), barX + barWidth/2, graphY + graphH + 3, { align: 'center' });
                });
            };
            
            // Sabit değer bar chart (yatay progress bar)
            const drawStaticBar = (chartX, chartY, chartWidth, chartHeight, value, title, color) => {
                // Başlık kutusu
                doc.setFillColor(color[0], color[1], color[2]);
                doc.roundedRect(chartX, chartY, chartWidth, 6, 1, 1, 'F');
                doc.setFontSize(6);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(turkishToAscii(title), chartX + 2, chartY + 4.5);
                
                const barY = chartY + 8;
                const barH = chartHeight - 10;
                
                // Arka plan
                doc.setFillColor(245, 245, 245);
                doc.rect(chartX, barY, chartWidth, barH, 'F');
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.3);
                doc.rect(chartX, barY, chartWidth, barH, 'S');
                
                // Progress bar
                const progressWidth = Math.max(0, Math.min(value, 100)) / 100 * (chartWidth - 4);
                doc.setFillColor(color[0], color[1], color[2]);
                doc.rect(chartX + 2, barY + 2, progressWidth, barH - 4, 'F');
                
                // Değer etiketi
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(value > 50 ? 255 : 0, value > 50 ? 255 : 0, value > 50 ? 255 : 0);
                doc.text(value.toFixed(0) + '%', chartX + chartWidth / 2, barY + barH / 2 + 2, { align: 'center' });
            };
            
            // 3x3 grid düzeninde 9 grafik
            const chartW = (contentWidth - 8) / 2;
            const chartH = 28;
            const chartSpacing = 4;
            
            // PPM verilerinin max değeri
            const maxPPM = Math.max(...(supplier.monthlyPPM || [0]), ppmTarget) * 1.2;
            const maxHata = Math.max(...(supplier.monthlyHata || [0]), hataHedefi) + 1;
            
            // Satır 1: PPM Değişimi ve PPM Puanı
            drawMiniBarChart(margin, y, chartW, chartH, supplier.monthlyPPM || Array(12).fill(0), 'AYLIK IADE PPM DEGISIMI', [255, 152, 0], maxPPM, true, ppmTarget);
            drawMiniBarChart(margin + chartW + chartSpacing, y, chartW, chartH, monthlyPPMScores, 'AYLIK PPM PUANI', [33, 150, 243], 100, false);
            y += chartH + 10;
            
            // Satır 2: Hata Sayısı ve Hata Puanı
            drawMiniBarChart(margin, y, chartW, chartH, supplier.monthlyHata || Array(12).fill(0), 'AYLIK HATA SAYISI', [229, 57, 53], maxHata, false);
            drawMiniBarChart(margin + chartW + chartSpacing, y, chartW, chartH, monthlyHataScores, 'HATA PUANI', [244, 81, 30], 100, false);
            y += chartH + 10;
            
            // Satır 3: Termin Puanı ve Tamamlanma Puanı
            drawMiniBarChart(margin, y, chartW, chartH, supplier.monthlyTerminPuan || Array(12).fill(100), 'TERMIN PUANI', [57, 73, 171], 100, false);
            drawMiniBarChart(margin + chartW + chartSpacing, y, chartW, chartH, monthlyTamamlanma, 'TAMAMLANMA PUANI', [0, 121, 107], 100, false);
            y += chartH + 10;
            
            // Satır 4: Sabit değerler (VDA, Kalite, 8D) - 3 adet yatay progress bar
            const staticW = (contentWidth - 8) / 3;
            const staticH = 18;
            
            drawStaticBar(margin, y, staticW, staticH, supplier.vdaPuan || 0, 'VDA PUANI', [142, 36, 170]);
            drawStaticBar(margin + staticW + 4, y, staticW, staticH, supplier.kalitePuan || 0, 'KALITE BELGE PUANI', [67, 160, 71]);
            drawStaticBar(margin + (staticW + 4) * 2, y, staticW, staticH, supplier.donusOrani8D || 0, '8D DONUS ORANI', [2, 136, 209]);
            
            y += staticH + 8;
            } // GRAFİK VERİLERİ sonu
            
            // ---- KALİTE BELGELERİ VE DOKÜMANLAR ----
            if (options.kaliteBelgeleri) {
            // Sayfa kontrolü
            if (y > pageHeight - 80) {
                doc.addPage();
                y = 15;
            }
            
            doc.setFillColor(255, 152, 0);
            doc.rect(margin, y, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(turkishToAscii('KALITE BELGELERI & DOKUMANLAR'), margin + 3, y + 5.5);
            y += 12;
            doc.setTextColor(0, 0, 0);
            
            // Kalite belgeleri (yatay düzen) - Geçerlilik tarihleriyle
            const certs = qualityCertTypes.map(cert => ({
                name: cert.label,
                key: cert.key,
                has: supplier[cert.key]
            }));
            
            const certWidth = contentWidth / 4;
            const today = new Date();
            
            certs.forEach((cert, idx) => {
                const x = margin + (idx * certWidth);
                const expiryDate = supplier.certExpiryDates?.[cert.key];
                let isExpired = false;
                let isExpiringSoon = false;
                
                if (expiryDate) {
                    const expDate = new Date(expiryDate);
                    const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    isExpired = diffDays < 0;
                    isExpiringSoon = diffDays >= 0 && diffDays <= 30;
                }
                
                // Arka plan rengi
                let bgColor = [255, 235, 238]; // Yok - kırmızı tonlu
                if (cert.has) {
                    if (isExpired) {
                        bgColor = [255, 205, 210]; // Süresi dolmuş - kırmızı
                    } else if (isExpiringSoon) {
                        bgColor = [255, 243, 224]; // Yakında dolacak - turuncu
                    } else {
                        bgColor = [232, 245, 233]; // Geçerli - yeşil
                    }
                }
                
                doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
                doc.roundedRect(x, y, certWidth - 2, 18, 2, 2, 'F');
                
                // Belge adı
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                const textColor = cert.has ? (isExpired ? [198, 40, 40] : isExpiringSoon ? [230, 81, 0] : [46, 125, 50]) : [198, 40, 40];
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(`${cert.has ? (isExpired ? '!' : '✓') : '✗'} ${cert.name}`, x + 3, y + 6);
                
                // Geçerlilik tarihi
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                if (cert.has && expiryDate) {
                    const formattedDate = new Date(expiryDate).toLocaleDateString('tr-TR');
                    const statusText = isExpired ? 'SURESI DOLDU' : isExpiringSoon ? 'Yaklasıyor' : 'Gecerli';
                    doc.text(turkishToAscii(`${formattedDate}`), x + 3, y + 12);
                    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                    doc.text(turkishToAscii(statusText), x + 3, y + 16);
                } else if (cert.has) {
                    doc.text('Tarih girilmedi', x + 3, y + 12);
                } else {
                    doc.text('Belge yok', x + 3, y + 12);
                }
            });
            
            y += 22;
            
            // Doküman durumu - tüm gerekli dokümanlar
            const requiredDocTypes = getDocumentTypes();
            const exemptDocs = supplier.documents?.exemptDocTypes || [];
            const uploadedDocs = supplier.documents?.documents || {};
            const timestamps = supplier.documents?.timestamps || {};
            
            let uploadedCount = 0;
            let missingCount = 0;
            let exemptCount = 0;
            const docTableData = [];
            
            // Her gerekli doküman türü için kontrol et
            requiredDocTypes.forEach(docType => {
                const docArray = uploadedDocs[docType];
                const hasDoc = docArray && Array.isArray(docArray) && docArray.length > 0;
                const isExempt = exemptDocs.includes(docType);
                
                if (isExempt) {
                    exemptCount++;
                    docTableData.push([
                        turkishToAscii(docType),
                        '-',
                        '-',
                        turkishToAscii('Muaf')
                    ]);
                } else if (hasDoc) {
                    uploadedCount++;
                    docArray.forEach((doc, idx) => {
                        const sizeKB = (doc.size / 1024).toFixed(1);
                        const docKey = `${docType}_${idx}`;
                        const docTimestamp = timestamps[docKey];
                        let statusText = turkishToAscii('Incelenmedi');
                        
                        if (docTimestamp) {
                            if (docTimestamp.approved === true) statusText = turkishToAscii('Kabul');
                            else if (docTimestamp.approved === false) statusText = 'RET';
                            else statusText = turkishToAscii('Bekleme');
                            
                            if (docTimestamp.date) {
                                const dateStr = new Date(docTimestamp.date).toLocaleDateString('tr-TR');
                                statusText += ` (${dateStr})`;
                            }
                        }
                        
                        docTableData.push([
                            turkishToAscii(docType),
                            turkishToAscii(doc.name.substring(0, 30)),
                            sizeKB + ' KB',
                            statusText
                        ]);
                    });
                } else {
                    missingCount++;
                    docTableData.push([
                        turkishToAscii(docType),
                        '-',
                        '-',
                        turkishToAscii('EKSIK')
                    ]);
                }
            });
            
            // Özet kutuları
            const totalRequired = requiredDocTypes.length - exemptCount;
            const completionRate = totalRequired > 0 ? Math.round((uploadedCount / totalRequired) * 100) : 100;
            
            const summaryBoxWidth = contentWidth / 4 - 2;
            
            // Yüklendi kutusu
            doc.setFillColor(232, 245, 233);
            doc.roundedRect(margin, y, summaryBoxWidth, 14, 2, 2, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(46, 125, 50);
            doc.text(uploadedCount.toString(), margin + summaryBoxWidth/2, y + 7, { align: 'center' });
            doc.setFontSize(6);
            doc.setFont('helvetica', 'normal');
            doc.text(turkishToAscii('Yuklendi'), margin + summaryBoxWidth/2, y + 12, { align: 'center' });
            
            // Eksik kutusu
            doc.setFillColor(255, 235, 238);
            doc.roundedRect(margin + summaryBoxWidth + 2, y, summaryBoxWidth, 14, 2, 2, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(198, 40, 40);
            doc.text(missingCount.toString(), margin + summaryBoxWidth + 2 + summaryBoxWidth/2, y + 7, { align: 'center' });
            doc.setFontSize(6);
            doc.setFont('helvetica', 'normal');
            doc.text('Eksik', margin + summaryBoxWidth + 2 + summaryBoxWidth/2, y + 12, { align: 'center' });
            
            // Muaf kutusu
            doc.setFillColor(255, 253, 231);
            doc.roundedRect(margin + (summaryBoxWidth + 2) * 2, y, summaryBoxWidth, 14, 2, 2, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 193, 7);
            doc.text(exemptCount.toString(), margin + (summaryBoxWidth + 2) * 2 + summaryBoxWidth/2, y + 7, { align: 'center' });
            doc.setFontSize(6);
            doc.setFont('helvetica', 'normal');
            doc.text('Muaf', margin + (summaryBoxWidth + 2) * 2 + summaryBoxWidth/2, y + 12, { align: 'center' });
            
            // Tamamlanma kutusu
            const compColor = completionRate >= 80 ? [46, 125, 50] : completionRate >= 50 ? [255, 152, 0] : [198, 40, 40];
            doc.setFillColor(compColor[0], compColor[1], compColor[2], 0.1);
            doc.roundedRect(margin + (summaryBoxWidth + 2) * 3, y, summaryBoxWidth, 14, 2, 2, 'F');
            doc.setDrawColor(compColor[0], compColor[1], compColor[2]);
            doc.setLineWidth(0.5);
            doc.roundedRect(margin + (summaryBoxWidth + 2) * 3, y, summaryBoxWidth, 14, 2, 2, 'S');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(compColor[0], compColor[1], compColor[2]);
            doc.text('%' + completionRate, margin + (summaryBoxWidth + 2) * 3 + summaryBoxWidth/2, y + 7, { align: 'center' });
            doc.setFontSize(6);
            doc.setFont('helvetica', 'normal');
            doc.text('Tamamlanma', margin + (summaryBoxWidth + 2) * 3 + summaryBoxWidth/2, y + 12, { align: 'center' });
            
            y += 18;
            
            // Doküman tablosu
            if (docTableData.length > 0) {
                doc.autoTable({
                    startY: y,
                    head: [[turkishToAscii('Dokuman Turu'), turkishToAscii('Dosya'), 'KB', 'Durum']],
                    body: docTableData,
                    theme: 'grid',
                    styles: { fontSize: 6, cellPadding: 2 },
                    headStyles: { fillColor: [103, 58, 183], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 7 },
                    columnStyles: {
                        0: { cellWidth: 28, fontStyle: 'bold' },
                        1: { cellWidth: 'auto' },
                        2: { cellWidth: 16, halign: 'right' },
                        3: { cellWidth: 32, halign: 'center' }
                    },
                    margin: { left: margin, right: margin },
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 3) {
                            const cellText = data.cell.raw;
                            if (cellText.includes('Kabul')) {
                                data.cell.styles.fillColor = [232, 245, 233];
                                data.cell.styles.textColor = [46, 125, 50];
                            } else if (cellText.includes('RET')) {
                                data.cell.styles.fillColor = [255, 235, 238];
                                data.cell.styles.textColor = [198, 40, 40];
                            } else if (cellText.includes('EKSIK')) {
                                data.cell.styles.fillColor = [255, 235, 238];
                                data.cell.styles.textColor = [198, 40, 40];
                                data.cell.styles.fontStyle = 'bold';
                            } else if (cellText.includes('Muaf')) {
                                data.cell.styles.fillColor = [255, 253, 231];
                                data.cell.styles.textColor = [255, 152, 0];
                            }
                        }
                    }
                });
            }
            } // KALİTE BELGELERİ sonu
            
            // ===== FOOTER: Sayfa numaraları =====
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                if (i > 1) { // Kapak hariç
                    doc.text(`${i - 1} / ${totalPages - 1}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
                    doc.text(turkishToAscii(supplier.name.substring(0, 40)), margin, pageHeight - 8);
                }
            }
            
            // Dosyayı kaydet
            const fileName = turkishToAscii(`${supplier.name}_Rapor_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.pdf`);
            doc.save(fileName);
            showAlert('✅ PDF raporu başarıyla indirildi!', 'success');
        }
        
        function closeSettingsDialog() {
            document.getElementById('settingsDialog').style.display = 'none';
        }
        
        async function refreshDatabaseStats() {
            // Bağlantı durumu
            const statusEl = document.getElementById('dbStatus');
            const nameEl = document.getElementById('dbName');
            const countEl = document.getElementById('dbRecordCount');
            const sizeEl = document.getElementById('dbTotalSize');
            const troubleshootBtns = document.getElementById('dbTroubleshootButtons');
            const warningMsg = document.getElementById('dbWarningMessage');
            const warningText = document.getElementById('dbWarningText');
            
            if (!db) {
                statusEl.innerHTML = '❌ Bağlı Değil';
                statusEl.style.color = '#f44336';
                nameEl.textContent = '-';
                countEl.textContent = '-';
                sizeEl.textContent = '-';
                
                // Sorun giderme butonlarını göster
                if (troubleshootBtns) {
                    troubleshootBtns.style.display = 'flex';
                }
                if (warningMsg) {
                    warningMsg.style.display = 'block';
                    warningText.textContent = 'Veritabanı bağlantısı kurulamadı.';
                }
                
                return;
            }
            
            statusEl.innerHTML = '✅ Bağlı';
            statusEl.style.color = '#4caf50';
            nameEl.textContent = DB_NAME;
            
            // Sorun giderme butonlarını gizle (bağlantı başarılı)
            if (troubleshootBtns) {
                troubleshootBtns.style.display = 'none';
            }
            if (warningMsg) {
                warningMsg.style.display = 'none';
            }
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                
                // Kayıt sayısı
                const countRequest = objectStore.count();
                countRequest.onsuccess = () => {
                    countEl.textContent = countRequest.result;
                };
                
                // Toplam boyut
                const getAllRequest = objectStore.getAll();
                getAllRequest.onsuccess = () => {
                    const allRecords = getAllRequest.result;
                    let totalSize = 0;
                    allRecords.forEach(record => {
                        totalSize += JSON.stringify(record).length;
                    });
                    const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
                    sizeEl.textContent = `${sizeMB} MB`;
                };
            } catch (e) {
                console.error('İstatistik hatası:', e);
                countEl.textContent = 'Hata';
                sizeEl.textContent = 'Hata';
                
                // Hata varsa sorun giderme seçeneklerini göster
                if (troubleshootBtns) {
                    troubleshootBtns.style.display = 'flex';
                }
                if (warningMsg) {
                    warningMsg.style.display = 'block';
                    warningText.textContent = 'Veritabanı erişiminde hata oluştu.';
                }
            }
        }
        
        async function testDatabaseConnection() {
            const statusEl = document.getElementById('dbStatus');
            
            statusEl.innerHTML = '⏳ Test ediliyor...';
            statusEl.style.color = '#ff9800';
            
            try {
                if (!db) {
                    // Yeniden bağlanmayı dene
                    await initIndexedDB();
                }
                
                // Test yazma
                const testData = {
                    timestamp: new Date().toISOString(),
                    name: 'Test Bağlantısı',
                    data: [{ test: true }]
                };
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const addRequest = objectStore.add(testData);
                
                addRequest.onsuccess = () => {
                    // Test verisini hemen sil
                    const deleteTransaction = db.transaction([STORE_NAME], 'readwrite');
                    const deleteStore = deleteTransaction.objectStore(STORE_NAME);
                    deleteStore.delete(addRequest.result);
                    
                    statusEl.innerHTML = '✅ Bağlı (Test Başarılı)';
                    statusEl.style.color = '#4caf50';
                    showAlert('✅ Veritabanı bağlantısı başarıyla test edildi!', 'success');
                    refreshDatabaseStats();
                };
                
                addRequest.onerror = () => {
                    statusEl.innerHTML = '❌ Test Başarısız';
                    statusEl.style.color = '#f44336';
                    showAlert('❌ Veritabanı testi başarısız!', 'error');
                    refreshDatabaseStats();
                };
            } catch (e) {
                console.error('Test hatası:', e);
                statusEl.innerHTML = '❌ Bağlantı Hatası';
                statusEl.style.color = '#f44336';
                showAlert('❌ Veritabanı bağlantısı kurulamadı!', 'error');
                refreshDatabaseStats();
            }
        }
        
        // Manuel yeniden bağlanma
        async function reconnectDatabase() {
            const statusEl = document.getElementById('dbStatus');
            
            statusEl.innerHTML = '⏳ Yeniden bağlanıyor...';
            statusEl.style.color = '#ff9800';
            
            try {
                // Mevcut bağlantıyı kapat (varsa)
                if (db) {
                    db.close();
                    db = null;
                }
                
                // Yeniden bağlan
                await initIndexedDB();
                
                if (db) {
                    statusEl.innerHTML = '✅ Bağlantı Başarılı';
                    statusEl.style.color = '#4caf50';
                    showAlert('✅ Veritabanına başarıyla yeniden bağlanıldı!', 'success');

                    refreshDatabaseStats();
                } else {
                    throw new Error('Bağlantı kurulamadı');
                }
            } catch (e) {
                console.error('Yeniden bağlanma hatası:', e);
                statusEl.innerHTML = '❌ Bağlanma Başarısız';
                statusEl.style.color = '#f44336';
                showAlert('❌ Yeniden bağlanma başarısız! Hata: ' + e.message, 'error');
                refreshDatabaseStats();
            }
        }
        
        // Veritabanını onar (sil ve yeniden oluştur)
        async function repairDatabase() {
            if (!confirm('⚠️ UYARI: Veritabanı onarma işlemi tüm kayıtlı verileri silecektir!\n\nDevam etmek istediğinize emin misiniz?\n\n📝 Not: Devam etmeden önce "JSON İndir" ile yedeğinizi alın.')) {
                return;
            }
            
            const statusEl = document.getElementById('dbStatus');
            
            statusEl.innerHTML = '⏳ Onarılıyor...';
            statusEl.style.color = '#ff9800';
            
            try {
                // Mevcut bağlantıyı kapat
                if (db) {
                    db.close();
                    db = null;
                }
                
                // Veritabanını sil
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                
                deleteRequest.onsuccess = async () => {
                    console.log('🗑️ Eski veritabanı silindi');
                    
                    // Yeni veritabanı oluştur
                    try {
                        await initIndexedDB();
                        
                        if (db) {
                            statusEl.innerHTML = '✅ Onarma Başarılı';
                            statusEl.style.color = '#4caf50';
                            showAlert('✅ Veritabanı başarıyla onarıldı ve yeniden oluşturuldu!\n\nArtik Excel yükleyerek verilerinizi kaydedebilirsiniz.', 'success');
                            refreshDatabaseStats();
                        } else {
                            throw new Error('Yeni veritabanı oluşturulamadı');
                        }
                    } catch (e) {
                        throw new Error('Yeniden oluşturma hatası: ' + e.message);
                    }
                };
                
                deleteRequest.onerror = () => {
                    throw new Error('Veritabanı silinemedi');
                };
                
                deleteRequest.onblocked = () => {
                    showAlert('⚠️ Veritabanı kullanımda! Lütfen bu sayfayı açık tüm sekmeleri kapatın ve tekrar deneyin.', 'warning');
                    statusEl.innerHTML = '⚠️ Engellendi';
                    statusEl.style.color = '#ff9800';
                };
            } catch (e) {
                console.error('Onarma hatası:', e);
                statusEl.innerHTML = '❌ Onarma Başarısız';
                statusEl.style.color = '#f44336';
                showAlert('❌ Veritabanı onarma başarısız! Hata: ' + e.message, 'error');
                refreshDatabaseStats();
            }
        }
        
        function updateSystemInfo() {
            // Tarayıcı bilgisi - Daha detaylı algılama
            const ua = navigator.userAgent;
            let browserName = 'Bilinmiyor';
            let browserVersion = '';
            
            // Önce özel tarayıcıları kontrol et (Chromium tabanlılar)
            if (ua.indexOf('Edg/') > -1 || ua.indexOf('Edge/') > -1) {
                browserName = 'Microsoft Edge';
                const match = ua.match(/Edg\/(\d+)/);
                browserVersion = match ? ` ${match[1]}` : '';
            } else if (ua.indexOf('OPR/') > -1 || ua.indexOf('Opera/') > -1) {
                browserName = 'Opera';
                const match = ua.match(/OPR\/(\d+)/);
                browserVersion = match ? ` ${match[1]}` : '';
            } else if (ua.indexOf('Brave/') > -1 || (ua.indexOf('Chrome') > -1 && navigator.brave)) {
                browserName = 'Brave';
            } else if (ua.indexOf('Chrome/') > -1) {
                browserName = 'Chrome';
                const match = ua.match(/Chrome\/(\d+)/);
                browserVersion = match ? ` ${match[1]}` : '';
            } else if (ua.indexOf('Firefox/') > -1) {
                browserName = 'Firefox';
                const match = ua.match(/Firefox\/(\d+)/);
                browserVersion = match ? ` ${match[1]}` : '';
            } else if (ua.indexOf('Safari/') > -1 && ua.indexOf('Chrome') === -1) {
                browserName = 'Safari';
                const match = ua.match(/Version\/(\d+)/);
                browserVersion = match ? ` ${match[1]}` : '';
            }
            
            document.getElementById('browserInfo').textContent = browserName + browserVersion;
            
            // IndexedDB desteği
            const hasIndexedDB = !!window.indexedDB;
            const supportEl = document.getElementById('indexedDBSupport');
            supportEl.textContent = hasIndexedDB ? '✅ Destekleniyor' : '❌ Desteklenmiyor';
            supportEl.style.color = hasIndexedDB ? '#4caf50' : '#f44336';
            
            // Yüklü tedarikçi sayısı
            document.getElementById('loadedSuppliers').textContent = allResults.length || '0';
            
            // Kayıtlı durum eşleştirmesi sayısı
            document.getElementById('statusMapCount').textContent = `${supplierStatusMap.size} tedarikçi`;

            // Kayıtlı lokasyon bilgisi (IndexedDB supplierLocations)
            const locationCountEl = document.getElementById('locationStoreCount');
            const locationLastEl = document.getElementById('locationLastUpdate');
            if (db) {
                try {
                    const txLoc = db.transaction([LOCATION_STORE_NAME], 'readonly');
                    const storeLoc = txLoc.objectStore(LOCATION_STORE_NAME);
                    const getAllLoc = storeLoc.getAll();
                    getAllLoc.onsuccess = () => {
                        const rows = getAllLoc.result || [];
                        locationCountEl.textContent = `${rows.length} kayıt`;
                        if (rows.length > 0) {
                            rows.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            const last = rows[0];
                            const dt = new Date(last.timestamp);
                            locationLastEl.textContent = dt.toLocaleString('tr-TR');
                        } else {
                            locationLastEl.textContent = 'Henüz kayıt yok';
                        }
                    };
                    getAllLoc.onerror = () => {
                        locationCountEl.textContent = 'Bilgi alınamadı';
                        locationLastEl.textContent = 'Bilgi alınamadı';
                    };
                } catch (e) {
                    locationCountEl.textContent = 'Bilgi alınamadı';
                    locationLastEl.textContent = 'Bilgi alınamadı';
                }
            } else {
                locationCountEl.textContent = 'Veritabanı bağlı değil';
                locationLastEl.textContent = 'Veritabanı bağlı değil';
            }
            
            // Kayıtlı doküman bilgisi (IndexedDB supplierDocuments)
            const documentCountEl = document.getElementById('documentStoreCount');
            const documentLastEl = document.getElementById('documentLastUpdate');
            if (db) {
                try {
                    const txDoc = db.transaction([DOC_STORE_NAME], 'readonly');
                    const storeDoc = txDoc.objectStore(DOC_STORE_NAME);
                    const getAllDoc = storeDoc.getAll();
                    getAllDoc.onsuccess = () => {
                        const rows = getAllDoc.result || [];
                        documentCountEl.textContent = `${rows.length} kayıt`;
                        if (rows.length > 0) {
                            rows.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
                            const last = rows[0];
                            const dt = new Date(last.lastUpdated);
                            documentLastEl.textContent = dt.toLocaleString('tr-TR');
                        } else {
                            documentLastEl.textContent = 'Henüz kayıt yok';
                        }
                    };
                    getAllDoc.onerror = () => {
                        documentCountEl.textContent = 'Bilgi alınamadı';
                        documentLastEl.textContent = 'Bilgi alınamadı';
                    };
                } catch (e) {
                    documentCountEl.textContent = 'Bilgi alınamadı';
                    documentLastEl.textContent = 'Bilgi alınamadı';
                }
            } else {
                documentCountEl.textContent = 'Veritabanı bağlı değil';
                documentLastEl.textContent = 'Veritabanı bağlı değil';
            }
            
        }
        
        // Durum eşleştirmelerini temizle
        function clearSupplierStatusMap() {
            if (!confirm('⚠️ Tüm tedarikçi durum eşleştirmelerini silmek istediğinize emin misiniz?\n\nBu işlemden sonra yeni Excel yüklediğinizde tüm tedarikçiler "Onaylı" olarak gelecektir.')) {
                return;
            }
            
            supplierStatusMap.clear();
            localStorage.removeItem('supplierStatusMap');
            
            showAlert('✅ Tüm durum eşleştirmeleri temizlendi!', 'success');
            updateSystemInfo();
        }
        
        // Durum ve diğer aktiviteleri içeren değişiklik geçmişini göster
        function showStatusChangeHistory() {
            const statusHistory = JSON.parse(localStorage.getItem('supplierStatusHistory') || '[]');
            const activityHistory = JSON.parse(localStorage.getItem('activityHistory') || '[]');

            if (statusHistory.length === 0 && activityHistory.length === 0) {
                showAlert('📜 Henüz değişiklik kaydı yok', 'info');
                return;
            }

            const parseStatusDate = (value) => {
                // Mevcut format: 20.01.2026 13:57:31
                if (!value) return new Date(0);
                return new Date(value.split('.').reverse().join('-').replace(',', ''));
            };

            const mergedHistory = [];

            statusHistory.forEach((record, idx) => {
                mergedHistory.push({
                    type: 'status',
                    supplierName: record.tedarikcı,
                    oldStatus: record.eskiDurum,
                    newStatus: record.yeniDurum,
                    displayDate: record.tarih,
                    parsedDate: parseStatusDate(record.tarih),
                    index: idx
                });
            });

            activityHistory.forEach((record, idx) => {
                const parsedDate = record.timestamp ? new Date(record.timestamp) : new Date();
                mergedHistory.push({
                    type: record.type,
                    supplierName: record.supplierName,
                    docType: record.docType,
                    fileName: record.fileName,
                    oldStatus: record.oldStatus,
                    newStatus: record.newStatus,
                    locations: record.locations,
                    oldLocations: record.oldLocations,
                    fileData: record.fileData,
                    fileId: record.fileId,
                    displayDate: parsedDate.toLocaleString('tr-TR'),
                    parsedDate,
                    index: idx
                });
            });

            // Tarihe göre sırala (en yeni en üstte)
            const sortedHistory = mergedHistory.sort((a, b) => b.parsedDate - a.parsedDate);

            // Toplam boyutu hesapla (MB cinsinden)
            const sizeInBytes = new Blob([JSON.stringify({ statusHistory, activityHistory })]).size;
            const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);

            const typeLabels = {
                status: 'Durum Değişikliği',
                'status-change': 'Durum Değişikliği',
                'document-add': 'Doküman Eklendi',
                'document-delete': 'Doküman Silindi',
                'location-change': 'Lokasyon Güncellendi'
            };

            const typeColors = {
                status: '#9c27b0',
                'status-change': '#9c27b0',
                'document-add': '#4caf50',
                'document-delete': '#f44336',
                'location-change': '#ff9800'
            };

            let html = `
                <div id="statusChangeHistoryModal" class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000;">
                    <div class="modal-dialog" style="background: white; border-radius: 10px; max-width: 950px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-header" style="padding: 20px; background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0;">📜 Değişiklik Geçmişi</h3>
                                <div style="font-size: 0.85em; opacity: 0.9; margin-top: 4px;">
                                    ${sortedHistory.length} kayıt • ${sizeInMB} MB
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-secondary" onclick="clearStatusHistory()" style="background: #f44336; color: white; padding: 8px 15px; font-size: 0.9em; border: none; border-radius: 5px; cursor: pointer;">
                                    🗑️ Tümünü Temizle
                                </button>
                                <button onclick="closeStatusChangeHistory()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0; width: 30px; height: 30px;">✕</button>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1;">
            `;

            sortedHistory.forEach((record, index) => {
                const badgeColor = typeColors[record.type] || '#607d8b';
                const typeLabel = typeLabels[record.type] || 'Aktivite';
                const backgroundColor = index % 2 === 0 ? '#f8f9fa' : 'white';

                if (record.type === 'status' || record.type === 'status-change') {
                    const statusEmoji = {
                        'ONAYLI': '✅',
                        'ONAYSIZ': '⚠️',
                        'MÜŞTERİ': '👤'
                    };

                    const oldEmoji = statusEmoji[record.oldStatus] || '📌';
                    const newEmoji = statusEmoji[record.newStatus] || '📌';

                    html += `
                        <div style="padding: 12px; margin: 8px 0; background: ${backgroundColor}; border-radius: 6px; border-left: 4px solid ${badgeColor}; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="padding: 3px 8px; background: ${badgeColor}; color: white; border-radius: 4px; font-size: 0.8em;">${typeLabel}</span>
                                        <span style="font-size: 0.9em; color: #555;">${record.displayDate}</span>
                                    </div>
                                    <div style="font-weight: 600; color: #1e3c72; font-size: 1.05em; margin-bottom: 5px;">
                                        ${record.supplierName || '-'}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                        <span style="padding: 4px 10px; background: #e3f2fd; border-radius: 4px; font-size: 0.9em;">
                                            ${oldEmoji} ${record.oldStatus || ''}
                                        </span>
                                        <span style="color: #666;">→</span>
                                        <span style="padding: 4px 10px; background: #e8f5e9; border-radius: 4px; font-size: 0.9em; font-weight: 600;">
                                            ${newEmoji} ${record.newStatus || ''}
                                        </span>
                                    </div>
                                </div>
                                <button onclick="deleteSingleStatusHistory('${record.type}', ${record.index})"
                                        style="background: #ff5252; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.85em; white-space: nowrap;"
                                        onmouseover="this.style.background='#ff1744'"
                                        onmouseout="this.style.background='#ff5252'">
                                    🗑️ Sil
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (record.type === 'document-add' || record.type === 'document-delete') {
                    const docEmoji = record.type === 'document-add' ? '📥' : '🗑️';
                    html += `
                        <div style="padding: 12px; margin: 8px 0; background: ${backgroundColor}; border-radius: 6px; border-left: 4px solid ${badgeColor}; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="padding: 3px 8px; background: ${badgeColor}; color: white; border-radius: 4px; font-size: 0.8em;">${typeLabel}</span>
                                        <span style="font-size: 0.9em; color: #555;">${record.displayDate}</span>
                                    </div>
                                    <div style="font-weight: 600; color: #1e3c72; font-size: 1.05em; margin-bottom: 5px;">
                                        ${record.supplierName || '-'}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px; flex-wrap: wrap;">
                                        <span style="padding: 4px 10px; background: #e3f2fd; border-radius: 4px; font-size: 0.9em;">
                                            ${docEmoji} ${record.docType || 'Doküman'}
                                        </span>
                                        ${record.fileName ? `<span style="padding: 4px 10px; background: #fff3cd; border-radius: 4px; font-size: 0.9em;">📄 ${record.fileName}</span>` : ''}
                                    </div>
                                </div>
                                <button onclick="deleteSingleStatusHistory('${record.type}', ${record.index})"
                                        style="background: #ff5252; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.85em; white-space: nowrap;"
                                        onmouseover="this.style.background='#ff1744'"
                                        onmouseout="this.style.background='#ff5252'">
                                    🗑️ Sil
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (record.type === 'location-change') {
                    html += `
                        <div style="padding: 12px; margin: 8px 0; background: ${backgroundColor}; border-radius: 6px; border-left: 4px solid ${badgeColor}; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="padding: 3px 8px; background: ${badgeColor}; color: white; border-radius: 4px; font-size: 0.8em;">${typeLabel}</span>
                                        <span style="font-size: 0.9em; color: #555;">${record.displayDate}</span>
                                    </div>
                                    <div style="font-weight: 600; color: #1e3c72; font-size: 1.05em; margin-bottom: 5px;">
                                        ${record.supplierName || '-'}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px; flex-wrap: wrap;">
                                        <span style="padding: 4px 10px; background: #fff8e1; border-radius: 4px; font-size: 0.9em;">
                                            📍 ${record.locations || 'Bilinmiyor'}
                                        </span>
                                    </div>
                                </div>
                                <button onclick="deleteSingleStatusHistory('${record.type}', ${record.index})"
                                        style="background: #ff5252; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.85em; white-space: nowrap;"
                                        onmouseover="this.style.background='#ff1744'"
                                        onmouseout="this.style.background='#ff5252'">
                                    🗑️ Sil
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
            });

            html += `
                            <div style="margin-top: 20px; padding: 12px; background: #e8f5e9; border-radius: 5px; border: 1px solid #4caf50;">
                                <strong>✅ Sınırsız Depolama:</strong> Tüm değişiklikler kaydedilir. Her tedarikçinin en son durumu yeni Excel yüklendiğinde geçerlidir.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('statusChangeHistoryModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', html);
        }

        // Geçmiş modal'ını kapat
        function closeStatusChangeHistory() {
            const modal = document.getElementById('statusChangeHistoryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Tüm geçmişi temizle (durum + aktivite)
        function clearStatusHistory() {
            if (!confirm('⚠️ Tüm değişiklik geçmişini silmek istediğinize emin misiniz?\n\n⚡ Not: Tedarikçilerin mevcut durumları (Onaylı/Onaysız/Müşteri) korunur, sadece geçmiş kayıtları silinir.')) {
                return;
            }

            localStorage.removeItem('supplierStatusHistory');
            localStorage.removeItem('activityHistory');
            showAlert('✅ Değişiklik geçmişi temizlendi!', 'success');

            const historyModal = document.getElementById('statusChangeHistoryModal');
            if (historyModal) {
                historyModal.remove();
            }
        }

        // Tek bir kayıt sil (durum veya aktivite) ve değişikliği geri al
        function deleteSingleStatusHistory(type, index) {
            if (!confirm('⚠️ Bu değişiklik kaydını silmek istediğinize emin misiniz?\n\n📌 Not: Değişiklik geri alınacak ve önceki duruma dönülecektir.')) {
                return;
            }

            try {
                if (type === 'status') {
                    let history = JSON.parse(localStorage.getItem('supplierStatusHistory') || '[]');
                    if (index >= 0 && index < history.length) {
                        const deletedRecord = history[index];
                        const supplierName = deletedRecord.tedarikcı;
                        const oldStatus = deletedRecord.eskiDurum;
                        
                        // Durum değişikliğini geri al - eski duruma dön
                        const supplier = allResults.find(r => r.name === supplierName);
                        if (supplier) {
                            supplier.status = oldStatus;
                            updateSupplierStatus(supplierName, oldStatus);
                            console.log(`↩️ ${supplierName} durumu geri alındı: ${deletedRecord.yeniDurum} → ${oldStatus}`);
                        }
                        
                        history.splice(index, 1);
                        localStorage.setItem('supplierStatusHistory', JSON.stringify(history));
                        console.log(`✅ Durum kaydı silindi: ${supplierName} (${oldStatus} → ${deletedRecord.yeniDurum})`);
                        
                        // Tabloyu yeniden render et
                        renderTable(allResults);
                        showAlert(`↩️ ${supplierName} durumu "${oldStatus}" olarak geri alındı`, 'success');
                    }
                } else {
                    let activity = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                    if (index >= 0 && index < activity.length) {
                        const deletedActivity = activity[index];
                        const activityType = deletedActivity.type;
                        const supplierName = deletedActivity.supplierName;
                        
                        // Aktivite türüne göre geri alma işlemi
                        if (activityType === 'document-add') {
                            // Doküman ekleme kaydı silindiyse → dokümanı sil
                            const docType = deletedActivity.docType;
                            const fileName = deletedActivity.fileName;
                            
                            // Dosya ID'sini bul ve sil
                            getSupplierDocuments(supplierName).then(record => {
                                if (record && record.documents && record.documents[docType]) {
                                    const fileToDelete = record.documents[docType].find(doc => doc.name === fileName);
                                    if (fileToDelete) {
                                        deleteSupplierDocument(supplierName, docType, fileToDelete.id, true).then(() => {
                                            console.log(`↩️ ${supplierName} - ${docType} - ${fileName} dokümanı geri alındı (silindi)`);
                                            showAlert(`↩️ ${fileName} dokümanı geri alındı (silindi)`, 'success');
                                            renderTable(allResults);
                                        }).catch(err => {
                                            console.error('Doküman silme hatası:', err);
                                        });
                                    }
                                }
                            }).catch(err => {
                                console.error('Doküman okuma hatası:', err);
                            });
                        } else if (activityType === 'document-delete') {
                            // Doküman silme kaydı silindiyse → dokümanı geri yükle
                            if (deletedActivity.fileData) {
                                const docType = deletedActivity.docType;
                                const fileData = deletedActivity.fileData;
                                
                                // IndexedDB'ye dokümanı geri ekle
                                const normalizedName = normalizeName(supplierName);
                                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                                const store = transaction.objectStore(DOC_STORE_NAME);
                                const getRequest = store.get(normalizedName);
                                
                                getRequest.onsuccess = () => {
                                    let record = getRequest.result || {
                                        normalizedName: normalizedName,
                                        supplierName: supplierName,
                                        documents: {},
                                        lastUpdated: new Date().toISOString()
                                    };
                                    
                                    if (!record.documents[docType]) {
                                        record.documents[docType] = [];
                                    }
                                    
                                    // Dosyayı geri ekle
                                    const fileId = deletedActivity.fileId || (Date.now() + '_' + Math.random().toString(36).substr(2, 9));
                                    record.documents[docType].push({
                                        id: fileId,
                                        name: fileData.name,
                                        blob: fileData.blob,
                                        timestamp: new Date().toISOString(),
                                        size: fileData.size
                                    });
                                    
                                    record.lastUpdated = new Date().toISOString();
                                    
                                    const putRequest = store.put(record);
                                    putRequest.onsuccess = () => {
                                        console.log(`↩️ ${supplierName} - ${docType} - ${fileData.name} dokümanı geri yüklendi`);
                                        showAlert(`↩️ ${fileData.name} dokümanı geri yüklendi`, 'success');
                                        renderTable(allResults);
                                    };
                                    putRequest.onerror = () => {
                                        console.error('Doküman geri yükleme hatası:', putRequest.error);
                                        showAlert('❌ Doküman geri yüklenemedi', 'error');
                                    };
                                };
                                
                                getRequest.onerror = () => {
                                    console.error('Doküman okuma hatası:', getRequest.error);
                                    showAlert('❌ Doküman geri yüklenemedi', 'error');
                                };
                            } else {
                                showAlert('⚠️ Silinen dokümanı geri yüklemek mümkün değil (dosya verisi kayıtlı değil)', 'info');
                            }
                        } else if (activityType === 'status-change') {
                            // Status-change activity kaydı silindiyse → eski duruma dön
                            const oldStatus = deletedActivity.oldStatus;
                            const supplier = allResults.find(r => r.name === supplierName);
                            if (supplier) {
                                supplier.status = oldStatus;
                                updateSupplierStatus(supplierName, oldStatus);
                                console.log(`↩️ ${supplierName} durumu geri alındı: ${deletedActivity.newStatus} → ${oldStatus}`);
                                renderTable(allResults);
                                showAlert(`↩️ ${supplierName} durumu "${oldStatus}" olarak geri alındı`, 'success');
                            }
                        } else if (activityType === 'location-change') {
                            // Lokasyon değişikliği kaydı silinirse → Lokasyonu temizle
                            const supplier = allResults.find(r => r.name === supplierName);
                            if (supplier) {
                                supplier.lokasyon = [];
                                saveLokasyonToStorage(supplierName, [], true); // skipLog=true
                                console.log(`🗑️ ${supplierName} lokasyonu temizlendi`);
                                renderTable(allResults);
                                showAlert(`🗑️ ${supplierName} lokasyonu temizlendi`, 'success');
                            }
                        }
                        
                        activity.splice(index, 1);
                        localStorage.setItem('activityHistory', JSON.stringify(activity));
                        console.log(`✅ Aktivite kaydı silindi: ${activityType} ${supplierName}`);
                    }
                }

                const historyModal = document.getElementById('statusChangeHistoryModal');
                if (historyModal && historyModal.parentElement) {
                    historyModal.parentElement.removeChild(historyModal);
                }

                setTimeout(() => {
                    showStatusChangeHistory();
                }, 100);
            } catch (e) {
                console.error('Kayıt silme hatası:', e);
                showAlert('❌ Kayıt silinirken hata oluştu!', 'error');
            }
        }

        function restoreEditsVersion(index) {
            const history = JSON.parse(localStorage.getItem('supplierEditsHistory') || '[]');
            if (index < 0 || index >= history.length) return;

            const snapshot = history[index];
            
            // Tedarikçileri güncelleştir
            loadSavedEdits(snapshot);
            
            const date = new Date(snapshot.timestamp);
            const saveName = snapshot.name || `Sürüm ${history.length - index}`;
            showAlert(`✅ "${saveName}" geri yüklendi!`, 'success');
        }

        function deleteEditsVersion(index) {
            const history = JSON.parse(localStorage.getItem('supplierEditsHistory') || '[]');
            if (index < 0 || index >= history.length) return;

            const snapshot = history[index];
            const saveName = snapshot.name || `Sürüm ${history.length - index}`;
            
            if (!confirm(`⚠️ "${saveName}" sürümünü silmek istediğinize emin misiniz?`)) {
                return;
            }

            // Versiyonu sil
            history.splice(index, 1);
            localStorage.setItem('supplierEditsHistory', JSON.stringify(history));
            
            updateEditsVersionButton();
            showAlert(`✅ "${saveName}" silindi!`, 'success');
            
            // Diyaloğu yenile
            showEditsHistory();
        }

        function showCustomAlert(html, title) {
            // Eski modalı kapat (varsa)
            const oldModal = document.getElementById('customAlertModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Basit modal göster
            const modal = document.createElement('div');
            modal.id = 'customAlertModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            // Overlay'e tıklanınca modalı kapat
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            modal.innerHTML = `
                <div style="background: white; border-radius: 10px; padding: 20px; max-width: 950px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    <h2 style="margin-top: 0; margin-bottom: 20px; color: #1e3c72;">${title}</h2>
                    ${html}
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" style="padding: 10px 20px;" onclick="document.getElementById('customAlertModal').remove()">
                            Kapat
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function clearAllEdits() {
            if (!confirm('⚠️ Tüm kaydedilmiş sürümleri (IndexedDB) silmek istediğinize emin misiniz? Bu işlem geri alınamaz!')) {
                return;
            }
            
            if (!db) {
                showAlert('❌ Veri tabanı hazır değil!', 'error');
                return;
            }
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const clearRequest = objectStore.clear();
            
            clearRequest.onsuccess = () => {
                updateEditsVersionButton();
                showAlert('✅ Tüm kaydedilmiş sürümler silindi (IndexedDB)', 'success');
            };
            
            clearRequest.onerror = () => {
                console.error('IndexedDB temizleme hatası:', clearRequest.error);
                showAlert('❌ Silme başarısız!', 'error');
            };
        }
        
        // ======== Veri Sıfırlama Fonksiyonları ========
        
        // Lokasyon verilerini sıfırla
        async function clearLocationData() {
            if (!confirm('⚠️ TÜM TEDARİKÇİLERİN LOKASYON VERİLERİNİ SILMEK İSTEDİĞİNİZE EMİN MİSİNİZ?\n\nBu işlem geri alınamaz!')) {
                return;
            }
            
            if (!db) {
                showAlert('❌ Veri tabanı hazır değil!', 'error');
                return;
            }
            
            try {
                const transaction = db.transaction([LOCATION_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(LOCATION_STORE_NAME);
                const clearRequest = objectStore.clear();
                
                clearRequest.onsuccess = () => {
                    // Mevcut tedarikçilerin lokasyonlarını da temizle
                    if (allResults && allResults.length > 0) {
                        allResults.forEach(r => {
                            r.lokasyon = [];
                        });
                        renderTable(lastFilteredResults || allResults);
                    }
                    
                    refreshDatabaseStats();
                    showAlert('✅ Tüm lokasyon verileri silindi!', 'success');
                };
                
                clearRequest.onerror = () => {
                    console.error('Lokasyon silme hatası:', clearRequest.error);
                    showAlert('❌ Lokasyon verileri silinemedi!', 'error');
                };
            } catch (err) {
                console.error('Lokasyon silme hatası:', err);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }
        
        // Doküman verilerini sıfırla
        async function clearDocumentData() {
            if (!confirm('⚠️ TÜM TEDARİKÇİLERİN DOKÜMANLARINI SILMEK İSTEDİĞİNİZE EMİN MİSİNİZ?\n\nBu işlem geri alınamaz!')) {
                return;
            }
            
            if (!confirm('⚠️⚠️ SON UYARI!\n\nTüm dokümanlar kalıcı olarak silinecek!\n\nEmin misiniz?')) {
                return;
            }
            
            if (!db) {
                showAlert('❌ Veri tabanı hazır değil!', 'error');
                return;
            }
            
            try {
                const transaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(DOC_STORE_NAME);
                const clearRequest = objectStore.clear();
                
                clearRequest.onsuccess = () => {
                    refreshDatabaseStats();
                    showAlert('✅ Tüm doküman verileri silindi!', 'success');
                };
                
                clearRequest.onerror = () => {
                    console.error('Doküman silme hatası:', clearRequest.error);
                    showAlert('❌ Doküman verileri silinemedi!', 'error');
                };
            } catch (err) {
                console.error('Doküman silme hatası:', err);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }
        
        // Tüm verileri sıfırla (HER ŞEY!)
        async function clearAllData() {
            const message = `💣 TÜM VERİLERİ SILMEK ÜZERE!\n\n━━━━━━━━━━━━━━━━━━━━━━━━\n\nSilinecekler:\n✓ Lokasyon verileri\n✓ Doküman verileri\n✓ 8D Raporlar\n✓ Tedarikçi durum eşleştirmeleri\n✓ Manuel girilen tüm veriler\n✓ Kaydedilen tüm sürümler\n✓ Değişiklik geçmişi\n\n━━━━━━━━━━━━━━━━━━━━━━━━\n\n⚠️ BU İŞLEM GERİ ALINAMAZ!\n\nDevam etmek istediğinize EMİN MİSİNİZ?`;
            
            if (!confirm(message)) {
                return;
            }
            
            if (!confirm('⚠️⚠️⚠️ SON UYARI!\n\nTÜM VERİLER KALICI OLARAK SİLİNECEK!\n\nYedek aldınız mı?\n\nGerçekten devam etmek istiyor musunuz?')) {
                return;
            }
            
            if (!db) {
                showAlert('❌ Veri tabanı hazır değil!', 'error');
                return;
            }
            
            try {
                // 1. Kayıtlı sürümleri sil
                const historyTransaction = db.transaction([STORE_NAME], 'readwrite');
                const historyStore = historyTransaction.objectStore(STORE_NAME);
                await new Promise((resolve, reject) => {
                    const clearRequest = historyStore.clear();
                    clearRequest.onsuccess = resolve;
                    clearRequest.onerror = reject;
                });
                
                // 2. Lokasyon verilerini sil
                const locationTransaction = db.transaction([LOCATION_STORE_NAME], 'readwrite');
                const locationStore = locationTransaction.objectStore(LOCATION_STORE_NAME);
                await new Promise((resolve, reject) => {
                    const clearRequest = locationStore.clear();
                    clearRequest.onsuccess = resolve;
                    clearRequest.onerror = reject;
                });
                
                // 3. Doküman verilerini sil
                const docTransaction = db.transaction([DOC_STORE_NAME], 'readwrite');
                const docStore = docTransaction.objectStore(DOC_STORE_NAME);
                await new Promise((resolve, reject) => {
                    const clearRequest = docStore.clear();
                    clearRequest.onsuccess = resolve;
                    clearRequest.onerror = reject;
                });
                
                // 4. 8D Raporları sil
                const report8DTransaction = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const report8DStore = report8DTransaction.objectStore(REPORT_8D_STORE_NAME);
                await new Promise((resolve, reject) => {
                    const clearRequest = report8DStore.clear();
                    clearRequest.onsuccess = resolve;
                    clearRequest.onerror = reject;
                });
                
                // 5. LocalStorage verilerini sil
                localStorage.removeItem('supplierStatusMap');
                localStorage.removeItem('statusChangeHistory');
                localStorage.removeItem('supplierFilters');
                localStorage.removeItem('lastSavedData');
                localStorage.removeItem('supplierEditsHistory');
                
                // 6. Mevcut verileri sıfırla
                if (allResults && allResults.length > 0) {
                    allResults.forEach(r => {
                        r.lokasyon = [];
                        r.status = 'Onaylı';
                    });
                    
                    renderTable(allResults);
                    updateDashboard(allResults);
                }
                
                // UI'ı güncelle
                updateEditsVersionButton();
                refreshDatabaseStats();
                update8DReportCount();
                
                showAlert('✅ TÜM VERİLER BAŞARIYLA SİLİNDİ!\n\nSistem tamamen temizlendi.', 'success');
                
            } catch (err) {
                console.error('Tüm verileri silme hatası:', err);
                showAlert('❌ Bazı veriler silinirken hata oluştu!', 'error');
            }
        }
        
        // 8D Raporlarını sıfırla
        async function clear8DReportData() {
            const message = `⚠️ TÜM 8D RAPORLARINI SILMEK ÜZERE!\n\n━━━━━━━━━━━━━━━━━━━━━━━━\n\nSilinecekler:\n✓ Tüm 8D raporlar\n✓ Tüm düzeltici faaliyetler\n✓ D1-D8 adımları\n✓ Tüm 8D dokümanları\n\n━━━━━━━━━━━━━━━━━━━━━━━━\n\n⚠️ BU İŞLEM GERİ ALINAMAZ!\n\nDevam etmek istediğinize emin misiniz?`;
            
            if (!confirm(message)) {
                return;
            }
            
            if (!db) {
                showAlert('❌ Veri tabanı hazır değil!', 'error');
                return;
            }
            
            try {
                const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                
                await new Promise((resolve, reject) => {
                    const clearRequest = objectStore.clear();
                    clearRequest.onsuccess = resolve;
                    clearRequest.onerror = reject;
                });
                
                // UI'ı güncelle
                update8DReportCount();
                
                showAlert('✅ Tüm 8D raporlar başarıyla silindi!', 'success');
                
            } catch (err) {
                console.error('8D rapor silme hatası:', err);
                showAlert('❌ 8D raporlar silinirken hata oluştu!', 'error');
            }
        }

        // ======== JSON Export/Import Fonksiyonları ========

        async function exportEditsToJSON() {
            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                return;
            }

            try {
                // Tüm verileri topla
                const exportData = {
                    version: '2.0', // Yeni versiyon - tam yedek
                    exportDate: new Date().toISOString(),
                    appVersion: '1.0',
                    
                    // Tedarikçi düzenlemeleri
                    suppliers: allResults.map(r => ({
                        name: r.name,
                        normalizedName: r.normalizedName || normalizeName(r.name),
                        status: r.status || getSupplierStatus(r.name),
                        iatf: r.iatf || false,
                        iso9001: r.iso9001 || false,
                        iso14001: r.iso14001 || false,
                        iso45001: r.iso45001 || false,
                        certExpiryDates: r.certExpiryDates || {},
                        talepEdilen8D: r.talepEdilen8D || 0,
                        cevaplanan8D: r.cevaplanan8D || 0,
                        vdaPuan: r.vdaPuan || 0,
                        terminPuan: r.terminPuan || 100,
                        tamamlanmaPuan: r.tamamlanmaPuan || 100,
                        lokasyon: r.lokasyon || [],
                        ppmTarget: r.ppmTarget || null,
                        hataHedefi: r.hataHedefi || null,
                        kalitePuan: r.kalitePuan || 0
                    })),
                    
                    // IndexedDB verileri
                    indexedDB: {
                        supplierHistory: [],
                        supplierLocations: [],
                        supplierDocuments: [],
                        supplier8DCounts: [],
                        report8D: []
                    },
                    
                    // localStorage verileri
                    localStorage: {
                        targetAgreements: localStorage.getItem('targetAgreements'),
                        documentTypes: localStorage.getItem('documentTypes'),
                        selectedLocations: localStorage.getItem('selectedLocations'),
                        selectedCustomer: localStorage.getItem('selectedCustomer'),
                        jsonBinApiKey: localStorage.getItem('jsonBinApiKey'),
                        githubToken: localStorage.getItem('githubToken'),
                        githubRepo: localStorage.getItem('githubRepo'),
                        githubOwner: localStorage.getItem('githubOwner'),
                        supplierStatusMap: localStorage.getItem('supplierStatusMap'),
                        supplierInfoMap: localStorage.getItem('supplierInfoMap'),
                        supplierFilters: localStorage.getItem('supplierFilters')
                    },
                    
                    // Kullanıcı seçimleri ve filtreler
                    userState: {
                        selectedSuppliers: Array.from(selectedSuppliers),
                        currentTab: currentTab,
                        selectedClassFilter: selectedClassFilter,
                        // Durum filtreleri
                        selectedDurumlar: Array.from(document.querySelectorAll('#durumOptions input[type="checkbox"]:checked'))
                            .map(cb => cb.value),
                        // Lokasyon filtreleri
                        selectedLocations: Array.from(document.querySelectorAll('#locationOptions input[type="checkbox"]:checked'))
                            .map(cb => cb.value),
                        // Ay filtreleri
                        selectedMonths: Array.from(document.querySelectorAll('#monthOptions input[type="checkbox"]:checked:not([value="__TUMU__"])'))
                            .map(cb => cb.value)
                    }
                };

                // IndexedDB verilerini oku
                const stores = [
                    { name: STORE_NAME, key: 'supplierHistory' },
                    { name: LOCATION_STORE_NAME, key: 'supplierLocations' },
                    { name: DOC_STORE_NAME, key: 'supplierDocuments' },
                    { name: SUPPLIER_8D_COUNTS_STORE, key: 'supplier8DCounts' },
                    { name: REPORT_8D_STORE_NAME, key: 'report8D' }
                ];

                for (const store of stores) {
                    try {
                        const data = await getAllFromStore(store.name);
                        exportData.indexedDB[store.key] = data;
                        console.log(`✅ ${store.name}: ${data.length} kayıt`);
                    } catch (e) {
                        console.error(`❌ ${store.name} okunamadı:`, e);
                        exportData.indexedDB[store.key] = [];
                    }
                }

                // JSON dosyasını indir
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                a.download = `supplier_system_full_backup_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                const stats = `
📊 Yedeklenen Veriler:
- Tedarikçiler: ${exportData.suppliers.length}
- Lokasyonlar: ${exportData.indexedDB.supplierLocations.length}
- Dokümanlar: ${exportData.indexedDB.supplierDocuments.length}
- 8D Raporlar: ${exportData.indexedDB.report8D.length}
- Ayarlar: Tümü
                `.trim();

                showAlert(`✅ Tam yedek alındı!\n\n${stats}`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('❌ Yedek alınırken hata oluştu: ' + error.message, 'error');
            }
        }

        // IndexedDB store'dan tüm verileri al
        function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    if (!db.objectStoreNames.contains(storeName)) {
                        resolve([]);
                        return;
                    }
                    
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                } catch (e) {
                    reject(e);
                }
            });
        }

        function closeJSONSaveDialog() {
            document.getElementById('jsonSaveDialog').style.display = 'none';
        }

        function saveEditsAsJSON() {
            const saveName = document.getElementById('jsonSaveName').value.trim();
            
            if (!saveName) {
                showAlert('⚠️ Lütfen kayıt için bir ad girin!', 'error');
                return;
            }

            const editedSuppliers = allResults.filter(r => {
                return r.iatf || r.iso9001 || r.iso14001 || r.iso45001 ||
                       r.talepEdilen8D > 0 || r.cevaplanan8D > 0 ||
                       r.vdaPuan > 0 || 
                       (r.terminPuan && r.terminPuan !== 100) ||
                       (r.tamamlanmaPuan && r.tamamlanmaPuan !== 100) ||
                       (r.lokasyon && r.lokasyon.length > 0);
            }).map(r => ({
                name: r.name,
                iatf: r.iatf ? true : false,
                iso9001: r.iso9001 ? true : false,
                iso14001: r.iso14001 ? true : false,
                iso45001: r.iso45001 ? true : false,
                certExpiryDates: r.certExpiryDates || {},
                talepEdilen8D: r.talepEdilen8D || 0,
                cevaplanan8D: r.cevaplanan8D || 0,
                vdaPuan: r.vdaPuan || 0,
                terminPuan: r.terminPuan || 100,
                tamamlanmaPuan: r.tamamlanmaPuan || 100,
                lokasyon: r.lokasyon || []
            }));

            const jsonData = {
                version: '1.0',
                name: saveName,
                timestamp: new Date().toISOString(),
                data: editedSuppliers
            };

            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tedarikci_duzenlemeleri_${saveName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeJSONSaveDialog();
            showAlert(`✅ "${saveName}" JSON dosyası olarak indirildi!`, 'success');
        }

        async function importEditsFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    if (!jsonData.version) {
                        showAlert('❌ Geçersiz JSON dosyası formatı!', 'error');
                        return;
                    }

                    // Versiyon kontrolü
                    if (jsonData.version === '2.0') {
                        // Tam yedek - tüm verileri yükle
                        await importFullBackup(jsonData);
                    } else if (jsonData.version === '1.0') {
                        // Eski versiyon - sadece tedarikçi düzenlemeleri
                        await importLegacyBackup(jsonData);
                    } else {
                        showAlert('❌ Desteklenmeyen JSON versiyonu: ' + jsonData.version, 'error');
                        return;
                    }

                } catch (error) {
                    console.error('JSON import error:', error);
                    showAlert('❌ JSON dosyası yüklenirken hata oluştu: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Input'u temizle
            event.target.value = '';
        }

        // Tam yedek (v2.0) import
        async function importFullBackup(jsonData) {
            try {
                console.log('📥 Tam yedek yükleniyor...');
                
                let stats = {
                    suppliers: 0,
                    locations: 0,
                    documents: 0,
                    report8D: 0,
                    settings: 0
                };

                // 1. Tedarikçi düzenlemelerini yükle
                if (jsonData.suppliers && Array.isArray(jsonData.suppliers)) {
                    // allResults yoksa veya boşsa, verileri localStorage'a kaydet
                    if (!allResults || allResults.length === 0) {
                        console.warn('⚠️ Excel henüz yüklenmemiş, tedarikçi verileri localStorage\'a kaydediliyor');
                        localStorage.setItem('pendingSupplierData', JSON.stringify(jsonData.suppliers));
                        showAlert('⚠️ Önce Excel dosyasını yükleyin!\n\nTedarikçi verileri kaydedildi ve Excel yüklendiğinde otomatik uygulanacak.', 'warning');
                    } else {
                        // allResults varsa normal şekilde yükle
                        allResults.forEach(supplier => {
                            const savedSupplier = jsonData.suppliers.find(s => 
                                s.name === supplier.name || 
                                s.normalizedName === (supplier.normalizedName || normalizeName(supplier.name))
                            );
                            
                            if (savedSupplier) {
                                supplier.status = savedSupplier.status || 'ONAYLI';
                                supplier.iatf = savedSupplier.iatf || false;
                                supplier.iso9001 = savedSupplier.iso9001 || false;
                                supplier.iso14001 = savedSupplier.iso14001 || false;
                                supplier.iso45001 = savedSupplier.iso45001 || false;
                                supplier.certExpiryDates = savedSupplier.certExpiryDates || {};
                                supplier.talepEdilen8D = savedSupplier.talepEdilen8D || 0;
                                supplier.cevaplanan8D = savedSupplier.cevaplanan8D || 0;
                                supplier.vdaPuan = savedSupplier.vdaPuan || 0;
                                supplier.terminPuan = savedSupplier.terminPuan || 100;
                                supplier.tamamlanmaPuan = savedSupplier.tamamlanmaPuan || 100;
                                supplier.lokasyon = savedSupplier.lokasyon || [];
                                supplier.ppmTarget = savedSupplier.ppmTarget || null;
                                supplier.hataHedefi = savedSupplier.hataHedefi || null;
                                supplier.kalitePuan = savedSupplier.kalitePuan || 0;
                                
                                // Status'u map'e de kaydet
                                if (savedSupplier.status) {
                                    updateSupplierStatus(supplier.name, savedSupplier.status);
                                }
                                
                                recalculateSupplierScore(supplier);
                                stats.suppliers++;
                            }
                        });
                        
                        // Başarılı yükleme sonrası bekleyen veriyi temizle
                        localStorage.removeItem('pendingSupplierData');
                    }
                }

                // 2. IndexedDB verilerini yükle
                if (jsonData.indexedDB) {
                    // Lokasyonlar
                    if (jsonData.indexedDB.supplierLocations) {
                        for (const loc of jsonData.indexedDB.supplierLocations) {
                            await putToStore(LOCATION_STORE_NAME, loc);
                        }
                        stats.locations = jsonData.indexedDB.supplierLocations.length;
                    }

                    // Dokümanlar
                    if (jsonData.indexedDB.supplierDocuments) {
                        for (const doc of jsonData.indexedDB.supplierDocuments) {
                            await putToStore(DOC_STORE_NAME, doc);
                        }
                        stats.documents = jsonData.indexedDB.supplierDocuments.length;
                    }

                    // 8D Sayıları
                    if (jsonData.indexedDB.supplier8DCounts) {
                        for (const count of jsonData.indexedDB.supplier8DCounts) {
                            await putToStore(SUPPLIER_8D_COUNTS_STORE, count);
                        }
                    }

                    // 8D Raporlar
                    if (jsonData.indexedDB.report8D) {
                        for (const report of jsonData.indexedDB.report8D) {
                            await putToStore(REPORT_8D_STORE_NAME, report);
                        }
                        stats.report8D = jsonData.indexedDB.report8D.length;
                    }

                    // Supplier History
                    if (jsonData.indexedDB.supplierHistory) {
                        for (const history of jsonData.indexedDB.supplierHistory) {
                            await putToStore(STORE_NAME, history);
                        }
                    }
                }

                // 3. localStorage verilerini yükle
                if (jsonData.localStorage) {
                    for (const [key, value] of Object.entries(jsonData.localStorage)) {
                        // supplierFilters için özel işlem: null ise mevcut değeri koru
                        if (key === 'supplierFilters') {
                            if (value !== null && value !== undefined) {
                                localStorage.setItem(key, value);
                                stats.settings++;
                            }
                            // value null/undefined ise localStorage'daki mevcut değeri koru (silme)
                        } else if (value !== null && value !== undefined) {
                            localStorage.setItem(key, value);
                            stats.settings++;
                        }
                    }
                    
                    // Target Agreements'i yeniden yükle
                    loadTargetAgreementsFromStorage();
                    
                    // Supplier status map'i yeniden yükle
                    if (jsonData.localStorage.supplierStatusMap) {
                        loadSupplierStatusMap();
                    }
                    
                    // Supplier info map'i yeniden yükle
                    if (jsonData.localStorage.supplierInfoMap) {
                        loadSupplierInfoMap();
                    }
                }
                
                // Kaydedilmiş filtreleri her zaman yükle (localStorage'a kaydedildiyse otomatik gelir)
                loadSavedFilters();
                
                // 4. Kullanıcı durumunu ve seçimlerini geri yükle
                if (jsonData.userState) {
                    // Seçili tedarikçileri geri yükle
                    if (jsonData.userState.selectedSuppliers && Array.isArray(jsonData.userState.selectedSuppliers)) {
                        selectedSuppliers.clear();
                        jsonData.userState.selectedSuppliers.forEach(s => selectedSuppliers.add(s));
                        console.log('✅ Seçili tedarikçiler geri yüklendi:', selectedSuppliers.size);
                    }
                    
                    // Tab seçimini geri yükle
                    if (jsonData.userState.currentTab) {
                        currentTab = jsonData.userState.currentTab;
                    }
                    
                    // Sınıf filtresini geri yükle
                    if (jsonData.userState.selectedClassFilter) {
                        selectedClassFilter = jsonData.userState.selectedClassFilter;
                    }
                    
                    // Durum filtrelerini geri yükle
                    if (jsonData.userState.selectedDurumlar && Array.isArray(jsonData.userState.selectedDurumlar)) {
                        // Önce tüm checkbox'ları temizle
                        document.querySelectorAll('#durumOptions input[type="checkbox"]').forEach(cb => {
                            cb.checked = false;
                        });
                        // Kaydedilen durumları işaretle
                        jsonData.userState.selectedDurumlar.forEach(durum => {
                            const cb = document.querySelector(`#durumOptions input[value="${durum}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                    
                    // Lokasyon filtrelerini geri yükle
                    if (jsonData.userState.selectedLocations && Array.isArray(jsonData.userState.selectedLocations)) {
                        // Önce tüm checkbox'ları temizle
                        document.querySelectorAll('#locationOptions input[type="checkbox"]').forEach(cb => {
                            cb.checked = false;
                        });
                        // Kaydedilen lokasyonları işaretle
                        jsonData.userState.selectedLocations.forEach(loc => {
                            const cb = document.querySelector(`#locationOptions input[value="${loc}"]`);
                            if (cb) cb.checked = true;
                        });
                        // Lokasyon filtresinin görünen metnini güncelle
                        updateLocationFilter();
                    }
                    
                    // Ay filtrelerini geri yükle
                    if (jsonData.userState.selectedMonths && Array.isArray(jsonData.userState.selectedMonths)) {
                        // Önce tüm checkbox'ları temizle
                        document.querySelectorAll('#monthOptions input[type="checkbox"]:not([value="__TUMU__"])').forEach(cb => {
                            cb.checked = false;
                        });
                        // Kaydedilen ayları işaretle
                        jsonData.userState.selectedMonths.forEach(month => {
                            const cb = document.querySelector(`#monthOptions input[value="${month}"]`);
                            if (cb) cb.checked = true;
                        });
                        // "Tümü" checkbox'ını güncelle
                        const selectAllMonthCheckbox = document.querySelector('#monthOptions input[value="__TUMU__"]');
                        const monthCheckboxes = document.querySelectorAll('#monthOptions input[type="checkbox"]:not([value="__TUMU__"])');
                        if (selectAllMonthCheckbox && monthCheckboxes) {
                            selectAllMonthCheckbox.checked = jsonData.userState.selectedMonths.length === monthCheckboxes.length;
                        }
                        // Ay filtresinin görünen metnini güncelle
                        updateMonthFilter();
                    }
                    
                    // Durum filtrelerinin görünen metnini güncelle
                    if (jsonData.userState.selectedDurumlar) {
                        updateDurumFilter();
                    }
                }

                // Kaydedilmiş filtreleri yükle
                loadSavedFilters();

                // Tabloyu yeniden render et
                if (allResults && allResults.length > 0) {
                    // Seçili tedarikçi dropdown'ını güncelle
                    updateSelectedText();
                    
                    // Dropdown checkboxlarını seçili durumlarla senkronize et
                    if (jsonData.userState && jsonData.userState.selectedSuppliers) {
                        // Tüm supplier checkboxlarını güncelle
                        document.querySelectorAll('#supplierOptions .multiselect-option:not(.select-all)').forEach(option => {
                            const supplierKey = option.getAttribute('data-supplier-key') || option.getAttribute('data-supplier');
                            const checkbox = option.querySelector('input[type="checkbox"]');
                            if (checkbox && supplierKey) {
                                checkbox.checked = selectedSuppliers.has(supplierKey);
                            }
                        });
                        
                        // "Tümünü Seç" checkboxunu güncelle
                        const selectAllCheckbox = document.getElementById('selectAll');
                        if (selectAllCheckbox) {
                            selectAllCheckbox.checked = selectedSuppliers.size === allResults.length;
                        }
                    }
                    
                    // Tab'ı geri yükle
                    if (jsonData.userState && jsonData.userState.currentTab) {
                        switchTab(jsonData.userState.currentTab);
                    }
                    
                    // Tabloyu filtrele
                    filterTable();
                } else {
                    console.warn('⚠️ allResults boş, filterTable çağrılmıyor');
                }
                
                // 8D sayısını güncelle
                await update8DReportCount();

                const message = `✅ Tam yedek başarıyla yüklendi!

📊 Yüklenen Veriler:
- Tedarikçiler: ${stats.suppliers}${stats.suppliers === 0 ? ' ⚠️ Excel yüklenmemiş!' : ''}
- Lokasyonlar: ${stats.locations}
- Dokümanlar: ${stats.documents}
- 8D Raporlar: ${stats.report8D}
- Ayarlar: ${stats.settings}

📅 Yedek Tarihi: ${new Date(jsonData.exportDate).toLocaleString('tr-TR')}

${stats.suppliers === 0 ? '\n⚠️ Tedarikçi verileri için önce Excel dosyasını yükleyin!' : '✅ Veriler başarıyla yüklendi!'}`;

                showAlert(message, stats.suppliers > 0 ? 'success' : 'warning');
                
                console.log('✅ Import tamamlandı:', stats);
                
                // En güncel sertifika verilerini localStorage'dan yükle (merge)
                if (stats.suppliers > 0) {
                    loadSupplierCertData();
                }
                
                // Eğer tedarikçiler yüklendiyse UI'ı güncelle
                if (stats.suppliers > 0) {
                    // İkinci dosya bölümünü göster (eğer monthly scores için gerekiyorsa)
                    document.getElementById('secondUploadSection').style.display = 'block';
                    
                    // Controls bölümünü aktif et
                    document.getElementById('controls').classList.add('active');
                    
                    // Sürüm butonunu güncelle
                    updateEditsVersionButton();
                }
            } catch (error) {
                console.error('Full backup import error:', error);
                throw error;
            }
        }

        // Eski versiyon (v1.0) import - geriye uyumluluk için
        async function importLegacyBackup(jsonData) {
            if (!jsonData.data) {
                showAlert('❌ Eski format veri bulunamadı!', 'error');
                return;
            }

            allResults.forEach(supplier => {
                const savedSupplier = jsonData.data.find(s => s.name === supplier.name);
                if (savedSupplier) {
                    supplier.iatf = savedSupplier.iatf || false;
                    supplier.iso9001 = savedSupplier.iso9001 || false;
                    supplier.iso14001 = savedSupplier.iso14001 || false;
                    supplier.iso45001 = savedSupplier.iso45001 || false;
                    supplier.certExpiryDates = savedSupplier.certExpiryDates || {};
                    supplier.talepEdilen8D = savedSupplier.talepEdilen8D || 0;
                    supplier.cevaplanan8D = savedSupplier.cevaplanan8D || 0;
                    supplier.vdaPuan = savedSupplier.vdaPuan || 0;
                    supplier.terminPuan = savedSupplier.terminPuan || 100;
                    supplier.tamamlanmaPuan = savedSupplier.tamamlanmaPuan || 100;
                    supplier.lokasyon = savedSupplier.lokasyon || [];
                    
                    recalculateSupplierScore(supplier);
                }
            });

            filterTable();
            
            const loadName = jsonData.name || 'Eski Kayıt';
            const loadDate = new Date(jsonData.timestamp).toLocaleString('tr-TR');
            
            // En güncel sertifika verilerini localStorage'dan yükle (merge)
            loadSupplierCertData();
            
            showAlert(`✅ "${loadName}" yüklendi! (${loadDate})\n\n⚠️ Not: Eski format - sadece tedarikçi düzenlemeleri yüklendi.`, 'success');
        }

        // IndexedDB store'a veri ekle/güncelle
        function putToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                try {
                    if (!db.objectStoreNames.contains(storeName)) {
                        console.warn(`Store ${storeName} bulunamadı, atlanıyor`);
                        resolve();
                        return;
                    }
                    
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                } catch (e) {
                    reject(e);
                }
            });
        }

        // ======== Target Agreement Verileri (Global) ========
        // Yapı: { "Tedarikçi Adı": { "2024": { "PPM": { "hedef": 9800, "gerçekleşme": 8500 }, "HataTekrarı": { "hedef": 2, "gerçekleşme": 1.5 } }, "2025": {...} } }
        let targetAgreements = {};

        // ======== Target Agreement Verileri Yükleme ========
        
        function loadTargetAgreementsFromStorage() {
            // localStorage'dan kaydedilmiş Target Agreements'i yükle
            const savedAgreements = localStorage.getItem('targetAgreements');
            if (savedAgreements) {
                try {
                    targetAgreements = JSON.parse(savedAgreements);
                } catch (e) {
                    console.error('Target Agreements yüklenirken hata:', e);
                    targetAgreements = {};
                }
            }
        }

        function saveTargetAgreementsToStorage() {
            try {
                localStorage.setItem('targetAgreements', JSON.stringify(targetAgreements));
            } catch (e) {
                console.error('Target Agreements kaydedilirken hata:', e);
            }
        }

        // Sayfa yüklendiğinde Target Agreements'i yükle
        loadTargetAgreementsFromStorage();

        // ======== Performance Modal Fonksiyonları ========

        function openPerformanceDialog(supplierName) {
            console.log('openPerformanceDialog çağrıldı:', supplierName);
            // Emoji ve extra karakterleri temizle
            supplierName = String(supplierName).trim().replace(/📊|📈|📉|🎯|🔍/g, '').trim();
            console.log('Temizlenmiş supplier name:', supplierName);
            
            const dialog = document.getElementById('performanceDialog');
            const perfSupplierName = document.getElementById('perfSupplierName');
            
            if (!dialog || !perfSupplierName) {
                console.error('Modal öğeleri bulunamadı!');
                alert('Hata: Modal öğeleri bulunamadı!');
                return;
            }
            
            perfSupplierName.textContent = supplierName;
            dialog.style.display = 'flex';
            
            // Listeden tedarikçiyi bul ve hedef/gerçekleşme değerlerini yükle
            const normalizedSearchName = normalizeName(supplierName);
            const supplier = allResults.find(r => {
                // İsim tam eşleşmesi
                if (r.name === supplierName) return true;
                
                // Normalize isim karşılaştırması (normalizedName yoksa on-the-fly hesapla)
                const rNormalized = r.normalizedName || normalizeName(r.name);
                if (rNormalized === normalizedSearchName) return true;
                
                return false;
            });
            
            if (supplier) {
                console.log('Supplier bulundu:', supplier.name, 'Toplam Hata:', supplier.totalHata);
                document.getElementById('perfYear').value = '';
                document.getElementById('perfPPMTarget').value = supplier.ppmTarget || '';
                document.getElementById('perfPPMActual').value = supplier.ppm ? supplier.ppm.toFixed(2) : '0.00';
                document.getElementById('perfDefectTarget').value = supplier.hataHedefi || '';
                document.getElementById('perfDefectActual').value = supplier.totalHata ?? 0;
                
                // Bugünün tarihini gözden geçirme tarihi alanına set et
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reviewDate').value = today;
                
                console.log('Modal input değerleri set edildi - perfDefectActual:', supplier.totalHata);
                
                // Bir sonraki hedefleri hesapla
                calculateNextTargets();
            } else {
                console.error('Supplier bulunamadı:', supplierName, 'Normalized:', normalizedSearchName);
                console.log('KOTAN ile başlayanlar:', allResults.filter(r => r.name.startsWith('KOTAN')).map(r => ({
                    name: r.name, 
                    normalized: r.normalizedName,
                    match: r.normalizedName === normalizedSearchName
                })));
            }
            
            document.getElementById('perfYear').focus();
            
            console.log('Modal açıldı');
        }

        function closePerformanceDialog() {
            document.getElementById('performanceDialog').style.display = 'none';
        }

        // ======== Ana Liste Export Modal Fonksiyonları ========
        let currentExportType = null;

        function openExportDialog(exportType) {
            currentExportType = exportType;
            const dialog = document.getElementById('exportDialog');
            const today = new Date().toISOString().split('T')[0];
            const currentYear = new Date().getFullYear();
            
            document.getElementById('exportYear').value = currentYear;
            document.getElementById('exportReviewDate').value = today;
            
            const confirmBtn = document.getElementById('exportConfirmBtn');
            confirmBtn.onclick = () => {
                const year = document.getElementById('exportYear').value;
                const reviewDate = document.getElementById('exportReviewDate').value;
                
                if (!year || !reviewDate) {
                    showAlert('⚠️ Lütfen tüm alanları doldurun', 'error');
                    return;
                }
                
                closeExportDialog();
                
                if (exportType === 'excel') {
                    exportToExcel(year, reviewDate);
                } else if (exportType === 'pdf') {
                    exportToPDF(year, reviewDate);
                }
            };
            
            dialog.style.display = 'flex';
        }

        function closeExportDialog() {
            document.getElementById('exportDialog').style.display = 'none';
            currentExportType = null;
        }

        function closePerformanceCharts() {
            const modal = document.getElementById('performanceChartModal');
            if (modal) modal.style.display = 'none';
            
            // Modal kapanırken tablo ve dashboard'u güncelle
            if (window.currentSupplierForCallbacks) {
                console.log('📋 Modal kapatılıyor - tablo güncelleniyor...');
                updateSupplierCells(window.currentSupplierForCallbacks.name);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
            }
            
            // Callback referanslarını temizle
            window.currentDefectCallback = null;
            window.currentTerminCallback = null;
            window.currentCompletionCallback = null;
            window.currentSupplierForCallbacks = null;
        }

        function updateKalitePuanValue(supplierName, newValue) {
            const value = Math.max(0, Math.min(100, parseFloat(newValue) || 0));
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier.kalitePuan = value;
                // Tüm aylara da uygula (eğer aylık veri yoksa)
                for (let m = 0; m < 12; m++) {
                    if (!supplier.monthlyKalitePuan[m]) {
                        supplier.monthlyKalitePuan[m] = value;
                    }
                }
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                updateSupplierCells(supplierName);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                showAlert(`✅ ${supplierName} kalite puanı ${value}% olarak güncellendi.`, 'success');
            }
        }

        function updateDefectScorePuan(supplierName, newValue) {
            // Scroll pozisyonunu kaydet
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const tableWrapper = document.querySelector('.table-wrapper');
            const horizontalScrollLeft = tableWrapper ? tableWrapper.scrollLeft : 0;
            
            const value = Math.max(0, Math.min(100, parseFloat(newValue) || 0));
            const supplier = allResults.find(r => r.name === supplierName);
            if (supplier) {
                supplier.hataPuan = value / 100;
                supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                updateSupplierCells(supplierName);
                updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                showAlert(`✅ ${supplierName} hata puanı ${value}% olarak güncellendi.`, 'success');
                
                // Scroll'u geri yükle
                requestAnimationFrame(() => {
                    window.scrollTo(0, scrollY);
                    const newTableWrapper = document.querySelector('.table-wrapper');
                    if (newTableWrapper) {
                        newTableWrapper.scrollLeft = horizontalScrollLeft;
                    }
                });
            }
        }

        function drawBarChart(canvasId, labels, data, color, title, targetLine = null, onBarClick = null, monthNumbers = null) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.clientWidth;
            const h = canvas.height = canvas.height || 180;
            ctx.clearRect(0, 0, w, h);
            const maxVal = Math.max(...data, 1, targetLine || 0);
            const leftPadding = 130;
            const rightPadding = 100;
            const topPadding = 20;
            const bottomPadding = 70;
            
            // Çubuk genişliği ve boşluğu
            const barWidth = (w - leftPadding - rightPadding) / (labels.length || 1) * 0.6;
            const gap = ((w - leftPadding - rightPadding) / (labels.length || 1)) - barWidth;
            
            // Step hesaplama
            const niceStep = (value) => {
                if (value <= 1) return 1;
                const exponent = Math.floor(Math.log10(value));
                const fraction = value / Math.pow(10, exponent);
                let niceFraction = 1;
                if (fraction <= 1) niceFraction = 1;
                else if (fraction <= 2) niceFraction = 2;
                else if (fraction <= 5) niceFraction = 5;
                else niceFraction = 10;
                return niceFraction * Math.pow(10, exponent);
            };
            const step = niceStep(maxVal / 5);
            const maxTick = Math.ceil(maxVal / step) * step;
            
            // Tıklama event'i varsa ekle
            if (onBarClick) {
                // Önceki event listener'ı temizle
                const newCanvas = canvas.cloneNode(true);
                canvas.parentNode.replaceChild(newCanvas, canvas);
                const newCtx = newCanvas.getContext('2d');
                
                newCanvas.addEventListener('click', function(e) {
                    const rect = newCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Hangi çubuğa tıklandığını bul - tüm sütun alanını kapsayacak şekilde
                    labels.forEach((label, i) => {
                        const barX = leftPadding + i * (barWidth + gap) + gap / 2;
                        const barY = h - bottomPadding;
                        const barHeight = maxTick === 0 ? 0 : (data[i] / maxTick) * (h - topPadding - bottomPadding);
                        
                        // Tüm sütun yüksekliği boyunca tıklanabilir yap (sıfır değerler için de)
                        if (x >= barX && x <= barX + barWidth && y >= topPadding && y <= barY) {
                            const monthNum = monthNumbers ? monthNumbers[i] : i+1;
                            onBarClick(i, label, data[i], monthNum);
                        }
                    });
                });
                
                // Yeniden çiz (yeni canvas'a)
                return drawBarChartOnCanvas(newCanvas, newCtx, labels, data, color, title, targetLine, w, h, leftPadding, rightPadding, topPadding, bottomPadding, barWidth, gap, maxVal);
            }
            
            drawBarChartOnCanvas(canvas, ctx, labels, data, color, title, targetLine, w, h, leftPadding, rightPadding, topPadding, bottomPadding, barWidth, gap, maxVal);
        }
        
        function drawBarChartOnCanvas(canvas, ctx, labels, data, color, title, targetLine, w, h, leftPadding, rightPadding, topPadding, bottomPadding, barWidth, gap, maxVal) {
            ctx.clearRect(0, 0, w, h);
            
            // Eksenleri çiz
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            
            // Y ekseni (dikey)
            ctx.beginPath();
            ctx.moveTo(leftPadding, topPadding);
            ctx.lineTo(leftPadding, h - bottomPadding);
            ctx.stroke();
            
            // X ekseni (yatay)
            ctx.beginPath();
            ctx.moveTo(leftPadding, h - bottomPadding);
            ctx.lineTo(w - rightPadding, h - bottomPadding);
            ctx.stroke();
            
            // Y ekseni etiketleri (okunaklı adımlar)
            ctx.font = '11px Segoe UI';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';

            const niceStep = (value) => {
                if (value <= 1) return 1;
                const exponent = Math.floor(Math.log10(value));
                const fraction = value / Math.pow(10, exponent);
                let niceFraction = 1;
                if (fraction <= 1) niceFraction = 1;
                else if (fraction <= 2) niceFraction = 2;
                else if (fraction <= 5) niceFraction = 5;
                else niceFraction = 10;
                return niceFraction * Math.pow(10, exponent);
            };

            const step = niceStep(maxVal / 5);
            const maxTick = Math.ceil(maxVal / step) * step;
            const tickCount = Math.max(1, Math.round(maxTick / step));

            for (let i = 0; i <= tickCount; i++) {
                const yVal = step * i;
                const yPos = h - bottomPadding - (yVal / maxTick) * (h - topPadding - bottomPadding);
                
                // Y ekseni sayı değerleri
                ctx.fillStyle = '#666';
                ctx.font = '11px Segoe UI';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(yVal.toFixed(0), leftPadding - 10, yPos);
                
                if (i > 0) {
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(leftPadding, yPos);
                    ctx.lineTo(w - rightPadding, yPos);
                    ctx.stroke();
                }
            }
            
            // Çubuklar ve etiketler
            ctx.font = '11px Segoe UI';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            
            labels.forEach((label, i) => {
                const val = data[i] ?? 0;
                const x = leftPadding + i * (barWidth + gap) + gap / 2;
                const y = h - bottomPadding;
                const barHeight = maxTick === 0 ? 0 : (val / maxTick) * (h - topPadding - bottomPadding);
                
                // Çubuk
                ctx.fillStyle = color;
                ctx.fillRect(x, y - barHeight, barWidth, barHeight);
                
                // Değer (çubuk üstünde)
                ctx.fillStyle = '#333';
                ctx.font = '10px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(val.toFixed(0), x + barWidth / 2, y - barHeight - 3);
                
                // X eksen etiketi (ay adları döndürülü)
                ctx.save();
                ctx.translate(x + barWidth / 2, y + 12);
                ctx.rotate(-Math.PI / 4);
                ctx.font = '10px Segoe UI';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText(label, 0, 0);
                ctx.restore();
            });
            
            // Hedef çizgisi (varsa)
            if (targetLine !== null && targetLine > 0) {
                const targetY = h - bottomPadding - (targetLine / maxTick) * (h - topPadding - bottomPadding);
                
                // Kırmızı kesikli çizgi
                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(leftPadding, targetY);
                ctx.lineTo(w - rightPadding, targetY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Hedef etiketi - sağdaki boşlukta çizgiyle aynı hizada
                ctx.fillStyle = '#dc3545';
                ctx.font = 'bold 11px Segoe UI';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textX = w - rightPadding / 2;
                ctx.fillText('Hedef:', textX, targetY - 12);
                ctx.font = 'bold 13px Segoe UI';
                ctx.fillText(targetLine.toFixed(0), textX, targetY + 8);
            }

        }

        function openPerformanceCharts(supplierKey) {
            const modal = document.getElementById('performanceChartModal');
            if (!modal) return;
            const supplier = allResults.find(r => (r.mapKey || r.name) === supplierKey || r.name === supplierKey);
            if (!supplier) {
                showAlert('⚠️ Tedarikçi bulunamadı.', 'error');
                return;
            }
            const avgPPM = supplier.ppm || 0;
            const supplierClass = supplier.tedarikcisınıfı || '-';
            const isMusteri = supplier.status && supplier.status.toUpperCase() === 'MÜŞTERİ';
            
            // Sınıf rengini belirle
            let classColor = '#666';
            if (supplierClass === 'A') classColor = '#92D050';
            else if (supplierClass === 'B') classColor = '#FFFF00';
            else if (supplierClass === 'C') classColor = '#FFC000';
            else if (supplierClass === 'D') classColor = '#FF0000';
            
            // PPM rengini belirle
            let ppmColor = '#666';
            if (avgPPM > supplier.ppmTarget * 2) ppmColor = '#dc3545';
            else if (avgPPM > supplier.ppmTarget) ppmColor = '#ffc107';
            else ppmColor = '#28a745';
            
            // HTML ile renkli başlık oluştur
            const titleHTML = `📊 ${supplier.name} - Performans Grafikleri (<span style="color: ${classColor}; font-weight: bold;">Sınıf: ${supplierClass}</span> | <span style="color: ${ppmColor}; font-weight: bold;">Ortalama PPM: ${avgPPM.toFixed(0)}</span>)`;
            document.getElementById('perfChartTitle').innerHTML = titleHTML;
            modal.style.display = 'flex';
            modal.setAttribute('data-supplier-name', supplier.name);

            const months = Array.from(selectedMonths).sort((a,b)=>a-b);
            const monthLabels = months.map(m => `${m}.Ay`);

            // Ayarlanmış aylık PPM değerlerini kullan (monthlyPPM dizisi varsa)
            const ppmSeries = months.map(m => {
                if (supplier.monthlyPPM && Array.isArray(supplier.monthlyPPM)) {
                    return supplier.monthlyPPM[m-1] || 0;
                }
                const sevk = supplier.monthlySevk?.[m-1] || 0;
                const iade = supplier.monthlyIade?.[m-1] || 0;
                return sevk > 0 ? (iade / sevk) * 1_000_000 : 0;
            });

            const defectSeries = months.map(m => supplier.monthlyHata?.[m-1] || 0);
            const vdaConst = supplier.vdaPuan || 0;
            const kaliteConst = supplier.kalitePuan || 0;
            const donus8DConst = supplier.donusOrani8D || 100;
            const vdaSeries = [vdaConst];
            const kaliteSeries = [kaliteConst];
            const donus8DSeries = [donus8DConst];
            
            // Aylık PPM puanlarını hesapla (her ay için ayrı 100 üzerinden)
            const ppmTarget = supplier.ppmTarget || 1000;
            const ppmPuanSeries = months.map(m => {
                // Aylık PPM değerini al
                const monthlyPPM = ppmSeries[months.indexOf(m)];
                
                // PPM puanı hesaplama formülü
                let ppmPuan = 0;
                if (monthlyPPM === 0) {
                    ppmPuan = 100; // Hiç iade yoksa tam puan
                } else if (monthlyPPM <= ppmTarget / 4) {
                    ppmPuan = 100;
                } else if (monthlyPPM <= ppmTarget / 2) {
                    ppmPuan = 90;
                } else if (monthlyPPM <= ppmTarget) {
                    ppmPuan = 70;
                } else if (monthlyPPM <= ppmTarget * 1.5) {
                    ppmPuan = 50;
                } else if (monthlyPPM <= ppmTarget * 2) {
                    ppmPuan = 30;
                } else {
                    ppmPuan = 0;
                }
                
                return ppmPuan;
            });
            
            const returnPPMSeries = ppmSeries; // ayarlanmış değerleri kullan
            const terminSeries = months.map(m => {
                const val = supplier.monthlyTerminPuan?.[m-1];
                return (val !== undefined && val !== null) ? val : 100;
            });
            const completionSeries = months.map(m => {
                const val = supplier.monthlyTamamlanmaPuan?.[m-1];
                return (val !== undefined && val !== null) ? val : 100;
            });
            const defectScoreSeries = months.map(m => {
                const hata = supplier.monthlyHata?.[m-1] || 0;
                const target = supplier.hataHedefi || 2;
                if (hata === 0) return 100;
                if (target / hata > 1) return 100;
                return Math.max(0, Math.min(100, (target / hata) * 100));
            });

            document.getElementById('perfChartSupplierInfo').textContent =
                `Seçili aylar: ${months.join(', ')}`;
            
            // Müşteri için grafikleri gizle/göster
            const hideElements = document.querySelectorAll('.hide-for-musteri');
            hideElements.forEach(el => {
                el.style.display = isMusteri ? 'none' : 'block';
            });

            drawBarChart('chartPPMPuan', monthLabels, ppmPuanSeries, '#42a5f5', 'PPM Puanı');
            
            // Hata grafiği için callback fonksiyonu
            const defectCallback = (index, label, currentValue) => {
                const monthIndex = months[index] - 1;
                
                // Canvas'ın pozisyonunu al
                const canvas = document.getElementById('chartDefect');
                const rect = canvas.getBoundingClientRect();
                
                // Çubuğun pozisyonunu hesapla
                const leftPadding = 130;
                const rightPadding = 100;
                const barWidth = (canvas.width - leftPadding - rightPadding) / (monthLabels.length || 1) * 0.6;
                const gap = ((canvas.width - leftPadding - rightPadding) / (monthLabels.length || 1)) - barWidth;
                const barX = leftPadding + index * (barWidth + gap) + gap / 2;
                
                // Input elementi oluştur
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.step = '1';
                input.value = currentValue;
                input.style.position = 'fixed';
                input.style.left = (rect.left + barX + barWidth/2 - 40) + 'px';
                input.style.top = (rect.top + 60) + 'px';
                input.style.width = '80px';
                input.style.padding = '8px';
                input.style.border = '3px solid #e53935';
                input.style.borderRadius = '6px';
                input.style.fontSize = '16px';
                input.style.fontWeight = 'bold';
                input.style.zIndex = '10001';
                input.style.backgroundColor = '#fff';
                input.style.boxShadow = '0 4px 12px rgba(229, 57, 53, 0.4)';
                input.style.textAlign = 'center';
                
                document.body.appendChild(input);
                input.focus();
                input.select();
                
                // Enter tuşuna basıldığında kaydet
                const saveValue = () => {
                    let newValue = parseFloat(input.value);
                    
                    // Tam sayıya yuvarla
                    newValue = Math.round(newValue);
                    
                    if (!isNaN(newValue) && newValue >= 0) {
                        const oldValue = supplier.monthlyHata[monthIndex] || 0;
                        const difference = newValue - oldValue;
                        
                        // Aylık hata değerini güncelle
                        supplier.monthlyHata[monthIndex] = newValue;
                        
                        // GRAFİKTEKİ ayları kullan (zaten months değişkeninde var - closure)
                        const currentMonths = months;
                        
                        // Toplam hatayı güncelle
                        if (difference !== 0) {
                            // Fark kadar ekle/çıkar
                            supplier.totalHata = Math.max(0, Math.round((supplier.totalHata || 0) + difference));
                        }
                        
                        console.log(`📊 Hata grafiği güncellendi: Ay ${monthIndex + 1}, Eski=${oldValue}, Yeni=${newValue}, Fark=${difference}, Toplam=${supplier.totalHata}`);
                        
                        // Hata puanını yeniden hesapla
                        const hataHedefi = supplier.hataHedefi || 2;
                        // Excel formülü
                        if (hataHedefi === 0) {
                            supplier.hataPuan = supplier.totalHata === 0 ? 1 : 0;
                        } else if (supplier.totalHata === 0) {
                            supplier.hataPuan = 1;
                        } else if ((hataHedefi / supplier.totalHata) > 1) {
                            supplier.hataPuan = 1;
                        } else {
                            supplier.hataPuan = hataHedefi / supplier.totalHata;
                        }
                        
                        // Tedarikçi puanını yeniden hesapla
                        supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                        supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                        
                        // Tabloyu güncelle (toplam hata dahil)
                        updateSupplierCells(supplier.name);
                        updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                        
                        // Düzenlemeleri kaydet
                        saveEditsToLocalStorage();
                        
                        // Modal içindeki Toplam Hata alanını güncelle
                        const perfDefectActual = document.getElementById('perfDefectActual');
                        if (perfDefectActual) {
                            perfDefectActual.value = supplier.totalHata;
                            console.log('Modal Toplam Hata güncellendi:', supplier.totalHata);
                            // Bir sonraki hedefleri yeniden hesapla
                            calculateNextTargets();
                        } else {
                            console.log('perfDefectActual elementi bulunamadı - modal açık değil olabilir');
                        }
                        
                        // Grafikleri yeniden çiz (modal açık kalacak şekilde)
                        const defectSeriesNew = months.map(m => supplier.monthlyHata?.[m-1] || 0);
                        const defectScoreSeriesNew = months.map(m => {
                            const hata = supplier.monthlyHata?.[m-1] || 0;
                            const target = supplier.hataHedefi || 2;
                            if (hata === 0) return 100;
                            if (target / hata > 1) return 100;
                            return Math.max(0, Math.min(100, (target / hata) * 100));
                        });
                        
                        // Sadece hata grafiklerini yeniden çiz
                        drawBarChart('chartDefect', monthLabels, defectSeriesNew, '#e53935', 'Hata Sayısı', null, defectCallback);
                        drawBarChart('chartDefectScore', monthLabels, defectScoreSeriesNew, '#f4511e', 'Hata Puanı');
                    }
                    input.remove();
                };
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveValue();
                    } else if (e.key === 'Escape') {
                        input.remove();
                    }
                });
                
                input.addEventListener('blur', () => {
                    setTimeout(() => input.remove(), 200);
                });
            };
            
            // Termin callback FACTORY fonksiyonu - ayları parametre olarak al
            const createTerminCallback = (monthsArray) => {
                return (index, label, currentValue, monthNumber) => {
                    const targetMonth = (monthsArray && monthsArray[index]) ? monthsArray[index] : monthNumber || (index + 1);
                    const monthIndex = Math.max(0, Math.min(11, targetMonth - 1));
                    console.log(`🎯 TERMIN CALLBACK: index=${index}, label="${label}", value=${currentValue}, monthNumber=${targetMonth}`);
                    console.log(`📍 Hesaplanan monthIndex: ${monthIndex} (Ay ${targetMonth})`);
                    
                    const canvas = document.getElementById('chartTermin');
                    const rect = canvas.getBoundingClientRect();
                    
                    // FACTORY'den gelen ayları kullan (parametre olarak alındı)
                    const currentMonths = monthsArray;
                    const currentMonthLabels = currentMonths.map(m => `${m}.Ay`);
                    console.log(`📅 Grafikteki aylar (factory): ${JSON.stringify(currentMonths)}`);
                
                const leftPadding = 130;
                const rightPadding = 100;
                const barWidth = (canvas.width - leftPadding - rightPadding) / (currentMonthLabels.length || 1) * 0.6;
                const gap = ((canvas.width - leftPadding - rightPadding) / (currentMonthLabels.length || 1)) - barWidth;
                const barX = leftPadding + index * (barWidth + gap) + gap / 2;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.max = '100';
                input.step = '1';
                input.value = currentValue;
                input.style.position = 'fixed';
                input.style.left = (rect.left + barX + barWidth/2 - 40) + 'px';
                input.style.top = (rect.top + 60) + 'px';
                input.style.width = '80px';
                input.style.padding = '8px';
                input.style.border = '3px solid #3949ab';
                input.style.borderRadius = '6px';
                input.style.fontSize = '16px';
                input.style.fontWeight = 'bold';
                input.style.zIndex = '10001';
                input.style.backgroundColor = '#fff';
                input.style.boxShadow = '0 4px 12px rgba(57, 73, 171, 0.4)';
                input.style.textAlign = 'center';
                
                document.body.appendChild(input);
                input.focus();
                input.select();
                
                const saveValue = () => {
                    let newValue = parseFloat(input.value);
                    if (!isNaN(newValue)) {
                        if (newValue < 0) newValue = 0;
                        if (newValue > 100) newValue = 100;
                        
                        // Array'in bağımsız kopyasını al ve sadece hedef ayı değiştir
                        const baseArray = (supplier.monthlyTerminPuan && Array.isArray(supplier.monthlyTerminPuan))
                            ? supplier.monthlyTerminPuan
                            : Array.from({length: 12}, () => 100);
                        const snapshotArray = baseArray.slice(0, 12); // 12 elemanlık kopya
                        console.log(`🔵 Termin değiştiriliyor: Çubuk index=${index}, Ay=${targetMonth}, Array index=${monthIndex}`);
                        console.log('Eski dizi:', JSON.stringify(snapshotArray));
                        console.log('Değiştirilecek index:', monthIndex, 'Yeni değer:', newValue);
                        snapshotArray[monthIndex] = newValue;
                        supplier.monthlyTerminPuan = snapshotArray; // tek atama
                        console.log('Yeni dizi:', JSON.stringify(snapshotArray));
                        console.log('Kontrol - değişen index:', snapshotArray[monthIndex]);
                        console.log('Supplier referansı:', supplier.name);
                        
                        // MANUEL DÜZENLEME KAYDI - Excel yüklendiğinde korunması için
                        if (!manualMonthlyEdits[supplier.name]) {
                            manualMonthlyEdits[supplier.name] = { termin: [], tamamlanma: [] };
                        }
                        if (!manualMonthlyEdits[supplier.name].termin.includes(targetMonth)) {
                            manualMonthlyEdits[supplier.name].termin.push(targetMonth);
                            console.log(`📝 Manuel düzenleme kaydedildi: ${supplier.name} - Termin - Ay ${targetMonth}`);
                        }
                        
                        // Ortalamayı yeniden hesapla (TÜM 12 aydan)
                        supplier.terminPuan = snapshotArray.reduce((a,b)=>a+b,0) / 12;
                        console.log('Yeni ortalama (tüm 12 ay):', supplier.terminPuan.toFixed(2));
                        
                        // Tedarikçi puanını yeniden hesapla
                        supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                        supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                        
                        // HEMEN tablo ve dashboard güncelle
                        updateSupplierCells(supplier.name);
                        updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                        
                        // Düzenlemeleri kaydet
                        saveEditsToLocalStorage();
                        
                        console.log(`✅ ${supplier.name} güncellendi - Yeni termin puanı: ${supplier.terminPuan.toFixed(2)}`);
                        
                        // Grafiği yeniden çiz - SNAPSHOT kullan (değişmemiş veriler)
                        const currentMonthLabels = currentMonths.map(m => `${m}.Ay`);
                        const terminSeriesNew = currentMonths.map(m => {
                            const val = snapshotArray[m-1];
                            console.log(`Ay ${m} için değer (snapshot): ${val}`);
                            return val !== undefined ? val : 100;
                        });
                        console.log('Grafik verisi (snapshot):', JSON.stringify(terminSeriesNew));
                        
                        // YENİ callback oluştur - currentMonths'ı parametre olarak geç
                        const newTerminCallback = createTerminCallback(currentMonths);
                        
                        drawBarChart('chartTermin', currentMonthLabels, terminSeriesNew, '#3949ab', 'Termin', null, newTerminCallback, currentMonths);
                        
                        // Tabloyu da güncelle (gecikme günleri puandan hesaplanacak)
                        const modal = document.getElementById('performanceChartModal');
                        if (modal && modal.style.display === 'flex') {
                            const ppmSeries = currentMonths.map(m => {
                                if (supplier.monthlyPPM && Array.isArray(supplier.monthlyPPM)) {
                                    return supplier.monthlyPPM[m-1] || 0;
                                }
                                const sevk = supplier.monthlySevk?.[m-1] || 0;
                                const iade = supplier.monthlyIade?.[m-1] || 0;
                                return sevk > 0 ? (iade / sevk) * 1_000_000 : 0;
                            });
                            const completionSeriesNew = currentMonths.map(m => {
                                const val = supplier.monthlyTamamlanmaPuan?.[m-1];
                                return (val !== undefined && val !== null) ? val : 100;
                            });
                            populateModalTables(supplier, currentMonths, currentMonthLabels, ppmSeries, terminSeriesNew, completionSeriesNew);
                        }
                    }
                    input.remove();
                };
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') saveValue();
                    else if (e.key === 'Escape') input.remove();
                });
                input.addEventListener('blur', () => setTimeout(() => input.remove(), 200));
                };
            }; // createTerminCallback factory fonksiyonunun sonu
            
            // İlk callback'i oluştur
            const terminCallback = createTerminCallback(months);
            
            // Tamamlanma callback FACTORY fonksiyonu - ayları parametre olarak al
            const createCompletionCallback = (monthsArray) => {
                return (index, label, currentValue, monthNumber) => {
                    const targetMonth = (monthsArray && monthsArray[index]) ? monthsArray[index] : monthNumber || (index + 1);
                    const monthIndex = Math.max(0, Math.min(11, targetMonth - 1));
                    console.log(`🎯 TAMAMLANMA CALLBACK: index=${index}, label="${label}", value=${currentValue}, monthNumber=${targetMonth}`);
                    console.log(`📍 Hesaplanan monthIndex: ${monthIndex} (Ay ${targetMonth})`);
                    
                    const canvas = document.getElementById('chartCompletion');
                    const rect = canvas.getBoundingClientRect();
                    
                    // FACTORY'den gelen ayları kullan (parametre olarak alındı)
                    const currentMonths = monthsArray;
                    const currentMonthLabels = currentMonths.map(m => `${m}.Ay`);
                    console.log(`📅 Grafikteki aylar (factory): ${JSON.stringify(currentMonths)}`);
                
                const leftPadding = 130;
                const rightPadding = 100;
                const barWidth = (canvas.width - leftPadding - rightPadding) / (currentMonthLabels.length || 1) * 0.6;
                const gap = ((canvas.width - leftPadding - rightPadding) / (currentMonthLabels.length || 1)) - barWidth;
                const barX = leftPadding + index * (barWidth + gap) + gap / 2;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.max = '100';
                input.step = '1';
                input.value = currentValue;
                input.style.position = 'fixed';
                input.style.left = (rect.left + barX + barWidth/2 - 40) + 'px';
                input.style.top = (rect.top + 60) + 'px';
                input.style.width = '80px';
                input.style.padding = '8px';
                input.style.border = '3px solid #00796b';
                input.style.borderRadius = '6px';
                input.style.fontSize = '16px';
                input.style.fontWeight = 'bold';
                input.style.zIndex = '10001';
                input.style.backgroundColor = '#fff';
                input.style.boxShadow = '0 4px 12px rgba(0, 121, 107, 0.4)';
                input.style.textAlign = 'center';
                
                document.body.appendChild(input);
                input.focus();
                input.select();
                
                const saveValue = () => {
                    let newValue = parseFloat(input.value);
                    if (!isNaN(newValue)) {
                        if (newValue < 0) newValue = 0;
                        if (newValue > 100) newValue = 100;
                        
                        // Array'in bağımsız kopyasını al ve sadece hedef ayı değiştir
                        const baseArray = (supplier.monthlyTamamlanmaPuan && Array.isArray(supplier.monthlyTamamlanmaPuan))
                            ? supplier.monthlyTamamlanmaPuan
                            : Array.from({length: 12}, () => 100);
                        const snapshotArray = baseArray.slice(0, 12); // 12 elemanlık kopya
                        console.log(`🟢 Tamamlanma değiştiriliyor: Çubuk index=${index}, Ay=${targetMonth}, Array index=${monthIndex}`);
                        console.log('Eski dizi:', JSON.stringify(snapshotArray));
                        console.log('Değiştirilecek index:', monthIndex, 'Yeni değer:', newValue);
                        snapshotArray[monthIndex] = newValue;
                        supplier.monthlyTamamlanmaPuan = snapshotArray; // tek atama
                        console.log('Yeni dizi:', JSON.stringify(snapshotArray));
                        console.log('Kontrol - değişen index:', snapshotArray[monthIndex]);
                        console.log('Supplier referansı:', supplier.name);
                        
                        // MANUEL DÜZENLEME KAYDI - Excel yüklendiğinde korunması için
                        if (!manualMonthlyEdits[supplier.name]) {
                            manualMonthlyEdits[supplier.name] = { termin: [], tamamlanma: [] };
                        }
                        if (!manualMonthlyEdits[supplier.name].tamamlanma.includes(targetMonth)) {
                            manualMonthlyEdits[supplier.name].tamamlanma.push(targetMonth);
                            console.log(`📝 Manuel düzenleme kaydedildi: ${supplier.name} - Tamamlanma - Ay ${targetMonth}`);
                        }
                        
                        // Ortalamayı yeniden hesapla (TÜM 12 aydan)
                        supplier.tamamlanmaPuan = snapshotArray.reduce((a,b)=>a+b,0) / 12;
                        console.log('Yeni ortalama (tüm 12 ay):', supplier.tamamlanmaPuan.toFixed(2));
                        
                        // Tedarikçi puanını yeniden hesapla
                        supplier.tedarikcipuani = calculateTedarikcipuani(supplier);
                        supplier.tedarikcisınıfı = calculateTedarikcisınıfı(supplier.tedarikcipuani);
                        
                        // HEMEN tablo ve dashboard güncelle
                        updateSupplierCells(supplier.name);
                        updateDashboard(lastFilteredResults.length ? lastFilteredResults : allResults);
                        
                        // Düzenlemeleri kaydet
                        saveEditsToLocalStorage();
                        
                        console.log(`✅ ${supplier.name} güncellendi - Yeni tamamlanma puanı: ${supplier.tamamlanmaPuan.toFixed(2)}`);
                        
                        // Grafiği yeniden çiz - SNAPSHOT kullan (değişmemiş veriler)
                        const currentMonthLabels = currentMonths.map(m => `${m}.Ay`);
                        const completionSeriesNew = currentMonths.map(m => {
                            const val = snapshotArray[m-1];
                            console.log(`Ay ${m} için değer (snapshot): ${val}`);
                            return val !== undefined ? val : 100;
                        });
                        console.log('Grafik verisi (snapshot):', JSON.stringify(completionSeriesNew));
                        
                        // YENİ callback oluştur - currentMonths'ı parametre olarak geç
                        const newCompletionCallback = createCompletionCallback(currentMonths);
                        
                        drawBarChart('chartCompletion', currentMonthLabels, completionSeriesNew, '#00796b', 'Tamamlanma', null, newCompletionCallback, currentMonths);
                        
                        // Tabloyu da güncelle
                        const modal = document.getElementById('performanceChartModal');
                        if (modal && modal.style.display === 'flex') {
                            const ppmSeries = currentMonths.map(m => {
                                if (supplier.monthlyPPM && Array.isArray(supplier.monthlyPPM)) {
                                    return supplier.monthlyPPM[m-1] || 0;
                                }
                                const sevk = supplier.monthlySevk?.[m-1] || 0;
                                const iade = supplier.monthlyIade?.[m-1] || 0;
                                return sevk > 0 ? (iade / sevk) * 1_000_000 : 0;
                            });
                            const terminSeriesNew = currentMonths.map(m => {
                                const val = supplier.monthlyTerminPuan?.[m-1];
                                return (val !== undefined && val !== null) ? val : 100;
                            });
                            populateModalTables(supplier, currentMonths, currentMonthLabels, ppmSeries, terminSeriesNew, completionSeriesNew);
                        }
                    }
                    input.remove();
                };
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') saveValue();
                    else if (e.key === 'Escape') input.remove();
                });
                input.addEventListener('blur', () => setTimeout(() => input.remove(), 200));
                };
            }; // createCompletionCallback factory fonksiyonunun sonu
            
            // İlk callback'leri oluştur
            const completionCallback = createCompletionCallback(months);
            
            // Callback'leri global olarak kaydet (listeden güncelleme için)
            window.currentDefectCallback = defectCallback;
            window.currentTerminCallback = terminCallback;
            window.currentCompletionCallback = completionCallback;
            window.currentSupplierForCallbacks = supplier; // Supplier referansını da kaydet
            
            drawBarChart('chartDefect', monthLabels, defectSeries, '#e53935', 'Hata Sayısı', null, defectCallback);
            
            // 8D Butonlarını oluştur (async olarak)
            create8DButtons(supplier.name, months);
            
            if (!isMusteri) {
                drawBarChart('chartVDA', ['Sabit'], vdaSeries, '#8e24aa', 'VDA');
                drawBarChart('chartQuality', ['Sabit'], kaliteSeries, '#43a047', 'Kalite Belge');
            }
            drawBarChart('chart8D', ['Sabit'], donus8DSeries, '#0288d1', '8D Dönüş Oranı');
            drawBarChart('chartReturnPPM', monthLabels, returnPPMSeries, '#fb8c00', 'İade PPM', ppmTarget);
            if (!isMusteri) {
                drawBarChart('chartTermin', monthLabels, terminSeries, '#3949ab', 'Termin', null, terminCallback, months);
                drawBarChart('chartCompletion', monthLabels, completionSeries, '#00796b', 'Tamamlanma', null, completionCallback, months);
            }
            drawBarChart('chartDefectScore', monthLabels, defectScoreSeries, '#f4511e', 'Hata Puanı');
            
            // Tabloları doldur
            populateModalTables(supplier, months, monthLabels, returnPPMSeries, terminSeries, completionSeries);
        }
        
        // Modal tabloları dolduran fonksiyon
        function populateModalTables(supplier, months, monthLabels, ppmSeries, terminSeries, completionSeries) {
            console.log(`📊 populateModalTables çağrıldı: ${supplier.name}`);
            console.log(`   monthlyTerminGecikmeGun:`, supplier.monthlyTerminGecikmeGun);
            
            // PPM Tablosu (Yatay - aylar sütunlarda)
            const ppmTableDiv = document.getElementById('modalTablePPM');
            if (ppmTableDiv) {
                let ppmHTML = `
                    <div style="padding-left: 130px; padding-right: 100px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75em;">
                            <thead>
                                <tr style="background: #ff9800; color: white;">
                                    <th style="padding: 6px; border: 1px solid #ff9800; text-align: left; width: 80px;">Veri</th>
                                    ${months.map(m => `<th style="padding: 6px; border: 1px solid #ff9800; text-align: center;">${m}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #fff;">
                                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: 600; background: #ffe0b2;">Sevk</td>
                                    ${months.map(m => {
                                        const sevk = supplier.monthlySevk?.[m-1] || 0;
                                        return `<td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${sevk.toLocaleString('tr-TR')}</td>`;
                                    }).join('')}
                                </tr>
                                <tr style="background: #f9f9f9;">
                                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: 600; background: #ffe0b2;">İade</td>
                                    ${months.map(m => {
                                        const iade = supplier.monthlyIade?.[m-1] || 0;
                                        return `<td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${iade.toLocaleString('tr-TR')}</td>`;
                                    }).join('')}
                                </tr>
                                <tr style="background: #fff;">
                                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: 600; background: #ffe0b2;">PPM</td>
                                    ${months.map((m, idx) => {
                                        const ppm = ppmSeries[idx] || 0;
                                        return `<td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: 600;">${ppm.toFixed(0)}</td>`;
                                    }).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                ppmTableDiv.innerHTML = ppmHTML;
            }
            
            // Termin Tablosu (Yatay - aylar sütunlarda, gecikme günü ile)
            const terminTableDiv = document.getElementById('modalTableTermin');
            if (terminTableDiv) {
                let terminHTML = `
                    <div style="padding-left: 130px; padding-right: 100px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75em;">
                            <thead>
                                <tr style="background: #3949ab; color: white;">
                                    <th style="padding: 6px; border: 1px solid #3949ab; text-align: left; width: 80px;">Veri</th>
                                    ${months.map(m => `<th style="padding: 6px; border: 1px solid #3949ab; text-align: center;">${m}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #fff;">
                                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: 600; background: #c5cae9;">Gecikme (gün)</td>
                                    ${months.map((m, idx) => {
                                        const puan = terminSeries[idx] || 100;
                                        // Önce gerçek gün değerine bak (Excel'den gelen), yoksa puandan hesapla
                                        let gun;
                                        const gecikmeGunArr = supplier.monthlyTerminGecikmeGun;
                                        const hasRealValue = gecikmeGunArr && gecikmeGunArr[m-1] !== null && gecikmeGunArr[m-1] !== undefined;
                                        
                                        console.log(`🔍 Modal Tablo: ${supplier.name} Ay ${m}, idx=${idx}, m-1=${m-1}, hasArray=${!!gecikmeGunArr}, hasValue=${hasRealValue}, value=${hasRealValue ? gecikmeGunArr[m-1] : 'N/A'}`);
                                        
                                        if (hasRealValue) {
                                            gun = gecikmeGunArr[m-1]; // Gerçek değer (EKSİ GÜNLER DAHİL!)
                                            console.log(`✅ GERÇEK GÜN KULLANILDI: ${Math.round(gun)}`);
                                        } else {
                                            gun = terminPuanToGecikmeGun(puan); // Puandan hesapla
                                            console.log(`⚠️ Puandan hesaplandı: ${Math.round(gun)}`);
                                        }
                                        const gunText = gun > 0 ? `+${Math.round(gun)}` : gun < 0 ? Math.round(gun) : '0';
                                        const color = gun > 0 ? '#d32f2f' : gun < 0 ? '#388e3c' : '#666';
                                        return `<td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: ${color}; font-weight: 600;">${gunText}</td>`;
                                    }).join('')}
                                </tr>
                                <tr style="background: #f9f9f9;">
                                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: 600; background: #c5cae9;">Puan (%)</td>
                                    ${months.map((m, idx) => {
                                        const puan = terminSeries[idx] || 100;
                                        return `<td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: 600;">${puan.toFixed(1)}%</td>`;
                                    }).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                terminTableDiv.innerHTML = terminHTML;
            }
            
            // Tamamlanma Tablosu (Yatay - aylar sütunlarda)
            const tamamlanmaTableDiv = document.getElementById('modalTableTamamlanma');
            if (tamamlanmaTableDiv) {
                let tamamlanmaHTML = `
                    <div style="padding-left: 130px; padding-right: 100px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75em;">
                            <thead>
                                <tr style="background: #00796b; color: white;">
                                    <th style="padding: 6px; border: 1px solid #00796b; text-align: left; width: 80px;">Veri</th>
                                    ${months.map(m => `<th style="padding: 6px; border: 1px solid #00796b; text-align: center;">${m}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #f9f9f9;">
                                    <td style="padding: 6px; border: 1px solid #ddd; font-weight: 600; background: #b2dfdb;">Puan (%)</td>
                                    ${months.map((m, idx) => {
                                        const puan = completionSeries[idx] || 100;
                                        return `<td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: 600;">${puan.toFixed(1)}%</td>`;
                                    }).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                tamamlanmaTableDiv.innerHTML = tamamlanmaHTML;
            }
        }
        
        // Modal tabloları göster/gizle
        function toggleModalTable(tableId) {
            const table = document.getElementById(tableId);
            if (table) {
                if (table.style.display === 'none') {
                    table.style.display = 'block';
                } else {
                    table.style.display = 'none';
                }
            }
        }

        function calculateNextTargets() {
            const ppmTarget = parseFloat(document.getElementById('perfPPMTarget').value) || 0;
            const ppmActual = parseFloat(document.getElementById('perfPPMActual').value) || 0;
            const defectTarget = parseFloat(document.getElementById('perfDefectTarget').value) || 0;
            const defectActual = parseFloat(document.getElementById('perfDefectActual').value) || 0;
            
            // PPM için sonraki hedefi hesapla ve tamsayıya yuvarla
            const ppmNextTarget = calculateNextTarget(ppmTarget, ppmActual);
            document.getElementById('perfPPMNextTarget').value = ppmNextTarget ? Math.round(ppmNextTarget) : '';
            
            // Hata için sonraki hedefi hesapla ve tamsayıya yuvarla
            const defectNextTarget = calculateNextTarget(defectTarget, defectActual);
            document.getElementById('perfDefectNextTarget').value = defectNextTarget ? Math.round(defectNextTarget) : '';
        }

        function calculateNextTarget(hedef, gerçekleşme) {
            if (!hedef || hedef === 0) return '';
            
            // Eğer gerçekleşme < hedef: sonraki = hedef × 0.9
            if (gerçekleşme < hedef) {
                return (hedef * 0.9).toFixed(2);
            }
            // Eğer hedef ≤ gerçekleşme ≤ hedef×1.2: sonraki = aynı hedef
            else if (gerçekleşme <= hedef * 1.2) {
                return hedef.toFixed(2);
            }
            // Eğer gerçekleşme > hedef×1.2: sonraki = gerçekleşme × 0.9
            else {
                return (gerçekleşme * 0.9).toFixed(2);
            }
        }

        function clearPerformanceFields() {
            document.getElementById('perfYear').value = '';
            document.getElementById('perfPPMTarget').value = '';
            document.getElementById('perfPPMActual').value = '';
            document.getElementById('perfPPMNextTarget').value = '';
            document.getElementById('perfDefectTarget').value = '';
            document.getElementById('perfDefectActual').value = '';
            document.getElementById('perfDefectNextTarget').value = '';
        }

        function savePerformanceData() {
            const supplierName = document.getElementById('perfSupplierName').textContent;
            const year = document.getElementById('perfYear').value;
            const ppmTarget = parseFloat(document.getElementById('perfPPMTarget').value) || 0;
            const ppmActual = parseFloat(document.getElementById('perfPPMActual').value) || 0;
            const defectTarget = parseFloat(document.getElementById('perfDefectTarget').value) || 0;
            const defectActual = parseFloat(document.getElementById('perfDefectActual').value) || 0;
            
            if (!year) {
                showAlert('⚠️ Lütfen yıl girin!', 'error');
                return;
            }
            
            if (!ppmTarget || !defectTarget) {
                showAlert('⚠️ Lütfen hedef değerlerini girin!', 'error');
                return;
            }
            
            // Target Agreements'e ekle/güncelle
            if (!targetAgreements[supplierName]) {
                targetAgreements[supplierName] = {};
            }
            
            targetAgreements[supplierName][year] = {
                PPM: {
                    hedef: ppmTarget,
                    gerçekleşme: ppmActual
                },
                HataTekrarı: {
                    hedef: defectTarget,
                    gerçekleşme: defectActual
                }
            };
            
            // localStorage'a kaydet
            saveTargetAgreementsToStorage();
            
            showAlert(`✅ ${supplierName} hedefleri ${year} yılı için kaydedildi!`, 'success');
            closePerformanceDialog();
        }

        // ======== Toplu Performans Raporları ========

        function getSelectedSuppliersForBulkReports() {
            if (selectedRows.size === 0) {
                showAlert('⚠️ Lütfen önce satır seçin!\n\nPerformans raporu için tablodaki checkboxları işaretleyin.', 'warning');
                return [];
            }

            const suppliers = [];
            selectedRows.forEach(rowKey => {
                const supplier = allResults.find(r => (r.mapKey || r.name) === rowKey);
                if (supplier) suppliers.push(supplier);
            });

            return suppliers;
        }

        function getLatestTargetAgreementYear(supplierName) {
            const supplierAgreements = targetAgreements[supplierName] || {};
            const years = Object.keys(supplierAgreements)
                .map(y => parseInt(y, 10))
                .filter(y => Number.isFinite(y));
            if (years.length === 0) return new Date().getFullYear();
            return Math.max(...years);
        }

        function buildPerformanceDataForSupplier(supplier, customYear = null) {
            const supplierName = supplier.name;
            const baseYear = customYear || getLatestTargetAgreementYear(supplierName);
            const agreementsForYear = (targetAgreements[supplierName] || {})[String(baseYear)] || {};
            const ppmAgreement = agreementsForYear.PPM || {};
            const defectAgreement = agreementsForYear.HataTekrarı || {};

            const ppmTarget = Number(ppmAgreement.hedef) || supplier.ppmTarget || 0;
            const ppmActual = Number(ppmAgreement.gerçekleşme) || supplier.ppm || 0;
            const defectTarget = Number(defectAgreement.hedef) || supplier.hataHedefi || 0;
            const defectActual = Number(defectAgreement.gerçekleşme) || supplier.totalHata || 0;

            const ppmNextTarget = Number(calculateNextTarget(ppmTarget, ppmActual)) || 0;
            const defectNextTarget = Number(calculateNextTarget(defectTarget, defectActual)) || 0;

            return {
                supplierName,
                baseYear,
                ppmTarget,
                ppmActual,
                ppmNextTarget,
                defectTarget,
                defectActual,
                defectNextTarget
            };
        }

        function applyPerformanceDataToDialog(data, includeChartData, customReviewDate = null) {
            document.getElementById('perfSupplierName').textContent = data.supplierName;
            document.getElementById('perfYear').value = String(data.baseYear);
            document.getElementById('perfPPMTarget').value = data.ppmTarget;
            document.getElementById('perfPPMActual').value = data.ppmActual;
            document.getElementById('perfPPMNextTarget').value = Math.round(data.ppmNextTarget);
            document.getElementById('perfDefectTarget').value = data.defectTarget;
            document.getElementById('perfDefectActual').value = data.defectActual;
            document.getElementById('perfDefectNextTarget').value = Math.round(data.defectNextTarget);
            
            // Gözden geçirme tarihini ayarla
            if (customReviewDate) {
                const reviewDateInput = document.getElementById('reviewDate');
                if (reviewDateInput) {
                    reviewDateInput.value = customReviewDate;
                }
            }
            
            const chartCheckbox = document.getElementById('includeChartData');
            if (chartCheckbox) chartCheckbox.checked = !!includeChartData;
        }

        function sanitizeFileName(name) {
            return String(name || '')
                .replace(/[\\/:*?"<>|]/g, '_')
                .replace(/\s+/g, ' ')
                .trim();
        }

        async function exportSelectedPerformanceReportsPDF(includeChartData) {
            const suppliers = getSelectedSuppliersForBulkReports();
            if (suppliers.length === 0) return;

            // Kullanıcıdan dönem (yıl) sor
            const currentYear = new Date().getFullYear();
            const yearInput = prompt(`📅 Performans Dönemi (Yıl):`, currentYear);
            if (!yearInput || yearInput.trim() === '') {
                showAlert('❌ Yıl girilmedi. İşlem iptal edildi.', 'warning');
                return;
            }
            
            const baseYear = parseInt(yearInput.trim());
            if (isNaN(baseYear) || baseYear < 2000 || baseYear > 2100) {
                showAlert('❌ Geçersiz yıl. Lütfen 2000-2100 arası bir yıl girin.', 'error');
                return;
            }
            
            // Kullanıcıdan gözden geçirme tarihi sor
            const todayStr = new Date().toLocaleDateString('tr-TR');
            const reviewDateInput = prompt(`📆 Gözden Geçirme Tarihi (GG.AA.YYYY):`, todayStr);
            if (!reviewDateInput || reviewDateInput.trim() === '') {
                showAlert('❌ Tarih girilmedi. İşlem iptal edildi.', 'warning');
                return;
            }
            
            // Tarihi YYYY-MM-DD formatına çevir (reviewDate input alanı için)
            let reviewDateFormatted = '';
            const dateParts = reviewDateInput.trim().split('.');
            if (dateParts.length === 3) {
                const day = dateParts[0].padStart(2, '0');
                const month = dateParts[1].padStart(2, '0');
                const year = dateParts[2];
                reviewDateFormatted = `${year}-${month}-${day}`;
            } else {
                showAlert('❌ Geçersiz tarih formatı. GG.AA.YYYY formatında girin.', 'error');
                return;
            }

            if (!confirm(`📄 ${suppliers.length} tedarikçi için PDF performans raporu indirilsin mi?\n\nDönem: ${baseYear}\nGözden Geçirme: ${reviewDateInput}`)) {
                return;
            }

            if (!window.JSZip) {
                showAlert('⚠️ ZIP kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }

            const zip = new JSZip();
            for (const supplier of suppliers) {
                const data = buildPerformanceDataForSupplier(supplier, baseYear);
                applyPerformanceDataToDialog(data, includeChartData, reviewDateFormatted);
                const safeName = sanitizeFileName(data.supplierName || 'Supplier');
                const fileName = `Target_Agreement_${safeName}_${baseYear}.pdf`;
                const blob = exportTargetAgreementPDF({
                    returnBlob: true,
                    includeChartData: includeChartData,
                    fileNameOverride: fileName,
                    silent: true
                });
                if (blob) {
                    zip.file(fileName, blob);
                }
            }

            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const dateStr = new Date().toISOString().split('T')[0];
            saveAs(zipBlob, `Performans_Raporlari_PDF_${baseYear}_${dateStr}.zip`);
            showAlert(`✅ PDF performans raporları ZIP olarak indirildi! (Dönem: ${baseYear})`, 'success');
        }

        async function exportSelectedPerformanceReportsExcel(includeChartData) {
            const suppliers = getSelectedSuppliersForBulkReports();
            if (suppliers.length === 0) return;

            // Kullanıcıdan dönem (yıl) sor
            const currentYear = new Date().getFullYear();
            const yearInput = prompt(`📅 Performans Dönemi (Yıl):`, currentYear);
            if (!yearInput || yearInput.trim() === '') {
                showAlert('❌ Yıl girilmedi. İşlem iptal edildi.', 'warning');
                return;
            }
            
            const baseYear = parseInt(yearInput.trim());
            if (isNaN(baseYear) || baseYear < 2000 || baseYear > 2100) {
                showAlert('❌ Geçersiz yıl. Lütfen 2000-2100 arası bir yıl girin.', 'error');
                return;
            }
            
            // Kullanıcıdan gözden geçirme tarihi sor
            const todayStr = new Date().toLocaleDateString('tr-TR');
            const reviewDateInput = prompt(`📆 Gözden Geçirme Tarihi (GG.AA.YYYY):`, todayStr);
            if (!reviewDateInput || reviewDateInput.trim() === '') {
                showAlert('❌ Tarih girilmedi. İşlem iptal edildi.', 'warning');
                return;
            }
            
            // Tarihi YYYY-MM-DD formatına çevir (reviewDate input alanı için)
            let reviewDateFormatted = '';
            const dateParts = reviewDateInput.trim().split('.');
            if (dateParts.length === 3) {
                const day = dateParts[0].padStart(2, '0');
                const month = dateParts[1].padStart(2, '0');
                const year = dateParts[2];
                reviewDateFormatted = `${year}-${month}-${day}`;
            } else {
                showAlert('❌ Geçersiz tarih formatı. GG.AA.YYYY formatında girin.', 'error');
                return;
            }

            if (!confirm(`📊 ${suppliers.length} tedarikçi için Excel performans raporu indirilsin mi?\n\nDönem: ${baseYear}\nGözden Geçirme: ${reviewDateInput}`)) {
                return;
            }

            if (!window.JSZip) {
                showAlert('⚠️ ZIP kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                return;
            }

            const zip = new JSZip();
            for (const supplier of suppliers) {
                const data = buildPerformanceDataForSupplier(supplier, baseYear);
                applyPerformanceDataToDialog(data, includeChartData, reviewDateFormatted);
                const safeName = sanitizeFileName(data.supplierName || 'Supplier');
                const fileName = `Target_Agreement_${safeName}_${baseYear}.xlsx`;
                const buffer = await exportTargetAgreementExcel({
                    returnBuffer: true,
                    includeChartData: includeChartData,
                    fileNameOverride: fileName,
                    silent: true
                });
                if (buffer) {
                    zip.file(fileName, buffer);
                }
            }

            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const dateStr = new Date().toISOString().split('T')[0];
            saveAs(zipBlob, `Performans_Raporlari_Excel_${baseYear}_${dateStr}.zip`);
            showAlert(`✅ Excel performans raporları ZIP olarak indirildi! (Dönem: ${baseYear})`, 'success');
        }

        // PDF'e Target Agreement olarak kaydet
        function exportTargetAgreementPDF(options = {}) {
            try {
                // jsPDF kontrolü
                if (!window.jspdf && !window.jsPDF) {
                    showAlert('⚠️ PDF kütüphanesi yüklenemedi. Sayfayı yenileyin.', 'error');
                    return;
                }
                
                const jsPDF = window.jspdf?.jsPDF || window.jsPDF;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const supplierName = document.getElementById('perfSupplierName').textContent || '';
                const yearInput = (document.getElementById('perfYear').value || '').trim();
                let baseYear = new Date().getFullYear();
                
                // Gözden geçirme tarihini al
                const reviewDateInput = document.getElementById('reviewDate')?.value;
                let reviewDateStr = '';
                if (reviewDateInput) {
                    // YYYY-MM-DD formatından DD.MM.YYYY'ye çevir
                    const parts = reviewDateInput.split('-');
                    if (parts.length === 3) {
                        reviewDateStr = `${parts[2]}.${parts[1]}.${parts[0]}`;
                    } else {
                        reviewDateStr = new Date().toLocaleDateString('tr-TR');
                    }
                } else {
                    reviewDateStr = new Date().toLocaleDateString('tr-TR');
                }
                console.log('PDF Gözden Geçirme Tarihi:', reviewDateStr);

                if (/^\d{4}$/.test(yearInput)) {
                    baseYear = parseInt(yearInput);
                } else if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(yearInput)) {
                    const parts = yearInput.split('.');
                    const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                    if (!isNaN(d.getTime())) {
                        baseYear = d.getFullYear();
                        reviewDateStr = d.toLocaleDateString('tr-TR');
                    }
                }
                const nextYear = baseYear + 1;

                const ppmTarget = Number(document.getElementById('perfPPMTarget').value) || 0;
                const ppmActual = Number(document.getElementById('perfPPMActual').value) || 0;
                const ppmNextTarget = Number(document.getElementById('perfPPMNextTarget').value) || 0;
                const defectTarget = Number(document.getElementById('perfDefectTarget').value) || 0;
                const defectActual = Number(document.getElementById('perfDefectActual').value) || 0;
                const defectNextTarget = Number(document.getElementById('perfDefectNextTarget').value) || 0;

                // Türkçe karakter düzeltme
                const normalizeTurkish = (str) => {
                    if (!str) return '';
                    return String(str)
                        .replace(/İ/g, 'I').replace(/ı/g, 'i')
                        .replace(/Ş/g, 'S').replace(/ş/g, 's')
                        .replace(/Ğ/g, 'G').replace(/ğ/g, 'g')
                        .replace(/Ü/g, 'U').replace(/ü/g, 'u')
                        .replace(/Ö/g, 'O').replace(/ö/g, 'o')
                        .replace(/Ç/g, 'C').replace(/ç/g, 'c');
                };

                doc.setFont('helvetica');
                
                const margin = 10;
                const pageWidth = doc.internal.pageSize.width;
                const usableWidth = pageWidth - (2 * margin);
                
                // En üst başlık: Kalite Yönetim Sistemi Dokümantasyonu
                doc.setFillColor(173, 216, 230);
                doc.rect(margin, 8, usableWidth, 6, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Kalite Yonetim Sistemi Dokumantasyonu', pageWidth/2, 12, { align: 'center' });
                
                // Ana Antet - 3 bölümlü (SANIFOAM | BAŞLIK | DOK BİLGİLERİ)
                const headerY = 16;
                const logoWidth = 55;
                const titleWidth = usableWidth - logoWidth - 55;
                const docInfoWidth = 55;
                
                // Sol: SANIFOAM
                doc.setFillColor(173, 216, 230);
                doc.rect(margin, headerY, logoWidth, 30, 'FD');
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(31, 73, 125);
                doc.text('SANIFOAM', margin + logoWidth/2, headerY + 18, { align: 'center' });
                
                // Orta: Başlık
                const titleX = margin + logoWidth;
                doc.setFillColor(173, 216, 230);
                doc.rect(titleX, headerY, titleWidth, 30, 'FD');
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(31, 73, 125);
                doc.text('TEDARIKCI PERFORMANS ANLASMASI', titleX + titleWidth/2, headerY + 13, { align: 'center' });
                doc.setFontSize(10);
                doc.text('TARGET AGREEMENT', titleX + titleWidth/2, headerY + 20, { align: 'center' });
                
                // Sağ: Doküman Bilgileri
                const docInfoX = titleX + titleWidth;
                doc.setFillColor(255, 243, 205);
                doc.rect(docInfoX, headerY, docInfoWidth, 7.5, 'FD');
                doc.rect(docInfoX, headerY + 7.5, docInfoWidth, 7.5, 'FD');
                doc.rect(docInfoX, headerY + 15, docInfoWidth, 7.5, 'FD');
                doc.rect(docInfoX, headerY + 22.5, docInfoWidth, 7.5, 'FD');
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('DOK.NO: FR160', docInfoX + docInfoWidth/2, headerY + 5, { align: 'center' });
                doc.text('Y.TRH: 13.02.2013', docInfoX + docInfoWidth/2, headerY + 12.5, { align: 'center' });
                doc.text('REV.NO/TARIH: 03/29.08.2025', docInfoX + docInfoWidth/2, headerY + 19.5, { align: 'center' });
                doc.text('SAYFA: 1/1', docInfoX + docInfoWidth/2, headerY + 27, { align: 'center' });
                
                // Tedarikçi Adı Satırı
                const supplierY = headerY + 32;
                doc.setFillColor(173, 216, 230);
                doc.rect(margin, supplierY, 50, 10, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Tedarikci Adi', margin + 25, supplierY + 4, { align: 'center' });
                doc.text('Supplier Name', margin + 25, supplierY + 7.5, { align: 'center' });
                
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + 50, supplierY, usableWidth - 50, 10, 'FD');
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(normalizeTurkish(supplierName), margin + 52, supplierY + 7);
                
                // Ana Tablo
                const tableY = supplierY + 12;
                const col1W = 50;  // Label column
                const colDataW = (usableWidth - col1W) / 3;
                
                // Tablo başlıkları (renkli)
                doc.setFillColor(67, 160, 71);  // Yeşil
                doc.rect(margin + col1W, tableY, colDataW, 14, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(`Hedef ${baseYear}`, margin + col1W + colDataW/2, tableY + 6, { align: 'center' });
                doc.text(`Target ${baseYear}`, margin + col1W + colDataW/2, tableY + 10, { align: 'center' });
                
                doc.setFillColor(251, 140, 0);  // Turuncu
                doc.rect(margin + col1W + colDataW, tableY, colDataW, 14, 'FD');
                doc.text(`${baseYear} Gerceklesen`, margin + col1W + colDataW + colDataW/2, tableY + 6, { align: 'center' });
                doc.text(`Realized ${baseYear}`, margin + col1W + colDataW + colDataW/2, tableY + 10, { align: 'center' });
                
                doc.setFillColor(30, 136, 229);  // Mavi
                doc.rect(margin + col1W + 2*colDataW, tableY, colDataW, 14, 'FD');
                doc.text(`${nextYear} Hedef`, margin + col1W + 2*colDataW + colDataW/2, tableY + 6, { align: 'center' });
                doc.text(`Target ${nextYear}`, margin + col1W + 2*colDataW + colDataW/2, tableY + 10, { align: 'center' });
                
                // PPM satırı
                let rowY = tableY + 14;
                doc.setFillColor(255, 224, 178);
                doc.rect(margin, rowY, col1W, 12, 'FD');
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text('PPM', margin + col1W/2, rowY + 7, { align: 'center' });
                
                // Hedef 2026 kolonu (yeşil arka plan)
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + col1W, rowY, colDataW, 12, 'FD');
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(ppmTarget.toString(), margin + col1W + colDataW/2, rowY + 7, { align: 'center' });
                
                // 2026 Gerçekleşen kolonu (turuncu arka plan)
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + col1W + colDataW, rowY, colDataW, 12, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.text(Math.round(ppmActual).toString(), margin + col1W + colDataW + colDataW/2, rowY + 7, { align: 'center' });
                
                // 2027 Hedef kolonu (mavi arka plan)
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + col1W + 2*colDataW, rowY, colDataW, 12, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.text(Math.round(ppmNextTarget).toString(), margin + col1W + 2*colDataW + colDataW/2, rowY + 7, { align: 'center' });
                
                // Hata Tekrarı satırı
                rowY += 12;
                doc.setFillColor(255, 205, 210);
                doc.rect(margin, rowY, col1W, 14, 'FD');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.text('Hata Tekrari', margin + col1W/2, rowY + 6, { align: 'center' });
                doc.setFontSize(7);
                doc.text('Number of Quality Incidents', margin + col1W/2, rowY + 10, { align: 'center' });
                
                // Hedef 2026 kolonu
                doc.setFontSize(10);
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + col1W, rowY, colDataW, 14, 'FD');
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(defectTarget.toString(), margin + col1W + colDataW/2, rowY + 8, { align: 'center' });
                
                // 2026 Gerçekleşen kolonu
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + col1W + colDataW, rowY, colDataW, 14, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.text(Math.round(defectActual).toString(), margin + col1W + colDataW + colDataW/2, rowY + 8, { align: 'center' });
                
                // 2027 Hedef kolonu
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + col1W + 2*colDataW, rowY, colDataW, 14, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.text(Math.round(defectNextTarget).toString(), margin + col1W + 2*colDataW + colDataW/2, rowY + 8, { align: 'center' });
                
                // Gözden Geçirme Tarihi
                rowY += 18;
                doc.setFillColor(232, 245, 233);
                doc.rect(margin, rowY, usableWidth/2 - 1, 10, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('Gozden Gecirme Tarihi:', margin + usableWidth/4, rowY + 6.5, { align: 'center' });
                
                doc.setFillColor(255, 255, 255);
                doc.rect(margin + usableWidth/2 + 1, rowY, usableWidth/2 - 1, 10, 'FD');
                doc.setFont('helvetica', 'normal');
                doc.text(reviewDateStr, margin + 3*usableWidth/4, rowY + 6.5, { align: 'center' });
                
                // İmza Alanları
                rowY += 15;
                const sigWidth = usableWidth / 2 - 1;
                const sigHeight = 35;
                
                // Sol İmza Alanı (Tedarikçi)
                doc.setFillColor(255, 250, 205);
                doc.rect(margin, rowY, sigWidth, sigHeight, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(100, 100, 100);
                doc.text('Imza / Kase', margin + sigWidth/2, rowY + sigHeight - 8, { align: 'center' });
                doc.text('Signature / Stamp', margin + sigWidth/2, rowY + sigHeight - 3, { align: 'center' });
                
                // Sağ İmza Alanı (Sanifoam)
                doc.setFillColor(255, 250, 205);
                doc.rect(margin + sigWidth + 2, rowY, sigWidth, sigHeight, 'FD');
                doc.text('Imza / Kase', margin + sigWidth + 2 + sigWidth/2, rowY + sigHeight - 8, { align: 'center' });
                doc.text('Signature / Stamp', margin + sigWidth + 2 + sigWidth/2, rowY + sigHeight - 3, { align: 'center' });
                
                // Alt açıklamalar
                rowY += sigHeight + 2;
                doc.setFillColor(211, 211, 211);
                doc.rect(margin, rowY, sigWidth, 10, 'FD');
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Tedarikci Kalite Guvence Yoneticisi', margin + sigWidth/2, rowY + 4, { align: 'center' });
                doc.text('Head Of Quality (Supplier)', margin + sigWidth/2, rowY + 7.5, { align: 'center' });
                
                doc.setFillColor(211, 211, 211);
                doc.rect(margin + sigWidth + 2, rowY, sigWidth, 10, 'FD');
                doc.setTextColor(0, 0, 0);
                doc.text('Sanifoam Kalite Guvence Yoneticisi', margin + sigWidth + 2 + sigWidth/2, rowY + 4, { align: 'center' });
                doc.text('Head Of Quality (Sanifoam)', margin + sigWidth + 2 + sigWidth/2, rowY + 7.5, { align: 'center' });
                
                // yPos değişkenini tanımla (grafik verileri ve diğer bölümler için kullanılacak)
                let yPos = rowY + 15;
                const pageHeight = doc.internal.pageSize.height;
                
                // Grafik verilerini ekle (eğer seçilmişse)
                const includeChartData = (options.includeChartData !== undefined)
                    ? options.includeChartData
                    : document.getElementById('includeChartData')?.checked;
                if (includeChartData) {
                    const supplier = allResults.find(r => r.name === supplierName);
                    if (supplier) {
                        const months = Array.from(selectedMonths).sort((a,b)=>a-b);
                        const monthLabels = months.map(m => `${m}`);
                        
                        // Başlık bilgileri
                        const supplierClass = supplier.tedarikcisınıfı || '-';
                        const supplierScore = ((supplier.tedarikcipuani || 0) * 100).toFixed(0);
                        const avgPPM = months.length > 0 ? 
                            months.reduce((sum, m) => sum + (supplier.monthlyPPM?.[m-1] || 0), 0) / months.length : 0;
                        
                        // Üst bilgi başlığı - TR + EN
                        doc.setFillColor(30, 60, 114);
                        doc.rect(margin, yPos, usableWidth, 10, 'FD');
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(255, 255, 255);
                        const headerTextTr = `PERFORMANS GRAFIKLERI | Sinif: ${supplierClass} | Puan: ${supplierScore}% | Ort.PPM: ${Math.round(avgPPM)} | Aylar: ${monthLabels.join(',')}`;
                        const headerTextEn = `PERFORMANCE CHARTS | Class: ${supplierClass} | Score: ${supplierScore}% | Avg.PPM: ${Math.round(avgPPM)} | Months: ${monthLabels.join(',')}`;
                        doc.setFontSize(7.5);
                        doc.text(headerTextTr, pageWidth/2, yPos + 4.2, { align: 'center' });
                        doc.setFontSize(7);
                        doc.text(headerTextEn, pageWidth/2, yPos + 8.2, { align: 'center' });
                        yPos += 12;
                        
                        // Grafik verilerini ekle
                        const chartDataSets = [
                            { title: { tr: 'AYLIK HATA', en: 'MONTHLY DEFECTS' }, data: months.map(m => supplier.monthlyHata?.[m-1] || 0), color: [229, 57, 53] },
                            { title: { tr: 'AYLIK PPM', en: 'MONTHLY PPM' }, data: months.map(m => supplier.monthlyPPM?.[m-1] || 0), color: [251, 140, 0] },
                            { title: { tr: 'PPM PUAN', en: 'PPM SCORE' }, data: months.map(m => {
                                const ppm = supplier.monthlyPPM?.[m-1] || 0;
                                const target = supplier.ppmTarget || 1000;
                                if (ppm === 0) return 100;
                                if (ppm <= target / 4) return 100;
                                if (ppm <= target / 2) return 90;
                                if (ppm <= target) return 70;
                                if (ppm <= target * 1.5) return 50;
                                if (ppm <= target * 2) return 30;
                                return 0;
                            }), color: [33, 150, 243] },
                            { title: { tr: 'HATA PUAN', en: 'DEFECT SCORE' }, data: months.map(m => {
                                const hata = supplier.monthlyHata?.[m-1] || 0;
                                const target = supplier.hataHedefi || 2;
                                if (hata === 0) return 100;
                                if (target / hata > 1) return 100;
                                return Math.max(0, Math.min(100, (target / hata) * 100));
                            }), color: [244, 81, 30] },
                            { title: { tr: 'TERMİN', en: 'DELIVERY' }, data: months.map(m => supplier.monthlyTerminPuan?.[m-1] || 100), color: [57, 73, 171] },
                            { title: { tr: 'TAMAMLANMA', en: 'COMPLETION' }, data: months.map(m => supplier.monthlyTamamlanmaPuan?.[m-1] || 100), color: [0, 121, 107] }
                        ];
                        
                        // İki kolona böl - kompakt düzen
                        const columnWidth = usableWidth / 2 - 2;
                        const startY = yPos;
                        
                        chartDataSets.forEach((dataset, index) => {
                            const col = index % 2; // 0: sol, 1: sağ
                            const xPos = margin + (col * (columnWidth + 4));
                            
                            if (index % 2 === 0 && index > 0) {
                                yPos += 18; // Yeni satıra geç
                            }
                            if (index === 0) yPos = startY;
                            if (col === 0) yPos = startY + Math.floor(index / 2) * 18;
                            
                            // Başlık - TR + EN (iki satır)
                            doc.setFillColor(...dataset.color);
                            doc.rect(xPos, yPos, columnWidth, 7, 'FD');
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(6.5);
                            doc.text(normalizeTurkish(dataset.title.tr), xPos + columnWidth/2, yPos + 3.0, { align: 'center' });
                            doc.setFontSize(6);
                            doc.text(dataset.title.en, xPos + columnWidth/2, yPos + 5.8, { align: 'center' });
                            
                            // Ay başlıkları ve değerler
                            const colWidth = columnWidth / months.length;
                            
                            // Ay etiketleri
                            doc.setFillColor(240, 240, 240);
                            doc.rect(xPos, yPos + 7, columnWidth, 4, 'FD');
                            doc.setFontSize(6);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(0, 0, 0);
                            monthLabels.forEach((label, idx) => {
                                doc.text(label.replace('.Ay', ''), xPos + (idx * colWidth) + colWidth/2, yPos + 9.5, { align: 'center' });
                            });
                            
                            // Değerler
                            doc.setFillColor(255, 255, 255);
                            doc.rect(xPos, yPos + 11, columnWidth, 4, 'FD');
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(6);
                            dataset.data.forEach((value, idx) => {
                                const displayValue = typeof value === 'number' ? 
                                    (value % 1 === 0 ? value.toString() : value.toFixed(1)) : value;
                                doc.text(displayValue, xPos + (idx * colWidth) + colWidth/2, yPos + 13.5, { align: 'center' });
                            });
                            
                            // Tablo çerçeveleri
                            doc.setDrawColor(0, 0, 0);
                            doc.setLineWidth(0.2);
                            for (let i = 0; i <= months.length; i++) {
                                doc.line(xPos + (i * colWidth), yPos + 7, xPos + (i * colWidth), yPos + 15);
                            }
                            doc.rect(xPos, yPos, columnWidth, 15, 'S');
                        });
                        
                        // Sabit değerler (VDA, Kalite, 8D) - altta tek satırda
                        yPos = startY + Math.ceil(chartDataSets.length / 2) * 18 + 2;
                        
                        const staticData = [
                            { title: { tr: 'VDA PUANI', en: 'VDA SCORE' }, value: supplier.vdaPuan || 0, color: [142, 36, 170] },
                            { title: { tr: 'KALİTE BELGE', en: 'QUALITY CERT' }, value: supplier.kalitePuan || 0, color: [67, 160, 71] },
                            { title: { tr: '8D DÖNÜŞ', en: '8D RETURN' }, value: supplier.donusOrani8D || 100, color: [2, 136, 209] }
                        ];
                        
                        const staticColWidth = usableWidth / staticData.length;
                        
                        staticData.forEach((item, idx) => {
                            const xPos = margin + (idx * staticColWidth);
                            
                            // Başlık (TR + EN)
                            doc.setFillColor(...item.color);
                            doc.rect(xPos, yPos, staticColWidth - 1, 6, 'FD');
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(6);
                            doc.text(normalizeTurkish(item.title.tr), xPos + (staticColWidth - 1)/2, yPos + 2.6, { align: 'center' });
                            doc.setFontSize(5.5);
                            doc.text(item.title.en, xPos + (staticColWidth - 1)/2, yPos + 5.2, { align: 'center' });
                            
                            // Değer
                            doc.setFillColor(255, 255, 255);
                            doc.rect(xPos, yPos + 6, staticColWidth - 1, 4, 'FD');
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(7);
                            const displayValue = typeof item.value === 'number' ? 
                                (item.value % 1 === 0 ? item.value.toString() : item.value.toFixed(1)) : item.value;
                            doc.text(displayValue, xPos + (staticColWidth - 1)/2, yPos + 8.8, { align: 'center' });
                        });
                        
                        yPos += 12;
                    }
                }
                
                // Kaydet
                const defaultFileName = `Target_Agreement_${normalizeTurkish(supplierName)}_${baseYear}.pdf`;
                const fileName = options.fileNameOverride || defaultFileName;
                if (options.returnBlob) {
                    return doc.output('blob');
                }
                doc.save(fileName);
                if (!options.silent) {
                    showAlert('✅ PDF basariyla indirildi!', 'success');
                }
                
            } catch (err) {
                console.error('PDF export error:', err);
                if (!options.silent) {
                    showAlert('❌ PDF olusturulurken hata olustu: ' + err.message, 'error');
                }
                return null;
            }
        }

        // Excel'e Target Agreement (tam antet ve biçim) olarak kaydet
        async function exportTargetAgreementExcel(options = {}) {
            try {
                const supplierName = document.getElementById('perfSupplierName').textContent || '';
                const yearInput = (document.getElementById('perfYear').value || '').trim();
                let baseYear = new Date().getFullYear();
                
                // Gözden geçirme tarihini al
                const reviewDateInput = document.getElementById('reviewDate')?.value;
                let reviewDateStr = '';
                if (reviewDateInput) {
                    // YYYY-MM-DD formatından DD.MM.YYYY'ye çevir
                    const parts = reviewDateInput.split('-');
                    if (parts.length === 3) {
                        reviewDateStr = `${parts[2]}.${parts[1]}.${parts[0]}`;
                    } else {
                        reviewDateStr = new Date().toLocaleDateString('tr-TR');
                    }
                } else {
                    reviewDateStr = new Date().toLocaleDateString('tr-TR');
                }
                console.log('Excel Gözden Geçirme Tarihi:', reviewDateStr);

                // Yıl/Tarih girdisini işle: 'YYYY' veya 'DD.MM.YYYY'
                if (/^\d{4}$/.test(yearInput)) {
                    baseYear = parseInt(yearInput);
                } else if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(yearInput)) {
                    const parts = yearInput.split('.');
                    const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                    if (!isNaN(d.getTime())) {
                        baseYear = d.getFullYear();
                    }
                }
                const nextYear = baseYear + 1;

                // Modal değerleri
                const ppmTarget = Number(document.getElementById('perfPPMTarget').value) || 0;
                const ppmActual = Number(document.getElementById('perfPPMActual').value) || 0;
                const ppmNextTarget = Number(document.getElementById('perfPPMNextTarget').value) || 0;
                const defectTarget = Number(document.getElementById('perfDefectTarget').value) || 0;
                const defectActual = Number(document.getElementById('perfDefectActual').value) || 0;
                const defectNextTarget = Number(document.getElementById('perfDefectNextTarget').value) || 0;

                const wb = new ExcelJS.Workbook();
                const ws = wb.addWorksheet('Target Agreement');

                // Sayfa / yazdırma düzeni
                ws.pageSetup = {
                    orientation: 'portrait',
                    fitToPage: true,
                    fitToWidth: 1,
                    fitToHeight: 1,
                    margins: { left: 0.5, right: 0.5, top: 0.5, bottom: 0.5, header: 0.3, footer: 0.3 }
                };

                // Çalışma alanı sütunları (A-L) - 12 ay için
                ws.columns = [
                    { width: 12 }, // A
                    { width: 12 }, // B
                    { width: 12 }, // C
                    { width: 12 }, // D
                    { width: 12 }, // E
                    { width: 12 }, // F
                    { width: 12 }, // G
                    { width: 12 }, // H
                    { width: 12 }, // I
                    { width: 12 }, // J
                    { width: 12 }, // K
                    { width: 12 }, // L
                ];

                const borderThin = { top: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' }, bottom: { style: 'thin' } };
                const centerWrap = { horizontal: 'center', vertical: 'middle', wrapText: true };

                // Üst antet
                // Logo alanı (A1:B4)
                ws.mergeCells('A1:B4');
                const logoCell = ws.getCell('A1');
                logoCell.value = 'SANIFOAM';
                logoCell.alignment = centerWrap;
                logoCell.font = { bold: true, size: 18, color: { argb: 'FF1F497D' } };
                logoCell.border = borderThin;

                // Orta üst bilgi (C1:H1) - Kalite Yönetim Sistemi Dokümantasyonu
                ws.mergeCells('C1:H1');
                const kysdCell = ws.getCell('C1');
                kysdCell.value = 'Kalite Yönetim Sistemi Dokümantasyonu';
                kysdCell.alignment = centerWrap;
                kysdCell.font = { size: 11, bold: true };
                kysdCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe3f2fd' } };
                kysdCell.border = borderThin;

                // Başlık (C2:H4) - boşluk kalmaması için 4. satıra kadar genişletildi
                ws.mergeCells('C2:H4');
                const titleCell = ws.getCell('C2');
                titleCell.value = 'TEDARİKÇİ PERFORMANS ANLAŞMASI\nTARGET AGREEMENT';
                titleCell.alignment = centerWrap;
                titleCell.font = { bold: true, size: 16, color: { argb: 'FF1e3c72' } };
                titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFcfe2f3' } };
                titleCell.border = borderThin;

                // Sağ üst kutular (I1:L4)
                ws.mergeCells('I1:L1'); 
                const dokCell = ws.getCell('I1');
                dokCell.value = 'DOK.NO: FR160'; 
                dokCell.alignment = centerWrap; 
                dokCell.font = { bold: true, size: 10 };
                dokCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfff3cd' } };
                dokCell.border = borderThin;
                
                ws.mergeCells('I2:L2'); 
                const ytrhCell = ws.getCell('I2');
                ytrhCell.value = 'Y.TRH: 13.02.2013'; 
                ytrhCell.alignment = centerWrap; 
                ytrhCell.font = { bold: true, size: 10 };
                ytrhCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfff3cd' } };
                ytrhCell.border = borderThin;
                
                ws.mergeCells('I3:L3'); 
                const revCell = ws.getCell('I3');
                revCell.value = 'REV.NO/TARİH: 03/29.08.2025'; 
                revCell.alignment = centerWrap; 
                revCell.font = { bold: true, size: 10 };
                revCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfff3cd' } };
                revCell.border = borderThin;
                
                ws.mergeCells('I4:L4'); 
                const sayfaCell = ws.getCell('I4');
                sayfaCell.value = 'SAYFA: 1/1'; 
                sayfaCell.alignment = centerWrap; 
                sayfaCell.font = { bold: true, size: 10 };
                sayfaCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfff3cd' } };
                sayfaCell.border = borderThin;

                // Üst antet satır yükseklikleri (okunabilirlik için daha da artırıldı)
                ws.getRow(1).height = 30; 
                ws.getRow(2).height = 42; 
                ws.getRow(3).height = 42; 
                ws.getRow(4).height = 30;
                ws.getRow(5).height = 36;

                // Tedarikçi adı (C5:L5), etiket (A5:B5)
                ws.mergeCells('A5:B5'); 
                const labelName = ws.getCell('A5'); 
                labelName.value = 'Tedarikçi Adı\nSupplier Name'; 
                labelName.alignment = centerWrap; 
                labelName.font = { bold: true, size: 11 };
                labelName.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe8eaf6' } };
                labelName.border = borderThin;
                
                ws.mergeCells('C5:L5'); 
                const supplierCell = ws.getCell('C5'); 
                supplierCell.value = supplierName; 
                supplierCell.alignment = { horizontal: 'center', vertical: 'middle' }; 
                supplierCell.font = { bold: true, size: 12, color: { argb: 'FF1e3c72' } }; 
                supplierCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe3f2fd' } };
                supplierCell.border = borderThin;

                // Ana tablo başlıkları (A7:L7)
                ws.mergeCells('A7:C7'); 
                ws.getCell('A7').value = ''; 
                ws.getCell('A7').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf5f5f5' } };
                ws.getCell('A7').border = borderThin;
                
                ws.mergeCells('D7:F7'); 
                const hedefCell = ws.getCell('D7');
                hedefCell.value = `Hedef ${baseYear}\nTarget ${baseYear}`; 
                hedefCell.alignment = centerWrap; 
                hedefCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } }; 
                hedefCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF43a047' } };
                hedefCell.border = borderThin;
                
                ws.mergeCells('G7:I7'); 
                const gercekCell = ws.getCell('G7');
                gercekCell.value = `${baseYear} Gerçekleşen\nRealized ${baseYear}`; 
                gercekCell.alignment = centerWrap; 
                gercekCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } }; 
                gercekCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfb8c00' } };
                gercekCell.border = borderThin;
                
                ws.mergeCells('J7:L7'); 
                const nextHedefCell = ws.getCell('J7');
                nextHedefCell.value = `${nextYear} Hedef\nTarget ${nextYear}`; 
                nextHedefCell.alignment = centerWrap; 
                nextHedefCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } }; 
                nextHedefCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1e88e5' } };
                nextHedefCell.border = borderThin;
                ws.getRow(7).height = 48;

                // PPM satırı (A8:L8)
                ws.mergeCells('A8:C8'); 
                const ppmLabelCell = ws.getCell('A8');
                ppmLabelCell.value = 'PPM'; 
                ppmLabelCell.alignment = centerWrap; 
                ppmLabelCell.font = { bold: true, size: 11 };
                ppmLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFffe0b2' } };
                ppmLabelCell.border = borderThin;
                
                ws.mergeCells('D8:F8'); 
                const ppmTargetCell = ws.getCell('D8');
                ppmTargetCell.value = ppmTarget; 
                ppmTargetCell.alignment = centerWrap; 
                ppmTargetCell.font = { size: 11, bold: true };
                ppmTargetCell.border = borderThin;
                
                ws.mergeCells('G8:I8'); 
                const ppmActualCell = ws.getCell('G8');
                ppmActualCell.value = Math.round(ppmActual); 
                ppmActualCell.alignment = centerWrap; 
                ppmActualCell.font = { size: 11, bold: true };
                ppmActualCell.border = borderThin;
                
                ws.mergeCells('J8:L8'); 
                const ppmNextCell = ws.getCell('J8');
                ppmNextCell.value = Math.round(ppmNextTarget); 
                ppmNextCell.alignment = centerWrap; 
                ppmNextCell.font = { size: 11, bold: true };
                ppmNextCell.border = borderThin;
                ws.getRow(8).height = 32;

                // Hata Tekrarı satırı (A9:L9)
                ws.mergeCells('A9:C9'); 
                const hataLabelCell = ws.getCell('A9');
                hataLabelCell.value = 'Hata Tekrarı\nNumber of Quality Incidents'; 
                hataLabelCell.alignment = centerWrap; 
                hataLabelCell.font = { bold: true, size: 11 };
                hataLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFffcdd2' } };
                hataLabelCell.border = borderThin;
                
                ws.mergeCells('D9:F9'); 
                const hataTargetCell = ws.getCell('D9');
                hataTargetCell.value = defectTarget; 
                hataTargetCell.alignment = centerWrap; 
                hataTargetCell.font = { size: 11, bold: true };
                hataTargetCell.border = borderThin;
                
                ws.mergeCells('G9:I9'); 
                const hataActualCell = ws.getCell('G9');
                hataActualCell.value = Math.round(defectActual); 
                hataActualCell.alignment = centerWrap; 
                hataActualCell.font = { size: 11, bold: true };
                hataActualCell.border = borderThin;
                
                ws.mergeCells('J9:L9'); 
                const hataNextCell = ws.getCell('J9');
                hataNextCell.value = Math.round(defectNextTarget); 
                hataNextCell.alignment = centerWrap; 
                hataNextCell.font = { size: 11, bold: true };
                hataNextCell.border = borderThin;
                ws.getRow(9).height = 42;

                // Gözden geçirme tarihi (A11:F11 label, G11:L11 value)
                ws.mergeCells('A11:F11'); 
                const reviewLabelCell = ws.getCell('A11');
                reviewLabelCell.value = 'Gözden Geçirme Tarihi:'; 
                reviewLabelCell.alignment = { horizontal: 'right', vertical: 'middle' }; 
                reviewLabelCell.font = { bold: true, size: 11 };
                reviewLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe8f5e9' } };
                reviewLabelCell.border = borderThin;
                
                ws.mergeCells('G11:L11'); 
                const reviewValueCell = ws.getCell('G11');
                reviewValueCell.value = reviewDateStr; 
                reviewValueCell.alignment = { horizontal: 'center', vertical: 'middle' }; 
                reviewValueCell.font = { bold: true, size: 11 };
                reviewValueCell.border = borderThin;
                ws.getRow(11).height = 30;

                // Alt imza/kaşe alanları ve unvanlar (görsel eşleştirme ve okuyabilirlik)
                // İmza/Kaşe kutuları
                ws.mergeCells('A13:F15');
                const imza1Cell = ws.getCell('A13');
                imza1Cell.value = 'İmza / Kaşe\nSignature / Stamp';
                imza1Cell.alignment = { horizontal: 'center', vertical: 'bottom', wrapText: true };
                imza1Cell.font = { bold: true, size: 11, color: { argb: 'FF808080' } };
                imza1Cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfff9c4' } };
                imza1Cell.border = borderThin;

                ws.mergeCells('G13:L15');
                const imza2Cell = ws.getCell('G13');
                imza2Cell.value = 'İmza / Kaşe\nSignature / Stamp';
                imza2Cell.alignment = { horizontal: 'center', vertical: 'bottom', wrapText: true };
                imza2Cell.font = { bold: true, size: 11, color: { argb: 'FF808080' } };
                imza2Cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFfff9c4' } };
                imza2Cell.border = borderThin;

                ws.getRow(13).height = 32; 
                ws.getRow(14).height = 32; 
                ws.getRow(15).height = 32;

                // Unvanları aynı hücre içinde iki satır olarak yaz
                ws.mergeCells('A16:F16');
                const unvan1Cell = ws.getCell('A16');
                unvan1Cell.value = 'Tedarikçi Kalite Güvence Yöneticisi\nHead Of Quality (Supplier)';
                unvan1Cell.alignment = centerWrap;
                unvan1Cell.font = { bold: true, size: 10 };
                unvan1Cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe0e0e0' } };
                unvan1Cell.border = borderThin;

                ws.mergeCells('G16:L16');
                const unvan2Cell = ws.getCell('G16');
                unvan2Cell.value = 'Sanifoam Kalite Güvence Yöneticisi\nHead Of Quality (Sanifoam)';
                unvan2Cell.alignment = centerWrap;
                unvan2Cell.font = { bold: true, size: 10 };
                unvan2Cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe0e0e0' } };
                unvan2Cell.border = borderThin;

                ws.getRow(16).height = 36;

                // Form alanına dış kenarlık ekle (A7:H12 ve A13:H15 bloklarının çevresi)
                const borderMedium = { top: { style: 'medium' }, left: { style: 'medium' }, right: { style: 'medium' }, bottom: { style: 'medium' } };
                // Üst tablo çerçevesi
                ['A7','C7','E7','G7','A8','C8','E8','G8','A9','C9','E9','G9','A11','E11'].forEach(addr => {
                    ws.getCell(addr).border = borderMedium;
                });
                // İmza kutuları çerçevesi
                ['A13','E13'].forEach(addr => { ws.getCell(addr).border = borderMedium; });

                // Grafik verilerini ekle (eğer seçilmişse)
                const includeChartData = (options.includeChartData !== undefined)
                    ? options.includeChartData
                    : document.getElementById('includeChartData')?.checked;
                if (includeChartData) {
                    // Tedarikçi bilgilerini al
                    const supplier = allResults.find(r => r.name === supplierName);
                    if (supplier) {
                        const months = Array.from(selectedMonths).sort((a,b)=>a-b);
                        const monthLabels = months.map(m => `${m}`);
                        
                        // Başlık bilgileri
                        const supplierClass = supplier.tedarikcisınıfı || '-';
                        const supplierScore = ((supplier.tedarikcipuani || 0) * 100).toFixed(0);
                        const avgPPM = months.length > 0 ? 
                            months.reduce((sum, m) => sum + (supplier.monthlyPPM?.[m-1] || 0), 0) / months.length : 0;
                        
                        let startRow = 19; // Form'dan sonra başla
                        
                        // Üst bilgi satırı
                        ws.mergeCells(`A${startRow}:L${startRow}`);
                        const infoCell = ws.getCell(`A${startRow}`);
                        infoCell.value = `📊 PERFORMANS GRAFİKLERİ | Sınıf: ${supplierClass} | Tedarikçi Puanı: ${supplierScore}% | Ortalama PPM: ${avgPPM.toFixed(0)} | Seçili Aylar: ${monthLabels.join(', ')}\nPERFORMANCE CHARTS | Class: ${supplierClass} | Supplier Score: ${supplierScore}% | Avg. PPM: ${avgPPM.toFixed(0)} | Months: ${monthLabels.join(', ')}`;
                        infoCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                        infoCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
                        infoCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1e3c72' } };
                        ws.getRow(startRow).height = 56;
                        startRow++;
                        
                        // Boş satır
                        startRow++;
                        
                        // Grafik verilerini ekle
                        const chartDataSets = [
                            { title: { tr: 'AYLIK HATA SAYISI', en: 'MONTHLY DEFECTS' }, data: months.map(m => supplier.monthlyHata?.[m-1] || 0), color: 'FFe53935' },
                            { title: { tr: 'AYLIK İADE PPM', en: 'MONTHLY RETURN PPM' }, data: months.map(m => supplier.monthlyPPM?.[m-1] || 0), color: 'FFfb8c00' },
                            { title: { tr: 'AYLIK PPM PUANI', en: 'MONTHLY PPM SCORE' }, data: months.map(m => {
                                const ppm = supplier.monthlyPPM?.[m-1] || 0;
                                const target = supplier.ppmTarget || 1000;
                                if (ppm === 0) return 100;
                                if (ppm <= target / 4) return 100;
                                if (ppm <= target / 2) return 90;
                                if (ppm <= target) return 70;
                                if (ppm <= target * 1.5) return 50;
                                if (ppm <= target * 2) return 30;
                                return 0;
                            }), color: 'FF2196f3' },
                            { title: { tr: 'AYLIK HATA PUANI', en: 'MONTHLY DEFECT SCORE' }, data: months.map(m => {
                                const hata = supplier.monthlyHata?.[m-1] || 0;
                                const target = supplier.hataHedefi || 2;
                                if (hata === 0) return 100;
                                if (target / hata > 1) return 100;
                                return Math.max(0, Math.min(100, (target / hata) * 100));
                            }), color: 'FFf4511e' },
                            { title: { tr: 'TERMİN PUANI', en: 'DELIVERY SCORE' }, data: months.map(m => supplier.monthlyTerminPuan?.[m-1] || 100), color: 'FF3949ab' },
                            { title: { tr: 'TAMAMLANMA PUANI', en: 'COMPLETION SCORE' }, data: months.map(m => supplier.monthlyTamamlanmaPuan?.[m-1] || 100), color: 'FF00796b' }
                        ];
                        
                        // Sabit değerler (VDA, Kalite, 8D)
                        const staticData = [
                            { title: { tr: 'VDA PUANI', en: 'VDA SCORE' }, value: supplier.vdaPuan || 0, color: 'FF8e24aa' },
                            { title: { tr: 'KALİTE BELGE PUANI', en: 'QUALITY CERT SCORE' }, value: supplier.kalitePuan || 0, color: 'FF43a047' },
                            { title: { tr: '8D DÖNÜŞ ORANI', en: '8D RETURN RATE' }, value: supplier.donusOrani8D || 100, color: 'FF0288d1' }
                        ];
                        
                        // Aylık grafik verilerini ekle
                        chartDataSets.forEach(dataset => {
                            // Başlık
                            ws.mergeCells(`A${startRow}:L${startRow}`);
                            const titleCell = ws.getCell(`A${startRow}`);
                            titleCell.value = `${dataset.title.tr}\n${dataset.title.en}`;
                            titleCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                            titleCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
                            titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: dataset.color } };
                            titleCell.border = borderThin;
                            ws.getRow(startRow).height = 32;
                            startRow++;
                            
                            // Ay etiketleri
                            monthLabels.forEach((label, idx) => {
                                const col = String.fromCharCode(65 + idx); // A, B, C...
                                const cell = ws.getCell(`${col}${startRow}`);
                                cell.value = label;
                                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                                cell.font = { bold: true, size: 10 };
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf0f0f0' } };
                                cell.border = borderThin;
                            });
                            ws.getRow(startRow).height = 22;
                            startRow++;
                            
                            // Değerler
                            dataset.data.forEach((value, idx) => {
                                const col = String.fromCharCode(65 + idx);
                                const cell = ws.getCell(`${col}${startRow}`);
                                cell.value = typeof value === 'number' ? (value % 1 === 0 ? value : parseFloat(value.toFixed(2))) : value;
                                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                                cell.font = { size: 10 };
                                cell.border = borderThin;
                            });
                            ws.getRow(startRow).height = 22;
                            startRow++;
                            
                            // Boş satır
                            startRow++;
                        });
                        
                        // Sabit değerleri ekle
                        staticData.forEach(item => {
                            ws.mergeCells(`A${startRow}:F${startRow}`);
                            const titleCell = ws.getCell(`A${startRow}`);
                            titleCell.value = `${item.title.tr}\n${item.title.en}`;
                            titleCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                            titleCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
                            titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: item.color } };
                            titleCell.border = borderThin;
                            
                            ws.mergeCells(`G${startRow}:L${startRow}`);
                            const valueCell = ws.getCell(`G${startRow}`);
                            valueCell.value = typeof item.value === 'number' ? (item.value % 1 === 0 ? item.value : parseFloat(item.value.toFixed(2))) : item.value;
                            valueCell.alignment = { horizontal: 'center', vertical: 'middle' };
                            valueCell.font = { size: 11, bold: true };
                            valueCell.border = borderThin;
                            
                            ws.getRow(startRow).height = 38;
                            startRow++;
                            startRow++; // Boş satır
                        });
                    }
                }

                // Dosyayı indir
                const dateStr = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
                const buffer = await wb.xlsx.writeBuffer();
                if (options.returnBuffer) {
                    return buffer;
                }

                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const safeName = supplierName ? supplierName.replace(/[^a-zA-Z0-9_\- ]/g, '') : 'Supplier';
                const defaultFileName = `Target_Agreement_${safeName}_${baseYear}_${dateStr}.xlsx`;
                const fileName = options.fileNameOverride || defaultFileName;
                saveAs(blob, fileName);
                if (!options.silent) {
                    showAlert('✅ Target Agreement (tam biçimlendirme) Excel indirildi!', 'success');
                }
            } catch (e) {
                console.error('Target Agreement Excel oluşturulurken hata:', e);
                if (!options.silent) {
                    showAlert('❌ Excel oluşturulurken hata oluştu!', 'error');
                }
                return null;
            }
        }

        // ======== 8D REPORT SİSTEMİ ========
        
        const REPORT_8D_STORE_NAME = 'report8D';
        let current8DSupplier = null;
        let current8DMonth = null;
        let current8DData = null;
        let d2Attachments = []; // D2 attachments array
        let d5Attachments = []; // D5 attachments array
        let d6Attachments = []; // D6 attachments array
        let d7Attachments = []; // D7 attachments array
        let headDefectPhotos = []; // Head Defect Photos array
        let autoSync8DInterval = null; // Otomatik senkronizasyon interval'ı
        let isAutoSyncEnabled = false; // Otomatik senkronizasyon aktif mi?

        // 8D Modal açma
        async function open8DReportModal(supplierName, monthIndex, reportId = null) {
            current8DSupplier = supplierName;
            current8DMonth = monthIndex;
            
            document.getElementById('report8DTitle').textContent = `📋 8D RAPOR - ${supplierName} - ${monthIndex}.Ay`;
            
            // Buton görünümlerini ayarla
            const saveBtn = document.getElementById('save8DBtn');
            const syncBtn = document.getElementById('sync8DBtn');
            
            // Eğer reportId verilmişse o raporu yükle, yoksa yeni rapor oluştur
            if (reportId) {
                console.log('📂 8D rapor yüklenecek:', reportId);
                await load8DReportById(reportId);
                
                // Düzenleme modu - Kaydet butonu her zaman görünür (değişiklikleri JSONBin'e göndermek için)
                saveBtn.style.display = 'block';
                
                // Eğer raporun sharedStorjKey, sharedGistId, sharedBinId veya sharedPantryId varsa sync kontrol et
                if (current8DData && current8DData.sharedStorjKey) {
                    console.log('🔗 Storj paylaşımı bulundu:', current8DData.sharedStorjKey);
                    syncBtn.style.display = 'block';
                    // İlk açılışta bir kez sync yap
                    await silentSync8DStorj();
                } else if (current8DData && current8DData.sharedGistId) {
                    console.log('🔗 GitHub Gist paylaşımı bulundu:', current8DData.sharedGistId);
                    syncBtn.style.display = 'block';
                    // İlk açılışta bir kez sync yap
                    await silentSync8DGist();
                } else if (current8DData && current8DData.sharedPantryId && current8DData.sharedBasketName) {
                    console.log('🔗 Pantry paylaşımı bulundu:', current8DData.sharedPantryId);
                    syncBtn.style.display = 'block';
                    // İlk açılışta bir kez sync yap
                    await silentSync8DPantry();
                } else if (current8DData && current8DData.sharedBinId) {
                    // sharedBinId Pantry formatında mı kontrol et
                    if (current8DData.sharedBinId.startsWith('pantry:')) {
                        const parts = current8DData.sharedBinId.split(':');
                        if (parts.length >= 3) {
                            current8DData.sharedPantryId = parts[1];
                            current8DData.sharedBasketName = parts.slice(2).join(':');
                            console.log('🔗 Pantry formatı tespit edildi ve parse edildi:', {
                                pantryId: current8DData.sharedPantryId,
                                basketName: current8DData.sharedBasketName
                            });
                            syncBtn.style.display = 'block';
                            // İlk açılışta bir kez sync yap
                            await silentSync8DPantry();
                        }
                    } else {
                        console.log('🔗 JSONBin paylaşımı bulundu, sync başlatılıyor:', current8DData.sharedBinId);
                        await syncFromJsonBin(current8DData.sharedBinId, reportId);
                        syncBtn.style.display = 'block';
                    }
                } else {
                    console.log('ℹ️ Bu rapor paylaşılmamış, sync yok');
                    syncBtn.style.display = 'none';
                }
            } else {
                clear8DForm();
                current8DData = null;
                
                // Yeni rapor modu - Kaydet butonunu göster
                saveBtn.style.display = 'block';
                syncBtn.style.display = 'none';
                
                // Yeni rapor - bugünün tarihini set et
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('f8d_startDate').value = today;
                document.getElementById('f8d_currentDate').value = today;
            }
            
            document.getElementById('report8DModal').style.display = 'flex';
            switch8DTab('head');
        }

        // 8D Modal kapatma
        function close8DReportModal() {
            document.getElementById('report8DModal').style.display = 'none';
            
            // Otomatik senkronizasyonu durdur
            stopAutoSync8D();
            
            current8DSupplier = null;
            current8DMonth = null;
            current8DData = null;
        }

        // Otomatik senkronizasyon başlat
        // Senkronizasyon durumu göstergesini güncelle
        function updateSyncStatus(status, message, lastUpdate = null) {
            const indicator = document.getElementById('syncStatusIndicator');
            const icon = document.getElementById('syncStatusIcon');
            const text = document.getElementById('syncStatusText');
            const lastUpdateEl = document.getElementById('syncLastUpdate');
            
            if (!indicator) return;
            
            if (status === 'active') {
                indicator.style.background = 'rgba(33, 150, 243, 0.95)';
                icon.textContent = '🔄';
                text.textContent = message || 'Otomatik senkronizasyon aktif (5s)';
                indicator.style.display = 'block';
            } else if (status === 'syncing') {
                indicator.style.background = 'rgba(255, 152, 0, 0.95)';
                icon.textContent = '⏳';
                text.textContent = message || 'Senkronize ediliyor...';
                indicator.style.display = 'block';
            } else if (status === 'success') {
                indicator.style.background = 'rgba(76, 175, 80, 0.95)';
                icon.textContent = '✅';
                text.textContent = message || 'Senkronize edildi!';
                indicator.style.display = 'block';
                
                // 2 saniye sonra aktif duruma dön
                setTimeout(() => {
                    updateSyncStatus('active');
                }, 2000);
            } else if (status === 'off') {
                indicator.style.display = 'none';
            }
            
            if (lastUpdate && lastUpdateEl) {
                lastUpdateEl.textContent = `Son güncelleme: ${new Date(lastUpdate).toLocaleTimeString('tr-TR')}`;
                lastUpdateEl.style.display = 'block';
            }
        }
        
        function startAutoSync8D() {
            if (autoSync8DInterval) {
                clearInterval(autoSync8DInterval);
            }
            
            if (!current8DData || !current8DData.sharedBinId) {
                console.log('⚠️ Paylaşılmış rapor yok, otomatik sync başlatılamadı');
                return;
            }
            
            console.log('🔄 Otomatik senkronizasyon başlatıldı (5 saniyede bir)');
            isAutoSyncEnabled = true;
            
            // Durum göstergesini göster
            updateSyncStatus('active');
            
            // Her 5 saniyede bir sync yap
            autoSync8DInterval = setInterval(async () => {
                if (isAutoSyncEnabled && current8DData && current8DData.sharedBinId) {
                    console.log('🔄 Otomatik sync çalışıyor...');
                    updateSyncStatus('syncing');
                    await silentSync8D();
                }
            }, 5000); // 5 saniye
        }
        
        // Otomatik senkronizasyonu durdur
        function stopAutoSync8D() {
            if (autoSync8DInterval) {
                clearInterval(autoSync8DInterval);
                autoSync8DInterval = null;
                isAutoSyncEnabled = false;
                console.log('🛑 Otomatik senkronizasyon durduruldu');
                
                // Durum göstergesini gizle
                updateSyncStatus('off');
            }
        }
        
        // Sessiz senkronizasyon (bildirim göstermeden, modal içinde güncelleme yapar)
        // Akıllı birleştirme - her alanı timestamp'e göre birleştir
        function smartMerge8DReport(localData, remoteData) {
            console.log('🔀 Smart merge başlıyor...');
            const merged = JSON.parse(JSON.stringify(localData)); // Deep copy
            
            // Paylaşım bilgilerini koru (merge etme!)
            if (localData.sharedBinId) {
                merged.sharedBinId = localData.sharedBinId;
            }
            if (localData.sharedPantryId) {
                merged.sharedPantryId = localData.sharedPantryId;
            }
            if (localData.sharedBasketName) {
                merged.sharedBasketName = localData.sharedBasketName;
            }
            
            // Ana timestamp karşılaştırması
            const localTime = new Date(localData.timestamp || 0).getTime();
            const remoteTime = new Date(remoteData.timestamp || 0).getTime();
            
            // Her section için ayrı timestamp kontrolü (head dahil!)
            const sections = ['head', 'd0', 'd1', 'd2', 'd3', 'd4', 'd5', 'd6', 'd7', 'd8'];
            
            sections.forEach(section => {
                const localSection = localData[section];
                const remoteSection = remoteData[section];
                
                if (!localSection && remoteSection) {
                    // Local'de yok, remote'da var - remote'u al
                    merged[section] = JSON.parse(JSON.stringify(remoteSection));
                    console.log(`  📥 ${section}: Remote verisi alındı (local boş)`);
                } else if (localSection && remoteSection) {
                    // İkisi de var - timestamp karşılaştır
                    const localSectionTime = new Date(localSection.timestamp || localSection.lastUpdated || 0).getTime();
                    const remoteSectionTime = new Date(remoteSection.timestamp || remoteSection.lastUpdated || 0).getTime();
                    
                    if (remoteSectionTime >= localSectionTime) {
                        // Remote eşit veya daha yeni - REMOTE ÖNCELİKLİ!
                        merged[section] = JSON.parse(JSON.stringify(remoteSection));
                        console.log(`  📥 ${section}: Remote daha yeni/eşit (${new Date(remoteSectionTime).toLocaleString()})`);
                    } else {
                        console.log(`  📤 ${section}: Local daha yeni (${new Date(localSectionTime).toLocaleString()})`);
                    }
                }
            });
            
            // Head data birleştirme
            const headFields = [
                'f8d_partNumber', 'f8d_partName', 'f8d_defectDescription',
                'f8d_defectQuantity', 'f8d_totalCheckedQuantity', 'f8d_defectRate',
                'f8d_detectionPoint', 'f8d_initialActionDate'
            ];
            
            headFields.forEach(field => {
                if (remoteData[field] && !localData[field]) {
                    merged[field] = remoteData[field];
                    console.log(`  📥 Head ${field}: Remote verisi alındı`);
                } else if (remoteData[field] && localData[field]) {
                    // İkisi de varsa remote'u tercih et (son güncelleme kazanır)
                    if (remoteTime > localTime) {
                        merged[field] = remoteData[field];
                        console.log(`  📥 Head ${field}: Remote güncellendi`);
                    }
                }
            });
            
            // NOT: Attachment birleştirme KALDIRILDI!
            // Section merge zaten yapılıyor (>= ile remote öncelikli)
            // Remote section daha yeni/eşitse, o section'ın TÜM attachments'ları gelir
            
            // Head defect photos - Remote'dan al (eşit veya daha yeni ise remote kullan!)
            if (remoteData.head && remoteData.head.timestamp) {
                const localHeadTime = new Date(localData.head?.timestamp || 0).getTime();
                const remoteHeadTime = new Date(remoteData.head.timestamp).getTime();
                
                if (remoteHeadTime >= localHeadTime) {
                    // Remote daha yeni veya eşit - remote'u kullan (REMOTE ÖNCELİKLİ!)
                    if (!merged.head) merged.head = {};
                    merged.head.defectPhotos = remoteData.head.defectPhotos || [];
                    console.log(`  📸 Head defect photos remote'dan alındı: ${merged.head.defectPhotos.length} adet`);
                } else {
                    // Local daha yeni - local'i kullan
                    if (!merged.head) merged.head = {};
                    merged.head.defectPhotos = localData.head?.defectPhotos || [];
                    console.log(`  📸 Head defect photos local'de kalıyor: ${merged.head.defectPhotos.length} adet`);
                }
            } else if (localData.head?.defectPhotos) {
                // Remote'da head yok, local'i koru
                if (!merged.head) merged.head = {};
                merged.head.defectPhotos = localData.head.defectPhotos;
                console.log(`  📸 Head defect photos local'de kalıyor: ${merged.head.defectPhotos.length} adet`);
            }
            
            // Status ve timestamp güncelleme
            if (remoteTime > localTime) {
                merged.d8_status = remoteData.d8_status;
                merged.timestamp = remoteData.timestamp;
                console.log(`  🔄 Status ve timestamp güncellendi: ${merged.d8_status}`);
            }
            
            console.log('✅ Smart merge tamamlandı!');
            return merged;
        }
        
        async function silentSync8D() {
            if (!current8DData) {
                return;
            }
            
            // Storj kontrolü
            if (current8DData.sharedStorjKey) {
                return await silentSync8DStorj();
            }
            
            // GitHub Gist kontrolü
            if (current8DData.sharedGistId) {
                return await silentSync8DGist();
            }
            
            // Önce explicit Pantry bilgilerini kontrol et
            if (current8DData.sharedPantryId && current8DData.sharedBasketName) {
                return await silentSync8DPantry();
            }
            
            // sharedBinId'nin Pantry formatında olup olmadığını kontrol et
            if (current8DData.sharedBinId) {
                if (current8DData.sharedBinId.startsWith('pantry:')) {
                    // Pantry formatı: "pantry:pantryId:basketName"
                    const parts = current8DData.sharedBinId.split(':');
                    if (parts.length >= 3) {
                        current8DData.sharedPantryId = parts[1];
                        current8DData.sharedBasketName = parts.slice(2).join(':'); // basketName'de ':' olabilir
                        console.log('🔄 Pantry formatı tespit edildi:', {
                            pantryId: current8DData.sharedPantryId,
                            basketName: current8DData.sharedBasketName
                        });
                        return await silentSync8DPantry();
                    }
                } else {
                    // Normal JSONBin ID
                    return await silentSync8DJsonBin();
                }
            }
        }
        
        // Pantry ile sessiz sync
        async function silentSync8DPantry() {
            try {
                const pantryId = current8DData.sharedPantryId;
                const basketName = current8DData.sharedBasketName;
                
                if (!pantryId || !basketName) {
                    console.warn('⚠️ Pantry bilgileri eksik!');
                    return;
                }
                
                const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/${basketName}`);
                
                if (!response.ok) {
                    return;
                }
                
                const shareData = await response.json();
                const remoteData = shareData.reportData;
                
                // Akıllı birleştirme yap
                const localTime = new Date(current8DData.timestamp || 0).getTime();
                const remoteTime = new Date(remoteData.timestamp || 0).getTime();
                
                // Eğer remote'da değişiklik varsa merge yap
                if (remoteTime !== localTime || JSON.stringify(remoteData) !== JSON.stringify(current8DData)) {
                    console.log('🔔 Değişiklik tespit edildi! Akıllı birleştirme yapılıyor...');
                    console.log(`  📊 ÖNCƏ: Local D6 implementations: ${current8DData.d6?.implementations?.length || 0}`);
                    console.log(`  📊 ÖNCƏ: Remote D6 implementations: ${remoteData.d6?.implementations?.length || 0}`);
                    
                    const oldData = JSON.parse(JSON.stringify(current8DData));
                    const mergedData = smartMerge8DReport(current8DData, remoteData);
                    
                    console.log(`  📊 SONRA: Merged D6 implementations: ${mergedData.d6?.implementations?.length || 0}`);
                    
                    // Veritabanına kaydet
                    const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                    const store = tx.objectStore(REPORT_8D_STORE_NAME);
                    store.put(mergedData);
                    await new Promise(resolve => tx.oncomplete = resolve);
                    
                    current8DData = mergedData;
                    populate8DForm(mergedData);
                    showModalNotification('🔔 Rapor güncellendi!');
                } else {
                    console.log('ℹ️ Değişiklik yok, sync atlandı');
                }
            } catch (error) {
                console.error('❌ Pantry sessiz sync hatası:', error);
            }
        }
        
        // GitHub Gist ile sessiz sync
        async function silentSync8DGist() {
            if (!current8DData || !current8DData.sharedGistId) {
                return;
            }
            
            const token = getGitHubToken();
            if (!token) {
                console.log('ℹ️ GitHub token yok, sync atlandı');
                return;
            }
            
            try {
                console.log('🔄 Gist\'ten veri alınıyor...');
                const gistId = current8DData.sharedGistId;
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    console.error('❌ Gist yükleme hatası:', response.status);
                    return;
                }
                
                const gistData = await response.json();
                const files = gistData.files;
                const firstFile = Object.values(files)[0];
                
                if (!firstFile) {
                    console.error('❌ Gist\'te dosya bulunamadı');
                    return;
                }
                
                // Truncated kontrolü
                if (firstFile.truncated) {
                    console.error('❌ Gist dosyası kesilmiş (>1MB limit)');
                    showModalNotification('⚠️ Dosya çok büyük! Fotoğrafları küçültün.');
                    return;
                }
                
                let shareData;
                try {
                    shareData = JSON.parse(firstFile.content);
                } catch (parseError) {
                    console.error('❌ JSON parse hatası:', parseError);
                    console.error('📄 Content uzunluğu:', firstFile.content?.length);
                    return;
                }
                
                const remoteData = shareData.reportData;
                
                console.log('📥 Remote data timestamp:', remoteData.timestamp);
                console.log('📍 Local data timestamp:', current8DData.timestamp);
                
                const mergedData = smartMerge8DReport(current8DData, remoteData);
                
                if (mergedData !== current8DData) {
                    current8DData = mergedData;
                    
                    // IndexedDB'ye kaydet
                    const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                    const store = tx.objectStore(REPORT_8D_STORE_NAME);
                    store.put(mergedData);
                    await new Promise(resolve => tx.oncomplete = resolve);
                    
                    populate8DForm(mergedData);
                    showModalNotification('🔔 Rapor güncellendi!');
                } else {
                    console.log('ℹ️ Değişiklik yok, sync atlandı');
                }
            } catch (error) {
                console.error('❌ Gist sessiz sync hatası:', error);
            }
        }
        
        // Storj DCS ile sessiz sync
        async function silentSync8DStorj() {
            if (!current8DData || !current8DData.sharedStorjKey) {
                return;
            }
            
            let settings = getStorjSettings();
            
            // Eğer localStorage'da yoksa, URL'den al (supplier mode için)
            if (!settings) {
                const urlParams = new URLSearchParams(window.location.search);
                const storjEncoded = urlParams.get('storj');
                
                if (storjEncoded) {
                    try {
                        const credsJson = atob(storjEncoded);
                        const creds = JSON.parse(credsJson);
                        settings = {
                            accessKey: creds.accessKey,
                            secretKey: creds.secretKey,
                            bucket: creds.bucket,
                            endpoint: creds.endpoint
                        };
                        console.log('🔑 Credentials URL\'den alındı (supplier mode - silent sync)');
                    } catch (e) {
                        console.error('❌ URL credentials parse hatası:', e);
                    }
                }
            }
            
            if (!settings) {
                console.log('ℹ️ Storj ayarları yok, sync atlandı');
                return;
            }
            
            try {
                console.log('🔄 Storj\'dan veri alınıyor...');
                
                const shareData = await downloadFromStorj(current8DData.sharedStorjKey, settings);
                const remoteData = shareData.reportData;
                
                console.log('📥 Remote data timestamp:', remoteData.timestamp);
                console.log('📍 Local data timestamp:', current8DData.timestamp);
                
                const mergedData = smartMerge8DReport(current8DData, remoteData);
                
                if (mergedData !== current8DData) {
                    // Metadata'yı koru
                    mergedData.sharedStorjKey = current8DData.sharedStorjKey;
                    mergedData.id = current8DData.id;
                    
                    current8DData = mergedData;
                    
                    // IndexedDB'ye kaydet
                    const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                    const store = tx.objectStore(REPORT_8D_STORE_NAME);
                    store.put(mergedData);
                    await new Promise(resolve => tx.oncomplete = resolve);
                    
                    populate8DForm(mergedData);
                    showModalNotification('🔔 Rapor güncellendi!');
                } else {
                    console.log('ℹ️ Değişiklik yok, sync atlandı');
                }
            } catch (error) {
                console.error('❌ Storj sessiz sync hatası:', error);
            }
        }
        
        // JSONBin.io ile sessiz sync
        async function silentSync8DJsonBin() {
            if (!current8DData || !current8DData.sharedBinId) {
                return;
            }
            
            const apiKey = getJsonBinApiKey();
            if (!apiKey) {
                console.warn('⚠️ JSONBin API Key yok, senkronizasyon yapılamıyor');
                return;
            }
            
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${current8DData.sharedBinId}/latest`, {
                    headers: { 'X-Master-Key': apiKey }
                });
                
                if (!response.ok) {
                    if (response.status === 400) {
                        console.error('❌ JSONBin API Key geçersiz! Lütfen Ayarlar\'dan API Key\'i kontrol edin.');
                        // Otomatik sync'i durdur
                        stopAutoSync8D();
                        // Kullanıcıya bir kez uyarı göster
                        if (!window.jsonBinKeyWarningShown) {
                            window.jsonBinKeyWarningShown = true;
                            showAlert('⚠️ JSONBin API Key geçersiz!\n\n8D senkronizasyonu durdu. Lütfen Ayarlar > 8D Paylaşım Servisi bölümünden API Key\'inizi kontrol edin ve test edin.', 'error');
                        }
                    }
                    return;
                }
                
                const result = await response.json();
                const remoteData = result.record.reportData;
                
                // Akıllı birleştirme yap
                const localTime = new Date(current8DData.timestamp || 0).getTime();
                const remoteTime = new Date(remoteData.timestamp || 0).getTime();
                
                // Eğer remote'da değişiklik varsa merge yap
                if (remoteTime !== localTime || JSON.stringify(remoteData) !== JSON.stringify(current8DData)) {
                    console.log('🔔 Değişiklik tespit edildi! Akıllı birleştirme yapılıyor...');
                    
                    // Eski veriyi al
                    const oldData = JSON.parse(JSON.stringify(current8DData));
                    
                    // Smart merge uygula
                    const mergedData = smartMerge8DReport(current8DData, remoteData);
                    
                    // Veritabanına kaydet
                    const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                    const store = tx.objectStore(REPORT_8D_STORE_NAME);
                    store.put(mergedData);
                    
                    await new Promise(resolve => tx.oncomplete = resolve);
                    
                    // current8DData'yı güncelle
                    current8DData = mergedData;
                        
                        // 8D sayılarını güncelle
                        const supplierName = remoteData.d2_supplierName || current8DSupplier;
                        if (supplierName) {
                            const isNewReport = !oldData;
                            const wasClosedBefore = oldData && oldData.d8_status === 'Closed';
                            const isClosedNow = remoteData.d8_status === 'Closed';
                            
                            if (isNewReport) {
                                update8DCountsInSupplierData(supplierName, 1, isClosedNow ? 1 : 0);
                            } else if (!wasClosedBefore && isClosedNow) {
                                update8DCountsInSupplierData(supplierName, 0, 1);
                            } else if (wasClosedBefore && !isClosedNow) {
                                update8DCountsInSupplierData(supplierName, 0, -1);
                            } else {
                                if (typeof renderTable === 'function') {
                                    renderTable(lastFilteredResults || allResults);
                                }
                            }
                        }
                        
                        // Formu yeniden doldur (modal içinde güncelleme)
                        populate8DForm(mergedData);
                        
                        // Küçük bildirim göster (modal içinde)
                        showModalNotification('🔔 Rapor güncellendi!');
                        
                        // Durum göstergesini güncelle
                        updateSyncStatus('success', 'Senkronize edildi!', mergedData.timestamp);
                    } else {
                        // Değişiklik yok
                        console.log('ℹ️ Değişiklik yok, sync atlandı');
                    }
                } catch (error) {
                    console.error('❌ Sessiz sync hatası:', error);
                    updateSyncStatus('active'); // Hata durumunda normal duruma dön
                }
            }
        
        // Modal içinde küçük bildirim göster
        function showModalNotification(message) {
            const notification = document.getElementById('modal8DNotification');
            if (notification) {
                notification.textContent = message;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // Manuel sync fonksiyonu - HER ZAMAN GÜNCELLE!
        async function manualSync8D() {
            if (!current8DData) {
                showAlert('⚠️ Rapor yüklenmemiş!', 'warning');
                return;
            }
            
            // Storj kontrolü
            if (current8DData.sharedStorjKey) {
                return await manualSync8DStorj();
            }
            
            // GitHub Gist kontrolü
            if (current8DData.sharedGistId) {
                return await manualSync8DGist();
            }
            
            // Önce explicit Pantry bilgilerini kontrol et
            if (current8DData.sharedPantryId && current8DData.sharedBasketName) {
                return await manualSync8DPantry();
            }
            
            // sharedBinId Pantry formatında mı kontrol et
            if (current8DData.sharedBinId) {
                if (current8DData.sharedBinId.startsWith('pantry:')) {
                    // Pantry formatını parse et
                    const parts = current8DData.sharedBinId.split(':');
                    if (parts.length >= 3) {
                        current8DData.sharedPantryId = parts[1];
                        current8DData.sharedBasketName = parts.slice(2).join(':');
                        console.log('🔄 Pantry formatı parse edildi:', {
                            pantryId: current8DData.sharedPantryId,
                            basketName: current8DData.sharedBasketName
                        });
                        return await manualSync8DPantry();
                    }
                } else {
                    // JSONBin formatı
                    return await manualSync8DJsonBin();
                }
            } else {
                showAlert('⚠️ Bu rapor paylaşılmamış!', 'warning');
            }
        }
        
        // Storj DCS ile manuel sync
        async function manualSync8DStorj() {
            try {
                console.log('🔄 Storj\'dan veri çekiliyor...');
                updateSyncStatus('syncing', 'Senkronize ediliyor...');
                
                let settings = getStorjSettings();
                
                // Eğer localStorage'da yoksa, URL'den al (supplier mode için)
                if (!settings) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const storjEncoded = urlParams.get('storj');
                    
                    if (storjEncoded) {
                        try {
                            const credsJson = atob(storjEncoded);
                            const creds = JSON.parse(credsJson);
                            settings = {
                                accessKey: creds.accessKey,
                                secretKey: creds.secretKey,
                                bucket: creds.bucket,
                                endpoint: creds.endpoint
                            };
                            console.log('🔑 Credentials URL\'den alındı (supplier mode - manual sync)');
                        } catch (e) {
                            console.error('❌ URL credentials parse hatası:', e);
                        }
                    }
                }
                
                if (!settings) {
                    throw new Error('Storj ayarları bulunamadı!');
                }
                
                const shareData = await downloadFromStorj(current8DData.sharedStorjKey, settings);
                const remoteData = shareData.reportData;
                
                console.log('📥 Remote data yüklendi');
                console.log('🔀 Smart merge başlıyor...');
                
                const mergedData = smartMerge8DReport(current8DData, remoteData);
                // Metadata'yı koru
                mergedData.id = current8DData.id;
                mergedData.sharedStorjKey = current8DData.sharedStorjKey;
                
                current8DData = mergedData;
                
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                store.put(mergedData);
                await new Promise(resolve => tx.oncomplete = resolve);
                
                populate8DForm(mergedData);
                updateSyncStatus('success', 'Senkronize edildi!', mergedData.timestamp);
                showAlert('✅ Güncelleme tamamlandı!', 'success');
                
                setTimeout(() => updateSyncStatus('off'), 3000);
                
            } catch (error) {
                console.error('❌ Storj sync hatası:', error);
                updateSyncStatus('off');
                showAlert('❌ Güncelleme hatası: ' + error.message, 'error');
            }
        }
        
        // Pantry ile manuel sync
        async function manualSync8DPantry() {
            try {
                console.log('🔄 Pantry\'den veri çekiliyor...');
                updateSyncStatus('syncing', 'Senkronize ediliyor...');
                
                const pantryId = current8DData.sharedPantryId;
                const basketName = current8DData.sharedBasketName;
                
                if (!pantryId || !basketName) {
                    throw new Error('Pantry bilgileri eksik!');
                }
                
                console.log('🔑 Pantry ID:', pantryId.substring(0, 20) + '...');
                console.log('🗄️ Basket adı:', basketName);
                
                const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/${basketName}`);
                
                if (!response.ok) {
                    throw new Error('Pantry hatası: ' + response.status);
                }
                
                const shareData = await response.json();
                const remoteData = shareData.reportData;
                
                console.log('📥 Veri alındı, akıllı birleştirme yapılıyor...');
                
                const finalData = smartMerge8DReport(current8DData, remoteData);
                current8DData = finalData;
                
                // Veritabanına kaydet
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                store.put(finalData);
                await new Promise(resolve => tx.oncomplete = resolve);
                
                populate8DForm(finalData);
                updateSyncStatus('success', 'Senkronize edildi!', finalData.timestamp);
                showAlert('✅ Güncelleme tamamlandı!', 'success');
                
                // 3 saniye sonra göstergeyi gizle
                setTimeout(() => updateSyncStatus('off'), 3000);
                
            } catch (error) {
                console.error('❌ Pantry sync hatası:', error);
                updateSyncStatus('off');
                showAlert('❌ Güncelleme hatası: ' + error.message, 'error');
            }
        }
        
        // GitHub Gist ile manuel sync
        async function manualSync8DGist() {
            try {
                console.log('🔄 Gist\'ten veri çekiliyor...');
                updateSyncStatus('syncing', 'Senkronize ediliyor...');
                
                const token = getGitHubToken();
                if (!token) {
                    throw new Error('GitHub token bulunamadı!');
                }
                
                const gistId = current8DData.sharedGistId;
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Gist yükleme hatası: ${response.status}`);
                }
                
                const gistData = await response.json();
                const files = gistData.files;
                const firstFile = Object.values(files)[0];
                
                if (!firstFile) {
                    throw new Error('Gist\'te dosya bulunamadı');
                }
                
                console.log('📊 Dosya boyutu:', firstFile.size, 'byte');
                console.log('📄 Dosya adı:', firstFile.filename);
                
                // Büyük dosyalarda truncated olabilir
                if (firstFile.truncated) {
                    showAlert('⚠️ Dosya çok büyük! (>1MB)\nGist API limiti aşıldı.\n\nLütfen rapordaki fotoğrafları küçültün veya Pantry kullanın.', 'error');
                    throw new Error('Gist dosyası kesilmiş (>1MB). Raw content kullanılmalı.');
                }
                
                let shareData;
                try {
                    shareData = JSON.parse(firstFile.content);
                } catch (parseError) {
                    console.error('❌ JSON parse hatası:', parseError);
                    console.error('📄 Content uzunluğu:', firstFile.content?.length);
                    console.error('📄 İlk 500 karakter:', firstFile.content?.substring(0, 500));
                    throw new Error('JSON parse hatası - veri bozuk veya çok büyük');
                }
                
                const remoteData = shareData.reportData;
                
                console.log('📥 Remote data yüklendi');
                console.log('🔀 Smart merge başlıyor...');
                
                const mergedData = smartMerge8DReport(current8DData, remoteData);
                const finalData = { ...mergedData };
                finalData.id = current8DData.id;
                finalData.sharedGistId = gistId;
                
                current8DData = finalData;
                
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                store.put(finalData);
                await new Promise(resolve => tx.oncomplete = resolve);
                
                populate8DForm(finalData);
                updateSyncStatus('success', 'Senkronize edildi!', finalData.timestamp);
                showAlert('✅ Güncelleme tamamlandı!', 'success');
                
                setTimeout(() => updateSyncStatus('off'), 3000);
                
            } catch (error) {
                console.error('❌ Gist sync hatası:', error);
                updateSyncStatus('off');
                showAlert('❌ Güncelleme hatası: ' + error.message, 'error');
            }
        }
        
        // JSONBin ile manuel sync
        async function manualSync8DJsonBin() {
            if (!current8DData || !current8DData.sharedBinId) {
                showAlert('⚠️ Bu rapor paylaşılmamış!', 'warning');
                return;
            }
            
            const apiKey = getJsonBinApiKey();
            if (!apiKey) {
                showAlert('⚠️ API Key bulunamadı!', 'error');
                return;
            }
            
            try {
                console.log('🔄 JSONBin\'den veri çekiliyor...');
                const response = await fetch(`https://api.jsonbin.io/v3/b/${current8DData.sharedBinId}/latest`, {
                    headers: { 'X-Master-Key': apiKey }
                });
                
                if (!response.ok) {
                    throw new Error('JSONBin hatası: ' + response.status);
                }
                
                const result = await response.json();
                const remoteData = result.record.reportData;
                
                console.log('📥 Veri alındı, akıllı birleştirme yapılıyor...');
                
                // Eski veriyi al - yoksa yeni rapor demektir
                const checkTx = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
                const checkStore = checkTx.objectStore(REPORT_8D_STORE_NAME);
                const oldDataRequest = checkStore.get(remoteData.id);
                
                const oldData = await new Promise(resolve => {
                    oldDataRequest.onsuccess = () => resolve(oldDataRequest.result);
                    oldDataRequest.onerror = () => resolve(null);
                });
                
                // Eğer local veri varsa smart merge yap
                let finalData = remoteData;
                if (current8DData && current8DData.id === remoteData.id) {
                    console.log('🔀 Local veri var, smart merge uygulanıyor...');
                    finalData = smartMerge8DReport(current8DData, remoteData);
                } else {
                    console.log('📥 Local veri yok, remote veri direkt alınıyor');
                }
                
                current8DData = finalData;
                
                // Veritabanına kaydet
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                store.put(finalData);
                
                await new Promise(resolve => tx.oncomplete = resolve);
                
                console.log('💾 Birleştirilmiş veri veritabanına kaydedildi!');
                console.log('✅ current8DData senkronize edildi, sharedBinId:', current8DData.sharedBinId);
                
                // 8D sayılarını güncelle
                const supplierName = remoteData.d2_supplierName || current8DSupplier;
                if (supplierName) {
                    const isNewReport = !oldData; // Daha önce yoksa yeni rapor
                    const wasClosedBefore = oldData && oldData.d8_status === 'Closed';
                    const isClosedNow = remoteData.d8_status === 'Closed';
                    
                    if (isNewReport) {
                        // Yeni rapor geldi - talep edilen +1
                        console.log('🆕 Yeni 8D raporu - talepEdilen +1');
                        update8DCountsInSupplierData(supplierName, 1, isClosedNow ? 1 : 0);
                    } else if (!wasClosedBefore && isClosedNow) {
                        // Açıktan Closed'a geçiş - cevaplanan +1
                        console.log('✅ 8D Closed durumuna geçti - cevaplanan +1');
                        update8DCountsInSupplierData(supplierName, 0, 1);
                    } else if (wasClosedBefore && !isClosedNow) {
                        // Closed'dan açığa geçiş - cevaplanan -1
                        console.log('↩️ 8D Closed durumundan çıktı - cevaplanan -1');
                        update8DCountsInSupplierData(supplierName, 0, -1);
                    } else {
                        console.log('ℹ️ Status değişmedi, 8D sayıları korunuyor');
                    }
                }
                
                console.log('📝 Form güncelleniyor...');
                console.log('📎 Remote D2 Attachments:', remoteData.d2?.attachments?.length || 0);
                console.log('📎 Remote D5 Attachments:', remoteData.d5?.attachments?.length || 0);
                console.log('📎 Remote D6 Attachments:', remoteData.d6?.attachments?.length || 0);
                console.log('📎 Remote D7 Attachments:', remoteData.d7?.attachments?.length || 0);
                
                // Formu güncelle (clear8DForm çağırmıyoruz - attachmentlar kaybolmasın)
                // populate8DForm zaten tüm alanları dolduracak
                populate8DForm(remoteData);
                
                // Modal içinde bildirim göster
                const modalNotification = document.getElementById('modal8DNotification');
                if (modalNotification) {
                    modalNotification.textContent = '🔔 Rapor güncellendi!';
                    modalNotification.style.display = 'block';
                    setTimeout(() => {
                        modalNotification.style.display = 'none';
                    }, 3000);
                }
                
                showAlert('✅ Güncelleme tamamlandı!', 'success');
                console.log('✅ Güncelleme tamamlandı! Form dolduruldu.');
            } catch (error) {
                console.error('❌ Sync hatası:', error);
                showAlert('❌ Güncelleme hatası: ' + error.message, 'error');
            }
        }

        // Tab değiştirme
        function switch8DTab(tabName) {
            // Tüm tabları gizle
            document.querySelectorAll('.tab-8d-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Tüm tab butonlarından active sınıfını kaldır
            document.querySelectorAll('.tab-8d-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Seçili tabı göster
            const selectedContent = document.querySelector(`[data-tab-content="${tabName}"]`);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
            
            // Seçili tab butonunu aktif yap
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
        }

        // D1 Team Member ekleme
        let d1MemberCount = 0;
        function addD1TeamMember(data = {}) {
            d1MemberCount++;
            const container = document.getElementById('d1TeamMembers');
            const memberId = `d1_member_${d1MemberCount}`;
            
            const html = `
                <div class="d1-team-member" id="${memberId}">
                    <button class="remove-btn-8d" onclick="document.getElementById('${memberId}').remove()">×</button>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Name</label>
                            <input type="text" class="d1-name" value="${data.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Department</label>
                            <input type="text" class="d1-department" value="${data.department || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Position</label>
                            <input type="text" class="d1-position" value="${data.position || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="grid-column: span 3;">
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Contact Details</label>
                            <input type="text" class="d1-contact" value="${data.contact || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Email, Phone, etc.">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D3 Containment Action ekleme
        let d3ActionCount = 0;
        function addD3Action(data = {}) {
            d3ActionCount++;
            const container = document.getElementById('d3ContainmentActions');
            const actionId = `d3_action_${d3ActionCount}`;
            
            const html = `
                <div class="d3-action" id="${actionId}">
                    <button class="remove-btn-8d" onclick="document.getElementById('${actionId}').remove()">×</button>
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Containment Action Description</label>
                        <textarea class="d3-description" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${data.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Responsible Person</label>
                            <input type="text" class="d3-responsible" value="${data.responsible || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Target Date</label>
                            <input type="date" class="d3-date" value="${data.date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D4 Root Cause ekleme
        let d4RootCauseCount = 0;
        function addD4RootCause(type, data = {}) {
            d4RootCauseCount++;
            const container = document.getElementById('d4RootCauses');
            const causeId = `d4_cause_${d4RootCauseCount}`;
            
            const typeNames = {
                'tco': 'Technical Root Cause Occurrence (TCO)',
                'tcn': 'Technical Root Cause Non-Detection (TCN)',
                'sco': 'Systemic Root Cause Occurrence (SCO)',
                'scn': 'Systemic Root Cause Non-Detection (SCN)'
            };
            
            const html = `
                <div class="d4-root-cause" id="${causeId}" style="border-left: 4px solid #c62828;">
                    <button class="remove-btn-8d" onclick="document.getElementById('${causeId}').remove()">×</button>
                    <h4 style="margin: 0 0 10px 0; color: #c62828;">${typeNames[type]}</h4>
                    <input type="hidden" class="d4-type" value="${type}">
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Title</label>
                        <input type="text" class="d4-title" value="${data.title || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Description</label>
                        <textarea class="d4-description" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${data.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Verification by (Person)</label>
                            <input type="text" class="d4-verification" value="${data.verification || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Results / Method / Report</label>
                            <input type="text" class="d4-results" value="${data.results || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Date</label>
                            <input type="date" class="d4-date" value="${data.date || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D5 Corrective Action ekleme
        let d5ActionCount = 0;
        function addD5Action(data = {}) {
            d5ActionCount++;
            const container = document.getElementById('d5CorrectiveActions');
            const actionId = `d5_action_${d5ActionCount}`;
            
            const html = `
                <div class="d5-action" id="${actionId}">
                    <button class="remove-btn-8d" onclick="document.getElementById('${actionId}').remove()">×</button>
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Corrective Action</label>
                        <textarea class="d5-action-text" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${data.action || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Plan Date of Launch</label>
                            <input type="date" class="d5-plan-date" value="${data.planDate || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Responsible for the Launch</label>
                            <input type="text" class="d5-responsible" value="${data.responsible || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Verification performed on</label>
                            <input type="date" class="d5-verification-date" value="${data.verificationDate || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="grid-column: span 3;">
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Verification by (Person)</label>
                            <input type="text" class="d5-verification-person" value="${data.verificationPerson || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D6 Implementation ekleme
        let d6ImplementationCount = 0;
        function addD6Implementation(data = {}) {
            d6ImplementationCount++;
            const container = document.getElementById('d6Implementations');
            const implId = `d6_impl_${d6ImplementationCount}`;
            
            const html = `
                <div class="d6-implementation" id="${implId}">
                    <button class="remove-btn-8d" onclick="document.getElementById('${implId}').remove()">×</button>
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Corrective Action</label>
                        <textarea class="d6-action" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${data.action || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Launch Date</label>
                            <input type="date" class="d6-launch-date" value="${data.launchDate || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Effective From</label>
                            <input type="date" class="d6-effective-from" value="${data.effectiveFrom || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Validated on</label>
                            <input type="date" class="d6-validated-on" value="${data.validatedOn || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="grid-column: span 3;">
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Responsible (Validation)</label>
                            <input type="text" class="d6-responsible" value="${data.responsible || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D7 Prevention ekleme
        let d7PreventionCount = 0;
        function addD7Prevention(data = {}) {
            d7PreventionCount++;
            const container = document.getElementById('d7Preventions');
            const prevId = `d7_prev_${d7PreventionCount}`;
            
            const html = `
                <div class="d7-prevention" id="${prevId}">
                    <button class="remove-btn-8d" onclick="document.getElementById('${prevId}').remove()">×</button>
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Description</label>
                        <textarea class="d7-description" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${data.description || ''}</textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Responsible (Person, Contact)</label>
                            <input type="text" class="d7-responsible" value="${data.responsible || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Planned</label>
                            <input type="date" class="d7-planned" value="${data.planned || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Hand Over Date</label>
                            <input type="date" class="d7-handover" value="${data.handover || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="grid-column: span 3;">
                            <label style="font-weight: 600; font-size: 0.9em; color: #666;">Assessment of Applicability (by the Recipient)</label>
                            <input type="text" class="d7-assessment" value="${data.assessment || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D8 Participant ekleme
        let d8ParticipantCount = 0;
        function addD8Participant(data = {}) {
            d8ParticipantCount++;
            const container = document.getElementById('d8Participants');
            const partId = `d8_part_${d8ParticipantCount}`;
            
            const html = `
                <div class="d8-participant" id="${partId}">
                    <button class="remove-btn-8d" onclick="document.getElementById('${partId}').remove()">×</button>
                    <div style="margin-top: 10px;">
                        <label style="font-weight: 600; font-size: 0.9em; color: #666;">Participant Name</label>
                        <input type="text" class="d8-participant-name" value="${data.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // D2 Attachments Handling
        function handleD2Attachments(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const sizeLimit = getMaxFileSizeForService();
            const maxSize = sizeLimit.bytes;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > maxSize) {
                    alert(`⚠️ DOSYA ÇOK BÜYÜK!\n\nDosya: "${file.name}"\nBoyut: ${(file.size / 1024 / 1024).toFixed(2)} MB\n\n❌ Seçili servis: ${sizeLimit.name}\n❌ Maksimum dosya boyutu: ${sizeLimit.text}\n\n💡 Daha büyük dosyalar için Pantry (1.44 MB) kullanın!`);
                    showAlert(`❌ "${file.name}" çok büyük! ${sizeLimit.name} limiti: ${sizeLimit.text}`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    d2Attachments.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    });
                    renderD2Attachments();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }
        
        function renderD2Attachments() {
            const container = document.getElementById('d2AttachmentsList');
            if (!d2Attachments || d2Attachments.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Henüz ek dosya eklenmedi</div>';
                return;
            }
            
            let html = '';
            d2Attachments.forEach((attachment, index) => {
                const fileSize = (attachment.size / 1024).toFixed(1) + ' KB';
                const fileIcon = getFileIcon(attachment.type);
                html += `
                    <div style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; gap: 10px;">
                        <span style="font-size: 1.5em;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${attachment.name}</div>
                            <div style="font-size: 0.85em; color: #666;">${fileSize} - ${new Date(attachment.uploadDate).toLocaleString('tr-TR')}</div>
                        </div>
                        <button onclick="downloadD2Attachment(${index})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;" title="İndir">📥</button>
                        <button onclick="removeD2Attachment(${index})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Sil">🗑️</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function downloadD2Attachment(index) {
            const attachment = d2Attachments[index];
            if (!attachment) return;
            const link = document.createElement('a');
            link.href = attachment.data;
            link.download = attachment.name;
            link.click();
        }
        
        function removeD2Attachment(index) {
            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                d2Attachments.splice(index, 1);
                renderD2Attachments();
            }
        }

        // D5 Attachments Handling
        function handleD5Attachments(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const sizeLimit = getMaxFileSizeForService();
            const maxSize = sizeLimit.bytes;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > maxSize) {
                    alert(`⚠️ DOSYA ÇOK BÜYÜK!\n\nDosya: "${file.name}"\nBoyut: ${(file.size / 1024 / 1024).toFixed(2)} MB\n\n❌ Seçili servis: ${sizeLimit.name}\n❌ Maksimum dosya boyutu: ${sizeLimit.text}\n\n💡 Daha büyük dosyalar için Pantry (1.44 MB) kullanın!`);
                    showAlert(`❌ "${file.name}" çok büyük! ${sizeLimit.name} limiti: ${sizeLimit.text}`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    d5Attachments.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    });
                    renderD5Attachments();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }
        
        function renderD5Attachments() {
            const container = document.getElementById('d5AttachmentsList');
            if (!d5Attachments || d5Attachments.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Henüz ek dosya eklenmedi</div>';
                return;
            }
            
            let html = '';
            d5Attachments.forEach((attachment, index) => {
                const fileSize = (attachment.size / 1024).toFixed(1) + ' KB';
                const fileIcon = getFileIcon(attachment.type);
                html += `
                    <div style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; gap: 10px;">
                        <span style="font-size: 1.5em;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${attachment.name}</div>
                            <div style="font-size: 0.85em; color: #666;">${fileSize} - ${new Date(attachment.uploadDate).toLocaleString('tr-TR')}</div>
                        </div>
                        <button onclick="downloadD5Attachment(${index})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;" title="İndir">📥</button>
                        <button onclick="removeD5Attachment(${index})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Sil">🗑️</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function downloadD5Attachment(index) {
            const attachment = d5Attachments[index];
            if (!attachment) return;
            const link = document.createElement('a');
            link.href = attachment.data;
            link.download = attachment.name;
            link.click();
        }
        
        function removeD5Attachment(index) {
            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                d5Attachments.splice(index, 1);
                renderD5Attachments();
            }
        }

        // D6 Attachments Handling
        function handleD6Attachments(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const sizeLimit = getMaxFileSizeForService();
            const maxSize = sizeLimit.bytes;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > maxSize) {
                    alert(`⚠️ DOSYA ÇOK BÜYÜK!\n\nDosya: "${file.name}"\nBoyut: ${(file.size / 1024 / 1024).toFixed(2)} MB\n\n❌ Seçili servis: ${sizeLimit.name}\n❌ Maksimum dosya boyutu: ${sizeLimit.text}\n\n💡 Daha büyük dosyalar için Pantry (1.44 MB) kullanın!`);
                    showAlert(`❌ "${file.name}" çok büyük! ${sizeLimit.name} limiti: ${sizeLimit.text}`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    d6Attachments.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    });
                    renderD6Attachments();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }
        
        function renderD6Attachments() {
            const container = document.getElementById('d6AttachmentsList');
            if (!d6Attachments || d6Attachments.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Henüz ek dosya eklenmedi</div>';
                return;
            }
            
            let html = '';
            d6Attachments.forEach((attachment, index) => {
                const fileSize = (attachment.size / 1024).toFixed(1) + ' KB';
                const fileIcon = getFileIcon(attachment.type);
                html += `
                    <div style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; gap: 10px;">
                        <span style="font-size: 1.5em;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${attachment.name}</div>
                            <div style="font-size: 0.85em; color: #666;">${fileSize} - ${new Date(attachment.uploadDate).toLocaleString('tr-TR')}</div>
                        </div>
                        <button onclick="downloadD6Attachment(${index})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;" title="İndir">📥</button>
                        <button onclick="removeD6Attachment(${index})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Sil">🗑️</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function downloadD6Attachment(index) {
            const attachment = d6Attachments[index];
            if (!attachment) return;
            const link = document.createElement('a');
            link.href = attachment.data;
            link.download = attachment.name;
            link.click();
        }
        
        function removeD6Attachment(index) {
            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                d6Attachments.splice(index, 1);
                renderD6Attachments();
            }
        }

        // D7 Attachments Handling
        function handleD7Attachments(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const sizeLimit = getMaxFileSizeForService();
            const maxSize = sizeLimit.bytes;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.size > maxSize) {
                    alert(`⚠️ DOSYA ÇOK BÜYÜK!\n\nDosya: "${file.name}"\nBoyut: ${(file.size / 1024 / 1024).toFixed(2)} MB\n\n❌ Seçili servis: ${sizeLimit.name}\n❌ Maksimum dosya boyutu: ${sizeLimit.text}\n\n💡 Daha büyük dosyalar için Pantry (1.44 MB) kullanın!`);
                    showAlert(`❌ "${file.name}" çok büyük! ${sizeLimit.name} limiti: ${sizeLimit.text}`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const attachment = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    };
                    
                    d7Attachments.push(attachment);
                    renderD7Attachments();
                };
                
                reader.readAsDataURL(file);
            }
            
            // Input'u temizle
            event.target.value = '';
        }
        
        function renderD7Attachments() {
            const container = document.getElementById('d7AttachmentsList');
            
            if (!d7Attachments || d7Attachments.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Henüz ek dosya eklenmedi</div>';
                return;
            }
            
            let html = '';
            d7Attachments.forEach((attachment, index) => {
                const fileSize = (attachment.size / 1024).toFixed(1) + ' KB';
                const fileIcon = getFileIcon(attachment.type);
                
                html += `
                    <div style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; gap: 10px;">
                        <span style="font-size: 1.5em;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${attachment.name}</div>
                            <div style="font-size: 0.85em; color: #666;">${fileSize} - ${new Date(attachment.uploadDate).toLocaleString('tr-TR')}</div>
                        </div>
                        <button onclick="downloadD7Attachment(${index})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;" title="İndir">
                            📥
                        </button>
                        <button onclick="removeD7Attachment(${index})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Sil">
                            🗑️
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return '🖼️';
            if (fileType.includes('pdf')) return '📄';
            if (fileType.includes('word')) return '📝';
            if (fileType.includes('excel') || fileType.includes('sheet')) return '📊';
            return '📎';
        }
        
        function downloadD7Attachment(index) {
            const attachment = d7Attachments[index];
            if (!attachment) return;
            
            const link = document.createElement('a');
            link.href = attachment.data;
            link.download = attachment.name;
            link.click();
        }
        
        function removeD7Attachment(index) {
            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                d7Attachments.splice(index, 1);
                renderD7Attachments();
            }
        }

        // Head Defect Photos Handling
        function handleHeadDefectPhotos(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const sizeLimit = getMaxFileSizeForService();
            const maxSize = sizeLimit.bytes;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.size > maxSize) {
                    alert(`⚠️ FOTOĞRAF ÇOK BÜYÜK!\n\nDosya: "${file.name}"\nBoyut: ${(file.size / 1024 / 1024).toFixed(2)} MB\n\n❌ Seçili servis: ${sizeLimit.name}\n❌ Maksimum dosya boyutu: ${sizeLimit.text}\n\n💡 Daha büyük fotoğraflar için Pantry (1.44 MB) kullanın!`);
                    showAlert(`❌ "${file.name}" çok büyük! ${sizeLimit.name} limiti: ${sizeLimit.text}`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const attachment = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    };
                    
                    headDefectPhotos.push(attachment);
                    renderHeadDefectPhotos();
                };
                
                reader.readAsDataURL(file);
            }
            
            // Input'u temizle
            event.target.value = '';
        }
        
        function renderHeadDefectPhotos() {
            const container = document.getElementById('headDefectPhotosList');
            
            if (!headDefectPhotos || headDefectPhotos.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Henüz ek dosya eklenmedi</div>';
                return;
            }
            
            let html = '';
            headDefectPhotos.forEach((attachment, index) => {
                const fileSize = (attachment.size / 1024).toFixed(1) + ' KB';
                const fileIcon = getFileIcon(attachment.type);
                
                html += `
                    <div style="display: flex; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; gap: 10px;">
                        <span style="font-size: 1.5em;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${attachment.name}</div>
                            <div style="font-size: 0.85em; color: #666;">${fileSize} - ${new Date(attachment.uploadDate).toLocaleString('tr-TR')}</div>
                        </div>
                        <button onclick="downloadHeadDefectPhoto(${index})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;" title="İndir">
                            📥
                        </button>
                        <button onclick="removeHeadDefectPhoto(${index})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Sil">
                            🗑️
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function downloadHeadDefectPhoto(index) {
            const attachment = headDefectPhotos[index];
            if (!attachment) return;
            
            const link = document.createElement('a');
            link.href = attachment.data;
            link.download = attachment.name;
            link.click();
        }
        
        function removeHeadDefectPhoto(index) {
            if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
                headDefectPhotos.splice(index, 1);
                renderHeadDefectPhotos();
            }
        }
        
        // Defect Rate otomatik hesaplama
        function calculateDefectRate() {
            const defectQty = parseFloat(document.getElementById('f8d_defectQuantity').value) || 0;
            const totalChecked = parseFloat(document.getElementById('f8d_totalCheckedQuantity').value) || 0;
            
            if (totalChecked > 0) {
                const rate = (defectQty / totalChecked) * 100;
                document.getElementById('f8d_defectRate').value = rate.toFixed(2);
            } else {
                document.getElementById('f8d_defectRate').value = '0.00';
            }
        }
        
        // Event listener'ları ekle (sayfa yüklendiğinde)
        document.addEventListener('DOMContentLoaded', function() {
            const defectQtyInput = document.getElementById('f8d_defectQuantity');
            const totalCheckedInput = document.getElementById('f8d_totalCheckedQuantity');
            
            if (defectQtyInput) {
                defectQtyInput.addEventListener('input', calculateDefectRate);
            }
            if (totalCheckedInput) {
                totalCheckedInput.addEventListener('input', calculateDefectRate);
            }
        });

        // Pantry ID Yönetimi
        function savePantryId() {
            const pantryId = document.getElementById('pantryId').value.trim();
            if (!pantryId) {
                showAlert('⚠️ Pantry ID boş olamaz!', 'error');
                return;
            }
            
            // UUID formatını kontrol et (basit kontrol)
            if (pantryId.length < 8) {
                showAlert('⚠️ Pantry ID çok kısa! UUID formatında olmalıdır.\n\nÖrnek: abc123-def456-ghi789', 'error');
                return;
            }
            
            console.log('💾 Pantry ID kaydediliyor...');
            console.log('🗄️ ID uzunluğu:', pantryId.length, 'karakter');
            
            localStorage.setItem('pantry_id', pantryId);
            
            // Kaydedildiğini doğrula
            const savedId = localStorage.getItem('pantry_id');
            if (savedId === pantryId) {
                console.log('✅ Pantry ID başarıyla kaydedildi!');
                showAlert('✅ Pantry ID kaydedildi!\n\n🗄️ ID: ' + pantryId.substring(0, 20) + '...\n\nŞimdi 8D raporlarını paylaşabilirsiniz!', 'success');
            } else {
                console.error('❌ Pantry ID kaydedilemedi!');
                showAlert('❌ Pantry ID kaydedilemedi! Lütfen tekrar deneyin.', 'error');
            }
        }
        
        function getPantryId() {
            const savedId = localStorage.getItem('pantry_id');
            if (savedId) {
                console.log('🗄️ Pantry ID localStorage\'dan alındı');
                return savedId;
            }
            return null;
        }

        // 8D Raporu kaydetme
        // JSONBin.io API Key Yönetimi
        function saveJsonBinApiKey() {
            const apiKey = document.getElementById('jsonbinApiKey').value.trim();
            if (!apiKey) {
                showAlert('⚠️ API Key boş olamaz!', 'error');
                return;
            }
            
            // API key formatını kontrol et
            if (apiKey.length < 20) {
                showAlert('⚠️ API Key çok kısa! Doğru key\'i kopyaladığınızdan emin olun.', 'error');
                return;
            }
            
            console.log('💾 API Key kaydediliyor...');
            console.log('🔑 Key uzunluğu:', apiKey.length, 'karakter');
            console.log('🔑 Key başlangıcı:', apiKey.substring(0, 10) + '...');
            
            localStorage.setItem('jsonbin_api_key', apiKey);
            
            // Kaydedildiğini doğrula
            const savedKey = localStorage.getItem('jsonbin_api_key');
            if (savedKey === apiKey) {
                console.log('✅ API Key başarıyla kaydedildi ve doğrulandı!');
                showAlert('✅ API Key kaydedildi!\n\n🔑 Key uzunluğu: ' + apiKey.length + ' karakter\n\nŞimdi 8D raporunu paylaşabilirsiniz.', 'success');
            } else {
                console.error('❌ API Key kaydedilemedi!');
                showAlert('❌ API Key kaydedilemedi! Lütfen tekrar deneyin.', 'error');
            }
        }

        // Servis seçimi toggle
        function toggle8DServiceSettings() {
            const selectedService = document.querySelector('input[name="shareService"]:checked').value;
            const jsonbinSettings = document.getElementById('jsonbinSettings');
            const pantrySettings = document.getElementById('pantrySettings');
            const gistSettings = document.getElementById('gistSettings');
            const storjSettings = document.getElementById('storjSettings');
            
            // Tüm ayarları gizle
            jsonbinSettings.style.display = 'none';
            pantrySettings.style.display = 'none';
            gistSettings.style.display = 'none';
            if (storjSettings) storjSettings.style.display = 'none';
            
            // Seçili servisi göster
            if (selectedService === 'jsonbin') {
                jsonbinSettings.style.display = 'block';
            } else if (selectedService === 'pantry') {
                pantrySettings.style.display = 'block';
            } else if (selectedService === 'gist') {
                gistSettings.style.display = 'block';
            } else if (selectedService === 'storj') {
                if (storjSettings) {
                    storjSettings.style.display = 'block';
                    // Storj ayarlarını yükle
                    loadStorjSettings();
                }
            }
            
            // Seçimi kaydet
            localStorage.setItem('preferred_8d_service', selectedService);
            console.log('✅ Paylaşım servisi değiştirildi:', selectedService);
        }
        
        // Seçili servisi al
        function get8DShareService() {
            return localStorage.getItem('preferred_8d_service') || 'pantry';
        }
        
        // Pantry ile paylaş (API key yok, limitsiz)
        async function shareWith8DPantry(reportData, supplierName, monthIndex) {
            try {
                // Kaydedilmiş Pantry ID'yi al
                const pantryId = getPantryId();
                if (!pantryId) {
                    throw new Error('Pantry ID bulunamadı! Lütfen önce Pantry ID kaydedin.');
                }
                
                // Basket adı oluştur (her rapor için unique)
                const basketName = `newBasket8D-${reportData.id}`;
                
                const shareData = {
                    reportId: reportData.id,
                    supplierName: supplierName,
                    monthIndex: monthIndex,
                    reportData: reportData,
                    sharedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };
                
                console.log('📤 Pantry\'ye gönderiliyor...');
                console.log('🔑 Pantry ID:', pantryId.substring(0, 20) + '...');
                console.log('🗄️ Basket adı:', basketName);
                console.log('📊 Veri boyutu:', JSON.stringify(shareData).length, 'byte');
                
                const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/${basketName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shareData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Pantry error: ${response.status} - ${errorText}`);
                }
                
                console.log('✅ Pantry\'ye yüklendi!');
                console.log('🔑 Pantry ID:', pantryId.substring(0, 20) + '...');
                console.log('🗄️ Basket adı:', basketName);
                
                // Basket bilgisini rapor verisine ekle ve kaydet
                reportData.sharedPantryId = pantryId;
                reportData.sharedBasketName = basketName;
                await updateReportBinId(reportData.id, `pantry:${pantryId}:${basketName}`);
                
                // Share URL oluştur
                const shareUrl = `${window.location.origin}${window.location.pathname}?8d=pantry:${pantryId}:${basketName}`;
                
                return shareUrl;
                
            } catch (error) {
                console.error('❌ Pantry paylaşım hatası:', error);
                throw error;
            }
        }
        
        // Pantry'den yükle
        async function loadFromPantry(pantryIdAndBasket) {
            try {
                console.log('📥 Pantry\'den yükleniyor...');
                
                // pantryIdAndBasket formatı: "pantryId:basketName"
                const [pantryId, basketName] = pantryIdAndBasket.split(':');
                
                console.log('🔑 Pantry ID:', pantryId.substring(0, 20) + '...');
                console.log('🗄️ Basket adı:', basketName);
                
                const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/${basketName}`);
                
                if (!response.ok) {
                    throw new Error(`Pantry error: ${response.status}`);
                }
                
                const shareData = await response.json();
                console.log('✅ Pantry\'den yüklendi!');
                
                return shareData;
                
            } catch (error) {
                console.error('❌ Pantry yükleme hatası:', error);
                throw error;
            }
        }

        function getJsonBinApiKey() {
            // Önce URL'den kontrol et (tedarikçi modu için)
            const urlParams = new URLSearchParams(window.location.search);
            const urlKey = urlParams.get('key');
            if (urlKey) {
                try {
                    const decodedKey = atob(urlKey);
                    console.log('🔑 API Key URL\'den alındı (tedarikçi modu)');
                    console.log('🔑 Key uzunluğu:', decodedKey.length, 'karakter');
                    return decodedKey;
                } catch (e) {
                    console.error('❌ URL\'deki API Key decode edilemedi:', e);
                }
            }
            
            // URL'de yoksa localStorage'dan al (admin modu)
            const storedKey = localStorage.getItem('jsonbin_api_key') || '';
            if (storedKey) {
                console.log('🔑 API Key localStorage\'dan alındı (admin modu)');
                console.log('🔑 Key uzunluğu:', storedKey.length, 'karakter');
                console.log('🔑 Key başlangıcı:', storedKey.substring(0, 15) + '...');
            } else {
                console.warn('⚠️ API Key bulunamadı! localStorage boş.');
            }
            return storedKey;
        }

        async function testJsonBinConnection() {
            const apiKey = getJsonBinApiKey();
            if (!apiKey) {
                showAlert('⚠️ Önce API Key kaydedin!', 'error');
                return;
            }

            console.log('🧪 JSONBin bağlantı testi başlıyor...');
            console.log('🔑 API Key uzunluğu:', apiKey.length, 'karakter');

            try {
                // Test için basit bir bin oluştur
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'JSONBin connection test'
                };

                console.log('📤 Test verisi gönderiliyor...');

                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey,
                        'X-Bin-Name': 'connection_test'
                    },
                    body: JSON.stringify(testData)
                });

                console.log('📡 Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    const binId = result.metadata.id;
                    
                    console.log('✅ Test başarılı! Bin ID:', binId);
                    
                    // Test bin'i sil
                    try {
                        await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                            method: 'DELETE',
                            headers: { 'X-Master-Key': apiKey }
                        });
                        console.log('🗑️ Test bin silindi');
                    } catch (e) {
                        console.warn('Test bin silinemedi:', e);
                    }
                    
                    showAlert('✅ JSONBin Bağlantı Başarılı!\n\n🔑 API Key çalışıyor\n📡 Bin oluşturuldu ve silindi\n\n8D raporlarını paylaşabilirsiniz!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('❌ Test başarısız:', response.status, errorText);
                    
                    let errorMsg = '❌ JSONBin Bağlantı Hatası!\n\n';
                    
                    if (response.status === 401) {
                        errorMsg += '🔒 Kimlik doğrulama hatası!\n\nAPI Key geçersiz veya süresi dolmuş.\n\n';
                    } else if (response.status === 403) {
                        errorMsg += '🚫 Yetki hatası!\n\nAPI Key geçersiz veya bin oluşturma yetkisi yok.\n\n';
                        errorMsg += '💡 Çözüm:\n';
                        errorMsg += '1. JSONBin.io hesabınıza giriş yapın\n';
                        errorMsg += '2. Yeni bir API Key oluşturun\n';
                        errorMsg += '3. API Key\'in tüm yetkilere sahip olduğundan emin olun\n\n';
                    } else if (response.status === 429) {
                        errorMsg += '⏱️ İstek limiti aşıldı!\n\nBir süre bekleyin ve tekrar deneyin.\n\n';
                    } else {
                        errorMsg += `📊 HTTP ${response.status}\n\n`;
                    }
                    
                    errorMsg += `📝 Detay: ${errorText}`;
                    showAlert(errorMsg, 'error');
                }
            } catch (error) {
                console.error('❌ Test exception:', error);
                showAlert('❌ Bağlantı Hatası!\n\n' + error.message + '\n\nİnternet bağlantınızı kontrol edin.', 'error');
            }
        }
        
        // GitHub Token kaydet
        function saveGitHubToken() {
            const tokenInput = document.getElementById('githubToken');
            const token = tokenInput.value.trim();
            
            if (!token) {
                showAlert('⚠️ Lütfen GitHub token girin!', 'error');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showAlert('⚠️ GitHub token genellikle "ghp_" veya "github_pat_" ile başlar!\n\nDoğru token\'ı kopyaladığınızdan emin olun.', 'error');
                return;
            }
            
            console.log('💾 GitHub token kaydediliyor...');
            console.log('🔑 Token uzunluğu:', token.length, 'karakter');
            
            localStorage.setItem('github_token', token);
            
            const savedToken = localStorage.getItem('github_token');
            if (savedToken === token) {
                console.log('✅ GitHub token başarıyla kaydedildi!');
                showAlert('✅ GitHub Token kaydedildi!\n\n🔑 Token uzunluğu: ' + token.length + ' karakter\n\nŞimdi 8D raporunu paylaşabilirsiniz.', 'success');
            } else {
                console.error('❌ GitHub token kaydedilemedi!');
                showAlert('❌ Token kaydedilemedi! Lütfen tekrar deneyin.', 'error');
            }
        }
        
        // GitHub bağlantı testi
        async function testGitHubConnection() {
            const token = localStorage.getItem('github_token');
            
            if (!token) {
                showAlert('⚠️ Önce GitHub token kaydedin!', 'error');
                return;
            }
            
            console.log('🔍 GitHub bağlantısı test ediliyor...');
            
            try {
                // GitHub API'ye test isteği gönder
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                console.log('📡 Response status:', response.status);
                
                if (response.ok) {
                    const userData = await response.json();
                    console.log('✅ GitHub kullanıcı bilgisi:', userData.login);
                    showAlert(`✅ GitHub Bağlantı Başarılı!\n\n👤 Kullanıcı: ${userData.login}\n🔑 Token çalışıyor\n\n8D raporlarını paylaşabilirsiniz!`, 'success');
                } else if (response.status === 401) {
                    showAlert('❌ GitHub Token Geçersiz!\n\n🔒 Token doğrulanamadı.\n\n💡 Çözüm:\n1. GitHub\'da yeni token oluşturun\n2. "gist" yetkisini seçin\n3. Token\'ı kopyalayıp buraya kaydedin', 'error');
                } else {
                    const errorText = await response.text();
                    showAlert(`❌ GitHub Bağlantı Hatası!\n\nHTTP ${response.status}\n\n${errorText}`, 'error');
                }
            } catch (error) {
                console.error('❌ GitHub test exception:', error);
                showAlert('❌ Bağlantı Hatası!\n\n' + error.message + '\n\nİnternet bağlantınızı kontrol edin.', 'error');
            }
        }
        
        // GitHub token al
        function getGitHubToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('ghtoken');
            if (urlToken) {
                try {
                    return atob(urlToken);
                } catch (e) {
                    console.error('❌ URL\'deki GitHub token decode edilemedi:', e);
                }
            }
            return localStorage.getItem('github_token') || '';
        }
        
        // ==================== STORJ DCS FONKSİYONLARI ====================
        
        // Storj ayarlarını kaydet
        // Storj ayarlarını input alanlarına yükle
        function loadStorjSettings() {
            const settings = getStorjSettings();
            if (settings) {
                const accessKeyInput = document.getElementById('storjAccessKey');
                const secretKeyInput = document.getElementById('storjSecretKey');
                const bucketInput = document.getElementById('storjBucket');
                const endpointInput = document.getElementById('storjEndpoint');
                
                if (accessKeyInput) accessKeyInput.value = settings.accessKey || '';
                if (secretKeyInput) secretKeyInput.value = settings.secretKey || '';
                if (bucketInput) bucketInput.value = settings.bucket || '';
                if (endpointInput) endpointInput.value = settings.endpoint || 'gateway.storjshare.io';
                
                console.log('✅ Storj ayarları yüklendi');
                console.log('📦 Bucket:', settings.bucket);
                console.log('🔗 Endpoint:', settings.endpoint);
            }
        }
        
        function saveStorjSettings() {
            const accessKey = document.getElementById('storjAccessKey').value.trim();
            const secretKey = document.getElementById('storjSecretKey').value.trim();
            const bucket = document.getElementById('storjBucket').value.trim();
            const endpoint = document.getElementById('storjEndpoint').value.trim() || 'gateway.storjshare.io';
            
            if (!accessKey || !secretKey || !bucket) {
                showAlert('⚠️ Lütfen tüm alanları doldurun!\n\nAccess Key, Secret Key ve Bucket adı gereklidir.', 'error');
                return;
            }
            
            const storjSettings = { accessKey, secretKey, bucket, endpoint };
            localStorage.setItem('storj_settings', JSON.stringify(storjSettings));
            
            console.log('✅ Storj ayarları kaydedildi');
            console.log('📦 Bucket:', bucket);
            console.log('🔗 Endpoint:', endpoint);
            
            showAlert('✅ Storj DCS ayarları kaydedildi!\n\n📦 Bucket: ' + bucket + '\n🔗 Endpoint: ' + endpoint + '\n\nŞimdi "Test Et" butonuna tıklayarak bağlantıyı kontrol edin.', 'success');
        }
        
        // Storj ayarlarını al
        function getStorjSettings() {
            const stored = localStorage.getItem('storj_settings');
            if (!stored) return null;
            
            try {
                return JSON.parse(stored);
            } catch (e) {
                console.error('❌ Storj ayarları parse edilemedi:', e);
                return null;
            }
        }
        
        // Storj bağlantı testi
        async function testStorjConnection() {
            const settings = getStorjSettings();
            
            if (!settings) {
                showAlert('⚠️ Önce Storj ayarlarını kaydedin!', 'error');
                return;
            }
            
            console.log('🔍 Storj bağlantısı test ediliyor...');
            
            try {
                // S3 LIST buckets çağrısı - bucket'ın var olup olmadığını kontrol et
                const url = `https://${settings.endpoint}/${settings.bucket}/`;
                const date = new Date().toUTCString();
                
                // Basit bir HEAD request ile bucket erişimini test et
                const response = await fetch(url, {
                    method: 'HEAD',
                    headers: {
                        'Date': date
                    }
                });
                
                console.log('📡 Response status:', response.status);
                
                if (response.ok || response.status === 403) {
                    // 200 = erişilebilir, 403 = bucket var ama public değil (normal)
                    showAlert(`✅ Storj DCS Bağlantı Başarılı!\n\n📦 Bucket: ${settings.bucket}\n🔗 Endpoint: ${settings.endpoint}\n\n8D raporlarını paylaşabilirsiniz!`, 'success');
                } else if (response.status === 404) {
                    showAlert(`⚠️ Bucket Bulunamadı!\n\n📦 Bucket adı: ${settings.bucket}\n\n💡 Çözüm:\n1. Storj Dashboard'da bucket'ın varlığını kontrol edin\n2. Bucket adını doğru yazdığınızdan emin olun`, 'error');
                } else {
                    showAlert(`❌ Storj Bağlantı Hatası!\n\nHTTP ${response.status}\n\nLütfen ayarlarınızı kontrol edin.`, 'error');
                }
            } catch (error) {
                console.error('❌ Storj test exception:', error);
                showAlert('❌ Bağlantı Hatası!\n\n' + error.message + '\n\n🔍 Kontrol edin:\n1. İnternet bağlantınız aktif mi?\n2. Endpoint doğru mu? (gateway.storjshare.io)\n3. Access Key ve Secret Key doğru mu?', 'error');
            }
        }
        
        // AWS Signature V4 oluştur (Storj S3-compatible için)
        async function createAwsSignature(method, path, payload, settings, queryString = '') {
            const timestamp = new Date().toISOString().replace(/[:-]|\.\d{3}/g, '');
            const date = timestamp.substr(0, 8);
            const region = 'us-east-1'; // Storj için sabit
            const service = 's3';
            
            // Canonical request oluştur
            const canonicalUri = path;
            const canonicalQuerystring = queryString;
            const canonicalHeaders = `host:${settings.endpoint}\nx-amz-content-sha256:UNSIGNED-PAYLOAD\nx-amz-date:${timestamp}\n`;
            const signedHeaders = 'host;x-amz-content-sha256;x-amz-date';
            const payloadHash = 'UNSIGNED-PAYLOAD';
            
            const canonicalRequest = `${method}\n${canonicalUri}\n${canonicalQuerystring}\n${canonicalHeaders}\n${signedHeaders}\n${payloadHash}`;
            
            // Debug logging (geliştirme için)
            if (queryString) {
                console.log('🔐 AWS Signature Debug:');
                console.log('  Method:', method);
                console.log('  Path:', path);
                console.log('  Query:', queryString);
                console.log('  Canonical Request:', canonicalRequest.substring(0, 200));
            }
            
            // String to sign
            const credentialScope = `${date}/${region}/${service}/aws4_request`;
            const canonicalRequestHash = await sha256(canonicalRequest);
            const stringToSign = `AWS4-HMAC-SHA256\n${timestamp}\n${credentialScope}\n${canonicalRequestHash}`;
            
            // Signing key oluştur
            const kDate = await hmacSha256('AWS4' + settings.secretKey, date);
            const kRegion = await hmacSha256(kDate, region);
            const kService = await hmacSha256(kRegion, service);
            const kSigning = await hmacSha256(kService, 'aws4_request');
            
            // Signature hesapla
            const signature = await hmacSha256Hex(kSigning, stringToSign);
            
            // Authorization header
            const authHeader = `AWS4-HMAC-SHA256 Credential=${settings.accessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;
            
            return {
                authorization: authHeader,
                date: timestamp
            };
        }
        
        // SHA256 hash (hex)
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // HMAC-SHA256
        async function hmacSha256(key, data) {
            const keyBuffer = typeof key === 'string' ? new TextEncoder().encode(key) : key;
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBuffer,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            const signature = await crypto.subtle.sign('HMAC', cryptoKey, new TextEncoder().encode(data));
            return new Uint8Array(signature);
        }
        
        // HMAC-SHA256 hex output
        async function hmacSha256Hex(key, data) {
            const signature = await hmacSha256(key, data);
            return Array.from(signature).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Storj'a dosya yükle (S3 PUT)
        async function uploadToStorj(key, data, settings) {
            const url = `https://${settings.endpoint}/${settings.bucket}/${key}`;
            const method = 'PUT';
            const path = `/${settings.bucket}/${key}`;
            
            const auth = await createAwsSignature(method, path, data, settings);
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'x-amz-content-sha256': 'UNSIGNED-PAYLOAD',
                    'x-amz-date': auth.date,
                    'Authorization': auth.authorization
                },
                body: data
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Storj upload hatası: ${response.status} - ${errorText}`);
            }
            
            return { success: true, url: url };
        }
        
        // Storj'dan dosya indir (S3 GET)
        async function downloadFromStorj(key, settings) {
            const url = `https://${settings.endpoint}/${settings.bucket}/${key}`;
            const method = 'GET';
            const path = `/${settings.bucket}/${key}`;
            
            const auth = await createAwsSignature(method, path, '', settings);
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'x-amz-content-sha256': 'UNSIGNED-PAYLOAD',
                    'x-amz-date': auth.date,
                    'Authorization': auth.authorization
                }
            });
            
            if (!response.ok) {
                throw new Error(`Storj download hatası: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // Storj'daki BACKUP_ dosyalarını listele (S3 ListObjectsV2)
        async function listStorjBackups(settings) {
            const url = `https://${settings.endpoint}/${settings.bucket}?list-type=2&prefix=BACKUP_`;
            const method = 'GET';
            const path = `/${settings.bucket}`; // Trailing slash KALDIRILDI (S3 spec)
            const queryString = 'list-type=2&prefix=BACKUP_';
            
            const auth = await createAwsSignature(method, path, '', settings, queryString);
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'x-amz-content-sha256': 'UNSIGNED-PAYLOAD',
                    'x-amz-date': auth.date,
                    'Authorization': auth.authorization
                }
            });
            
            if (!response.ok) {
                throw new Error(`Storj list hatası: ${response.status}`);
            }
            
            const xmlText = await response.text();
            
            // XML parse et
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const contents = xmlDoc.getElementsByTagName('Contents');
            const backups = [];
            
            for (let i = 0; i < contents.length; i++) {
                const content = contents[i];
                const key = content.getElementsByTagName('Key')[0]?.textContent || '';
                const size = parseInt(content.getElementsByTagName('Size')[0]?.textContent || '0');
                const lastModified = content.getElementsByTagName('LastModified')[0]?.textContent || '';
                
                backups.push({
                    key: key,
                    size: size,
                    sizeText: (size / (1024 * 1024)).toFixed(2) + ' MB',
                    lastModified: new Date(lastModified),
                    lastModifiedText: new Date(lastModified).toLocaleString('tr-TR')
                });
            }
            
            // Tarihe göre sırala (en yeni önce)
            backups.sort((a, b) => b.lastModified - a.lastModified);
            
            return backups;
        }
        
        // Storj'dan dosya sil (S3 DELETE)
        async function deleteStorjBackup(key, settings) {
            const url = `https://${settings.endpoint}/${settings.bucket}/${key}`;
            const method = 'DELETE';
            const path = `/${settings.bucket}/${key}`;
            
            const auth = await createAwsSignature(method, path, '', settings);
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'x-amz-content-sha256': 'UNSIGNED-PAYLOAD',
                    'x-amz-date': auth.date,
                    'Authorization': auth.authorization
                }
            });
            
            if (!response.ok) {
                throw new Error(`Storj delete hatası: ${response.status}`);
            }
            
            return { success: true };
        }
        
        // Blob'u base64'e çevir (helper fonksiyon)
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // Base64'ü blob'a çevir (helper fonksiyon)
        function base64ToBlob(base64) {
            try {
                // Data URL formatını parse et (data:image/png;base64,...)
                const arr = base64.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            } catch (err) {
                console.error('Base64 to Blob dönüştürme hatası:', err);
                return null;
            }
        }
        
        // Veritabanını Storj'a yükle (Ekip senkronizasyonu için)
        async function uploadDatabaseToStorj() {
            if (!db) {
                showAlert('❌ Veritabanı hazır değil!', 'error');
                return;
            }
            
            const settings = getStorjSettings();
            if (!settings) {
                showAlert('⚠️ Önce Storj ayarlarını yapın!', 'error');
                return;
            }
            
            try {
                showAlert('📦 Veritabanı hazırlanıyor...', 'info');
                
                // Tüm verileri topla
                const exportData = {
                    exportedAt: new Date().toISOString(),
                    version: db.version,
                    stores: {}
                };
                
                // 1. ÖNCE allResults'tan suppliers al (aktif veriler - Excel'den yüklenmiş olabilir)
                if (allResults && allResults.length > 0) {
                    // allResults'ı localStorage'a da kaydet (güvenlik için)
                    localStorage.setItem('selectedSuppliers', JSON.stringify(allResults));
                    exportData.stores['suppliers'] = allResults;
                    console.log(`✅ suppliers (allResults): ${allResults.length} kayıt`);
                } else {
                    // 2. allResults yoksa localStorage'dan al
                    const suppliersData = localStorage.getItem('selectedSuppliers');
                    if (suppliersData) {
                        try {
                            const suppliers = JSON.parse(suppliersData);
                            if (suppliers && suppliers.length > 0) {
                                exportData.stores['suppliers'] = suppliers;
                                console.log(`✅ suppliers (localStorage): ${suppliers.length} kayıt`);
                            } else {
                                showAlert('❌ Yedeklenecek tedarikçi verisi yok!\n\n💡 Önce Excel dosyanızı yükleyin, sonra yedek oluşturun.', 'error');
                                return;
                            }
                        } catch (e) {
                            console.error('Suppliers verisi parse edilemedi:', e);
                            showAlert('❌ Supplier verisi okunamadı!\n\n💡 Lütfen Excel dosyanızı tekrar yükleyin.', 'error');
                            return;
                        }
                    } else {
                        showAlert('❌ Yedeklenecek tedarikçi verisi yok!\n\n💡 Önce Excel dosyanızı yükleyin, sonra yedek oluşturun.', 'error');
                        return;
                    }
                }
                
                // 2. IndexedDB'den diğer store'ları oku
                const storeNames = [
                    'supplierHistory',    // savedVersions
                    'supplierLocations',  // locations
                    'supplierDocuments',  // documents
                    'report8D',           // 8d-reports
                    'supplier8DCounts'    // 8D sayıları
                ];
                
                for (const storeName of storeNames) {
                    const tx = db.transaction([storeName], 'readonly');
                    const store = tx.objectStore(storeName);
                    const allData = await new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    // supplierDocuments için blob'ları base64'e çevir
                    if (storeName === 'supplierDocuments') {
                        for (const docRecord of allData) {
                            if (docRecord.documents) {
                                for (const docType in docRecord.documents) {
                                    for (const file of docRecord.documents[docType]) {
                                        if (file.blob && typeof file.blob !== 'string') {
                                            // Blob'u base64'e çevir
                                            try {
                                                const base64 = await blobToBase64(file.blob);
                                                file.data = base64;
                                                delete file.blob; // Blob'u sil, data kullan
                                            } catch (err) {
                                                console.error(`Blob dönüştürme hatası (${file.name}):`, err);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        console.log(`✅ ${storeName}: ${allData.length} kayıt (blob'lar base64'e çevrildi)`);
                    } else {
                        console.log(`✅ ${storeName}: ${allData.length} kayıt`);
                    }
                    
                    exportData.stores[storeName] = allData;
                }
                
                // Storj'a yükle
                const backupKey = `BACKUP_${Date.now()}.json`;
                const jsonData = JSON.stringify(exportData, null, 2);
                const sizeMB = (jsonData.length / (1024 * 1024)).toFixed(2);
                
                console.log(`📤 Yükleniyor: ${backupKey} (${sizeMB} MB)`);
                
                await uploadToStorj(backupKey, jsonData, settings);
                
                // Başarı mesajı ve key'i göster
                const message = `✅ Veritabanı başarıyla yüklendi!
                
📦 Dosya boyutu: ${sizeMB} MB
🔑 Backup Key: ${backupKey}
☁️ Konum: Storj DCS

💡 Bu key'i kaydedin! Başka PC'de indirmek için gerekli.

📋 Key panoya kopyalandı.`;
                
                // Key'i panoya kopyala
                await navigator.clipboard.writeText(backupKey);
                
                showAlert(message, 'success');
                
            } catch (error) {
                console.error('❌ Yükleme hatası:', error);
                showAlert('❌ Yükleme Hatası!\n\n' + error.message, 'error');
            }
        }
        
        // Storj'dan veritabanını indir ve yükle
        async function downloadDatabaseFromStorj() {
            if (!db) {
                showAlert('❌ Veritabanı hazır değil!', 'error');
                return;
            }
            
            const settings = getStorjSettings();
            if (!settings) {
                showAlert('⚠️ Önce Storj ayarlarını yapın!', 'error');
                return;
            }
            
            // Backup key'i sor
            const backupKey = prompt('📥 Storj Backup Key\'ini girin:\n\n(Örnek: BACKUP_1234567890.json)\n\n💡 Key\'iniz yoksa "Yedekleri Görüntüle" butonuna tıklayın!');
            if (!backupKey) return;
            
            try {
                showAlert('📥 Veritabanı indiriliyor...', 'info');
                
                // Storj'dan indir
                const importData = await downloadFromStorj(backupKey, settings);
                
                console.log('✅ Veri indirildi');
                console.log('📊 Store sayısı:', Object.keys(importData.stores || {}).length);
                console.log('📅 Export tarihi:', importData.exportedAt);
                
                // Onay iste
                const storeSummary = Object.entries(importData.stores || {})
                    .map(([name, data]) => `• ${name}: ${data.length} kayıt`)
                    .join('\n');
                
                // Suppliers kontrolü
                const suppliersCount = (importData.stores['suppliers'] || []).length;
                if (suppliersCount === 0) {
                    showAlert('⚠️ Bu yedekte tedarikçi verisi yok!\n\nBu yedek muhtemelen boş bir veritabanından alınmış.\n\n💡 Çözüm: Excel dosyanızı yükleyin ve yeni bir yedek oluşturun.', 'error');
                    return;
                }
                
                const confirmMessage = `⚠️ MEVCUT VERİLERİN ÜZERİNE YAZILACAK!

İndirilen veri:
${storeSummary}

Export tarihi: ${new Date(importData.exportedAt).toLocaleString('tr-TR')}

Devam etmek istiyor musunuz?`;
                
                if (!confirm(confirmMessage)) {
                    showAlert('İşlem iptal edildi.', 'info');
                    return;
                }
                
                showAlert('💾 Veritabanına yazılıyor...', 'info');
                
                // Tüm verileri yükle
                let suppliersLoaded = false;
                
                for (const [storeName, data] of Object.entries(importData.stores || {})) {
                    // suppliers verisi localStorage'a VE allResults'a yazılır
                    if (storeName === 'suppliers') {
                        localStorage.setItem('selectedSuppliers', JSON.stringify(data));
                        allResults = data; // Direkt allResults'a da yaz
                        suppliersLoaded = true;
                        console.log(`✅ suppliers: ${data.length} kayıt yüklendi (localStorage + allResults)`);
                        continue;
                    }
                    
                    // Diğer store'lar IndexedDB'ye yazılır
                    const tx = db.transaction([storeName], 'readwrite');
                    const store = tx.objectStore(storeName);
                    
                    // Store'u temizle
                    await new Promise((resolve, reject) => {
                        const clearRequest = store.clear();
                        clearRequest.onsuccess = resolve;
                        clearRequest.onerror = () => reject(clearRequest.error);
                    });
                    
                    // supplierDocuments için base64'ü blob'a çevir
                    if (storeName === 'supplierDocuments') {
                        let convertedCount = 0;
                        let failedCount = 0;
                        for (const docRecord of data) {
                            if (docRecord.documents) {
                                for (const docType in docRecord.documents) {
                                    for (const file of docRecord.documents[docType]) {
                                        // Eğer data varsa (base64 string) bunu blob'a çevir
                                        if (file.data && typeof file.data === 'string' && !file.blob) {
                                            try {
                                                const blob = base64ToBlob(file.data);
                                                if (blob) {
                                                    file.blob = blob;
                                                    convertedCount++;
                                                    console.log(`✅ ${file.name}: Blob oluşturuldu (${blob.size} bytes, type: ${blob.type})`);
                                                } else {
                                                    failedCount++;
                                                    console.error(`❌ ${file.name}: Blob null döndü`);
                                                }
                                            } catch (err) {
                                                failedCount++;
                                                console.error(`❌ ${file.name}: Dönüştürme hatası:`, err);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        console.log(`✅ ${storeName}: ${data.length} kayıt yüklendi (${convertedCount} dosya dönüştürüldü, ${failedCount} hata)`);
                    } else {
                        console.log(`✅ ${storeName}: ${data.length} kayıt yüklendi`);
                    }
                    
                    // Verileri ekle
                    for (const item of data) {
                        await new Promise((resolve, reject) => {
                            const addRequest = store.add(item);
                            addRequest.onsuccess = resolve;
                            addRequest.onerror = () => reject(addRequest.error);
                        });
                    }
                }
                
                // Eğer suppliers yüklendiyse, tabloyu render et
                if (suppliersLoaded && allResults && allResults.length > 0) {
                    console.log('🔄 Tabloya yükleniyor...');
                    
                    // PPM ve puanları yeniden hesapla
                    allResults.forEach(supplier => {
                        if (supplier.ppmTarget) {
                            savePPMTargetToStorage(supplier.name, supplier.ppmTarget);
                        }
                        if (supplier.hataHedefi !== undefined) {
                            saveHataHedefiToStorage(supplier.name, supplier.hataHedefi);
                        }
                        
                        const totalSevk = supplier.totalSevk || 0;
                        const totalIade = supplier.totalIade || 0;
                        
                        if (totalSevk > 0) {
                            const calculatedPpm = (totalIade / totalSevk) * 1000000;
                            supplier.currentPPM = calculatedPpm;
                            supplier.ppm = calculatedPpm;
                        }
                        
                        const targetPpm = supplier.ppmTarget || 1000;
                        const monthlyPpm = supplier.ppm;
                        
                        let ppmPuan = 0;
                        if (monthlyPpm === 0) {
                            ppmPuan = 1;
                        } else if (monthlyPpm <= 0.2 * targetPpm) {
                            ppmPuan = 0.95;
                        } else if (monthlyPpm <= 0.4 * targetPpm) {
                            ppmPuan = 0.9;
                        } else if (monthlyPpm <= 0.6 * targetPpm) {
                            ppmPuan = 0.85;
                        } else if (monthlyPpm <= 0.8 * targetPpm) {
                            ppmPuan = 0.8;
                        } else if (monthlyPpm < 1.2 * targetPpm) {
                            ppmPuan = 0.6;
                        } else {
                            ppmPuan = 0;
                        }
                        supplier.ppmPuan = ppmPuan;
                        
                        recalculateSupplierScore(supplier);
                    });
                    
                    // selectedSuppliers Set'ini güncelle (FİLTRE İÇİN ÖNEMLİ!)
                    selectedSuppliers.clear();
                    allResults.forEach(supplier => {
                        const supplierKey = supplier.mapKey || supplier.name;
                        selectedSuppliers.add(supplierKey);
                    });
                    console.log(`✅ ${selectedSuppliers.size} tedarikçi selectedSuppliers'a eklendi`);
                    
                    // Kontrol panelini aktif et ve tabloyu göster
                    displayResults();
                    
                    // 8D sayılarını güncelle
                    if (typeof load8DCountsFromDB === 'function') {
                        await load8DCountsFromDB();
                    }
                    
                    showAlert(`✅ Veritabanı başarıyla yüklendi!\n\n📦 ${Object.keys(importData.stores).length} store güncellendi\n📊 ${allResults.length} tedarikçi tabloda görüntüleniyor\n📅 Export tarihi: ${new Date(importData.exportedAt).toLocaleString('tr-TR')}`, 'success');
                } else {
                    showAlert(`✅ Veritabanı başarıyla yüklendi!\n\n📦 ${Object.keys(importData.stores).length} store güncellendi\n📅 Export tarihi: ${new Date(importData.exportedAt).toLocaleString('tr-TR')}\n\n🔄 Sayfa yenileniyor...`, 'success');
                    setTimeout(() => location.reload(), 2000);
                }
                
            } catch (error) {
                console.error('❌ İndirme hatası:', error);
                showAlert('❌ İndirme Hatası!\n\n' + error.message + '\n\n🔍 Key doğru mu kontrol edin.', 'error');
            }
        }
        
        // Storj yedeklerini listele ve göster
        async function showStorjBackupsList() {
            const settings = getStorjSettings();
            if (!settings) {
                showAlert('⚠️ Önce Storj ayarlarını yapın!', 'error');
                return;
            }
            
            try {
                showAlert('🔍 Storj\'daki yedekler listeleniyor...', 'info');
                
                const backups = await listStorjBackups(settings);
                
                if (backups.length === 0) {
                    showAlert('📭 Storj\'da hiç yedek bulunamadı!\n\nİlk yedeğinizi "Veritabanını Yükle" butonu ile oluşturabilirsiniz.', 'info');
                    return;
                }
                
                // Modal oluştur
                const modal = document.createElement('div');
                modal.id = 'storjBackupsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    max-width: 480px;
                    width: 94%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                `;
                
                // Başlık
                const header = document.createElement('div');
                header.style.cssText = `
                    background: linear-gradient(135deg, #4CAF50, #2e7d32);
                    color: white;
                    padding: 10px 14px;
                    border-radius: 8px 8px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                header.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.1em;">☁️</span>
                        <div>
                            <div style="font-weight: 600; font-size: 1em;">Storj Yedekleri</div>
                            <div style="font-size: 0.75em; opacity: 0.9;">${backups.length} yedek bulundu</div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('storjBackupsModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.3em; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                `;
                
                // İçerik - kart listesi
                const content = document.createElement('div');
                content.style.cssText = 'padding: 10px;';
                
                let cardsHTML = '';
                backups.forEach((backup, index) => {
                    cardsHTML += `
                        <div style="background: ${index % 2 === 0 ? '#fff' : '#f9f9f9'}; border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 0.88em; color: #333; font-weight: 500;">📅 ${backup.lastModifiedText}</span>
                                <span style="font-size: 0.82em; color: #666;">📦 ${backup.sizeText}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <code style="background: #e8f5e9; padding: 3px 6px; border-radius: 3px; font-size: 0.7em; color: #2e7d32; word-break: break-all; display: block; line-height: 1.3;">🔑 ${backup.key}</code>
                            </div>
                            <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                <button onclick="loadBackupFromList('${backup.key}')" style="background: #2196F3; color: white; border: none; padding: 5px 14px; border-radius: 4px; cursor: pointer; font-size: 0.82em; font-weight: 600;">📥 Yükle</button>
                                <button onclick="deleteBackupFromList('${backup.key}')" style="background: #f44336; color: white; border: none; padding: 5px 14px; border-radius: 4px; cursor: pointer; font-size: 0.82em; font-weight: 600;">🗑️ Sil</button>
                            </div>
                        </div>
                    `;
                });
                content.innerHTML = cardsHTML;
                
                // Bilgi notu
                const info = document.createElement('div');
                info.style.cssText = `
                    margin: 0 10px 10px 10px;
                    padding: 8px 10px;
                    background: #e3f2fd;
                    border-left: 3px solid #2196F3;
                    border-radius: 3px;
                    font-size: 0.78em;
                    color: #1565c0;
                    line-height: 1.3;
                `;
                info.innerHTML = `<strong>💡 Backup Key:</strong> Benzersiz anahtar ile başka PC'de aynı yedeği indirebilir ve paylaşabilirsiniz`;
                
                modalContent.appendChild(header);
                modalContent.appendChild(content);
                modalContent.appendChild(info);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Modal dışına tıklanınca kapansın
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('❌ Liste hatası:', error);
                showAlert('❌ Yedek Listesi Alınamadı!\n\n' + error.message, 'error');
            }
        }
        
        // Listeden backup yükle
        async function loadBackupFromList(key) {
            const settings = getStorjSettings();
            if (!settings) return;
            
            if (!confirm(`📥 Bu yedeği yüklemek istiyor musunuz?\n\n🔑 ${key}\n\n⚠️ MEVCUT VERİLERİN ÜZERİNE YAZILACAK!`)) {
                return;
            }
            
            try {
                showAlert('📥 Veritabanı indiriliyor...', 'info');
                
                const importData = await downloadFromStorj(key, settings);
                
                // Onay iste
                const storeSummary = Object.entries(importData.stores || {})
                    .map(([name, data]) => `• ${name}: ${data.length} kayıt`)
                    .join('\n');
                
                // Suppliers kontrolü
                const suppliersCount = (importData.stores['suppliers'] || []).length;
                if (suppliersCount === 0) {
                    showAlert('⚠️ Bu yedekte tedarikçi verisi yok!\n\nBu yedek muhtemelen boş bir veritabanından alınmış.\n\n💡 Çözüm: Excel dosyanızı yükleyin ve yeni bir yedek oluşturun.', 'error');
                    return;
                }
                
                const confirmMessage = `✅ Veri indirildi!\n\n${storeSummary}\n\nExport tarihi: ${new Date(importData.exportedAt).toLocaleString('tr-TR')}\n\nDevam etmek istiyor musunuz?`;
                
                if (!confirm(confirmMessage)) {
                    localStorage.removeItem('skipAutoModal'); // İptal edince flag'i temizle
                    showAlert('İşlem iptal edildi.', 'info');
                    return;
                }
                
                showAlert('💾 Veritabanına yazılıyor...', 'info');
                
                // Tüm verileri yükle
                let suppliersLoaded = false;
                
                for (const [storeName, data] of Object.entries(importData.stores || {})) {
                    // suppliers verisi localStorage'a VE allResults'a yazılır
                    if (storeName === 'suppliers') {
                        localStorage.setItem('selectedSuppliers', JSON.stringify(data));
                        allResults = data; // Direkt allResults'a da yaz
                        suppliersLoaded = true;
                        console.log(`✅ suppliers: ${data.length} kayıt yüklendi (localStorage + allResults)`);
                        continue;
                    }
                    
                    // Diğer store'lar IndexedDB'ye yazılır
                    const tx = db.transaction([storeName], 'readwrite');
                    const store = tx.objectStore(storeName);
                    
                    // Store'u temizle
                    await new Promise((resolve, reject) => {
                        const clearRequest = store.clear();
                        clearRequest.onsuccess = resolve;
                        clearRequest.onerror = () => reject(clearRequest.error);
                    });
                    
                    // supplierDocuments için base64'ü blob'a çevir
                    if (storeName === 'supplierDocuments') {
                        for (const docRecord of data) {
                            if (docRecord.documents) {
                                for (const docType in docRecord.documents) {
                                    for (const file of docRecord.documents[docType]) {
                                        // Eğer data varsa (base64 string) bunu blob'a çevir
                                        if (file.data && typeof file.data === 'string' && !file.blob) {
                                            try {
                                                const blob = base64ToBlob(file.data);
                                                if (blob) {
                                                    file.blob = blob;
                                                }
                                            } catch (err) {
                                                console.error(`Base64 to Blob dönüştürme hatası (${file.name}):`, err);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        console.log(`✅ ${storeName}: ${data.length} kayıt yüklendi (base64'ler blob'a çevrildi)`);
                    } else {
                        console.log(`✅ ${storeName}: ${data.length} kayıt yüklendi`);
                    }
                    
                    // Verileri ekle
                    for (const item of data) {
                        await new Promise((resolve, reject) => {
                            const addRequest = store.add(item);
                            addRequest.onsuccess = resolve;
                            addRequest.onerror = () => reject(addRequest.error);
                        });
                    }
                }
                
                // Modalı kapat
                document.getElementById('storjBackupsModal')?.remove();
                document.getElementById('customAlertModal')?.remove();
                
                // Eğer suppliers yüklendiyse, tabloyu render et ve verilerle çalış
                if (suppliersLoaded && allResults && allResults.length > 0) {
                    console.log('🔄 Tabloya yükleniyor...', allResults.length, 'tedarikçi');
                    
                    // PPM ve puanları yeniden hesapla
                    allResults.forEach(supplier => {
                        if (supplier.ppmTarget) {
                            savePPMTargetToStorage(supplier.name, supplier.ppmTarget);
                        }
                        if (supplier.hataHedefi !== undefined) {
                            saveHataHedefiToStorage(supplier.name, supplier.hataHedefi);
                        }
                        
                        // PPM değerini yeniden hesapla
                        const totalSevk = supplier.totalSevk || 0;
                        const totalIade = supplier.totalIade || 0;
                        
                        if (totalSevk > 0) {
                            const calculatedPpm = (totalIade / totalSevk) * 1000000;
                            supplier.currentPPM = calculatedPpm;
                            supplier.ppm = calculatedPpm;
                        }
                        
                        // PPM puanını yeniden hesapla
                        const targetPpm = supplier.ppmTarget || 1000;
                        const monthlyPpm = supplier.ppm;
                        
                        let ppmPuan = 0;
                        if (monthlyPpm === 0) {
                            ppmPuan = 1;
                        } else if (monthlyPpm <= 0.2 * targetPpm) {
                            ppmPuan = 0.95;
                        } else if (monthlyPpm <= 0.4 * targetPpm) {
                            ppmPuan = 0.9;
                        } else if (monthlyPpm <= 0.6 * targetPpm) {
                            ppmPuan = 0.85;
                        } else if (monthlyPpm <= 0.8 * targetPpm) {
                            ppmPuan = 0.8;
                        } else if (monthlyPpm < 1.2 * targetPpm) {
                            ppmPuan = 0.6;
                        } else {
                            ppmPuan = 0;
                        }
                        supplier.ppmPuan = ppmPuan;
                        
                        // Tedarikçi puanı ve sınıfını yeniden hesapla
                        recalculateSupplierScore(supplier);
                    });
                    
                    console.log('🎨 Tablo render ediliyor...');
                    
                    // selectedSuppliers Set'ini güncelle (FİLTRE İÇİN ÖNEMLİ!)
                    selectedSuppliers.clear();
                    allResults.forEach(supplier => {
                        const supplierKey = supplier.mapKey || supplier.name;
                        selectedSuppliers.add(supplierKey);
                    });
                    console.log(`✅ ${selectedSuppliers.size} tedarikçi selectedSuppliers'a eklendi`);
                    
                    // Kontrol panelini aktif et
                    displayResults();
                    
                    // 8D sayılarını güncelle
                    if (typeof load8DCountsFromDB === 'function') {
                        await load8DCountsFromDB();
                    }
                    
                    showAlert(`✅ Veritabanı başarıyla yüklendi!\n\n📊 ${allResults.length} tedarikçi tabloda görüntüleniyor`, 'success');
                } else {
                    console.log('⚠️ Suppliers yüklenmedi veya boş, reload gerekiyor');
                    // Suppliers yüklenmediyse veya boşsa, sayfa reload gerekiyor
                    showAlert(`✅ Veritabanı başarıyla yüklendi!\n\n🔄 Sayfa yenileniyor...`, 'success');
                    setTimeout(() => location.reload(), 1500);
                }
                
            } catch (error) {
                console.error('❌ Yükleme hatası:', error);
                showAlert('❌ Yükleme Hatası!\n\n' + error.message, 'error');
            }
        }
        
        // Listeden backup sil
        async function deleteBackupFromList(key) {
            const settings = getStorjSettings();
            if (!settings) return;
            
            if (!confirm(`🗑️ Bu yedeği silmek istiyor musunuz?\n\n🔑 ${key}\n\n⚠️ BU İŞLEM GERİ ALINAMAZ!`)) {
                return;
            }
            
            try {
                showAlert('🗑️ Yedek siliniyor...', 'info');
                
                await deleteStorjBackup(key, settings);
                
                showAlert('✅ Yedek başarıyla silindi!', 'success');
                
                // Storj bölümünü güncelle (modalı yeniden açmadan)
                const storjSection = document.getElementById('storjBackupsSection');
                if (storjSection) {
                    storjSection.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #2e7d32;">
                            <div style="font-size: 1.2em; margin-bottom: 10px;">🔄 Liste güncelleniyor...</div>
                        </div>
                    `;
                    
                    // Listeyi yeniden yükle
                    const backups = await listStorjBackups(settings);
                    
                    let storjHTML = '';
                    if (backups.length === 0) {
                        storjHTML = `
                            <div style="text-align: center; padding: 30px 20px; color: #666; background: white; border-radius: 8px;">
                                <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                                <div style="font-size: 1em; margin-bottom: 5px; color: #2e7d32;">Storj'da yedek yok</div>
                                <div style="font-size: 0.85em; color: #666;">Ayarlar > Storj DCS > "Veritabanını Yükle" ile yedek oluşturun</div>
                            </div>
                        `;
                    } else {
                        backups.forEach((backup, index) => {
                            const rowStyle = index % 2 === 0 ? 'background: white;' : 'background: #f1f8f4;';
                            storjHTML += `
                                <div style="padding: 12px; margin: 8px 0; ${rowStyle} border-radius: 8px; border: 1px solid #c8e6c9;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #2e7d32; font-size: 1.05em;">☁️ ${backup.lastModifiedText}</div>
                                            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">Boyut: ${backup.sizeText}</div>
                                            <div style="font-size: 0.75em; color: #999; margin-top: 2px; word-break: break-all;">
                                                <code style="background: #e8f5e9; padding: 2px 6px; border-radius: 3px;">${backup.key}</code>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                            <button class="btn" style="padding: 6px 12px; font-size: 0.9em; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="loadBackupFromList('${backup.key}')">
                                                📥 Yükle
                                            </button>
                                            <button class="btn" style="padding: 6px 12px; font-size: 0.9em; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="deleteBackupFromList('${backup.key}')">
                                                🗑️ Sil
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    storjSection.innerHTML = storjHTML;
                }
                
            } catch (error) {
                console.error('❌ Silme hatası:', error);
                showAlert('❌ Silme Hatası!\n\n' + error.message, 'error');
            }
        }
        
        // Seçili servise göre maksimum dosya boyutunu döndür
        function getMaxFileSizeForService() {
            const service = get8DShareService();
            
            const limits = {
                'jsonbin': {
                    bytes: 100 * 1024, // 100 KB
                    text: '100 KB',
                    name: 'JSONBin'
                },
                'pantry': {
                    bytes: 1.44 * 1024 * 1024, // 1.44 MB
                    text: '1.44 MB',
                    name: 'Pantry'
                },
                'gist': {
                    bytes: 1 * 1024 * 1024, // 1 MB
                    text: '1 MB',
                    name: 'GitHub Gists'
                },
                'storj': {
                    bytes: 100 * 1024 * 1024, // 100 MB (Storj DCS büyük dosyaları destekler)
                    text: '100 MB',
                    name: 'Storj DCS'
                }
            };
            
            return limits[service] || limits['pantry']; // Varsayılan: Pantry
        }
        
        // Pantry bağlantı testi
        async function testPantryConnection() {
            try {
                console.log('🧪 Pantry bağlantı testi başlıyor...');
                
                // Kaydedilmiş Pantry ID'yi al
                const pantryId = getPantryId();
                if (!pantryId) {
                    showAlert('⚠️ Önce Pantry ID kaydedin!', 'error');
                    return;
                }
                
                console.log('🔑 Pantry ID kullanılıyor:', pantryId.substring(0, 20) + '...');
                
                const testData = {
                    test: true,
                    message: 'Pantry connection test',
                    timestamp: new Date().toISOString()
                };
                
                // Test verisi yaz
                console.log('📤 Test verisi gönderiliyor...');
                const writeResponse = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (!writeResponse.ok) {
                    throw new Error(`Pantry write error: ${writeResponse.status}`);
                }
                
                console.log('✅ Test verisi yazıldı');
                
                // Test verisini oku
                console.log('📥 Test verisi okunuyor...');
                const readResponse = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/test`);
                
                if (!readResponse.ok) {
                    throw new Error(`Pantry read error: ${readResponse.status}`);
                }
                
                const readResult = await readResponse.json();
                console.log('✅ Test verisi okundu:', readResult);
                
                // Veriyi karşılaştır
                if (readResult.test === true && readResult.message === testData.message) {
                    console.log('✅ Veri doğrulaması başarılı!');
                    
                    showAlert('✅ Pantry Bağlantı Başarılı!\n\n📡 Yazma: OK\n📥 Okuma: OK\n🔄 Veri doğrulama: OK\n\n🚀 8D raporlarını paylaşmaya hazırsınız!\n\n💡 Not: API key gerekmez, limitsiz kullanım!', 'success');
                } else {
                    throw new Error('Veri doğrulama başarısız!');
                }
                
            } catch (error) {
                console.error('❌ Pantry test exception:', error);
                showAlert('❌ Pantry Bağlantı Hatası!\n\n' + error.message + '\n\n🔍 Kontrol edin:\n1. İnternet bağlantınız aktif mi?\n2. Pantry servisi çalışıyor mu?\n\n💡 Alternatif: JSONBin.io kullanabilirsiniz.', 'error');
            }
        }

        // 8D Raporu Paylaşma
        async function share8DReport() {
            // Seçili servisi kontrol et
            const selectedService = get8DShareService();
            
            if (selectedService === 'pantry') {
                return await share8DReportWithPantry();
            } else if (selectedService === 'gist') {
                return await share8DReportWithGist();
            } else if (selectedService === 'storj') {
                return await share8DReportWithStorj();
            } else {
                return await share8DReportWithJsonBin();
            }
        }
        
        // Pantry ile paylaş (API key yok, limitsiz)
        async function share8DReportWithPantry() {
            if (!current8DData || !current8DData.id) {
                showAlert('⚠️ Önce raporu kaydedin!', 'error');
                return;
            }
            
            console.log('🟢 Pantry ile paylaşım başlıyor...');
            console.log('🆔 Report ID:', current8DData.id);
            console.log('📦 Supplier:', current8DSupplier);
            
            try {
                const shareUrl = await shareWith8DPantry(current8DData, current8DSupplier, current8DMonth);
                
                // Senkronize butonunu göster
                const syncBtn = document.getElementById('sync8DBtn');
                if (syncBtn) {
                    syncBtn.style.display = 'block';
                    console.log('🔄 Senkronize butonu gösterildi');
                }
                
                // Linki kopyala
                await navigator.clipboard.writeText(shareUrl);
                
                // Link göster
                showShareLinkDialog(shareUrl, 'Pantry');
                
            } catch (error) {
                console.error('❌ Pantry paylaşım hatası:', error);
                showAlert('❌ Paylaşım Hatası!\n\n' + error.message, 'error');
            }
        }
        
        // GitHub Gists ile paylaş (100 MB limit)
        async function share8DReportWithGist() {
            if (!current8DData || !current8DData.id) {
                showAlert('⚠️ Önce raporu kaydedin!', 'error');
                return;
            }
            
            const token = getGitHubToken();
            if (!token) {
                showAlert('⚠️ GitHub token ayarlanmamış!\n\nAyarlar menüsünden GitHub token ekleyin.\n\n📝 Token almak için:\n1. github.com/settings/tokens/new adresine gidin\n2. "gist" yetkisini seçin\n3. Token oluşturun ve kaydedin', 'error');
                return;
            }
            
            console.log('🟣 GitHub Gists ile paylaşım başlıyor...');
            console.log('🆔 Report ID:', current8DData.id);
            console.log('📦 Supplier:', current8DSupplier);
            
            try {
                const shareData = {
                    reportId: current8DData.id,
                    supplierName: current8DSupplier,
                    monthIndex: current8DMonth,
                    reportData: current8DData,
                    sharedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };
                
                const fileName = '8d-report.json';
                
                console.log('📤 Gist oluşturuluyor...');
                console.log('📄 Dosya adı:', fileName);
                console.log('📊 Veri boyutu:', JSON.stringify(shareData).length, 'byte');
                
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: `8D Report - ${current8DSupplier} (${current8DMonth})`,
                        public: false,
                        files: {
                            [fileName]: {
                                content: JSON.stringify(shareData, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('❌ Gist oluşturma hatası:', errorData);
                    throw new Error(`GitHub error: ${response.status} - ${errorData.message || 'Unknown error'}`);
                }
                
                const gistData = await response.json();
                const gistId = gistData.id;
                
                console.log('✅ Gist oluşturuldu!');
                console.log('🆔 Gist ID:', gistId);
                console.log('🔗 URL:', gistData.html_url);
                
                // Gist ID'yi raporda sakla
                current8DData.sharedGistId = gistId;
                
                // IndexedDB'ye kaydet
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                store.put(current8DData);
                await new Promise(resolve => tx.oncomplete = resolve);
                
                // Tedarikçi URL'i oluştur
                const encodedToken = btoa(token);
                const shareUrl = `${window.location.origin}${window.location.pathname}?mode=supplier&gist=${gistId}&ghtoken=${encodedToken}`;
                
                // Senkronize butonunu göster
                const syncBtn = document.getElementById('sync8DBtn');
                if (syncBtn) {
                    syncBtn.style.display = 'block';
                    console.log('🔄 Senkronize butonu gösterildi');
                }
                
                // Linki kopyala
                await navigator.clipboard.writeText(shareUrl);
                
                // Link göster
                showShareLinkDialog(shareUrl, 'GitHub Gists');
                
            } catch (error) {
                console.error('❌ GitHub Gists paylaşım hatası:', error);
                showAlert('❌ Paylaşım Hatası!\n\n' + error.message, 'error');
            }
        }
        
        // Storj DCS ile paylaş
        async function share8DReportWithStorj() {
            console.log('🚀 Storj DCS ile paylaşım başlıyor...');
            
            const settings = getStorjSettings();
            if (!settings) {
                showAlert('⚠️ Storj ayarları yapılmamış!\n\nAyarlar menüsünden Storj DCS ayarlarını yapın.\n\n📝 Kurulum:\n1. storj.io\'dan ücretsiz hesap açın\n2. Bucket oluşturun\n3. S3 credentials alın\n4. Ayarları kaydedin', 'error');
                return;
            }
            
            try {
                const shareData = {
                    reportId: current8DData.id || 'new',
                    supplierName: current8DSupplier,
                    monthIndex: current8DMonth,
                    reportData: current8DData,
                    sharedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };
                
                // Unique key oluştur
                const storjKey = `8D_${current8DSupplier}_${current8DMonth}_${Date.now()}.json`.replace(/[^a-zA-Z0-9._-]/g, '_');
                
                console.log('📤 Storj\'a yükleniyor...');
                console.log('🔑 Key:', storjKey);
                console.log('📊 Veri boyutu:', JSON.stringify(shareData).length, 'byte');
                
                // Storj'a yükle
                const result = await uploadToStorj(storjKey, JSON.stringify(shareData, null, 2), settings);
                
                console.log('✅ Storj\'a yüklendi!');
                console.log('🔗 URL:', result.url);
                
                // Storj key'i raporda sakla
                current8DData.sharedStorjKey = storjKey;
                
                // IndexedDB'ye kaydet
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                store.put(current8DData);
                await new Promise(resolve => tx.oncomplete = resolve);
                
                // Tedarikçi URL'i oluştur (credentials'ı encode ederek)
                const encodedCreds = btoa(JSON.stringify({ accessKey: settings.accessKey, secretKey: settings.secretKey, bucket: settings.bucket, endpoint: settings.endpoint, key: storjKey }));
                const shareUrl = `${window.location.origin}${window.location.pathname}?mode=supplier&storj=${encodedCreds}`;
                
                // Senkronize butonunu göster
                const syncBtn = document.getElementById('sync8DBtn');
                if (syncBtn) {
                    syncBtn.style.display = 'block';
                    console.log('🔄 Senkronize butonu gösterildi');
                }
                
                // Linki kopyala
                await navigator.clipboard.writeText(shareUrl);
                
                // Link göster
                showShareLinkDialog(shareUrl, 'Storj DCS');
                
            } catch (error) {
                console.error('❌ Storj paylaşım hatası:', error);
                showAlert('❌ Paylaşım Hatası!\n\n' + error.message + '\n\n🔍 Kontrol edin:\n1. Storj ayarları doğru mu?\n2. Bucket var mı?\n3. Access Key/Secret Key geçerli mi?', 'error');
            }
        }
        
        // JSONBin.io ile paylaş (eski sistem)
        async function share8DReportWithJsonBin() {
            const apiKey = getJsonBinApiKey();
            if (!apiKey) {
                showAlert('⚠️ JSONBin API Key ayarlanmamış!\n\nAyarlar menüsünden API Key ekleyin.\n\n📝 API Key almak için:\n1. https://jsonbin.io adresine gidin\n2. Ücretsiz hesap açın\n3. API Keys bölümünden key oluşturun', 'error');
                return;
            }

            // API key formatını kontrol et
            if (apiKey.length < 20) {
                showAlert('⚠️ API Key geçersiz görünüyor!\n\nAPI Key en az 20 karakter olmalıdır.\nLütfen doğru API Key\'i ayarlardan girin.', 'error');
                return;
            }

            if (!current8DData || !current8DData.id) {
                showAlert('⚠️ Önce raporu kaydedin!', 'error');
                console.error('❌ Paylaşım başarısız: current8DData yok veya ID yok');
                console.log('current8DData:', current8DData);
                return;
            }
            
            console.log('🔵 Paylaşım başlıyor...');
            console.log('🔵 Report ID:', current8DData.id);
            console.log('🔵 Supplier:', current8DSupplier);
            console.log('🔵 Mevcut sharedBinId:', current8DData.sharedBinId || 'YOK');
            console.log('🔑 API Key uzunluğu:', apiKey.length, 'karakter');

            try {
                console.log('📤 Share8D başladı, current8DData:', current8DData);
                console.log('🆔 Rapor ID:', current8DData.id);

                // 8D raporunu JSONBin'e yükle
                const shareData = {
                    reportId: current8DData.id,
                    supplierName: current8DSupplier,
                    monthIndex: current8DMonth,
                    reportData: current8DData,
                    sharedAt: new Date().toISOString(),
                    mode: 'supplier-edit' // Tedarikçi doldurabilir
                };

                // Bin name - Türkçe karakterleri temizle (ISO-8859-1 uyumlu olmalı)
                const safeBinName = `8D_${current8DSupplier}_${current8DMonth}`
                    .replace(/[ğĞ]/g, 'g')
                    .replace(/[üÜ]/g, 'u')
                    .replace(/[şŞ]/g, 's')
                    .replace(/[ıİ]/g, 'i')
                    .replace(/[öÖ]/g, 'o')
                    .replace(/[çÇ]/g, 'c')
                    .replace(/[^a-zA-Z0-9_-]/g, '_'); // Diğer özel karakterleri _ yap

                console.log('📤 JSONBin\'e gönderiliyor...');
                console.log('📦 Bin Name:', safeBinName);
                console.log('📊 Veri boyutu:', JSON.stringify(shareData).length, 'byte');

                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey,
                        'X-Bin-Name': safeBinName
                    },
                    body: JSON.stringify(shareData)
                });

                console.log('📡 Response status:', response.status);
                console.log('📡 Response statusText:', response.statusText);

                if (!response.ok) {
                    // Detaylı hata mesajı al
                    let errorDetail = '';
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.message || JSON.stringify(errorData);
                        console.error('❌ JSONBin error response:', errorData);
                    } catch (e) {
                        errorDetail = await response.text();
                        console.error('❌ JSONBin error text:', errorDetail);
                    }

                    // Özel hata mesajları
                    if (response.status === 403) {
                        // 100kb hatası kontrol et
                        if (errorDetail.includes('100kb') || errorDetail.includes('record over')) {
                            throw new Error(`Veri boyutu çok büyük (100kb+)!\n\n📦 JSONBin ücretsiz hesap 100kb limiti var.\n\n💡 Çözüm: Ek dosyalar otomatik çıkarıldı.\nEğer hala hata alıyorsanız:\n1. Rapordaki text verilerini kısaltın\n2. Veya JSONBin Pro hesaba yükseltin\n\n📝 Detay: ${errorDetail}`);
                        }
                        throw new Error(`API Key geçersiz veya yetkisiz!\n\n🔑 API Key kontrol edin:\n1. JSONBin.io hesabınızda API Key aktif mi?\n2. Doğru API Key\'i mi kopyaladınız?\n3. API Key\'in bin oluşturma yetkisi var mı?\n\n📝 Detay: ${errorDetail}`);
                    } else if (response.status === 401) {
                        throw new Error(`Kimlik doğrulama hatası!\n\nAPI Key geçersiz veya süresi dolmuş.\n\n📝 Detay: ${errorDetail}`);
                    } else if (response.status === 429) {
                        throw new Error(`İstek limiti aşıldı!\n\nBir süre bekleyin ve tekrar deneyin.\n\n📝 Detay: ${errorDetail}`);
                    } else {
                        // 100kb hatası başka status code'da gelebilir
                        if (errorDetail.includes('100kb') || errorDetail.includes('record over')) {
                            throw new Error(`Veri boyutu limiti aşıldı!\n\n📦 JSONBin ücretsiz: max 100kb\n💡 Ek dosyalar çıkarıldı ama hala büyük.\n\nText verilerini kısaltın veya Pro hesaba yükseltin.\n\n📝 Detay: ${errorDetail}`);
                        }
                        throw new Error(`JSONBin yükleme hatası (${response.status})\n\n📝 Detay: ${errorDetail}`);
                    }
                }

                const result = await response.json();
                console.log('✅ JSONBin response:', result);
                
                const binId = result.metadata.id;
                
                console.log('✅ JSONBin bin oluşturuldu:', binId);
                console.log('💾 Bin ID kaydediliyor... reportId:', current8DData.id);
                console.log('🔍 current8DData.sharedBinId ÖNCE:', current8DData.sharedBinId);
                
                // Bin ID'yi ÖNCE rapor verisine ekle ve kaydet
                current8DData.sharedBinId = binId;
                console.log('🔍 current8DData.sharedBinId SONRA:', current8DData.sharedBinId);
                
                await updateReportBinId(current8DData.id, binId);
                
                console.log('✅ Bin ID veritabanına kaydedildi');
                console.log('✅ current8DData.sharedBinId kontrol:', current8DData.sharedBinId);
                
                // Senkronize butonunu göster
                const syncBtn = document.getElementById('sync8DBtn');
                if (syncBtn) {
                    syncBtn.style.display = 'block';
                    console.log('🔄 Senkronize butonu gösterildi');
                }
                
                // API key'i base64 encode et
                const encodedKey = btoa(apiKey);
                const shareUrl = `${window.location.origin}${window.location.pathname}?8d=${binId}&key=${encodedKey}`;

                // Linki kopyala
                await navigator.clipboard.writeText(shareUrl);
                
                // Link göster
                showShareLinkDialog(shareUrl, binId);

            } catch (error) {
                console.error('❌ Share error:', error);
                console.error('❌ Error stack:', error.stack);
                
                // Kullanıcıya detaylı hata göster
                showAlert('❌ Paylaşım Hatası!\n\n' + error.message, 'error');
            }
        }

        function showShareLinkDialog(url, binId) {
            const dialog = document.createElement('div');
            dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 20000; max-width: 650px; width: 90%; max-height: 90vh; overflow-y: auto;';
            
            // file:// protokolü kontrolü
            const isLocalFile = window.location.protocol === 'file:';
            const warningHtml = isLocalFile ? `
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #ff9800;">
                    <div style="font-weight: 700; color: #f57c00; margin-bottom: 8px;">⚠️ ÖNEMLİ UYARI: Dosya Lokal Çalışıyor!</div>
                    <div style="font-size: 0.9em; color: #e65100; line-height: 1.6;">
                        <p style="margin: 5px 0;"><strong>Bu link sadece sizin bilgisayarınızda çalışır!</strong></p>
                        <p style="margin: 8px 0 5px 0; font-weight: 600;">Tedarikçinin erişebilmesi için:</p>
                        <ol style="margin: 5px 0; padding-left: 20px; font-size: 0.95em;">
                            <li><strong>index.html</strong> dosyasını bir web sunucusuna yükleyin</li>
                            <li><strong>Ücretsiz seçenekler:</strong>
                                <ul style="margin: 3px 0; padding-left: 20px;">
                                    <li><a href="https://pages.github.com" target="_blank" style="color: #2196f3;">GitHub Pages</a> (en kolay)</li>
                                    <li><a href="https://vercel.com" target="_blank" style="color: #2196f3;">Vercel</a></li>
                                    <li><a href="https://netlify.com" target="_blank" style="color: #2196f3;">Netlify</a></li>
                                </ul>
                            </li>
                            <li>Veya firma sunucunuza yükleyin</li>
                            <li>Sonra tekrar paylaşım linki oluşturun</li>
                        </ol>
                    </div>
                </div>
            ` : '';
            
            dialog.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #1e3c72;">🔗 8D Rapor Linki Oluşturuldu</h3>
                ${warningHtml}
                <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; border: 2px solid #4caf50; margin-bottom: 15px;">
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Paylaşım Linki:</div>
                    <div style="font-family: monospace; font-size: 0.8em; word-break: break-all; color: #333; max-height: 80px; overflow-y: auto;">${url}</div>
                </div>
                <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin-bottom: 15px; line-height: 1.6; font-size: 0.9em;">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">✅ Link Özellikleri:</div>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li>Link panoya kopyalandı</li>
                        <li>Tedarikçi sadece 8D formunu görür</li>
                        <li>Tedarikçi formları doldurabilir ve kaydedebilir</li>
                        <li>Güncellemeler otomatik sizin veritabanınıza yansır</li>
                        <li>API key güvenli şekilde gömülü</li>
                    </ul>
                </div>
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.85em; color: #856404; line-height: 1.5;">
                    <strong>💡 Kullanım:</strong> Bu linki tedarikçiye e-posta, WhatsApp veya SMS ile gönderin. Tedarikçi linki açtığında 8D formunu doldurup kaydedebilir.
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="sendDocumentShareEmail('${url}', '${binId}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">📧 Mail Gönder</button>
                    <button onclick="navigator.clipboard.writeText('${url}').then(() => showAlert('📋 Link kopyalandı!', 'success'))" style="flex: 1; min-width: 120px; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">📋 Kopyala</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="flex: 1; min-width: 120px; padding: 10px; background: #9e9e9e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Kapat</button>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }

        async function updateReportBinId(reportId, binId) {
            console.log('📝 updateReportBinId çağrıldı:', { reportId, binId });
            return new Promise((resolve, reject) => {
                const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const store = tx.objectStore(REPORT_8D_STORE_NAME);
                const getRequest = store.get(reportId);
                
                getRequest.onsuccess = () => {
                    const report = getRequest.result;
                    console.log('📂 Rapor okundu:', report ? 'Bulundu' : 'Bulunamadı');
                    if (report) {
                        console.log('🔍 Eski sharedBinId:', report.sharedBinId);
                        report.sharedBinId = binId;
                        console.log('✏️ Yeni sharedBinId atandı:', binId);
                        const putRequest = store.put(report);
                        
                        putRequest.onsuccess = () => {
                            console.log('✅ sharedBinId veritabanına yazıldı!');
                            resolve();
                        };
                        putRequest.onerror = () => {
                            console.error('❌ Put hatası:', putRequest.error);
                            reject(putRequest.error);
                        };
                    } else {
                        console.error('❌ Rapor bulunamadı, ID:', reportId);
                        resolve();
                    }
                };
                
                getRequest.onerror = () => {
                    console.error('❌ Get hatası:', getRequest.error);
                    reject(getRequest.error);
                };
            });
        }

        async function updateSharedReport(binIdOrPantryId, reportData) {
            // GitHub Gist mi kontrol et
            if (current8DData.sharedGistId) {
                return await updateSharedReportGist(current8DData.sharedGistId, reportData);
            }
            // Pantry mu JSONBin mi kontrol et
            else if (binIdOrPantryId && binIdOrPantryId.startsWith('pantry:')) {
                const pantryInfo = binIdOrPantryId.replace('pantry:', '');
                return await updateSharedReportPantry(pantryInfo, reportData);
            } else if (current8DData.sharedPantryId && current8DData.sharedBasketName) {
                // sharedPantryId varsa Pantry kullan
                const pantryInfo = `${current8DData.sharedPantryId}:${current8DData.sharedBasketName}`;
                return await updateSharedReportPantry(pantryInfo, reportData);
            } else {
                // JSONBin kullan
                return await updateSharedReportJsonBin(binIdOrPantryId, reportData);
            }
        }
        
        // Pantry ile güncelleme
        async function updateSharedReportPantry(pantryInfo, reportData) {
            try {
                // pantryInfo formatı: "pantryId:basketName"
                const [pantryId, basketName] = pantryInfo.split(':');
                
                if (!pantryId || !basketName) {
                    console.error('❌ Pantry bilgileri eksik!', pantryInfo);
                    return;
                }
                
                const shareData = {
                    reportId: reportData.id || current8DData.id,
                    supplierName: current8DSupplier || reportData.supplierName,
                    monthIndex: current8DMonth !== undefined ? current8DMonth : reportData.monthIndex,
                    reportData: reportData,
                    updatedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };

                console.log('📤 Pantry POST isteği gönderiliyor...');
                console.log('🔑 Pantry ID:', pantryId.substring(0, 20) + '...');
                console.log('🗄️ Basket adı:', basketName);
                console.log('🏢 Supplier:', shareData.supplierName);
                console.log('📅 Month:', shareData.monthIndex);
                console.log('📤 Report Timestamp:', reportData.timestamp);
                console.log('📤 Update Timestamp:', shareData.updatedAt);
                console.log('📸 Head defect photos:', reportData.head?.defectPhotos?.length || 0);

                const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${pantryId}/basket/${basketName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shareData)
                });

                if (response.ok) {
                    console.log('✅ Pantry başarıyla güncellendi (POST)!');
                    return { success: true };
                } else {
                    console.error('❌ Pantry güncelleme hatası, status:', response.status);
                    const errorText = await response.text();
                    console.error('❌ Hata detayı:', errorText);
                    
                    if (response.status === 413) {
                        console.warn('⚠️ Pantry boyut limiti aşıldı (1.44 MB)!');
                        console.warn('⚠️ Bu normal, Pantry yine de çalışabilir.');
                    }
                    return { success: false, error: response.status };
                }
            } catch (error) {
                console.error('❌ Pantry güncelleme exception:', error);
            }
        }
        
        // GitHub Gist ile güncelleme
        async function updateSharedReportGist(gistId, reportData) {
            const token = getGitHubToken();
            if (!token) {
                console.error('❌ GitHub token yok!');
                return;
            }
            
            try {
                const shareData = {
                    reportId: reportData.id || current8DData.id,
                    supplierName: current8DSupplier || reportData.supplierName,
                    monthIndex: current8DMonth !== undefined ? current8DMonth : reportData.monthIndex,
                    reportData: reportData,
                    updatedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };
                
                const fileName = '8d-report.json';
                
                console.log('📤 Gist PATCH isteği gönderiliyor...');
                console.log('🆔 Gist ID:', gistId);
                console.log('📄 Dosya:', fileName);
                console.log('📤 Update Timestamp:', shareData.updatedAt);
                
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            [fileName]: {
                                content: JSON.stringify(shareData, null, 2)
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    console.log('✅ Gist başarıyla güncellendi!');
                    return { success: true };
                } else {
                    console.error('❌ Gist güncelleme hatası, status:', response.status);
                    const errorData = await response.json();
                    console.error('❌ Hata detayı:', errorData);
                    return { success: false, error: 'GIST_ERROR' };
                }
            } catch (error) {
                console.error('❌ Gist güncelleme exception:', error);
            }
        }
        
        // Storj DCS ile güncelleme
        async function updateSharedReportStorj(storjKey, reportData) {
            let settings = getStorjSettings();
            
            // Eğer localStorage'da yoksa, URL'den al (supplier mode için)
            if (!settings) {
                const urlParams = new URLSearchParams(window.location.search);
                const storjEncoded = urlParams.get('storj');
                
                if (storjEncoded) {
                    try {
                        const credsJson = atob(storjEncoded);
                        const creds = JSON.parse(credsJson);
                        settings = {
                            accessKey: creds.accessKey,
                            secretKey: creds.secretKey,
                            bucket: creds.bucket,
                            endpoint: creds.endpoint
                        };
                        console.log('🔑 Credentials URL\'den alındı (supplier mode)');
                    } catch (e) {
                        console.error('❌ URL credentials parse hatası:', e);
                    }
                }
            }
            
            if (!settings) {
                console.error('❌ Storj ayarları yok!');
                return;
            }
            
            try {
                const shareData = {
                    reportId: reportData.id || current8DData.id,
                    supplierName: current8DSupplier || reportData.supplierName,
                    monthIndex: current8DMonth !== undefined ? current8DMonth : reportData.monthIndex,
                    reportData: reportData,
                    updatedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };
                
                console.log('📤 Storj PUT isteği gönderiliyor...');
                console.log('🔑 Key:', storjKey);
                console.log('📤 Update Timestamp:', shareData.updatedAt);
                
                await uploadToStorj(storjKey, JSON.stringify(shareData), settings);
                
                console.log('✅ Storj başarıyla güncellendi!');
                return { success: true };
            } catch (error) {
                console.error('❌ Storj güncelleme exception:', error);
                return { success: false, error: 'STORJ_ERROR' };
            }
        }
        
        // JSONBin ile güncelleme
        async function updateSharedReportJsonBin(binId, reportData) {
            const apiKey = getJsonBinApiKey();
            if (!apiKey) {
                console.error('❌ API Key yok!');
                return;
            }

            try {
                const shareData = {
                    reportId: reportData.id || current8DData.id,
                    supplierName: reportData.supplierName,
                    monthIndex: reportData.monthIndex,
                    reportData: reportData,
                    updatedAt: new Date().toISOString(),
                    mode: 'supplier-edit'
                };

                console.log('📤 JSONBin PUT isteği gönderiliyor...');
                console.log('📤 Bin ID:', binId);
                console.log('📤 Timestamp:', reportData.timestamp);

                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey
                    },
                    body: JSON.stringify(shareData)
                });

                if (response.ok) {
                    console.log('✅ JSONBin başarıyla güncellendi!');
                    const result = await response.json();
                    console.log('✅ Response:', result);
                } else {
                    console.error('❌ JSONBin güncelleme hatası, status:', response.status);
                }
            } catch (error) {
                console.error('❌ JSONBin güncelleme exception:', error);
            }
        }

        async function syncFromJsonBin(binId, localReportId) {
            const apiKey = getJsonBinApiKey();
            console.log('🔄 syncFromJsonBin çağrıldı:', { binId, localReportId, apiKey: apiKey ? 'Var' : 'Yok' });
            
            if (!apiKey || !binId) {
                console.warn('⚠️ API Key veya binId yok, sync iptal edildi');
                if (!apiKey) {
                    showAlert('⚠️ JSONBin API Key bulunamadı!\n\nLütfen Ayarlar > 8D Paylaşım Servisi bölümünden API Key\'inizi girin ve test edin.', 'warning');
                }
                return;
            }

            try {
                console.log('🔍 JSONBin\'den veri çekiliyor...');
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });

                if (!response.ok) {
                    console.error('❌ JSONBin response hatalı:', response.status);
                    if (response.status === 400) {
                        showAlert('⚠️ JSONBin API Key geçersiz!\n\nLütfen Ayarlar > 8D Paylaşım Servisi bölümünden API Key\'inizi kontrol edin ve test edin.', 'error');
                    }
                    return;
                }

                const result = await response.json();
                const remoteData = result.record.reportData;

                console.log('� Remote veri alındı, güncelleniyor...');
                console.log('  Remote timestamp:', remoteData.timestamp);
                console.log('  Local timestamp:', current8DData.timestamp);

                // HER ZAMAN GÜNCELLE (timestamp karşılaştırması YOK!)
                if (true) {
                    // Remote daha yeni - local'i güncelle
                    console.log('📥 JSONBin\'den güncel veri çekiliyor...');
                    
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                        const store = tx.objectStore(REPORT_8D_STORE_NAME);
                        
                        remoteData.id = localReportId;
                        remoteData.sharedBinId = binId;
                        
                        const putRequest = store.put(remoteData);
                        
                        putRequest.onsuccess = () => {
                            current8DData = remoteData;
                            populate8DForm(remoteData);
                            
                            // Büyük bildirim göster
                            const updateNotification = document.createElement('div');
                            updateNotification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 25000; min-width: 350px; animation: slideIn 0.5s ease-out;';
                            updateNotification.innerHTML = `
                                <style>
                                    @keyframes slideIn {
                                        from { transform: translateX(400px); opacity: 0; }
                                        to { transform: translateX(0); opacity: 1; }
                                    }
                                </style>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="font-size: 2.5em;">🔔</div>
                                    <div>
                                        <div style="font-size: 1.2em; font-weight: 700; margin-bottom: 5px;">YENİ GÜNCELLEME!</div>
                                        <div style="font-size: 0.95em; line-height: 1.4;">Tedarikçi 8D raporunu güncelledi. Yeni veriler yüklendi.</div>
                                    </div>
                                    <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.3); border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 5px 10px; border-radius: 5px; margin-left: auto;">×</button>
                                </div>
                            `;
                            document.body.appendChild(updateNotification);
                            
                            // 7 saniye sonra otomatik kapat
                            setTimeout(() => updateNotification.remove(), 7000);
                            
                            resolve();
                        };
                        
                        putRequest.onerror = () => reject(putRequest.error);
                    });
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        // URL'den 8D yükleme (Tedarikçi modu)
        async function checkShared8DInUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const binId = urlParams.get('8d');
            const gistId = urlParams.get('gist');
            const storjEncoded = urlParams.get('storj');
            
            if (storjEncoded) {
                // Credentials'ı decode edip key'i kontrol et
                try {
                    const credsJson = atob(storjEncoded);
                    const creds = JSON.parse(credsJson);
                    
                    // Key DOCS_ ile başlıyorsa doküman paylaşımı
                    if (creds.key && creds.key.startsWith('DOCS_')) {
                        console.log('📄 Doküman paylaşımı tespit edildi');
                        await loadSharedDocumentsFromStorj(storjEncoded);
                        return;
                    }
                } catch (e) {
                    console.error('Storj credentials parse hatası:', e);
                }
                
                // Servisi Storj olarak ayarla
                localStorage.setItem('preferred_8d_service', 'storj');
                console.log('✅ Paylaşım servisi otomatik olarak Storj DCS olarak ayarlandı');
                
                // 8D Rapor yükle
                await loadShared8DReportFromStorj(storjEncoded);
                // Sayfa açılışında bir kez senkronize et
                if (current8DData && current8DData.sharedStorjKey) {
                    console.log('📥 Sayfa açılışında Storj DCS senkronizasyonu yapılıyor...');
                    await silentSync8DStorj();
                }
            } else if (gistId) {
                // GitHub Gist'ten yükle
                await loadShared8DReportFromGist(gistId);
                // Sayfa açılışında bir kez senkronize et
                if (current8DData && current8DData.gistId) {
                    console.log('📥 Sayfa açılışında GitHub Gist senkronizasyonu yapılıyor...');
                    await silentSync8DGist();
                }
            } else if (binId) {
                await loadShared8DReport(binId);
                // Sayfa açılışında bir kez senkronize et
                if (current8DData && current8DData.sharedBinId) {
                    console.log('📥 Sayfa açılışında senkronizasyon yapılıyor...');
                    await silentSync8D();
                }
            }
        }

        async function loadShared8DReport(binId) {
            // Servis tipini kontrol et (pantry:pantryId:basketName veya jsonbin binId)
            if (binId.startsWith('pantry:')) {
                // Pantry'den yükle
                const pantryInfo = binId.replace('pantry:', '');
                
                try {
                    const shareData = await loadFromPantry(pantryInfo);
                    
                    // Tedarikçi modunda aç
                    current8DSupplier = shareData.supplierName;
                    current8DMonth = shareData.monthIndex;
                    current8DData = shareData.reportData;
                    
                    // Pantry bilgilerini sakla
                    const [pantryId, basketName] = pantryInfo.split(':');
                    current8DData.sharedPantryId = pantryId;
                    current8DData.sharedBasketName = basketName;
                    window.supplierEditMode = true;
                    
                    setupSupplierEditMode(shareData);
                    
                } catch (error) {
                    showAlert('❌ Rapor yüklenemedi!\n\n' + error.message, 'error');
                }
            } else {
                // JSONBin.io'dan yükle (eski sistem)
                await loadShared8DReportFromJsonBin(binId);
            }
        }
        
        async function loadShared8DReportFromJsonBin(binId) {
            // Önce URL'den API key kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            const encodedKey = urlParams.get('key');
            
            let apiKey = getJsonBinApiKey();
            
            // Eğer URL'de key varsa onu kullan
            if (encodedKey) {
                try {
                    apiKey = atob(encodedKey);
                } catch (e) {
                    console.error('Key decode error:', e);
                }
            }
            
            if (!apiKey) {
                showAlert('⚠️ API Key bulunamadı! Link hatalı olabilir.', 'error');
                return;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('Report not found');
                }

                const result = await response.json();
                const shareData = result.record;

                // Tedarikçi modunda aç
                current8DSupplier = shareData.supplierName;
                current8DMonth = shareData.monthIndex;
                current8DData = shareData.reportData;
                current8DData.sharedBinId = binId;
                window.supplierEditMode = true;

                setupSupplierEditMode(shareData);

            } catch (error) {
                console.error('Load shared report error:', error);
                showAlert('❌ Paylaşılan rapor yüklenemedi!', 'error');
            }
        }
        
        async function loadShared8DReportFromGist(gistId) {
            // URL'den GitHub token al
            const urlParams = new URLSearchParams(window.location.search);
            const encodedToken = urlParams.get('ghtoken');
            
            let token = getGitHubToken();
            
            // Eğer URL'de token varsa onu kullan ve kaydet
            if (encodedToken) {
                try {
                    token = atob(encodedToken);
                    saveGitHubToken(token); // localStorage'a kaydet
                } catch (e) {
                    console.error('Token decode error:', e);
                }
            }
            
            if (!token) {
                showAlert('⚠️ GitHub token bulunamadı! Link hatalı olabilir.', 'error');
                return;
            }

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Gist bulunamadı');
                }

                const gistData = await response.json();
                
                // İlk dosyayı al (dosya adından bağımsız)
                const firstFileName = Object.keys(gistData.files)[0];
                if (!firstFileName) {
                    throw new Error('Gist\'te dosya bulunamadı');
                }
                
                console.log('📄 Gist dosya adı:', firstFileName);
                const fileContent = gistData.files[firstFileName].content;
                const shareData = JSON.parse(fileContent);

                // Tedarikçi modunda aç
                current8DSupplier = shareData.supplierName;
                current8DMonth = shareData.monthIndex;
                current8DData = shareData.reportData;
                current8DData.gistId = gistId;
                window.supplierEditMode = true;

                setupSupplierEditMode(shareData);

            } catch (error) {
                console.error('Load shared Gist error:', error);
                showAlert('❌ GitHub Gist\'ten rapor yüklenemedi!\n\n' + error.message, 'error');
            }
        }
        
        // Storj DCS'den paylaşılan rapor yükle
        async function loadShared8DReportFromStorj(encodedCreds) {
            try {
                // Base64 encoded credentials parse et
                const credsJson = atob(encodedCreds);
                const creds = JSON.parse(credsJson);
                
                console.log('🚀 Storj DCS\'den yükleniyor...');
                console.log('🔑 Key:', creds.key);
                
                // Settings objesini oluştur
                const settings = {
                    accessKey: creds.accessKey,
                    secretKey: creds.secretKey,
                    bucket: creds.bucket,
                    endpoint: creds.endpoint
                };
                
                // Storj'dan indir
                const shareData = await downloadFromStorj(creds.key, settings);
                
                // Tedarikçi modunda aç
                current8DSupplier = shareData.supplierName;
                current8DMonth = shareData.monthIndex;
                current8DData = shareData.reportData;
                current8DData.sharedStorjKey = creds.key;
                window.supplierEditMode = true;
                
                // Credentials'ı localStorage'a kaydet (sonraki sync'ler için)
                saveStorjSettings(creds.accessKey, creds.secretKey, creds.bucket, creds.endpoint);
                
                setupSupplierEditMode(shareData);
                
            } catch (error) {
                console.error('Load shared Storj error:', error);
                showAlert('❌ Storj DCS\'ten rapor yüklenemedi!\n\n' + error.message, 'error');
            }
        }

        // Storj DCS'den paylaşılan dokümanları yükle
        async function loadSharedDocumentsFromStorj(encodedCreds) {
            try {
                // Base64 encoded credentials parse et
                const credsJson = atob(encodedCreds);
                const creds = JSON.parse(credsJson);
                
                console.log('🚀 Dokümanlar Storj DCS\'den yükleniyor...');
                console.log('🔑 Key:', creds.key);
                
                // Settings objesini oluştur
                const settings = {
                    accessKey: creds.accessKey,
                    secretKey: creds.secretKey,
                    bucket: creds.bucket,
                    endpoint: creds.endpoint
                };
                
                // Storj'dan indir
                const shareData = await downloadFromStorj(creds.key, settings);
                
                console.log('✅ Dokümanlar yüklendi:', shareData);
                
                // Doküman görüntüleme modalını aç
                showSharedDocumentsView(shareData);
                
            } catch (error) {
                console.error('Load shared documents error:', error);
                showAlert('❌ Storj DCS\'ten dokümanlar yüklenemedi!\n\n' + error.message, 'error');
            }
        }

        // Paylaşılan dokümanları görüntüle
        function showSharedDocumentsView(shareData) {
            // Ana sayfayı gizle
            const mainContainer = document.querySelector('.container');
            const navbar = document.querySelector('.navbar');
            
            if (mainContainer) mainContainer.style.display = 'none';
            if (navbar) navbar.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.body.style.background = '#f5f5f5';
            
            // Doküman viewer oluştur
            const viewer = document.createElement('div');
            viewer.id = 'sharedDocumentViewer';
            viewer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #f5f5f5;
                overflow-y: auto;
                z-index: 10000;
                padding: 20px;
            `;
            
            let html = `
                <div style="max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 30px; text-align: center;">
                        <h1 style="margin: 0; font-size: 2em;">📄 ${shareData.supplierName} - Dokümanlar</h1>
                        <p style="margin: 10px 0 0 0; opacity: 0.9;">Paylaşım Tarihi: ${new Date(shareData.sharedAt).toLocaleString('tr-TR')}</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.8;">💡 Her doküman türüne dosya yükleyebilir ve güncelleyebilirsiniz</p>
                    </div>
                    
                    <div style="padding: 30px;">
            `;
            
            // Tüm doküman türlerini göster (DOCUMENT_TYPES + custom types)
            const allDocTypes = [...new Set([...getDocumentTypes(), ...(shareData.customTypes || [])])];
            
            if (allDocTypes.length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 40px;">Doküman türü bulunamadı</p>';
            } else {
                allDocTypes.forEach((docType, typeIdx) => {
                    const docs = shareData.documents[docType] || [];
                    const hasDoc = docs.length > 0;
                    const isExempt = (shareData.exemptDocTypes || []).includes(docType);
                    
                    html += `
                        <div style="margin-bottom: 30px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${hasDoc ? '#e8f5e9' : isExempt ? '#fffde7' : '#f5f5f5'}; padding: 15px; border-bottom: 2px solid ${hasDoc ? '#4CAF50' : isExempt ? '#ff9800' : '#ddd'};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="margin: 0; color: #333; font-size: 1.2em;">${docType}</h3>
                                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">${hasDoc ? `✓ ${docs.length} dosya yüklü` : isExempt ? '− Zorunlu Değil' : 'Dosya yok'}</p>
                                    </div>
                                    <div>
                                        <input type="file" id="supplierDocInput_${typeIdx}" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png,.txt" style="display: none;" multiple onchange="handleSupplierDocUpload('${docType.replace(/'/g, "\\'")}', this.files, ${typeIdx})">
                                        <button onclick="document.getElementById('supplierDocInput_${typeIdx}').click()" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                            <span>📁</span> Dosya Yükle
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 15px;" id="docList_${docType.replace(/[^a-zA-Z0-9]/g, '_')}">>
                    `;
                    
                    docs.forEach((file, idx) => {
                        const safeDocType = docType.replace(/'/g, "\\'");
                        const statusColor = file.status === 'approved' ? '#4CAF50' : file.status === 'rejected' ? '#f44336' : '#ff9800';
                        const statusText = file.status === 'approved' ? '✅ Kabul Edildi' : file.status === 'rejected' ? '❌ Reddedildi' : '⏳ İnceleme Sürecinde';
                        const statusBg = file.status === 'approved' ? '#e8f5e9' : file.status === 'rejected' ? '#ffebee' : '#fff3e0';
                        
                        html += `
                            <div style="padding: 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${statusColor};" id="supplierDoc_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 5px;">📎 ${file.name} ${file.uploadedBySupplier ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;">TEDARİKÇİ</span>' : '<span style="background: #2196f3; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;">ANA PC</span>'}</div>
                                        <div style="font-size: 0.85em; color: #666;">
                                            ${new Date(file.timestamp).toLocaleDateString('tr-TR')} • ${(file.size / 1024).toFixed(1)} KB
                                        </div>
                                        ${!file.uploadedBySupplier && file.description ? `
                                        <div style="margin-top: 6px; padding: 6px 8px; background: #e3f2fd; border-radius: 4px; border-left: 3px solid #2196f3;">
                                            <div style="font-size: 0.75em; color: #666; margin-bottom: 2px;">Ana PC Açıklaması:</div>
                                            <div style="font-size: 0.8em; color: #333;">${file.description}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="previewSharedDocument('${safeDocType}', ${idx})" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                            👁️ Önizle
                                        </button>
                                        <button onclick="downloadSharedDocument('${safeDocType}', ${idx})" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                            ⬇️ İndir
                                        </button>
                                        <button onclick="removeSupplierDocument('${safeDocType}', ${idx})" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                            🗑️ Sil
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 8px; padding: 10px; background: ${statusBg}; border-radius: 4px; border: 2px solid ${statusColor};">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="font-size: 0.9em; font-weight: 700; color: ${statusColor};">${statusText}</div>
                                            <span style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; font-weight: 600;">☁️ STORJ</span>
                                        </div>
                                        ${file.reviewedAt ? `<div style="font-size: 0.75em; color: #666;">📅 ${new Date(file.reviewedAt).toLocaleDateString('tr-TR')}</div>` : ''}
                                    </div>
                                    ${file.reviewComment ? `
                                    <div style="margin-top: 6px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 0.75em; color: #666; margin-bottom: 3px; font-weight: 600;">💬 Müşteri Yorumu:</div>
                                        <div style="font-size: 0.85em; color: #333; line-height: 1.4;">${file.reviewComment}</div>
                                    </div>
                                    ` : `<div style="font-size: 0.75em; color: #999; font-style: italic; margin-top: 4px;">Henüz müşteri yorumu yok</div>`}
                                    <div style="margin-top: 8px; padding: 8px; background: #e8f5e9; border: 2px solid #4CAF50; border-radius: 6px;">
                                        <label style="display: block; font-size: 0.75em; color: #2e7d32; margin-bottom: 3px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                            💭 Tedarikçi Yorumu (Müşteriye iletilir):
                                            <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.85em;">☁️ STORJ</span>
                                        </label>
                                        <textarea id="supplierComment_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}" placeholder="Müşteriye iletilecek yorumunuzu yazın..." onchange="updateSupplierComment('${safeDocType}', ${idx}, this.value)" style="width: 100%; min-height: 50px; padding: 6px 8px; border: 1px solid #4CAF50; border-radius: 4px; font-size: 0.8em; resize: vertical; box-sizing: border-box; line-height: 1.4;">${file.supplierComment || ''}</textarea>
                                        <div style="font-size: 0.7em; color: #2e7d32; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                            ℹ️ Bu yorum "Dokümanları Gönder" butonuna bastığınızda Storj üzerinden müşteriye iletilir.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                        <div style="position: sticky; bottom: 0; padding: 20px; background: white; border-top: 2px solid #2196F3; text-align: center; margin-top: 30px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                            <button onclick="syncSupplierConfigFromStorj()" style="padding: 15px 40px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.1em; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                🔄 Yeni Değişiklikleri Al
                            </button>
                            <button onclick="sendSupplierDocumentsToStorj()" style="padding: 15px 40px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.1em; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                📤 Dokümanları Gönder
                            </button>
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #666; text-align: center;">💡 Ana PC'den gelen değişiklikleri görmek için "Yeni Değişiklikleri Al" butonuna basın</p>
                    </div>
                </div>
            `;
            
            viewer.innerHTML = html;
            document.body.appendChild(viewer);
            
            // Doküman verilerini global değişkende sakla
            window.sharedDocumentsData = shareData;
            window.supplierDocumentChanges = {}; // Değişiklikleri takip et
        }

        // Tedarikçinin dosya yüklemesi
        async function handleSupplierDocUpload(docType, files, typeIdx) {
            if (!files || files.length === 0) return;
            
            console.log(`📁 ${docType} için ${files.length} dosya seçildi`);
            
            // Açıklama input'undan al
            const descInput = document.getElementById(`supplierDocDesc_${typeIdx}`);
            const description = descInput ? descInput.value.trim() : '';
            
            console.log('📝 Açıklama:', description || '(yok)');
            
            for (const file of files) {
                // Dosya boyutu kontrolü (100 MB)
                if (file.size > 100 * 1024 * 1024) {
                    showAlert(`⚠️ "${file.name}" çok büyük!\n\nMaksimum: 100 MB\nDosya boyutu: ${(file.size / 1024 / 1024).toFixed(2)} MB`, 'error');
                    continue;
                }
                
                // Dosyayı base64'e çevir
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        timestamp: Date.now(),
                        description: description || '',
                        status: 'pending',
                        reviewComment: '',
                        reviewedAt: null,
                        uploadedBySupplier: true
                    };
                    
                    // Değişikliklere ekle
                    if (!window.supplierDocumentChanges[docType]) {
                        window.supplierDocumentChanges[docType] = [];
                    }
                    window.supplierDocumentChanges[docType].push(fileData);
                    
                    // Shared data'ya da ekle
                    if (!window.sharedDocumentsData.documents[docType]) {
                        window.sharedDocumentsData.documents[docType] = [];
                    }
                    window.sharedDocumentsData.documents[docType].push(fileData);
                    
                    // UI'yi güncelle
                    updateSupplierDocumentList(docType);
                    
                    console.log(`✅ "${file.name}" eklendi`);
                };
                reader.readAsDataURL(file);
            }
            
            // Açıklama alanını temizle
            if (descInput) {
                descInput.value = '';
            }
        }

        // Tedarikçi dosya açıklamasını güncelle
        function updateSupplierFileDescription(docType, fileIndex, newDescription) {
            if (!window.sharedDocumentsData || !window.sharedDocumentsData.documents[docType]) {
                console.error('❌ Doküman verisi bulunamadı');
                return;
            }
            
            const docs = window.sharedDocumentsData.documents[docType];
            if (docs[fileIndex]) {
                docs[fileIndex].description = newDescription;
                console.log(`✅ "${docs[fileIndex].name}" açıklaması güncellendi: "${newDescription}"`);
                console.log('📋 Güncel doküman objesi:', docs[fileIndex]);
            } else {
                console.error(`❌ Dosya bulunamadı: docType=${docType}, index=${fileIndex}`);
            }
        }

        // Tedarikçi yorumunu güncelle
        function updateSupplierComment(docType, fileIndex, comment) {
            if (!window.sharedDocumentsData || !window.sharedDocumentsData.documents[docType]) {
                console.error('❌ Doküman verisi bulunamadı');
                return;
            }
            
            const docs = window.sharedDocumentsData.documents[docType];
            if (docs[fileIndex]) {
                docs[fileIndex].supplierComment = comment;
                docs[fileIndex].supplierCommentDate = new Date().toISOString();
                console.log(`✅ "${docs[fileIndex].name}" tedarikçi yorumu güncellendi: "${comment}"`);
                console.log('📋 Güncel doküman objesi:', docs[fileIndex]);
            } else {
                console.error(`❌ Dosya bulunamadı: docType=${docType}, index=${fileIndex}`);
            }
        }

        // Tedarikçi doküman listesini güncelle
        function updateSupplierDocumentList(docType) {
            const listId = `docList_${docType.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const listContainer = document.getElementById(listId);
            if (!listContainer) return;
            
            const docs = window.sharedDocumentsData.documents[docType] || [];
            
            let html = '';
            docs.forEach((file, idx) => {
                const statusColor = file.status === 'approved' ? '#4CAF50' : file.status === 'rejected' ? '#f44336' : '#ff9800';
                const statusText = file.status === 'approved' ? '✅ Kabul Edildi' : file.status === 'rejected' ? '❌ Reddedildi' : '⏳ İnceleme Sürecinde';
                const statusBg = file.status === 'approved' ? '#e8f5e9' : file.status === 'rejected' ? '#ffebee' : '#fff3e0';
                
                html += `
                    <div style="padding: 12px; background: ${file.uploadedBySupplier ? '#e8f5e9' : '#f9f9f9'}; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${statusColor};" id="supplierDoc_${docType.replace(/[^a-zA-Z0-9]/g, '_')}_${idx}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                    📎 ${file.name}
                                    ${file.uploadedBySupplier ? '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;">TEDARİKÇİ</span>' : '<span style="background: #2196f3; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 5px;">ANA PC</span>'}
                                </div>
                                <div style="font-size: 0.85em; color: #666;">
                                    ${file.timestamp ? new Date(file.timestamp).toLocaleDateString('tr-TR') : ''} • ${((file.size || 0) / 1024).toFixed(1)} KB
                                </div>
                                ${file.description ? `<div style="font-size: 0.8em; color: #666; margin-top: 6px; padding: 6px 8px; background: ${file.uploadedBySupplier ? '#c8e6c9' : '#bbdefb'}; border-radius: 3px; border-left: 3px solid ${file.uploadedBySupplier ? '#4CAF50' : '#2196f3'};">💬 ${file.uploadedBySupplier ? 'Tedarikçi' : 'Ana PC'} Açıklaması: ${file.description}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="previewSharedDocument('${docType.replace(/'/g, "\\'")}', ${idx})" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    👁️ Önizle
                                </button>
                                <button onclick="downloadSharedDocument('${docType.replace(/'/g, "\\'")}', ${idx})" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    ⬇️ İndir
                                </button>
                                <button onclick="removeSupplierDocument('${docType.replace(/'/g, "\\'")}', ${idx})" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    🗑️ Sil
                                </button>
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: ${statusBg}; border-radius: 4px;">
                            <div style="font-size: 0.85em; font-weight: 600; color: #333; margin-bottom: 4px;">${statusText}</div>
                            ${file.reviewComment ? `<div style="font-size: 0.8em; color: #666; padding: 6px 8px; background: white; border-radius: 3px; margin-top: 4px;">📝 Müşteri Yorumu: ${file.reviewComment}</div>` : ''}
                            ${file.reviewedAt ? `<div style="font-size: 0.75em; color: #999; margin-top: 4px;">Değerlendirme: ${new Date(file.reviewedAt).toLocaleString('tr-TR')}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html || '<p style="text-align: center; color: #999; padding: 20px;">Henüz dosya yüklenmedi</p>';
        }

        // Tedarikçi doküman silme
        function removeSupplierDocument(docType, index) {
            if (!confirm('Bu dokümanı silmek istediğinize emin misiniz?')) return;
            
            if (!window.sharedDocumentsData.documents[docType]) return;
            
            window.sharedDocumentsData.documents[docType].splice(index, 1);
            updateSupplierDocumentList(docType);
        }

        // Tedarikçi PC: Ana PC'den konfigürasyon değişikliklerini al
        async function syncSupplierConfigFromStorj() {
            console.log('🔄 Konfigürasyon senkronizasyonu başlıyor...');

            if (!window.sharedDocumentsData) {
                showAlert('❌ Veri bulunamadı!', 'error');
                return;
            }

            // URL'den Storj bilgilerini al
            const urlParams = new URLSearchParams(window.location.search);
            const storjData = urlParams.get('storj');
            
            if (!storjData) {
                showAlert('❌ Storj bilgisi bulunamadı!', 'error');
                return;
            }

            try {
                const credentials = JSON.parse(atob(storjData));
                
                console.log('🔑 Storj\'dan çekiliyor:', credentials.key);

                // Settings objesi oluştur
                const settings = {
                    accessKey: credentials.accessKey,
                    secretKey: credentials.secretKey,
                    bucket: credentials.bucket,
                    endpoint: credentials.endpoint
                };

                // downloadFromStorj fonksiyonunu kullan (AWS Signature v4 ile)
                const updatedData = await downloadFromStorj(credentials.key, settings);
                
                console.log('✅ Güncel veri alındı!');
                console.log('📊 Zorunlu değil türler:', updatedData.exemptDocTypes);
                console.log('📊 Özel türler:', updatedData.customTypes);
                console.log('📄 Dokümanlar:', Object.keys(updatedData.documents || {}).length, 'tür');

                // Değişiklikleri karşılaştır
                const oldExempt = JSON.stringify(window.sharedDocumentsData.exemptDocTypes || []);
                const newExempt = JSON.stringify(updatedData.exemptDocTypes || []);
                const oldCustom = JSON.stringify(window.sharedDocumentsData.customTypes || []);
                const newCustom = JSON.stringify(updatedData.customTypes || []);
                const oldDocs = JSON.stringify(window.sharedDocumentsData.documents || {});
                const newDocs = JSON.stringify(updatedData.documents || {});

                let changes = [];
                
                if (oldExempt !== newExempt) {
                    changes.push('📋 Zorunlu değil türler güncellendi');
                }
                
                if (oldCustom !== newCustom) {
                    changes.push('📝 Özel doküman türleri güncellendi');
                }
                
                if (oldDocs !== newDocs) {
                    changes.push('📄 Doküman durumları ve yorumlar güncellendi');
                }

                // Güncel veriyi uygula (değişiklik olsun olmasın)
                window.sharedDocumentsData = updatedData;
                
                // Sayfayı yeniden oluştur
                const viewer = document.getElementById('sharedDocumentViewer');
                if (viewer) {
                    viewer.remove();
                }
                showSharedDocumentsView(updatedData);

                // Kullanıcıya bilgi ver
                if (changes.length === 0) {
                    showAlert('✅ Sayfa Yenilendi!\n\nEn güncel veriler gösteriliyor.', 'success');
                } else {
                    showAlert('✅ Güncellemeler Alındı!\n\n' + changes.join('\n') + '\n\n🔄 Sayfa yenilendi.', 'success');
                }

            } catch (error) {
                console.error('❌ Senkronizasyon hatası:', error);
                showAlert('❌ Senkronizasyon Hatası!\n\n' + error.message, 'error');
            }
        }

        // Tedarikçinin dokümanları Storj'a gönder
        async function sendSupplierDocumentsToStorj() {
            console.log('📤 Tedarikçi dokümanları Storj\'a gönderiliyor...');
            
            try {
                // Dokümanları temizle - sadece JSON-safe alanları gönder
                const convertedDocuments = {};
                for (const [docType, files] of Object.entries(window.sharedDocumentsData.documents || {})) {
                    convertedDocuments[docType] = files.map(file => {
                        console.log(`📝 Dosya: ${file.name}, Açıklama: "${file.description || '(yok)'}"`);
                        return {
                            id: file.id,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: file.data, // Zaten base64 string olarak mevcut
                            timestamp: file.timestamp,
                            description: file.description || '',
                            status: file.status || 'pending',
                            reviewComment: file.reviewComment || '',
                            supplierComment: file.supplierComment || '',
                            supplierCommentDate: file.supplierCommentDate || null,
                            reviewedAt: file.reviewedAt || null,
                            uploadedBySupplier: file.uploadedBySupplier || false
                        };
                    });
                }
                
                // Güncellenmiş veriyi hazırla
                const updatedData = {
                    supplierName: window.sharedDocumentsData.supplierName,
                    documents: convertedDocuments,
                    exemptDocTypes: window.sharedDocumentsData.exemptDocTypes || [],
                    customTypes: window.sharedDocumentsData.customTypes || [],
                    sharedAt: window.sharedDocumentsData.sharedAt,
                    mode: window.sharedDocumentsData.mode,
                    lastUpdatedBySupplier: new Date().toISOString()
                };
                
                console.log('📊 Gönderilecek veri:', JSON.stringify(updatedData, null, 2).substring(0, 500) + '...');
                
                // Storj credentials'ı URL'den al
                const urlParams = new URLSearchParams(window.location.search);
                const storjEncoded = urlParams.get('storj');
                if (!storjEncoded) {
                    showAlert('❌ Storj key bulunamadı!', 'error');
                    return;
                }
                
                const credsJson = atob(storjEncoded);
                const creds = JSON.parse(credsJson);
                
                // Settings objesini oluştur
                const settings = {
                    accessKey: creds.accessKey,
                    secretKey: creds.secretKey,
                    bucket: creds.bucket,
                    endpoint: creds.endpoint
                };
                
                console.log('📤 Storj PUT isteği gönderiliyor...');
                console.log('🔑 Key:', creds.key);
                console.log('📊 Doküman türü sayısı:', Object.keys(updatedData.documents).length);
                
                // Storj'a yükle
                await uploadToStorj(creds.key, JSON.stringify(updatedData, null, 2), settings);
                
                console.log('✅ Dokümanlar başarıyla gönderildi!');
                
                // Başarılı gönderim modalı göster
                const successModal = document.createElement('div');
                successModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 30000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                successModal.id = 'supplierSuccessModal';
                successModal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="font-size: 4em; margin-bottom: 20px; animation: bounce 1s;">✅</div>
                        <h2 style="color: #4CAF50; margin-bottom: 15px; font-size: 1.8em;">Başarıyla Gönderildi!</h2>
                        <p style="color: #666; font-size: 1.1em; margin-bottom: 10px;">Dokümanlarınız Storj DCS'e yüklendi.</p>
                        <p style="color: #999; font-size: 0.9em; margin-bottom: 30px;">Ana PC "Senkronize Et" butonu ile yeni dokümanları görüntüleyebilir.</p>
                        <button id="closeSuccessModalBtn" style="padding: 12px 40px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.1em;">
                            Tamam
                        </button>
                    </div>
                    <style>
                        @keyframes bounce {
                            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                            40% { transform: translateY(-20px); }
                            60% { transform: translateY(-10px); }
                        }
                    </style>
                `;
                document.body.appendChild(successModal);
                
                // Modal kapatma event listener
                const closeBtn = document.getElementById('closeSuccessModalBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        const modal = document.getElementById('supplierSuccessModal');
                        if (modal) modal.remove();
                    });
                }
                
                // Değişiklik işaretlerini temizle
                window.supplierDocumentChanges = {};
                
            } catch (error) {
                console.error('❌ Gönderme hatası:', error);
                showAlert('❌ Gönderme Hatası!\n\n' + error.message, 'error');
            }
        }

        // Paylaşılan dokümanı önizle
        function previewSharedDocument(docType, index) {
            if (!window.sharedDocumentsData) {
                showAlert('⚠️ Doküman verisi bulunamadı!', 'warning');
                return;
            }
            
            const docs = window.sharedDocumentsData.documents[docType];
            if (!docs || !docs[index]) {
                showAlert('⚠️ Doküman bulunamadı!', 'warning');
                return;
            }
            
            const file = docs[index];
            
            if (!file.data) {
                showAlert('⚠️ Dosya verisi bulunamadı!', 'warning');
                return;
            }
            
            // Preview modal oluştur
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 20000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%; background: white; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 15px; background: #1976d2; color: white; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">${file.name}</h3>
                        <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">✕</button>
                    </div>
                    <div style="flex: 1; overflow: auto; padding: 20px;">
                        ${file.type.includes('image') ? 
                            `<img src="${file.data}" style="max-width: 100%; height: auto;" />` :
                            file.type.includes('pdf') ?
                            `<embed src="${file.data}" type="application/pdf" width="100%" height="800px" />` :
                            '<p>Önizleme desteklenmiyor. Lütfen indirin.</p>'
                        }
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Paylaşılan dokümanı indir
        function downloadSharedDocument(docType, index) {
            if (!window.sharedDocumentsData) {
                showAlert('⚠️ Doküman verisi bulunamadı!', 'warning');
                return;
            }
            
            const docs = window.sharedDocumentsData.documents[docType];
            if (!docs || !docs[index]) {
                showAlert('⚠️ Doküman bulunamadı!', 'warning');
                return;
            }
            
            const file = docs[index];
            
            if (!file.data) {
                showAlert('⚠️ Dosya verisi bulunamadı!', 'warning');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log(`✅ ${file.name} indirildi`);
            } catch (error) {
                console.error('İndirme hatası:', error);
                showAlert('❌ İndirme hatası: ' + error.message, 'error');
            }
        }
        
        
        // Tedarikçi modu UI ayarları
        function setupSupplierEditMode(shareData) {
                // Tüm ana sayfayı gizle
                const mainContainer = document.querySelector('.container');
                const navbar = document.querySelector('.navbar');
                const allButtons = document.querySelectorAll('button:not(#report8DModal button)');
                
                if (mainContainer) mainContainer.style.display = 'none';
                if (navbar) navbar.style.display = 'none';
                document.body.style.overflow = 'hidden';
                document.body.style.background = '#f5f5f5';
                
                // Modal'ı full-screen yap
                const modal = document.getElementById('report8DModal');
                const modalDialog = modal.querySelector('.modal-dialog');
                modal.style.background = 'rgba(0,0,0,0.85)';
                modalDialog.style.maxWidth = '95%';
                modalDialog.style.width = '95%';
                modalDialog.style.maxHeight = '95vh';
                modalDialog.style.height = '95vh';
                
                // Kapatma butonunu gizle
                const closeBtn = modal.querySelector('[onclick="close8DReportModal()"]');
                if (closeBtn) closeBtn.style.display = 'none';
                
                // İptal butonunu gizle
                const cancelBtns = modal.querySelectorAll('button');
                cancelBtns.forEach(btn => {
                    if (btn.textContent.includes('İptal')) {
                        btn.style.display = 'none';
                    }
                });
                
                // Mail Gönder butonunu gizle
                const emailBtn = modal.querySelector('#sendEmail8DBtn');
                if (emailBtn) emailBtn.style.display = 'none';
                
                // Paylaş butonunu gizle
                const shareBtn = modal.querySelector('[onclick="share8DReport()"]');
                if (shareBtn) shareBtn.style.display = 'none';

                document.getElementById('report8DTitle').textContent = `📋 8D RAPOR - ${shareData.supplierName} - ${shareData.monthIndex}.Ay`;
                populate8DForm(shareData.reportData);
                
                // Attachmentlerin kesinlikle render edildiğinden emin ol
                if (shareData.reportData.head && shareData.reportData.head.defectPhotos) {
                    headDefectPhotos = shareData.reportData.head.defectPhotos || [];
                    renderHeadDefectPhotos();
                }
                if (shareData.reportData.d2 && shareData.reportData.d2.attachments) {
                    d2Attachments = shareData.reportData.d2.attachments || [];
                    renderD2Attachments();
                }
                if (shareData.reportData.d5 && shareData.reportData.d5.attachments) {
                    d5Attachments = shareData.reportData.d5.attachments || [];
                    renderD5Attachments();
                }
                if (shareData.reportData.d6 && shareData.reportData.d6.attachments) {
                    d6Attachments = shareData.reportData.d6.attachments || [];
                    renderD6Attachments();
                }
                if (shareData.reportData.d7 && shareData.reportData.d7.attachments) {
                    d7Attachments = shareData.reportData.d7.attachments || [];
                    renderD7Attachments();
                }
                
                modal.style.display = 'flex';
                switch8DTab('head');

                // Kaydet butonu metnini değiştir ve ortala
                const saveBtn = document.querySelector('[onclick="save8DReport()"]');
                if (saveBtn) {
                    saveBtn.innerHTML = '💾 Kaydet ve Gönder';
                    saveBtn.style.fontSize = '1.1em';
                    saveBtn.style.padding = '12px 30px';
                }

                // Otomatik senkronizasyon yap (arka planda)
                console.log('🔄 Tedarikçi modu: Otomatik senkronizasyon başlıyor...');
                setTimeout(async () => {
                    try {
                        await silentSync8D();
                        console.log('✅ Otomatik senkronizasyon tamamlandı!');
                        showAlert('✅ En güncel veriler yüklendi!', 'success');
                    } catch (e) {
                        console.warn('⚠️ Otomatik senkronizasyon hatası:', e);
                    }
                }, 1000); // 1 saniye bekle, modal tamamen yüklensin
        }

        async function save8DReport() {
            if (!current8DSupplier || !current8DMonth) {
                showAlert('⚠️ Tedarikçi veya ay bilgisi eksik!', 'error');
                return;
            }

            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                return;
            }

            const reportData = {
                supplierName: current8DSupplier,
                monthIndex: current8DMonth,
                timestamp: new Date().toISOString(),
                
                // D0 - Preliminary Planning
                d0: {
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // Head Data
                head: {
                    reportNumber: document.getElementById('f8d_reportNumber').value,
                    version: document.getElementById('f8d_version').value,
                    title: document.getElementById('f8d_title').value,
                    startDate: document.getElementById('f8d_startDate').value,
                    subject: document.getElementById('f8d_subject').value,
                    currentDate: document.getElementById('f8d_currentDate').value,
                    customer: document.getElementById('f8d_customer').value,
                    status: document.getElementById('f8d_status').value,
                    email: document.getElementById('f8d_email').value,
                    phone: document.getElementById('f8d_phone').value,
                    additionalInfo: document.getElementById('f8d_additionalInfo').value,
                    // Preliminary Defect Information
                    partNumber: document.getElementById('f8d_partNumber').value,
                    partName: document.getElementById('f8d_partName').value,
                    defectDescription: document.getElementById('f8d_defectDescription').value,
                    defectQuantity: document.getElementById('f8d_defectQuantity').value,
                    totalCheckedQuantity: document.getElementById('f8d_totalCheckedQuantity').value,
                    defectRate: document.getElementById('f8d_defectRate').value,
                    detectionPoint: document.getElementById('f8d_detectionPoint').value,
                    defectPhotos: headDefectPhotos || [],
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D1
                d1: {
                    teamMembers: Array.from(document.querySelectorAll('.d1-team-member')).map(member => ({
                        name: member.querySelector('.d1-name').value,
                        department: member.querySelector('.d1-department').value,
                        position: member.querySelector('.d1-position').value,
                        contact: member.querySelector('.d1-contact').value
                    })),
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D2
                d2: {
                    symptom: document.getElementById('f8d_d2_symptom').value,
                    problem: document.getElementById('f8d_d2_problem').value,
                    errorType: document.getElementById('f8d_d2_errorType').value,
                    errorLocation: document.getElementById('f8d_d2_errorLocation').value,
                    riskAssessment: document.getElementById('f8d_d2_riskAssessment').value,
                    riskDate: document.getElementById('f8d_d2_riskDate').value,
                    attachments: d2Attachments || [],
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D3
                d3: {
                    actions: Array.from(document.querySelectorAll('.d3-action')).map(action => ({
                        description: action.querySelector('.d3-description').value,
                        responsible: action.querySelector('.d3-responsible').value,
                        date: action.querySelector('.d3-date').value
                    })),
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D4
                d4: {
                    rootCauses: Array.from(document.querySelectorAll('.d4-root-cause')).map(cause => ({
                        type: cause.querySelector('.d4-type').value,
                        title: cause.querySelector('.d4-title').value,
                        description: cause.querySelector('.d4-description').value,
                        verification: cause.querySelector('.d4-verification').value,
                        results: cause.querySelector('.d4-results').value,
                        date: cause.querySelector('.d4-date').value
                    })),
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D5
                d5: {
                    actions: Array.from(document.querySelectorAll('.d5-action')).map(action => ({
                        action: action.querySelector('.d5-action-text').value,
                        planDate: action.querySelector('.d5-plan-date').value,
                        responsible: action.querySelector('.d5-responsible').value,
                        verificationDate: action.querySelector('.d5-verification-date').value,
                        verificationPerson: action.querySelector('.d5-verification-person').value
                    })),
                    attachments: d5Attachments || [],
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D6
                d6: {
                    implementations: Array.from(document.querySelectorAll('.d6-implementation')).map(impl => ({
                        action: impl.querySelector('.d6-action').value,
                        launchDate: impl.querySelector('.d6-launch-date').value,
                        effectiveFrom: impl.querySelector('.d6-effective-from').value,
                        validatedOn: impl.querySelector('.d6-validated-on').value,
                        responsible: impl.querySelector('.d6-responsible').value
                    })),
                    attachments: d6Attachments || [],
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D7
                d7: {
                    preventions: Array.from(document.querySelectorAll('.d7-prevention')).map(prev => ({
                        description: prev.querySelector('.d7-description').value,
                        responsible: prev.querySelector('.d7-responsible').value,
                        planned: prev.querySelector('.d7-planned').value,
                        handover: prev.querySelector('.d7-handover').value,
                        assessment: prev.querySelector('.d7-assessment').value
                    })),
                    attachments: d7Attachments || [],
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                },
                
                // D8
                d8: {
                    participants: Array.from(document.querySelectorAll('.d8-participant')).map(part => ({
                        name: part.querySelector('.d8-participant-name').value
                    })),
                    result: document.getElementById('f8d_d8_result').value,
                    assessmentBy: document.getElementById('f8d_d8_assessmentBy').value,
                    finalMeetingDate: document.getElementById('f8d_d8_finalMeetingDate').value,
                    performedOn: document.getElementById('f8d_d8_performedOn').value,
                    finalDiscussion: document.getElementById('f8d_d8_finalDiscussion').value,
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                }
            };

            try {
                const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                
                const isEditMode = current8DData && current8DData.id;
                const oldStatus = isEditMode ? current8DData.head?.status : null;
                const newStatus = reportData.head.status;
                
                // Eğer düzenleme modundaysa (current8DData varsa) güncelle, yoksa yeni ekle
                if (isEditMode) {
                    // Mevcut raporu güncelle
                    reportData.id = current8DData.id;
                    
                    // Timestamp'i kesinlikle güncelle (özellikle tedarikçi modu için kritik!)
                    reportData.timestamp = new Date().toISOString();
                    
                    // sharedBinId'yi koru!
                    if (current8DData.sharedBinId) {
                        reportData.sharedBinId = current8DData.sharedBinId;
                        console.log('🔗 sharedBinId korundu:', reportData.sharedBinId);
                    }
                    
                    // sharedGistId'yi koru!
                    if (current8DData.sharedGistId) {
                        reportData.sharedGistId = current8DData.sharedGistId;
                        console.log('🔗 sharedGistId korundu:', reportData.sharedGistId);
                    }
                    
                    // gistId'yi koru (supplier mode için)
                    if (current8DData.gistId) {
                        reportData.gistId = current8DData.gistId;
                        console.log('🔗 gistId korundu:', reportData.gistId);
                    }
                    
                    // Storj bilgisini koru!
                    if (current8DData.sharedStorjKey) {
                        reportData.sharedStorjKey = current8DData.sharedStorjKey;
                        console.log('🚀 sharedStorjKey korundu:', reportData.sharedStorjKey);
                    }
                    
                    // Pantry bilgilerini koru!
                    if (current8DData.sharedPantryId) {
                        reportData.sharedPantryId = current8DData.sharedPantryId;
                        console.log('🔑 sharedPantryId korundu:', reportData.sharedPantryId.substring(0, 20) + '...');
                    }
                    if (current8DData.sharedBasketName) {
                        reportData.sharedBasketName = current8DData.sharedBasketName;
                        console.log('🗄️ sharedBasketName korundu:', reportData.sharedBasketName);
                    }
                    
                    const putRequest = objectStore.put(reportData);
                    
                    putRequest.onsuccess = async () => {
                        // current8DData'yı güncelle - sharedBinId kaybolmasın!
                        current8DData = reportData;
                        
                        console.log('💾 RAPOR KAYDEDİLDİ!');
                        console.log('🔗 sharedBinId:', current8DData.sharedBinId || '❌ YOK');
                        console.log('🔑 sharedPantryId:', current8DData.sharedPantryId || '❌ YOK');
                        console.log('🗄️ sharedBasketName:', current8DData.sharedBasketName || '❌ YOK');
                        console.log('📸 Head defect photos KAYDEDILDI:', current8DData.head?.defectPhotos?.length || 0);
                        console.log('📸 Head defect photos DATA:', JSON.stringify(current8DData.head?.defectPhotos || []));
                        console.log('📎 D2 Attachments KAYDEDILDI:', current8DData.d2?.attachments?.length || 0);
                        console.log('📎 D5 Attachments KAYDEDILDI:', current8DData.d5?.attachments?.length || 0);
                        console.log('📎 D6 Attachments KAYDEDILDI:', current8DData.d6?.attachments?.length || 0);
                        console.log('📎 D7 Attachments KAYDEDILDI:', current8DData.d7?.attachments?.length || 0);
                        
                        // PAYLAŞIM GÜNCELLEME KONTROLÜ
                        if (current8DData.sharedStorjKey) {
                            console.log('✅ Storj bilgisi VAR, güncelleme yapılacak!');
                        } else if (current8DData.sharedPantryId && current8DData.sharedBasketName) {
                            console.log('✅ Pantry bilgileri VAR, güncelleme yapılacak!');
                        } else if (current8DData.sharedBinId) {
                            console.log('✅ JSONBin bilgisi VAR, güncelleme yapılacak!');
                        } else if (current8DData.sharedGistId || current8DData.gistId) {
                            console.log('✅ GitHub Gist bilgisi VAR, güncelleme yapılacak!');
                        } else {
                            console.log('⚠️ UYARI: Bu rapor paylaşılmamış, güncelleme YAPILMAYACAK!');
                        }
                        
                        // Status değişimini kontrol et
                        if (oldStatus !== newStatus && newStatus === 'Closed' && oldStatus !== 'Closed') {
                            // Closed'a geçiş yapıldı - cevaplanan8D +1
                            update8DCountsInSupplierData(current8DSupplier, 0, 1);
                        } else if (oldStatus === 'Closed' && newStatus !== 'Closed') {
                            // Closed'dan çıkıldı - cevaplanan8D -1
                            update8DCountsInSupplierData(current8DSupplier, 0, -1);
                        } else {
                            // Status değişmedi ama tabloyu yine de güncelle
                            if (typeof renderTable === 'function') {
                                renderTable(lastFilteredResults || allResults);
                            }
                        }
                        
                        // Rapor paylaşılmışsa remote servise de güncelle
                        if (current8DData.sharedStorjKey) {
                            console.log('📤 Paylaşılan rapor güncelleniyor, Storj DCS\'e gönderiliyor...');
                            await updateSharedReportStorj(current8DData.sharedStorjKey, reportData);
                            console.log('✅ Storj DCS güncellendi!');
                        } else if (current8DData.sharedGistId) {
                            console.log('📤 Paylaşılan rapor güncelleniyor, GitHub Gist\'e gönderiliyor...');
                            await updateSharedReportGist(current8DData.sharedGistId, reportData);
                            console.log('✅ GitHub Gist güncellendi!');
                        } else if (current8DData.gistId) {
                            // Supplier mode için gistId
                            console.log('📤 Paylaşılan rapor güncelleniyor (supplier mode), GitHub Gist\'e gönderiliyor...');
                            await updateSharedReportGist(current8DData.gistId, reportData);
                            console.log('✅ GitHub Gist güncellendi!');
                        } else if (current8DData.sharedBinId) {
                            console.log('📤 Paylaşılan rapor güncelleniyor, JSONBin\'e gönderiliyor...');
                            await updateSharedReport(current8DData.sharedBinId, reportData);
                            console.log('✅ JSONBin güncellendi!');
                        } else if (current8DData.sharedPantryId && current8DData.sharedBasketName) {
                            console.log('📤 Paylaşılan rapor güncelleniyor, Pantry\'ye gönderiliyor...');
                            const pantryInfo = `${current8DData.sharedPantryId}:${current8DData.sharedBasketName}`;
                            await updateSharedReport(`pantry:${pantryInfo}`, reportData);
                            console.log('✅ Pantry güncellendi!');
                        }
                        
                        // Senkronize butonunu göster (paylaşılmış raporlarda)
                        const syncBtn = document.getElementById('sync8DBtn');
                        if (syncBtn && (current8DData.sharedBinId || current8DData.sharedPantryId || current8DData.sharedGistId || current8DData.gistId || current8DData.sharedStorjKey)) {
                            syncBtn.style.display = 'block';
                            console.log('🔄 Senkronize butonu gösterildi');
                        }
                        
                        // Eğer tedarikçi modunda ise özel başarı mesajı göster
                        if (window.supplierEditMode) {
                            // Büyük başarı mesajı göster
                            const successDialog = document.createElement('div');
                            successDialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 40px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 30000; text-align: center; min-width: 400px; animation: scaleIn 0.3s ease-out;';
                            successDialog.innerHTML = `
                                <style>
                                    @keyframes scaleIn {
                                        from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
                                        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                                    }
                                </style>
                                <div style="font-size: 4em; margin-bottom: 15px;">✅</div>
                                <div style="font-size: 1.8em; font-weight: 700; margin-bottom: 10px;">BAŞARILI!</div>
                                <div style="font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">
                                    8D Raporu başarıyla gönderildi.<br>
                                    Firma bilgilerinizi aldı.<br>
                                    Teşekkür ederiz!
                                </div>
                                <button onclick="this.parentElement.remove()" style="background: white; color: #4caf50; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">Tamam</button>
                            `;
                            document.body.appendChild(successDialog);
                            
                            // 5 saniye sonra otomatik kapat
                            setTimeout(() => successDialog.remove(), 5000);
                        } else {
                            showAlert('✅ 8D Raporu kaydedildi!', 'success');
                            // Modal'ı kapatmıyoruz, kullanıcı devam edebilsin
                            update8DReportCount();
                            // Tabloyu güncelle
                            if (typeof renderTable === 'function') {
                                renderTable(lastFilteredResults || allResults);
                            }
                            // Sayıları otomatik güncelle
                            await load8DCountsFromDB();
                        }
                    };
                    
                    putRequest.onerror = () => {
                        console.error('8D rapor güncelleme hatası:', putRequest.error);
                        showAlert('❌ Güncelleme başarısız!', 'error');
                    };
                } else {
                    // Yeni rapor ekle
                    const addRequest = objectStore.add(reportData);
                    
                    addRequest.onsuccess = async () => {
                        // ID'yi reportData'ya ekle
                        reportData.id = addRequest.result;
                        current8DData = reportData;
                        console.log('✅ Yeni rapor eklendi, ID:', reportData.id);
                        
                        // Yeni 8D eklendi
                        const talepEdilenDelta = 1;
                        const cevaplanaDelta = (newStatus === 'Closed') ? 1 : 0;
                        update8DCountsInSupplierData(current8DSupplier, talepEdilenDelta, cevaplanaDelta);
                        
                        // Eğer tedarikçi modunda ise remote servise de güncelle
                        if (window.supplierEditMode && current8DData) {
                            // Timestamp'i kesinlikle güncelle
                            reportData.timestamp = new Date().toISOString();
                            
                            if (current8DData.gistId) {
                                console.log('🔵 TEDARIKÇI MODU: GitHub Gist güncellemesi başlıyor...');
                                console.log('🔵 Gist ID:', current8DData.gistId);
                                console.log('🔵 Timestamp:', reportData.timestamp);
                                
                                await updateSharedReportGist(current8DData.gistId, reportData);
                                console.log('🔵 GitHub Gist güncelleme tamamlandı');
                            } else if (current8DData.sharedBinId) {
                                console.log('🔵 TEDARIKÇI MODU: JSONBin güncellemesi başlıyor...');
                                console.log('🔵 Bin ID:', current8DData.sharedBinId);
                                console.log('🔵 Timestamp:', reportData.timestamp);
                                
                                await updateSharedReport(current8DData.sharedBinId, reportData);
                                console.log('🔵 JSONBin güncelleme tamamlandı');
                            }
                            
                            // Büyük başarı mesajı göster
                            const successDialog = document.createElement('div');
                            successDialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 40px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 30000; text-align: center; min-width: 400px; animation: scaleIn 0.3s ease-out;';
                            successDialog.innerHTML = `
                                <style>
                                    @keyframes scaleIn {
                                        from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
                                        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                                    }
                                </style>
                                <div style="font-size: 4em; margin-bottom: 15px;">✅</div>
                                <div style="font-size: 1.8em; font-weight: 700; margin-bottom: 10px;">BAŞARILI!</div>
                                <div style="font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">
                                    8D Raporu başarıyla kaydedildi ve gönderildi.<br>
                                    Firma bilgilerinizi aldı.<br>
                                    Teşekkür ederiz!
                                </div>
                                <button onclick="this.parentElement.remove()" style="background: white; color: #4caf50; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">Tamam</button>
                            `;
                            document.body.appendChild(successDialog);
                            
                            // 5 saniye sonra otomatik kapat
                            setTimeout(() => successDialog.remove(), 5000);
                        } else {
                            showAlert(`✅ 8D Raporu kaydedildi!`, 'success');
                            close8DReportModal();
                            update8DReportCount();
                            // Liste modalını yeniden aç - doğru fonksiyon adı
                            setTimeout(() => show8DReportList(), 300);
                            // Sayıları otomatik güncelle
                            load8DCountsFromDB();
                        }
                    };
                    
                    addRequest.onerror = () => {
                        console.error('8D rapor kaydetme hatası:', addRequest.error);
                        showAlert('❌ Kaydetme başarısız!', 'error');
                    };
                }
                
            } catch (e) {
                console.error('8D rapor kaydetme hatası:', e);
                showAlert('❌ Kaydetme başarısız!', 'error');
            }
        }
        
        // 8D sayılarını yeniden hesapla - manuel tetikleme için
        // Tüm 8D raporlarını veritabanından yükle ve tedarikçi verilerini güncelle
        async function load8DCountsFromDB() {
            if (!db) {
                console.warn('8D sayıları yüklenemedi: DB hazır değil');
                return;
            }
            
            console.log('8D sayıları veritabanından yükleniyor...');
            
            try {
                const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                const getAllRequest = objectStore.getAll();
                
                getAllRequest.onsuccess = () => {
                    const allReports = getAllRequest.result;
                    console.log(`Toplam ${allReports.length} adet 8D raporu bulundu`);
                    
                    // Tedarikçi bazında sayıları hesapla
                    const supplierCounts = new Map();
                    
                    allReports.forEach(report => {
                        const supplierName = report.supplierName;
                        if (!supplierName) return;
                        
                        if (!supplierCounts.has(supplierName)) {
                            supplierCounts.set(supplierName, { talepEdilen: 0, cevaplanan: 0 });
                        }
                        
                        const counts = supplierCounts.get(supplierName);
                        counts.talepEdilen += 1;
                        
                        // Status "Closed" ise cevaplanan sayısını artır
                        if (report.head?.status === 'Closed') {
                            counts.cevaplanan += 1;
                        }
                    });
                    
                    console.log('Tedarikçi bazında 8D sayıları:', Array.from(supplierCounts.entries()));
                    
                    // allResults'taki tedarikçileri güncelle
                    if (allResults && allResults.length > 0) {
                        let updatedCount = 0;
                        let clearedCount = 0;
                        
                        allResults.forEach(supplier => {
                            // İki farklı alan adını kontrol et
                            const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
                            if (!supplierName) return;
                            
                            const counts = supplierCounts.get(supplierName.trim());
                            if (counts) {
                                // Raporu olan tedarikçi - gerçek sayıları yaz
                                supplier.talepEdilen8D = counts.talepEdilen;
                                supplier.cevaplanan8D = counts.cevaplanan;
                                
                                // Dönüş oranını hesapla
                                if (supplier.talepEdilen8D > 0) {
                                    supplier.donusOrani8D = (supplier.cevaplanan8D / supplier.talepEdilen8D) * 100;
                                } else {
                                    supplier.donusOrani8D = 0;
                                }
                                
                                updatedCount++;
                                console.log(`8D güncellendi: ${supplierName} - Talep: ${counts.talepEdilen}, Cevaplanan: ${counts.cevaplanan}`);
                            } else {
                                // Raporu olmayan tedarikçi - sayıları sıfırla
                                if (supplier.talepEdilen8D > 0 || supplier.cevaplanan8D > 0) {
                                    supplier.talepEdilen8D = 0;
                                    supplier.cevaplanan8D = 0;
                                    supplier.donusOrani8D = 0;
                                    clearedCount++;
                                    console.log(`8D temizlendi: ${supplierName} - Silinen raporlar kaldırıldı`);
                                }
                            }
                        });
                        
                        console.log(`✅ ${updatedCount} tedarikçinin 8D sayıları güncellendi, ${clearedCount} tedarikçi temizlendi`);
                        
                        // Tabloyu güncelle
                        if (typeof renderTable === 'function') {
                            renderTable(lastFilteredResults || allResults);
                        }
                    }
                };
                
                getAllRequest.onerror = () => {
                    console.error('8D raporları yükleme hatası:', getAllRequest.error);
                };
                
            } catch (e) {
                console.error('8D sayıları yükleme hatası:', e);
            }
        }
        
        // Tedarikçi verisindeki 8D sayılarını güncelle
        function update8DCountsInSupplierData(supplierName, talepEdilenDelta, cevaplanaDelta) {
            console.log(`update8DCountsInSupplierData çağrıldı: "${supplierName}", Delta: +${talepEdilenDelta}/+${cevaplanaDelta}`);
            console.log('allResults var mı?', !!allResults, 'uzunluk:', allResults?.length);
            
            if (!allResults || !supplierName) {
                console.error('allResults veya supplierName eksik!');
                return;
            }
            
            // Trim yaparak boşlukları temizle
            const cleanSupplierName = supplierName.trim();
            
            const supplier = allResults.find(r => {
                const excelName = (r['Tedarikçi Adı'] || '').trim();
                return excelName === cleanSupplierName;
            });
            
            if (!supplier) {
                console.error(`Tedarikçi bulunamadı: "${cleanSupplierName}"`);
                console.log('İlk 5 tedarikçi örneği:', allResults.slice(0, 5).map(r => `"${r['Tedarikçi Adı']}"`));
                
                // Benzer isim ara
                const similarSupplier = allResults.find(r => {
                    const excelName = (r['Tedarikçi Adı'] || '').trim().toUpperCase();
                    const searchName = cleanSupplierName.toUpperCase();
                    return excelName.includes(searchName) || searchName.includes(excelName);
                });
                
                if (similarSupplier) {
                    console.warn(`Benzer tedarikçi bulundu: "${similarSupplier['Tedarikçi Adı']}" - Bunu kullanıyorum`);
                    // Benzer tedarikçiyi kullan
                    updateSupplier(similarSupplier, talepEdilenDelta, cevaplanaDelta);
                    return;
                }
                
                return;
            }
            
            updateSupplier(supplier, talepEdilenDelta, cevaplanaDelta);
        }
        
        // Yardımcı fonksiyon - tedarikçi verisini güncelle
        function updateSupplier(supplier, talepEdilenDelta, cevaplanaDelta) {
            if (!supplier) {
                console.error('updateSupplier: supplier nesnesi null veya undefined!');
                return;
            }
            
            // Mevcut değerleri al
            const currentTalepEdilen = supplier.talepEdilen8D || 0;
            const currentCevaplanan = supplier.cevaplanan8D || 0;
            
            console.log(`Mevcut değerler - Talep: ${currentTalepEdilen}, Cevaplanan: ${currentCevaplanan}`);
            
            // Yeni değerleri ayarla
            supplier.talepEdilen8D = Math.max(0, currentTalepEdilen + talepEdilenDelta);
            supplier.cevaplanan8D = Math.max(0, currentCevaplanan + cevaplanaDelta);
            
            // 8D Dönüş Oranı hesapla - DOĞRU ALAN ADI: donusOrani8D
            if (supplier.talepEdilen8D > 0) {
                supplier.donusOrani8D = (supplier.cevaplanan8D / supplier.talepEdilen8D) * 100;
            } else {
                supplier.donusOrani8D = 0;
            }
            
            console.log(`✅ Yeni değerler - Talep: ${supplier.talepEdilen8D}, Cevaplanan: ${supplier.cevaplanan8D}, Oran: ${supplier.donusOrani8D.toFixed(2)}%`);
            
            // 8D sayılarını IndexedDB'ye kaydet
            const supplierName = supplier['Tedarikçi Adı'] || supplier.name;
            if (supplierName) {
                save8DCounts(supplierName, supplier.talepEdilen8D, supplier.cevaplanan8D, supplier.donusOrani8D)
                    .then(() => {
                        console.log('💾 8D sayıları IndexedDB\'ye kaydedildi');
                    })
                    .catch(err => {
                        console.error('8D sayıları kaydetme hatası:', err);
                    });
            }
            
            // lastFilteredResults'ta da güncelle (eğer varsa)
            if (lastFilteredResults) {
                const supplierName = supplier['Tedarikçi Adı'];
                if (!supplierName) {
                    console.error('Tedarikçi adı bulunamadı!');
                    return;
                }
                const filteredSupplier = lastFilteredResults.find(r => r['Tedarikçi Adı'] === supplierName);
                if (filteredSupplier) {
                    filteredSupplier.talepEdilen8D = supplier.talepEdilen8D;
                    filteredSupplier.cevaplanan8D = supplier.cevaplanan8D;
                    filteredSupplier.donusOrani8D = supplier.donusOrani8D;
                    console.log('lastFilteredResults da güncellendi');
                }
            }
            
            // Tabloyu güncelle
            console.log('renderTable çağrılıyor...');
            if (typeof renderTable === 'function') {
                renderTable(lastFilteredResults || allResults);
            }
        }
        
        // 8D Raporu yükleme
        async function load8DReport(supplierName, monthIndex) {
            // Bu fonksiyon artık kullanılmıyor - reportId bazlı yükleme için load8DReportById kullan
            clear8DForm();
        }
        
        // Belirli bir 8D raporunu ID'ye göre yükle
        async function load8DReportById(reportId) {
            clear8DForm();
            
            if (!db || !reportId) return;

            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                    const getRequest = objectStore.get(reportId);
                    
                    getRequest.onsuccess = () => {
                        const reportData = getRequest.result;
                        
                        if (reportData) {
                            current8DData = reportData;
                            console.log('✅ Rapor yüklendi, ID:', reportData.id);
                            console.log('📦 Rapor tüm verisi:', JSON.stringify(reportData, null, 2));
                            console.log('🔗 sharedBinId:', reportData.sharedBinId || '❌ YOK');
                            console.log('� sharedPantryId:', reportData.sharedPantryId || '❌ YOK');
                            console.log('🗄️ sharedBasketName:', reportData.sharedBasketName || '❌ YOK');
                            console.log('📎 D2 Attachments:', reportData.d2?.attachments?.length || 0);
                            console.log('📎 D5 Attachments:', reportData.d5?.attachments?.length || 0);
                            console.log('📎 D6 Attachments:', reportData.d6?.attachments?.length || 0);
                            console.log('📎 D7 Attachments:', reportData.d7?.attachments?.length || 0);
                            console.log('📸 Head Defect Photos:', reportData.head?.defectPhotos?.length || 0);
                            populate8DForm(reportData);
                            resolve(reportData);
                        } else {
                            console.error('8D rapor bulunamadı:', reportId);
                            showAlert('❌ Rapor bulunamadı!', 'error');
                            reject(new Error('Rapor bulunamadı'));
                        }
                    };
                    
                    getRequest.onerror = () => {
                        console.error('8D rapor yükleme hatası:', getRequest.error);
                        showAlert('❌ Rapor yüklenemedi!', 'error');
                        reject(getRequest.error);
                    };
                    
                } catch (e) {
                    console.error('8D rapor yükleme hatası:', e);
                    showAlert('❌ Rapor yüklenemedi!', 'error');
                    reject(e);
                }
            });
        }

        // Form temizleme
        function clear8DForm() {
            // Head
            document.getElementById('f8d_reportNumber').value = '';
            document.getElementById('f8d_version').value = '';
            document.getElementById('f8d_title').value = '';
            document.getElementById('f8d_startDate').value = '';
            document.getElementById('f8d_subject').value = '';
            document.getElementById('f8d_currentDate').value = '';
            document.getElementById('f8d_customer').value = '';
            document.getElementById('f8d_status').value = '';
            document.getElementById('f8d_email').value = '';
            document.getElementById('f8d_phone').value = '';
            document.getElementById('f8d_additionalInfo').value = '';
            
            // Preliminary Defect Information
            document.getElementById('f8d_partNumber').value = '';
            document.getElementById('f8d_partName').value = '';
            document.getElementById('f8d_defectDescription').value = '';
            document.getElementById('f8d_defectQuantity').value = '';
            document.getElementById('f8d_totalCheckedQuantity').value = '';
            document.getElementById('f8d_defectRate').value = '';
            document.getElementById('f8d_detectionPoint').value = '';
            
            // Head Defect Photos
            headDefectPhotos = [];
            renderHeadDefectPhotos();
            
            // D1
            document.getElementById('d1TeamMembers').innerHTML = '';
            d1MemberCount = 0;
            
            // D2
            document.getElementById('f8d_d2_symptom').value = '';
            document.getElementById('f8d_d2_problem').value = '';
            document.getElementById('f8d_d2_errorType').value = '';
            document.getElementById('f8d_d2_errorLocation').value = '';
            document.getElementById('f8d_d2_riskAssessment').value = '';
            document.getElementById('f8d_d2_riskDate').value = '';
            
            // D2 Attachments
            d2Attachments = [];
            renderD2Attachments();
            
            // D3-D7
            document.getElementById('d3ContainmentActions').innerHTML = '';
            d3ActionCount = 0;
            document.getElementById('d4RootCauses').innerHTML = '';
            d4RootCauseCount = 0;
            document.getElementById('d5CorrectiveActions').innerHTML = '';
            d5ActionCount = 0;
            
            // D5 Attachments
            d5Attachments = [];
            renderD5Attachments();
            
            document.getElementById('d6Implementations').innerHTML = '';
            d6ImplementationCount = 0;
            
            // D6 Attachments
            d6Attachments = [];
            renderD6Attachments();
            
            document.getElementById('d7Preventions').innerHTML = '';
            d7PreventionCount = 0;
            
            // D7 Attachments
            d7Attachments = [];
            renderD7Attachments();
            
            // D8
            document.getElementById('d8Participants').innerHTML = '';
            d8ParticipantCount = 0;
            document.getElementById('f8d_d8_result').value = '';
            document.getElementById('f8d_d8_assessmentBy').value = '';
            document.getElementById('f8d_d8_finalMeetingDate').value = '';
            document.getElementById('f8d_d8_performedOn').value = '';
            document.getElementById('f8d_d8_finalDiscussion').value = '';
        }

        // Form doldurma
        function populate8DForm(data) {
            // ÖNEMLİ: Önce tüm dynamic container'ları TEMİZLE!
            console.log('🧹 populate8DForm: Tüm container\'lar temizleniyor...');
            document.getElementById('d1TeamMembers').innerHTML = '';
            document.getElementById('d3ContainmentActions').innerHTML = '';
            document.getElementById('d4RootCauses').innerHTML = '';
            document.getElementById('d5CorrectiveActions').innerHTML = '';
            document.getElementById('d6Implementations').innerHTML = '';
            document.getElementById('d7Preventions').innerHTML = '';
            document.getElementById('d8Participants').innerHTML = '';
            
            // Counter'ları SIFIRLA
            d1MemberCount = 0;
            d3ActionCount = 0;
            d4RootCauseCount = 0;
            d5ActionCount = 0;
            d6ImplementationCount = 0;
            d7PreventionCount = 0;
            d8ParticipantCount = 0;
            
            // Head
            if (data.head) {
                document.getElementById('f8d_reportNumber').value = data.head.reportNumber || '';
                document.getElementById('f8d_version').value = data.head.version || '';
                document.getElementById('f8d_title').value = data.head.title || '';
                document.getElementById('f8d_startDate').value = data.head.startDate || '';
                document.getElementById('f8d_subject').value = data.head.subject || '';
                document.getElementById('f8d_currentDate').value = data.head.currentDate || '';
                document.getElementById('f8d_customer').value = data.head.customer || '';
                document.getElementById('f8d_status').value = data.head.status || '';
                document.getElementById('f8d_email').value = data.head.email || '';
                document.getElementById('f8d_phone').value = data.head.phone || '';
                document.getElementById('f8d_additionalInfo').value = data.head.additionalInfo || '';
                
                // Preliminary Defect Information
                document.getElementById('f8d_partNumber').value = data.head.partNumber || '';
                document.getElementById('f8d_partName').value = data.head.partName || '';
                document.getElementById('f8d_defectDescription').value = data.head.defectDescription || '';
                document.getElementById('f8d_defectQuantity').value = data.head.defectQuantity || '';
                document.getElementById('f8d_totalCheckedQuantity').value = data.head.totalCheckedQuantity || '';
                document.getElementById('f8d_defectRate').value = data.head.defectRate || '';
                document.getElementById('f8d_detectionPoint').value = data.head.detectionPoint || '';
                
                // Head Defect Photos
                if (data.head.defectPhotos) {
                    headDefectPhotos = data.head.defectPhotos || [];
                    renderHeadDefectPhotos();
                }
            }
            
            // D1
            if (data.d1 && data.d1.teamMembers) {
                data.d1.teamMembers.forEach(member => addD1TeamMember(member));
            }
            
            // D2
            if (data.d2) {
                document.getElementById('f8d_d2_symptom').value = data.d2.symptom || '';
                document.getElementById('f8d_d2_problem').value = data.d2.problem || '';
                document.getElementById('f8d_d2_errorType').value = data.d2.errorType || '';
                document.getElementById('f8d_d2_errorLocation').value = data.d2.errorLocation || '';
                document.getElementById('f8d_d2_riskAssessment').value = data.d2.riskAssessment || '';
                document.getElementById('f8d_d2_riskDate').value = data.d2.riskDate || '';
                
                // D2 Attachments
                if (data.d2.attachments) {
                    d2Attachments = data.d2.attachments || [];
                    renderD2Attachments();
                }
            }
            
            // D3-D7
            if (data.d3 && data.d3.actions) {
                data.d3.actions.forEach(action => addD3Action(action));
            }
            if (data.d4 && data.d4.rootCauses) {
                data.d4.rootCauses.forEach(cause => addD4RootCause(cause.type, cause));
            }
            if (data.d5 && data.d5.actions) {
                data.d5.actions.forEach(action => addD5Action(action));
            }
            
            // D5 Attachments
            if (data.d5 && data.d5.attachments) {
                d5Attachments = data.d5.attachments || [];
                renderD5Attachments();
            }
            
            if (data.d6 && data.d6.implementations) {
                data.d6.implementations.forEach(impl => addD6Implementation(impl));
            }
            
            // D6 Attachments
            if (data.d6 && data.d6.attachments) {
                d6Attachments = data.d6.attachments || [];
                renderD6Attachments();
            }
            
            if (data.d7 && data.d7.preventions) {
                data.d7.preventions.forEach(prev => addD7Prevention(prev));
            }
            
            // D7 Attachments
            if (data.d7 && data.d7.attachments) {
                d7Attachments = data.d7.attachments || [];
                renderD7Attachments();
            }
            
            // D8
            if (data.d8) {
                if (data.d8.participants) {
                    data.d8.participants.forEach(part => addD8Participant(part));
                }
                document.getElementById('f8d_d8_result').value = data.d8.result || '';
                document.getElementById('f8d_d8_assessmentBy').value = data.d8.assessmentBy || '';
                document.getElementById('f8d_d8_finalMeetingDate').value = data.d8.finalMeetingDate || '';
                document.getElementById('f8d_d8_performedOn').value = data.d8.performedOn || '';
                document.getElementById('f8d_d8_finalDiscussion').value = data.d8.finalDiscussion || '';
            }
            
            // Senkronize butonunu her zaman göster
            const syncBtn = document.getElementById('sync8DBtn');
            if (syncBtn) {
                syncBtn.style.display = 'block';
                console.log('🔄 Senkronize butonu gösterildi (her zaman görünür)');
            }
        }

        // 8D Raporu var mı kontrol ve durum analizi
        async function check8DReportExists(supplierName, monthIndex) {
            if (!db) return { exists: false, status: null };
            
            return new Promise((resolve) => {
                try {
                    const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                    const index = objectStore.index('supplierName');
                    const getAllRequest = index.getAll(supplierName);
                    
                    getAllRequest.onsuccess = () => {
                        const allReports = getAllRequest.result || [];
                        // Bu ay için raporları filtrele
                        const monthReports = allReports.filter(r => r.monthIndex === monthIndex);
                        
                        if (monthReports.length === 0) {
                            resolve({ exists: false, status: null });
                            return;
                        }
                        
                        // Durumları analiz et
                        const statuses = monthReports.map(r => r.head?.status || 'Open');
                        const hasOpen = statuses.some(s => s === 'Open');
                        const hasInProgress = statuses.some(s => s === 'In Progress');
                        const allClosed = statuses.every(s => s === 'Closed');
                        
                        let statusColor = 'green'; // Default
                        if (allClosed) {
                            statusColor = 'green'; // Tümü Closed
                        } else if (hasInProgress) {
                            statusColor = 'yellow'; // En az biri In Progress
                        } else if (hasOpen) {
                            statusColor = 'red'; // En az biri Open
                        }
                        
                        resolve({ exists: true, status: statusColor, count: monthReports.length });
                    };
                    
                    getAllRequest.onerror = () => {
                        resolve({ exists: false, status: null });
                    };
                } catch (e) {
                    resolve({ exists: false, status: null });
                }
            });
        }

        // 8D PDF Export
        async function export8DReportPDF(retryCount = 0) {
            if (!current8DSupplier || current8DMonth === null || current8DMonth === undefined) {
                showAlert('⚠️ 8D raporu bilgileri eksik! Lütfen raporu kapatıp tekrar açın.', 'error');
                return;
            }

            // jsPDF kontrolü - global window nesnelerinde ara
            let jsPDF = null;
            
            // Farklı yükleme formatlarını dene
            if (window.jspdf && window.jspdf.jsPDF) {
                jsPDF = window.jspdf.jsPDF;
            } else if (window.jsPDF) {
                jsPDF = window.jsPDF;
            }
            
            if (!jsPDF) {
                // Kütüphane henüz yüklenmemiş
                if (retryCount < 5) {
                    console.log('PDF kütüphanesi yükleniyor... Deneme:', retryCount + 1);
                    showAlert(`⏳ PDF kütüphanesi yükleniyor... (${retryCount + 1}/5)`, 'warning');
                    setTimeout(() => export8DReportPDF(retryCount + 1), 1500);
                    return;
                } else {
                    showAlert('❌ PDF kütüphanesi yüklenemedi! Sayfayı yenileyin (F5) ve tekrar deneyin.', 'error');
                    console.error('jsPDF yüklenemedi. window.jspdf:', window.jspdf, 'window.jsPDF:', window.jsPDF);
                    return;
                }
            }

            try {
                const doc = new jsPDF('p', 'mm', 'a4');
            
            // Get current form data
            const reportData = {
                reportNumber: document.getElementById('f8d_reportNumber').value || '',
                version: document.getElementById('f8d_version').value || '',
                title: document.getElementById('f8d_title').value || '',
                startDate: document.getElementById('f8d_startDate').value || '',
                subject: document.getElementById('f8d_subject').value || '',
                currentDate: document.getElementById('f8d_currentDate').value || '',
                customer: document.getElementById('f8d_customer').value || '',
                status: document.getElementById('f8d_status').value || '',
                email: document.getElementById('f8d_email').value || '',
                phone: document.getElementById('f8d_phone').value || '',
                // Preliminary Defect Information
                partNumber: document.getElementById('f8d_partNumber').value || '',
                partName: document.getElementById('f8d_partName').value || '',
                defectDescription: document.getElementById('f8d_defectDescription').value || '',
                defectQuantity: document.getElementById('f8d_defectQuantity').value || '',
                totalCheckedQuantity: document.getElementById('f8d_totalCheckedQuantity').value || '',
                defectRate: document.getElementById('f8d_defectRate').value || '',
                detectionPoint: document.getElementById('f8d_detectionPoint').value || ''
            };

            let yPos = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - 2 * margin;

            // Header - 8D Report Title
            doc.setFillColor(0, 128, 128);
            doc.rect(margin, yPos, contentWidth, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('8D Report', pageWidth / 2, yPos + 8, { align: 'center' });

            // Report Number and Version
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            doc.text(`8D-Report Number: ${reportData.reportNumber}`, pageWidth - margin - 2, yPos + 4, { align: 'right' });
            doc.text(`Version: ${reportData.version}`, pageWidth - margin - 2, yPos + 8, { align: 'right' });

            yPos += 15;

            // Header Information Table
            doc.autoTable({
                startY: yPos,
                head: [['Version', 'Start Date']],
                body: [
                    [reportData.version, reportData.startDate],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            doc.autoTable({
                startY: yPos,
                head: [['Subject of Problem Solving', 'Current Date']],
                body: [
                    [reportData.subject, reportData.currentDate],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            doc.autoTable({
                startY: yPos,
                head: [['Problem Owner/Customer', 'Status/Report Form:']],
                body: [
                    [reportData.customer, reportData.status],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            doc.autoTable({
                startY: yPos,
                head: [['E-Mail', 'Phone']],
                body: [
                    [reportData.email, reportData.phone],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 5;
            
            // Preliminary Defect Information Section - HER ZAMAN GÖSTER
            doc.setFillColor(30, 60, 114); // #1e3c72
            doc.rect(margin, yPos, contentWidth, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('PRELIMINARY DEFECT INFORMATION', margin + 3, yPos + 5.5);
            yPos += 10;
            
            doc.autoTable({
                startY: yPos,
                head: [['Part Number', 'Part Name']],
                body: [
                    [reportData.partNumber || '', reportData.partName || ''],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 2;
            
            doc.autoTable({
                startY: yPos,
                head: [['Defect Description']],
                body: [
                    [reportData.defectDescription || ''],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });
            yPos = doc.lastAutoTable.finalY + 2;
            
            doc.autoTable({
                startY: yPos,
                head: [['Defect Quantity (pcs)', 'Total Checked Quantity (pcs)', 'Defect Rate (%)']],
                body: [
                    [reportData.defectQuantity || '', reportData.totalCheckedQuantity || '', reportData.defectRate || ''],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 2;
            
            doc.autoTable({
                startY: yPos,
                head: [['Detection Point']],
                body: [
                    [reportData.detectionPoint || ''],
                ],
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2 },
                headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold' },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 2;
            
            // Defect Photos - Resimleri göster
            if (headDefectPhotos && headDefectPhotos.length > 0) {
                // Resim formatlarını tanımla
                const imageFormats = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'tif', 'webp'];
                const imageFiles = [];
                const otherFiles = [];
                
                // Dosyaları ayır
                headDefectPhotos.forEach(photo => {
                    const extension = photo.name.split('.').pop().toLowerCase();
                    if (imageFormats.includes(extension)) {
                        imageFiles.push(photo);
                    } else {
                        otherFiles.push(photo);
                    }
                });
                
                // Önce resimleri göster
                if (imageFiles.length > 0) {
                    doc.setFontSize(9);
                    doc.setTextColor(30, 60, 114);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Defect Photos:', margin, yPos);
                    yPos += 5;
                    
                    for (const photo of imageFiles) {
                        // Yeni sayfa kontrolü
                        if (yPos > pageHeight - 80) {
                            doc.addPage();
                            yPos = 15;
                        }
                        
                        try {
                            // Base64 data URL'den resmi ekle
                            if (photo.data) {
                                const imgWidth = 80; // mm
                                const imgHeight = 60; // mm
                                
                                // Resim çerçevesi
                                doc.setDrawColor(200, 200, 200);
                                doc.setLineWidth(0.5);
                                doc.rect(margin, yPos, imgWidth, imgHeight);
                                
                                // Resmi ekle
                                doc.addImage(photo.data, 'JPEG', margin + 1, yPos + 1, imgWidth - 2, imgHeight - 2);
                                
                                // Resim adı altına
                                doc.setFontSize(7);
                                doc.setTextColor(100, 100, 100);
                                doc.setFont('helvetica', 'normal');
                                doc.text(photo.name, margin, yPos + imgHeight + 3);
                                
                                yPos += imgHeight + 6;
                            } else {
                                // Data yoksa sadece isim göster
                                doc.setFontSize(8);
                                doc.setTextColor(150, 150, 150);
                                doc.text(`📷 ${photo.name} (görsel yüklenemedi)`, margin, yPos);
                                yPos += 5;
                            }
                        } catch (err) {
                            console.error('Resim ekleme hatası:', err);
                            doc.setFontSize(8);
                            doc.setTextColor(150, 150, 150);
                            doc.text(`📷 ${photo.name} (görsel eklenemedi)`, margin, yPos);
                            yPos += 5;
                        }
                    }
                }
                
                // Resim olmayan dosyaları tablo olarak göster
                if (otherFiles.length > 0) {
                    const attachmentRows = otherFiles.map((file, index) => {
                        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                        return [
                            (index + 1).toString(),
                            file.name || 'Unnamed file',
                            fileSize,
                            new Date(file.uploadDate).toLocaleDateString('tr-TR')
                        ];
                    });
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['#', 'Other Defect Files (Attachments)', 'Size', 'Upload Date']],
                        body: attachmentRows,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [30, 60, 114], textColor: [255, 255, 255], fontStyle: 'bold' },
                        columnStyles: {
                            0: { cellWidth: 10, halign: 'center' },
                            1: { cellWidth: 'auto' },
                            2: { cellWidth: 25, halign: 'right' },
                            3: { cellWidth: 30, halign: 'center' }
                        },
                        margin: { left: margin, right: margin }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 2;
                }
            } else {
                doc.autoTable({
                    startY: yPos,
                    head: [['Defect Photos (Attachments)']],
                    body: [
                        ['No attachments']
                    ],
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2, textColor: [150, 150, 150] },
                    headStyles: { fillColor: [30, 60, 114], textColor: [255, 255, 255], fontStyle: 'bold' },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 2;
            }
            
            yPos += 3;

            // D1 - Problem Solving Team
            addSectionHeader(doc, 'D1', 'Problem Solving Team', yPos, margin, contentWidth);
            yPos += 8;

            const d1Members = Array.from(document.querySelectorAll('.d1-team-member')).map(member => [
                member.querySelector('.d1-name')?.value || '',
                member.querySelector('.d1-department')?.value || '',
                member.querySelector('.d1-position')?.value || ''
            ]);

            if (d1Members.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Name', 'Department', 'Position']],
                    body: d1Members,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [0, 128, 0], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            // Check if new page needed
            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D2 - Problem Description
            addSectionHeader(doc, 'D2', 'Problem Description', yPos, margin, contentWidth);
            yPos += 8;

            const d2Data = {
                symptom: document.getElementById('f8d_d2_symptom')?.value || '',
                problem: document.getElementById('f8d_d2_problem')?.value || '',
                errorType: document.getElementById('f8d_d2_errorType')?.value || '',
                errorLocation: document.getElementById('f8d_d2_errorLocation')?.value || ''
            };

            doc.autoTable({
                startY: yPos,
                body: [
                    ['Description - Symptom', d2Data.symptom],
                    ['Description - Problem', d2Data.problem],
                    ['Categorization (type of error)', d2Data.errorType],
                    ['Categorization (error location)', d2Data.errorLocation]
                ],
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 50, fontStyle: 'bold', fillColor: [240, 240, 240] },
                    1: { cellWidth: 'auto' }
                },
                margin: { left: margin, right: margin }
            });

            yPos = doc.lastAutoTable.finalY + 5;

            // Add attachments list if attachments exist
            if (d2Attachments && d2Attachments.length > 0) {
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'bold');
                doc.text(`Attachments (${d2Attachments.length}):`, margin, yPos);
                yPos += 4;
                doc.setFont('helvetica', 'normal');
                d2Attachments.forEach((att, idx) => {
                    doc.text(`  ${idx + 1}. ${att.name}`, margin + 2, yPos);
                    yPos += 3.5;
                });
                yPos += 2;
            }

            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D3 - Containment Actions
            addSectionHeader(doc, 'D3', 'Containment Actions', yPos, margin, contentWidth);
            yPos += 8;

            const d3Actions = Array.from(document.querySelectorAll('.d3-action')).map(action => [
                action.querySelector('.d3-description')?.value || '',
                action.querySelector('.d3-responsible')?.value || '',
                action.querySelector('.d3-date')?.value || ''
            ]);

            if (d3Actions.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Description', 'Responsible', 'Date']],
                    body: d3Actions,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [245, 124, 0], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D4 - Root Cause Analysis
            addSectionHeader(doc, 'D4', 'Root Cause Analysis', yPos, margin, contentWidth);
            yPos += 8;

            const d4Causes = Array.from(document.querySelectorAll('.d4-root-cause')).map(cause => [
                cause.querySelector('.d4-type')?.value || '',
                cause.querySelector('.d4-title')?.value || '',
                cause.querySelector('.d4-description')?.value || '',
                cause.querySelector('.d4-verification')?.value || ''
            ]);

            if (d4Causes.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Type', 'Title', 'Description', 'Verification']],
                    body: d4Causes,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [211, 47, 47], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D5 - Selection and Verification of Corrective Actions
            addSectionHeader(doc, 'D5', 'Selection and Verification of Corrective Actions', yPos, margin, contentWidth);
            yPos += 8;

            const d5Actions = Array.from(document.querySelectorAll('.d5-action')).map(action => [
                action.querySelector('.d5-action-text')?.value || '',
                action.querySelector('.d5-responsible')?.value || '',
                action.querySelector('.d5-plan-date')?.value || '',
                action.querySelector('.d5-verification-date')?.value || ''
            ]);

            if (d5Actions.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Corrective Actions', 'Responsible', 'Plan Date', 'Verification Date']],
                    body: d5Actions,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [106, 27, 154], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            if (d5Attachments && d5Attachments.length > 0) {
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'bold');
                doc.text(`Attachments (${d5Attachments.length}):`, margin, yPos);
                yPos += 4;
                doc.setFont('helvetica', 'normal');
                d5Attachments.forEach((att, idx) => {
                    doc.text(`  ${idx + 1}. ${att.name}`, margin + 2, yPos);
                    yPos += 3.5;
                });
                yPos += 2;
            }

            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D6 - Implementation and Validation
            addSectionHeader(doc, 'D6', 'Implementation and Validation of Corrective Actions', yPos, margin, contentWidth);
            yPos += 8;

            const d6Implementations = Array.from(document.querySelectorAll('.d6-implementation')).map(impl => [
                impl.querySelector('.d6-action')?.value || '',
                impl.querySelector('.d6-launch-date')?.value || '',
                impl.querySelector('.d6-effective-from')?.value || '',
                impl.querySelector('.d6-responsible')?.value || ''
            ]);

            if (d6Implementations.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Corrective Actions', 'Launch Date', 'Effective From', 'Responsible']],
                    body: d6Implementations,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [0, 105, 92], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            if (d6Attachments && d6Attachments.length > 0) {
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'bold');
                doc.text(`Attachments (${d6Attachments.length}):`, margin, yPos);
                yPos += 4;
                doc.setFont('helvetica', 'normal');
                d6Attachments.forEach((att, idx) => {
                    doc.text(`  ${idx + 1}. ${att.name}`, margin + 2, yPos);
                    yPos += 3.5;
                });
                yPos += 2;
            }

            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D7 - Prevention of Reoccurrence
            addSectionHeader(doc, 'D7', 'Prevention of Reoccurrence', yPos, margin, contentWidth);
            yPos += 8;

            const d7Preventions = Array.from(document.querySelectorAll('.d7-prevention')).map(prev => [
                prev.querySelector('.d7-description')?.value || '',
                prev.querySelector('.d7-responsible')?.value || '',
                prev.querySelector('.d7-planned')?.value || '',
                prev.querySelector('.d7-handover')?.value || ''
            ]);

            if (d7Preventions.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Description', 'Responsible', 'Planned', 'Hand Over Date']],
                    body: d7Preventions,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [1, 87, 155], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            if (d7Attachments && d7Attachments.length > 0) {
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'bold');
                doc.text(`Attachments (${d7Attachments.length}):`, margin, yPos);
                yPos += 4;
                doc.setFont('helvetica', 'normal');
                d7Attachments.forEach((att, idx) => {
                    doc.text(`  ${idx + 1}. ${att.name}`, margin + 2, yPos);
                    yPos += 3.5;
                });
                yPos += 2;
            }

            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 15;
            }

            // D8 - Conclusion
            addSectionHeader(doc, 'D8', 'Conclusion and Appreciation of the Team\'s Success', yPos, margin, contentWidth);
            yPos += 8;

            const d8Participants = Array.from(document.querySelectorAll('.d8-participant')).map(part => [
                part.querySelector('.d8-participant-name')?.value || ''
            ]);

            if (d8Participants.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Participants']],
                    body: d8Participants,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [85, 139, 47], textColor: [255, 255, 255] },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 5;
            }

            const d8Result = document.getElementById('f8d_d8_result')?.value || '';
            const d8AssessmentBy = document.getElementById('f8d_d8_assessmentBy')?.value || '';
            const d8PerformedOn = document.getElementById('f8d_d8_performedOn')?.value || '';

            doc.autoTable({
                startY: yPos,
                body: [
                    ['Result 8D Assessment', d8Result],
                    ['8D Assessment carried out by', d8AssessmentBy],
                    ['8D Assessment performed on', d8PerformedOn]
                ],
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 60, fontStyle: 'bold', fillColor: [240, 240, 240] },
                    1: { cellWidth: 'auto' }
                },
                margin: { left: margin, right: margin }
            });

            // Footer - sadece sayfa numarası
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`${i}/${totalPages}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
            }

            // Save PDF
            const fileName = `8D_Report_${reportData.reportNumber || current8DSupplier}_${current8DMonth}month.pdf`;
            doc.save(fileName);
            showAlert('✅ PDF başarıyla oluşturuldu!', 'success');
            
            } catch (error) {
                console.error('PDF oluşturma hatası:', error);
                showAlert('❌ PDF oluşturulurken hata oluştu: ' + error.message, 'error');
            }
        }

        // 8D Raporu için Mail Gönder
        async function send8DReportEmail() {
            if (!current8DSupplier || current8DMonth === null || current8DMonth === undefined) {
                showAlert('⚠️ 8D raporu bilgileri eksik!', 'error');
                return;
            }

            // Form verilerini al
            const reportData = {
                reportNumber: document.getElementById('f8d_reportNumber')?.value || '',
                version: document.getElementById('f8d_version')?.value || '',
                title: document.getElementById('f8d_title')?.value || '',
                subject: document.getElementById('f8d_subject')?.value || '',
                customer: document.getElementById('f8d_customer')?.value || '',
                partNumber: document.getElementById('f8d_partNumber')?.value || '',
                partName: document.getElementById('f8d_partName')?.value || '',
                defectDescription: document.getElementById('f8d_defectDescription')?.value || '',
                currentDate: document.getElementById('f8d_currentDate')?.value || new Date().toISOString().split('T')[0]
            };

            try {
                // Raporu paylaş ve link al
                let shareUrl = '';
                
                // Eğer rapor daha önce paylaşılmışsa, mevcut linki kullan
                if (current8DData && current8DData.sharedUrl) {
                    shareUrl = current8DData.sharedUrl;
                } else {
                    // Yeni paylaşım yap
                    const selectedService = get8DShareService();
                    
                    if (selectedService === 'pantry') {
                        shareUrl = await shareWith8DPantry(current8DData, current8DSupplier, current8DMonth);
                    } else if (selectedService === 'storj') {
                        // Storj DCS ile paylaş
                        const settings = getStorjSettings();
                        if (!settings) {
                            showAlert('⚠️ Storj ayarları yapılmamış!\n\nAyarlar menüsünden Storj DCS ayarlarını yapın.', 'error');
                            return;
                        }
                        
                        const shareData = {
                            reportId: current8DData.id || 'new',
                            supplierName: current8DSupplier,
                            monthIndex: current8DMonth,
                            reportData: current8DData,
                            sharedAt: new Date().toISOString(),
                            mode: 'supplier-edit'
                        };
                        
                        // Unique key oluştur
                        const storjKey = `8D_${current8DSupplier}_${current8DMonth}_${Date.now()}.json`.replace(/[^a-zA-Z0-9._-]/g, '_');
                        
                        // Storj'a yükle
                        await uploadToStorj(storjKey, JSON.stringify(shareData, null, 2), settings);
                        
                        // Storj key'i raporda sakla
                        current8DData.sharedStorjKey = storjKey;
                        
                        // IndexedDB'ye kaydet
                        const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                        const store = tx.objectStore(REPORT_8D_STORE_NAME);
                        store.put(current8DData);
                        await new Promise(resolve => tx.oncomplete = resolve);
                        
                        // Tedarikçi URL'i oluştur (credentials'ı encode ederek)
                        const encodedCreds = btoa(JSON.stringify({ accessKey: settings.accessKey, secretKey: settings.secretKey, bucket: settings.bucket, endpoint: settings.endpoint, key: storjKey }));
                        shareUrl = `${window.location.origin}${window.location.pathname}?mode=supplier&storj=${encodedCreds}`;
                    } else {
                        // JSONBin ile paylaş
                        const apiKey = getJsonBinApiKey();
                        if (!apiKey) {
                            showAlert('⚠️ Önce 8D raporunu paylaşın veya API Key ayarlayın!', 'error');
                            return;
                        }
                        
                        const shareData = {
                            reportId: current8DData.id,
                            supplierName: current8DSupplier,
                            monthIndex: current8DMonth,
                            reportData: current8DData,
                            sharedAt: new Date().toISOString(),
                            mode: 'supplier-edit'
                        };

                        let binId = current8DData.sharedBinId;
                        
                        if (binId) {
                            const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Master-Key': apiKey,
                                    'X-Bin-Versioning': 'false'
                                },
                                body: JSON.stringify(shareData)
                            });

                            if (!updateResponse.ok) {
                                throw new Error('Rapor güncellenemedi');
                            }
                        } else {
                            const createResponse = await fetch('https://api.jsonbin.io/v3/b', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Master-Key': apiKey,
                                    'X-Bin-Name': `8D_${current8DSupplier}_Month${current8DMonth}`,
                                    'X-Bin-Private': 'false'
                                },
                                body: JSON.stringify(shareData)
                            });

                            if (!createResponse.ok) {
                                throw new Error('Rapor paylaşılamadı');
                            }

                            const result = await createResponse.json();
                            binId = result.metadata.id;
                            
                            // Bin ID'yi kaydet
                            current8DData.sharedBinId = binId;
                            
                            // IndexedDB'ye kaydet
                            const tx = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                            const store = tx.objectStore(REPORT_8D_STORE_NAME);
                            store.put(current8DData);
                            await new Promise(resolve => tx.oncomplete = resolve);
                        }

                        shareUrl = `${window.location.origin}${window.location.pathname}?share8d=${binId}`;
                    }
                }

                // Mail şablonunu hazırla
                const emailSubjectTR = `8D Raporu - ${reportData.reportNumber || current8DSupplier} - ${reportData.partName || 'Hata Bildirimi'}`;
                const emailSubjectEN = `8D Report - ${reportData.reportNumber || current8DSupplier} - ${reportData.partName || 'Defect Notification'}`;
                
                // Türkçe mail içeriği
                const emailBodyTR = `
Sayın Yetkili,

${reportData.customer || current8DSupplier} tedarikçimiz ile ilgili 8D raporu aşağıdaki bilgilerle oluşturulmuştur:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 RAPOR BİLGİLERİ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📄 Rapor No: ${reportData.reportNumber || 'Belirtilmemiş'}
📅 Tarih: ${reportData.currentDate}
🏢 Tedarikçi: ${reportData.customer || current8DSupplier}
📦 Parça No: ${reportData.partNumber || 'Belirtilmemiş'}
🔧 Parça Adı: ${reportData.partName || 'Belirtilmemiş'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ HATA TANIMI
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${reportData.defectDescription || 'Detaylı açıklama raporda mevcuttur.'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Lütfen aşağıdaki bağlantıyı kullanarak 8D raporunu görüntüleyin ve gerekli bilgileri doldurun:

🔗 8D Rapor Linki:
${shareUrl}

Not: Bu link ile rapora erişebilir ve düzenleyebilirsiniz.

Sorularınız için lütfen bizimle iletişime geçin.

Saygılarımızla,
Kalite Ekibi
`.trim();

                // İngilizce mail içeriği
                const emailBodyEN = `
Dear Sir/Madam,

An 8D report has been created regarding ${reportData.customer || current8DSupplier} with the following information:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 REPORT INFORMATION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📄 Report No: ${reportData.reportNumber || 'Not specified'}
📅 Date: ${reportData.currentDate}
🏢 Supplier: ${reportData.customer || current8DSupplier}
📦 Part No: ${reportData.partNumber || 'Not specified'}
🔧 Part Name: ${reportData.partName || 'Not specified'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ DEFECT DESCRIPTION
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${reportData.defectDescription || 'Detailed description is available in the report.'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Please use the link below to view and complete the 8D report:

🔗 8D Report Link:
${shareUrl}

Note: You can access and edit the report using this link.

For any questions, please contact us.

Best regards,
Quality Team
`.trim();

                // Kullanıcıya dil seçimi sun - daha açık bir dialog
                let languageChoice = prompt(
                    '📧 Mail Dili Seçimi / Select Email Language:\n\n' +
                    '1 = Türkçe (Turkish)\n' +
                    '2 = İngilizce (English)\n\n' +
                    'Lütfen 1 veya 2 yazın / Please enter 1 or 2:',
                    '1'
                );
                
                // Varsayılan olarak Türkçe
                if (languageChoice !== '1' && languageChoice !== '2') {
                    languageChoice = '1';
                }
                
                const useTurkish = languageChoice === '1';
                
                const emailSubject = useTurkish ? emailSubjectTR : emailSubjectEN;
                const emailBody = useTurkish ? emailBodyTR : emailBodyEN;
                
                // Mailto linki oluştur
                const mailtoLink = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // Mail istemcisini aç
                window.location.href = mailtoLink;
                
                showAlert('✅ Mail istemciniz açılıyor...', 'success');
                
            } catch (error) {
                console.error('Mail gönderme hatası:', error);
                showAlert('❌ Mail hazırlanırken hata oluştu: ' + error.message, 'error');
            }
        }

        // Doküman Paylaşımı için Mail Gönder
        function sendDocumentShareEmail(shareUrl, serviceName, supplierNameOverride = null) {
            try {
                // Tedarikçi adını parametre veya global değişkenden al
                const supplierName = supplierNameOverride || currentDocShareSupplier || 'Tedarikçi';
                
                // Türkçe mail içeriği
                const emailSubjectTR = `📄 Doküman Paylaşımı - ${supplierName}`;
                
                const emailBodyTR = `
Sayın Yetkili,

${supplierName} için doküman paylaşımı oluşturulmuştur. Lütfen gerekli dokümanları yükleyiniz ve güncelleyiniz.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 DOKÜMAN PORTAL ERIŞIMI
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Aşağıdaki bağlantıyı kullanarak doküman portalına erişebilirsiniz:

🔗 Doküman Portal Linki:
${shareUrl}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✨ ÖZELLİKLER
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ Tüm gerekli doküman türlerini görebilirsiniz
✓ Her türe dosya yükleyebilirsiniz (PDF, Excel, Word, Resim)
✓ Yüklenen dosyaları indirebilir ve görüntüleyebilirsiniz
✓ Dosyalara açıklama ekleyebilirsiniz
✓ Doküman durumunu takip edebilirsiniz (İnceleniyor/Kabul/Red)
✓ Müşteri yorumlarını görebilirsiniz

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 NASIL KULLANILIR?
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Yukarıdaki linke tıklayın
2. Doküman türlerini görün
3. "Dosya Yükle" butonuna basarak belgelerinizi yükleyin
4. İsterseniz açıklama ekleyin
5. "Dokümanları Gönder" butonu ile kaydedin
6. "Yeni Değişiklikleri Al" ile güncellemeleri görebilirsiniz

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Not: Bu link ile dokümanlarınızı güvenli bir şekilde paylaşabilirsiniz.
Herhangi bir sorunuz olursa lütfen bizimle iletişime geçin.

Saygılarımızla,
Kalite Ekibi
`.trim();

                // İngilizce mail içeriği
                const emailSubjectEN = `📄 Document Sharing - ${supplierName}`;
                
                const emailBodyEN = `
Dear Sir/Madam,

Document sharing has been created for ${supplierName}. Please upload and update the required documents.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 DOCUMENT PORTAL ACCESS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

You can access the document portal using the link below:

🔗 Document Portal Link:
${shareUrl}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✨ FEATURES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ View all required document types
✓ Upload files for each type (PDF, Excel, Word, Images)
✓ Download and preview uploaded files
✓ Add descriptions to files
✓ Track document status (Under Review/Approved/Rejected)
✓ View customer comments

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 HOW TO USE?
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Click the link above
2. View document types
3. Click "Upload File" to upload your documents
4. Optionally add descriptions
5. Save with "Send Documents" button
6. Use "Get New Changes" to see updates

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Note: You can securely share your documents using this link.
If you have any questions, please contact us.

Best regards,
Quality Team
`.trim();

                // Kullanıcıya dil seçimi sun
                let languageChoice = prompt(
                    '📧 Mail Dili Seçimi / Select Email Language:\n\n' +
                    '1 = Türkçe (Turkish)\n' +
                    '2 = İngilizce (English)\n\n' +
                    'Lütfen 1 veya 2 yazın / Please enter 1 or 2:',
                    '1'
                );
                
                // Varsayılan olarak Türkçe
                if (languageChoice !== '1' && languageChoice !== '2') {
                    languageChoice = '1';
                }
                
                const useTurkish = languageChoice === '1';
                
                const emailSubject = useTurkish ? emailSubjectTR : emailSubjectEN;
                const emailBody = useTurkish ? emailBodyTR : emailBodyEN;
                
                // Mailto linki oluştur
                const mailtoLink = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // Mail istemcisini aç
                window.location.href = mailtoLink;
                
                showAlert('✅ Mail istemciniz açılıyor...', 'success');
                
            } catch (error) {
                console.error('Mail gönderme hatası:', error);
                showAlert('❌ Mail hazırlanırken hata oluştu: ' + error.message, 'error');
            }
        }

        // Doküman modalinden mail gönder - paylaşım linkini reconstruct ederek
        async function sendDocumentShareEmailFromModal() {
            try {
                const sendMailBtn = document.getElementById('sendDocMailBtn');
                if (!sendMailBtn) {
                    showAlert('❌ Mail butonu bulunamadı', 'error');
                    return;
                }
                
                const supplierName = sendMailBtn.getAttribute('data-supplier');
                const storjKey = sendMailBtn.getAttribute('data-storj-key');
                
                if (!supplierName || !storjKey) {
                    showAlert('❌ Tedarikçi bilgileri bulunamadı', 'error');
                    return;
                }
                
                // Storj ayarlarını al
                const settings = await getStorjSettings();
                if (!settings) {
                    showAlert('⚠️ Storj ayarları bulunamadı!', 'error');
                    return;
                }
                
                // Sharing URL'i yeniden oluştur
                const encodedCreds = btoa(JSON.stringify({ 
                    accessKey: settings.accessKey, 
                    secretKey: settings.secretKey, 
                    bucket: settings.bucket, 
                    endpoint: settings.endpoint, 
                    key: storjKey 
                }));
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?mode=supplier&storj=${encodedCreds}`;
                
                console.log('📧 Mail gönderiliyor:', supplierName);
                console.log('🔗 URL:', shareUrl);
                
                // Mail gönder fonksiyonunu çağır
                await sendDocumentShareEmail(shareUrl, storjKey, supplierName);
                
            } catch (error) {
                console.error('❌ Modal\'dan mail gönderme hatası:', error);
                showAlert('❌ Mail gönderilirken hata oluştu: ' + error.message, 'error');
            }
        }

        // Helper function to add section headers
        function addSectionHeader(doc, sectionNumber, sectionTitle, yPos, margin, contentWidth) {
            doc.setFillColor(0, 128, 128);
            doc.rect(margin, yPos, contentWidth, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(`${sectionNumber}`, margin + 2, yPos + 5);
            doc.setFontSize(10);
            doc.text(sectionTitle, margin + 12, yPos + 5);
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
        }

        // 8D Butonlarını oluşturma
        async function create8DButtons(supplierName, months) {
            const buttonContainer_ppm = document.getElementById('chart8DButtons_ppm');
            
            if (!buttonContainer_ppm) return;
            
            // Temizle
            buttonContainer_ppm.innerHTML = '';
            
            // Her ay için buton oluştur
            for (const monthIndex of months) {
                const reportStatus = await check8DReportExists(supplierName, monthIndex);
                
                // Container oluştur (buton + liste ikonu) - Grid cell için
                const container = document.createElement('div');
                container.style.cssText = 'position: relative; display: flex; justify-content: center; align-items: center;';
                
                // Ana 8D butonu
                const button = document.createElement('button');
                button.className = 'month-8d-btn';
                
                if (reportStatus.exists) {
                    // Durum rengine göre sınıf ekle
                    if (reportStatus.status === 'green') {
                        button.classList.add('status-closed');
                    } else if (reportStatus.status === 'yellow') {
                        button.classList.add('status-inprogress');
                    } else if (reportStatus.status === 'red') {
                        button.classList.add('status-open');
                    }
                    button.title = `${monthIndex}.Ay - ${reportStatus.count} adet 8D Rapor - Yeni Ekle`;
                } else {
                    button.title = `${monthIndex}.Ay - Yeni 8D Rapor Aç`;
                }
                
                button.textContent = '8D';
                button.onclick = () => open8DReportModal(supplierName, monthIndex);
                
                container.appendChild(button);
                
                // Mevcut raporlar varsa liste ikonu ekle
                if (reportStatus.exists && reportStatus.count > 0) {
                    const listIcon = document.createElement('button');
                    listIcon.style.cssText = `
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: #ff5722;
                        color: white;
                        border: 2px solid white;
                        font-size: 10px;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        z-index: 10;
                    `;
                    listIcon.textContent = reportStatus.count;
                    listIcon.title = `${reportStatus.count} adet 8D Raporu Görüntüle`;
                    listIcon.onclick = (e) => {
                        e.stopPropagation();
                        open8DReportsForMonth(supplierName, monthIndex);
                    };
                    container.appendChild(listIcon);
                }
                
                // Sadece PPM grafiği altına ekle
                buttonContainer_ppm.appendChild(container);
            }
        }
        
        // Belirli bir ay için 8D raporlarını aç
        function open8DReportsForMonth(supplierName, monthIndex) {
            // Önce genel listeyi aç, sonra o aya scroll yap
            show8DReportList();
            setTimeout(() => {
                const monthHeader = document.querySelector(`[data-month="${monthIndex}"]`);
                if (monthHeader) {
                    monthHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }

        // 8D Raporlar listesini göster
        async function show8DReportList() {
            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                return;
            }

            try {
                const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                const getAllRequest = objectStore.getAll();
                
                getAllRequest.onsuccess = () => {
                    const allReports = getAllRequest.result || [];
                    display8DReportList(allReports);
                };
                
                getAllRequest.onerror = () => {
                    console.error('8D raporları yükleme hatası:', getAllRequest.error);
                    showAlert('❌ Raporlar yüklenemedi!', 'error');
                };
            } catch (e) {
                console.error('8D rapor listesi hatası:', e);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }

        // 8D Raporları listele
        function display8DReportList(reports) {
            const modal = document.getElementById('report8DListModal');
            const contentDiv = document.getElementById('report8DListContent');
            
            if (reports.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📭</div>
                        <div style="font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">Henüz 8D rapor kaydedilmemiş</div>
                        <div style="font-size: 0.95em; color: #999;">Tedarikçi performans grafiklerinde aylık 8D butonlarını kullanarak rapor oluşturabilirsiniz</div>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }

            // Tedarikçiye göre grupla
            const groupedReports = {};
            reports.forEach(report => {
                if (!groupedReports[report.supplierName]) {
                    groupedReports[report.supplierName] = [];
                }
                groupedReports[report.supplierName].push(report);
            });

            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1e3c72;">
                    <div style="font-size: 1.1em; font-weight: 600; color: #1e3c72; margin-bottom: 5px;">
                        📊 Toplam ${reports.length} adet 8D Rapor
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        ${Object.keys(groupedReports).length} tedarikçi için rapor mevcut
                    </div>
                </div>
            `;

            // Her tedarikçi için kartlar oluştur
            Object.keys(groupedReports).sort().forEach(supplierName => {
                const supplierReports = groupedReports[supplierName].sort((a, b) => a.monthIndex - b.monthIndex);
                
                html += `
                    <div style="margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <div data-month="${supplierReports[0].monthIndex}" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px;">
                            <div style="font-size: 1.15em; font-weight: 600;">🏭 ${supplierName}</div>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">${supplierReports.length} adet rapor</div>
                        </div>
                        <div style="padding: 15px; background: white;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                `;
                
                supplierReports.forEach(report => {
                    // Start Date'i al, yoksa timestamp kullan
                    const startDate = report.head?.startDate;
                    let dateStr = '-';
                    
                    if (startDate) {
                        // Start Date ISO formatında (YYYY-MM-DD)
                        const date = new Date(startDate);
                        dateStr = date.toLocaleDateString('tr-TR');
                    } else {
                        // Fallback: timestamp kullan
                        const date = new Date(report.timestamp);
                        dateStr = date.toLocaleDateString('tr-TR');
                    }
                    
                    const reportNumber = report.head?.reportNumber || '-';
                    const status = report.head?.status || 'Open';
                    
                    let statusColor = '#666';
                    let statusIcon = '○';
                    if (status === 'Closed') {
                        statusColor = '#4CAF50';
                        statusIcon = '✓';
                    } else if (status === 'In Progress') {
                        statusColor = '#FF9800';
                        statusIcon = '◐';
                    }
                    
                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 6px; padding: 12px; background: #f8f9fa; transition: all 0.3s; cursor: pointer;" 
                             onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" 
                             onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="font-weight: 600; color: #1e3c72; font-size: 1.05em;">${report.monthIndex}.Ay</div>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="open8DReportFromList(${report.id})" 
                                            style="padding: 4px 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;"
                                            title="Raporu Düzenle">
                                        ✏️
                                    </button>
                                    <button onclick="delete8DReportFromList(${report.id}, '${supplierName.replace(/'/g, "\\'")}', ${report.monthIndex})" 
                                            style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;"
                                            title="Raporu Sil">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 8px;">
                                <div><strong>Rapor No:</strong> ${reportNumber}</div>
                                <div style="margin-top: 4px;">
                                    <strong>Durum:</strong> 
                                    <span style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${status}</span>
                                </div>
                            </div>
                            <div style="font-size: 0.8em; color: #999; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">
                                📅 ${dateStr}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            contentDiv.innerHTML = html;
            modal.style.display = 'flex';
        }

        // 8D Raporlar listesi modalını kapat
        function close8DReportListModal() {
            document.getElementById('report8DListModal').style.display = 'none';
        }

        // Listeden 8D rapor aç
        function open8DReportFromList(reportId) {
            // Liste modalını açık tut - sadece 8D form modalını aç
            
            // reportId üzerinden tedarikçi ve ay bilgilerini almak için IndexedDB'den raporu oku
            if (!db) return;
            
            const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
            const getRequest = objectStore.get(reportId);
            
            getRequest.onsuccess = () => {
                const report = getRequest.result;
                if (report) {
                    open8DReportModal(report.supplierName, report.monthIndex, reportId);
                }
            };
            
            getRequest.onerror = () => {
                console.error('Rapor bilgisi alınamadı:', getRequest.error);
                showAlert('❌ Rapor açılamadı!', 'error');
            };
        }

        // Listeden 8D rapor sil
        async function delete8DReportFromList(reportId, supplierName, monthIndex) {
            if (!confirm(`⚠️ "${supplierName} - ${monthIndex}.Ay" raporu silinecek. Emin misiniz?`)) {
                return;
            }

            if (!db) {
                showAlert('⚠️ Veritabanı hazır değil!', 'error');
                return;
            }

            try {
                const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                
                // Önce raporu oku (status bilgisine ihtiyacımız var)
                const getRequest = objectStore.get(reportId);
                
                getRequest.onsuccess = () => {
                    const report = getRequest.result;
                    if (!report) {
                        showAlert('❌ Rapor bulunamadı!', 'error');
                        return;
                    }
                    
                    const reportStatus = report.head?.status;
                    
                    // Raporu sil
                    const deleteRequest = objectStore.delete(reportId);
                    
                    deleteRequest.onsuccess = () => {
                        // Sayaçları güncelle
                        const talepEdilenDelta = -1;
                        const cevaplanaDelta = (reportStatus === 'Closed') ? -1 : 0;
                        update8DCountsInSupplierData(supplierName, talepEdilenDelta, cevaplanaDelta);
                        
                        showAlert('✅ 8D Rapor silindi!', 'success');
                        update8DReportCount();
                        
                        // Tabloyu güncelle
                        if (typeof renderTable === 'function') {
                            renderTable(lastFilteredResults || allResults);
                        }
                        
                        // Sayıları otomatik güncelle
                        load8DCountsFromDB();
                        
                        // Listeyi yeniden göster
                        show8DReportList();
                    };
                    
                    deleteRequest.onerror = () => {
                        console.error('8D rapor silme hatası:', deleteRequest.error);
                        showAlert('❌ Silme başarısız!', 'error');
                    };
                };
                
                getRequest.onerror = () => {
                    console.error('8D rapor okuma hatası:', getRequest.error);
                    showAlert('❌ Rapor okunamadı!', 'error');
                };
            } catch (e) {
                console.error('8D rapor silme hatası:', e);
                showAlert('❌ Bir hata oluştu!', 'error');
            }
        }

        // 8D Rapor sayısını güncelle
        async function update8DReportCount() {
            if (!db) {
                document.getElementById('report8DCount').textContent = '0';
                return;
            }

            try {
                const transaction = db.transaction([REPORT_8D_STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(REPORT_8D_STORE_NAME);
                const countRequest = objectStore.count();
                
                countRequest.onsuccess = () => {
                    const count = countRequest.result || 0;
                    document.getElementById('report8DCount').textContent = count;
                };
                
                countRequest.onerror = () => {
                    document.getElementById('report8DCount').textContent = '0';
                };
            } catch (e) {
                document.getElementById('report8DCount').textContent = '0';
            }
        }

        // ======== COA Badge Güncelleme ========
        async function updateCOABadge() {
            try {
                if (typeof SharedConfig !== 'undefined' && SharedConfig.isConnected()) {
                    const coaData = await SharedConfig.getCOAData();
                    const badge = document.getElementById('coaBadge');
                    if (badge && coaData.length > 0) {
                        badge.textContent = coaData.length;
                        badge.style.display = 'block';
                    }
                }
            } catch (e) {
                console.log('COA badge güncellenemedi:', e);
            }
        }
        
        // Sayfa yüklendiğinde COA badge'i güncelle
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateCOABadge, 1000);
        });

        // ======== Diyalog Fonksiyonları ========
    </script>
</body>
</html>
